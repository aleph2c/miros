
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Distributed Battery Charging Example &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Cellular Automata" href="cellular_automata.html" />
    <link rel="prev" title="Using and Unwinding a Factory" href="towardsthefactoryexample.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="distributed-battery-charging-example">
<span id="batterychargingexample-battery-charging-example"></span><h1>Distributed Battery Charging Example<a class="headerlink" href="#distributed-battery-charging-example" title="Permalink to this headline">¶</a></h1>
<p>Lead acid batteries are very heavy.  But they are cheaper than lithium ion
batteries and this is why they are used in a lot of off-grid electrical systems.</p>
<a class="reference external image-reference" href="https://www.lowtechmagazine.com/2015/05/sustainability-off-grid-solar-power.html"><img alt="https://krisdedecker.typepad.com/.a/6a00e0099229e8883301bb0820445e970d-pi" class="align-center" src="https://krisdedecker.typepad.com/.a/6a00e0099229e8883301bb0820445e970d-pi" /></a>
<p>A large lead-acid battery is made up of a set of smaller lead-acid batteries
connected together in series.  These smaller batteries are called cells.</p>
<a class="reference external image-reference" href="https://chargetek.com/images/pdfs/equal.pdf"><img alt="_images/cells_in_series.PNG" class="align-center" src="_images/cells_in_series.PNG" /></a>
<p>Each cell contains two terminals, and each terminal is connected to a plate that
reaches down into a bath of sulphuric acid (H2SO4) and water (H2O).  There is a
positive and a negative terminal.  The positive terminal of a cell is made up of
lead dioxide (PbO2) and the negative terminal is made out of lead (Pb).</p>
<p>A battery is a chemical reaction that wants to happen, but can’t until there is
a path for electrons to flow from one material to another.  As a result, there
is a voltage potential expressed across the positive and negative terminals of
the battery.  If an electrical device is connected across these terminals an
electron path is made, the battery can begin its chemical reaction.  As a side
effect the electrical device is powered on.  The flow of current leaves the
positive terminal and enters the negative terminal.  When this happens the
battery is said to discharge.</p>
<a class="reference external image-reference" href="https://circuitglobe.com/lead-acid-battery.html"><img alt="https://circuitglobe.com/wp-content/uploads/2017/01/lead-acid-cell-112.jpg" class="align-center" src="https://circuitglobe.com/wp-content/uploads/2017/01/lead-acid-cell-112.jpg" /></a>
<p>Charging of a battery occurs when current is forced to flow in the opposite
direction: current leaves the negative terminal and enters the positive
terminal. This causes the chemical reaction to reverse, sequestering the
electrons back into the various materials of the battery.  You can charge a
battery with a battery charger.</p>
<a class="reference external image-reference" href="https://circuitglobe.com/lead-acid-battery.html"><img alt="https://circuitglobe.com/wp-content/uploads/2017/01/recharging-of-lead-acid-battery.jpg" class="align-center" src="https://circuitglobe.com/wp-content/uploads/2017/01/recharging-of-lead-acid-battery.jpg" /></a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you aren’t familiar with the terminology of electricity, imagine a water
tower.  The water is trying to get to the ground, due to gravity,
but it is held in place by the walls of the tower.  This means that there is a
potential for the water to flow, the height of the tower determines how much
energy is stored within it.  The higher the tower, the higher the potential
energy.  Voltage is analogous to height of the held water in the tower.</p>
<a class="reference external image-reference" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtYw4fJS9o3meW9yv5ZGJ5enzVpyJ0sfw5L45UifmATQERiArD"><img alt="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtYw4fJS9o3meW9yv5ZGJ5enzVpyJ0sfw5L45UifmATQERiArD" class="align-center" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtYw4fJS9o3meW9yv5ZGJ5enzVpyJ0sfw5L45UifmATQERiArD" /></a>
<p>Now imagine connecting a pipe from the tower to the ground, and letting the
water flow through it.  This flow is like current in an electrical system, and
the pipe width would limit that flow, so that would be like an electrical load.</p>
<p>Our battery is like a water tower; if no pipe is connected, current can’t flow.
If a pipe is connected, it can, and the energy of the battery reduces just like
the potential energy of our water tower would reduce as it’s water leaves it
through a pipe.  If you were to push the current back into the pipe, by
connecting a higher water tower, or by just driving the current back up the
tube with a pump, you would cause the potential of the water tower to increase.
We would be charging the tower.</p>
<p class="last">As mentioned before, a battery is made up of stacking cells in series.  Think of
that as a very tall water tower made up of stacked shorter water towers.  You
can increase their potential energy by stacking them this way.</p>
</div>
<p>As a lead acid battery is discharged, a crust of lead sulphate (PbSO4) forms on the
plates.  This crust reduces the surface area of the lead plates exposed to the
acid, reducing its ability to react and drive current.</p>
<a class="reference external image-reference" href="https://stevedmarineconsulting.com/sulfation-too-many-batteries-die-an-unnecessarily-early-death-from-this-phenomenon/"><img alt="https://stevedmarineconsulting.com/wp-content/uploads/2019/06/082504179.jpg" class="align-center" src="https://stevedmarineconsulting.com/wp-content/uploads/2019/06/082504179.jpg" /></a>
<p>There are electrical charging techniques which can remove this lead sulphate
(PbSO4), by reversing the chemical reaction, and even sometimes bubbling the
acid.  These bubbles physically massage away the lead sulphate crystals,
dislodging them from the plate, dropping them into the acid bath where they can
break down, crystallizing their lead atoms back onto the plates.</p>
<p>An electrical charger can control one of two things, it can act to control
current flow or it can control the voltage across the terminals of the
battery.  If it holds the current constant, electrons are pushed back into the
battery, which will cause the voltage of the battery to slowly rise over time.</p>
<p>If the charger holds the voltage at a higher potential than the battery voltage,
current will flow into the battery.  At first it will flow quickly, but over
time the battery’s ability to accept electrons will be limited by the amount of
material within it, causing the current flow to subside.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Thinking back to the water tower.  If we re-filled our water tower using a
pump to push a constant amount of water, this would be like controlling the
current being pushed into the battery.  If we connected a higher water tower,
and let it passively drain some of its water into the lower tower, this would
be like controlling the voltage of our charger.  Together the two towers
would have the potential energy of the taller tower, so it’s voltage would be
set to this.</p>
</div>
<p>When you hear people talk about the stages of charging of a battery, they are
talking about either a constant current or a constant voltage charging
technique.  In two stage charging, a constant current technique starts the
charging process, then once the battery voltage rises to a high enough level, a
constant voltage technique takes over.  In three stage charging, the third stage
is a constant voltage technique, but held at a lower value than the second
stage.  A forth stage of charging can be applied very infrequently, it’s called
equalization.  It is a constant voltage technique that applies such a high
voltage across the battery terminals, that the acid boils, and explosive
hydrogen is expelled from the batteries (this is why battery rooms need to be
well vented).</p>
<p>There are arbitrary naming conventions that have been applied to these stages of
charging:</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="13%" />
<col width="13%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name of Stage</th>
<th class="head">Constant
Current?</th>
<th class="head">Constant
Voltage?</th>
<th class="head">Notes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>bulk stage</em></td>
<td>yes</td>
<td>no</td>
<td>80 percent of charge put back</td>
</tr>
<tr class="row-odd"><td><em>absorption stage</em></td>
<td>no</td>
<td>yes</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td><em>float stage</em></td>
<td>no</td>
<td>yes</td>
<td>voltage is lower than absorption</td>
</tr>
<tr class="row-odd"><td><em>equalization</em></td>
<td>no</td>
<td>yes</td>
<td>voltage is very high</td>
</tr>
</tbody>
</table>
<p>A charger is typically called one of these:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name of Charger</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>trickle charger</em></td>
<td>float stage only</td>
</tr>
<tr class="row-odd"><td><em>two stage charger</em></td>
<td>bulk followed by the float stage</td>
</tr>
<tr class="row-even"><td><em>three stage charger</em></td>
<td>bulk followed by absorption, followed by float</td>
</tr>
</tbody>
</table>
<p>The <em>equalization</em> stage is so dangerous that it doesn’t happen automatically,
it has to be manually set by the user.</p>
<p>It has been found that when you charge batteries with three stage chargers, the
process of plate sulphation is slower than it would be with a two stage charger.
If such a charger is also equipped with the equalization feature, a knowledgeable
user can keep their battery’s healthy for a long time.</p>
<p>Let’s look at the three stage charging electrical profile:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_all.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_all.svg" src="_images/three_stage_charging_all.svg" /></div>
</a>
<p>That diagram is not going to win any graphic design awards, but it shows you
everything you need to know about building a charger.  We need two control
systems, one that can hold current to a constant level and one that can hold the
voltage to a constant level.  We need to track time, so that we can exit a stage
if the charger has been in it too long.  And we need to be able to set some
parameters based on the kind of battery we are attached too.</p>
<p>The bulk stage is where the battery is charged quickly.  Charging the battery is
what our customer’s care about the most, but battery maintenance is very
important too.</p>
<p>The charger will have a rated current, the more money we put into its hardware,
the higher this current can be.  The problem is if we over-build this, our
charger will be too big for a lot of systems and these customers will buy
someone else’s product because it is cheaper than ours.</p>
<p>A way to solve this problem is to build a charger that can be ganged together
with more versions of itself.  That way we can keep the costs low, and if a
customer needs a lot of current, they can buy as many of our products as they
need and gang them together in parallel.</p>
<p>The added benefit of this approach is that if one of their chargers fails, there
batteries can still be charged by the others in their system.  It offers them
some resilience.  If they felt so inclined, they could actually over-build their
charging system to increase their system’s reliability (think military
contracts).  Batteries are expensive, heavy and dangerous, and chargers are
relatively cheap and easy to work with and install.</p>
<p>Another problem our customers have is with the parameters.  We can’t expect them
to figure out what all of the values and time-outs mean.  They really don’t
care, we need to eat this complexity on their behalf, especially if we are
expecting them to buy a bunch of our products for a single installation.</p>
<hr class="docutils" />
<p>Often the hardest thing to do on a project is to pack knowledge into a
specification (spec).  The specification should be simple and full of pictures,
if it isn’t nobody will look a it, and nobody will change it to match what the
system actually does.  Engineers talk with pictures, because pictures transmit
more information than writing.  Pictures also illicit conversation which moves
relevant personal knowledge into project knowledge:  When you are talking to
technical people they often forget that they know a lot of things you don’t
know. If you are both pointing to and talking about a picture, you will both
learn more about each others contribution and thinking in regards to the
project.  Once things are discovered from one another they should be packed into
a couple of notes and pictures and added to the spec.</p>
<p>The spec should be short enough that it can be read and understood by everyone
involved.  If specific drawings are too technical for some members, efforts
should be made to explain what they mean so everyone can participate in the
conversation.  Here is an example of such a conversation to discover how to
build a single three stage battery charger.  But if you want to skip the
conversation and just jump to the design, click <a class="reference internal" href="#batterychargingexample-single-unit-three-stage-battery-charger-design"><span class="std std-ref">here</span></a>.</p>
<hr class="docutils" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">New knowledge and things said by other imagined people will be
<span class="new-spec">highlighted.</span></p>
</div>
<p>Specification (1):</p>
<ul class="simple">
<li><span class="new-spec">A charger has two control systems: constant current and constant voltage.</span></li>
<li><span class="new-spec">The bulk stage is a constant current control technique.</span></li>
<li><span class="new-spec">The absorption, float and equalization stages are constant voltage control
techniques.</span></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_1.svg" src="_images/three_stage_charging_chart_1.svg" /></div>
</a>
<p>I show the above diagram to the <span class="new-spec">electrical engineer</span> I’m working with, and he says,
<span class="new-spec">Yeah, it looks good, but can you make sure the two control systems are
generalizeable?</span>  What do you mean?  <span class="new-spec">Well, I want to just give the current
control system a reference current and it will drive the device to output that
current.  The same idea applies to the voltage controller.</span>  He continues,
<span class="new-spec">A control system is just some math, you give it a goal called a “reference”.
then you give it the value of the thing it is trying to control, call this the
“input” and the math will drive the “output” towards the goal.  We connect
this output value to our hardware and it will behave as expected.  I want to use
the same math to solve the current and voltage control problems, so give me a
reference and give me the input and I’ll make it work.</span></p>
<p>You turn to leave and he says, <span class="new-spec">Oh, one more thing, I need to tune the
two control systems differently, so make sure I can set some variables “ki”,
“kp” and “kd”.  That should be good</span>.</p>
<p>So now we have to start thinking about all of the parameters, each can be
changed for a different battery type.  We change the language on the diagram to
match how our electrical engineer talks about things.</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_parameters.svg" src="_images/three_stage_charging_parameters.svg" /></div>
</a>
<p>After we update the image we show our electrical engineer the new picture.  He
looks at it and asks, <span class="new-spec">What are these arrows connecting the boxes
together?</span> You answer, it’s just a way of saying that the <code class="docutils literal notranslate"><span class="pre">reference</span></code>,
<code class="docutils literal notranslate"><span class="pre">input</span></code>, <code class="docutils literal notranslate"><span class="pre">kp</span></code>, <code class="docutils literal notranslate"><span class="pre">ki</span></code> and <code class="docutils literal notranslate"><span class="pre">kd</span></code> values will be in both of the current and
voltage control classes.  It’s just a drawing short hand.   He says,
<span class="new-spec">Ok, it looks good.</span></p>
<hr class="docutils" />
<p>Specification (2):</p>
<ul class="simple">
<li>A charger has two control systems: constant current and constant voltage.</li>
<li>The bulk stage is a constant current control technique.</li>
<li>The absorption, float and equalization stages are constant voltage control
techniques.</li>
<li><span class="new-spec">The electrical profile of the system will look like this:</span></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_parameters.svg" src="_images/three_stage_charging_parameters.svg" /></div>
</a>
<ul class="simple">
<li><span class="new-spec">The behavior of the system will look like this:</span></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_1.svg" src="_images/three_stage_charging_chart_1.svg" /></div>
</a>
<hr class="docutils" />
<p>We still haven’t solved the parameter issue.  I need to create a data structure
that has the control system information and the battery stuff in one place.  How
about this:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_parameters_2.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_parameters_2.svg" src="_images/three_stage_charging_parameters_2.svg" /></div>
</a>
<p>So we make a <code class="docutils literal notranslate"><span class="pre">ChargerParameter</span></code> class that “has a” (black diamond arrow)
<code class="docutils literal notranslate"><span class="pre">CurrentControlSystem</span></code>, a <code class="docutils literal notranslate"><span class="pre">VoltageControlSystem</span></code> and some
<code class="docutils literal notranslate"><span class="pre">BatterySpecificInformation</span></code>.</p>
<p>OK, we know how our data is structured, now we need to go back to our behavioral
diagram and figure out how to get information from the world.</p>
<p>We go back to the electrical engineer and ask him, “How fast to I need to read
the voltage and the current?”  He says, <span class="new-spec">Well, I have to read these
values very quickly in the embedded device’s interrupt service routines, the
control systems will be running at 20 Khz, but you don’t have to worry about
that.  Changing between the various stages can happen slowly.  I’ll be reading
the input, I’ll use raw ADC readings to keep my code fast and I’ll use the PWM
peripherals on the part to set the output current and voltage via an H-bridge.
But I will need you to determine which control system to run and I’ll need you
to set it’s reference.  Make it so I can tune these values later if I need to,
but for now you can sample the current, voltage and make decisions at 2 Hz”.
(every 0.5 seconds)</span></p>
<p>You say, “Wait, I’m not controlling the current or voltage?”.  He laughs and
says, <span class="new-spec">Not with Python you aren’t, but you control which control
system will run, and you will control that controllers reference and tuning
parameters, think meta, man!</span></p>
<p>Here we are seeing some of the power of statecharts.  They allow us to wrap deep
expertise inside of a system with a rich set of other features.  The electrical
engineer will manage the control system and the circuits needed to make the
device work, but that is where his expertise stops.  We need to manage which of
the control strategies are applied, and what their goals are.</p>
<p>Let’s pack this new knowledge into our pictures.  Let’s start with the data
model.  We want to attach it to our statechart so that our statechart can use
it:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_data.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_2_data.svg" src="_images/three_stage_charging_chart_2_data.svg" /></div>
</a>
<p>We talk to the electrical engineer again and he says, <span class="new-spec">What are those
diamond arrows?</span>  You answer, it’s just a way of saying one class has an
attribute of another class.  For instance the <code class="docutils literal notranslate"><span class="pre">battery_spec</span></code> in the
<code class="docutils literal notranslate"><span class="pre">ChargerParameter</span></code> class is a <code class="docutils literal notranslate"><span class="pre">BatterySpecificInformation</span></code> class.  You leave
the <code class="docutils literal notranslate"><span class="pre">BatterySpecificInformation</span></code> class on the picture so you can see what it’s
attribute names are.</p>
<p><span class="new-spec">It seems kind of complicated, can you just show me in code?</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ControlSystem</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># ..</span>

 <span class="k">class</span> <span class="nc">CurrentControlSystem</span><span class="p">(</span><span class="n">ControlSystem</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

 <span class="k">class</span> <span class="nc">VoltageControlSystem</span><span class="p">(</span><span class="n">ControlSystem</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

 <span class="k">class</span> <span class="nc">BatterySpecificSettings</span><span class="p">:</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">bulk_timeout_sec</span> <span class="o">=</span> <span class="mi">700</span>
     <span class="c1"># ..</span>

 <span class="k">class</span> <span class="nc">ChargerParameters</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">c_control</span> <span class="o">=</span> <span class="n">CurrentControlSystem</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">v_control</span> <span class="o">=</span> <span class="n">VoltageControlSystem</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span> <span class="o">=</span> <span class="n">BatterySpecificSettings</span><span class="p">()</span>

 <span class="k">class</span> <span class="nc">Charger</span><span class="p">(</span><span class="n">ChargerParameters</span><span class="p">,</span> <span class="n">CustomFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="c1"># ..</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">charger</span> <span class="o">=</span> <span class="n">Charger</span><span class="p">()</span>
    <span class="n">charge</span><span class="o">.</span><span class="n">c_control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mf">40.0</span>
    <span class="n">charge</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_timeout_sec</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="c1"># ..</span>
</pre></div>
</div>
<p>He looks at the picture and the code for a while, then says, <span class="new-spec">OK, I
see how it works, but why are the diamond arrows backwards?</span>  You answer, “The
head of the diamond describes who owns the other thing.  If you want to know why
it was set that way you will have to ask the committee that decided this in the
1990’s”</p>
<p>Then he asks, <span class="new-spec">What’s the ball and the stick?</span>  That’s where the data will
connect to the software that drives the charger’s behavior.  The behavior will need the
data, and if you see the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> class inherits from the <code class="docutils literal notranslate"><span class="pre">CustomFactory</span></code>
class which contains all of the code that can drive behavior.  Inheritance is
just programming by difference, that arrow is like a copy and paste, it’s as if
I have copied and pasted all of that <code class="docutils literal notranslate"><span class="pre">CustomFactory</span></code> and <code class="docutils literal notranslate"><span class="pre">ChargerParameters</span></code>
code into the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> class.  The ball is just short hand for saying the
data attaches to the behavior here.  The “here” in this case is the “charging
state” which will be described somewhere else.  He looks confused, and says,
<span class="new-spec">I guess you will have to show me when you make it.</span></p>
<hr class="docutils" />
<p>The data model seems good enough so let’s start designing the system behavior.
We need to start programming time, so we will construct three heart beats,
something that will sample the current, something that will sample the voltage
and something that will drive the statechart’s decisions.  To make current and
voltage readings, we create two hooks in the charging state.  Finally, we make
sure that these heart beats are turned off when we leave the state; we can’t
remember why this is important, but we know it is.</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_chart.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_2_chart.svg" src="_images/three_stage_charging_chart_2_chart.svg" /></div>
</a>
<p>We also adjust the chart so that the correct control system is selected when we
enter a charging stage, and then we use our data model and our behavior to
select which current or voltage reference will be set in each stage.</p>
<p>Now we want to talk to our electrical engineer about behavior, but we know we
should accompany the statechart diagram with the electrical profile, or it might
be a bit much for him.</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_2_graph.svg" src="_images/three_stage_charging_chart_2_graph.svg" /></div>
</a>
<p>We show him the diagram, and say, “Listen, some stuff is missing on this, but I
just want you to look at how the current and voltage are sampled, and how the
control systems are set up.”  He says, <span class="new-spec">Ok, show me.</span></p>
<p>You say, “In the entry stage we create three different named pulses that repeat
forever, or until the charging state is exited. The chart can react to these
named pulses and change state, or just run some code.” I pause and look at him,
he says, <span class="new-spec">Keep going.</span></p>
<p>“Alright, see that <code class="docutils literal notranslate"><span class="pre">Sample_Current</span></code> pulse, it will fire forever with a period of
<code class="docutils literal notranslate"><span class="pre">cur_in_sec</span></code> which we will probably just set to 0.5 seconds, but we can tune
it, we can make this something else if we need to.”</p>
<p>“The <code class="docutils literal notranslate"><span class="pre">Sample_Current</span></code> and <code class="docutils literal notranslate"><span class="pre">Sample_Voltage</span></code> events will be sent at the chart
and the chart will react to them, but in our case, we just hook these signals
to sample the current and voltage.  The chart won’t actually change state when
these events are seen by it, it will just use the events to update a <code class="docutils literal notranslate"><span class="pre">curr</span></code>
and <code class="docutils literal notranslate"><span class="pre">volt</span></code> attribute in it’s data structure so these values can be kept fresh
enough that the chart can make good decisions with the information.”</p>
<p>“Does that make sense?”  <span class="new-spec">Yeah, it’s just a timer right?</span>  You answer,
“Yeah, but look there is another one, called <code class="docutils literal notranslate"><span class="pre">Pulse</span></code>, it’s not wired up yet,
but soon it will be the thing that drives the chart’s decisions”</p>
<p>“Now I’ll show you how the controllers are set up.  After the charging state is
entered, it will set up these pulses, then it will enter the bulk state.  When
it enters the <code class="docutils literal notranslate"><span class="pre">constant_current_state</span></code>, it sets the control system to use the
<code class="docutils literal notranslate"><span class="pre">CurrentControlSystem</span></code> and then when it enters the bulk state, it sets the
reference of this control system to be <code class="docutils literal notranslate"><span class="pre">battery_spec.ref_amps</span></code> from our data
model.”</p>
<p>He looks at it for a while, and says, <span class="new-spec">Yeah, this is what I wanted, ok,
yeah, I get it.  How do I get into the other states?</span>  “I haven’t set that up
yet, but suppose we were to enter the <code class="docutils literal notranslate"><span class="pre">absorption</span></code> state, we would first have
to enter the <code class="docutils literal notranslate"><span class="pre">constant_voltage_state</span></code>.  This would cause our control system to
change, we would detach the current control system, and attach the voltage
control system.  We would then use all of that control system’s <code class="docutils literal notranslate"><span class="pre">kp</span></code>, <code class="docutils literal notranslate"><span class="pre">ki</span></code>
and <code class="docutils literal notranslate"><span class="pre">kd</span></code> parameters.”  <span class="new-spec">Yeah, ok, good, this is what I wanted.</span></p>
<p>Things seem to be coming together, so we go back and work on our spec, teasing
apart our high level descriptions from our technical design.</p>
<hr class="docutils" />
<p>Specification iteration 3:</p>
<p><strong>High level Specification (3)</strong></p>
<ul class="simple">
<li>This product will be a three stage charger with an equalization feature.</li>
<li>The charger has two control systems: constant current and constant voltage.</li>
<li>The bulk stage is a constant current control technique.</li>
<li>The absorption, float and equalization stages are constant voltage control
techniques.</li>
<li><span class="new-spec">The charging electrical profile can be seen here</span></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_2_graph.svg" src="_images/three_stage_charging_chart_2_graph.svg" /></div>
</a>
<p><strong>Sofware Functional Specification (3)</strong></p>
<ul class="simple">
<li><span class="new-spec">The software system will be broken into two parts, fast running c code and slower running Python code</span></li>
<li><span class="new-spec">The c code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</span></li>
<li><span class="new-spec">The Python code will determine which control strategy the c code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit</span></li>
<li><span class="new-spec">The Python code will sample the current and voltage and make decisions every 0.5 seconds</span></li>
<li><span class="new-spec">The Python data architecture can be seen here.</span></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_data.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_2_data.svg" src="_images/three_stage_charging_chart_2_data.svg" /></div>
</a>
<ul class="simple">
<li><span class="new-spec">The Python behavioral architecture can be seen here.</span></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_chart.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_2_chart.svg" src="_images/three_stage_charging_chart_2_chart.svg" /></div>
</a>
<hr class="docutils" />
<p>Let’s wire up the <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> event and add more functionality to our chart.  We
want the charger to:</p>
<blockquote>
<div><ul class="simple">
<li>change it’s charging state to match our electrical/time profile</li>
<li>be able to be forced into any of the charge states</li>
</ul>
</div></blockquote>
<p>Here is a new design that does these things:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_chart.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_3_chart.svg" src="_images/three_stage_charging_chart_3_chart.svg" /></div>
</a>
<p>Since there is a need for timeouts in various states, we invent a new signal
called <code class="docutils literal notranslate"><span class="pre">Tick</span></code>.  <code class="docutils literal notranslate"><span class="pre">Tick</span></code> is driven by our <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> event, and it is given a payload
which is the time in seconds since the charging state was entered.</p>
<p>Time to show our electrical engineer.</p>
<p>We approach him with the diagrams and he says, <span class="new-spec">Ok walk me through
it</span>.  “When the <code class="docutils literal notranslate"><span class="pre">charging</span></code> state is entered the <code class="docutils literal notranslate"><span class="pre">sec</span></code> is set to 0, then the
three heart beats are initiated.  Two of the heart beats drive the current and
voltage readings, but the third heart beat, <code class="docutils literal notranslate"><span class="pre">Pulse</span></code>, will fire every
<code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code> seconds.  We will probably set <code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code> to 0.5.  The key
thing to notice on this picture is that Pulse drives another event called
<code class="docutils literal notranslate"><span class="pre">Tick</span></code> which is given a payload of <code class="docutils literal notranslate"><span class="pre">sec</span></code> which is how much time has passed
since the charging state was entered.”</p>
<p><span class="new-spec">Wait, how does this tick thing work?</span>.  “When system turns on the
first thing that will happen is it will enter the <code class="docutils literal notranslate"><span class="pre">charging</span></code> state. When the
<code class="docutils literal notranslate"><span class="pre">charging</span></code> state is entered a bunch of heart beats are setup, these are
basically named timers, <code class="docutils literal notranslate"><span class="pre">Sample_Current</span></code>, <code class="docutils literal notranslate"><span class="pre">Sample_Voltage</span></code> and <code class="docutils literal notranslate"><span class="pre">Pulse</span></code>.
Then the charging state initializes, causing a transition into the <code class="docutils literal notranslate"><span class="pre">bulk</span></code>
state.  While this happens, the <code class="docutils literal notranslate"><span class="pre">constant_current_state</span></code> is entered, setting
the control system to use your current control system, then it enters the
<code class="docutils literal notranslate"><span class="pre">bulk</span></code> state, which sets the reference of your current control system.”  He
looks at the diagram and after some time says, <span class="new-spec">Ok, yeah, I see that,
but how does this pulse stuff work?</span></p>
<p>“The Pulse event will fire every, say 0.5 seconds, but it is caught by a hook,
which invents another signal called <code class="docutils literal notranslate"><span class="pre">Tick</span></code> which has a payload, <code class="docutils literal notranslate"><span class="pre">sec</span></code>.  The
<code class="docutils literal notranslate"><span class="pre">sec</span></code> payload of the Tick signal will have the time in seconds since the
charging state was entered.  It’s this <code class="docutils literal notranslate"><span class="pre">Tick</span></code> event, which can make stuff
happen.  Do you see it?”  <span class="new-spec">I see it.  So how do these charging stage
time outs work?  Can you show me the electrical profile and the statechart
timing mechanisms together?</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_graph.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_3_graph.svg" src="_images/three_stage_charging_chart_3_graph.svg" /></div>
</a>
<p>“Ok, so first of all we enter the bulk state, then we start getting <code class="docutils literal notranslate"><span class="pre">Tick</span></code>
events with <code class="docutils literal notranslate"><span class="pre">sec</span></code> payloads representing the amount of time in seconds since
the beginning of <code class="docutils literal notranslate"><span class="pre">charging</span></code>.  Notice that when the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state is entered,
the time at which this happened is squirreled away in the <code class="docutils literal notranslate"><span class="pre">start_sec</span></code>
attribute.  From then on, every <code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code> a <code class="docutils literal notranslate"><span class="pre">Tick</span></code> signal will be seen by
the bulk state.  Your current control system will charge the battery.  While this
is happening the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state will see a whole lot of <code class="docutils literal notranslate"><span class="pre">Tick</span></code> events which it
will ignore.  But once the time in bulk is equal to or greater than
<code class="docutils literal notranslate"><span class="pre">abs_timeout_sec</span></code> or if the battery voltage is equal to or greater than
<code class="docutils literal notranslate"><span class="pre">bulk_exit_volt</span></code>, the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state will post a <code class="docutils literal notranslate"><span class="pre">To_Abs</span></code> event to the chart.”</p>
<p>“The <code class="docutils literal notranslate"><span class="pre">To_Abs</span></code> event, will cause an exit from the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state, then an exit
from the <code class="docutils literal notranslate"><span class="pre">constant_current_control</span></code> state.  Then it will enter into the
<code class="docutils literal notranslate"><span class="pre">constant_voltage_control</span></code> state, which will switch the control system to use
a voltage controller, then enter the <code class="docutils literal notranslate"><span class="pre">absorption</span></code> state which will set the
voltage reference to <code class="docutils literal notranslate"><span class="pre">abs_ref_volts</span></code>”.  <span class="new-spec">I see how it works and I
see how the same thing happens for transitions to float from absorption.  Also,
I see that you can only force your way into the equalize state, that’s good eh.</span></p>
<p>He looks a bit longer and says, <span class="new-spec">So the charger will try and spend
most of its time in float eh? But how to we get back into bulk if there is a big
draw on the batteries? Say our customer has a big DC load that draws the voltage
down below the bulk_entry_volts.  What happens then?</span></p>
<p>You look at the chart and see that you can’t get back into bulk, “Right now you
can’t, I missed that, but let me fix it”  You spend a moment adjusting the
chart, “Look at this:”</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_chart_1.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_3_chart_1.svg" src="_images/three_stage_charging_chart_3_chart_1.svg" /></div>
</a>
<p>“See how I adjusted the <code class="docutils literal notranslate"><span class="pre">Sample_Voltage</span></code> hook to post a <code class="docutils literal notranslate"><span class="pre">To_Bulk</span></code> signal when
the voltage is below the <code class="docutils literal notranslate"><span class="pre">bulk_entry_volts</span></code>.  I have added a <code class="docutils literal notranslate"><span class="pre">To_Bulk</span></code> hook
in the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state which blocks this event from causing a transition from
<code class="docutils literal notranslate"><span class="pre">charging</span></code> to <code class="docutils literal notranslate"><span class="pre">bulk</span></code> while the unit is in bulk but the voltage is still
lower than the <code class="docutils literal notranslate"><span class="pre">bulk_exit_volts</span></code>.”  He asks, <span class="new-spec">Why would that happen?</span>.  “The
charger would probably need some time to get the voltage above the
<code class="docutils literal notranslate"><span class="pre">bulk_entry_volts</span></code> once it fell below this threshold, maybe because of a big
DC draw on the battery.”  He says, <span class="new-spec">Yeah, that will probably happen in
some situations</span>.</p>
<p>You ask him, “Do we need to separate the timing of our current, voltage and
decision pulses?”  He says, <span class="new-spec">No, it’s not that important, what’s the
cost of having extra timers anyway?</span>  “It’s not a big deal, just each heart beat
will have it’s own thread, and when I’m looking at the logs it could get kind of
cluttered having all of those signals firing at the same time.  So, maybe I could
simplify the design by just having one heart beat.”  <span class="new-spec">Yeah, simple is
good, we probably won’t need separate timers.</span></p>
<p>You spend a moment adjusting the chart.  “Here, it’s less cluttered now”:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_chart_2.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_3_chart_2.svg" src="_images/three_stage_charging_chart_3_chart_2.svg" /></div>
</a>
<p>Do you see anything else we could pull out of there?  <span class="new-spec">No, it seems
pretty compact, how are you going to test this thing anyway?  I’m not going to
have hardware for you for a couple of weeks, can you test it before that?</span>.
“I will run it on a PC and feed it fake electrical profiles, I also plan
to squeeze time so I can run it through all of it’s states quickly”.</p>
<p>Things seem to be coming together, so we go back and work on our spec, teasing
apart our high level descriptions from our technical design.</p>
<div class="section" id="single-unit-three-stage-battery-charger-design">
<span id="batterychargingexample-single-unit-three-stage-battery-charger-design"></span><h2>Single Unit Three Stage Battery Charger Design<a class="headerlink" href="#single-unit-three-stage-battery-charger-design" title="Permalink to this headline">¶</a></h2>
<p><strong>High level Specification (4)</strong></p>
<ul class="simple">
<li>This product will be a three stage charger with an equalization feature.</li>
<li>The charger has two control systems: constant current and constant voltage.</li>
<li>The bulk stage is a constant current control technique.</li>
<li>The absorption, float and equalization stages are constant voltage control
techniques.</li>
<li>The charging electrical profile can be seen here</li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_2_graph.svg" src="_images/three_stage_charging_chart_2_graph.svg" /></div>
</a>
<p><strong>Sofware Functional Specification (4)</strong></p>
<ul class="simple">
<li>The software system will be broken into two parts, fast running c code and slower running Python code</li>
<li>The c code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</li>
<li>The Python code will determine which control strategy the c code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit</li>
<li>The Python code will sample the current and voltage and make decisions every 0.5 seconds</li>
<li>The Python data architecture can be seen here.</li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_data.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_4_data.svg" src="_images/three_stage_charging_chart_4_data.svg" /></div>
</a>
<ul class="simple">
<li>The Python behavioral architecture can be seen here.</li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_chart.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_4_chart.svg" src="_images/three_stage_charging_chart_4_chart.svg" /></div>
</a>
<hr class="docutils" />
<p>We have enough knowledge now to build something.  Let’s start with the data
model:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_data.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_4_data.svg" src="_images/three_stage_charging_chart_4_data.svg" /></div>
</a>
<p>The code to make this model can be found <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/single_unit_three_stage_charger_1.py">here</a></p>
<p>It would be simple enough to adjust our code to use a SQL database, or an
object-relational-mapper, like <a class="reference external" href="https://www.sqlalchemy.org">SQLAlchemy</a> to
track the different types of battery specifications.  For now we will leave our
model as Python code, but if you had a lot of different battery types, you might
want to keep them in a database.</p>
<p>Next, let’s write the statechart:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_chart.pdf"><div align="center" class="align-center"><img alt="_images/three_stage_charging_chart_4_chart.svg" src="_images/three_stage_charging_chart_4_chart.svg" /></div>
</a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Charger</span><span class="p">(</span><span class="n">ChargerParameters</span><span class="p">,</span> <span class="n">LoggedBehavior</span><span class="p">,</span> <span class="n">ThreadSafeAttributes</span><span class="p">):</span>

  <span class="c1"># The charger will be multithreaded, provide simple locks around data</span>
  <span class="c1"># accesses to these attributes</span>
  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;amps&#39;</span><span class="p">,</span>
    <span class="s1">&#39;volts&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sec&#39;</span><span class="p">,</span>
    <span class="s1">&#39;control&#39;</span><span class="p">,</span>
  <span class="p">]</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">charger_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pulse_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Three stage battery charger feature management</span>

<span class="sd">    This class will manage the data and the behavior of our three stage</span>
<span class="sd">    battery charger.  The control systems used by the charge will be</span>
<span class="sd">    written in c, but the reference and turning parameters of these</span>
<span class="sd">    controllers will be accessible to this python code via SWIG.</span>

<span class="sd">    To understand this class reference:</span>

<span class="sd">      1) the three stage charging electrical profile drawing:</span>

<span class="sd">      2) the three stage charging data architecture drawing:</span>

<span class="sd">      3) the three stage charging state chart drawing:</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``name`` (str): name of the charging state chart</span>
<span class="sd">       | ``charger_params=None`` (ChargerParameters):</span>
<span class="sd">       |                           parameters/controller</span>
<span class="sd">       |                           needed by charger</span>
<span class="sd">       | ``live_trace=None(bool)``: enable live_trace feature?</span>
<span class="sd">       | ``live_spy=None(bool)``: enable live_spy feature?</span>
<span class="sd">       | ``pulse_sec=None``(float): how often to same current/voltage</span>
<span class="sd">       |                            and make decisions about</span>
<span class="sd">       |                            state changes</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      ccs = CurrentControlSystem(# ...)</span>
<span class="sd">      vcs = VoltageControlSystem(# ...)</span>
<span class="sd">      battery_spec = BatterySpecificationSettings(# ...)</span>
<span class="sd">      charge_params = ChargerParameters(</span>
<span class="sd">        c_control=ccs,</span>
<span class="sd">        v_control=vcs,</span>
<span class="sd">        battery_spec=battery_spec)</span>

<span class="sd">      three_stage_charger = Charger(</span>
<span class="sd">        &#39;charger&#39;,</span>
<span class="sd">        charger_params=charger_params,</span>
<span class="sd">        live_trace=True)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pulse_sec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">pulse_sec</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">pulse_sec</span>
    <span class="n">c_control</span> <span class="o">=</span> <span class="n">charger_params</span><span class="o">.</span><span class="n">c_control</span>
    <span class="n">v_control</span> <span class="o">=</span> <span class="n">charger_params</span><span class="o">.</span><span class="n">v_control</span>
    <span class="n">battery_spec</span> <span class="o">=</span> <span class="n">charger_params</span><span class="o">.</span><span class="n">battery_spec</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
      <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
      <span class="n">live_trace</span><span class="o">=</span><span class="n">live_trace</span><span class="p">,</span>
      <span class="n">live_spy</span><span class="o">=</span><span class="n">live_spy</span><span class="p">,</span>
      <span class="n">c_control</span><span class="o">=</span><span class="n">c_control</span><span class="p">,</span>
      <span class="n">v_control</span><span class="o">=</span><span class="n">v_control</span><span class="p">,</span>
      <span class="n">battery_spec</span><span class="o">=</span><span class="n">battery_spec</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">charging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;charging&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Pulse</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_pulse</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Bulk</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_to_bulk</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Bulk</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_bulk</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Abs</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_to_abs</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Abs</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_abs</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Float</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_to_float</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Float</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_float</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Equ</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_equ</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;constant_current_control&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
          <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;constant_voltage_control&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY</span><span class="p">,</span>
          <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contant_voltage_control_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;bulk&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Bulk</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_to_bulk</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_tick</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;absorption&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_tick</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">float_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">equalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;equalize&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize_tick</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">charging_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Pulse</span><span class="p">),</span>
      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
      <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse_sec</span><span class="p">,</span>
      <span class="n">times</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">amps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_current</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">volts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_voltage</span><span class="p">()</span>
    <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_entry_volts</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Bulk</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse_sec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
      <span class="n">payload</span><span class="o">=</span><span class="n">SecInCharge</span><span class="p">(</span><span class="n">sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_to_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_to_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_to_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_equ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Pulse</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">constant_current_control_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_control</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">contant_voltage_control_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_voltage</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">bulk_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">referece</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_ref_amps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">bulk_to_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">bulk_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">&gt;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_timeout_sec</span> <span class="ow">or</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">volts</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_exit_volts</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Abs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">absorption_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">abs_ref_volts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">absorption_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">&gt;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">abs_timeout_sec</span> <span class="ow">or</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">amps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">abs_exit_amps</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Float</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">float_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">float_ref_volts</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">equalize_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">equ_ref_volts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">equalize_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">&gt;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">equ_timeout_sec</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Float</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">sample_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return 20 amps&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="mi">20</span>

  <span class="k">def</span> <span class="nf">sample_voltage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return 12 volts&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="mi">12</span>
</pre></div>
</div>
<p>You can see the full code listing <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/single_unit_three_stage_charger_2.py">here</a>.</p>
<p>Before we continue, let’s tune the trace and spy instrumentation to write to a
log file.  We will do this by writing a <code class="docutils literal notranslate"><span class="pre">LoggedBehavior</span></code> class which forces
the trace and spy to write to a log file called “single_unit_three_stage_charger.log”.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LoggedBehavior</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">log_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> \
      <span class="k">else</span> <span class="n">live_trace</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> \
      <span class="k">else</span> <span class="n">live_spy</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="s1">&#39;single_unit_three_stage_charger.log&#39;</span> \
      <span class="k">if</span> <span class="n">log_file</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file</span>

    <span class="c1"># clear our old log file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
      <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
      <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span>
      <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span>
      <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span>
      <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;trace without datetimestamp&#39;&#39;&#39;</span>
    <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;spy with machine name pre-pending&#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>
</pre></div>
</div>
<p>To see the behavior of the chart we need to setup a data model, then create
the statechart.  We will do this at the bottom of the <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/single_unit_three_stage_charger_2.py">file</a>
so it’s easy to test.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="c1"># current control system</span>
  <span class="n">ccs</span> <span class="o">=</span> <span class="n">CurrentControlSystem</span><span class="p">(</span>
    <span class="n">reference</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span>  <span class="c1"># 50 amps</span>
    <span class="n">kp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">ki</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
    <span class="n">kd</span><span class="o">=</span><span class="mf">0.04</span>
  <span class="p">)</span>

  <span class="c1"># voltage control system</span>
  <span class="n">vcs</span> <span class="o">=</span> <span class="n">VoltageControlSystem</span><span class="p">(</span>
    <span class="n">reference</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="c1"># 12 volts</span>
    <span class="n">kp</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">ki</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="n">kd</span><span class="o">=</span><span class="mf">0.005</span>
  <span class="p">)</span>

  <span class="c1"># battery specification</span>
  <span class="n">battery_spec</span> <span class="o">=</span> <span class="n">BatterySpecificationSettings</span><span class="p">(</span>
    <span class="n">bulk_timeout_sec</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
    <span class="n">abs_timeout_sec</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">equ_timeout_sec</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>
    <span class="n">bulk_entry_volts</span><span class="o">=</span><span class="mf">18.0</span><span class="p">,</span>
    <span class="n">bulk_exit_volts</span><span class="o">=</span><span class="mf">28.0</span><span class="p">,</span>
    <span class="n">abs_exit_amps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">bulk_ref_amps</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
    <span class="n">float_ref_volts</span><span class="o">=</span><span class="mf">24.0</span><span class="p">,</span>
    <span class="n">abs_ref_volts</span><span class="o">=</span><span class="mf">28.0</span><span class="p">,</span>
    <span class="n">equ_ref_volts</span><span class="o">=</span><span class="mf">30.0</span>
  <span class="p">)</span>

  <span class="c1"># aggregated charger paramters</span>
  <span class="n">charger_params</span> <span class="o">=</span> <span class="n">ChargerParameters</span><span class="p">(</span>
    <span class="n">c_control</span><span class="o">=</span><span class="n">ccs</span><span class="p">,</span>
    <span class="n">v_control</span><span class="o">=</span><span class="n">vcs</span><span class="p">,</span>
    <span class="n">battery_spec</span><span class="o">=</span><span class="n">battery_spec</span>
  <span class="p">)</span>

  <span class="c1"># the charger data and behavior</span>
  <span class="n">three_stage_charger</span> <span class="o">=</span> <span class="n">Charger</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;charger&#39;</span><span class="p">,</span>
    <span class="n">charger_params</span><span class="o">=</span><span class="n">charger_params</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>When we run this <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/single_unit_three_stage_charger_2.py">code</a>
it will write our custom <code class="docutils literal notranslate"><span class="pre">spy</span></code> and <code class="docutils literal notranslate"><span class="pre">trace</span></code> output to the log file.</p>
<p>To view the results, you can <cite>cat</cite> and grep for the <code class="docutils literal notranslate"><span class="pre">trace</span></code> log:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s1">&#39;single_unit_three_stage_charger.log&#39;</span> <span class="p">|</span> grep T:
<span class="m">19</span>:54:21,801 DEBUG:T: <span class="o">[</span>charger<span class="o">]</span> e-&gt;start_at<span class="o">()</span> top-&gt;constant_current_control
<span class="m">19</span>:54:22,304 DEBUG:T: <span class="o">[</span>charger<span class="o">]</span> e-&gt;To_Bulk<span class="o">()</span> constant_current_control-&gt;bulk
</pre></div>
</div>
<p>Or view the <code class="docutils literal notranslate"><span class="pre">spy</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat <span class="s1">&#39;single_unit_three_stage_charger.log&#39;</span> <span class="p">|</span> grep S:
.
.
.
<span class="m">19</span>:56:38,706 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">0</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="m">19</span>:56:39,204 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:bulk
<span class="m">19</span>:56:39,204 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:constant_current_control
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:charging
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> POST_FIFO:To_Bulk
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> POST_FIFO:Tick
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:charging:HOOK
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">2</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="m">19</span>:56:39,206 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> To_Bulk:bulk
<span class="m">19</span>:56:39,206 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> To_Bulk:bulk:HOOK
<span class="m">19</span>:56:39,206 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">1</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="m">19</span>:56:39,207 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Tick:bulk
<span class="m">19</span>:56:39,207 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Tick:bulk:HOOK
<span class="m">19</span>:56:39,207 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">0</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Our electrical engineer comes up to us, <span class="new-spec">How is it going?</span>, you
answer, “No plan ever survives first contact with the enemy.”</p>
<p><span class="new-spec">That well hey?</span> “It’s going well enough, I have the data model
and statechart written, I can see that it might be working, and I only had
to change a few things in the design do get it there.  Now I have to figure
out how to test it.”</p>
<p><span class="new-spec">Any ideas?</span>.  “I would like to feed in a graph or a CSV file,
and have the statechart respond to the graph.  I would have to instrument
it in such a way that the statechart’s log output would be easy to
interpret next to the graph.”</p>
<p><span class="new-spec">If you figure that out, I would like to use it too.  That’s the
nice thing about software, it’s so gullible, it’s so easy to lie to
software eh?</span>  You look at him for a while, and say, “yeah, I guess you are
right, maybe I could mock it out using dependency injection via subclassing
or something like that”.  <span class="new-spec">Why do you software guys always invent
these complicated names for things?</span>  You think for a while and surprise
him with an answer, “I think it happens because we try to keep everything
as general as possible, and we aren’t that creative about naming, because
naming isn’t the thing we think is important at the time, we are usually
trying to solve a specific problem when we come up with the name.  So you
think of something, and the first idea is usually bad, but you don’t care
and you move on.  Then that name sticks and everyone else has to endure
your shitty name.  Nobody has control of the language once it is released
to the public, so the language just lingers around like a bad smell.” He
laughs and says, <span class="new-spec">Well at least you aren’t using Latin.</span></p>
<p><span class="new-spec">Why don’t you just add your testing design into the spec, this
stuff you have written needs to work, or you could burn down someone’s
house eh?  No pressure, eh?  Just add it to the spec, then make it happen.</span></p>
<hr class="docutils" />
<p><a class="reference internal" href="examples.html#examples"><span class="std std-ref">back to examples</span></a></p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Distributed Battery Charging Example</a><ul>
<li><a class="reference internal" href="#single-unit-three-stage-battery-charger-design">Single Unit Three Stage Battery Charger Design</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="examples.html">Examples</a><ul>
      <li>Previous: <a href="towardsthefactoryexample.html" title="previous chapter">Using and Unwinding a Factory</a></li>
      <li>Next: <a href="cellular_automata.html" title="next chapter">Cellular Automata</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/batterychargingexample.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Scott Volk.
      
      |
      <a href="_sources/batterychargingexample.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>