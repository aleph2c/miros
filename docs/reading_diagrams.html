
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Diagrams &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Examples" href="examples.html" />
    <link rel="prev" title="Tutorial: Zero To One" href="zero_to_one.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <blockquote id="reading-diagrams-reading-diagrams">
<div><p><em>If I can’t picture it, I can’t understand it</em></p>
<p class="attribution">&mdash;Albert Einstein</p>
</div></blockquote>
<blockquote>
<div><p><em>Obey, cooperate, diverge</em></p>
<p class="attribution">&mdash;Chinese Proverb</p>
</div></blockquote>
<div class="section" id="diagrams">
<h1>Diagrams<a class="headerlink" href="#diagrams" title="Permalink to this headline">¶</a></h1>
<div class="section" id="history-and-context">
<span id="reading-diagrams-history-and-context"></span><h2>History and Context<a class="headerlink" href="#history-and-context" title="Permalink to this headline">¶</a></h2>
<p>In the 1990s a number of people got together an collected all of the different
popular ways of drawing pictures of software into one standard called UML
(<a class="reference external" href="https://xkcd.com/927/">unified</a> modeling language).  The Harel formalism
(the way David Harel wanted us to draw statecharts) was included in UML.</p>
<p>Unfortunately, UML has fallen out of favor because the committees developing it
built something that the general software community didn’t want.  There are many
different reasons for this, but it is safe to say that it is no longer popular.
In fact, UML, in some ways, has become a kind of anti-brand.</p>
<p>The UML mission was noble, to create an object-oriented-picture language that
could be used to build working systems.  But the broader software community
didn’t want a separate picture language, they wanted some simple and common
drawing techniques that would help them communicate their thinking in a compact
form.</p>
<p>To make a picture language, or any programming language is complicated, so as
the rules governing the picture language became more complex, it became less
useful for those who just wanted to use it to share ideas.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Aspects of UML are still alive and well.  They have been integrated into
model-driven development tools like those provided by Matlab.  It makes sense
to have these diagrams under the control of a single, well funded software
company, closely integrated with the mathematical theory used for control
systems, FFTs and that kind of thing.</p>
<p>As processors become ever more complicated (<a class="reference external" href="http://www.ti.com/tool/HERCULES-DSPLIB">A technical reference manual is
typically over 2000 pages now</a>),
the software specialists at Matlab work hand in hand with the hardware
vendors that have developed the new processors.  This means they eat the
mundane and arcane complexity on your behalf, by providing code which will
automatically write the software drivers needed to control the hardware.</p>
<p class="last">This unlocks the engineer from being drown in the specifics, it gives them
the power to quickly develop working prototypes.  It comes at a cost; you no
longer practice programming, you practice the Matlab user interface.  But
your increase in capability may be worth it for the productivity gain.</p>
</div>
<p>UML was written for the C++ tradition of object oriented programming.  Python
also uses this tradition, so this means that UML fits tightly to Python.  So we
have some useful tools and drawing techniques for compacting our designs into a
set of images.</p>
<p>Martin Fowler rendered down the complexity of the UML standard into: <a class="reference external" href="https://martinfowler.com/books/uml.html">UML
distilled</a>.  If you want a very solid
understanding about Harel formalism as it relates to UML, go to the source and
read <a class="reference external" href="https://sourceforge.net/projects/qpc/files/doc/PSiCC2.pdf/download">Practical UML Statecharts in C/C++, 2nd Edition</a> by Miro
Samek.</p>
<p>But do you need to read these books before you use UML? No, because we are not
going to treat UML as a formal computer language with mathematical semantics. We
will use UML as something to sketch with.  The formal language we will use is
Python.</p>
<p>This section should give you enough information so that you can make your own
pictures.</p>
<div class="section" id="the-most-important-rule-in-uml">
<span id="reading-diagrams-the-most-important-rule-in-uml"></span><h3>The Most Important Rule in UML<a class="headerlink" href="#the-most-important-rule-in-uml" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p><em>Software modelers depend on and use engineering analogies but often fail to
understand them.  Engineers realize that the models aren’t the product; they’re
abstractions of the product.  In fact, in most cases, the models are only
partial abstractions of the product, used to hightlight aspects that the
engineer should know about the product.  The term *executable specification</em>
is an oxymoron – if the specification were truly executable, it would
actually be “the thing”.  Otherwise, it would merely model “the thing,” which
by definition is partial and incomplete.*</p>
<p class="attribution">&mdash;Dave Thomas</p>
</div></blockquote>
<p><strong>You don’t have to draw everything on your picture.</strong></p>
</div>
<div class="section" id="classes">
<span id="reading-diagrams-classes"></span><h3>Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h3>
<p>The class is a blueprint for an object.</p>
<p>Typically, your class diagram would have a name and it would describe the
important variables (attributes) and functions (methods) of your class.  I tend
to put a little line between these when I’m diagramming them.</p>
<a class="reference external image-reference" href="_static/class_1.pdf"><div align="center" class="align-center"><img alt="_images/class_1.svg" src="_images/class_1.svg" /></div>
</a>
<p>If your class inherits from another class, you draw it with the inheritance
arrow (the ToasterOven <em>is an</em> ActiveObject):</p>
<a class="reference external image-reference" href="_static/class_2.pdf"><div align="center" class="align-center"><img alt="_images/class_2.svg" src="_images/class_2.svg" /></div>
</a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ToaterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="c1"># ...</span>
</pre></div>
</div>
<hr class="docutils" />
<p>If the object that is instantiated from your class, constructs another
object, of another class, you can draw this with the composite arrow (The toaster
oven <em>has a</em> light):</p>
<a class="reference external image-reference" href="_static/class_3.pdf"><div align="center" class="align-center"><img alt="_images/class_3.svg" src="_images/class_3.svg" /></div>
</a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">light</span> <span class="o">=</span> <span class="n">Light</span><span class="p">()</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<hr class="docutils" />
<p>If your object references another object that already exists, you can draw this
with an aggregation arrow (The toaster oven <em>has a</em> relay).</p>
<a class="reference external image-reference" href="_static/class_4.pdf"><div align="center" class="align-center"><img alt="_images/class_4.svg" src="_images/class_4.svg" /></div>
</a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">relay</span> <span class="o">=</span> <span class="n">Relay</span><span class="p">()</span>

<span class="c1"># ...</span>
<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relay</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relay</span> <span class="o">=</span> <span class="n">relay</span>
    <span class="c1"># ...</span>

<span class="n">toaster_oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">relay</span><span class="p">)</span>
</pre></div>
</div>
<p id="reading-diagrams-backwards-arrows">Oh, but wait, did you notice the aggregation and composition arrows are
backwards?  This was done for a good reason, the arrow head (diamond looking
thing) is on the side that owns the other thing.  So at a glance you can see who
owns what.</p>
<a class="reference external image-reference" href="_static/arrow_pear.pdf"><div align="center" class="align-center"><img alt="_images/arrow_pear.svg" src="_images/arrow_pear.svg" /></div>
</a>
<p>The composite arrow is black because when your object is destroyed, so is the
object that it has built within it.</p>
<a class="reference external image-reference" href="_static/arrow_pear_2.pdf"><div align="center" class="align-center"><img alt="_images/arrow_pear_2.svg" src="_images/arrow_pear_2.svg" /></div>
</a>
<p>These mnemonics should help you when you are diagramming.</p>
</div>
<div class="section" id="inheritance-and-miros">
<span id="reading-diagrams-inheritance"></span><h3>Inheritance and miros<a class="headerlink" href="#inheritance-and-miros" title="Permalink to this headline">¶</a></h3>
<p>Within the context of this library, you would inherit from either the
ActiveObject or the ActiveFactory to gain access to the event processor, and all
of the other useful methods which would drive your statechart.  Then, you can
either attach this class directly to your statechart, or make an intermediate
class that holds all of your worker-functions for the thing you are trying to
build.</p>
<a class="reference external image-reference" href="_static/class_6.pdf"><div align="center" class="align-center"><img alt="_images/class_6.svg" src="_images/class_6.svg" /></div>
</a>
<p>Inheritance is patching.  Patching is easy for a computer to do, but it’s a lot
harder for a human mind.  In the 1990’s when object oriented programming was
<em>the</em> raging fad, the computer science community really over-emphasized this
feature.  We have since learned that inheritance is like any good vitamin, if
you use too much of it, it becomes hazardous to your well-being.</p>
<p>So don’t over use inheritance or you will make your code <em>really</em> hard to debug
and maintain:</p>
<a class="reference external image-reference" href="_static/class_7.pdf"><div align="center" class="align-center"><img alt="_images/class_7.svg" src="_images/class_7.svg" /></div>
</a>
<p>It makes sense to inherit from an ActiveObject or an ActiveFactory, because you
probably have no intention of debugging this library’s code.  If you make a
subclass of one of these classes, you can put your specific worker functions and
named attributes in it; but will you ever need to subclass beyond that point?
Probably not; inheritance can get you into a lot of trouble if it’s too deep.</p>
<p>If you are going to inherit ask yourself if the “is-a”, or “is-an”, relationship
holds true when you use the two class names in a sentence.  “The ToasterOven
class is an ActiveObject”; yes, that makes sense.  Ok, I’ll use inheritance.</p>
<p>If you want all of the states of your statechart to react the same when they see
a specific event, use the <a class="reference internal" href="patterns.html#patterns-ultimate-hook"><span class="std std-ref">ultimate hook pattern</span></a>.
This gives you all of the benefits of inheritance while still having debuggable
code.</p>
</div>
<div class="section" id="events">
<span id="reading-diagrams-events"></span><h3>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h3>
<p>Any code which uses the miros library is event-driven.</p>
<p>On your drawings the events are represented as the hook descriptions on the
upper left part of a state, or by the arrows which point from one state to
another.  In the special case of the <strong>init</strong> event, it is represented as the
black dot with an arrow on it.</p>
<p>There can be many events which all share the same name; an event’s name is
called a signal.  An event can also carry a python object with it as a payload.
You draw how an event will be handled by your statechart, by drawing arrows or
hooks labeled with that event’s signal name.  If your event has a payload, draw the
structure into which you will place that payload.</p>
<p>The event that is not a hook, is like a named marble that can roll on a groove,
described by the arrows of your statechart.  You can think of the groove as
being pitched so that a marble can only roll in one direction.  Any groove can
have software written on it, but this software will only run when a marble rolls
over it.  This is how these grooves can be drawn with UML:</p>
<a class="reference external image-reference" href="_static/Transition_Triggers.pdf"><div align="center" class="align-center"><img alt="_images/Transition_Triggers.svg" src="_images/Transition_Triggers.svg" /></div>
</a>
<p>In English, the above diagram would say, “If I receive an event with a signal
name SIGNAL_NAME while I am in source_state, run the guard, if it returns True,
run the action() function within the context of the source state, then add the
EVT_A event to my fifo queue so that it can be run during my next RTC process,
then transition to the target_state, but, if my guard code returns False, do not
transition, but let the SIGNAL_NAME event propagate outward.”</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On the <code class="docutils literal notranslate"><span class="pre">^EVT_A</span></code> shorthand.</p>
<p>In miros there are many different ways to post events.  You can post to a
fifo; <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> and you can post to a lifo, <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code>.  You can even
publish an event, so that another concurrent statechart will receive the
message.  So, to use the <code class="docutils literal notranslate"><span class="pre">^EVT_A</span></code> in UML isn’t descriptive capture miro’s
capabilities.</p>
<p class="last">As a rule, if I see <code class="docutils literal notranslate"><span class="pre">^EVT_A</span></code> I will assume that it is using the
<code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> API, and if I need to be specific, I will write the code that
performs the post directly on the diagram.</p>
</div>
<p>The above diagram written as <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/guard_example.py">code</a>,
could look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># guard_example.py</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="n">OptionalPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;OptionalPayload&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>

 <span class="k">def</span> <span class="nf">guard</span><span class="p">():</span>
   <span class="sd">&#39;&#39;&#39;should we let an event pass?&#39;&#39;&#39;</span>
   <span class="k">return</span> <span class="bp">True</span>

 <span class="k">def</span> <span class="nf">action</span><span class="p">():</span>
   <span class="sd">&#39;&#39;&#39;some code to run when the event occurs (on the arrow)&#39;&#39;&#39;</span>
   <span class="k">print</span><span class="p">(</span><span class="s1">&#39;some action&#39;</span><span class="p">)</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">source_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">):</span>
</span><span class="hll">     <span class="k">if</span> <span class="n">guard</span><span class="p">():</span>
</span><span class="hll">       <span class="n">action</span><span class="p">()</span>  <span class="c1"># perform some action on this event</span>
</span><span class="hll">
</span><span class="hll">       <span class="c1"># the EVT_A event will be posted after we have</span>
</span><span class="hll">       <span class="c1"># finish our transition</span>
</span><span class="hll">       <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EVT_A</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">       <span class="c1"># transition to the target_state</span>
</span><span class="hll">       <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">target_state</span><span class="p">)</span>
</span>   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">target_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

   <span class="c1"># event arrow example</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;eae&#39;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">source_state</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">,</span>
     <span class="n">payload</span><span class="o">=</span><span class="n">OptionalPayload</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)))</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>This will produce the following trace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mf">14.851</span><span class="p">]</span> <span class="p">[</span><span class="n">eae</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">source_state</span>
<span class="n">some</span> <span class="n">action</span>
<span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mf">14.853</span><span class="p">]</span> <span class="p">[</span><span class="n">eae</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">SIGNAL_NAME</span><span class="p">()</span> <span class="n">source_state</span><span class="o">-&gt;</span><span class="n">target_state</span>
</pre></div>
</div>
<hr class="docutils" />
<p>Your event can also run some code without causing a state transition; this is
called a hook:</p>
<a class="reference external image-reference" href="_static/hook_diagram_1.pdf"><div align="center" class="align-center"><img alt="_images/hook_diagram_1.svg" src="_images/hook_diagram_1.svg" /></div>
</a>
<p>In English, the above diagram would say, “If I receive an event with a signal
named “SIGNAL_NAME” while I am in source_state, or any of its inner states, run
the guard, if it returns True, run the action().  When I have finished running
the action, do not perform a state transition.  If the guard returned false,
ignore this event and let it percolate outward to my super state”</p>
<p>The above diagram expressed in <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/hook_example_1.py">code</a>
could look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># hook_example_1.py</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="n">OptionalPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;OptionalPayload&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>

 <span class="k">def</span> <span class="nf">guard</span><span class="p">():</span>
   <span class="k">return</span> <span class="bp">True</span>

 <span class="k">def</span> <span class="nf">action</span><span class="p">():</span>
   <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hook code was run {}&#39;</span><span class="p">)</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">):</span>
</span><span class="hll">     <span class="k">if</span> <span class="n">guard</span><span class="p">():</span>
</span><span class="hll">       <span class="n">action</span><span class="p">()</span>
</span><span class="hll">       <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">a1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">a</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="c1"># simple hook example</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;she&quot;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">OptionalPayload</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
   <span class="c1"># starting another thread, let it run for a moment before we shut down</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
   <span class="k">print</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
</pre></div>
</div>
<p>This will produce the following trace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">08</span> <span class="mi">21</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mf">57.385487</span><span class="p">]</span> <span class="p">[</span><span class="n">she</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="n">hook</span> <span class="n">code</span> <span class="n">was</span> <span class="n">run</span> <span class="mi">2</span>
<span class="n">a1</span>
</pre></div>
</div>
<hr class="docutils" />
<p>If I would like my hook to stop the event from being handled outside of the
state, I would handle it with the hook, but I would show that I’m doing nothing
with it by drawing <code class="docutils literal notranslate"><span class="pre">{}</span></code> in the action part of the hook.</p>
<a class="reference external image-reference" href="_static/hook_diagram_2.pdf"><div align="center" class="align-center"><img alt="_images/hook_diagram_2.svg" src="_images/hook_diagram_2.svg" /></div>
</a>
<p>In English, the above diagram would say, “If I receive an event with a signal
named ‘SIGNAL_NAME’ while I am in a1, or any of its inner states (a11), do
not let this event proceed past the a1 boundary, and do not cause a
state transition.”</p>
<p>The above diagram expressed in <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/hook_example_2.py">code</a>
could look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># hook_example_2.py</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="n">OptionalPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;OptionalPayload&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;this code should never run&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">a1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">a</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">a11</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">a1</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="c1"># simple hook example 2</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;she2&quot;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">a11</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">))</span>
   <span class="c1"># starting another thread, let it run for a moment before we shut down</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
   <span class="k">print</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
</pre></div>
</div>
<p>When run the above code will produce the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">09</span> <span class="mo">06</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mf">13.640030</span><span class="p">]</span> <span class="p">[</span><span class="n">she2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">a11</span>
<span class="n">a11</span>
</pre></div>
</div>
<hr class="docutils" />
<p>There are internal and external signals.</p>
<p>The internal signals are ENTRY_SIGNAL, INIT_SIGNAL and EXIT_SIGNAL.  They are
automatically sent to your statechart by the event processor as it solves the
topological problems required to have your program follow the Harel Formalism.</p>
<p>An event with the ENTRY_SIGNAL will be sent to your state as another event has
caused a transition from the outer part of the state to the inner part of the
state.  On the state drawing, it is called <strong>enter</strong> and it follows the same
drawing rules as any other hook.</p>
<p>Conversely, an event with the EXIT_SIGNAL internal signal is send to your state
when another event has caused a transition from inner part of the state to the
outer part of the state.  On the state drawing, it is called <strong>exit</strong> and it
follows the hook drawing rules.</p>
<p>An event called INIT_SIGNAL will be sent to your state, once that state has been
settled into.  On the diagram it is a <strong>large black dot</strong> with an arrow on it.</p>
<a class="reference external image-reference" href="_static/internal_signals_1.pdf"><div align="center" class="align-center"><img alt="_images/internal_signals_1.svg" src="_images/internal_signals_1.svg" /></div>
</a>
<p>Here is some <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/internal_signals_1.py">code</a>
that would map to the above diagram:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># internal_signals_1.py</span>
 <span class="kn">import</span> <span class="nn">time</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&#39;a&#39; entered&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&#39;a&#39; exited&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">   <span class="c1"># need to add an external signal so we can cause exits</span>
</span><span class="hll">   <span class="c1"># for our demo</span>
</span>   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="hll">   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="n">print_string</span>  <span class="o">=</span> <span class="s2">&quot;code to run after &#39;a&#39; entered &quot;</span>
</span><span class="hll">     <span class="n">print_string</span> <span class="o">+=</span> <span class="s2">&quot;and we have settled into &#39;a&#39;, &quot;</span>
</span><span class="hll">     <span class="n">print_string</span> <span class="o">+=</span> <span class="s2">&quot;the INIT_SIGNAL wants us to &quot;</span>
</span><span class="hll">     <span class="n">print_string</span> <span class="o">+=</span> <span class="s2">&quot;transition into &#39;a1&#39;&quot;</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="n">print_string</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
</span>   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">a1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&#39;a1&#39; entered&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&#39;a1&#39; exited&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">a</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="c1"># simple hook example 2</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;she2&quot;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">SIGNAL_NAME</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
   <span class="c1"># starting another thread, let it run for a moment before we shut down</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If we were to run this code we would see:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;a&#39;</span> <span class="n">entered</span>
<span class="s1">&#39;a1&#39;</span> <span class="n">entered</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">09</span> <span class="mo">06</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">53.050553</span><span class="p">]</span> <span class="p">[</span><span class="n">she2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="s1">&#39;a1&#39;</span> <span class="n">exited</span>
<span class="s1">&#39;a&#39;</span> <span class="n">exited</span>
<span class="s1">&#39;a&#39;</span> <span class="n">entered</span>
<span class="n">code</span> <span class="n">to</span> <span class="n">run</span> <span class="n">after</span> <span class="s1">&#39;a&#39;</span> <span class="n">entered</span> <span class="ow">and</span> <span class="n">we</span> <span class="n">have</span> <span class="n">settled</span> <span class="n">into</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
<span class="n">the</span> <span class="n">INIT_SIGNAL</span> <span class="n">wants</span> <span class="n">us</span> <span class="n">to</span> <span class="n">transition</span> <span class="n">into</span> <span class="s1">&#39;a1&#39;</span>
<span class="s1">&#39;a1&#39;</span> <span class="n">entered</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">09</span> <span class="mo">06</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">53.052104</span><span class="p">]</span> <span class="p">[</span><span class="n">she2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">()</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">a1</span>
</pre></div>
</div>
<p>External event signal names are created the moment they are labeled in the code.
Here is some code that shows how this is done:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">my_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">MY_EVENT</span><span class="p">)</span>
<span class="n">my_event_with_payload</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">MY_EVENT</span><span class="p">,</span>
  <span class="n">payload</span><span class="o">=</span><span class="s2">&quot;with a payload that is just a string&quot;</span><span class="p">)</span>

<span class="n">MouseCoordinate</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;MouseCoordinates&quot;</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">&#39;x_px&#39;</span><span class="p">,</span><span class="s1">&#39;y_px&#39;</span><span class="p">,</span><span class="s1">&#39;z_px&#39;</span><span class="p">]</span>

<span class="n">mouse_click_evt</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">MOUSE_CLICK</span><span class="p">,</span>
  <span class="n">payload</span><span class="o">=</span><span class="p">(</span><span class="n">MouseCoordinate</span><span class="p">(</span><span class="n">x_px</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y_px</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">z_pz</span><span class="o">=</span><span class="mi">30</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="section" id="event-processor-attachment-points">
<span id="reading-diagrams-event-processor-connection"></span><h3>Event Processor Attachment Points<a class="headerlink" href="#event-processor-attachment-points" title="Permalink to this headline">¶</a></h3>
<p>The event processor is the rule book for your statechart.  It is the thing that
will cause it to transition from one state to another.  It will trigger
internal events and it will read and run all of your code as your code reacts
to the outside world.</p>
<p>To connect the event processor of your object to a statemachine; inherit it into
the class that will solve your problem, then draw the attachment point like this:</p>
<a class="reference external image-reference" href="_static/attachment_point_1.pdf"><div align="center" class="align-center"><img alt="_images/attachment_point_1.svg" src="_images/attachment_point_1.svg" /></div>
</a>
<p>This attachment point serves double duty, it shows that the event processor drives
the state chart dynamics and it shows were the state machine is started.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I’m not sure if I’m using UML properly according to the standard, and I don’t
really care.  What I care about is if you understand what I mean.</p>
</div>
<p>The above diagram could be <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/attachment_point_1.py">written this way</a>
in Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># attachment_point_1.py</span>
 <span class="kn">import</span> <span class="nn">time</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="k">class</span> <span class="nc">Class1UsedToSolveProblem</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;demonstration class used to show</span>
<span class="sd">        event processor attachment point on statechart diagram</span>

<span class="sd">     **Args**:</span>
<span class="sd">        | ``name`` (string): the name to show up in the trace</span>
<span class="sd">     &#39;&#39;&#39;</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">None</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">None</span>

   <span class="k">def</span> <span class="nf">method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;method 1 called&quot;</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;method 2 called&quot;</span><span class="p">)</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">True</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">True</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hook&#39;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_1</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">inner_state_1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">method_1</span><span class="p">()</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_2</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">method_2</span><span class="p">()</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">inner_state_2</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">True</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">True</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_1</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">False</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">False</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">subclassed_ao</span> <span class="o">=</span> <span class="n">Class1UsedToSolveProblem</span><span class="p">(</span><span class="s1">&#39;subclassed_ao&#39;</span><span class="p">)</span>
   <span class="n">subclassed_ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="hll">   <span class="c1"># this is the attachement point where the event processor</span>
</span><span class="hll">   <span class="c1"># is linking to the statemachine defined above as a set of</span>
</span><span class="hll">   <span class="c1"># functions which reference each other</span>
</span><span class="hll">   <span class="n">subclassed_ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
</span>   <span class="n">subclassed_ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
   <span class="n">subclassed_ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>
   <span class="n">subclassed_ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If you were to run this code you would see something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">method</span> <span class="mi">1</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mf">35.66</span><span class="p">]</span> <span class="p">[</span><span class="n">subclassed_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">inner_state_1</span>
<span class="n">method</span> <span class="mi">2</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mf">35.66</span><span class="p">]</span> <span class="p">[</span><span class="n">subclassed_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">()</span> <span class="n">inner_state_1</span><span class="o">-&gt;</span><span class="n">inner_state_2</span>
<span class="n">method</span> <span class="mi">1</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mf">35.66</span><span class="p">]</span> <span class="p">[</span><span class="n">subclassed_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">()</span> <span class="n">inner_state_2</span><span class="o">-&gt;</span><span class="n">inner_state_1</span>
<span class="n">hook</span>
</pre></div>
</div>
<hr class="docutils" />
<p>In the context of this library an object instantiated with an event processor
can attach itself to a statemachine.  Another object instantiated with a
different event processor can also be attach to the same statemachine.</p>
<a class="reference external image-reference" href="_static/attachment_point_2.pdf"><div align="center" class="align-center"><img alt="_images/attachment_point_2.svg" src="_images/attachment_point_2.svg" /></div>
</a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The statemachine and its functions do not keep track of variables or the
current state; they simply act as a behavioral specification.  The attribute
changes are always performed on the first arguement of the state function,
the state function itself has no memory or notion of the program’s state.</p>
</div>
<p>You could manifest the above diagram in <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/attachment_point_2.py">code like
this</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># attachment_point_2.py</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">Class1UsedToSolveProblem</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;demonstration class used to show</span>
<span class="sd">       event processor attachment point on statechart diagram</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``name`` (string): the name to show up in the trace</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;method 1 called&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;method 2 called&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Class2UsedToSolveProblem</span><span class="p">(</span><span class="n">Class1UsedToSolveProblem</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;demonstration class showing how inheritance can</span>
<span class="sd">       overload methods of an another class, and indepentently attach</span>
<span class="sd">       to the statemachine used by the other class.</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``name`` (string): the name to show up in the trace</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;method 1(overloaded) called&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;method 2(overloaded) called&quot;</span><span class="p">)</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;hook&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner_state_1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">method_1</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_2</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">method_2</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner_state_2</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_1</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">subclassed_ao1</span> <span class="o">=</span> <span class="n">Class1UsedToSolveProblem</span><span class="p">(</span><span class="s1">&#39;subclassed_ao1&#39;</span><span class="p">)</span>
  <span class="n">subclassed_ao1</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="hll">  <span class="c1"># this is the attachement point to the first object</span>
</span><span class="hll">  <span class="n">subclassed_ao1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
</span>  <span class="n">subclassed_ao1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
  <span class="n">subclassed_ao1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>
  <span class="n">subclassed_ao1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>

  <span class="c1"># the two statemachines will be running at the same time in different</span>
  <span class="c1"># threads, so we will delay so we don&#39;t end up with a confusing trace</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="n">subsubclassed_ao2</span> <span class="o">=</span> <span class="n">Class2UsedToSolveProblem</span><span class="p">(</span><span class="s1">&#39;subsubclassed_ao2&#39;</span><span class="p">)</span>
  <span class="n">subsubclassed_ao2</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="hll">  <span class="c1"># this is the attachement point to the second object</span>
</span><span class="hll">  <span class="c1"># (it uses the same statemachine as the first object)</span>
</span><span class="hll">  <span class="n">subsubclassed_ao2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
</span>  <span class="n">subsubclassed_ao2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">subsubclassed_ao2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
  <span class="n">subsubclassed_ao2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>This would produce output like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">method</span> <span class="mi">1</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">22.30</span><span class="p">]</span> <span class="p">[</span><span class="n">subclassed_ao1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">inner_state_1</span>
<span class="n">method</span> <span class="mi">2</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">22.30</span><span class="p">]</span> <span class="p">[</span><span class="n">subclassed_ao1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">()</span> <span class="n">inner_state_1</span><span class="o">-&gt;</span><span class="n">inner_state_2</span>
<span class="n">method</span> <span class="mi">1</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">22.30</span><span class="p">]</span> <span class="p">[</span><span class="n">subclassed_ao1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">()</span> <span class="n">inner_state_2</span><span class="o">-&gt;</span><span class="n">inner_state_1</span>
<span class="n">hook</span>
<span class="n">method</span> <span class="mi">1</span><span class="p">(</span><span class="n">overloaded</span><span class="p">)</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">22.32</span><span class="p">]</span> <span class="p">[</span><span class="n">subsubclassed_ao2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">inner_state_1</span>
<span class="n">hook</span>
<span class="n">method</span> <span class="mi">2</span><span class="p">(</span><span class="n">overloaded</span><span class="p">)</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">22.32</span><span class="p">]</span> <span class="p">[</span><span class="n">subsubclassed_ao2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">()</span> <span class="n">inner_state_1</span><span class="o">-&gt;</span><span class="n">inner_state_2</span>
<span class="n">method</span> <span class="mi">1</span><span class="p">(</span><span class="n">overloaded</span><span class="p">)</span> <span class="n">called</span>
<span class="p">[</span><span class="mo">07</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mf">22.32</span><span class="p">]</span> <span class="p">[</span><span class="n">subsubclassed_ao2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">()</span> <span class="n">inner_state_2</span><span class="o">-&gt;</span><span class="n">inner_state_1</span>
</pre></div>
</div>
<hr class="docutils" />
<p>If you want to embed your state machine within your class, you can, you just
write it’s functions as <code class="docutils literal notranslate"><span class="pre">staticmethods</span></code> and use the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code>.  An
embedded state chart might look like this:</p>
<a class="reference external image-reference" href="_static/attachment_point_4.pdf"><div align="center" class="align-center"><img alt="_images/attachment_point_4.svg" src="_images/attachment_point_4.svg" /></div>
</a>
<p>The <code class="docutils literal notranslate"><span class="pre">Event</span> <span class="pre">Processor</span></code> component in the <code class="docutils literal notranslate"><span class="pre">ClassWithEmbeddedChart</span></code> is taking up
a lot of room on the diagram.  So, why not just keep the bulbus part of its
glyph as a shorthand for the attachment point.  It still shows where we want the
statechart to start:</p>
<a class="reference external image-reference" href="_static/attachment_point_5.pdf"><div align="center" class="align-center"><img alt="_images/attachment_point_5.svg" src="_images/attachment_point_5.svg" /></div>
</a>
<p>Here is the <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/class_with_embedded_chart.py">code</a>
that could manifest the above diagram, notice that the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call is made
within the <code class="docutils literal notranslate"><span class="pre">ClassWithEmbeddedChart</span></code> <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">ClassWithEmbeddedChart</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;demonstration of a miros hierarchical statemachine within a class.</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``name`` (str): The name of this object in the trace instrumentation</span>
<span class="sd">       | ``live_trace=None`` (str): set to true to get a live trace of the chart</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="k">else</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">inner_state_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state_1&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_1_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_1_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_1_b</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">inner_state_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state_2&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_2_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_2_a</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_2_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_2</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>

<span class="hll">    <span class="c1"># this is the attachment point on the diagram</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
</span>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">inner_state_1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hook&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_1_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">method_1</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_1_exit_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">method_2</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_1_b</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">inner_state_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_2_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart_attribute_1</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">chart_attribute_2</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_2_a</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">inner_state_1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_2_exit_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart_attribute_1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">chart_attribute_2</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;calling method_1&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;calling method_2&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">cwec</span> <span class="o">=</span> <span class="n">ClassWithEmbeddedChart</span><span class="p">(</span><span class="s1">&#39;cwec&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">cwec</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
  <span class="n">cwec</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">cwec</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Object Oriented statecharts were first implemented and written about in 1996</p>
</div>
<p>As your team gets used to looking at these kinds of diagrams, you might create a
different short hand for the attachment point, or leave it off of your diagram
all together.</p>
</div>
<div class="section" id="states">
<span id="reading-diagrams-states"></span><h3>States<a class="headerlink" href="#states" title="Permalink to this headline">¶</a></h3>
<p>The states in miros are just functions that you write that will react to events
send to them by an active object’s event processor.  A state function has
two arguments, a reference to the active object calling it and an event.  State
functions typically contain an if-elif-else structure, which describes the event
arrows and hooks on the statechart diagram.  The state function will contain
information about what state wraps it in the diagram (it’s super state), this is
typically expressed in the else clause of it’s if-elif-else structure.  The
state function needs to return predefined information to tell the event
processor how it has reacted to an event; like if it is transitioning, or if the
event was unhandled and needs to be passed to the super state, or if it has been
handled so that the event processor can stop processing the event.</p>
<p>An important thing to remember is that a state function will be called many
times by the event processor while it is trying to find the answers to different
questions.  The state function can be asked for its super state, or it can be
asked how it handles a particular event.  The state function acts as a node in a
graph and a behavioral specification.</p>
<p>If you look at the following diagram, you will see we need to define three state
functions.</p>
<a class="reference external image-reference" href="_static/attachment_point_1.pdf"><div align="center" class="align-center"><img alt="_images/attachment_point_1.svg" src="_images/attachment_point_1.svg" /></div>
</a>
<p>You can see the code that could implement this design <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/attachment_point_1.py">here</a>.</p>
<p>The outer_state code could look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>

  <span class="c1"># return_status contain information about how this state</span>
  <span class="c1"># has reacted to the event,</span>
  <span class="c1"># we initialize our return status it to UNHANDLED,</span>
  <span class="c1"># so that if an event guard fails the event can percolate outward</span>
  <span class="c1"># to its superstate (parent state)</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># e, is the event that is being sent to this state function by the event</span>
  <span class="c1"># processor</span>
  <span class="c1">#</span>
  <span class="c1"># The signals object contains all of the signals that are used by this</span>
  <span class="c1"># statechart, the ENTRY_SIGNAL is an internal signal which is sent to the</span>
  <span class="c1"># this function by the event processor.</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="c1"># we are reacting to the entry event on the diagram</span>
    <span class="c1"># we only change variables on the first argument of our function, like</span>
    <span class="c1"># we would if it was named &#39;self&#39; in a typical Python method</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># this state wants to tell the event processor this event was handled</span>
    <span class="c1"># do not percolate outward in the graph (it wouldn&#39;t anyway for internal</span>
    <span class="c1"># signals)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1"># The INIT_SIGNAL is the big black dot on the diagram.  It is the &quot;now</span>
  <span class="c1"># what&quot; signal.  We have landed in the outer_state, now what?  Well our</span>
  <span class="c1"># diagram tells use we want a transition to inner_state_1</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="c1"># We are reacting to the init event</span>

     <span class="c1"># Here we tell the event processor that we want it to transition to a</span>
     <span class="c1"># different state by feeding the state function of our target as an</span>
     <span class="c1"># argument to the trans method.</span>
     <span class="c1"># The trans method will determine what we want  to return from</span>
     <span class="c1"># this function.</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_1</span><span class="p">)</span>

  <span class="c1"># The Hook signal name is an external signal name, something that is</span>
  <span class="c1"># specific to this design.  The first time, miros sees `Hook` in an event</span>
  <span class="c1"># it invents it and appends it to the signals object. (lightweight</span>
  <span class="c1"># metaprogramming)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
    <span class="c1"># We are reacting to the Hook event on the diagram.</span>
    <span class="c1">#</span>
    <span class="c1"># This is what we want to happen if the Hook event is sent to the state</span>
    <span class="c1"># chart while it is in this state, or the inner_state_1 or the</span>
    <span class="c1"># inner_state_2</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hook&quot;</span><span class="p">)</span>
    <span class="c1"># This is the code that makes the handing of this event a hook,</span>
    <span class="c1"># or an event which causes  code to run without causing a</span>
    <span class="c1"># state transition.  Here we tell the event processor to stop searching.</span>

    <span class="c1"># So imagine that we were in the inner_state_2 and a &#39;Hook&#39; event was</span>
    <span class="c1"># sent to the chart, the above code would run and the chart would remain</span>
    <span class="c1"># in the inner_state_2 state.</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># We specifically write what our outer state function is, since there</span>
    <span class="c1"># isn&#39;t one for outer_state, we use the special `top` attribute of the</span>
    <span class="c1"># active object to indicate to the event processor that we are at the</span>
    <span class="c1"># outermost state of our design.</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="c1"># We tell the event processor that we are in the &quot;set-super&quot; part of our</span>
    <span class="c1"># state function.  We landed here because the event sent was not handled</span>
    <span class="c1"># by the if-elif part of our function above.</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>

  <span class="c1"># tell the event processor how we dealt with the event</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The inner_state_1 and inner_state_2 state functions would look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inner_state_1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">method_1</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_2</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">method_2</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">inner_state_2</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state_1</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_1</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">attribute_2</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<hr class="docutils" />
<dl class="docutils">
<dt>There are two different ways to draw a state on a diagram:</dt>
<dd><ul class="first last simple">
<li>simple states</li>
<li>composite states</li>
</ul>
</dd>
</dl>
<p>Here is a simple state, you would use it when drawing a finite state machine:</p>
<a class="reference external image-reference" href="_static/simple_state_1.pdf"><div align="center" class="align-center"><img alt="_images/simple_state_1.svg" src="_images/simple_state_1.svg" /></div>
</a>
<p>Here is an example of a finite state machine (FSM) – An oven.</p>
<a class="reference external image-reference" href="_static/simple_state_2.pdf"><div align="center" class="align-center"><img alt="_images/simple_state_2.svg" src="_images/simple_state_2.svg" /></div>
</a>
<p>To make such a finite statemachine with miros is very straight forward, you just
set your state function super states to the <code class="docutils literal notranslate"><span class="pre">top</span></code> attribute of the
ActiveObject.  Here is some code that the above diagram could model:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">bake_pressed</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">heating</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">off_pressed</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">too_hot</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idling</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">idling</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">too_cold</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">heating</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Notice that the <strong>init</strong> signal is not written into the code, instead we use the
<code class="docutils literal notranslate"><span class="pre">start_at</span></code> method to attach our ActiveObject to the off state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;simple_fsm_2&#39;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="hll">   <span class="c1"># attach the ActiveObject&#39;s event processor to the state machine</span>
</span>   <span class="c1"># and start its thread</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">bake_pressed</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">off_pressed</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">bake_pressed</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">too_hot</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">too_cold</span><span class="p">))</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If we run it we see that it works:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">12</span> <span class="mo">07</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">10.304293</span><span class="p">]</span> <span class="p">[</span><span class="n">simple_fsm_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">12</span> <span class="mo">07</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">10.305574</span><span class="p">]</span> <span class="p">[</span><span class="n">simple_fsm_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">bake_pressed</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">heating</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">12</span> <span class="mo">07</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">10.306446</span><span class="p">]</span> <span class="p">[</span><span class="n">simple_fsm_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">off_pressed</span><span class="p">()</span> <span class="n">heating</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">12</span> <span class="mo">07</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">10.307243</span><span class="p">]</span> <span class="p">[</span><span class="n">simple_fsm_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">bake_pressed</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">heating</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">12</span> <span class="mo">07</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">10.308006</span><span class="p">]</span> <span class="p">[</span><span class="n">simple_fsm_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">too_hot</span><span class="p">()</span> <span class="n">heating</span><span class="o">-&gt;</span><span class="n">idling</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">12</span> <span class="mo">07</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">10.308924</span><span class="p">]</span> <span class="p">[</span><span class="n">simple_fsm_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">too_cold</span><span class="p">()</span> <span class="n">idling</span><span class="o">-&gt;</span><span class="n">heating</span>
</pre></div>
</div>
<p>So, to get a finite state machine working with miros, we must know that the
<strong>init</strong> glyph is just a synonym for the attachment point:</p>
<a class="reference external image-reference" href="_static/simple_state_3.pdf"><div align="center" class="align-center"><img alt="_images/simple_state_3.svg" src="_images/simple_state_3.svg" /></div>
</a>
<hr class="docutils" />
<p>The UML term for a state, which can have other states inside of it, is called a
“composite state”.  Here is what it looks like:</p>
<a class="reference external image-reference" href="_static/composite_state_1.pdf"><div align="center" class="align-center"><img alt="_images/composite_state_1.svg" src="_images/composite_state_1.svg" /></div>
</a>
<p>It shares the same rounded rectangular look of the simple state icon, but it
also has a bar across the top, above which, you type the state’s name.  The name
of the state is placed at the top like this to separate it away from the rest of
the rounded rectangle’s inner area.  The majority of the compound state’s inner
area serves as a canvas where you will draw your inner states, hooks, event
arrows…  etc.</p>
<p>In miros, all states are composite states.</p>
<p>Here is a simple hierarchical state machine (HSM) – A slightly better oven:</p>
<a class="reference external image-reference" href="_static/composite_state_2.pdf"><div align="center" class="align-center"><img alt="_images/composite_state_2.svg" src="_images/composite_state_2.svg" /></div>
</a>
<p>Any state-looking-widget on your diagram that actually isn’t a state, is called
a <strong>pseudostate</strong>.  For instance, on our diagram, the black initialization dot
and the H with a star beside it (deep history) are both called pseudostates.</p>
<p>We will talk about these shortly.</p>
<p>If you had to draw your statechart into a diagram that didn’t have enough room
for it, you might want to simplify it into a compacted representation.  This
would let the person reading your diagram know that there is more to it, but
that it was simplified on your picture so that everything would fit on the page.
This is called <strong>decomposition hiding</strong>.  I’ll demonstrate this by hiding some
of the details of our HSM oven:</p>
<a class="reference external image-reference" href="_static/composite_state_3.pdf"><div align="center" class="align-center"><img alt="_images/composite_state_3.svg" src="_images/composite_state_3.svg" /></div>
</a>
<p>I have hidden the majority of the door_closed state in the decomposition hiding
state icon.  When you see this icon, you know that some details have been hidden
to make the diagram fit on a page.  But there is a good chance that I am
breaking the UML standard by drawing the above diagram the way I did.  I’m
hiding the door_closed state, yet I’m showing part of it’s design.  I’m showing
an arrow going into the door_closed state, and showing it land on a deep history
icon.  So, am I hiding the state or not?  Well, I’m doing both.  I’m trying to
explain the gist of the hidden part of the design: to go back to the previous
sub-state of the door_closed part of the statechart, when the door is opened
after the over was in a door_open state.  I’m trying to show this
history-behavior is happening without going into the details of what substates
exist within the door_closed state.</p>
<p>When you sketch your diagrams without adhering to a rigid set of drawing rules,
you can make decisions like this.  The diagrams act as sketches rather than a
programming language.</p>
</div>
<div class="section" id="deep-history-icon">
<span id="reading-diagrams-deep-history-dot"></span><h3>Deep History Icon<a class="headerlink" href="#deep-history-icon" title="Permalink to this headline">¶</a></h3>
<p>If an event has caused you to leave a state deeply embedded in your statechart,
but you would like to transition back to that state after the interruption, you
can use the deep history pseudostate, it’s a circle enclosing a H*:</p>
<a class="reference external image-reference" href="_static/TransitionToHistoryStatePattern.pdf"><div align="center" class="align-center"><img alt="_images/TransitionToHistoryStatePattern.svg" src="_images/TransitionToHistoryStatePattern.svg" /></div>
</a>
<p>The <a class="reference internal" href="patterns.html#patterns-transition-to-history"><span class="std std-ref">transition to history</span></a> section of the
patterns part of this document goes into the details about how to implement this in code.</p>
</div>
<div class="section" id="if-else-structures">
<span id="reading-diagrams-if-structures"></span><h3>If-Else Structures<a class="headerlink" href="#if-else-structures" title="Permalink to this headline">¶</a></h3>
<p>If you would like an event to be managed in different ways depending on some
condition, you would use an if-else structure.  In UML your if-else structures look
like diamonds with an event guard written on one of the arrows:</p>
<a class="reference external image-reference" href="_static/if_else_1.pdf"><div align="center" class="align-center"><img alt="_images/if_else_1.svg" src="_images/if_else_1.svg" /></div>
</a>
</div>
<div class="section" id="extending-arrows">
<span id="reading-diagrams-extending-arrows"></span><h3>Extending Arrows<a class="headerlink" href="#extending-arrows" title="Permalink to this headline">¶</a></h3>
<p>Often you will find it tricky to get all of your arrows packed onto your page.
If a number of arrows share the same kind of action, you can “join” them using a
bar:</p>
<a class="reference external image-reference" href="_static/join_1.pdf"><div align="center" class="align-center"><img alt="_images/join_1.svg" src="_images/join_1.svg" /></div>
</a>
<p>You can also “fork” them using a bar too:</p>
<a class="reference external image-reference" href="_static/fork_1.pdf"><div align="center" class="align-center"><img alt="_images/fork_1.svg" src="_images/fork_1.svg" /></div>
</a>
</div>
<div class="section" id="terminate-icon">
<span id="reading-diagrams-terminate-pseudostate"></span><h3>Terminate Icon<a class="headerlink" href="#terminate-icon" title="Permalink to this headline">¶</a></h3>
<p>If you want to destroy your statechart upon reacting to an event, you can use
the terminate pseudostate (icon).</p>
<a class="reference external image-reference" href="_static/terminate_1.pdf"><div align="center" class="align-center"><img alt="_images/terminate_1.svg" src="_images/terminate_1.svg" /></div>
</a>
<p>Here is some code that shows a trivial statechart being terminated with the
ActiveObject’s <code class="docutils literal notranslate"><span class="pre">stop</span></code> method.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this picture’s code example we will turn on
the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>, and <a class="reference internal" href="recipes.html#recipes-scribble-on-the-spy"><span class="std std-ref">scribble</span></a> onto its output.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">some_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Destroy_This_Chart</span><span class="p">):</span>
<span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span>    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;Terminating Thread&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;some_state&#39;</span><span class="p">)</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="hll">  <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Destroy_This_Chart</span><span class="p">))</span>
</span>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>If we were to run this code we would see:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">START</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">some_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">some_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">some_state</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Destroy_This_Chart</span><span class="p">:</span><span class="n">some_state</span>
<span class="n">Terminating</span> <span class="n">Thread</span>
<span class="n">Destroy_This_Chart</span><span class="p">:</span><span class="n">some_state</span><span class="p">:</span><span class="n">HOOK</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">1</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="final-icon">
<span id="reading-diagrams-final-state"></span><h3>Final Icon<a class="headerlink" href="#final-icon" title="Permalink to this headline">¶</a></h3>
<p>If your event has completed all of the work required in the enclose region, you
can draw this with the final state icon:</p>
<a class="reference external image-reference" href="_static/final_1.pdf"><div align="center" class="align-center"><img alt="_images/final_1.svg" src="_images/final_1.svg" /></div>
</a>
<p>It might make sense to use this if you want some code to run upon the
initialization of the state, but you do not want to transition deeper into the
state machine:</p>
<a class="reference external image-reference" href="_static/final_2.pdf"><div align="center" class="align-center"><img alt="_images/final_2.svg" src="_images/final_2.svg" /></div>
</a>
<p>Here is some code that would answer this design:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># final_icon_example_1.py</span>
 <span class="kn">import</span> <span class="nn">time</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
<span class="hll">       <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run code, but don&#39;t transition out of outer_state&quot;</span><span class="p">)</span>
</span><span class="hll">       <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Retry</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="k">else</span> <span class="bp">True</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>We are writing our debug code onto the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy instrumentation</span></a> using its <a class="reference internal" href="recipes.html#recipes-scribble-on-the-spy"><span class="std std-ref">scribble</span></a>
feature, so we have to turn on the spy instrumentation to see it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;final_icon&#39;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="hll">   <span class="n">ao</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>
</span>   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Retry</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Retry</span><span class="p">))</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If you run this code you will see the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">START</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="hll"><span class="n">run</span> <span class="n">code</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">&#39;t transition out of outer_state</span>
</span><span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Retry</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">1</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Retry</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">Retry</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="hll"><span class="n">run</span> <span class="n">code</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">&#39;t transition out of outer_state</span>
</span><span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The above final pseudostate example could have been made with a statechart
wrapped within a class:</p>
<a class="reference external image-reference" href="_static/final_3.pdf"><div align="center" class="align-center"><img alt="_images/final_3.svg" src="_images/final_3.svg" /></div>
</a>
<p>Here is some code which interlocks with the above design diagram:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">import</span> <span class="nn">time</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="k">class</span> <span class="nc">InstrumentedFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

 <span class="k">class</span> <span class="nc">FinalIconExample</span><span class="p">(</span><span class="n">InstrumentedFactory</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;statechart demonstration the final icon</span>

<span class="sd">     **Args**:</span>
<span class="sd">        | ``name`` (str): name of the statechart</span>
<span class="sd">        | ``condition`` (bool): do we want to transition into the inner state?</span>
<span class="sd">        | ``live_trace=None``: enable live_trace feature?</span>
<span class="sd">        | ``live_spy=None``: enable live_spy feature?</span>

<span class="sd">     **Example(s)**:</span>

<span class="sd">     .. code-block:: python</span>

<span class="sd">        FinalIconExample(name=&#39;final_icon&#39;, condition=True)</span>

<span class="sd">     &#39;&#39;&#39;</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Retry</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_retry</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
<span class="hll">       <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run code, but don&#39;t transition out of outer_state&quot;</span><span class="p">)</span>
</span><span class="hll">       <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>     <span class="k">return</span> <span class="n">status</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">outer_state_retry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">condition</span> <span class="k">else</span> <span class="bp">True</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">FinalIconExample</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;final_icon&#39;</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Retry</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Retry</span><span class="p">))</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If you were to run this code you would see a spy output very similar to the
first example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">START</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Retry</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">Retry</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="hll"><span class="n">run</span> <span class="n">code</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">&#39;t transition out of outer_state</span>
</span><span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">1</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Retry</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer_state</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">inner_state</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="fall-through">
<h3>Fall Through<a class="headerlink" href="#fall-through" title="Permalink to this headline">¶</a></h3>
<p>The miros event handler can do something that I haven’t seen specified anywhere,
it can do a kind of <a class="reference external" href="https://en.wikipedia.org/wiki/Catch_and_release">catch-and-release</a>, where an event can be
processed by a state, then released outward into the statechart to be processed
by another, outer, state.  This event bubbling continues until the event falls
off the edge of the chart or is handled by a hook.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is not in the UML standard</p>
</div>
<a class="reference external image-reference" href="_static/fall_through_1.pdf"><div align="center" class="align-center"><img alt="_images/fall_through_1.svg" src="_images/fall_through_1.svg" /></div>
</a>
<p>I draw this with an un-attached, or an unhandled, arrow.  The arrow has code
marked on it, but it does not connect to anything, to express that it is not
handled within the current state region; the event processor will recurse
outward in it’s search to find where it is handled.</p>
<p>The action on the “unhandled” arrow is a search side effect that can provide
some useful features.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">a0</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Bubbling</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span>
      <span class="s2">&quot;finally hooked by a0, but state remains as {}&quot;</span><span class="o">.</span>
      <span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">state_name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">a1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Bubbling</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;caught and released by a1&quot;</span><span class="p">)</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">a0</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">a2</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Bubbling</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;caught and released by a2&quot;</span><span class="p">)</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">a1</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;fall_through&#39;</span><span class="p">)</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Bubbling</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Running the above would result in this output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[2019-07-16 09:02:04.725787] [fall_through] e-&gt;start_at() top-&gt;a2
caught and released by a2
caught and released by a1
finally hooked by a0, but state remains as a0
</pre></div>
</div>
</div>
<div class="section" id="publish-and-subscribe-coloured-dots">
<span id="reading-diagrams-publishing-to-other-charts"></span><h3>Publish and Subscribe Coloured Dots<a class="headerlink" href="#publish-and-subscribe-coloured-dots" title="Permalink to this headline">¶</a></h3>
<p>If you are publishing an event to another chart, it is often beneficial to have
your eyes fall on this immediately while looking at your diagram. It is an
output.  I use a red dot to signify this. Red because the event is currently
stopped as it is waiting for processing in a queue.</p>
<p>Eventually, this published event will pass through to the other chart.  To make
it easy to see where this happens, I mark the location with a green dot.  Green
for go; the event is being acted upon.</p>
<p>The red and green dots are not part of the UML standard, so you will be fighting
your UML drawing tools to place these dots in a way that is consistent on each
diagram.  So don’t worry about placement consistency, just get the dots close to
where you want them; think of them as marks you might make with a highlighter to
emphasize what you need to see.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Putting red and green dots on your statechart is not in the UML standard</p>
</div>
<p>To make a point I will draw two statecharts, which work together, with too much
UML:</p>
<a class="reference external image-reference" href="_static/pub_sub_icons_2.pdf"><div align="center" class="align-center"><img alt="_images/pub_sub_icons_2.svg" src="_images/pub_sub_icons_2.svg" /></div>
</a>
<p>The diagram is very busy.</p>
<p>The inheritance arrows at the top of the diagram describe the program’s
structure.  We see that I’m trying to get the attributes and methods of Chart1
into Chart2.  Chart2 also pulls in the features of the Factory, so we can
<a class="reference internal" href="recipes.html#recipes-creating-a-statechart-inside-of-a-class"><span class="std std-ref">create a statechart inside of a class</span></a>.</p>
<p>These structural details might be helpful when we first
write our code, but after that, they become clutter. The state machines are the vital part of the diagram;  this is where we pack the
design’s behavioral complexity.  We have two coupled state machines that work
together, so when we need to come back to this drawing, we will want to see how
this behavioral partnership works right away.  This is why we add the
highlighter marks.</p>
<p>Here is the code for the above picture with the event sharing code highlighted:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># pub_sub_example.py</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="n">Coordinate</span> <span class="o">=</span> \
   <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Coordinate&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">])</span>

 <span class="k">class</span> <span class="nc">Chart1</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

   <span class="k">def</span> <span class="nf">print_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;x: {}, y: {}, z: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">c_1_outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Chart_2_Started</span><span class="p">))</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Chart_2_Started</span><span class="p">):</span>
</span><span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">x</span>
</span><span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">y</span>
</span><span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">z</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c_1_inner_state</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">c_1_inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">print_payload</span><span class="p">()</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c_1_outer_state</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">c_1_outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>


 <span class="k">class</span> <span class="nc">Chart2</span><span class="p">(</span><span class="n">Chart1</span><span class="p">,</span> <span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">c_2_outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;c_2_outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_2_outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_2_outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">c_2_inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;c_2_inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_2_outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_2_outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_2_inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c_2_outer_state</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_2_inner_state</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">increment_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">c_2_outer_state_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">c_2_inner_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">c_2_outer_state_reset</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">increment_x</span><span class="p">()</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">c_2_outer_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="nd">@staticmethod</span>
   <span class="k">def</span> <span class="nf">c_2_outer_state_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Chart_2_Started</span><span class="p">,</span>
</span><span class="hll">       <span class="n">payload</span><span class="o">=</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">3</span><span class="p">)))</span>
</span>     <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="c1"># need to create an active object</span>
   <span class="c1"># set it&#39;s live trace attribute</span>
   <span class="c1"># then start it in the correct state</span>
   <span class="n">c_1</span> <span class="o">=</span> <span class="n">Chart1</span><span class="p">(</span><span class="s1">&#39;c_1&#39;</span><span class="p">)</span>
   <span class="n">c_1</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">c_1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">c_1_outer_state</span><span class="p">)</span>

   <span class="c1"># Chart2 starts itself in the correct state</span>
   <span class="n">c_2</span> <span class="o">=</span> <span class="n">Chart2</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;c_2&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
   <span class="n">c_2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
   <span class="n">c_2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this code, we see:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">c_1_outer_state</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">c_2_inner_state</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Chart_2_Started</span><span class="p">()</span> <span class="n">c_1_outer_state</span><span class="o">-&gt;</span><span class="n">c_1_inner_state</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">()</span> <span class="n">c_1_inner_state</span><span class="o">-&gt;</span><span class="n">c_1_outer_state</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">()</span> <span class="n">c_2_inner_state</span><span class="o">-&gt;</span><span class="n">c_2_inner_state</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">()</span> <span class="n">c_2_inner_state</span><span class="o">-&gt;</span><span class="n">c_2_inner_state</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Chart_2_Started</span><span class="p">()</span> <span class="n">c_1_outer_state</span><span class="o">-&gt;</span><span class="n">c_1_inner_state</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">()</span> <span class="n">c_1_inner_state</span><span class="o">-&gt;</span><span class="n">c_1_outer_state</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Chart_2_Started</span><span class="p">()</span> <span class="n">c_1_outer_state</span><span class="o">-&gt;</span><span class="n">c_1_inner_state</span>
<span class="p">[</span><span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mi">33</span><span class="p">]</span> <span class="p">[</span><span class="n">c_1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">()</span> <span class="n">c_1_inner_state</span><span class="o">-&gt;</span><span class="n">c_1_outer_state</span>
</pre></div>
</div>
<p>Let’s run the above trace output through the <a class="reference external" href="https://github.com/aleph2c/sequence">sequence tool</a> and compare the resulting <a class="reference internal" href="#reading-diagrams-sequence-diagrams"><span class="std std-ref">sequence
diagram</span></a> and UML statecharts:</p>
<a class="reference external image-reference" href="_static/pub_sub_icons_2.pdf"><div align="center" class="align-center"><img alt="_images/pub_sub_icons_2.svg" src="_images/pub_sub_icons_2.svg" /></div>
</a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Statechart</span><span class="p">:</span> <span class="n">c_1</span><span class="p">]</span> <span class="p">(</span><span class="n">Chart1</span><span class="p">:</span> <span class="n">ActiveObject</span><span class="p">)</span>
         <span class="n">top</span>            <span class="n">c_1_outer_state</span>      <span class="n">c_1_inner_state</span>
          <span class="o">+-----</span><span class="n">start_at</span><span class="p">()</span><span class="o">----&gt;|</span>                    <span class="o">|</span>
          <span class="o">|</span>        <span class="p">(</span><span class="mi">1</span><span class="p">)</span>         <span class="o">|</span>                    <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+--</span><span class="n">Chart_2_Started</span><span class="p">()</span><span class="o">&gt;|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+&lt;------</span><span class="n">Reset</span><span class="p">()</span><span class="o">------|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">4</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+--</span><span class="n">Chart_2_Started</span><span class="p">()</span><span class="o">&gt;|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">7</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+&lt;------</span><span class="n">Reset</span><span class="p">()</span><span class="o">------|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">8</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+--</span><span class="n">Chart_2_Started</span><span class="p">()</span><span class="o">&gt;|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">9</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+&lt;------</span><span class="n">Reset</span><span class="p">()</span><span class="o">------|</span>
          <span class="o">|</span>                    <span class="o">|</span>       <span class="p">(</span><span class="mi">10</span><span class="p">)</span>         <span class="o">|</span>

<span class="p">[</span><span class="n">Statechart</span><span class="p">:</span> <span class="n">c_2</span><span class="p">]</span> <span class="p">(</span><span class="n">Chart2</span><span class="p">:</span> <span class="n">Factory</span><span class="p">)</span>
      <span class="n">top</span>      <span class="n">c_2_inner_state</span>
       <span class="o">+--</span><span class="n">start_at</span><span class="p">()</span><span class="o">-&gt;|</span> <span class="n">publishes</span> <span class="n">Chart_2_Started</span>
       <span class="o">|</span>     <span class="p">(</span><span class="mi">2</span><span class="p">)</span>      <span class="o">|</span>
       <span class="o">|</span>              <span class="o">+</span>
       <span class="o">|</span>               \ <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
       <span class="o">|</span>               <span class="n">Reset</span><span class="p">()</span> <span class="n">publishes</span> <span class="n">Chart_2_Started</span>
       <span class="o">|</span>               <span class="o">/</span>
       <span class="o">|</span>              <span class="o">&lt;</span>
       <span class="o">|</span>              <span class="o">+</span>
       <span class="o">|</span>               \ <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
       <span class="o">|</span>               <span class="n">Reset</span><span class="p">()</span> <span class="n">publishes</span> <span class="n">Chart_2_Started</span>
       <span class="o">|</span>               <span class="o">/</span>
       <span class="o">|</span>              <span class="o">&lt;</span>
</pre></div>
</div>
<p>Here is what happens when we run our code:</p>
<ol class="arabic simple">
<li>c_1 (Chart1) starts and settles into the c_1_outer_state.</li>
<li>c_2 (Chart2) starts and transitions into the c_2_inner_state, which publishes
Chart_2_Started.</li>
<li>c_1 reacts to the Chart_2_Started event, transitions from c_1_outer_state to
c_1_inner_state, prints the contents of the Chart_2_started event’s payload,
then posts a Reset event to itself using the post_lifo API.</li>
<li>c_1 reacts to its Reset event, transitioning into c_1_outer_state.</li>
<li>c_2 receives a Reset event from our main thread, it publishes a
Chart_2_Started event.</li>
<li>c_2 receives another Reset event from our main thread, it publishes a
Chart_2_Started event.</li>
<li>c_1 reacts to the Chart_2_Started event, transitions from c_1_outer_state to
c_1_inner_state, prints the contents of the Chart_2_started event’s payload,
then posts a Reset event to itself using the post_lifo API.</li>
<li>c_1 reacts to its Reset event, transitioning into c_1_outer_state.</li>
<li>c_1 reacts to the Chart_2_Started event, transitions from c_1_outer_state to
c_1_inner_state, prints the contents of the Chart_2_started event’s payload,
then posts a Reset event to itself using the post_lifo API.</li>
<li>c_1 reacts to its Reset event, transitioning into c_1_outer_state.</li>
</ol>
</div>
<div class="section" id="high-level-federation-diagrams">
<span id="reading-diagrams-high-level-dependency-diagrams"></span><h3>High Level Federation Diagrams<a class="headerlink" href="#high-level-federation-diagrams" title="Permalink to this headline">¶</a></h3>
<p>If you have a number of statecharts that are all working together to perform
some sort of collective action, it’s often very useful to see how they relate
to one another from a very high point of view.  For this I draw high level
dependency diagrams:</p>
<a class="reference external image-reference" href="_static/context_diagram.pdf"><div align="center" class="align-center"><img alt="_images/context_diagram.svg" src="_images/context_diagram.svg" /></div>
</a>
<p>When I need to write about a specific part of the system, I will change it’s
colour to draw my audience’s attention.  In this example I am trying to draw
your attention to the CacheFileChart used by the <a class="reference external" href="https://aleph2c.github.io/miros-rabbitmq/how_it_works.html">miros-rabbitmq plugin</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is not in the UML standard</p>
</div>
</div>
<div class="section" id="medium-level-construction-and-pub-sub-diagrams">
<span id="reading-diagrams-medium-level-construction-and-pub-sub-diagrams"></span><h3>Medium Level Construction and Pub/Sub Diagrams<a class="headerlink" href="#medium-level-construction-and-pub-sub-diagrams" title="Permalink to this headline">¶</a></h3>
<p>If you have build a federation of statecharts working together, you might want
to look at how a specific statechart works in the context of this federation
without looking at the details of its state machine.  This can be done with a
medium level contextual view.  You would identify what it publishes, what it’s
subscribed to and what it constructs to perform it’s roll:</p>
<a class="reference external image-reference" href="_static/medium_context_lan_chart.pdf"><div align="center" class="align-center"><img alt="_images/medium_context_lan_chart.svg" src="_images/medium_context_lan_chart.svg" /></div>
</a>
<p>This is a medium context diagram of the LanChart used by the <a class="reference external" href="https://aleph2c.github.io/miros-rabbitmq/how_it_works.html">miros-rabbitmq plugin</a>.  It uses two
“has a” composite arrows to show that it builds a CacheFileChart and a
LanRecceChart when it is constructed.  When the LanChart is destroyed, both the
CacheFileChart and the LanRecceChart will be destroyed as well.</p>
<p>We use the publish and subscribe icons to show about events are inputs (green)
and what events are outputs (red).  The payloads of the events are described as
well.  From this diagram we can see how are LanChart chart contributes to the
federation of our design.</p>
<p>What is missing is that the LanChart doesn’t describe who constructs it.  I
really shouldn’t because it doesn’t have access to this information.  To see
this, you would reference the detailed statechart diagram.</p>
</div>
<div class="section" id="detailed-statechart-diagrams">
<span id="reading-diagrams-detailed-statechart-diagrams"></span><h3>Detailed Statechart Diagrams<a class="headerlink" href="#detailed-statechart-diagrams" title="Permalink to this headline">¶</a></h3>
<p>The complete statechart is something that shows the topological nature of your
design with code marked upon it so you can quickly scan it and see what it’s
doing.  The publish and subscription dots are immediately visible and if you
need to further augment the chart with graphs to describe timing or whatever you
think will be useful, place those on the diagram too:</p>
<a class="reference external image-reference" href="_static/miros_rabbitmq_cache_file_chart.pdf"><div align="center" class="align-center"><img alt="_images/miros_rabbitmq_cache_file_chart.svg" src="_images/miros_rabbitmq_cache_file_chart.svg" /></div>
</a>
</div>
<div class="section" id="sequence-diagrams">
<span id="reading-diagrams-sequence-diagrams"></span><h3>Sequence Diagrams<a class="headerlink" href="#sequence-diagrams" title="Permalink to this headline">¶</a></h3>
<p>Sequence diagrams are very useful and extremely fragile to design changes.  They
<a class="reference external" href="https://github.com/aleph2c/sequence">can be generated directly from the trace instrumentation of the state machine</a> and quickly written up in plain text.
You can drop this plain text into your code or use it directly in your docs.</p>
<p>From this instrumentation trace log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span> <span class="p">[</span><span class="n">doc_process</span><span class="p">]</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">()</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">statechart</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span> <span class="p">[</span><span class="n">doc_process</span><span class="p">]</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">prototype</span><span class="p">()</span> <span class="n">statechart</span><span class="o">-&gt;</span><span class="n">code</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span> <span class="p">[</span><span class="n">doc_process</span><span class="p">]</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">()</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span> <span class="p">[</span><span class="n">doc_process</span><span class="p">]</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">communicate</span><span class="p">()</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">trace</span>
<span class="p">[</span><span class="mi">2013</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">24</span><span class="p">]</span> <span class="p">[</span><span class="n">doc_process</span><span class="p">]</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="o">.</span><span class="n">rb</span><span class="p">()</span> <span class="n">trace</span><span class="o">-&gt;</span><span class="n">sequence_diagram</span>
</pre></div>
</div>
<p>To this sequence diagram:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>[ Chart: doc_process ] (?)
   spec       statechart        code             trace      sequence_diagram
     +-begin()-&gt;|                |                |                |
     |   (1)    |                |                |                |
     |          +--prototype()--&gt;|                |                |
     |          |      (2)       |                |                |
     |          |                +                |                |
     |          |                 \ (3)           |                |
     |          |                 debug()         |                |
     |          |                 /               |                |
     |          |                &lt;                |                |
     |          |                +-communicate()-&gt;|                |
     |          |                |      (4)       |                |
     |          |                |                +-sequence.rb()-&gt;|
     |          |                |                |      (5)       |
</pre></div>
</div>
<p>The horizontal axis describes the states we want to show in an interaction.  The
vertical axis represents time, time starts at the top of the page and moves into
the program’s future, lower down the page.</p>
<p>Vertical bars descend from each state, as guides for your eyes.  These are
called “lifelines,” the lifelines are connected by asynchronous events.  An
event can connect two different lifelines, or they can connect back on
themselves (like the debug event on the code lifeline).  Such an event
connection represents a state transition.</p>
<p>The UML sequence diagram standard describes ways we can define loops,
iterations, unexpected messages, lost messages, synchronous messages, actors and
all sorts of other stuff that we don’t care about.  We don’t care about this
stuff, because the engineering trade-off is not worth it.  The time spent to
build these beautiful and descriptive diagrams is wasted because they are broken
by the smallest change to your statechart.</p>
<p>So avoid spending a lot of time or effort on these diagrams, use code to
generate them, and avoid using their more advanced diagramming features.</p>
</div>
<div class="section" id="payloads">
<span id="reading-diagrams-payloads"></span><h3>Payloads<a class="headerlink" href="#payloads" title="Permalink to this headline">¶</a></h3>
<p>Your statechart is running in its own thread.  An event can be published from
one thread and consumed by another thread.  This means if you put mutable data
in your event’s payload, you could be creating a shared global variable between
two separate threads.  Shared global information should be locked and unlocked
if it’s being used by multiple concurrent processes.</p>
<p>Instead of coming up with complicated locking mechanisms, wrap large common data
structures within their own statecharts and copy smaller payloads into named
tuples.  A named tuple is immutable, so you won’t accidentally shoot yourself in
the foot by inadvertently creating a global variable shared between two
different threads.  You can draw your payloads into your statecharts like this:</p>
<a class="reference external image-reference" href="_static/immutable_payload.pdf"><div align="center" class="align-center"><img alt="_images/immutable_payload.svg" src="_images/immutable_payload.svg" /></div>
</a>
<p>Pepper these payload descriptions all over your drawings, you might be repeating
yourself, but the quick understanding that you will be getting from a glance
will pay for this trade-off.  The <a class="reference external" href="https://docs.python.org/3.5/library/collections.html#collections.namedtuple">namedtuple is nice to work with</a>.</p>
</div>
<div class="section" id="a-warning-about-diagramming">
<span id="reading-diagrams-a-warning-about-diagramming"></span><h3>A Warning about Diagramming<a class="headerlink" href="#a-warning-about-diagramming" title="Permalink to this headline">¶</a></h3>
<p>Be aware that as you draw your pictures, you will lock-in your thinking.</p>
<p>You and everyone on your team will be effected by the Sunk Cost Fallacy:  “Your
decisions are tainted by the emotional investments you accumulate, and the more
you invest in something the harder it becomes to abandon”. <a class="footnote-reference" href="#id7" id="id6">[1]</a></p>
<p>If you build beautiful drawings with a graphic design application; you will need
to put time and effort into them and you will probably become emotionally
attached to them.  Remember, your diagrams are just mistakes in the right
direction.  You need to be able to destroy and reform these pictures, just as
casually as you would refactor your code.</p>
<p>So use a simple and customizable tool.  To draw the pictures in this
documentation I used UMLet.  With UMLet you can build custom templates, <a class="reference external" href="https://github.com/aleph2c/umlet-statechart-template">here is
mine</a>.  And it is hard
to fall in love with a picture made by UMLet.</p>
<p>You don’t have to use this tool or this template, there <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_Unified_Modeling_Language_tools">a lot of other UML
drawing tools available</a>.</p>
<p>Another way to make your pictures easy to change is to limit the amount of
detail on them.  You don’t have to draw every class and you can shrink a
complicated statechart into a kind of short hand.</p>
<p>There are some diagrams that are extremely expressive and extremely fragile.  I
can explain how a sequence diagram works to someone in 10 seconds.  But any
sequence diagram used to describe your statechart behavior, will be extremely
fragile to change.</p>
<p>You might feel reluctant to change your design, not because you are attached to
your picture, but because you don’t want to re-write all of the boiler plate
code to describe your statechart in Python.  To avoid what used to take me hours
of work (mostly to debug) I have written some Ultisnips snippets for vim, that
mostly write the statechart code for me.  You can <a class="reference external" href="https://github.com/aleph2c/vim_tmux/blob/master/snippets/python.snippets">find these snippets here</a>.</p>
<p>UML can’t begin to describe everything you can create with your Python code.
So, if you need to express a code’s idea on the diagram, just write the code
directly onto the picture.</p>
<p>You may decide to extend or change how UML diagrams are drawn to match your way
of programming.  I have done this in this documentation.  There are a lot of
features that would make it very nice to view a statechart, like being able to
click on a diagram and drill in to see the specifics of that part of the
picture.  UMLet doesn’t support this, and to get such a thing to show up in HTML
(this doc) you would need some sort of SVG library working with javascript.
Well, I don’t have time to write that, and I’m not funded, so we will do the
best we have with the tools we got.</p>
<p>When you customize the way you draw a picture, just make sure the other
people on your team understand what you mean.</p>
<a class="reference internal" href="zero_to_one.html"<span class="std-ref">prev</span></a>, <a class="reference internal" href="index.html#top"><span class="std std-ref">top</span></a>, <a class="reference internal" href="examples.html"><span class="std std-ref">next</span></a><table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[1]</a></td><td><a class="reference external" href="https://youarenotsosmart.com/2011/03/25/the-sunk-cost-fallacy/">The Sunk Cost Fallacy</a></td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Diagrams</a><ul>
<li><a class="reference internal" href="#history-and-context">History and Context</a><ul>
<li><a class="reference internal" href="#the-most-important-rule-in-uml">The Most Important Rule in UML</a></li>
<li><a class="reference internal" href="#classes">Classes</a></li>
<li><a class="reference internal" href="#inheritance-and-miros">Inheritance and miros</a></li>
<li><a class="reference internal" href="#events">Events</a></li>
<li><a class="reference internal" href="#event-processor-attachment-points">Event Processor Attachment Points</a></li>
<li><a class="reference internal" href="#states">States</a></li>
<li><a class="reference internal" href="#deep-history-icon">Deep History Icon</a></li>
<li><a class="reference internal" href="#if-else-structures">If-Else Structures</a></li>
<li><a class="reference internal" href="#extending-arrows">Extending Arrows</a></li>
<li><a class="reference internal" href="#terminate-icon">Terminate Icon</a></li>
<li><a class="reference internal" href="#final-icon">Final Icon</a></li>
<li><a class="reference internal" href="#fall-through">Fall Through</a></li>
<li><a class="reference internal" href="#publish-and-subscribe-coloured-dots">Publish and Subscribe Coloured Dots</a></li>
<li><a class="reference internal" href="#high-level-federation-diagrams">High Level Federation Diagrams</a></li>
<li><a class="reference internal" href="#medium-level-construction-and-pub-sub-diagrams">Medium Level Construction and Pub/Sub Diagrams</a></li>
<li><a class="reference internal" href="#detailed-statechart-diagrams">Detailed Statechart Diagrams</a></li>
<li><a class="reference internal" href="#sequence-diagrams">Sequence Diagrams</a></li>
<li><a class="reference internal" href="#payloads">Payloads</a></li>
<li><a class="reference internal" href="#a-warning-about-diagramming">A Warning about Diagramming</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="zero_to_one.html" title="previous chapter">Tutorial: Zero To One</a></li>
      <li>Next: <a href="examples.html" title="next chapter">Examples</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/reading_diagrams.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Scott Volk.
      
      |
      <a href="_sources/reading_diagrams.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>