
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Patterns &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Reflection" href="reflection.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <blockquote>
<div><p><em>But in practice master plans fail - because they create totalitarian order,
not organic order.  They are too rigid; they cannot easily adapt to the
natural and unpredictable changes that inevitably arise in the life of a
community.</em></p>
<p class="attribution">&mdash;Christopher Alexander</p>
</div></blockquote>
<div class="section" id="patterns">
<span id="id1"></span><h1>Patterns<a class="headerlink" href="#patterns" title="Permalink to this headline">¶</a></h1>
<table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="#patterns-ultimate-hook"><span class="std std-ref">ultimate hook</span></a></li>
<li><a class="reference internal" href="#patterns-reminder"><span class="std std-ref">reminder</span></a></li>
<li><a class="reference internal" href="#patterns-deferred-event"><span class="std std-ref">deferred event</span></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="#patterns-orthogonal-component"><span class="std std-ref">orthogonal component</span></a></li>
<li><a class="reference internal" href="#patterns-transition-to-history"><span class="std std-ref">transition to history</span></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="#patterns-multichart-race"><span class="std std-ref">multichart race</span></a></li>
<li><a class="reference internal" href="#patterns-multichart-pend"><span class="std std-ref">multichart pend</span></a></li>
</ul>
</td></tr></table>
<p>The idea of software design patterns came from the architect Christopher
Alexander.  He wrote a book, <a class="reference external" href="https://www.patternlanguage.com/">a pattern language</a>, about how different
approaches to architecture could be used across different scales (from the
country to the pantry) to help people feel better about living in their
communities.  It’s a lovely book (everyone should own a copy); a child can
understand it yet it is still useful to professional architects.</p>
<p>This can not be said for the book it inspired in computer science, “Design
Patterns: Elements of Reusable Object-Oriented Software”  This book <em>was not</em>
child friendly, in fact everyone I knew secretly hated it because of its
illegibility; but would make sure to have a copy of it on their shelf to look
like they were in the club.</p>
<p>The ideas within the book were great and the follow up books that <a class="reference external" href="https://www.tutorialspoint.com/design_pattern/design_pattern_overview.htm">translated
it into English</a> were really useful.  Basically it described a set of
techniques for solving classes of problems that come up over and over again.
If you haven’t learned the patterns yet, find a copy of a patterns book written
by a practitioner in your language(s) and work through it.  You will level up.</p>
<p>In chapter 5 of “Practical UML STATECHARTS in C/C++” I was leveled up by Miro
Samek.  He describes 5 statechart patterns and made the bold claim that
<strong>statecharts are a pattern of patterns</strong>.  I completely agree with him.  So here
is my translation of his work into this library.  I’ll start each <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> with
quotes from his book, then write about it within the context of this work.</p>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="ultimate-hook">
<span id="patterns-ultimate-hook"></span><h2>Ultimate Hook<a class="headerlink" href="#ultimate-hook" title="Permalink to this headline">¶</a></h2>
<p>Formal description:</p>
<blockquote>
<div><p>[The Ultimate Hook Pattern provides a] common facilities and policies for
handling events but let clients override and specialize every aspect of the
system’s behavior.</p>
<p>The semantics of state nesting provide the desired mechanism of handling
all events, first in the context of the client code (the nested state) and
of automatically forwarding of all unhandled events to the [parent state]
(the default behavior). In that way, the client code intercepts every
stimulus and can override every aspect of the behavior. To reuse the
default behavior, the client simply ignores the event and lets the
superstate handle it (the [child state] inherits behavior from the
superstate) <a class="footnote-reference" href="#id6" id="id2">[5]</a></p>
</div></blockquote>
<p>Makes sense to me.  Keep up! ;)</p>
<p>To understand the ultimate hook <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a>, you first have to understand what a
hook is.  It is just some code in an <code class="docutils literal"><span class="pre">if-elif</span></code> clause.   A hook is just some
code that catches an event, runs your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> and then
returns something which tells the event processor to stop searching.  <strong>A hook
doesn’t cause a state transition</strong>.  It is a way to get the event processor’s
search algorithm to do work for you without changing state.</p>
<p>You see, anytime the event processor is trying to figure out what to do with an
event it needs to <a class="reference internal" href="recipes.html#recipes-what-a-state-does-and-how-to-structure-it"><span class="std std-ref">search your
statechart</span></a>.  If it finds
that it needs to do a transition, it will enlist the heavy-duty parts of it’s
algorithm to make sure that the <a class="reference internal" href="glossary.html#term-harel-formalism"><span class="xref std std-term">Harel Formalism</span></a>
occurs.  The hook has nothing to do with this, because it short circuits the
search before it does a transition, but not before it gets this search algorithm
to do some useful work.</p>
<p>If your if-else structure in your state method catches the signal name of an
event, runs your code, then returns the <code class="docutils literal"><span class="pre">return_status.HANDLED</span></code> back to the
event processor, no state transition will occur.  This is how you make a hook.
You make sure that part of your if-elif clause catches the event signal, runs
your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> and returns the <code class="docutils literal"><span class="pre">return_state.HANDLED</span></code>
value.</p>
<a class="reference external image-reference" href="_static/ultimate_hook1.pdf"><div align="center" class="align-center"><img alt="_images/ultimate_hook1.svg" src="_images/ultimate_hook1.svg" /></div>
</a>
<p>Here is a simple example which demonstrates a hook.  In this example we will
show that we can get some client code to run when we post an event with the
signal name of BEHAVIOR_NAME to your statechart:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># your code would go here</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>The highlighted code describes the hook.  We see that when the BEHAVIOR_NAME
signal is caught by this state method it runs your <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> then returns <code class="docutils literal"><span class="pre">return_status.HANDLED</span></code>.</p>
<p>The <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> output would look like this:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BEHAVIOR_NAME:outer_state&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;your outer_state code here&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;BEHAVIOR_NAME:outer_state:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Lines 1-5 describe the first <a class="reference internal" href="glossary.html#term-run-to-completion"><span class="xref std std-term">rtc</span></a> event which occurs
when we start the statechart.  Lines 5-9 of the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log actually describe the hook behavior.  The
event processor ran, searching the statechart starting at the outer_state
method to see if it knew how to process the BEHAVIOR_NAME signal and it did:
the <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> just
<a class="reference internal" href="recipes.html#recipes-scribble-on-the-spy"><span class="std std-ref">scribbled</span></a> something into our
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log so we can see what happened.  On line 7
we see the result of this in the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log.
Furthermore, no state transition occurred.</p>
<a class="reference external image-reference" href="_static/ultimate_hook2.pdf"><div align="center" class="align-center"><img alt="_images/ultimate_hook2.svg" src="_images/ultimate_hook2.svg" /></div>
</a>
<p>Now suppose we add another state within the outer state and start our active
object there.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>


<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
    <span class="c1"># your code would go here</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="hll"><span class="nd">@spy_on</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># your code would go here</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your inner_state code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_state</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="hll"><span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
</span><span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>Then look at the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;BEHAVIOR_NAME:inner_state&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;your inner_state code here&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;BEHAVIOR_NAME:inner_state:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>Ok, no surprises.  The inner_state hooked the BEHAVIOR_NAME signal and
ran some <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a>.</p>
<a class="reference external image-reference" href="_static/ultimate_hook3.pdf"><div align="center" class="align-center"><img alt="_images/ultimate_hook3.svg" src="_images/ultimate_hook3.svg" /></div>
</a>
<p>Now let’s remove the handling of the BEHAVIOR_NAME from our
inner state and see what happens when we start the active object in the
inner_state then send it an event with the BEHAVIOR_NAME.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">spy_on</span><span class="p">,</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">):</span>
    <span class="c1"># your code would go here</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;your outer_state code here&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1">#if(e.signal == signals.BEHAVIOR_NAME):</span>
  <span class="c1">#  # your code would go here</span>
  <span class="c1">#  chart.scribble(&quot;your inner_state code here&quot;)</span>
  <span class="c1">#  status = return_status.HANDLED</span>
  <span class="c1">#else:</span>
  <span class="c1">#  chart.temp.fun = outer_state</span>
  <span class="c1">#  status = return_status.SUPER</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>

<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BEHAVIOR_NAME</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</td></tr></table></div>
<p>In the highlighted code you can see that I adjusted the inner_state to run as
if it’s <code class="docutils literal"><span class="pre">else</span></code> method clause was always active.  I did this so that it would not
handle the BEHAVIOR_NAME signal.  Now we run the code and look at the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> output.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner_state&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:inner_state&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:outer_state&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;your outer_state code here&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;BEHAVIOR_NAME:outer_state:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The highlighted lines show how our event processor tried to determine what to
do with the event containing the BEHAVIOR_NAME signal.</p>
<p>It called the inner_state with the event (8), it wasn’t handled, so it
called the parent outer_state with the same event (9) and we see on
line (10) that the outer_state <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> was run.  Finally, on line (11)
the spy instrumentation tells us that it detected a hooked event.  When you see
this in the log it means there was no state transition.</p>
<p>So, the outer_state hook code caught an event that was sent to the
inner_state.  The <a class="reference internal" href="glossary.html#term-harel-formalism"><span class="xref std std-term">Harel Formalism</span></a> followed by the
event processor determines that when it has an event, it will search outward
from the current state, to the next <a class="reference internal" href="glossary.html#term-parent-state"><span class="xref std std-term">parent state</span></a>, then the next parent state
over and over until your event is handled or, it reaches the top most state of
your <a class="reference internal" href="glossary.html#term-hierarchical-state-machine"><span class="xref std std-term">HSM</span></a>. This means that any inner state
method will automatically inherit the hook code of any outer state.  The outer
most state contains the ultimate hook; this is why the <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> is called what
it is.</p>
<a class="reference external image-reference" href="_static/ultimate_hook4.pdf"><div align="center" class="align-center"><img alt="_images/ultimate_hook4.svg" src="_images/ultimate_hook4.svg" /></div>
</a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To show that there is some sort of explicit design feature occuring on your
diagram, something that might be too subtle for someone to see right away UML
provides a dotted-collaboration-bubble.  It is very easy to over use
this feature and clutter up your diagram.</p>
</div>
<p>You can overwrite the behavior of the outer state hooks simply by explicitly
handling the signal in an inner state.  These ideas are very similar to
inheritance and overloading in object oriented programming.</p>
<p>As a designer you would write default <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> behavior
in the outer states of charts, and all of your inner states would get this
behavior for free.  If they needed to overwrite this behavior they would
specifically handle the event in their state methods.</p>
<a class="reference external image-reference" href="_static/ultimate_hook5.pdf"><div align="center" class="align-center"><img alt="_images/ultimate_hook5.svg" src="_images/ultimate_hook5.svg" /></div>
</a>
<p>You would place generic reactions to events in your outer states and place the
specific responses in your inner states. Let’s build out the above diagram:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="hll"><span class="k">def</span> <span class="nf">process_a_generic</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing a generic&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="hll"><span class="k">def</span> <span class="nf">process_b_generic</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing b generic&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="hll"><span class="c1"># overrides the generic hook while in the specific state</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">process_a_specific</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s1">&#39;processing a specific&#39;</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;ultimate_hook_example&#39;</span><span class="p">)</span>
<span class="n">generic</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;generic&#39;</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_a_generic</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_b_generic</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">to_method</span><span class="p">()</span>

<span class="n">specific</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;specific&#39;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">process_a_specific</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">generic</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">specific</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">specific</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>First of all we notice that instead of using an active object the diagram asks
us to use a <a class="reference internal" href="towardsthefactoryexample.html#towardsthefactoryexample-using-the-factory-class"><span class="std std-ref">factory</span></a>.
To use the factory we create states and tie specific signals to callback
functions.</p>
<p>The highlighted code shows the callback functions that are acting like hooks.
Pay special attention to what they return.  If they do not return
<code class="docutils literal"><span class="pre">return_status.HANDLED</span></code> they will not work as hooks.</p>
<p>We can deterime if we got the expected behavior by looking at the
<a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a> log:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:generic&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:generic&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;b:specific&#39;</span><span class="p">,</span>
 <span class="s1">&#39;b:generic&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;processing b generic&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;b:generic:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s1">&#39;a:specific&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;processing a specific&#39;</span><span class="p">,</span>
</span><span class="hll"> <span class="s1">&#39;a:specific:HOOK&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>On lines 10 and 11 we see the reaction to our first <code class="docutils literal"><span class="pre">b</span></code> signal.  As expected
the generic state’s hook function was run while the statechart remained in the
specific state.</p>
<p>On lines 14 and 15 we see the specific behavior for the <code class="docutils literal"><span class="pre">a</span></code> signal.  The
statechart ran the <a class="reference internal" href="glossary.html#term-client-code"><span class="xref std std-term">client code</span></a> in the specific state then
stopped processing the signal.</p>
</div>
<div class="section" id="reminder">
<span id="patterns-reminder"></span><h2>Reminder<a class="headerlink" href="#reminder" title="Permalink to this headline">¶</a></h2>
<p>Formal description:</p>
<blockquote>
<div><p>“Make the statechart topology more flexible by inventing an event an posting
it to itself.</p>
<p>Often in state modeling, loosely related functions of a system are strongly
coupled by a common event. Consider, for example, periodic data acquisition,
in which a sensor producing the data needs to be polled at a predetermined
rate. Assume that a periodic TIME_OUT event is dispatched to the system at
the desired rate to provide the stimulus for polling the sensor. Because the
system has only one external event (the TIME_OUT event), it seems that this
event needs to trigger both the polling of the sensor and the processing of
the data. A straightforward but suboptimal solution is to organize the state
machine into two distinct orthogonal regions (for polling and processing).
However, orthogonal regions increase the cost of dispatching events … and
require complex synchronization between the regions because the polling and
processing are not quite independent.” <a class="footnote-reference" href="#id7" id="id3">[6]</a></p>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you find yourself drawing two separate states with a lot of arrows
connecting them, remind yourself of this <span class="xref std std-ref">reminder
pattern</span>.</p>
</div>
<p>The reminder <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> uses the <a class="reference internal" href="#patterns-ultimate-hook"><span class="std std-ref">ultimate hook</span></a>
<a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> mixed with <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial event</span></a> injection.  It’s
an <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial event</span></a> because it is invented by the
statechart and injected to itself rather than being invented and injected by an
outside caller.</p>
<p>I’ll try to explain this idea by showing a bad, but working design, show how it
is expensive and then refactor the design using the <span class="xref std std-ref">reminder
pattern</span>.</p>
<p>We will begin with some specifications:</p>
<ul class="simple">
<li>Part of the system will poll a sensor based on a system clock running with
a period of 100ms.</li>
<li>Once polled this information will be sent to some processing code.</li>
<li>After three such events, the system will perform some processing and it will
enter a busy state (maybe communicating with a server).</li>
<li>While the unit is in a busy state it should not poll the sensor or process
input.</li>
<li>After the busy process is completed the system should go back into it’s
polling mode.</li>
</ul>
<p>Here is a first shot at implementing this specification:</p>
<a class="reference external image-reference" href="_static/reminder1.pdf"><div align="center" class="align-center"><img alt="_images/reminder1.svg" src="_images/reminder1.svg" /></div>
</a>
<p>We create a polling state which upon entry poles something.  Any time there is
a time out it will re-enter the state making this happen.</p>
<p>Then when it initializes it transitions into the processing state.  Upon
entering the processing state we add one to the <code class="docutils literal"><span class="pre">chart.processing_count</span></code> and
then process the message.  When the processing state initializes itself it will
either go back to the polling state or enter the busy state, if the
<code class="docutils literal"><span class="pre">chart.processing_count</span></code> is high enough.</p>
<p>Upon entering the busy state the <code class="docutils literal"><span class="pre">chart.busy_count</span></code> is set to zero.  Then the
TIME_OUT event is used with a <span class="xref std std-term">hook</span> to work the information.  In
this example we just scribble “busy” into the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>
log.  Then we add 1 to our <code class="docutils literal"><span class="pre">chart.busy_count</span></code>.  If the count is big enough we
transition back to the polling state.  Upon exiting the processing state, the
<code class="docutils literal"><span class="pre">chart.processing_count</span></code> is set to 0.  That should work!</p>
<p>Actually, it won’t work at all.</p>
<p>Notice the large <strong>Xs</strong> on the diagram.  These are there to show that they
are illegal transitions.  The Miro Samek event processing algorithm will only
allow INIT_SIGNAL events to drill further into child states; they can not leave there
current state and navigate to another region of the chart.  I’ll just pretend I
didn’t know about this and continue.</p>
<p>Let’s see what happens when we try to make this broken statechart</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">polling_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">polling_enter</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_state</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">polling_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="c1"># illegal (init can&#39;t leave parent states)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>
</span>
<span class="k">def</span> <span class="nf">processing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
<span class="hll">    <span class="c1"># illegal (init can&#39;t leave parent states)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
</span>  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">processing_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;reminder_pattern_needed_1&#39;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;processing_count&quot;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;busy_count&quot;</span><span class="p">)</span>

<span class="n">polling</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_time_out</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_entry</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_exit</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">busy</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_time_out</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">polling</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">busy</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span> <span class="n">times</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>I have highlighted the <a class="reference internal" href="glossary.html#term-illegal-transition"><span class="xref std std-term">illegal transitions</span></a>.</p>
<p>If we run the code we will see:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">miros</span><span class="o">.</span><span class="n">hsm</span><span class="o">.</span><span class="n">HsmTopologyException</span><span class="p">:</span>
  <span class="n">impossible</span> <span class="n">chart</span> <span class="n">topology</span> <span class="k">for</span> <span class="n">HsmEventProcessor</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
  <span class="n">see</span> <span class="n">HsmEventProcessor</span><span class="o">.</span><span class="n">init</span> <span class="n">doc</span> <span class="n">string</span> <span class="k">for</span> <span class="n">details</span>
</pre></div>
</div>
<p>So, how do we make this software work?  When you see this
<span class="xref std std-term">HsmToplogyException</span>, it’s probably time to
consider another way to design your <a class="reference internal" href="glossary.html#term-statechart"><span class="xref std std-term">statechart</span></a>.  We will
get to that shortly, but for now let’s find a way to force this software to
work the way we want it to.</p>
<p>Instead of making the INIT_SIGNAL transition outside of the state, we could
invent a new signal, post it to ourselves and pretend like it came from outside
of the active object.  Then our chart could react to it like it would to any
other event.  This kind of thing is called an <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial
event</span></a>.  Here is the code that would create an artificial
PROCESS event:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># If &#39;PROCESS&#39; signal wasn&#39;t invented before invent it now</span>
<span class="c1"># We post it to ourselves so we can react to it in the next rtc.</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">))</span>
</pre></div>
</div>
<p>Now that we know how to do that let’s redesign our statechart:</p>
<a class="reference external image-reference" href="_static/reminder2.pdf"><div align="center" class="align-center"><img alt="_images/reminder2.svg" src="_images/reminder2.svg" /></div>
</a>
<p>This introduces a new <a class="reference internal" href="glossary.html#term-pseudostate"><span class="xref std std-term">glyph</span></a> called the final state:</p>
<a class="reference external image-reference" href="_static/reminder3.pdf"><div align="center" class="align-center"><img alt="_images/reminder3.svg" src="_images/reminder3.svg" /></div>
</a>
<p>When you see this <a class="reference internal" href="glossary.html#term-pseudostate"><span class="xref std std-term">glyph</span></a> on a diagram it means, stop running.  So:</p>
<a class="reference external image-reference" href="_static/reminder4.pdf"><div align="center" class="align-center"><img alt="_images/reminder4.svg" src="_images/reminder4.svg" /></div>
</a>
<p>Would look like this as code:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Square brackets on diagram.</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span> <span class="c1"># HEAVY-DUTY Harel Formalism run here.</span>
                               <span class="c1"># This is recursive and might take</span>
                               <span class="c1"># a while  before this</span>
                               <span class="c1"># routine finishes.</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># If &#39;POLL&#39; signal wasn&#39;t invented before invent it now.</span>
    <span class="c1"># We post it to ourselves so we can react to it in the next rtc.</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">POLL</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div></blockquote>
<p>Ok now that we have that all out of the way let’s start fresh, reconsidering
our specification and our proposed design, then implement it in code:</p>
<ul class="simple">
<li>Part of the system will poll a sensor based on a system clock running with
a period of 100ms.</li>
<li>Once polled this information will be sent to some processing code.</li>
<li>After three such events, the system will perform some processing and it will
enter a busy state (maybe communicating with a server).</li>
<li>While the unit is in a busy state it should not poll the sensor or process
input.</li>
<li>After the busy process is completed the system should go back into it’s
polling mode.</li>
</ul>
<a class="reference external image-reference" href="_static/reminder2.pdf"><div align="center" class="align-center"><img alt="_images/reminder2.svg" src="_images/reminder2.svg" /></div>
</a>
<p>Here is the code for this design with highlights for the <a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial
events</span></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">polling_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
</span><span class="hll">    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">polling_process</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
<span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
</span><span class="hll">      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">POLL</span><span class="p">))</span>
</span>  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">processing_poll</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processing_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_time_out</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;reminder_pattern_needed_2&#39;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;processing_count&quot;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;busy_count&quot;</span><span class="p">)</span>

<span class="n">polling</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span><span class="o">.</span> \
<span class="hll">            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_time_out</span><span class="p">)</span><span class="o">.</span> \
</span>            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PROCESS</span><span class="p">,</span>  <span class="n">handler</span><span class="o">=</span><span class="n">polling_process</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_entry</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
<span class="hll">            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_exit</span><span class="p">)</span><span class="o">.</span> \
</span>            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">POLL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_poll</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">busy</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_time_out</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">polling</span><span class="p">,</span>    <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">busy</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span> <span class="n">times</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>If we run this code, it will output 1 seconds worth of information. The
comments in the spy log are the thoughts I would have while viewing it.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span> <span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span> <span class="c1"># start_at code running</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># start_at code completed</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># time out event detected in polling</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;polling&quot;)</span>
 <span class="s1">&#39;POST_FIFO:PROCESS&#39;</span><span class="p">,</span> <span class="c1"># inventing and posting our artificial event</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span>  <span class="c1"># TIME_OUT was a hook, no state transition</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed (event waiting)</span>
</span> <span class="s1">&#39;PROCESS:polling&#39;</span><span class="p">,</span> <span class="c1"># PROCESS event detected in polling</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;processing&quot;)</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;POST_FIFO:POLL&#39;</span><span class="p">,</span> <span class="c1"># chart.post_fifo(Event(signal=signals.POLL))</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed (event waiting)</span>
</span> <span class="s1">&#39;POLL:processing&#39;</span><span class="p">,</span> <span class="c1"># polling state detected POLL event</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1">#rtc complete (no events waiting)</span>
</span> <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># second TIME_OUT event cycle described above</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:PROCESS&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;PROCESS:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:POLL&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;POLL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># third TIME_OUT event expecting something different now</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;polling&quot;)</span>
 <span class="s1">&#39;POST_FIFO:PROCESS&#39;</span><span class="p">,</span>  <span class="c1"># inventing and posting our artificial event</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT was a hook, no state transition</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed (event waiting)</span>
</span> <span class="s1">&#39;PROCESS:polling&#39;</span><span class="p">,</span> <span class="c1"># PROCESS event detected in polling</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="c1"># result of chart.scribble(&quot;processing&quot;)</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># busy state detect it&#39;s first TIME_OUT</span>
 <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
<span class="hll"> <span class="s1">&#39;TIME_OUT:busy:HOOK&#39;</span><span class="p">,</span> <span class="c1"># busy state hooks it and blocks it from leaving</span>
</span> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
 <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># busy state detects it&#39;s second TIME_OUT</span>
<span class="hll"> <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
</span> <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
<span class="hll"> <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># full circuit completed DESIGN CONFIRMED</span>
</span><span class="hll"> <span class="c1"># deleting the rest of the log from documentation</span>
</span></pre></div>
</div>
<p>The code works and we have met our specifications.</p>
<p>But the polling and the processing state are strongly coupled to the TIME_OUT
signal.  Our design of having the TIME_OUT start the system in the polling and
end up in the processing/busy state cost us a lot of CPU time.</p>
<p>Lets introduce the reminder <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> with a new design:</p>
<a class="reference external image-reference" href="_static/reminder6.pdf" id="patterns-reminder-here"><div align="center" class="align-center"><img alt="_images/reminder6.svg" src="_images/reminder6.svg" /></div>
</a>
<p>Let’s discuss this diagram.</p>
<p>We use INIT_SIGNAL events to climb into the idle state.</p>
<p>We create a TIME_OUT ultimate hook, which is a method that can be used by any
state within the statechart.  This ultimate hook counts up each time it sees a
TIME_OUT and once this count hits 3 it posts an artificial event with the
signal DATA_READY.</p>
<p>Once the <a class="reference internal" href="glossary.html#term-run-to-completion"><span class="xref std std-term">RTC</span></a> process is completed, idle will catch
the DATA_READY signal and transition into busy.  The busy state catches the
TIME_OUT event which means that it will not escape to the ultimate hook in
polling.  Instead it uses it to count up a busy_count and when it hits 2 it
will transition back into idle.</p>
<p>Now, let’s write the code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">polling_time_out_hook</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;generic TIME_OUT ultimate hook for all states,</span>
<span class="sd">     injects artificial event DATA_READY&#39;&#39;&#39;</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">if</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">processing_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">DATA_READY</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">polling_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">idle_data_ready</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">busy_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">busy_time_out_hook</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;specific TIME_OUT hook for busy state&#39;&#39;&#39;</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">if</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">busy_count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;reminder&#39;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;processing_count&quot;</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;busy_count&quot;</span><span class="p">)</span>

<span class="n">polling</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_init</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">polling_time_out_hook</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">idle</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;idle&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">DATA_READY</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">idle_data_ready</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">busy</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;busy&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">busy_time_out_hook</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">polling</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">polling</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">busy</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">polling</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">polling</span><span class="p">)</span>
<span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span> <span class="n">times</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>If we run the code and looked at the spy log it would look like this: (I have
marked it up with comments)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span> <span class="c1"># start_at code running</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:idle&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT detected in idle</span>
 <span class="s1">&#39;TIME_OUT:processing&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT passed out to processing</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT passed to polling</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;polling&quot;)</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT hooked by the polling</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:idle&#39;</span><span class="p">,</span> <span class="c1"># Second TIME_OUT circuit - dynamics same as above</span>
 <span class="s1">&#39;TIME_OUT:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;TIME_OUT:idle&#39;</span><span class="p">,</span> <span class="c1"># Third TIME_OUT event</span>
 <span class="s1">&#39;TIME_OUT:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TIME_OUT:polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;polling&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:DATA_READY&#39;</span><span class="p">,</span> <span class="c1"># Posting the artificial event to the chart</span>
 <span class="s1">&#39;TIME_OUT:polling:HOOK&#39;</span><span class="p">,</span> <span class="c1"># TIME_OUT hooked by pooling</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed with 1 item in queue</span>
</span> <span class="s1">&#39;DATA_READY:idle&#39;</span><span class="p">,</span> <span class="c1"># DATA_READY seen by idle state</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;EXIT_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism (busy_entry call run)</span>
 <span class="s1">&#39;INIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># busy sees TIME_OUT event</span>
 <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
 <span class="s1">&#39;TIME_OUT:busy:HOOK&#39;</span><span class="p">,</span>  <span class="c1"># busy hooks TIME_OUT event</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span> <span class="c1"># rtc completed</span>
</span> <span class="s1">&#39;TIME_OUT:busy&#39;</span><span class="p">,</span> <span class="c1"># second TIME_OUT event seen by busy</span>
 <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="c1"># chart.scribble(&quot;busy&quot;)</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># this started by return chart.trans(idle)</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:polling&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism search</span>
 <span class="s1">&#39;EXIT_SIGNAL:busy&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span> <span class="c1"># Harel formalism</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span> <span class="c1"># rtc completed .. full circuit demonstrated</span>
</span> <span class="o">.</span>
 <span class="o">.</span>
 <span class="p">]</span>
</pre></div>
</div>
<p>This design required a lot less CPU time.  This is especially important if you
are going to port your design to an embedded system.  If you are using Python
in production you will be much less concerned with performance (since you are
using Python), even so, it is still a better design.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you were to use the trace you might be surprised that the hooked code is
hidden from view.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.157806</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.461012</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DATA_READY</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">busy</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.661728</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">busy</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.763392</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DATA_READY</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">busy</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">22.963635</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">busy</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">14</span> <span class="mo">06</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mf">23.064705</span><span class="p">]</span> <span class="p">[</span><span class="n">reminder</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">DATA_READY</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">busy</span>
</pre></div>
</div>
<p class="last">This is because the trace will only track items which cause state transitions
and hooks do not cause state transitions.</p>
</div>
</div>
<div class="section" id="deferred-event">
<span id="patterns-deferred-event"></span><h2>Deferred Event<a class="headerlink" href="#deferred-event" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Formal description:</dt>
<dd>“Simplify state machines by modifying the sequencing of events” <a class="footnote-reference" href="#id8" id="id4">[7]</a></dd>
</dl>
<p>In reactive systems events come in <a class="reference external" href="http://barabasi.com/book/bursts">bursts</a>.  They come whenever they come
with no regard for the current state of your statechart.</p>
<p>Suppose you were building a bank machine where the receiving and authorization
stages involved some complex computing.  To interrupt these states to deal with
an inconveniently timed request would be difficult to program.</p>
<p>Instead of coming up with some complicated scheme for shelving our work to
process new requests, we just defer the event, then re-inject the event into
our statechart when it’s timing is more convenient.</p>
<a class="reference external image-reference" href="_static/deferred1.pdf"><div align="center" class="align-center"><img alt="_images/deferred1.svg" src="_images/deferred1.svg" /></div>
</a>
<p>Here is an example of a chart using the deferred event <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a>.</p>
<p>To begin with the chart climbs into the idle state.  Upon receiving it’s first
NEW_REQUEST it transitions into the receiving state.  After a second of
processing it transitions into the authorizing state.  After the authorizing
state processes for 2 seconds it transitions back to the idle state.</p>
<p>The reminder <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> occurs when a NEW_REQUEST event is seen while the system
is either in receiving or authorizing.  This NEW_REQUEST event is ignored by
these states and caught by the hook in processing.  The processing state places
this NEW_REQUEST event into the deferred queue then passes the program’s
control back into whichever state was currently active.</p>
<p>The idle state behaves differently, upon entering, it recalls any events that
were placed in the deferred queue.  This effectively transfers them into the
active object working queue and for all intents and purposes the statechart
will think that this event was just posted to it from the outside world.  In
the next RTC the idle state will react to the posted NEW_REQUEST by
transitioning into the receiving state and the cycle will continue.</p>
<p>Now that you have a high level view of how things are working I will talk about
timing.  The receiving and authorizing states are simulating difficultly by
using one shot events.  We are pretending that instead of just waiting around
for a one shot to fire, that instead, something really important is happening
in the background which we do not want to interrupt.</p>
<p>The event bursts, use to interrupt our chart, will be done with the
<code class="docutils literal"><span class="pre">create_bursts</span></code> function seen on the diagram.  All this function does is to
waste a random amount of time between a few NEW_REQUEST events so that we can
see how are chart reacts.</p>
<p>We will use both the trace and spy instrumentation to look at our timing.  The
trace outputs timing information for state transitions.  So we will use the
trace to see if our chart state transitions remains steady despite the chaos we
are sending at it.  To confirm that we aren’t just fooling ourselves we will
use the spy and scribble when timed events hit the chart.</p>
<p>Now let’s redraw the diagram and then write it’s code:</p>
<a class="reference external image-reference" href="_static/deferred1.pdf"><div align="center" class="align-center"><img alt="_images/deferred1.svg" src="_images/deferred1.svg" /></div>
</a>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">processing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;deferred at {}&quot;</span><span class="o">.</span> \
</span><span class="hll">      <span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M:%S:</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">processing_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">idle_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;recalled at {}&quot;</span><span class="o">.</span> \
</span><span class="hll">      <span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M:%S:</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">idle_new_request</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">receiving</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">receiving_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;receiving&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">RECEIVED</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">receiving_received</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">authorizing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">authorizing_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;authorizing&quot;</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">authorizing_authorized</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">idle</span><span class="p">)</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;deferred&#39;</span><span class="p">)</span>

<span class="n">processing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">NEW_REQUEST</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_entry</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">processing_init</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">idle</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;idle&#39;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">idle_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">NEW_REQUEST</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">idle_new_request</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="n">receiving</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;receiving&#39;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">receiving_entry</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">RECEIVED</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">receiving_received</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">authorizing</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;authorizing&#39;</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="n">authorizing_entry</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="n">authorizing_authorized</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">to_method</span><span class="p">()</span>

<span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">processing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">idle</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">receiving</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">authorizing</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">processing</span><span class="p">)</span>

<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">processing</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">burst_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">bursts</span><span class="p">,</span> <span class="n">fastest_time</span><span class="p">,</span> <span class="n">slowest_time</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="nb">range</span><span class="p">(</span><span class="n">bursts</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">fastest_time</span><span class="p">,</span><span class="n">slowest_time</span><span class="p">))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

<span class="n">burst_event</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">NEW_REQUEST</span><span class="p">),</span>
             <span class="n">bursts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
             <span class="n">fastest_time</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
             <span class="n">slowest_time</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>I have highlighted the code that I excluded from the diagram.  It is code that
will put timing information into the spy log.</p>
<p>When we run this test, it could take between 7 and 11 seconds.  The trace
and spy results I get will be different from what you get because of the
stochastic characteristics of when the events are posted to the statechart.</p>
<p>Let’s first look at the trace output and confirm that our statechart behaves as
we intended:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">49.465806</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">50.435495</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">51.451824</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.458799</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.459805</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">54.461726</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.463891</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.464915</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">57.466761</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">59.468877</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">59.469876</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
</pre></div>
</div>
<p>The received state takes about 1 second to complete, so we are expecting to see
that the time between a NEW_REQUEST and a RECEIVED event should be about 1
second.  From inspection on lines 2-3, 5-6, 8-9 we see this is true:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">50.435495</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">51.451824</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.459805</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">54.461726</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.464915</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">57.466761</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</td></tr></table></div>
<p>The authorizing state takes about 2 seconds to complete so the RECEIVED and
COMPLETED events should be about 2 seconds apart.  From the inspection of lines
3-4, 6-7 and 9-10 we see this is true.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">51.451824</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.458799</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">54.461726</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.463891</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">57.466761</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">RECEIVED</span><span class="p">()</span> <span class="n">receiving</span><span class="o">-&gt;</span><span class="n">authorizing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">59.468877</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="o">.</span>
</pre></div>
</td></tr></table></div>
<p>The deferred event <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> states that we will react to the recalled events
immediately and we can see this behavior on lines 4-5 and 8-9</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.458799</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">53.459805</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="o">.</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.463891</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COMPLETED</span><span class="p">()</span> <span class="n">authorizing</span><span class="o">-&gt;</span><span class="n">idle</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">09</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mf">56.464915</span><span class="p">]</span> <span class="p">[</span><span class="n">deferred</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">NEW_REQUEST</span><span class="p">()</span> <span class="n">idle</span><span class="o">-&gt;</span><span class="n">receiving</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</td></tr></table></div>
<p>Now we have to confirm that NEW_REQUEST events were sent at random times and
deferred by the chart.  To do this we will have to dig into the spy log.  To
make it easier to see I will put spaces after the RTC event and I will
highlight the moments when a NEW_REQUEST was seen and defered by the
chart:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;recalled at 20:49:465806&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:51:020281&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;RECEIVED:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:51:664940&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(2)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:52:219593&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(3)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;NEW_REQUEST:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;NEW_REQUEST:processing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:NEW_REQUEST&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;deferred at 20:53:219562&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;NEW_REQUEST:processing:HOOK&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(4)&#39;</span><span class="p">,</span>

 <span class="s1">&#39;COMPLETED:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:authorizing&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;RECALL:NEW_REQUEST&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:NEW_REQUEST&#39;</span><span class="p">,</span>
 <span class="s1">&#39;recalled at 20:53:459805&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:idle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(1) Deferred:(3)&#39;</span><span class="p">,</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
 <span class="s1">&#39;INIT_SIGNAL:receiving&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;- Queued:(0) Deferred:(9)&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>From the highlighted time stamps we see that these event injections were
sporatic; so it is safe to assume the design worked.</p>
<p>It turns out the design is a lot easier to explain and write than it is to
verify.  You might be wondering what happens if more items are posted than
there are slots in the deferred queue.  The deferred queue is a <code class="docutils literal"><span class="pre">deque</span></code>, which
means it is a kind of ring buffer.  It you overflow it, it will remove the
oldest item and push the newest item onto the tail end of the queue.  It has a
queue size of 500.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The spy log does not contain timing information.  To add timing information to the
spy only takes a little effort; use the scribble method with a
<code class="docutils literal"><span class="pre">datetime.now()</span></code> call.</p>
</div>
</div>
<div class="section" id="orthogonal-component">
<span id="patterns-orthogonal-component"></span><h2>Orthogonal Component<a class="headerlink" href="#orthogonal-component" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Formal description:</dt>
<dd>“Use state machines as components.”</dd>
</dl>
<p>In the original statechart paper written by David Harel he describes how his
formalism needs to capture requirements like “[The] gearbox change of state is
<em>independent</em> of [the] braking system”.  For this he invented something called a
‘orthogonal region’:</p>
<a class="reference external image-reference" href="_static/orthogonal_region1.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region1.svg" src="_images/orthogonal_region1.svg" /></div>
</a>
<p>The two different areas in the above chart separated by the dotted line are
<strong>orthogonal regions</strong>.  They represent two separate state machines that act
independent of one another but are both turned on when the truck state is
initiated.</p>
<p>This part of the <a class="reference internal" href="glossary.html#term-harel-formalism"><span class="xref std std-term">Harel Formalism</span></a> is <strong>not supported</strong> by the
Miro Samek event processing algorithm.</p>
<p>If you would like such a structure in your machine, you could use an
<strong>orthogonal component instead</strong>.  An orthogonal component is just a statechart
that can dispatch messages directly into another one.  I’ll explain this with
an example.</p>
<p id="nuclear-fusion-example">Imagine we are asked to build some software for the general fusion reactor:</p>
<blockquote>
<div>“The General Fusion’s Magnetized Target Fusion system uses a sphere filled
with molten lead-lithium that is pumped to form a vortex.  A pulse of
magnetically-confined plasma fuel is then injected into the vortex. Around
the sphere, an array of pistons drive a pressure wave into the centre of
the sphere, compressing the plasma to fusion conditions. This process is
then repeated, while the heat from the reaction is captured in the liquid
metal and used to generate electricity via a steam turbine.” – General
Fusion</div></blockquote>
<p>Now that is an ambitious project.</p>
<p>Let’s say we have to write the firing mechanism to cause all of the pistons to
initiate the pressure wave.</p>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/zf8QIJ2VgqU" frameborder="0" gesture="media" allow="encrypted-media" allowfullscreen></iframe>
</center><p>Imagine that each piston has two transducers that measure the relevant
conditions of the molten lead-lithium near its position on the sphere.  The
first <a class="reference internal" href="glossary.html#term-transducer"><span class="xref std std-term">transducer</span></a> provides a composite reading that
abstracts away a lot of the physics; it provides numbers between 0 and 100.
The second <a class="reference internal" href="glossary.html#term-transducer"><span class="xref std std-term">transducer</span></a> measures the temperature; it’s range
is 0 to 9000 degrees Celsius.  A piston can only fire after 1 second has passed
since the last firing event and once it passes this time threshold it would
like to fire as soon as possible so that the fusion reactor can output the
maximum amount of power.</p>
<p>There are 255 pistons.</p>
<p>Through a lot of trial and error it has been found a piston can fire in the
following situations:</p>
<table border="1" class="docutils">
<colgroup>
<col width="41%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Composite Transducer Reading</th>
<th class="head">Temperature Transducer  [degrees Celsius]</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0-20</td>
<td>50-100</td>
</tr>
<tr class="row-odd"><td>25-50</td>
<td>200-333</td>
</tr>
<tr class="row-even"><td>30-66</td>
<td>403-600</td>
</tr>
<tr class="row-odd"><td>70-100</td>
<td>670-1500</td>
</tr>
</tbody>
</table>
<p>All of the pistons have to fire at the same time and they can only fire if the
above criteria are met.</p>
<p>Let’s design the system.  First we will need to fake-out the temperature and
composite transducer readings.  This can be done with an infinite impulse
response filter and a random number generator using a uniform distribution.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="k">class</span> <span class="nc">FakeNewsSpec</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39; provides the following syntax:</span>
<span class="sd">      spec.initial_value</span>
<span class="sd">      spec.aggression</span>
<span class="sd">      spec.minimum</span>
<span class="sd">      spec.maximum</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">aggression</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">initial_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">minimum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">maximum</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maximum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="o">&gt;=</span> <span class="n">maximum</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">elif</span> <span class="n">initial_value</span> <span class="o">&lt;</span> <span class="n">minimum</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="n">minimum</span>
    <span class="k">elif</span> <span class="n">initial_value</span> <span class="o">&gt;</span> <span class="n">maximum</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="n">maximum</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span> <span class="o">=</span> <span class="n">initial_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aggression</span>    <span class="o">=</span> <span class="n">aggression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="n">minimum</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="n">maximum</span>


<span class="k">def</span> <span class="nf">fake_news</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # aggression ranges from 1 to 100.  1 is the least aggressive and 100 is</span>
<span class="sd">    # the most agressive</span>
<span class="sd">    fn = fake_news(</span>
<span class="sd">      FakeNewsSpec(</span>
<span class="sd">        minimum=0,</span>
<span class="sd">        maximum=100,</span>
<span class="sd">        initial_value=45,</span>
<span class="sd">        aggression=50))</span>

<span class="sd">    for i in range(5):</span>
<span class="sd">      print(fn())</span>

<span class="sd">    # 70.40052265431565</span>
<span class="sd">    # 98.55643192543394</span>
<span class="sd">    # 63.607687838082626</span>
<span class="sd">    # 96.33858152348765</span>
<span class="sd">    # 47.2780049249278</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">AGGRESSION_MAX</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="sd">&#39;&#39;&#39;returns a function that will generate the kind of fake news specified&#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">random</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

  <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span> <span class="o">&lt;=</span> <span class="n">AGGRESSION_MAX</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span>
  <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="n">AGGRESSION_MAX</span>

  <span class="k">def</span> <span class="nf">_fake_news_generator</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;provides an infinite set of number within the spec&#39;&#39;&#39;</span>
    <span class="n">current_number</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">initial_value</span>

    <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
      <span class="n">random_number</span>  <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">maximum</span><span class="p">)</span>
      <span class="c1"># IIR (infinite impulse response)</span>
      <span class="n">current_number</span> <span class="o">=</span> <span class="p">((</span><span class="n">aggression</span> <span class="o">*</span> <span class="n">random_number</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">AGGRESSION_MAX</span> <span class="o">-</span> <span class="n">aggression</span><span class="p">)</span> <span class="o">*</span>
                         <span class="n">current_number</span><span class="p">))</span> <span class="o">/</span> <span class="n">AGGRESSION_MAX</span>
      <span class="k">yield</span> <span class="n">current_number</span>

  <span class="k">def</span> <span class="nf">_fake_news</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;just hides the next syntax&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">_fake_news_generator</span><span class="p">())</span>

  <span class="k">return</span> <span class="n">_fake_news</span>
</pre></div>
</div>
<p>Ok, let’s try it out:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fake_transducer</span> <span class="o">=</span> <span class="n">fake_news</span><span class="p">(</span>
                      <span class="n">FakeNewsSpec</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                   <span class="n">initial_value</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">aggression</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="n">fake_transducer</span><span class="p">())</span>
<span class="c1"># 39.41035307935898</span>
<span class="c1"># 51.639646042274904</span>
<span class="c1"># 53.30613755950629</span>
</pre></div>
</div>
<p>We see we can make the numbers swing around and the function is tunable.  Good
enough (you could probably find something much better in numpy), pushing on.</p>
<p>As <a class="reference external" href="https://www.ted.com/talks/michel_laberge_how_synchronized_hammer_strikes_could_generate_nuclear_fusion">Michel Laberge</a> builds up his prototype reactor he will change the
piston firing specification a lot.</p>
<p>So we have to make sure it’s easy to change.  We will create a
is-this-piston-ready method then we can inject it into our design.  For now
we define it as this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_this_piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">):</span>
  <span class="n">comp</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">get_composite_reading</span><span class="p">()</span>
  <span class="n">temp</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">get_temperature_reading</span><span class="p">()</span>

  <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">20</span> <span class="ow">and</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">25</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">333</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">30</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">66</span> <span class="ow">and</span> <span class="mi">403</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">600</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">70</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="ow">and</span> <span class="mi">670</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">1500</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">return</span> <span class="n">ready</span>
</pre></div>
</div>
<p>Here is the high level UML class diagram for our approach:</p>
<a class="reference external image-reference" href="_static/orthogonal_region3.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region3.svg" src="_images/orthogonal_region3.svg" /></div>
</a>
<p>The FusionReactor class will be a subclass of the Factory.  It will aggregate
255 objects of the Piston class.  The FusionReactor object will connect to the
reactor_on state machine and each of the piston objects will use the same
piston_active state machine.</p>
<p>The Piston class will be a subclass of HsmWithQueues, which means it will not
have it’s own thread.  Threads are only constructed in the ActiveObject class
or any of it’s descendants.  The orthogonal component <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a>
will allow a single thread to be shared between many different <a class="reference internal" href="glossary.html#term-state-machine"><span class="xref std std-term">state
machines</span></a>.  This will be described in more detail shortly.</p>
<p>The Piston objects will each contain their own <span class="xref std std-term">event dispatcher</span>, their own event queues; but they will all reference the same
piston_manager <a class="reference internal" href="glossary.html#term-state-machine"><span class="xref std std-term">state machine</span></a>.</p>
<p>We are going to use the <a class="reference internal" href="recipes.html#recipes-what-a-state-does-and-how-to-structure-it"><span class="std std-ref">polyamorous
nature</span></a> of state methods to
implement the 255 pistons.  Instead of having a separate piston_active
<a class="reference internal" href="glossary.html#term-hierarchical-state-machine"><span class="xref std std-term">HSMs</span></a> defined for each of the 255 active objects we will instead define
just one <a class="reference internal" href="glossary.html#term-hsm"><span class="xref std std-term">HSM</span></a> and share it between all of them. (saving on memory)</p>
<a class="reference external image-reference" href="_static/orthogonal_region4.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region4.svg" src="_images/orthogonal_region4.svg" /></div>
</a>
<p>Let’s start writing the code.  Here is the Piston Class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Piston</span><span class="p">(</span><span class="n">HsmWithQueues</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
<span class="hll">               <span class="n">get_composite_reading</span><span class="p">,</span>
</span><span class="hll">               <span class="n">get_temperature_reading</span><span class="p">,</span>
</span><span class="hll">               <span class="n">is_this_piston_ready</span><span class="p">,</span>
</span>               <span class="n">number</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">is_this_piston_ready</span>    <span class="o">=</span> <span class="n">is_this_piston_ready</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">get_composite_reading</span>   <span class="o">=</span> <span class="n">get_composite_reading</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">get_temperature_reading</span> <span class="o">=</span> <span class="n">get_temperature_reading</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">number</span>                  <span class="o">=</span> <span class="n">number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count</span>                   <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">armed</span>                   <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span>                    <span class="o">=</span> <span class="s2">&quot;piston_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</pre></div>
</div>
<p>The highlights were made to show that it is easy to inject different types of
functions to generate the <a class="reference internal" href="glossary.html#term-transducer"><span class="xref std std-term">transducer</span></a> readings and the
piston-ready criterion.</p>
<p>Now let’s write the piston state machine:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># This is the piston&#39;s HSM, it will be shared by all pistons</span>
<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">armed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">relaxing</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">relaxing</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;relaxing&quot;</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
      <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">priming</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">PRIMING</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">priming</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">triggered</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;piston_slamming! at {}&quot;</span><span class="o">.</span> \
      <span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M:%S:</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">relaxing</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">priming</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span> <span class="n">piston</span><span class="o">.</span><span class="n">is_this_piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">armed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">triggered</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">armed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">priming</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The first thing we notice about this code, is that it uses the <a class="reference internal" href="recipes.html#recipes-boiler-plate-state-method-code"><span class="std std-ref">flat way
of writing</span></a> state methods.</p>
<p>This is because we want this <a class="reference internal" href="glossary.html#term-hsm"><span class="xref std std-term">HSM</span></a> to be shared between multiple
Piston objects.  A <a class="reference internal" href="glossary.html#term-state-machine"><span class="xref std std-term">state machine</span></a> build up using a
<a class="reference internal" href="glossary.html#term-factory"><span class="xref std std-term">factory</span></a> cannot be shared; it belongs to the thing that built
it.  This is in contrast with <a class="reference internal" href="glossary.html#term-flat-state-method"><span class="xref std std-term">flat state methods</span></a>,
they are defined outside of the event processors that will use them.  So they
can be used over and over again if they describe behavior that wants to be
shared.</p>
<p>In our system we are going to have 255 pistons that all want the same type of
behavior.  The internal variables for tracking counts and if that piston is
armed will be kept within the piston objects, not in the HSM that it is using
to define it’s operational state.  Never store your <a class="reference internal" href="glossary.html#term-extended-state-variables"><span class="xref std std-term">extended state
variables</span></a> in a <a class="reference internal" href="glossary.html#term-flat-state-method"><span class="xref std std-term">flat state method</span></a>.</p>
<p>The highlighted code marks the location of the TIME_OUT and FIRE
<a class="reference internal" href="glossary.html#term-signal"><span class="xref std std-term">signals</span></a>.  This signal will be injected into this state machine
using the <code class="docutils literal"><span class="pre">dispatch</span></code> method of the FusionReactor object (this is the essence
of the orthogonal component <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a>).  We will talk more about
that shortly.</p>
<p>We want to build 255 pistons with a tunable <code class="docutils literal"><span class="pre">is_this_piston_ready</span></code> method.
Furthermore, we want to be able to switch out our fake transducer readings with
real functions from the reactor.  To make it easy to change these things I
define a <code class="docutils literal"><span class="pre">build_piston</span></code> function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># A function for building pistons</span>
<span class="k">def</span> <span class="nf">build_piston</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">starting_state</span><span class="p">):</span>
  <span class="c1"># We would change the get_composite_reading and get_temperature_reading</span>
  <span class="c1"># with the actual functions that would return these values in production</span>
  <span class="n">piston</span> <span class="o">=</span> <span class="n">Piston</span><span class="p">(</span>
    <span class="n">get_composite_reading</span><span class="o">=</span><span class="n">fake_news</span><span class="p">(</span>
      <span class="n">FakeNewsSpec</span><span class="p">(</span>
        <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">maximum</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">initial_value</span><span class="o">=</span><span class="mi">89</span><span class="p">,</span>
        <span class="n">aggression</span><span class="o">=</span><span class="mi">21</span><span class="p">)),</span>
    <span class="n">get_temperature_reading</span><span class="o">=</span><span class="n">fake_news</span><span class="p">(</span>
      <span class="n">FakeNewsSpec</span><span class="p">(</span>
        <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">maximum</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
        <span class="n">initial_value</span><span class="o">=</span><span class="mi">798</span><span class="p">,</span>
        <span class="n">aggression</span><span class="o">=</span><span class="mi">16</span><span class="p">)),</span>
    <span class="n">is_this_piston_ready</span><span class="o">=</span><span class="n">is_this_piston_ready</span><span class="p">,</span>
    <span class="n">number</span><span class="o">=</span><span class="n">number</span>
  <span class="p">)</span>
  <span class="n">piston</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">starting_state</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">piston</span>
</pre></div>
</div>
<p>This function builds a fusion piston and starts it in whichever state we like.
It will be changed before we actually turn on the reactor.  We will remove the
<cite>fake_news</cite> calls with actual functions that return readings from our composite
and temperature transducers.  For now, it will let us test and tune our design.</p>
<p>Now that we can build and run a piston, let’s design the FusionReactor class
that it belongs to:</p>
<a class="reference external image-reference" href="_static/orthogonal_region5.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region5.svg" src="_images/orthogonal_region5.svg" /></div>
</a>
<p>From a high level, the FusionReactor is a subclass of the
<a class="reference internal" href="glossary.html#term-factory"><span class="xref std std-term">Factory</span></a> which means it has a thread and it can use the factory
syntax to build up its HSM.  Since there will be only one reactor with 255
pistons, we have it build the 255 pistons when it enters the reactor_on state.
The pistons are stored in an <span class="xref std std-term">extended state variable</span> in the reactor object.  This adds convenient syntax for accessing an
individual piston, or for iterating over all of them.</p>
<p>After constructing it’s pistons the reactor will climb into the
pending_on_pistons state.  This state captures the TIME_OUT event and iterates
through all of the pistons, injecting each of them with the TIME_OUT
<a class="reference internal" href="glossary.html#term-event"><span class="xref std std-term">event</span></a>.  To see how a fusion piston deals with a TIME_OUT we will
look at it’s state chart:</p>
<a class="reference external image-reference" href="_static/orthogonal_region4.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region4.svg" src="_images/orthogonal_region4.svg" /></div>
</a>
<p>So what happens with the first TIME_OUT event?  We see from inspection that
each of the pistons will start in the relaxing state.  There is an assumption
that when the fusion reactor is starting up, it lets its pistons relax into
their firing positions.</p>
<p>So the first TIME_OUT event will be caught by a piston’s relaxing state.  Each
successive TIME_OUT, the piston.count is incremented and when it is high
enough, the piston transitions into pending_optimal_conditions.</p>
<p>In the pending_optimal_conditions state, the piston uses each TIME_OUT pulse to
read its <span class="xref std std-term">tranducers</span>.  From this reading it can determine if
the liquid metal on it’s part of the sphere has met the design criteria for a
piston strike.  It does this by calling the <code class="docutils literal"><span class="pre">is_this_piston_ready</span></code> function
and transitioning into the ready state if the criteria are met, or by staying
in the pending_optimal_conditions if they aren’t.</p>
<p>This behavior is shared with the ready state:  On each TIME_OUT event, the
ready state can transition back into the pending_optimal_conditions if the
strike conditions are no longer present; disarming the piston.  When the ready
state is entered the piston’s armed variable is set to True.  When it is exited
it is set to false.  This is how information is shared with the fusion_reactor
active object.</p>
<p>Before we talk about the fusion_reactor again, we will finish the piston cycle
walk through.  A piston can only FIRE from the ready state and it’s event is
initiated from the fusion_reactor statechart.  A FIRE event causes the piston
to transition into the contract state and then the next TIME_OUT event will
cause it to transition back into the relaxing state.</p>
<p>The piston behavior described above is shared by all of the fusion pistons.
Now that we understand how they work let’s look at the fusion reactor again:</p>
<a class="reference external image-reference" href="_static/orthogonal_region5.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region5.svg" src="_images/orthogonal_region5.svg" /></div>
</a>
<p>We were talking about the pending_on_pistons TIME_OUT event handler prior to
looking at the piston behavior.</p>
<p>The orthogonal component <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> allows one active object to
manually dispatch events into another.  This is done with the <code class="docutils literal"><span class="pre">dispatch</span></code>
method.  Up until now we have dispatched events to our statecharts using the
<code class="docutils literal"><span class="pre">post_fifo</span></code> and <code class="docutils literal"><span class="pre">post_lifo</span></code> methods.  These methods write their events into
a queue, which in turn wakes up a thread then causes that active object’s
<a class="reference internal" href="glossary.html#term-hsm"><span class="xref std std-term">HSM</span></a> to run to completion.</p>
<p>The piston objects do not have their own threads, they share a thread with the
fusion_reactor object.  To pump an event into a piston object’s HSM we call
it’s <code class="docutils literal"><span class="pre">dispatch</span></code> method with the event.  This will cause it to link to it’s
<a class="reference internal" href="glossary.html#term-hsm"><span class="xref std std-term">HSM</span></a>, <a class="reference internal" href="glossary.html#term-run-to-completion"><span class="xref std std-term">run it to completion</span></a> then return
control back to the fusion_reactor statechart.</p>
<p>The fusion_reactor thread can be thought of as a large gear, who’s rotational
energy is coming from it’s thread.  The pistons are little gears that are being
powered by connecting with the large gear.</p>
<p>Getting back to our example we see that the pending_on_pistons states will only
post a FIRE <a class="reference internal" href="glossary.html#term-event"><span class="xref std std-term">event</span></a> when all of its pistons are ready.  The FIRE
event will cause a transition into the fusion_and_heat_transfer state, who’s
entry condition will pump a FIRE event into all of the pistons.  This will
cause each of the pistons to contract and the fusion reaction will be
initiated.  A small star will shine into the liquid metal.</p>
<p>The fusion_and_heat_transfer state uses the reminder <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> to wait for 1
second prior to transitioning back into the pending_on_pistons state.  Also
notice the TIME_OUT event is pumped into each of the piston state machines
by the TIME_OUT ultimate hook in the reactor_on class.   This will allow each
piston to relax while the heat is being transfered out of the liquid metal.</p>
<p>Now that we understand how the fusion reactor object works, let’s write it’s code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># The fusion statechart callbacks</span>
<span class="k">def</span> <span class="nf">reactor_on_entry</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">build_piston</span><span class="p">(</span><span class="n">piston_number</span><span class="p">,</span> <span class="n">starting_state</span><span class="o">=</span><span class="n">piston_ready</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">piston_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">)]</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">reactor_on_time_out</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1"># provide a relaxing TIME_OUT pulse to each piston</span>
  <span class="k">for</span> <span class="n">piston</span> <span class="ow">in</span> <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">:</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

  <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COOL_ENOUGH</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">reactor_on_init</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">energy_generation</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">reactor_on_priming</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">energy_generation_init</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">pending_on_pistons</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">fusion_active_entry</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">for</span> <span class="n">piston</span> <span class="ow">in</span> <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">:</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">fusion_active_cool_enough</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">pending_on_pistons</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">pending_on_pistons_timeout</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">all_ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">for</span> <span class="n">piston</span> <span class="ow">in</span> <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">:</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">all_ready</span> <span class="o">&amp;=</span> <span class="n">piston</span><span class="o">.</span><span class="n">armed</span>
  <span class="k">if</span> <span class="n">all_ready</span><span class="p">:</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">fusion_and_heat_transfer_fire</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">fusion_and_heat_transfer</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="c1"># Create a fusion reactor object and its HSM</span>
<span class="n">fusion_reactor</span> <span class="o">=</span> <span class="n">FusionReactor</span><span class="p">(</span><span class="s2">&quot;fusion_reactor&quot;</span><span class="p">)</span>

<span class="n">fusion_active</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;fusion_active&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_entry</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_init</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_time_out</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PRIMING</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_priming</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">energy_generation</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;energy_generation&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">energy_generation_init</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">fusion_and_heat_transfer</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;fusion_and_heat_transfer&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">fusion_active_entry</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COOL_ENOUGH</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">fusion_active_cool_enough</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">pending_on_pistons</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;pending_on_pistons&#39;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">pending_on_pistons_timeout</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">fusion_and_heat_transfer_fire</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">fusion_reactor</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">fusion_active</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">nest</span><span class="p">(</span><span class="n">energy_generation</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">fusion_active</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">nest</span><span class="p">(</span><span class="n">fusion_and_heat_transfer</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">energy_generation</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">nest</span><span class="p">(</span><span class="n">pending_on_pistons</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">energy_generation</span><span class="p">)</span>

<span class="n">fusion_reactor</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">fusion_active</span><span class="p">)</span>
</pre></div>
</div>
<p>A big issue with this design is the timing.  If you haven’t noticed already, a
TIME_OUT event needs to have a period of 100 ms otherwise we might damage our
fusion reactor. ;)</p>
<p>So here is some very important code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">fusion_reactor</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span>
                         <span class="n">times</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
<span class="hll">                         <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span>                         <span class="n">deferred</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fusion_reactor</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
<span class="c1"># pp(fusion_reactor.pistons[0].spy())</span>
<span class="c1"># pp(fusion_reactor.pistons[1].spy())</span>
<span class="k">print</span><span class="p">(</span><span class="n">fusion_reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
</pre></div>
</div>
<p>We are going to post a TIME_OUT event every 100 ms, 21 times.  This will run
things long enough to see if we see two fusion cycles.  Then we wait 2.1
seconds and then output the results:</p>
<p>This will output:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">27.968188</span><span class="p">]</span> <span class="p">[</span><span class="n">fusion_reactor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">pending_on_pistons</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">28.736951</span><span class="p">]</span> <span class="p">[</span><span class="n">fusion_reactor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">FIRE</span><span class="p">()</span> <span class="n">pending_on_pistons</span><span class="o">-&gt;</span><span class="n">fusion_and_heat_transfer</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">29.687615</span><span class="p">]</span> <span class="p">[</span><span class="n">fusion_reactor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">COOL_ENOUGH</span><span class="p">()</span> <span class="n">fusion_and_heat_transfer</span><span class="o">-&gt;</span><span class="n">pending_on_pistons</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">29.787727</span><span class="p">]</span> <span class="p">[</span><span class="n">fusion_reactor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">FIRE</span><span class="p">()</span> <span class="n">pending_on_pistons</span><span class="o">-&gt;</span><span class="n">fusion_and_heat_transfer</span>

<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">27.823549</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">relaxing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">28.571081</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">relaxing</span><span class="o">-&gt;</span><span class="n">pending_optimal_conditions</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">28.672391</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">pending_optimal_conditions</span><span class="o">-&gt;</span><span class="n">ready</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">28.737451</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">FIRE</span><span class="p">()</span> <span class="n">ready</span><span class="o">-&gt;</span><span class="n">triggered</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">28.775499</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">triggered</span><span class="o">-&gt;</span><span class="n">relaxing</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">29.479119</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">relaxing</span><span class="o">-&gt;</span><span class="n">pending_optimal_conditions</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">29.578757</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">pending_optimal_conditions</span><span class="o">-&gt;</span><span class="n">ready</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">29.788228</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">FIRE</span><span class="p">()</span> <span class="n">ready</span><span class="o">-&gt;</span><span class="n">triggered</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">19</span> <span class="mi">09</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mf">29.880259</span><span class="p">]</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TIME_OUT</span><span class="p">()</span> <span class="n">triggered</span><span class="o">-&gt;</span><span class="n">relaxing</span>
</pre></div>
</div>
<p>Let’s run the first trace through sequence and compare it to its design
diagram, then I’ll write some documentation that I would post to the General
Fusion wiki so that other people could understand my code.</p>
<a class="reference external image-reference" href="_static/orthogonal_region5.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region5.svg" src="_images/orthogonal_region5.svg" /></div>
</a>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="n">Chart</span><span class="p">:</span> <span class="n">fusion_reactor</span> <span class="p">]</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
           <span class="n">top</span>              <span class="n">pending_on_pistons</span>    <span class="n">fusion_and_heat_transfer</span>
            <span class="o">+------</span><span class="n">start_at</span><span class="p">()</span><span class="o">-------&gt;|</span>                        <span class="o">|</span>
            <span class="o">|</span>          <span class="p">(</span><span class="mi">2</span><span class="p">)</span>           <span class="o">|</span>                        <span class="o">|</span>
            <span class="o">|</span>                        <span class="o">+--------</span><span class="n">FIRE</span><span class="p">()</span><span class="o">---------&gt;|</span>
            <span class="o">|</span>                        <span class="o">|</span>          <span class="p">(</span><span class="mi">3</span><span class="p">)</span>           <span class="o">|</span>
            <span class="o">|</span>                        <span class="o">+&lt;----</span><span class="n">COOL_ENOUGH</span><span class="p">()</span><span class="o">------|</span>
            <span class="o">|</span>                        <span class="o">|</span>          <span class="p">(</span><span class="mi">4</span><span class="p">)</span>           <span class="o">|</span>
            <span class="o">|</span>                        <span class="o">+--------</span><span class="n">FIRE</span><span class="p">()</span><span class="o">---------&gt;|</span>
            <span class="o">|</span>                        <span class="o">|</span>          <span class="p">(</span><span class="mi">5</span><span class="p">)</span>           <span class="o">|</span>
</pre></div>
</div>
<ol class="arabic">
<li><p class="first">The fusion_reactor is the high level state chart which runs in it’s own
thread.</p>
</li>
<li><p class="first">Upon starting, the reactor builds 255 different piston orthogonal components
then climbs into the pending_on_pistons state.  While in this state it will
inject the TIME_OUT event into each of these pistons and when it finds that
each piston is armed it will post a FIRE event to itself.</p>
</li>
<li><p class="first">The fusion_reactor FIRE event indicates that all of the pistons are ready.
Upon entering this state each of the piston HSMs will be issued their own
FIRE event, causing them to contract in unison.</p>
<p>After each of the piston heads slam on the outer chamber of the fusion
sphere a liquid metal compression wave will propagate towards the core of
the system.  When this wave hits the plasma containment field it’s energy
will add to the field and cause a nuclear fusion event.  This event will
release a lot of energy and heat into the liquid metal.</p>
<p>The fusion_reactor will remain in the fusion_and_heat_transfer state for
about 1 second.  This will be enough time for turbines to extract the heat
from the system and cool things down enough so that another fusion reaction
can safely take place.</p>
</li>
<li><p class="first">The COOL_ENOUGH event is sent to the reactor when it is cool enough for
another reaction.  While in this state the fusion_reactor will inject it’s
TIME_OUT events into each of the piston HSMs and wait until they have all
reported that they are armed and ready to go.</p>
</li>
<li><p class="first">This is a repeat of step 3.</p>
</li>
</ol>
<p>Let’s run the second trace (a piston trace) through sequence and compare it to
it’s design diagram.  Then I’ll add the comments I would use to describe this
design to the rest of engineering.</p>
<a class="reference external image-reference" href="_static/orthogonal_region4.pdf"><div align="center" class="align-center"><img alt="_images/orthogonal_region4.svg" src="_images/orthogonal_region4.svg" /></div>
</a>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Chart</span><span class="p">:</span> <span class="n">piston_1</span><span class="p">]</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">top</span>           <span class="n">relaxing</span>   <span class="n">pending_optimal_conditions</span> <span class="n">ready</span>         <span class="n">triggered</span>
 <span class="o">+--</span><span class="n">start_at</span><span class="p">()</span><span class="o">---&gt;|</span>                 <span class="o">|</span>                 <span class="o">|</span>               <span class="o">|</span>
 <span class="o">|</span>      <span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="o">|</span>                 <span class="o">|</span>                 <span class="o">|</span>               <span class="o">|</span>
 <span class="o">|</span>                <span class="o">+---</span><span class="n">TIME_OUT</span><span class="p">()</span><span class="o">---&gt;|</span>                 <span class="o">|</span>               <span class="o">|</span>
 <span class="o">|</span>                <span class="o">|</span>       <span class="p">(</span><span class="mi">3</span><span class="p">)</span>       <span class="o">|</span>                 <span class="o">|</span>               <span class="o">|</span>
 <span class="o">|</span>                <span class="o">|</span>                 <span class="o">+--</span><span class="n">TIME_OUT</span><span class="p">()</span><span class="o">----&gt;|</span>               <span class="o">|</span>
 <span class="o">|</span>                <span class="o">|</span>                 <span class="o">|</span>      <span class="p">(</span><span class="mi">4</span><span class="p">)</span>        <span class="o">|</span>               <span class="o">|</span>
 <span class="o">|</span>                <span class="o">|</span>                 <span class="o">|</span>                 <span class="o">+----</span><span class="n">FIRE</span><span class="p">()</span><span class="o">----&gt;|</span>
 <span class="o">|</span>                <span class="o">|</span>                 <span class="o">|</span>                 <span class="o">|</span>      <span class="p">(</span><span class="mi">5</span><span class="p">)</span>      <span class="o">|</span>
 <span class="o">|</span>                <span class="o">+&lt;----------------+-----------------+--</span><span class="n">TIME_OUT</span><span class="p">()</span><span class="o">---|</span>
 <span class="o">|</span>                <span class="o">|</span>                 <span class="o">|</span>                 <span class="o">|</span>      <span class="p">(</span><span class="mi">6</span><span class="p">)</span>      <span class="o">|</span>
 <span class="o">|</span>                <span class="o">+---</span><span class="n">TIME_OUT</span><span class="p">()</span><span class="o">---&gt;|</span>                 <span class="o">|</span>               <span class="o">|</span>
 <span class="o">|</span>                <span class="o">|</span>       <span class="p">(</span><span class="mi">7</span><span class="p">)</span>       <span class="o">|</span>                 <span class="o">|</span>               <span class="o">|</span>
</pre></div>
</div>
<ol class="arabic simple">
<li>This trace is describing a single piston in the fusion reactor.  This
piston’s HSM is driven from the fusion_reactor thread (using the orthogonal
component statechart <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a>).  The TIME_OUT and FIRE events are actually
fed into this HSM from the fusion_reactor.  The piston can arm itself,
but it can not fire without a command provided by the fusion_reactor.</li>
<li>When the piston starts, it disarms by setting it’s armed attribute to False
then it enters the relaxing state.  The piston will remain in this state for 7
TIME_OUT events, after which it will transition into the
pending_optimal_conditions state.  The relaxing state is intended to
describe a piston physically relaxing back into a position where it can be
triggered.</li>
<li>After enough time has passed and the piston is back in it’s firing position a
TIME_OUT event will cause it to transition from the relaxing state into the
pending_optimal_conditions state.  The pending_optimal_conditions state is
used to sample the local transducers to see if the liquid metal has settled
into a state where it is safe to fire the piston.</li>
<li>While the piston is in the pending_optimal_conditions or any of its child
states, any TIME_OUT event will cause it to re-evaluate its firing
criteria.  If after testing its sensors it determines it is ready to fire,
the piston will arm by transitioning into the ready state.  When the piston
is in the ready state it is armed; if it is not in this state it is not armed.</li>
<li>The FIRE event will be issued by the fusion_reactor thread if all of the
pistons are armed (in their ready states).  This will cause the transition
into the contract state which will slam the piston, beginning the pressure
wave and initiate nuclear fusion.</li>
</ol>
<p>If you would like to skip to the next <a class="reference internal" href="glossary.html#term-pattern"><span class="xref std std-term">pattern</span></a> click
<a class="reference internal" href="#patterns-transition-to-history"><span class="std std-ref">here</span></a>.  Here is the full code listing
used in this example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Make Something that can generate numbers for us</span>
<span class="c1"># 1) needs to return a function</span>
<span class="c1"># 2) needs to be tunable</span>
<span class="c1"># 3) needs to be stochastic</span>
<span class="k">class</span> <span class="nc">FakeNewsSpec</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39; provides the following syntax:</span>
<span class="sd">      spec.initial_value</span>
<span class="sd">      spec.aggression</span>
<span class="sd">      spec.minimum</span>
<span class="sd">      spec.maximum</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">aggression</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">initial_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">minimum</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">maximum</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maximum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="o">&gt;=</span> <span class="n">maximum</span><span class="p">:</span>
      <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">initial_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximum</span> <span class="o">-</span> <span class="n">minimum</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">elif</span> <span class="n">initial_value</span> <span class="o">&lt;</span> <span class="n">minimum</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="n">minimum</span>
    <span class="k">elif</span> <span class="n">initial_value</span> <span class="o">&gt;</span> <span class="n">maximum</span><span class="p">:</span>
      <span class="n">initial_value</span> <span class="o">=</span> <span class="n">maximum</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span> <span class="o">=</span> <span class="n">initial_value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">aggression</span>    <span class="o">=</span> <span class="n">aggression</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="n">minimum</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="n">maximum</span>

<span class="k">def</span> <span class="nf">fake_news</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # aggression ranges from 1 to 100.  1 is the least aggressive and 100 is</span>
<span class="sd">    # the most agressive</span>
<span class="sd">    fn = fake_news(FakeNewsSpec(</span>
<span class="sd">                    minimum=0,</span>
<span class="sd">                    maximum=100,</span>
<span class="sd">                    initial_value=45,</span>
<span class="sd">                    aggression=50))</span>

<span class="sd">    for i in range(5):</span>
<span class="sd">      print(fn())</span>

<span class="sd">    # 70.40052265431565</span>
<span class="sd">    # 98.55643192543394</span>
<span class="sd">    # 63.607687838082626</span>
<span class="sd">    # 96.33858152348765</span>
<span class="sd">    # 47.2780049249278</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">AGGRESSION_MAX</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="sd">&#39;&#39;&#39;returns a function that will generate the kind of fake news specified&#39;&#39;&#39;</span>
  <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

  <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span> <span class="o">&lt;=</span> <span class="n">AGGRESSION_MAX</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span>
  <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">aggression</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">aggression</span> <span class="o">=</span> <span class="n">AGGRESSION_MAX</span>

  <span class="k">def</span> <span class="nf">_fake_news_generator</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;provides an infinite set of number within the spec&#39;&#39;&#39;</span>
    <span class="n">current_number</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">initial_value</span>

    <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
      <span class="n">random_number</span>  <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">maximum</span><span class="p">)</span>
      <span class="c1"># IIR (infinite impulse response)</span>
      <span class="n">current_number</span> <span class="o">=</span> <span class="p">((</span><span class="n">aggression</span> <span class="o">*</span> <span class="n">random_number</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">AGGRESSION_MAX</span> <span class="o">-</span> <span class="n">aggression</span><span class="p">)</span> <span class="o">*</span>
                         <span class="n">current_number</span><span class="p">))</span> <span class="o">/</span> <span class="n">AGGRESSION_MAX</span>
      <span class="k">yield</span> <span class="n">current_number</span>

  <span class="k">def</span> <span class="nf">_fake_news</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;just hides the next syntax&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">_fake_news_generator</span><span class="p">())</span>

  <span class="k">return</span> <span class="n">_fake_news</span>

<span class="c1"># Try it out</span>
<span class="n">fake_transducer</span> <span class="o">=</span> <span class="n">fake_news</span><span class="p">(</span>
  <span class="n">FakeNewsSpec</span><span class="p">(</span>
    <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">maximum</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">initial_value</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
    <span class="n">aggression</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="n">fake_transducer</span><span class="p">())</span>

<span class="c1"># Define a method which will determine if the piston is ready to fire ..</span>
<span class="c1"># keep it separate and easy to change.  We will inject it into the Piston</span>
<span class="c1"># class when we build it</span>
<span class="k">def</span> <span class="nf">is_this_piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">):</span>

  <span class="n">comp</span>  <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">get_composite_reading</span><span class="p">()</span>
  <span class="n">temp</span>  <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">get_temperature_reading</span><span class="p">()</span>

  <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">20</span> <span class="ow">and</span> <span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">25</span>  <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">333</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">30</span>  <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">66</span> <span class="ow">and</span> <span class="mi">403</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">600</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">elif</span> <span class="mi">70</span>  <span class="o">&lt;=</span> <span class="n">comp</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="ow">and</span> <span class="mi">670</span> <span class="o">&lt;=</span> <span class="n">temp</span> <span class="o">&lt;=</span> <span class="mi">1500</span><span class="p">:</span>
     <span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">return</span> <span class="n">ready</span>

<span class="k">class</span> <span class="nc">FusionReactor</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pistons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">Piston</span><span class="p">(</span><span class="n">HsmWithQueues</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">get_composite_reading</span><span class="p">,</span>
               <span class="n">get_temperature_reading</span><span class="p">,</span>
               <span class="n">is_this_piston_ready</span><span class="p">,</span>
               <span class="n">number</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">is_this_piston_ready</span>    <span class="o">=</span> <span class="n">is_this_piston_ready</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_composite_reading</span>   <span class="o">=</span> <span class="n">get_composite_reading</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_temperature_reading</span> <span class="o">=</span> <span class="n">get_temperature_reading</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">number</span>                  <span class="o">=</span> <span class="n">number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count</span>                   <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">armed</span>                   <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span>                    <span class="o">=</span> <span class="s2">&quot;piston_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

<span class="c1"># This is the piston&#39;s HSM, it will be shared by all pistons</span>
<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">armed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">relaxing</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">relaxing</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;relaxing&quot;</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
      <span class="n">piston</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">pending_optimal_conditions</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">PRIMING</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">pending_optimal_conditions</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">triggered</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;piston_slamming! at {}&quot;</span><span class="o">.</span> \
      <span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M:%S:</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">relaxing</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">pending_optimal_conditions</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">piston</span><span class="o">.</span><span class="n">is_this_piston_ready</span><span class="p">(</span><span class="n">piston</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">ready</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">pending_optimal_conditions</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">piston_ready</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="n">piston</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">armed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">piston</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">triggered</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">armed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">piston</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">pending_optimal_conditions</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="c1"># A function for building pistons</span>
<span class="k">def</span> <span class="nf">build_piston</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">starting_state</span><span class="p">):</span>
  <span class="c1"># We would change the get_composite_reading and get_temperature_reading</span>
  <span class="c1"># with the actual functions that would return these values in production</span>
  <span class="n">piston</span> <span class="o">=</span> <span class="n">Piston</span><span class="p">(</span>
    <span class="n">get_composite_reading</span><span class="o">=</span><span class="n">fake_news</span><span class="p">(</span>
      <span class="n">FakeNewsSpec</span><span class="p">(</span>
        <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">maximum</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">initial_value</span><span class="o">=</span><span class="mi">89</span><span class="p">,</span>
        <span class="n">aggression</span><span class="o">=</span><span class="mi">21</span><span class="p">)),</span>
    <span class="n">get_temperature_reading</span><span class="o">=</span><span class="n">fake_news</span><span class="p">(</span>
      <span class="n">FakeNewsSpec</span><span class="p">(</span>
        <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">maximum</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
        <span class="n">initial_value</span><span class="o">=</span><span class="mi">798</span><span class="p">,</span>
        <span class="n">aggression</span><span class="o">=</span><span class="mi">16</span><span class="p">)),</span>
    <span class="n">is_this_piston_ready</span><span class="o">=</span><span class="n">is_this_piston_ready</span><span class="p">,</span>
    <span class="n">number</span><span class="o">=</span><span class="n">number</span>
  <span class="p">)</span>
  <span class="n">piston</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">starting_state</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">piston</span>

<span class="c1"># The fusion statechart callbacks</span>
<span class="k">def</span> <span class="nf">reactor_on_entry</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">build_piston</span><span class="p">(</span><span class="n">piston_number</span><span class="p">,</span> <span class="n">starting_state</span><span class="o">=</span><span class="n">piston_ready</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">piston_number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">)]</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">reactor_on_time_out</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1"># provide a relaxing TIME_OUT pulse to each piston</span>
  <span class="k">for</span> <span class="n">piston</span> <span class="ow">in</span> <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">:</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

  <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COOL_ENOUGH</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">reactor_on_init</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">energy_generation</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">reactor_on_priming</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">energy_generation_init</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">pending_on_pistons</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">fusion_active_entry</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">for</span> <span class="n">piston</span> <span class="ow">in</span> <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">:</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">fusion_active_cool_enough</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">pending_on_pistons</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">pending_on_pistons_timeout</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">all_ready</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="k">for</span> <span class="n">piston</span> <span class="ow">in</span> <span class="n">reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">:</span>
    <span class="n">piston</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">all_ready</span> <span class="o">&amp;=</span> <span class="n">piston</span><span class="o">.</span><span class="n">armed</span>
  <span class="k">if</span> <span class="n">all_ready</span><span class="p">:</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">fusion_and_heat_transfer_fire</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">fusion_and_heat_transfer</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="c1"># Create a fusion reactor object and its HSM</span>
<span class="n">fusion_reactor</span> <span class="o">=</span> <span class="n">FusionReactor</span><span class="p">(</span><span class="s2">&quot;fusion_reactor&quot;</span><span class="p">)</span>

<span class="n">fusion_active</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;fusion_active&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_entry</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_init</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_time_out</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PRIMING</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">reactor_on_priming</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">energy_generation</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;energy_generation&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">energy_generation_init</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">fusion_and_heat_transfer</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;fusion_and_heat_transfer&quot;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">fusion_active_entry</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">COOL_ENOUGH</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">fusion_active_cool_enough</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">pending_on_pistons</span> <span class="o">=</span> \
  <span class="n">fusion_reactor</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;pending_on_pistons&#39;</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">pending_on_pistons_timeout</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">FIRE</span><span class="p">,</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">fusion_and_heat_transfer_fire</span><span class="p">)</span><span class="o">.</span> \
    <span class="n">to_method</span><span class="p">()</span>

<span class="n">fusion_reactor</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">fusion_active</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">nest</span><span class="p">(</span><span class="n">energy_generation</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">fusion_active</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">nest</span><span class="p">(</span><span class="n">fusion_and_heat_transfer</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">energy_generation</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">nest</span><span class="p">(</span><span class="n">pending_on_pistons</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">energy_generation</span><span class="p">)</span>

<span class="n">fusion_reactor</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">fusion_active</span><span class="p">)</span>

<span class="n">fusion_reactor</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">),</span>
                       <span class="n">times</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
                       <span class="n">period</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                       <span class="n">deferred</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">2.1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fusion_reactor</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
<span class="c1"># pp(fusion_reactor.pistons[0].spy())</span>
<span class="c1"># pp(fusion_reactor.pistons[1].spy())</span>
<span class="k">print</span><span class="p">(</span><span class="n">fusion_reactor</span><span class="o">.</span><span class="n">pistons</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="transition-to-history">
<span id="patterns-transition-to-history"></span><h2>Transition To History<a class="headerlink" href="#transition-to-history" title="Permalink to this headline">¶</a></h2>
<p>Formal description:</p>
<blockquote>
<div><p>Transition out of a composite state, but remember the most recent active
substate so you can return to that substate later.</p>
<p>State transitions defined in high-level composite states often deal with
events that require immediate attention; however, after handling them, the
system should return to the most recent substate of the given composite
state.  <a class="footnote-reference" href="#id9" id="id5">[8]</a></p>
</div></blockquote>
<p>To describe this pattern I will re-use the toaster oven example.  If you have read
Miro Samek’s book this should seem familiar because it is his.</p>
<a class="reference external image-reference" href="_static/history_1.pdf"><div align="center" class="align-center"><img alt="_images/history_1.svg" src="_images/history_1.svg" /></div>
</a>
<p>In the above design we see that we have built a ToasterOven class which inherits
from the Factory.  This means that it will have it’s own thread, queues and we
will get the convenient syntax for building up the statechart.  The ToasterOven class
has a history, and some methods which do toaster-oven-kind-of-things.  We will
make a toaster by instantiating the ToasterOven class, then build up the HSM
using the factory syntax, then link the toaster’s event processor to this HSM
with the <code class="docutils literal"><span class="pre">start_at</span></code> method.</p>
<p>This HSM consists of two high level states: door_closed and door_open.  From
inspection we see that when the statechart is first turned on, it will climb
into the off state.  If the user issues a BAKE signal, it will begin heating
then enter the baking state.  Similarly, the TOAST signal will cause the
heater to turn on and enter the toasting state.</p>
<p>If an OFF or OPEN event is experienced in either the baking or toasting states
the heater will be turned off as the event processor transitions out of the
heating state.</p>
<p>If the door is opened, an OPEN signal will fire causing the event processor to
follow the Harel Formalism leaving the state(s) and enter the door_open state.</p>
<p>Now, if the user of the toaster oven closed the door, they would expect the
toaster oven to remember what it was doing and re-enter that mode of operation.</p>
<p>This is what the little H* icon is doing.  It represents the UML pseudostate
called <em>deep history</em>.  When the statechart experiences a CLOSE event while in
the door_open state, it should change it’s target state to represent the last
mode of operation.  So you can think of the H* icon as a programmable arrow,
where the start of it is on the door_open state and it’s terminal end pointing
to the last substate of door_closed before the door was opened.</p>
<p>This library does not support the deep history pseudostate.  This is because
the event processor at the heart of the library doesn’t.  Miro Samek writes
code for embedded systems which need to be fast and do not have a lot of memory.
So instead of adding a set of heavy generalized history features; he provided a
way that you can design it into your statechart without relying upon the
framework.  The engineering trade off was to favor speed and simplicity over
syntactical convenience.</p>
<p>Here is how you can add deep history to your toaster oven:</p>
<a class="reference external image-reference" href="_static/history_2.pdf"><div align="center" class="align-center"><img alt="_images/history_2.svg" src="_images/history_2.svg" /></div>
</a>
<p>When we enter baking, toasting or off we just take it’s state method and store
it in the history attribute.  If the statechart ever finds itself
in the door_open state, the CLOSE event will transition to the last mode of
operation by transitioning to the state stored in the history attribute.
That’s it.</p>
<p>So let’s build up this design and test it.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros.hsm</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">miros.activeobject</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="c1"># Create a ToasterOven class from Factory</span>
<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="n">toaster</span><span class="p">):</span>
    <span class="n">toaster</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="n">toaster</span><span class="p">):</span>
    <span class="n">toaster</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater off&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">lamp_off</span><span class="p">(</span><span class="n">toaster</span><span class="p">):</span>
    <span class="n">toaster</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;lamp off&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">lamp_on</span><span class="p">(</span><span class="n">toaster</span><span class="p">):</span>
    <span class="n">toaster</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;lamp on&quot;</span><span class="p">)</span>

<span class="c1"># create the callback handlers for the HSM</span>
<span class="k">def</span> <span class="nf">door_closed_init</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">door_closed_off</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">door_closed_open</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">door_open</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">door_closed_bake</span><span class="p">(</span><span class="n">toasting</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">door_closed_toast</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">door_open_entry</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">toaster</span><span class="o">.</span><span class="n">lamp_on</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">door_open_exit</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">toaster</span><span class="o">.</span><span class="n">lamp_off</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">door_open_close</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toaster</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">heating_entry</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">toaster</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">heating_exit</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="n">toaster</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">off_entry</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">toaster</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">off</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">baking_entry</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">toaster</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">baking</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">toasting_entry</span><span class="p">(</span><span class="n">toaster</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">toaster</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">toasting</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="c1"># make a toaster object</span>
<span class="n">toaster</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="s2">&quot;easy_bake&quot;</span><span class="p">)</span>

<span class="n">door_closed</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;door_closed&quot;</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
                  <span class="n">handler</span><span class="o">=</span><span class="n">door_closed_init</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span>
                  <span class="n">handler</span><span class="o">=</span><span class="n">door_closed_off</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OPEN</span><span class="p">,</span>
                  <span class="n">handler</span><span class="o">=</span><span class="n">door_closed_open</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BAKE</span><span class="p">,</span>
                  <span class="n">handler</span><span class="o">=</span><span class="n">door_closed_bake</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TOAST</span><span class="p">,</span>
                  <span class="n">handler</span><span class="o">=</span><span class="n">door_closed_toast</span><span class="p">)</span><span class="o">.</span> \
                <span class="n">to_method</span><span class="p">()</span>

<span class="n">door_open</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;door_open&quot;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
                <span class="n">handler</span><span class="o">=</span><span class="n">door_open_entry</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
                <span class="n">handler</span><span class="o">=</span><span class="n">door_open_exit</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CLOSE</span><span class="p">,</span>
                <span class="n">handler</span><span class="o">=</span><span class="n">door_open_close</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">heating</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;heating&quot;</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
              <span class="n">handler</span><span class="o">=</span><span class="n">heating_entry</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
              <span class="n">handler</span><span class="o">=</span><span class="n">heating_exit</span><span class="p">)</span><span class="o">.</span> \
            <span class="n">to_method</span><span class="p">()</span>

<span class="n">baking</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;baking&quot;</span><span class="p">)</span><span class="o">.</span> \
           <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
             <span class="n">handler</span><span class="o">=</span><span class="n">baking_entry</span><span class="p">)</span><span class="o">.</span> \
           <span class="n">to_method</span><span class="p">()</span>

<span class="n">toasting</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;toasting&quot;</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
                <span class="n">handler</span><span class="o">=</span><span class="n">toasting_entry</span><span class="p">)</span><span class="o">.</span> \
              <span class="n">to_method</span><span class="p">()</span>

<span class="n">off</span> <span class="o">=</span> <span class="n">toaster</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
          <span class="n">handler</span><span class="o">=</span><span class="n">off_entry</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">to_method</span><span class="p">()</span>

<span class="c1"># now we nest them</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">door_closed</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="n">door_open</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="n">heating</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">door_closed</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">door_closed</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="n">baking</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">heating</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="n">toasting</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">heating</span><span class="p">)</span>

<span class="c1"># start up the statechart</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>

<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BAKE</span><span class="p">))</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OPEN</span><span class="p">))</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CLOSE</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TOAST</span><span class="p">))</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OPEN</span><span class="p">))</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CLOSE</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OFF</span><span class="p">))</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OPEN</span><span class="p">))</span>
<span class="n">toaster</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CLOSE</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">toaster</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
</pre></div>
</div>
<p>If we run this code we produce a high level trace of it’s behavior:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.273324</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.273324</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BAKE</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">baking</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.273324</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OPEN</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">door_open</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.274325</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">CLOSE</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">baking</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.283337</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TOAST</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">toasting</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.283337</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OPEN</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">door_open</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.283337</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">CLOSE</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">toasting</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.293338</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OFF</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.293338</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OPEN</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">door_open</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.293839</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">CLOSE</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">off</span>
</pre></div>
</div>
<p>Now let’s break it into parts and make a few sequence diagrams so we can consider
the results.</p>
<p>We see that when we put the oven into it’s baking mode, open and close the door
it goes back into it’s baking mode, good:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.273324</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.273324</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BAKE</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">baking</span>
<span class="hll"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.273324</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OPEN</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">door_open</span>
</span><span class="hll"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.274325</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">CLOSE</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">baking</span>
</span>
<span class="p">[</span> <span class="n">Chart</span><span class="p">:</span> <span class="n">easy_bake</span> <span class="p">]</span>
     <span class="n">top</span>          <span class="n">off</span>        <span class="n">baking</span>      <span class="n">door_open</span>
      <span class="o">+</span><span class="n">start_at</span><span class="p">()</span><span class="o">-&gt;|</span>            <span class="o">|</span>            <span class="o">|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>
      <span class="o">|</span>            <span class="o">+--</span><span class="n">BAKE</span><span class="p">()</span><span class="o">---&gt;|</span>            <span class="o">|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">+--</span><span class="n">OPEN</span><span class="p">()</span><span class="o">---&gt;|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">+&lt;-</span><span class="n">CLOSE</span><span class="p">()</span><span class="o">---|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>            <span class="o">|</span>
</pre></div>
</div>
<p>We see that when we put the oven into it’s toasting mode, open and close the door
it goes back into it’s toasting mode, good:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.283337</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">TOAST</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">toasting</span>
<span class="hll"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.283337</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OPEN</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">door_open</span>
</span><span class="hll"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.283337</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">CLOSE</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">toasting</span>
</span>
<span class="p">[</span> <span class="n">Chart</span><span class="p">:</span> <span class="n">easy_bake</span> <span class="p">]</span>
  <span class="n">baking</span>    <span class="n">toasting</span>   <span class="n">door_open</span>
     <span class="o">+-</span><span class="n">TOAST</span><span class="p">()</span><span class="o">-&gt;|</span>          <span class="o">|</span>
     <span class="o">|</span>          <span class="o">|</span>          <span class="o">|</span>
     <span class="o">|</span>          <span class="o">+-</span><span class="n">OPEN</span><span class="p">()</span><span class="o">--&gt;|</span>
     <span class="o">|</span>          <span class="o">|</span>          <span class="o">|</span>
     <span class="o">|</span>          <span class="o">+&lt;</span><span class="n">CLOSE</span><span class="p">()</span><span class="o">--|</span>
     <span class="o">|</span>          <span class="o">|</span>          <span class="o">|</span>
</pre></div>
</div>
<p>We see that when we turn the toaster off, then open and close the door it goes
back into the off state, the design works.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.293338</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OFF</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="hll"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.293338</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OPEN</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">door_open</span>
</span><span class="hll"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">20</span> <span class="mi">09</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">33.293839</span><span class="p">]</span> <span class="p">[</span><span class="n">easy_bake</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">CLOSE</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">off</span>
</span>
<span class="p">[</span> <span class="n">Chart</span><span class="p">:</span> <span class="n">easy_bake</span> <span class="p">]</span>
 <span class="n">toasting</span>      <span class="n">off</span>     <span class="n">door_open</span>
     <span class="o">+--</span><span class="n">OFF</span><span class="p">()</span><span class="o">--&gt;|</span>          <span class="o">|</span>
     <span class="o">|</span>          <span class="o">|</span>          <span class="o">|</span>
     <span class="o">|</span>          <span class="o">+-</span><span class="n">OPEN</span><span class="p">()</span><span class="o">--&gt;|</span>
     <span class="o">|</span>          <span class="o">|</span>          <span class="o">|</span>
     <span class="o">|</span>          <span class="o">+&lt;</span><span class="n">CLOSE</span><span class="p">()</span><span class="o">--|</span>
     <span class="o">|</span>          <span class="o">|</span>          <span class="o">|</span>
</pre></div>
</div>
</div>
<div class="section" id="multichart-race">
<span id="patterns-multichart-race"></span><h2>Multichart Race<a class="headerlink" href="#multichart-race" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="setting_up_rabbit_mq.html#setting-up-rabbit-mq-setting-up-rabbit-mq"><span class="std std-ref">setting up rabbit mq</span></a></p>
</div>
<div class="section" id="multichart-pend">
<span id="patterns-multichart-pend"></span><h2>Multichart Pend<a class="headerlink" href="#multichart-pend" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="setting_up_rabbit_mq.html#setting-up-rabbit-mq-setting-up-rabbit-mq"><span class="std std-ref">setting up rabbit mq</span></a></p>
<p><a class="reference internal" href="testing.html#testing-testing"><span class="std std-ref">Next topic</span></a>.</p>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[5]</a></td><td>p.206 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[6]</a></td><td>p.211 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[7]</a></td><td>p.219 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[8]</a></td><td>p.245 Practical UML STATECHARTS in C/C++, Second Edition</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Patterns</a><ul>
<li><a class="reference internal" href="#ultimate-hook">Ultimate Hook</a></li>
<li><a class="reference internal" href="#reminder">Reminder</a></li>
<li><a class="reference internal" href="#deferred-event">Deferred Event</a></li>
<li><a class="reference internal" href="#orthogonal-component">Orthogonal Component</a></li>
<li><a class="reference internal" href="#transition-to-history">Transition To History</a></li>
<li><a class="reference internal" href="#multichart-race">Multichart Race</a></li>
<li><a class="reference internal" href="#multichart-pend">Multichart Pend</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="reflection.html" title="previous chapter">Reflection</a></li>
      <li>Next: <a href="testing.html" title="next chapter">Testing</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/patterns.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Scott Volk.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="_sources/patterns.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>