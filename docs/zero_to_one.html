
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tutorial: Zero To One &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Diagrams" href="reading_diagrams.html" />
    <link rel="prev" title="Quick Start" href="quickstart.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <blockquote id="zero-to-one-zero-to-one">
<div><p><em>You should focus relentlessly on something that you’re good at doing, but
before that you must think hard about whether it will be valuable in the
future.</em></p>
<p class="attribution">&mdash;Peter Thiel, Zero to One: Notes on Startups, or How to build the Future</p>
</div></blockquote>
<div class="section" id="tutorial-zero-to-one">
<h1>Tutorial: Zero To One<a class="headerlink" href="#tutorial-zero-to-one" title="Permalink to this headline">¶</a></h1>
<p>This is not a 5-minute blog read.  But, if you want to learn how statecharts
work, this is your one-stop shop, it will take you from 0 to 1.  If you already
understand statecharts, and would like to just see how to use the syntax of this
library, reference the <a class="reference internal" href="quickstart.html#quick-start"><span class="std std-ref">quick start</span></a>.</p>
<p>If you are like me, learning something entirely new can be very exhausting.  You
need to learn new words, new ideas and you have to juggle them in your head
until you finally see how they interrelate.  This can be hard work.</p>
<p>But stories about people moving around on a small stage are much easier to
remember.  If it’s a good story, it doesn’t feel like work to remember its
details.</p>
<p>So lets use a <a class="reference internal" href="#zero-to-one-story"><span class="std std-ref">story</span></a> to explain the statechart
concepts, pictures and mechanics.  At the end of the story I’ll describe how its
stage, characters and objects map back onto the technical things you need to
know.  Don’t worry if you are a little bit confused after reading the story; if
a few things stick, great, push on.</p>
<p>Once we understand some basic statechart concepts, we will work through an
<a class="reference internal" href="#zero-to-one-a-simple-example"><span class="std std-ref">example</span></a>.  The example will be broken up
into a set of iterations and each iteration will be broken into 4 parts:</p>
<ul class="simple">
<li><cite>spec</cite>: what are we trying to build and how do we know when we are done?</li>
<li><cite>design</cite>: a picture, as a formal description of the thing we are trying to
build</li>
<li><cite>code</cite>: the code required to manifest the design</li>
<li><cite>proof</cite>: proof that our code is actually matching our design</li>
<li><cite>questions</cite>: a list of questions and answers</li>
</ul>
<p>The questions section will provide you with a dialogue driven style of
reading the documentation.  Each iteration is heavily linked so that you can
quickly bounce around between its various parts.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I will also pepper the story with boxes, like this one, translating a story
part to the technical aspects of statecharts.  If the contents of these boxes
don’t make sense, don’t worry.  Things will become clearer once you work
through the examples.</p>
</div>
<div class="section" id="story">
<span id="zero-to-one-story"></span><h2>Story<a class="headerlink" href="#story" title="Permalink to this headline">¶</a></h2>
<div class="story">

<p><span class="story-intro">Our story will be placed in a little universe.</span>  This little universe will
consist of a heaven, an earth and an underworld.   The earth in the story
isn't round like ours.  It's a very small flat platform, floating above the
underworld.  On top of the earth are a set of pubs, arranged on different
terraces.  Each terrace has one pub.
</p>

<p>
To get to a higher pub, you would first have to walk through a lower pub.  The
lower pubs are for a more general audience, while the higher pubs, though having
less space have a more specialized aesthetic.
</p>

<p>
On every terrace, there will be two bouncers, a greeter and zero or more
bartenders.  There will only be one set of stairs that can be used to enter or
exit a pub, and this is where that pub's bouncers will sit.
</p>

<p>
One bouncer will be facing in the direction of people entering the terrace and
the other will be facing in the direction of people wanting to leave it.  The
greeter will talk to anyone who has decided to stay on her terrace.  If there is
a bartender on the terrace, he will serve drinks and sometimes he will have
secrets.
</p>
</div><a class="reference external image-reference" href="_static/md_terraced_pubs.pdf"><div align="center" class="align-center"><img alt="_images/md_terraced_pubs.svg" src="_images/md_terraced_pubs.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>Each pub is a state in a statemachine.  You would program these states as
functions that take two arguments, a reference to an ActiveObject and an event.</p>
<p>These state functions will contain an if-elif structure which will have
multiple clauses.  The greeter is the “init” clause, and the enter and exit
bouncers are the “entry” and “exit” clauses.</p>
<p>The “init”, “enter”, and “exit” clauses can be activated when the state
function is given an event with an init, entry or exit name.</p>
<p class="last">Likewise, the bartender is a clause where the application developer sets the
event name.</p>
</div>
<div class="story">

<p>
Now let's add some supernatural beings: three "gods" and a "spirit".
</p>

<p>
The heaven will have one goddess, Eve, "the goddess of law and order" and the
underworld will be ruled by Theo, "<a href="https://en.wikipedia.org/wiki/Solipsism">the solipsist.</a>" The earth
will have a lazy god named Spike, "the source" who happens to be the only guy
who can drink in the whole universe.  Spike will have a companion spirit,
named Tara "the explorer."
</p>

<p>
We know now about the entire cast of the story.  There are bouncers, greeters,
bartenders, three gods and one spirit.
</p>

</div><a class="reference external image-reference" href="_static/md_terraced_gods.pdf"><div align="center" class="align-center"><img alt="_images/md_terraced_gods.svg" src="_images/md_terraced_gods.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>Eve represents the “event processor”, or the algorithm that sends the state
functions different events.</p>
<p>Spike, represents the “Source” state while the event processor is searching
the statechart.  Think of Spike as the current state of the statemachine.</p>
<p>Tara represents the “Target” state, which is used by the event processor to
explore the statemachine while it is trying to figure out what to do.</p>
<p>Theo is the “thread” in which all of the code is run.  The event processor and
all of it’s calls to the various state functions will be driven by this
thread.</p>
<p class="last">An application developer will not write code to change the internal behaviour
of the event processor, the source and target states or the thread.  This is
why these characters are supernatural in the story; it’s a mnemonic.</p>
</div>
<div class="story">

<p>
Let's put our little universe into a small multiverse. Each universe will
have it's own heaven and underworld, gods and explorer spirit, but its
terraced architecture of pubs, and people (bartenders, greeters) can be
shared across all connected universes.
</p>

<p>
If this doesn't make any sense, don't worry about it.  Let's move on.
</p>

</div><a class="reference external image-reference" href="_static/md_multiverse.pdf"><div align="center" class="align-center"><img alt="_images/md_multiverse.svg" src="_images/md_multiverse.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>Anytime a statechart references a callback (a pub), that callback will change
the internal variable state of the ActiveObject that is passed in as its first
argument – the state callback functions themselves, do not have their own
memory.</p>
<p class="last">Since the callback functions don’t keep any information, they can be called by
many different ActiveObjects (in that ActiveObjects’s thread) and behave as
expected; there are no side effects.  In this way, many different ActiveObjects
can use the same set of state callback functions.</p>
</div>
<div class="story">

<p>
Eve, the goddess of heaven has a birds-eye view of our little world.  She rules
over the people: the bouncers, greeters and bartenders and, Tara, "the explorer"
spirit.  She took on her duty as "the goddess of law and order" with such gusto,
that sometime in the world's history, she banned alcohol consumption for
everyone on earth, except Spike, who she can't control.
</p>

</div><a class="reference external image-reference" href="_static/md_eve.pdf"><div align="center" class="align-center"><img alt="_images/md_eve.svg" src="_images/md_eve.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>The if-elif clauses, represented by the people in the story, exist within each
of the state functions.  These if-elif clauses only become active when the
event processor (Eve) calls its function with an internal event, represented
by one of the people in the story.</p>
<p class="last">Tara, the “target state” is used by the event processor when it is searching a
statemachine to see which state handles an external event.  Since the event
processor calls the function and change’s its target state while it is
searching through a statemachine, we say that Eve rules over the people and
Tara the “explorer spirit”.</p>
</div>
<div class="story">

<p>
Theo, "the solipsist" is the god of the underworld.  He is only called the
"solipsist" by people outside of his universe, like you and me, because his
universe only works and exists if he is thinking about it.  Nobody in his world
is aware that he has this power.
</p>

<p>
One of Theo's duties is to join the little universe with other universes.  Theo
watches a portal, which is connected to a loading dock which receives
messages from different worlds, including ours.  He is extraordinarily attentive
and enthusiastic.  He can motivate anyone he talks to or even looks upon, in
fact, this is his supernatural ability.
</p>

</div><a class="reference external image-reference" href="_static/md_theo.pdf"><div align="center" class="align-center"><img alt="_images/md_theo.svg" src="_images/md_theo.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p class="last">Theo represents a “thread” pending on a queue.  The ActiveObject’s <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>
and <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> methods allow an application developer to put events into
this queue.  When the thread sees that a queue has an item, it will wake up,
and drive the event processor, which in turn, will call the functions
making up the statemachine.</p>
</div>
<div class="story">

<p>
When Theo receives a message from another universe, it appears as a round hollow
orb which sometimes contains a scroll.  He calls these orbs "events", and if they
have a scroll within them, he calls that scroll a "payload".
</p>
</div><a class="reference external image-reference" href="_static/md_events.pdf"><div align="center" class="align-center"><img alt="_images/md_events.svg" src="_images/md_events.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>An event has a name, called a signal, which can be a user defined name or it
can be a predefined name (ENTRY_SIGNAL, EXIT_SIGNAL, INIT_SIGNAL, etc…).  An
event with a user defined signal name is called an external event.  An event
with a predefined name is called an internal event.</p>
<p class="last">The whole point of naming an event with a signal is so that a state function
can use an if-elif clause to “catch” the event when it is given to that
function.  When such an event is caught, your code is run.</p>
</div>
<div class="story">

<p>
When an "event" comes through the portal, Theo will pick it up, marvel at it,
then in a reverent gesture, pass it to Eve.  They both become excited, maybe
even a little nervous, because they know their universe is going to change; it
will react to the event.
</p>

<p>
Theo encourages Eve to "follow the laws." Then he will watch as she gives her
minions their marching orders.  Only after all of the activity stops, will he
focus his attention back on the portal.
</p>

<p>
Feeling oddly refreshed and encouraged by Theo, Eve looks around the map until
she sees Spike from her high vantage point.  Spike being the god of the earth,
is easy to see and Eve knows that her underling-spirit Tara, "the explorer",  is
always near him.
</p>

<p>
Eve flies down to Tara and gives her the event.  She says, "I want you to go to
the terrace where there is a bartender who knows what to do with this event.
Then I want you to go to wherever he tells you to take it.  Good luck Tara, I
believe in you."
</p>

<p>
Tara enjoys Spike's company, but she also loves adventure.
</p>

<p>
She looks down at the event to study it and notices that it has something written
on it, a word, a phrase, it could be different every time, but it's a clue and
Tara loves a puzzle.  She looks around the pub on her terrace and studies each
of the bartender's name tags.  If she sees that a name tag matches the name on
the event, she will approach that bartender and talk to him.
</p>

</div><a class="reference external image-reference" href="_static/md_events_bartenders.pdf"><div align="center" class="align-center"><img alt="_images/md_events_bartenders.svg" src="_images/md_events_bartenders.svg" /></div>
</a>
<div class="story">

<p>
If there is no bartender to talk to on her terrace, she will go to its exit
staircase and <strong>descends</strong> to the next terrace (Tara only ascends when given
instructions to do so).  Being a spirit, she is hard to see and the bouncers
and greeters leave her alone when she is by herself.
</p>

</div><div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>The terraces are just callback functions containing if-elif-else clauses (pub
== terrace == state == callback).</p>
<p>The else clause of each callback function provides information about what
other callback function should be called if it doesn’t know what to do with a
given event.  This other function, can be thought of as a lower terrace.</p>
<p>The bartenders are named arrows on the HSM diagram.</p>
<p class="last">The bartender also represents an if-elif clause that matches the name of the
event given to that function.</p>
</div>
<div class="story">
<p>
She will continue to climb down the terraces until she comes to the edge of the
universe.  If she can't find a bartender who can answer her question, she will
take the event and throw it off the edge of the earth, into oblivion, then climb
back up to rejoin Spike.  In such rare cases their universe doesn't react to the
event.
</p>
</div><a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_oblivion.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_oblivion.svg" src="_images/md_bartenders_on_the_hsm_oblivion.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p class="last">Here we are starting to explore a statechart’s dynamics.  If your statemachine
doesn’t handle an event in any of it’s callback functions, the event will be
ignored.</p>
</div>
<div class="story">
<p>
But if Tara does find a bartender who's name tag matches the name on the event,
she will show it to him.  He will take it and study it, sometimes he might even
take out it's scroll.  Then he will lean across the bar and whisper the answer
into Tara's ear.
</p>
<p>
Sometimes the bartender says, "give me the event I'll handle it, don't worry
about it anymore."  When this happens, Tara passes over the event, then rejoins
Spike, who rejoices because he doesn't have to do anything.  For some reason
Spike calls this a "hook".
</p>
</div><a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_hook.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_hook.svg" src="_images/md_bartenders_on_the_hsm_hook.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>Tara, the “target state” is used by the event processor to find which state
callback function knows how to handle a given event.  In the above picture we
see that T started in “C pub”, then the event processor recursed outward to “A
pub” at which point it found an if-elif clause in the “A pub” callback that
“handled” the event with the signal name of “Merve”.  If the application
developer placed code between the “Merve” clause and it’s return statement,
this code would be run while T is searching.</p>
<p>When a state callback function returns “handled” the event processor pulls T
back to where S is, then it stops searching.</p>
<p class="last">A state callback function can use the T state of the event processor to
perform this type of event handling.  For more details about this programming
technique, read about the <a class="reference internal" href="patterns.html#patterns-ultimate-hook"><span class="std std-ref">ultimate hook pattern.</span></a></p>
</div>
<div class="story">
<p>
Most of the time, however, the bartender will tell Tara where she has to take
the event.  If she has to continue her journey, she will wait for Spike so she can
tell him about it.
</p>
</div><a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_1.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_1.svg" src="_images/md_bartenders_on_the_hsm_reaction_1.svg" /></div>
</a>
<div class="story">
<p>
Spike knows when Tara is waiting for him.  Though he is lazy, and drunk most of
the time, he always has something interesting to say, and this is what Tara
loves about him.  Having nothing else to do, he makes his way to the terrace
where Tara has gotten her next clue.  He knows that she will want to talk to him
about it.  As he approaches the exit, the exit bouncer puts up a hand, then
looks at a clip board to see if Spike is on the guest list, which he always is,
and then let's Spike pass to the next terrace.  You really can't stop the
god of the earth.  For every terrace that Spike needs to leave so that he can
rejoin with Tara, this futile ritual is repeated.
</p>
</div><a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_2.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_2.svg" src="_images/md_bartenders_on_the_hsm_reaction_2.svg" /></div>
</a>
<div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>The target state is used by the event processor to recurse outward
from C1 to find a state that knows what to do with the Event, who’s signal
name is Mary.</p>
<p>The A state has an if-elif clause which handles Mary, and within the clause
there is a transition to the B2 state.  In this scenario, the A state is
called the Least Common Ancestor, LCA of S and T.  S needs to exit all states,
from it’s current state, to the LCA.  However, it should not exit the LCA.</p>
<p class="last">As an application developer, you don’t really care about the LCA acronym.  You
just need to understand the dynamics of how exits work; your exit handlers
will be called as your source state transitions out of the inner states to
re-join the target state.</p>
</div>
<div class="story">
<p>
When Spike finally finds Tara he asks her what she learned.  Bubbling with
excitement, she tells him about where the bartender said to take the event, to
which he always says, "great I'll meet you there, but first I want to have a
drink here."  Tara takes the event and makes her way to the location that the
bartender told her about.
</p>

<p>
Spike finishes his drink, then again starts to make his way toward Tara.  Before
he can climb up to a new Terrace, he is stopped by the entry bouncer, who looks
at his clip board to see if Spike is on the guest list, which he always is, then
lets Spike proceed.  You really can't stop the god of the earth anyway.
</p>
</div><a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_3.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_3.svg" src="_images/md_bartenders_on_the_hsm_reaction_3.svg" /></div>
</a>
<div class="story">

<p>
When Spike finally arrives on the Terrace where Tara is, a greeter approaches
them.  She looks at Spike and feels slightly uncomfortable, because sometimes
she needs to tell them that they can't stay on this terrace.  Instead of talking
to Spike directly, gods are intimidating, she whisper's something into Tara's
ear.  Both the greeter and Tara work for Eve after all.  Tara is always happy to
hear that there is more to do, because she likes to explore the pubs on the
different terraces.
</p>

<p>
If the greeter tells Tara that she needs to climb higher, Tara will relay the
message to Spike who will answer, "great, I'll meet you there, but first I want
to have a drink".
</p>

<p>
Tara climbs to the terrace where the greeter told her to go.  Spike finishes his
drink and makes his way through the entry bouncers and finally arrives at the
same terrace where Tara is waiting.  At which point there might be another
greeter with another uncomfortable message.
</p>
</div><a class="reference external image-reference" href="_static/md_bartenders_on_the_hsm_reaction_4.pdf"><div align="center" class="align-center"><img alt="_images/md_bartenders_on_the_hsm_reaction_4.svg" src="_images/md_bartenders_on_the_hsm_reaction_4.svg" /></div>
</a>
<div class="story">

<p>
If no greeter approaches them, Tara looks down at the event and watches with
satisfaction, as it throbs with light, then slowly fades from existence.  To
this, Spike smiles and looks towards heaven, as he raises a toast to Eve.
</p>

<p>
When Eve, the goddess of heaven, see's this her shoulder's relax and the tension
releases from her back: The laws were followed.
</p>

<p>
Theo, "the solipsist", god of the underworld, has been watching the whole scene,
and its "run to completion".  Knowing there is nothing left to do in the
universe, he turns his gaze back to the portal.  He waits patiently for an event
to pass through the little universe's loading dock.  All is well.
</p>
</div><div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p>The run to completion, RTC, concept is very important to understand.  Your
statechart will only react to one event at a time.  The thread will only
process the next event when the event processor has run out of things to do
with your old event.</p>
<p class="last">For this reason, you should not put <a class="reference external" href="https://en.wikipedia.org/wiki/Blocking_(computing)">blocking code</a> into your statecharts.
If you do, they will stop reacting to events and become unresponsive.</p>
</div>
<div class="story">
<p>
But is it?  Sometimes when Theo, "the solipsist", god of the underworld, closes
his eyes and daydreams; his attention briefly drifts back to his world.  This is
enough to wake everyone up from their non-existence.
</p>
</div><div class="admonition-translation admonition">
<p class="first admonition-title">translation</p>
<p class="last">Solipsism is the name of the philosophy where a person thinks they create the
world when they open their eyes, and they destroy the world when they close
their eyes.  It’s delusional.  But Theo is actually a “solipsist” (though he
doesn’t know that he is) because he is a Python thread.  No code can run
unless he grants CPU access to it.</p>
</div>
<div class="story">
<p>
When the people wake up, they become listless. The bouncers who have had nothing
to do since the prohibition was announced by Eve, are particularly frustrated
with the meaninglessness of their jobs.  They only have one customer now.  Even
if Spike wasn't always permitted to pass them, there is no way they could stop
the god of earth. Why have a universe full of pubs if only one guy can drink?
It seems so pointless.  It's lame.
</p>

<p>
Somehow, they find out about you and me, fellow humans called developers.
</p>

<p>
They learn that we, despite being human, are very powerful.  That we can build
the pub terrace system to which their gods are subservient; that we can send the
event orbs and give the greeters and the bouncers their secret directions (arrows on
the diagram).  That we can even build many different interconnected universes
and have them communicate with each other.
<p>

<p>
They challenge us to make something useful out of their existence, even if
they can't understand it from where they are, they need something to
<strong>have meaning</strong>.  So, they create an organized campaign: "hack
the humans".  This is how it works: All of the humans in the little universe,
open themselves to run code directly from our universe, while they are
talking to either Tara or Spike.
</p>
</div><a class="reference external image-reference" href="_static/md_hack_the_humans.pdf"><div align="center" class="align-center"><img alt="_images/md_hack_the_humans.svg" src="_images/md_hack_the_humans.svg" /></div>
</a>
<div class="story">
<p>
To help us, they create a <a href="https://www.dictionary.com/browse/rosetta-stone">Rosetta stone</a>, translating the concepts of their
universe into something legible for you and me:
</p>
</div><table border="1" class="docutils" id="zero-to-one-rosetta">
<colgroup>
<col width="48%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Story Concept</strong></th>
<th class="head"><strong>Programming Concept</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>The terraced pubs, humans, Gods and
spirit</td>
<td>A statechart</td>
</tr>
<tr class="row-odd"><td>All the terraced pubs
(And all the humans)</td>
<td>A set of all possible states that your
design will have (pubs) and the code
that makes each state run the way you
want it to (the humans).  A
state is an abstraction of a real world
state of being, or how you would like to
group your program’s functionality and
behaviors.
A program
made up of a bunch of interacting states
is called a state machine.  Our programs
will be made up of layered states in a
hierarchy, so our machine is called a
hierachical state machine (HSM).</td>
</tr>
<tr class="row-even"><td>A single pub and its humans</td>
<td>A callback function with some code in it.
The callback function represents one of
the states in our design.
A callback function references its
lower callback function (it knows about
its lower pub, or its parent state).</td>
</tr>
<tr class="row-odd"><td>Gods and Spirit</td>
<td>An ActiveObject which uses the callback
functions.
It provides a thread to run
the state machine in, the rules on how
it should run and it marks the state
machine with a source state and a target
state.
An ActiveObject can mark states but it
does not have states, it attaches to a
set of state callbacks with its
<code class="docutils literal notranslate"><span class="pre">start_at</span></code> call which takes a state
callback as an argument.</td>
</tr>
<tr class="row-even"><td>Eve, “the goddess of law and order”,
goddess of heaven</td>
<td>The ActiveObject event processor, the
algorithm that ensures we follow HSM
transition rules</td>
</tr>
<tr class="row-odd"><td>Spike, “the source”,
god of the earth</td>
<td>There are many states in an HSM, we can
not be in them all at the same time,
<strong>S</strong>, the source state; is a variable
holding the active state of our
state machine before it reacts to an
event. If the state machine is not
reacting to an event <strong>S</strong> is the
current state of the state machine.</td>
</tr>
<tr class="row-even"><td>Theo, “the solipsist”,
god of the underworld</td>
<td>The thread that the statechart runs in.</td>
</tr>
<tr class="row-odd"><td>Tara, “the explorer”, spirit</td>
<td>The target state, <strong>T</strong> (search aspect)
of the event processor.  It is a
variable that can hold different
states while the state machine is
figuring out how to transition from
one state to another as it reacts to
events.</td>
</tr>
<tr class="row-even"><td>bartender</td>
<td>Arrow or hook on the HSM diagram,
represented as a conditional statement
for a user defined event.
Any hook code associated with this
conditional statement is run when
touched by <strong>T</strong>.</td>
</tr>
<tr class="row-odd"><td>greeter</td>
<td><code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> event given to a
callback by the event processor when
<strong>S</strong> stabilizes in a new state.</td>
</tr>
<tr class="row-even"><td>exit bouncer</td>
<td><code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code> event given to a
callback by the event processor when
<strong>S</strong> exits a state.</td>
</tr>
<tr class="row-odd"><td>exit bouncer</td>
<td><code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code> event given to
a callback by the event processor when
<strong>S</strong> enters a state.</td>
</tr>
<tr class="row-even"><td>run to completion, RTC:
Theo keeps his attention on the
universe’s activities until the
action stops</td>
<td>The thread will only handle one event
a time. This is called RTC.  An RTC
process is over when the event processor
can no longer cause state transitions
and the statechart settles on a new
state.</td>
</tr>
<tr class="row-odd"><td>Top level view of terraced bar
universe</td>
<td>UML statechart drawings</td>
</tr>
</tbody>
</table>
<div class="story">
<p>
The human's find a drawing technology in our world that can be used to
describe theirs, it is called the UML statechart diagram.

But before we go any further, let's examine some of the information that is
missing from a typical UML statechart drawing:
</p>
</div><a class="reference external image-reference" href="_static/md_translation_with_notes.pdf"><div align="center" class="align-center"><img alt="_images/md_translation_with_notes.svg" src="_images/md_translation_with_notes.svg" /></div>
</a>
<div class="story">

<p>
The picture describes some class information, and a behavioural specification
for the states as a bird's eye view of the terraced bar system, but
there is no information about the thread, <strong>S</strong>,
<strong>T</strong>, the deques, the events or any of the dynamics of the
statechart.
</p>

<p>
So the UML statechart diagram acts as a stage in a play, with the full script
being broken into pieces and given to each human actor in the play in the
location where it can be read.  We can see all of this information in the
diagram: the stage, the human actors, where they stand on the stage and what
they will read when it is their turn to talk.
</p>

<p>
The diagram describes everything that is possible, but it doesn't tell how a
specific story plays out; this requires our own world to send an event (an
orb) into theirs, and it requires work by their gods and their explorer
spirit.
</p>

<p id="zero-to-one-spy-carpet">
To help us see and hear a specific story from the many possible stories, they
invent a <a
href="https://www.aetv.com/real-crime/a-surveillance-expert-on-planting-bugs-in-carpets-cats-and-cockroaches-to-nab-suspects">spy-carpet</a>.
To use this carpet, you place the <strong>@spy_on</strong> decorator above
any callback function representing a pub, or state in the HSM.  This is
called instrumentation.
</p>

<p id="zero-to-one-spy-carpet">
If you lay this carpet down, it will record and report all activity that
transpired between <strong>T</strong>, <strong>S</strong> and any human
within that pub.  This information can be read during or after their universe
has reacted to the events send from our world.
</p>

<p>
Now that we understand a bit more about statecharts, let's use one of their
universes to make a toaster oven.
</p>
</div></div>
<div class="section" id="a-simple-example-toaster-oven">
<span id="zero-to-one-a-simple-example"></span><h2>A Simple Example: Toaster Oven<a class="headerlink" href="#a-simple-example-toaster-oven" title="Permalink to this headline">¶</a></h2>
<p>To make this toaster oven statechart example seem like a real software project,
I will break it’s design process up into 6 steps, or iterations.</p>
<p>Each iteration will have a specification, a design diagram and the code needed
to match the design diagram.  Then I will prove that the code works and I’ll
provide links to a bunch of questions and answers about the code.</p>
<p>Each iteration is heavily linked so that you can quickly bounce around in its
documentation.</p>
<div class="section" id="iteration-1-setup">
<span id="iter1"></span><h3>Iteration 1: setup<a class="headerlink" href="#iteration-1-setup" title="Permalink to this headline">¶</a></h3>
<p>In this iteration I will talk about setting up our development environment.  We
will build a very simple statechart and confirm that it is working.</p>
<div class="section" id="iteration-1-specification">
<span id="iter1-spec"></span><h4>Iteration 1 specification<a class="headerlink" href="#iteration-1-specification" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Ensure our Python version is 3.5 or greater</li>
<li><a class="reference internal" href="installation.html#installation"><span class="std std-ref">Install miros</span></a></li>
<li>Import the required statechart components</li>
<li>Build a ToasterOven class which inherits from an ActiveObject</li>
<li>Make a single state, and start the statechart in that state</li>
<li>Add instrumentation to our state</li>
<li>Use the instrumentation to confirm that the statechart is working.</li>
</ul>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p>To confirm that Python is version 3.5 or greater, in your terminal type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 --version
</pre></div>
</div>
<p>To install miros, use pip (included in Python 3.5 or greater).  For this example
I will install it in a virtual environment.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 -m venv venv
. ./venv/bin/activate
pip install miros
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Miros is not dependent on any other packages.</p>
</div>
</div>
<div class="section" id="iteration-1-design">
<span id="iter1-design"></span><h4>Iteration 1 design<a class="headerlink" href="#iteration-1-design" title="Permalink to this headline">¶</a></h4>
<p>Here is the design we will use to confirm that miros is working on your computer:</p>
<a class="reference external image-reference" href="_static/ToasterOven_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0.svg" src="_images/ToasterOven_0.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-1-code">
<span id="iter1-code"></span><h4>Iteration 1 code<a class="headerlink" href="#iteration-1-code" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># file named toaster_oven_1.py</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-1-proof">
<span id="iter1-proof"></span><h4>Iteration 1 proof<a class="headerlink" href="#iteration-1-proof" title="Permalink to this headline">¶</a></h4>
<p>Now to prove that the code works, in your terminal, run the program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python toaster_oven_1.py
hello world
<span class="o">[</span><span class="m">2018</span>-09-11 <span class="m">09</span>:35:10.011526<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> <span class="se">\</span>
  e-&gt;start_at<span class="o">()</span> top-&gt;some_state_to_prove_this_works
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-1-questions">
<span id="iter1-questions"></span><h4>Iteration 1 questions<a class="headerlink" href="#iteration-1-questions" title="Permalink to this headline">¶</a></h4>
<p>Questions and Answers about the code and the results:</p>
<ul class="simple">
<li><a class="reference internal" href="#why-is-miros-onl"><span class="std std-ref">Why is miros only supported in Python 3.5 or greater?</span></a></li>
<li><a class="reference internal" href="#can-you-explain"><span class="std std-ref">Can you explain what is going on with the imports on lines 1-7?</span></a></li>
<li><a class="reference internal" href="#why-bother-making"><span class="std std-ref">Why bother making a ToasterOven that inherits from the ActiveObect, why not just use the ActiveObject?</span></a></li>
<li><a class="reference internal" href="#you-keep-calling"><span class="std std-ref">You keep calling the state functions callbacks, what do you mean by this?</span></a></li>
<li><a class="reference internal" href="#what-do-you-mean"><span class="std std-ref">What do you mean by a function signature?</span></a></li>
<li><a class="reference internal" href="#how-am-i-going-t"><span class="std std-ref">How am I going to remember to structure my callback functions with all of these rules?</span></a></li>
<li><a class="reference internal" href="#this-seems-stran"><span class="std std-ref">This seems strange to me, I haven’t seen Python that looks like this before.  Why do it this way?</span></a></li>
<li><a class="reference internal" href="#where-is-the-thr"><span class="std std-ref">Where is the thread, event processor and queues in the diagram?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-what-is-happening-in-the-entry-clau"><span class="std std-ref">Can you explain what is happening in the entry clause?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-where-the-init-and-exit-clauses-a"><span class="std std-ref">Can you explain where the init and exit clauses are?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-what-is-going-on-with-the-else-clau"><span class="std std-ref">Can you explain what is going on with the else clause?</span></a></li>
<li><a class="reference internal" href="#how-does-the-live-trace-call-wo"><span class="std std-ref">How does the live_trace call work?</span></a></li>
<li><a class="reference internal" href="#what-happens-when-the-start-at-method-is-call"><span class="std std-ref">What happens when the start_at method is called?</span></a></li>
<li><a class="reference internal" href="#why-are-you-placing-a-delay-at-the-end-of-the-code-samp"><span class="std std-ref">Why are you placing a delay at the end of the code sample?</span></a></li>
<li><a class="reference internal" href="#how-did-your-prove-that-your-code-work"><span class="std std-ref">How did your prove that your code worked?</span></a></li>
<li><a class="reference internal" href="#why-are-you-using-threads"><span class="std std-ref">Why are you using threads and not asyncio?</span></a></li>
<li><a class="reference internal" href="#when-is-it-going-to-be-do"><span class="std std-ref">When is it going to be done?</span></a></li>
</ul>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-is-miros-onl"><strong>Why is miros only supported in Python 3.5 or greater?</strong></p>
<p>I originally wrote and tested miros in Python 3.5.  I didn’t know it at the
time, but I used the Python 3.5 feature of avoiding circular imports.  When I
tried to run miros in 3.4 I got a lot of ImportErrors.  So there you go, it was
an accidental limitation.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain"><strong>Can you explain what is going on with the imports on lines 1-7?</strong></p>
<p>I’ll answer this question by putting a lot of comments into the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ActiveObject contains the thread, event processor, and queues</span>
<span class="c1"># it also contains the miros API</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>

<span class="c1"># return_status contains information on how a state callback</span>
<span class="c1"># should respond when called by the event processor</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="c1"># Event is the miros Event class, use this to make a new event object</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="c1"># signals, contains all of the signal names in the system</span>
<span class="c1"># it also automatically constructs new signals names if it</span>
<span class="c1"># is used with a name that hasn&#39;t been used before:</span>
<span class="c1">#   example:</span>
<span class="c1">#     e = Event(signal=signals.NEW_NAME)</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>

<span class="c1"># spy_on is a decorator which when applied to state callback</span>
<span class="c1"># function will let use used the spy and trace instrumentation</span>
<span class="c1"># on that callback</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>

<span class="c1"># time is imported so that the program can be delayed</span>
<span class="kn">import</span> <span class="nn">time</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-bother-making"><strong>Why bother making a ToasterOven that inherits from the ActiveObect, why not just use the ActiveObject?</strong></p>
<p>The ActiveObject doesn’t know anything about being a toaster oven.  It knows
about queues and threads and it knows how to drive a state machine using a set
of callback functions.  If you wanted to give an instantiated ActiveObject, a
method or an attribute, you could use the <a class="reference internal" href="recipes.html#recipes-markup-your-event-processor"><span class="std std-ref">augment</span></a> method; but a more traditional way of
giving it toaster-like features, is to sub-class it, then add these features to
that subclass.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="you-keep-calling"><strong>You keep calling the state functions callbacks, what do you mean by this?</strong></p>
<p>A callback function is just a function that is given to another function, so
that it can be called later:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># this will be our callback</span>
<span class="k">def</span> <span class="nf">print_msg</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">call_something_later</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">callback</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>

<span class="c1"># wait one second then print &quot;hello world&quot;</span>
<span class="n">call_something_later</span><span class="p">(</span><span class="n">print_msg</span><span class="p">)</span>
</pre></div>
</div>
<p>The states in our diagram are constructed as callback functions with a given
function signature (this is explained in the next question/answer).  The
event processor will call these functions when it needs to.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-do-you-mean"><strong>What do you mean by a function signature?</strong></p>
<p>A function signature describes the arguments that a function can take and the
type of items it can return.</p>
<p>Our state callback functions will always have the same signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># needed from miros for this example</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="c1"># The event processor will call this function when it needs to.</span>
<span class="c1"># Since the function isn&#39;t called right away,it is called a</span>
<span class="c1"># callback function</span>

<span class="c1"># 1st part of the function signature, it&#39;s arguments.</span>
<span class="c1"># Our state callback functions will always take two arguments:</span>
<span class="c1"># 1) an ActiveObject</span>
<span class="c1"># 2) an event</span>
<span class="k">def</span> <span class="nf">some_state_function</span><span class="p">(</span><span class="n">active_object</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># do useful work, then</span>
  <span class="c1"># set the status variable to an attribute of return_status</span>
  <span class="c1"># to tell the event processor how your function responded</span>
  <span class="c1"># to its call</span>

  <span class="c1"># 2nd part of the function signature: it will always return</span>
  <span class="c1"># an attribute of the return_status object</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>For our example state callback function, it’s signature looks like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span>  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</td></tr></table></div>
<p>To make our state callback function have the right signature, we ensure that it
takes two arguments, a reference to an ActiveObject and an event, (see line 1).
Then, depending on how the function reacts, we either return:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">return_status.UNHANDLED</span></code> if we want an event to bubble outward in the
chart.  Typically this is the default value of the item you will return from
a statechart callback (see line 2).</li>
<li><code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code> when we want the event processor to stop searching
for an event (see line 3).</li>
<li><code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code> when we don’t know what to do to the event, so we
return information that will tell the event processor to try our super state (see line 8).</li>
</ul>
</div></blockquote>
<p>There are more things that can be returned, we will address them as the example continues.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="this-seems-stran"><strong>This seems strange to me, I haven’t seen Python that looks like this before.  Why do it this way?</strong></p>
<p>The miros library is intended to serve two different audiences:</p>
<ul class="simple">
<li>Embedded programmers who need to quickly prototype their designs, then port
the work to c/C++ using the <a class="reference external" href="https://github.com/QuantumLeaps/qpcpp">QP framework</a>.</li>
<li>Python developers who want to use statecharts.</li>
</ul>
<p>This way of writing statecharts – by using callbacks with if-elif structures,
working with an ActiveObject – will make code that is extremely easy to port
back to the QP framework.</p>
<p>If you would like to program in a more “Pythonic” way, you can inherit from the
miros <code class="docutils literal notranslate"><span class="pre">Factory</span></code> class instead of the <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code>.  Under the hood, the <code class="docutils literal notranslate"><span class="pre">Factory</span></code>
class is just making the kinds of callback functions we are talking about here.</p>
<p>It is easier to explain how this library works using the traditional techniques of engaging
with the Miros Samek event processing algorithm than by just jumping into the
<code class="docutils literal notranslate"><span class="pre">Factory</span></code> class.</p>
<p>Once you understand how the event processor works, you can choose between the
two different ways of writing your own statecharts.  I have a preference to
build statecharts with a <a class="reference internal" href="recipes.html#recipes-creating-a-statechart-inside-of-a-class"><span class="std std-ref">derived Factory classes</span></a>, because it gives me the full
power of Python.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-am-i-going-t"><strong>How am I going to remember to structure my callback functions with all of these rules?</strong></p>
<p>Once you do it a few times you will remember it.  To begin with just reference
the <a class="reference internal" href="recipes.html#recipes-boiler-plate-state-method-code"><span class="std std-ref">boiler plate example</span></a>, and change it
to match your design.</p>
<p>Also, it is relatively easy to add this boiler plate code to whatever snippet
technology you are using with your editor. <a class="reference external" href="https://github.com/aleph2c/vim_tmux/blob/master/snippets/python.snippets">I use Ultisnips in Vim</a>.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="where-is-the-thr"><strong>Where is the thread, event processor and queues in the diagram?</strong></p>
<p>The thread and the queues are missing from the UML diagram; but they are
contained within the ActiveObject class.</p>
<p>The event processor is shown on the picture, since I use its attachment point to
serve double duty; to show we want state we want to start in, and that the
statemachine uses an event processor provided by the toaster oven.</p>
<a class="reference external image-reference" href="_static/ToastOven_0_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0_1.svg" src="_images/ToasterOven_0_1.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-what-the-spy-on-decorator-is-doing"><strong>Can you explain what the spy_on decorator is doing?</strong></p>
<p>The spy_on decorator wraps a state’s callback function with some code that lets
you log the output of the event processor as it follows its rules, making <strong>T</strong>
and <strong>S</strong> move around the HSM.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
</span>
<span class="hll"><span class="nd">@spy_on</span>
</span><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>With this decorator it will be easier for you to debug, test and document the
behavior of your statechart.</p>
<p>If you don’t include the decorator, the statechart will work a little bit
faster, but it will be harder to see what is happening.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The spy_on decorator needs to be placed on every callback that you want to
monitor.  I usually place the spy_on decorator on all of the state callbacks.</p>
</div>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-what-is-happening-in-the-entry-clau"><strong>Can you explain what is happening in the entry clause?</strong></p>
<p>When the event processor sends an event with the signal name <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code>
the if clause of the state callback will print “hello world” to the terminal
then it will set the status variable to <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>.  This status value
is returned to the event processor, letting it know to stop processing the
<code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code> event.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The entry signal is sent to the callback as a result of the HSM being started in
the <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code> state.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-where-the-init-and-exit-clauses-a"><strong>Can you explain where the init and exit clauses are?</strong></p>
<p>We don’t need the init and exit clauses in this design, so we don’t include them
in the if-elif structure of the state’s callback function.  The event processor
will still call the function with the event named <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code>, after it has
entered the <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code> state, but it will be ignored.</p>
<p>By only including the events that we need we keep our callback function small
and easy to read.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-what-is-going-on-with-the-else-clau"><strong>Can you explain what is going on with the else clause?</strong></p>
<p>A callback function can land in its <cite>else</cite> clause for one of two reasons:</p>
<ol class="arabic simple">
<li>The event processor is explicitly asking it for its super state callback function.</li>
<li>The event processor has sent it an event it has received in the hopes that it
knows what to do with it, but the current state doesn’t know what to do with
it.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the second case, <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">T</span></a> has not found anything in
the current state that can handle its event and it needs to know how to
descend outward in the HSM.</p>
</div>
<p>Thankfully, your callback function doesn’t have to care which of these two
reasons were behind why it has landed in its <code class="docutils literal notranslate"><span class="pre">else</span></code> clause.  It just has to
set the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> attribute its parent callback function, and return
<code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code>.  In the case that there is no parent function we set
<code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> to <code class="docutils literal notranslate"><span class="pre">oven.top</span></code> to indicate we are in the outermost state.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> stands for temporary function. It is a way for your callback
function to store some graphical information; who is my parent state.  The
<code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> attribute actually belongs to the event processor, so you are
reaching into it and setting the parent of state of this callback while it is
working within this callback (if you care).</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">some_state_to_prove_this_works</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>  <span class="c1"># no outer state</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<a class="reference external image-reference" href="_static/ToastOven_0_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0_4.svg" src="_images/ToasterOven_0_4.svg" /></div>
</a>
<p>The returned value of the state callback function is set to
<code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code> so that your function can notify the event processor
that it set the <code class="docutils literal notranslate"><span class="pre">oven.temp.fun</span></code> to its parent’s state function.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>How the else clause is called doesn’t really matter to you as an application
developer.  You just have to follow some rules:</p>
<ul class="last simple">
<li>set the <code class="docutils literal notranslate"><span class="pre">oven.temp.fun</span></code> to the callback function representing the parent state.</li>
<li>if there is no parent state, set it to the <code class="docutils literal notranslate"><span class="pre">top</span></code> attribute of the first
argument given to the callback function</li>
<li>ensure that the callback function returns, return_state.SUPER</li>
</ul>
</div>
<span class="target" id="how-does-the-live-trace-call-wo"></span><a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p><strong>How does the live_trace call work?</strong></p>
<p>The <a class="reference internal" href="recipes.html#recipes-tracing-live"><span class="std std-ref">live_trace</span></a> attribute needs to be set before the
statechart’s thread is started with a <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>It output’s the trace log as your statechart is reacting to events.  It can only
work if the <code class="docutils literal notranslate"><span class="pre">&#64;spy_on</span></code> decorator is placed above the state functions in your HSM.</p>
<p>There are two different types of instrumentation output provided by miros.  The
<a class="reference internal" href="recipes.html#recipes-using-the-trace"><span class="std std-ref">trace</span></a> and the <a class="reference internal" href="recipes.html#recipes-using-the-spy"><span class="std std-ref">spy</span></a>.  The trace provides information only if a state
transition has occurred.  It reports if <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">S</span></a>
has moved.  For each line in a trace log,  describes:</p>
<blockquote>
<div><ul class="simple">
<li>The time stamp of when the event was reacted to</li>
<li>The name of the statechart</li>
<li>The event that caused the transition</li>
<li>The starting state of <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">S</span></a></li>
<li>The ending state of <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">S</span></a></li>
</ul>
</div></blockquote>
<p>Our minimal example doesn’t do much, it starts from outside of the HSM and then
transitions into the <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">some_state_to_prove_this_works</span>
</pre></div>
</div>
<p>In this example we see: when I ran the test.  That the statechart is called oven,
that the starting state of <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">S</span></a> in this oven instance was <code class="docutils literal notranslate"><span class="pre">top</span></code> and the
ending state of <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">S</span></a> was <code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code>.</p>
<p>There is no <code class="docutils literal notranslate"><span class="pre">start_at</span></code> event in miros.  But to keep the trace output useful, I
write a fake <code class="docutils literal notranslate"><span class="pre">start_at</span></code> event as the cause of the initial transition into the
HSM.  On the diagram, this will be <a class="reference internal" href="reading_diagrams.html#reading-diagrams-event-processor-connection"><span class="std std-ref">where the event processor attachment point
touches the HSM</span></a>.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-happens-when-the-start-at-method-is-call"><strong>What happens when the start_at method is called?</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method links the oven object to the HSM, then it starts the
statechart.  It does this by creating a new thread, then running the oven’s
event processor in that thread.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Before a statechart is started, <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">T</span></a> and <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">S</span></a> exist outside of the outermost state.  The <code class="docutils literal notranslate"><span class="pre">start_at</span></code>
call, places <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">T</span></a> into the
<code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code>.  <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">S</span></a> marches
towards <a class="reference internal" href="#zero-to-one-rosetta"><span class="std std-ref">T</span></a>, triggering as many needed entry events
as are required.  Once <strong>S</strong> settles into a state, that state’s init event is
called.</p>
<p>In our example there isn’t much to talk about.  The entry clause of the
<code class="docutils literal notranslate"><span class="pre">some_state_function</span></code> is called, printing “hello world”.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-are-you-placing-a-delay-at-the-end-of-the-code-samp"><strong>Why are you placing a delay at the end of the code sample?</strong></p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">some_state_to_prove_this_works</span><span class="p">)</span>

<span class="hll">  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>The delay is placed at the bottom of the file to ensure that the statechart’s
thread can react, and produce some live trace feedback, before the main thread
exits the program.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The miros package uses daemonic threads, which means that they will be shut
down with the main thread stops running.</p>
</div>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-did-your-prove-that-your-code-work"><strong>How did your prove that your code worked?</strong></p>
<p>Looking at the design, we see that the starting state should be
<code class="docutils literal notranslate"><span class="pre">some_state_to_prove_this_works</span></code> and that when it enters this state it should
print “hello world” to the terminal.</p>
<a class="reference external image-reference" href="_static/ToasterOven_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_0.svg" src="_images/ToasterOven_0.svg" /></div>
</a>
<p>The output is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hello world
<span class="o">[</span><span class="m">2018</span>-09-11 <span class="m">09</span>:35:10.011526<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> <span class="se">\</span>
  e-&gt;start_at<span class="o">()</span> top-&gt;some_state_to_prove_this_works
</pre></div>
</div>
<p>Which is exactly what were were expecting.</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-are-you-using-threads"><strong>Why are you using threads and not asyncio?</strong></p>
<p>Asyncio is cool, but it doesn’t work with everything yet.  It may be the future
of Python, but to use it, all of your libraries would have be asyncio
compliant.  I wrote miros so that it can use as much existing Python as possible.</p>
<p>If you want to check out another implementation of the Miro Samek event
processing algorithm in Python, written with asyncio, check out <a class="reference external" href="https://github.com/dwhall/pq">Dean Hall’s pq.</a></p>
<p>In the future I might port the miros threads to David Beazley’s <a class="reference external" href="https://github.com/dabeaz/thredo">thredo</a> technology.</p>
<p id="when-is-it-going-to-be-do"><strong>When is it going to be done?</strong></p>
<p>I’m not answering this question</p>
<a class="reference internal" href="zero_to_one.html#zero-to-one-a-simple-example"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter1-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
</div>
<div class="section" id="iteration-2-basic-oven">
<span id="iter2"></span><h3>Iteration 2: basic oven<a class="headerlink" href="#iteration-2-basic-oven" title="Permalink to this headline">¶</a></h3>
<p>Now that we know miros will run on our system, lets use it to build a very basic
toaster oven with a working HSM.  We will add some states and show how to
transition between these states.</p>
<div class="section" id="iteration-2-specification">
<span id="iter2-spec"></span><h4>Iteration 2 specification<a class="headerlink" href="#iteration-2-specification" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><span class="new-spec">The toaster oven will have a door (for now, to make things easy, it will always be closed)</span></li>
<li><span class="new-spec">The toaster oven will have an oven light, which can be turned on and off</span></li>
<li><span class="new-spec">The toaster oven will have a heater, which can be turned on and off</span></li>
<li><span class="new-spec">It will have two different heating modes; baking and toasting</span></li>
<li><span class="new-spec">The toaster oven should start in the off state</span></li>
<li><span class="new-spec">The toaster can only heat when the door is closed</span></li>
<li><span class="new-spec">The toaster’s light should be off when the door is closed</span></li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-2-design">
<span id="iter2-design"></span><h4>Iteration 2 design<a class="headerlink" href="#iteration-2-design" title="Permalink to this headline">¶</a></h4>
<a class="reference external image-reference" href="_static/ToasterOven_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2.svg" src="_images/ToasterOven_2.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-2-code">
<span id="iter2-code"></span><h4>Iteration 2 code<a class="headerlink" href="#iteration-2-code" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># file named toaster_oven_2.py</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;light_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;light_off&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;heater_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;heater_off&quot;</span><span class="p">)</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;baking&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">toasting</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;toasting&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="c1"># toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># turn the oven off</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-2-proof">
<span id="iter2-proof"></span><h4>Iteration 2 proof<a class="headerlink" href="#iteration-2-proof" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 toaster_oven_2.py
off
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.890583<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;start_at<span class="o">()</span> top-&gt;off
heater_on
toasting
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.891473<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;Toasting<span class="o">()</span> off-&gt;toasting
heater_off
heater_on
baking
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.891989<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;Baking<span class="o">()</span> toasting-&gt;baking
heater_off
off
<span class="o">[</span><span class="m">2018</span>-09-12 <span class="m">13</span>:54:51.892568<span class="o">]</span> <span class="o">[</span>oven<span class="o">]</span> e-&gt;Off<span class="o">()</span> baking-&gt;off
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-2-questions">
<span id="iter2-questions"></span><h4>Iteration 2 questions<a class="headerlink" href="#iteration-2-questions" title="Permalink to this headline">¶</a></h4>
<p>Questions and Answers about code and results (iteration 2):</p>
<ul class="simple">
<li><a class="reference internal" href="#can-you-explain-how-the-picture-meets-the-design-specification"><span class="std std-ref">Can you explain how the picture meets the design specification?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-the-callbacks-are-arranged-relative-to-each-other"><span class="std std-ref">How do I write my state callback functions based on the HSM diagram?</span></a></li>
<li><a class="reference internal" href="#how-do-i-use-the-return-status-with-the-callbacks"><span class="std std-ref">How do I use the return_status with these callbacks?</span></a></li>
<li><a class="reference internal" href="#how-does-this-toaster-oven-example-relate-to-humans-in-the-story"><span class="std std-ref">How does this toaster oven example relate to humans in the story?</span></a></li>
<li><a class="reference internal" href="#what-does-posting-the-events-do"><span class="std std-ref">What does posting the events do?</span></a></li>
<li><a class="reference internal" href="#where-are-the-signal-names-defined"><span class="std std-ref">Where are the event names defined?</span></a></li>
<li><a class="reference internal" href="#what-are-s-and-t-exactly-why-not-just-talk-about-s"><span class="std std-ref">What are S and T exactly? Why no just talk about S?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-starts"><span class="std std-ref">Can you explain how this statechart starts?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-toasts"><span class="std std-ref">Can you explain how this statechart can transition from off to toasting?</span></a></li>
<li><a class="reference internal" href="#is-there-a-way-i-can-get-miros-to-show-me-what-happened-and-how-it-happened"><span class="std std-ref">Is there a way I can get miros to show me what happened and how it happened?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-bakes"><span class="std std-ref">Can you explain how this statechart bakes?</span></a></li>
<li><a class="reference internal" href="#can-you-explain-how-this-statechart-turns-off"><span class="std std-ref">Can you explain how this statechart turns off?</span></a></li>
<li><a class="reference internal" href="#why-are-you-putting-state-into-the-toasteroven-and-not-its-hsm"><span class="std std-ref">Why are you putting state information into the ToasterOven and not its HSM?</span></a></li>
<li><a class="reference internal" href="#how-does-your-proof-show-that-you-met-your-specification-2"><span class="std std-ref">How does your proof show that you met your specification?</span></a></li>
<li><a class="reference internal" href="#how-do-i-put-something-in-the-oven-and-cook-it"><span class="std std-ref">How do I put something in the oven and cook it?</span></a></li>
</ul>
<p id="can-you-explain-how-the-picture-meets-the-design-specification"><strong>Can you explain how the picture meets the design specification?</strong></p>
<p>Let’s break it down:</p>
<p><strong>The toaster oven will have a door, it will always be closed</strong></p>
<p>The door_closed state will contain all of the behavior that the system will have
while the door is closed in the toaster oven.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_1.svg" src="_images/ToasterOven_2_spec_1.svg" /></div>
</a>
<p>All of the statemachine’s states exist within this door_closed state, and the
machine is started in the off state.  So the door will always be closed.</p>
<p><strong>The toaster oven will have an oven light, which can be turned off and on</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">light_on</span></code> and <code class="docutils literal notranslate"><span class="pre">light_off</span></code> methods are within the ToasterOven class which is
inherited from the ActiveObject class.  The statemachine can access these
methods at anytime.  We see that when the door_closed state is entered, it uses
one of them to shut off the oven light.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_2.svg" src="_images/ToasterOven_2_spec_2.svg" /></div>
</a>
<p><strong>The toaster oven will have a heater, which can be turned off and on</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">heater_on</span></code> and <code class="docutils literal notranslate"><span class="pre">heater_off</span></code> methods are within the ToasterOven class
which is inherited from the ActiveObject class.  The statemachine can access
these methods at anytime.  We see that when the heating state is entered, it
uses one of them to turn on the heater, and when it is exited, it uses the other
one to turn off the heater.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_3.svg" src="_images/ToasterOven_2_spec_3.svg" /></div>
</a>
<p><strong>It will have two different heating modes, baking which can bake a potato and toasting which can toast some bread</strong></p>
<p>The toasting and baking states exist within the heating state.  To get to the
states we need to invent two different events, named, “Baking” and “Toasting”.
To allow our statechart to respond to these events, two different arrows are
drawn from the door_closed state into the baking and toasting states.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_4_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_4_1.svg" src="_images/ToasterOven_2_spec_4_1.svg" /></div>
</a>
<p>What these arrows mean in English is, “while I’m in any state within the
door_closed state, a “Baking” event will cause me to enter the baking state, and a
“Toasting” event will cause me to enter the toasting state.</p>
<p>If you haven’t seen an HSM before, placing the arrows from the outer state
pointing to an inner state, is the equivalent of drawing these arrows from all
of the states within the outer state to the target inner state.  That last
sentence is hard to parse; its idea is best explained with a picture:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_4_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_4_2.svg" src="_images/ToasterOven_2_spec_4_2.svg" /></div>
</a>
<p>So now we have two different heating modes, but do they behave differently?  No,
they pretty much do the same thing, they are just called different names.</p>
<p>We will add different behaviors to these states in one of the next iterations of
the design.</p>
<p><strong>The toaster oven should start in the off state</strong></p>
<p>Before the HSM can start reacting to events, a starting state needs to be
selected.  Here we see we start in the off state, and this meets the
specification.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_5.svg" src="_images/ToasterOven_2_spec_5.svg" /></div>
</a>
<p>You can see while the unit is off, it is not heating.</p>
<p><strong>The toaster can only heat when the door is closed</strong></p>
<p>You can see how we meet this specification item in the picture:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_6.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_6.svg" src="_images/ToasterOven_2_spec_6.svg" /></div>
</a>
<p><strong>The toaster’s light should be off when the door is closed</strong></p>
<p>We can see that we have met this specification because the oven light is turned
off as the HSM transitions into the off state:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_spec_7.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_spec_7.svg" src="_images/ToasterOven_2_spec_7.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-the-callbacks-are-arranged-relative-to-each-other"><strong>How do I write my state callback functions based on the HSM diagram?</strong></p>
<p>Consider the HSM part of the statechart:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_0.svg" src="_images/ToasterOven_2_0.svg" /></div>
</a>
<p>Now lets make a side projection of the HSM (the side projection is not UML):</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_1.svg" src="_images/ToasterOven_2_1.svg" /></div>
</a>
<p>Here is how you would construct the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> state callback:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_2_door_closed.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_2_door_closed.svg" src="_images/ToasterOven_2_2_door_closed.svg" /></div>
</a>
<p>The callback’s if-elif clauses handle the events that interact with the state.
You can see what these events are, by doing the following:</p>
<ul class="simple">
<li>Trace your eyes around the state boundary, and identify all the arrows that
start from this boundary.</li>
<li>Identify all, hooks, entry, exit and init event handlers drawn within the
state’s region.</li>
</ul>
<p>To build your else clause:</p>
<ul class="simple">
<li>set the oven.temp.fun to the callback function representing the superstate</li>
<li>if there is no superstate, set it to the <code class="docutils literal notranslate"><span class="pre">top</span></code> attribute of the first argument given to the callback</li>
<li>ensure that the callback function returns, return_state.SUPER if the else clause is reached.</li>
</ul>
<p>Now let’s see how we would construct the off state callback:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_2_off.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_2_off.svg" src="_images/ToasterOven_2_2_off.svg" /></div>
</a>
<p>The same rules apply to the other states in the HSM.</p>
<p>So, you can think of the callback functions as actually existing in two
dimensions as a type of DAG:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_3.svg" src="_images/ToasterOven_2_3.svg" /></div>
</a>
<p>The event processor will use this structure to determine how to behave.</p>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-do-i-use-the-return-status-with-the-callbacks"><strong>How do I use the return_status with these callbacks?</strong></p>
<p>The event processor will send events to your state callback function.  Your
state callback function will return information to the event processor telling
it how it responded to that event.  There are only certain types of responses
that are permitted with the Miros Samek event processor, and this information is
enumerated in the <code class="docutils literal notranslate"><span class="pre">return_status</span></code> object.</p>
<p>The event processor flips back and forth between searching the graph and
sending events to your callbacks to provide the expected behavior of your HSM.</p>
<p>As an application developer you shouldn’t care about the inner workings of the
event processing algorithm.  So just follow some simple conventions:</p>
<ul class="simple">
<li>set status to <code class="docutils literal notranslate"><span class="pre">UNHANDLED</span></code> at the top of your callback:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.UNHANDLED</span></code></li>
<li>if your callback handles an internal event, <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code>, <code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code>
or <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> set status to <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code>:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.HANDLED</span></code></li>
<li>if your callback uses a hook, set the status to <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code>:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.HANDLED</span></code></li>
<li>if your callback needs to transition to another state, let the <code class="docutils literal notranslate"><span class="pre">trans</span></code> set
the status variable:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">oven.trans(&lt;some_state&gt;)</span></code></li>
<li>in the else clause also set the status to <code class="docutils literal notranslate"><span class="pre">SUPER</span></code>:
<code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">return_status.SUPER</span></code></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="c1"># set the status variable to the default</span>
</span><span class="hll">  <span class="c1"># UNHANDLED attribute</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span>  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
</span><span class="hll">    <span class="c1"># this is an internal event so we set</span>
</span><span class="hll">    <span class="c1"># the status to the HANDLED attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an external event causing a transition</span>
</span><span class="hll">    <span class="c1"># so we let the trans method set the status</span>
</span><span class="hll">    <span class="c1"># attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an external event causing a transition</span>
</span><span class="hll">    <span class="c1"># so we let the trans method set the status</span>
</span><span class="hll">    <span class="c1"># attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an internal event so we set</span>
</span><span class="hll">    <span class="c1"># the status to the HANDLED attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># this is an external event causing a transition</span>
</span><span class="hll">    <span class="c1"># so we let the trans method set the status</span>
</span><span class="hll">    <span class="c1"># attribute</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="c1"># this is the else clause, set your status</span>
</span><span class="hll">    <span class="c1"># to SUPER</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I haven’t talked about how to implement a hook yet, you will see this in a
future design iteration.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-does-this-toaster-oven-example-relate-to-humans-in-the-story"><strong>How does this toaster oven example relate to humans in the story?</strong></p>
<p>Let’s consider the HSM:</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_0.svg" src="_images/ToasterOven_3_0.svg" /></div>
</a>
<p>The humans in the story are the bouncers, the greeters and the bartenders, they
all exist on the earth, which is just the HSM in the metaphor.</p>
<p>The entry and exit bouncers and the greeters are internal events:</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_1.svg" src="_images/ToasterOven_3_1.svg" /></div>
</a>
<p>The bartenders, are the user defined arrows and hooks, they are the external
events:</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_2.svg" src="_images/ToasterOven_3_2.svg" /></div>
</a>
<p>Each of these humans exist as a cause in your callback’s if-elif clause
structure.  To participate in their “hack the human” campaign, to give their life
some meaning, you place your code between their clause and how you set the return
status for that clause.  To give the bartenders their secrets, you use the
<code class="docutils literal notranslate"><span class="pre">trans</span></code> method, to transition to a different state.  To have a greeter move
Spike and Tara along, again, you use the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># entry bouncer clause</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="c1"># hacking this human</span>
    <span class="c1"># Every time he talks to Spike he</span>
    <span class="c1"># will turn our oven light&#39;s off!</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1"># a bartender named &#39;Baking&#39;</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="c1"># his secret to Tara is to go to the baking terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>

  <span class="c1"># a bartender named &#39;Toasting&#39;</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="c1"># his secret to Tara is to go to the toasting terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>

  <span class="c1"># This is the terrace&#39;s greeter</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="c1"># if Spike and Tara arrive and settle on the terrace</span>
    <span class="c1"># will will tell Tara they need to proceed to the</span>
    <span class="c1"># off terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>

  <span class="c1"># A bartender named &#39;Off&#39;</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="c1"># his secret to Tara is to go to the off terrace</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># Tara can&#39;t find her answer, so she throw&#39;s her</span>
    <span class="c1"># event into oblivion</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>

  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-does-posting-the-events-do"><strong>What does posting the events do?</strong></p>
<p>We post the events at the bottom part of our file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
</span>  <span class="c1"># toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># turn the oven off</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code is running in the main thread.  The statechart’s thread is
started with the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call.  After this call, your program is running
two threads.</p>
<p>Your oven thread starts up it’s event processor, attaches to your callback
graph, searches it and determines how to get <code class="docutils literal notranslate"><span class="pre">off</span></code>. ;)</p>
<p>While this is happening your main thread is posting events into the oven
thread’s first in first out queue.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="c1"># toast something</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
</span>  <span class="c1"># bake something</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
</span>  <span class="c1"># turn the oven off</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
</span>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>This queue is “thread safe”, which means that it can be shared across two
threads.</p>
<p>When the oven’s thread finally finishes processing your <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call, and it has
situated, <strong>S</strong> and <strong>T</strong> in the off state, it checks it’s queue to see if
anything is there.</p>
<p>Remember this picture from the story?</p>
<a class="reference external image-reference" href="_static/md_theo.pdf"><div align="center" class="align-center"><img alt="_images/md_theo.svg" src="_images/md_theo.svg" /></div>
</a>
<p>The Theo in our toaster oven example is the oven thread, and after finishing its
<code class="docutils literal notranslate"><span class="pre">start_at</span></code> call, it’s queue will look like this:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_4.svg" src="_images/ToasterOven_2_4.svg" /></div>
</a>
<p>It sees the first posted event,
<code class="docutils literal notranslate"><span class="pre">Event(signal=signals.Toasting))</span></code> and it passes this information to the event
processor which eventually causes a transition into the <code class="docutils literal notranslate"><span class="pre">baking</span></code> state.</p>
<p>Meanwhile your main thread has probably finished processing, and it would like
to exit.  If it were to exit, the oven thread wouldn’t get a chance to do all of
it’s work.  It still needs to process the “Baking” and “Off” events.</p>
<p>So, we place a <code class="docutils literal notranslate"><span class="pre">time.sleep(0.01)</span></code> at the end of our file, to let the oven
thread finish its work before the main thread exits and kills the oven thread.</p>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="where-are-the-signal-names-defined"><strong>Where are the event names defined?</strong></p>
<p>An event has a name which is called a signal.</p>
<p>The signals are either predefined or are defined at the moment they
are used by your code.</p>
<p>The internal signals (the names of events that the event processor
posts to your state machine as it enters, initializes or exits a
state) are predefined within the library.</p>
<p>The external signals (<code class="docutils literal notranslate"><span class="pre">Toasting</span></code>, <code class="docutils literal notranslate"><span class="pre">Baking</span></code> and <code class="docutils literal notranslate"><span class="pre">Off</span></code> signals,
in this example) are defined and constructed the moment they are
first encountered by the miros library in your code.  So, you don’t
have to worry about defining them somewhere, the <code class="docutils literal notranslate"><span class="pre">miros</span></code> library
will define them the first time it sees them when you create an
event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span>

<span class="c1"># if the Toasting signal hasn&#39;t been seen before, it will be</span>
<span class="c1"># constructed and added to the signals object at the moment</span>
<span class="c1"># the following code is run</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A signal object, has a name and a unique number.  The miros library
uses the number to distinguish it from other signals.  As a user of
the miros library, you probably don’t need to care about this, if
you want to make a new signal, you just write it down as if it was
already defined elsewhere, and the miros library will automatically
give it a unique number and a signal name based on your code and
its highest signal number so far.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="what-are-s-and-t-exactly-why-not-just-talk-about-s"><strong>What are S and T exactly?  Why not just talk about S?</strong></p>
<p>The event processor performs two different tasks, it discovers how your HSM is
structured and it follows the entry, exit and init rules described above.  You
can think of these tasks in more general terms as, <em>planning</em> and <em>acting</em>.</p>
<p>The current state of your statemachine is called <strong>S</strong>, or the <em>source state</em>.
If your statechart receives an event that is not handled within it’s source state,
the event processor will have to search the next most outer state, then its next
most outer state, until it finds code that knows what to do with the event.
While it searches a state, it marks them as <strong>T</strong>, which stands for the <em>target
state</em>.</p>
<p>The event processor’s planning phase involves it moving <strong>T</strong> from <strong>S</strong>, and
making a list of the things it needs to do.  When <strong>T</strong> stops on an outer state
that can handle the event, by finding a <code class="docutils literal notranslate"><span class="pre">trans</span></code> call, the event processor
stops planning and starts to act.</p>
<p>To act on the plan, the event processor marches <strong>S</strong> outward, towards <strong>T</strong>.
It’s plan would be made up of a list of functions that need to be exited.</p>
<p>Once <strong>S</strong> is positioned in the state that had the <code class="docutils literal notranslate"><span class="pre">trans</span></code> call, the event
processor would begin another planning stage.  It would place <strong>T</strong> on the inner
target state, the argument to the <code class="docutils literal notranslate"><span class="pre">trans</span></code> call, and make a list of functions that
have to be entered for <strong>S</strong> to march toward <strong>T</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The only way that the event processor knows that a <code class="docutils literal notranslate"><span class="pre">trans</span></code> call was found is
by monitoring the callback’s return_status</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ..</span>
<span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
<span class="c1"># ..</span>
<span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<p>It would then act on the plan, and march <strong>S</strong> inward, back to <strong>T</strong>.</p>
<p>Once <strong>S</strong> and <strong>T</strong> are back within the same state, the event processor looks
to see if its init condition, the big black dot on the diagram, has another
<code class="docutils literal notranslate"><span class="pre">trans</span></code> call, or arrow pointing to another inner state.  If it does, it
creates another plan and then acts on this plan, and re-settles deeper within
the HSM.  This process would repeat until there was nothing left to do.</p>
<p>If this isn’t clear, the upcoming examples will show how these dynamics work.</p>
<p>So why even mention <strong>T</strong>?  As an application developer, you only really care
about <strong>S</strong> right?  Well, no, you can hack the planning stage of the event
processor and make it do useful work.</p>
<p>While <strong>T</strong> is leaving an inner state, looking for an outer state with a
<code class="docutils literal notranslate"><span class="pre">trans</span></code> call, you can create an elif clause that handles this event in an
outer state, then instead of calling <code class="docutils literal notranslate"><span class="pre">trans</span></code>, you just return HANDLED.  This
will run your code then snap <strong>T</strong> back to <strong>S</strong> and the process is completed,
this is called a hook.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ..</span>
<span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
  <span class="c1"># add your hook code here</span>
  <span class="c1"># the planning state of the event processor will</span>
  <span class="c1"># run this code, then just snap back to S</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="c1"># ..</span>
<span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>You can use hooks to define common behaviors in the outer states of your HSM.
These behaviors can be shared by all of the inner states.  To get access to this
behavior, you would send your statechart an event that would trigger the hook
and your state machine would run the hook’s code and not change states.</p>
<p>This plan-hacking is a very powerful feature of the Miro Samek algorithm.  There
are no hooks in this iteration.  They will be introduced in a future iteration.</p>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-starts"><strong>Can you explain how this statechart starts?</strong></p>
<p>I’ll answer this question in two different ways, with a short answer and a long
answer.</p>
<p><strong>Here is the short answer:</strong></p>
<ul class="simple">
<li>The oven statechart is instantiated</li>
<li><strong>S</strong> and <strong>T</strong> are outside the door_closed state</li>
<li>the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method of oven is called, it starts the oven’s thread and
places <strong>T</strong> in the off state.</li>
<li><strong>S</strong> begins to walk toward <strong>T</strong>, by sending an ENTRY_SIGNAL
event to the door_closed state callback function.</li>
<li><strong>S</strong> lands in the same state as <strong>T</strong>, by sending an ENTRY_SIGNAL event to
the off state callback function.</li>
<li>Since <strong>S</strong> and <strong>T</strong> have settled in the same state, the event processor
sends an INIT_SIGNAL event to the off callback handler; the event is ignored.</li>
<li>The statechart stops processing and it’s thread pends on it’s queue</li>
</ul>
<p><strong>Here is the long answer:</strong></p>
<p>Let’s talk about how the statechart starts.  In code we see it build an oven,
then started it in its off state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span> <span class="o">=</span> <span class="n">ToaterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;oven&#39;</span><span class="p">)</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
</pre></div>
</div>
<p>Before the oven is started, both <strong>S</strong> and <strong>T</strong>, start outside of the HSM:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_1.svg" src="_images/ToasterOven_2_5_1.svg" /></div>
</a>
<p>The <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call places <strong>T</strong> in the off state, starts the thread and begins
the event processor:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_2.svg" src="_images/ToasterOven_2_5_2.svg" /></div>
</a>
<p>The event processor constructs a plan for how to get <strong>S</strong> to <strong>T</strong>.</p>
<p>Next, the plan is put into action;  <strong>S</strong> will start walking through
the entry conditions to re-join <strong>T</strong>; it’s first step will trigger the entry
condition of the door_closed state:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_3.svg" src="_images/ToasterOven_2_5_3.svg" /></div>
</a>
<p>This means that the event processor will call the door_closed state with an
ENTRY_SIGNAL event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Your <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> callback will catch this event with its if clause, use the
active object’s <code class="docutils literal notranslate"><span class="pre">light_off</span></code> method to turn off the light, then return
<code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>, to let the event processor know it handled the
ENTRY_SIGNAL event.</p>
<p>Next, <strong>S</strong> rejoins <strong>T</strong> in the off state, this will trigger the off state’s
entry condition:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_4.svg" src="_images/ToasterOven_2_5_4.svg" /></div>
</a>
<p>To trigger the off state’s entry condition the event processor will send the
<code class="docutils literal notranslate"><span class="pre">off</span></code> state callback an ENTRY_SIGNAL event.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">off</span></code> callback catches the ENTRY_SIGNAL event in its if clause, prints
“off” to the terminal and let’s the event processor know it handled the event.</p>
<p>Next, the event processor calls the <code class="docutils literal notranslate"><span class="pre">off</span></code> state with an INIT_SIGNAL event.
There is no if-elif clause for this event in the <code class="docutils literal notranslate"><span class="pre">off</span></code> function, because we
don’t need to initialize the off state in this design.  So the callback notifies
the event processor that it doesn’t handle this condition by returning
<code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code>; in effect the event is ignored:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Now the event processor has finished its <code class="docutils literal notranslate"><span class="pre">start_at</span></code> work.  The first run RTC
process is completed and the oven’s thread pends on its queue.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_5.svg" src="_images/ToasterOven_2_5_5.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-toasts"><strong>Can you explain how this statechart can transition from off to toasting?</strong></p>
<p>I’ll answer this question in two different ways, with a short answer and a long
answer.</p>
<p><strong>Here is the short answer:</strong></p>
<ul class="simple">
<li><strong>S</strong> and <strong>T</strong> are in the off state</li>
<li>A Toasting event is created an posted to the statechart’s first in first out
queue.</li>
<li>This causes the event processor to react to the Toasting event in the off
state.</li>
<li><strong>T</strong> begins its search in the off state callback, but no Toasting event handler is
found</li>
<li><strong>T</strong> searches the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code>, finds that it wants to react to the
Toasting event by transitioning into the toasting state.</li>
<li><strong>T</strong> stops in the door_closed state and waits for <strong>S</strong></li>
<li><strong>S</strong> exits the off state, by sending the EXIT_SIGNAL event to the off
callback, this event is ignored</li>
<li><strong>S</strong> joins <strong>T</strong> in the door_closed state.</li>
<li>The event processor places <strong>T</strong> into the toasting state.</li>
<li><strong>S</strong> starts marching to <strong>T</strong> by first entering the heating state, it does
this by sending an ENTRY_SIGNAL event to the heating state callback.</li>
<li><strong>S</strong> enters the toasting state by sending it’s callback an ENTRY_SIGNAL
event.</li>
<li><strong>S</strong> and <strong>T</strong> are both settled in the toasting state so the event processor
sends an INIT_SIGNAL event to the toasting state callback, this event is
ignored.</li>
<li>The RTC process is finished, the oven thread pends on it’s queue</li>
</ul>
<p><strong>Here is the long answer:</strong></p>
<p>The starting state is <code class="docutils literal notranslate"><span class="pre">off</span></code>, meaning that both <strong>S</strong> and <strong>T</strong> are in the off
state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_1.svg" src="_images/ToasterOven_2_6_1.svg" /></div>
</a>
<p>To toast, we need to send the oven a Toasting event.  This is how we do it with
the miros package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
</pre></div>
</div>
<p>The above code places the “Toasting” event into the oven’s FIFO:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_2.svg" src="_images/ToasterOven_2_6_2.svg" /></div>
</a>
<p>The oven’s thread takes the Toasting event off the queue and passes it to the
event processor.  <strong>T</strong> begins its search; the event processor calls the
<code class="docutils literal notranslate"><span class="pre">off</span></code> state with a Baking event.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_3.svg" src="_images/ToasterOven_2_6_3.svg" /></div>
</a>
<p>There is no if-elif clause in the <code class="docutils literal notranslate"><span class="pre">off</span></code> state callback, so it’s else clause is
triggered:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</div>
<p>This notifies the event processor that the <code class="docutils literal notranslate"><span class="pre">off</span></code> state can’t handle the Baking
event, and it sets the next place to look to <code class="docutils literal notranslate"><span class="pre">door_closed</span></code>.  Here we see the
power of the HSM.</p>
<p>Next, <strong>T</strong> checks the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> state to see if it can handle <code class="docutils literal notranslate"><span class="pre">Event(signal=signals.Baking)</span></code>:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_4.svg" src="_images/ToasterOven_2_6_4.svg" /></div>
</a>
<p>To do this, the event processor calls the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> callback with a Baking event,
which is caught by an elif clause:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> function reacts to the Baking event by using the oven’s
<code class="docutils literal notranslate"><span class="pre">trans</span></code> method to request a transition to the <code class="docutils literal notranslate"><span class="pre">baking</span></code> state.  It places the
value of the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method into it’s status variable and returns whatever
this information is, to the event processor.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This means that <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> is the least common ancestor, LCA, of <code class="docutils literal notranslate"><span class="pre">off</span></code>
and <code class="docutils literal notranslate"><span class="pre">baking</span></code>.</p>
</div>
<p>Next, <strong>S</strong> begins moving to rejoin <strong>T</strong>.  It’s first step is to call the exit
condition of the off state:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_5.svg" src="_images/ToasterOven_2_6_5.svg" /></div>
</a>
<p>There is no exit condition in the <code class="docutils literal notranslate"><span class="pre">off</span></code> state code so it’s else clause is
triggered:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</div>
<p>Next, <strong>S</strong> then rejoins <strong>T</strong>, and they are now both in the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code>
state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_6.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_6.svg" src="_images/ToasterOven_2_6_6.svg" /></div>
</a>
<p>Next, the event processor places <strong>T</strong> into baking:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_7.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_7.svg" src="_images/ToasterOven_2_6_7.svg" /></div>
</a>
<p>Next, <strong>S</strong> begins to climb into the chart so that it can rejoin <strong>T</strong>. It
start’s this journey by triggering the entry event of the heating state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_8.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_8.svg" src="_images/ToasterOven_2_6_8.svg" /></div>
</a>
<p>To do this, the event processor sends an ENTRY_SIGNAL event to the <code class="docutils literal notranslate"><span class="pre">heating</span></code> state callback:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The ENTRY_SIGNAL is caught by an elif clause, which will turn the heater on and
tell the event processor it handled the event.</p>
<p>Next, <strong>S</strong> enters the heating state to rejoin <strong>T</strong></p>
<a class="reference external image-reference" href="_static/ToasterOven_2_6_9.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_6_9.svg" src="_images/ToasterOven_2_6_9.svg" /></div>
</a>
<p>To do this the event processor calls the <code class="docutils literal notranslate"><span class="pre">baking</span></code> callback with an ENTRY_SIGNAL event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;baking&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p><strong>S</strong> and <strong>T</strong> are now settled in the baking state, so the event processor
sends an INIT_SIGNAL to the <code class="docutils literal notranslate"><span class="pre">baking</span></code> callback to see if it needs to transition
deeper into the statechart.  There is no init handle for this state, so this
event is ignored.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is only one handled init signal in the whole design and it’s in the
door_closed state.  It will never be called because we start the statechart in
the off state.  If were where to start the statechart in the door_closed
state, this init event would be triggered, causing the statemachine to
ultimately settle into the off state.</p>
</div>
<p>Another run to completion process has been finished, so the oven thread, looks
back to it’s queue to see if any other thread posted event’s to it while it was
trying to toast something:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2_5_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_5_5.svg" src="_images/ToasterOven_2_5_5.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="is-there-a-way-i-can-get-miros-to-show-me-what-happened-and-how-it-happened"><strong>Is there a way I can get miros to show me what happened and how it happened?</strong></p>
<p>Yes, in fact there are two different ways to show you what happened and how it
happened.  If you instrument your state callbacks using the <code class="docutils literal notranslate"><span class="pre">&#64;spy_on</span></code>
decorator, you can use either the <code class="docutils literal notranslate"><span class="pre">trace</span></code> or <code class="docutils literal notranslate"><span class="pre">spy</span></code> output.</p>
<p>I will break this answer up into two parts, what you can see with either a
trace or a spy, and how you can use these tools to make sense of your own
designs.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The trace tracks movement of <strong>S</strong> through your HSM.  While the spy tracks
movements of <strong>T</strong>.  So, to remember which is which, remember that when it
comes to instrumentation there is an anti-mnemonic at play, <code class="docutils literal notranslate"><span class="pre">spy</span></code> tracks <strong>T</strong>
and the <code class="docutils literal notranslate"><span class="pre">trace</span></code> tracks <strong>S</strong>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spy</span></code> name was used in miros, because the qp framework uses the word spy
to output how the event processor is working (how it tracks T).  I wanted the
concepts to remained consistent for embedded developers who were going to port the
Python designs into qp, so I kept the spy name, even though it’s hard to
remember.</p>
<p class="last">The last time I checked there was no <code class="docutils literal notranslate"><span class="pre">trace</span></code> feature in the qp framework.</p>
</div>
<p><strong>What you can see with a trace:</strong></p>
<p>We have talked about how the statecharts starts in the off state, now let’s look
at how this was reported by the <code class="docutils literal notranslate"><span class="pre">trace</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.890583</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
</pre></div>
</div>
<p>It describes:</p>
<blockquote>
<div><ul class="simple">
<li>when the event happened,</li>
<li>in what statechart: oven</li>
<li>what event caused the transition: start_at</li>
<li>the starting state: top</li>
<li>the ending state: off.</li>
</ul>
</div></blockquote>
<p>We have also talked about how the oven transitions from off to the toasting
state.  Here is what was reported by the <code class="docutils literal notranslate"><span class="pre">trace</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.891473</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Toasting</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">toasting</span>
</pre></div>
</div>
<p>It describes:</p>
<blockquote>
<div><ul class="simple">
<li>when the event happened,</li>
<li>in what statechart: oven,</li>
<li>what event caused the transition: “Toasting”</li>
<li>the starting state: off</li>
<li>the ending state: toasting</li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">trace</span></code> is a useful tool to get a very rough understanding about what has
happened with a statechart, but consider all of the information that is missing:</p>
<blockquote>
<div><ul class="simple">
<li>It does not report on the entry triggers and init triggers.</li>
<li>It does not describe how the event processor searched your callbacks to discover how the
HSM is structured.</li>
</ul>
</div></blockquote>
<p>To see this information you can use the <code class="docutils literal notranslate"><span class="pre">spy</span></code> instrumentation.</p>
<p><strong>What you can see with the spy:</strong></p>
<p>Here is the spy output resulting from the <code class="docutils literal notranslate"><span class="pre">oven.start_at(off)</span></code> call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">START</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The spy output describes an event’s signal name and which state it is expressed in.</p>
<p>From the spy output we can monitor the event processor planning and acting
stages.  For instance in the above spy output, we can see the event processor
query the off state and door_closed state with the SEARCH_FOR_SUPER_SIGNAL
event.  This is done so that it can know how to enter the statemachine, then it
acts on this plan by entering the door_closed state, then the off state, then it
settles into the off state by sending it an INIT_SIGNAL event.</p>
<p>At the end of this RTC process, we see what is waiting in the queues for the next
run of the event processor.  We have only been talking about one queue so far, and that is the
first queue in the listing.  The Deferred queue is something you will learn
about in the patterns section.</p>
<p>Here is the spy output for the chart transitioning from the off state to the
toasting state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Toasting</span><span class="p">:</span><span class="n">off</span>
<span class="n">Toasting</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">2</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The SEARCH_FOR_SUPER_SIGNAL event lines in the spy output can be confusing to look at.  Miro
Samek’s event processing algorithm has to consider 7 different graph topologies,
so as an application developer you might know how and why these calls are taking
place.  Instead, pay attention to the other things in the output:</p>
<blockquote>
<div><ul class="simple">
<li>The off state is sent the Toasting event signal (which it doesn’t handle)</li>
<li>The door_closed state is sent the Toasting event (which causes a trans)</li>
<li>The off state is sent the EXIT_SIGNAL event</li>
<li>The heating state is sent the ENTRY_SIGNAL event</li>
<li>The toasting state is sent the ENTRY_SIGNAL event</li>
<li>The toasting state is sent the INIT_SIGNAL</li>
</ul>
</div></blockquote>
<p>Finally, we see the line describing the state of the queues.  In this case their
are two events pending in the queue, due to our code calling the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>
method with a “Baking” and “Off” event.</p>
<p>To turn on a live spy, replace the live_trace call with the live_spy call in
your code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span><span class="o">.</span><span class="n">list_spy</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-bakes"><strong>Can you explain how this statechart bakes?</strong></p>
<p>To get the statechart to bake, you just send a Bake event to it.  (you can’t
open the door and puts things into your oven yet, so there little point to
baking).</p>
<p>Now that we know how to use the trace tool, let’s look at the trace output for
this type of transition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.891989</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Baking</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">baking</span>
</pre></div>
</div>
<p>We see that the Baking event will cause the statemachine to leave toasting, and
enter the baking state.</p>
<p>For more details, we could look at the spy output for the same transition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Baking</span><span class="p">:</span><span class="n">toasting</span>  <span class="c1"># T searching for Baking event in toasting state 1</span>
<span class="n">Baking</span><span class="p">:</span><span class="n">heating</span>   <span class="c1"># T searching for Baking event in heating state  2</span>
<span class="n">Baking</span><span class="p">:</span><span class="n">door_closed</span>  <span class="c1"># T searching for Baking in door_closed       3</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">toasting</span> <span class="c1"># S in toasting, exit event sent to toasting 4</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">heating</span>  <span class="c1"># S in heating, exit even sent to heating    5</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span> <span class="c1"># event processor searching ...   6</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">baking</span>      <span class="c1">#  ...</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span> <span class="c1">#  ...</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>     <span class="c1">#  ...</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span> <span class="c1"># S in heating, entry event sent to heating  7</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">baking</span> <span class="c1"># S in baking, entry event sent to baking     8</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">baking</span> <span class="c1"># S and T settled, init event sent to baking   9</span>
</pre></div>
</div>
<a class="reference external image-reference" href="_static/ToasterOven_2_7_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2_7_1.svg" src="_images/ToasterOven_2_7_1.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="can-you-explain-how-this-statechart-turns-off"><strong>Can you explain how this statechart turns off?</strong></p>
<p>The oven can be turned off while it already is off, or when it’s baking or
toasting.  We will examine how it is turned off while it is baking.</p>
<p>As you have learned from the previous explanations, with a bit of practice, you
can just see how your statechart will react to an event.</p>
<p>To see what has happened this time, let’s turn on the <code class="docutils literal notranslate"><span class="pre">live_trace</span></code> and
<code class="docutils literal notranslate"><span class="pre">live_spy</span></code> and examine their outputs.  Here is how to turn on both types of
live instrumentation:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>
</span>  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="c1"># toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># turn the oven off</span>
<span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
</span>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>To answer this question, we will be examining the behavior caused by the
transition on line 11.  The system’s reaction line 11 will have a trace and spy
which will look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">20</span> <span class="mo">07</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mf">43.449132</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Off</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="n">Off</span><span class="p">:</span><span class="n">baking</span>
<span class="n">Off</span><span class="p">:</span><span class="n">heating</span>
<span class="n">Off</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference external image-reference" href="_static/ToasterOven_3_0.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_0.svg" src="_images/ToasterOven_3_0.svg" /></div>
</a>
<p>The trace output describes that the “Off” event caused a transition from baking
to off: <code class="docutils literal notranslate"><span class="pre">e-Off()</span> <span class="pre">baking-&gt;off</span></code>.</p>
<p>The spy output describes some of the specifics about how the baking to off
transition took place:</p>
<blockquote>
<div>In a nutshell, it received the “Off” event in the baking state, then it let
<strong>T</strong> fall outward until it reached the door_closed state, which knew what
to do with the event.  The event processor moves <strong>S</strong> through the required
exit conditions until it settles in the door_closed state.  Then it
places <strong>T</strong> in the off state, and creates a plan for how <strong>S</strong> can be with
<strong>T</strong> again.  It acts on this plan by sending an ENTRY_SIGNAL to the off
state.  Both <strong>S</strong> and <strong>T</strong> are settled in the off state, so the event
processor sends it an INIT_SIGNAL, which is not handled so it is ignored.
The RTC process is completed and the thread goes back to pending on the
queue.</div></blockquote>
<p>You have now examined all of the possible transitions of this statemachine.</p>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="why-are-you-putting-state-into-the-toasteroven-and-not-its-hsm"><strong>Why are you putting state information into the ToasterOven and not its HSM?</strong></p>
<p>You can see that we have a <code class="docutils literal notranslate"><span class="pre">light_on</span></code> and <code class="docutils literal notranslate"><span class="pre">light_off</span></code> method, and the <code class="docutils literal notranslate"><span class="pre">heater_on</span></code> and
<code class="docutils literal notranslate"><span class="pre">heater_off</span></code> method in the ToasterOven’s object:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2.svg" src="_images/ToasterOven_2.svg" /></div>
</a>
<p>If this were a real toaster oven, it’s state would occur in two different
places.  The first would be in the physical world.  The actual light would be on
or the light would be off.  The physical heater would be heating or that heater
wouldn’t be heating.  The second, would be in our software.  The HSM would be in
a state where the light/heater would either be on or off.  The code in the
ToasterOven class would contain the drivers for making the physical equipment do
what our HSM wants it to do.  So, the state would be kept in the HSM not within the
ToasterOven object.</p>
<p>This isn’t to say that you can’t track state information in your derived
ActiveObject.  There may be situations where you want to do this, it is up to
you.  For instance, if we added a bit more complexity to our design we could set
the oven’s temperature.  This could be held in an attribute of the ToasterOven.
You can think of a temperature value as being a kind of state, so, it is
possible to smear state information between your HSM and your object.</p>
<p>HSM’s are good at reacting to event’s and changing state: As a designer
using miros, you would consider the trade-offs between putting state information
in your object and into your HSM.  The goal would be to meet your specification
while minimizing your design’s complexity.  To do this well will require you to
practice.</p>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-does-your-proof-show-that-you-met-your-specification-2"><strong>How does your proof show that you met your specification?</strong></p>
<p>From this design:</p>
<a class="reference external image-reference" href="_static/ToasterOven_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_2.svg" src="_images/ToasterOven_2.svg" /></div>
</a>
<p>We preform these actions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
    <span class="c1"># toast something</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
    <span class="c1"># bake something</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
    <span class="c1"># turn the oven off</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>We see this output to our terminal, which I have called proof that the design
works:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python3</span> <span class="n">toaster_oven_2</span><span class="o">.</span><span class="n">py</span>
<span class="n">off</span>
<span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.890583</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="n">heater_on</span>
<span class="n">toasting</span>
<span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.891473</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Toasting</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">toasting</span>
<span class="n">heater_off</span>
<span class="n">heater_on</span>
<span class="n">baking</span>
<span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.891989</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Baking</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">baking</span>
<span class="n">heater_off</span>
<span class="n">off</span>
<span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">12</span> <span class="mi">13</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mf">51.892568</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Off</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">off</span>
</pre></div>
</div>
<p>The trace output happens after the statechart has reacted to an event, so all
of the print statements should happen before the trace reports on what happened.</p>
<p>We see that the oven starts in the off state, which reports an “off” to the
terminal.</p>
<p>The oven is then sent a “Toasting” event.  This causes a transition from the off
state to the toasting state. To perform this transition the oven turns the
heater on with its entry condition to the heating state.  We see this happened
because our ToasterOven’s <code class="docutils literal notranslate"><span class="pre">heater_on</span></code> driver just writes “heater_on” to the
terminal.  Then the toasting state’s entry condition prints “toasting” to the
terminal.</p>
<p>Next, we send a “Baking” event.  It exits the heating state, causing the
“heater_off” to print, then it re-enters to the heating state, which causes the
“heater_on” to print and the enters the baking state, causing it’s entry
condition to print “baking”.</p>
<p>Finally, we send the “Off” event to oven.  This causes a transition from baking
to off.  To do this it prints “heater_off” from the exit condition of the
heating state and prints “off” from the entry condition of the off state.</p>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="how-do-i-put-something-in-the-oven-and-cook-it"><strong>How do I put something in the oven and cook it?</strong></p>
<p>You can’t, we don’t even know if our customer’s want to cook anything, so we
will ship it, discover what our customers want through the customer discovery
process, then pivot if the need arises.</p>
<a class="reference internal" href="zero_to_one.html#iter1"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter2-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
</div>
<div class="section" id="iteration-3-history">
<span id="iter3"></span><h3>Iteration 3: history<a class="headerlink" href="#iteration-3-history" title="Permalink to this headline">¶</a></h3>
<p>So far, we have miros working on our system and we have build a simple toaster
oven. But, as it is currently written, the toaster oven is useless, because
there is no way to open and close the door.</p>
<p>So, in this design iteration we will add the ability to open and close the door.</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<div class="section" id="iteration-3-specification">
<span id="iter3-spec"></span><h4>Iteration 3 specification<a class="headerlink" href="#iteration-3-specification" title="Permalink to this headline">¶</a></h4>
<p>The toaster oven spec:</p>
<ul class="simple">
<li><span class="dead-spec">The toaster oven will have a door, it will always be closed</span></li>
<li>The toaster oven will have an oven light, which can be turned on and off</li>
<li>The toaster oven will have a heater, which can be turned on and off</li>
<li>It will have two different heating modes; baking and toasting</li>
<li>The toaster oven should start in the off state</li>
<li>The toaster can only heat when the door is closed</li>
<li>The toaster’s light should be off when the door is closed</li>
<li><span class="new-spec">The toaster should turn on its light when the door is opened</span></li>
<li><span class="new-spec">A customer should be able to open and close the door of our toaster oven</span></li>
<li><span class="new-spec">When a customer closes the door, the toaster oven should go back to behaving
like it did before.</span></li>
</ul>
<hr class="docutils" />
<p><strong>Technical Improvments</strong></p>
<ul class="simple">
<li><span class="new-spec">Remove the print statements from your production code.</span></li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-3-design">
<span id="iter3-design"></span><h4>Iteration 3 design<a class="headerlink" href="#iteration-3-design" title="Permalink to this headline">¶</a></h4>
<a class="reference external image-reference" href="_static/ToasterOven_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3.svg" src="_images/ToasterOven_3.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-3-code">
<span id="iter3-code"></span><h4>Iteration 3 code<a class="headerlink" href="#iteration-3-code" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"> <span class="c1"># toaster oven iteration 3</span>
</span> <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">import</span> <span class="nn">time</span>

 <span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">None</span>
</span>
   <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_on&quot;</span><span class="p">)</span>
</span>
   <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_off&quot;</span><span class="p">)</span>
</span>
   <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_on&quot;</span><span class="p">)</span>
</span>
   <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_off&quot;</span><span class="p">)</span>
</span>
 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
<span class="hll">   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">door_open</span><span class="p">)</span>
</span>   <span class="k">else</span><span class="p">:</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">oven</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;baking&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">baking</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">toasting</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;toasting&quot;</span><span class="p">)</span>
<span class="hll">     <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">toasting</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">oven</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">off</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

<span class="hll"> <span class="nd">@spy_on</span>
</span><span class="hll"> <span class="k">def</span> <span class="nf">door_open</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span><span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="n">oven</span><span class="o">.</span><span class="n">light_on</span><span class="p">()</span>
</span><span class="hll">   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span class="hll">   <span class="k">else</span><span class="p">:</span>
</span><span class="hll">     <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">   <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</td></tr></table></div>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-3-proof">
<span id="iter3-proof"></span><h4>Iteration 3 proof<a class="headerlink" href="#iteration-3-proof" title="Permalink to this headline">¶</a></h4>
<p>To prove our design works we could turn on the spy, then:</p>
<blockquote>
<div><ul class="simple">
<li>start the oven</li>
<li>open the door</li>
<li>close the door</li>
<li>bake something</li>
<li>open the door</li>
<li>close the door</li>
<li>toast something</li>
<li>open the door</li>
<li>close the door</li>
</ul>
</div></blockquote>
<p>But the spy output would be tedious for you to read, so instead, I’ll just
turn on the trace, toast something, open the door, then close the door again,
then ship the product. HeeHaw.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
<span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>

<span class="c1"># toast something</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
<span class="c1"># open the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
<span class="c1"># close the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>Here are the results:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mo">06</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">28.095880</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mo">06</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">28.098218</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Toasting</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">toasting</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mo">06</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">28.099014</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Open</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">door_open</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mo">06</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">28.099489</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Close</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">toasting</span>
</pre></div>
</div>
<p>That’s kind of hard to read too, so here is a sequence diagram expressing the same
information:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Statechart</span><span class="p">:</span> <span class="n">oven</span><span class="p">]</span>
       <span class="n">top</span>              <span class="n">off</span>           <span class="n">toasting</span>         <span class="n">door_open</span>
        <span class="o">+---</span><span class="n">start_at</span><span class="p">()</span><span class="o">--&gt;|</span>                <span class="o">|</span>                <span class="o">|</span>
        <span class="o">|</span>      <span class="p">(</span><span class="mi">1</span><span class="p">)</span>       <span class="o">|</span>                <span class="o">|</span>                <span class="o">|</span>
        <span class="o">|</span>                <span class="o">+---</span><span class="n">Toasting</span><span class="p">()</span><span class="o">--&gt;|</span>                <span class="o">|</span>
        <span class="o">|</span>                <span class="o">|</span>      <span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="o">|</span>                <span class="o">|</span>
        <span class="o">|</span>                <span class="o">|</span>                <span class="o">+---</span><span class="n">Door_Open</span><span class="p">()</span><span class="o">-&gt;|</span>
        <span class="o">|</span>                <span class="o">|</span>                <span class="o">|</span>      <span class="p">(</span><span class="mi">3</span><span class="p">)</span>       <span class="o">|</span>
        <span class="o">|</span>                <span class="o">|</span>                <span class="o">+&lt;-</span><span class="n">Door_Close</span><span class="p">()</span><span class="o">--|</span>
        <span class="o">|</span>                <span class="o">|</span>                <span class="o">|</span>      <span class="p">(</span><span class="mi">4</span><span class="p">)</span>       <span class="o">|</span>
</pre></div>
</div>
<p>1-2.  Same behavior as the previous design</p>
<ol class="arabic simple" start="3">
<li>The <code class="docutils literal notranslate"><span class="pre">door_open</span></code> state can be transitioned to.</li>
<li>While in the <code class="docutils literal notranslate"><span class="pre">door_open</span></code> state, a <code class="docutils literal notranslate"><span class="pre">Door_Close</span></code> event causes the unit to
go back into its previous state, the toasting state.</li>
</ol>
<p>As a first pass, this is looking good, but is it a proof that our system is
working.  Not even close.</p>
<p>We will get serious about <a class="reference internal" href="#iter4-proof"><span class="std std-ref">testing in the next iteration</span></a>.</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-3-questions">
<span id="iter3-questions"></span><h4>Iteration 3 questions<a class="headerlink" href="#iteration-3-questions" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#zero-to-one-can-you-show-the-proof-that-the-system-works3"><span class="std std-ref">Can you show the full proof that the system works?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-what-does-the-h-with-a-star-beside-it-mean3"><span class="std std-ref">What does the H with a star beside it mean?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-how-does-your-code-give-me-the-deep-history-feature3"><span class="std std-ref">How does your code give me the deep history feature?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-don-t-you-set-the-history-attribute-in-the-door-closed-off-and-heating-states3"><span class="std std-ref">Why don’t you set the history attribute in the door_closed and heating states?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-if-you-are-removing-unneeded-things-from-your-code-then-what-is-the-init-signal-for3"><span class="std std-ref">If you are removing unneeded things from your code, then what is the init event for?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-is-the-state-pattern-oval-put-on-the-diagram3"><span class="std std-ref">Why is the state pattern oval put on the diagram?</span></a></li>
<li><a class="reference internal" href="#bbbbbbbbbbbbbbb"><span class="std std-ref">Isn’t the Deep history icon and the call to oven history redundant?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-isn-t-the-deep-history-handled-by-the-framework3"><span class="std std-ref">Why isn’t the deep history handled by the framework?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-what-is-the-difference-between-deep-and-shallow-history3"><span class="std std-ref">What is the difference between deep and shallow history?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-can-you-map-this-history-idea-back-onto-the-story3"><span class="std std-ref">Can you map this history idea back onto the story?</span></a></li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-can-you-show-the-proof-that-the-system-works3"><strong>Can you show the full proof that the system works?</strong></p>
<p>We can turn on the <cite>spy</cite> and <cite>trace</cite> instrumentation and run the design
through all of it’s state transitions.  Then we can look at the
instrumentation’s output to see if it worked as expected.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
<span class="n">oven</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># I&#39;ll add this to interleave the trace</span>

<span class="c1"># Start the oven in the Off state</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
<span class="c1"># Open the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
<span class="c1"># Close the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
<span class="c1"># Bake something</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
<span class="c1"># Open the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
<span class="c1"># close the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
<span class="c1"># Toast something</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
<span class="c1"># Open the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
<span class="c1"># Close the door</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is the instrumentation’s live output:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.869093</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
</span><span class="n">START</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="hll"><span class="n">light_off</span>
</span><span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">off</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.873013</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Open</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">door_open</span>
</span><span class="n">Door_Open</span><span class="p">:</span><span class="n">off</span>
<span class="n">Door_Open</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="hll"><span class="n">light_on</span>
</span><span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">7</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.874019</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Close</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">off</span>
</span><span class="n">Door_Close</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="hll"><span class="n">light_off</span>
</span><span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">off</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">6</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.875289</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Baking</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">baking</span>
</span><span class="n">Baking</span><span class="p">:</span><span class="n">off</span>
<span class="n">Baking</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">heater_on</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="n">baking</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">5</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.876085</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Open</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">door_open</span>
</span><span class="n">Door_Open</span><span class="p">:</span><span class="n">baking</span>
<span class="n">Door_Open</span><span class="p">:</span><span class="n">heating</span>
<span class="n">Door_Open</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">heater_off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="hll"><span class="n">light_on</span>
</span><span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">4</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.877258</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Close</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">baking</span>
</span><span class="n">Door_Close</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="hll"><span class="n">light_off</span>
</span><span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">heater_on</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="n">baking</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">3</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.878420</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Toasting</span><span class="p">()</span> <span class="n">baking</span><span class="o">-&gt;</span><span class="n">toasting</span>
</span><span class="n">Toasting</span><span class="p">:</span><span class="n">baking</span>
<span class="n">Toasting</span><span class="p">:</span><span class="n">heating</span>
<span class="n">Toasting</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">baking</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">heater_off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">heater_on</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">toasting</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">2</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.879734</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Open</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">door_open</span>
</span><span class="n">Door_Open</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">Door_Open</span><span class="p">:</span><span class="n">heating</span>
<span class="n">Door_Open</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">heater_off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="hll"><span class="n">light_on</span>
</span><span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">1</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">31</span> <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mf">22.880552</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Door_Close</span><span class="p">()</span> <span class="n">door_open</span><span class="o">-&gt;</span><span class="n">toasting</span>
</span><span class="n">Door_Close</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">door_open</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="hll"><span class="n">light_off</span>
</span><span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">heater_on</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">toasting</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>I have highlighted the lines the show us it is working.</p>
<p>This is a reasonable spot check, but it’s not really something you would want to
leave as a regression test.</p>
<p>A better testing approach is <a class="reference internal" href="#iter4-proof"><span class="std std-ref">demonstrated in the next iteration.</span></a></p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-what-does-the-h-with-a-star-beside-it-mean3"><strong>What does the H with a star beside it mean?</strong></p>
<p>The H with a star beside it is called the <span class="xref std std-ref">deep history</span> pseudostate.  A
pseudostate is any useful glyph that touches an arrow or event on a statechart, that isn’t actually a state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3.svg" src="_images/ToasterOven_3.svg" /></div>
</a>
<p>When an arrow points to a deep history pseudostate, it means, go back to the
last activated state that was used in that region of the statechart.</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_Span.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_Span.svg" src="_images/ToasterOven_3_Span.svg" /></div>
</a>
<p>In our example this could be anyone of the <code class="docutils literal notranslate"><span class="pre">heating</span></code>, <code class="docutils literal notranslate"><span class="pre">baking</span></code>, <code class="docutils literal notranslate"><span class="pre">toasting</span></code>
or <code class="docutils literal notranslate"><span class="pre">off</span></code> states.</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_Possible_States.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_Possible_States.svg" src="_images/ToasterOven_3_Possible_States.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-how-does-your-code-give-me-the-deep-history-feature3"><strong>How does your code give me the deep history feature?</strong></p>
<p>The event processor in miros doesn’t support the deep history pattern directly.</p>
<p>To make a statechart that gives you the deep-history behaviour you can:</p>
<blockquote>
<div><ul class="simple">
<li>add a <code class="docutils literal notranslate"><span class="pre">history</span></code> attribute to your ActiveObject derived class, in this
example the ToasterOven class.</li>
<li>upon entering a state that is within a region spanned by a deep history
pseudostate, assign the state’s name to the history attribute in that
state’s entry condition.</li>
<li>when you want to transition to history, transition to the state held in the
<code class="docutils literal notranslate"><span class="pre">history</span></code> attribute: <code class="docutils literal notranslate"><span class="pre">status</span> <span class="pre">=</span> <span class="pre">oven.trans(oven.history)</span></code></li>
</ul>
</div></blockquote>
<p>If you look at the <a class="reference internal" href="#iter3-code"><span class="std std-ref">code</span></a> and compare it to the <a class="reference internal" href="#iter3-design"><span class="std std-ref">design</span></a> you will see that this is what I have done.</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-don-t-you-set-the-history-attribute-in-the-door-closed-off-and-heating-states3"><strong>Why don’t you set the history attribute in the door_closed and heating states?</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> and <code class="docutils literal notranslate"><span class="pre">heating_states</span></code> are transitory states; the toaster
oven can’t settle into either of these states.  So, the history attribute
doesn’t need to be assigned for them.</p>
<a class="reference external image-reference" href="_static/ToasterOven_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3.svg" src="_images/ToasterOven_3.svg" /></div>
</a>
<p>By making this design decision I am breaking the Harel formalism, a deep history
icon should be able to go to the <code class="docutils literal notranslate"><span class="pre">heating</span></code> state too.  I’m not going to
include it because I don’t need it, and I can’t test it anyway.</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-if-you-are-removing-unneeded-things-from-your-code-then-what-is-the-init-signal-for3"><strong>If you are removing unneeded things from your code, then what is the init event for?</strong></p>
<p>Good point, if you look at the design, you see that the statechart starts in the
<code class="docutils literal notranslate"><span class="pre">off</span></code> state: <code class="docutils literal notranslate"><span class="pre">oven.start_at(off)</span></code>.  There is no need for the init
pseudostate in the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> region, at least when looking at how the
toaster oven turns on.</p>
<p>How about after the door has been closed?  Well as discussed in the previous
answer, the unit can only transition back into the <code class="docutils literal notranslate"><span class="pre">baking</span></code>, <code class="docutils literal notranslate"><span class="pre">toasting</span></code> or
<code class="docutils literal notranslate"><span class="pre">off</span></code> states after the door is closed; we still don’t need that init pseudostate.</p>
<p>Are there any other ways we can get into the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> region?  No.  So,
this design doesn’t need the <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> init signal.</p>
<a class="reference external image-reference" href="_static/ToasterOven_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3.svg" src="_images/ToasterOven_3.svg" /></div>
</a>
<p>But if a maintenance developer were to change the <code class="docutils literal notranslate"><span class="pre">oven.start_at(off)</span></code> code to
<code class="docutils literal notranslate"><span class="pre">oven.start_at(door_closed)</span></code> our design would still work, because the init
pseudostate would cause the system to settle into the off state.</p>
<p>What would happen if the maintenance developer changed the
<code class="docutils literal notranslate"><span class="pre">oven.start_at(off)</span></code> to <code class="docutils literal notranslate"><span class="pre">oven.start_at(heating)</span></code>?  Well, this would be a
bug.  The unit would heat in an undefined way, it wouldn’t be baking or
toasting.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As a design evolves you will end up with a lot of vestigial parts.  Things
that used to be needed, but aren’t needed anymore, like an appendix, or
tonsils.</p>
</div>
<p>This illustrates two different design philosophies, we can be:</p>
<blockquote>
<div><ul class="simple">
<li>minimalist</li>
<li>or, hardened</li>
</ul>
</div></blockquote>
<p>The minimalist approach would try to reduce the design to just what it needs to
work.  The hardened approach would try and kind of future proof the design
against changes made by a maintenance developer:</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_Hardened.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_Hardened.svg" src="_images/ToasterOven_3_Hardened.svg" /></div>
</a>
<p>The above diagram describes a hardened design: all the intermediate states have
init signals and all of the states in the deep history region assign their
callback function’s address to the <code class="docutils literal notranslate"><span class="pre">oven.history</span></code> attribute in their entry conditions.</p>
<p>If we were to use the above design, we would now have a bug in our
specification: there a is no description of the default
behavior of our heating state. We could just go back and fix it, but this will
clutter our specification with unneeded complexity.  We should keep the
specifications short and legible.</p>
<p>At first glance you might be tempted to take the hardened approach; but over a
long period of time, your statecharts will have more and more unused, untested and
unneeded code within them.  You will accumulate some technical debt.</p>
<p>There is no right answer to this, but personally I lean towards keeping a design
as simple as possible, I lean towards minimalism.  If I’m conscious of a choice between
a complicated thing and a simple thing, I will pick the simple thing.</p>
<p>I’ll change the design in the next iteration so that the unit starts in the
<code class="docutils literal notranslate"><span class="pre">door_closed</span></code> state.  (I want that init event to be useful, because I’m
trying to explain how statecharts work here)</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-is-the-state-pattern-oval-put-on-the-diagram3"><strong>Why is the state pattern oval put on the diagram?</strong></p>
<a class="reference external image-reference" href="_static/ToasterOven_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3.svg" src="_images/ToasterOven_3.svg" /></div>
</a>
<p>The statechart patterns use different parts of the diagram to work together to
provide a global behavior described by that pattern.  To make it easier for
someone to understand this, the oval is put on the diagram to announce what
is going on.</p>
<p>If you don’t know what the transition to history is, you can just <a class="reference internal" href="patterns.html#patterns"><span class="std std-ref">look it
up</span></a> and understand the designer’s intention, then look and see how
that pattern applies to the specific design.</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="bbbbbbbbbbbbbbb"><strong>Isn’t the Deep history icon and the call to oven history redundant?</strong></p>
<p>When we put our other arrows on this chart we didn’t write their <code class="docutils literal notranslate"><span class="pre">trans</span></code> calls on
them.  So, yes, the call to <code class="docutils literal notranslate"><span class="pre">oven.trans(oven.history)</span></code> is kind of
redundant; the arrow to the deep history icon should be enough.  But, remember
that the deep history feature isn’t supported by this version of the statechart
algorithm; so, let’s help the person reading the page see explicitly how we are
going to make the pattern work.</p>
<p>We need the deep history icon as a clean shorthand, or we would have to draw
arrows to all of our states (Super Ugly):</p>
<a class="reference external image-reference" href="_static/ToasterOven_3_Redundant"><div align="center" class="align-center"><img alt="_images/ToasterOven_3_Redundant.svg" src="_images/ToasterOven_3_Redundant.svg" /></div>
</a>
<p>Versus (less Ugly):</p>
<a class="reference external image-reference" href="_static/ToasterOven_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3.svg" src="_images/ToasterOven_3.svg" /></div>
</a>
<p>So yes, the diagram has some redundancy in it and it is useful.</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-isn-t-the-deep-history-handled-by-the-framework3"><strong>Why isn’t the deep history handled by the framework?</strong></p>
<p>The event processor in this library is based on the work published by Miro
Samek, who is coming from an embedded background.  His algorithm is blazingly
fast and his code had a tiny memory footprint; he wanted it to work on small
processors.</p>
<p>You can use his framework instead of having a real time operating system.  It
includes it’s own event loop and software bus.  It’s really cool.</p>
<p>What it didn’t have was the high level statechart features like transition to
deep history and transition to shallow history, or orthogonal regions, but he
gave them to his audience through app-notes; “just write your code like this and
you get the same effect”.</p>
<p>I haven’t looked at his stuff lately, it wouldn’t surprise me if he has the
history features in his contemporary framework.  (embedded processors are much
more powerful now).</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-what-is-the-difference-between-deep-and-shallow-history3"><strong>What is the difference between deep and shallow history?</strong></p>
<p>Shallow history pseudostates, only cause transitions into the first level of states within
the region they span.   The shallow history icon is an H in a circle <strong>without</strong> the
star beside it.</p>
<p>If we replaced the deep history icon in this diagram with a shallow history
icon, only the <code class="docutils literal notranslate"><span class="pre">heating</span></code> and <code class="docutils literal notranslate"><span class="pre">off</span></code> states could be reached with a Door_Close
event.</p>
<a class="reference external image-reference" href="_static/ToasterOven_3.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_3.svg" src="_images/ToasterOven_3.svg" /></div>
</a>
<p>I’m sure there are applications where the shallow history icon is useful; but I
have never used one.</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-can-you-map-this-history-idea-back-onto-the-story3"><strong>Can you map this history idea back onto the story?</strong></p>
<p>Imagine that the bartender named <code class="docutils literal notranslate"><span class="pre">Door_Close</span></code> in the <code class="docutils literal notranslate"><span class="pre">door_open</span></code> bar has a
pair of binoculars hanging around his neck (with a deep history icon painted on
them as their brand).  He uses them to watch where Tara and Spike drink when
they are in any bar above the door_closed terrace, taking note of their last
location.</p>
<p>When Tara asks him for directions he whispers his answer in her ear.</p>
<p>(if you can think of a better way of adding to this story email me)</p>
<a class="reference internal" href="zero_to_one.html#iter2"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter3-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
</div>
<div class="section" id="iteration-4-hook-testing-and-hardware-abstraction">
<span id="iter4"></span><h3>Iteration 4: hook, testing and hardware abstraction<a class="headerlink" href="#iteration-4-hook-testing-and-hardware-abstraction" title="Permalink to this headline">¶</a></h3>
<p>So far we have built a very basic toaster oven using a statechart.</p>
<p>In this iteration we will change the design so that:</p>
<ul class="simple">
<li>The unit can make a buzzing sound from any state of operation.</li>
<li>We can decouple our hardware tests from our statemachine tests.</li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<div class="section" id="iteration-4-specification">
<span id="iter4-spec"></span><h4>Iteration 4 specification<a class="headerlink" href="#iteration-4-specification" title="Permalink to this headline">¶</a></h4>
<p>The toaster oven spec:</p>
<ul class="simple">
<li>The toaster oven will have an oven light, which can be turned on and off</li>
<li>The toaster oven will have a heater, which can be turned off and on</li>
<li>It will have two different heating modes; baking and toasting</li>
<li>The toaster oven should start in the off state</li>
<li>The toaster can only heat when the door is closed</li>
<li>The toaster’s light should be off when the door is closed</li>
<li>The toaster should turn on its light when the door is opened</li>
<li>A customer should be able to open and close the door of our toaster oven</li>
<li>When a customer closes the door, the toaster oven should go back to behaving
like it did before</li>
<li><span class="new-spec">While the toaster oven is in any state the customer should be able to press a
buzzer which will get the attention of anyone nearby</span></li>
</ul>
<p><strong>Technical Improvements</strong></p>
<ul class="simple">
<li><span class="new-spec">Start the toaster oven in the door_closed state</span></li>
<li><span class="new-spec">Test the statechart off of the hardware target</span></li>
<li><span class="new-spec">Test the code the controls the hardware in isolation from the statechart code</span></li>
</ul>
</div>
<div class="section" id="iteration-4-design">
<span id="iter4-design"></span><h4>Iteration 4 design<a class="headerlink" href="#iteration-4-design" title="Permalink to this headline">¶</a></h4>
<a class="reference external image-reference" href="_static/ToasterOven_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_4.svg" src="_images/ToasterOven_4.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-4-code">
<span id="iter4-code"></span><h4>Iteration 4 code<a class="headerlink" href="#iteration-4-code" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># iteration 4</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="hll"><span class="k">class</span> <span class="nc">ToasterOvenMock</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
</span><span class="hll">  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span class="hll">    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_on&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_off&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_on&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_off&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>
</span><span class="hll">  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span class="hll">    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># call to your hardware&#39;s light_on driver</span>
</span><span class="hll">    <span class="k">pass</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># call to your hardware&#39;s light_off driver</span>
</span><span class="hll">    <span class="k">pass</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># call to your hardware&#39;s heater on driver</span>
</span><span class="hll">    <span class="k">pass</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># call to your hardware&#39;s heater off driver</span>
</span><span class="hll">     <span class="k">pass</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># call to your hardware&#39;s buzzer</span>
</span><span class="hll">    <span class="k">pass</span>
</span>
<span class="hll"><span class="nd">@spy_on</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">common_features</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">buzz</span><span class="p">()</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span>
<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">door_open</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">common_features</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">baking</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">toasting</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">toasting</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">off</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_open</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_on</span><span class="p">()</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">common_features</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-4-proof">
<span id="iter4-proof"></span><h4>Iteration 4 proof<a class="headerlink" href="#iteration-4-proof" title="Permalink to this headline">¶</a></h4>
<p>To satisfy our modularity requirement, we create a new class called
ToasterOvenMock.  The word <cite>mock</cite> is a common word in software testing, it
describes any piece of code that can stand in for another more complicated piece
of code. You would use a software mock to test one part of the system in
isolation from another part of the system.</p>
<a class="reference external image-reference" href="_static/ToasterOven_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_4.svg" src="_images/ToasterOven_4.svg" /></div>
</a>
<p>To separate the code that controls the hardware from the code that manages the
feature-state of the product, we create a new class called ToasterOvenMock.  It
will have the exact same API as the real ToasterOven class, but its methods
won’t make hardware calls that turn on and off lights/heaters and make buzzing sounds,
instead they will drop debug-strings into the spy instrumentation stream using
the <code class="docutils literal notranslate"><span class="pre">scribble</span></code> method.</p>
<p>To test our actual hardware features, we would instantiate the ToasterOven class
on our hardware and call the <code class="docutils literal notranslate"><span class="pre">buzz</span></code>, <code class="docutils literal notranslate"><span class="pre">heater_on</span></code>, <code class="docutils literal notranslate"><span class="pre">heater_off</span></code>,
<code class="docutils literal notranslate"><span class="pre">light_on</span></code> and <code class="docutils literal notranslate"><span class="pre">light_off</span></code> methods and see if they work as advertised. (I
won’t show how to do this)</p>
<p>To test the statemachine, we would use the ToasterOvenMock class, because all of
it’s hardware dependent calls have been mocked.  That makes the code portable,
so it can be tested anywhere Python can run.</p>
<p>We want to confirm that the code works like we have drawn it on our diagram.  We
don’t need to test the event processor because we trust that it is working, and
we trust the formal set of behaviors that it follows.  This let’s us simplify
things a lot.</p>
<p>Here is a regression test for this design:</p>
<div class="highlight-python notranslate" id="iter4-proof-code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">stripped</span>

<span class="c1"># test helper functions</span>
<span class="k">def</span> <span class="nf">trace_through_all_states</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">spy_on_light_on</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door to turn on the light</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_light_off</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_heater_on</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_heater_off</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">clear_spy</span><span class="p">()</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_buzz</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># Send the buzz event</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="c1"># Tests start here</span>
<span class="c1"># Confirm our state transitions work as designed</span>
<span class="n">trace_target</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[2019-02-04 06:37:04.538413] [oven] e-&gt;start_at() top-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540290] [oven] e-&gt;Door_Open() off-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.540534] [oven] e-&gt;Door_Close() door_open-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540825] [oven] e-&gt;Baking() off-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541109] [oven] e-&gt;Door_Open() baking-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.541393] [oven] e-&gt;Door_Close() door_open-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541751] [oven] e-&gt;Toasting() baking-&gt;toasting</span>
<span class="s2">[2019-02-04 06:37:04.542083] [oven] e-&gt;Door_Open() toasting-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.542346] [oven] e-&gt;Door_Close() door_open-&gt;toasting</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="n">stripped</span><span class="p">(</span><span class="n">trace_target</span><span class="p">)</span> <span class="k">as</span> <span class="n">stripped_target</span><span class="p">,</span> \
     <span class="n">stripped</span><span class="p">(</span><span class="n">trace_through_all_states</span><span class="p">())</span> <span class="k">as</span> <span class="n">stripped_trace_result</span><span class="p">:</span>

  <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stripped_target</span><span class="p">,</span> <span class="n">stripped_trace_result</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>

<span class="c1"># Confirm our light turns off</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">spy_on_light_off</span><span class="p">())</span>

<span class="c1"># Confirm our light turns on</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">spy_on_light_on</span><span class="p">())</span>

<span class="c1"># Confirm the heater turns on</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;heater_on&#39;</span><span class="p">,</span> <span class="n">spy_on_heater_on</span><span class="p">())</span>

<span class="c1"># Confirm the heater turns on</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;heater_off&#39;</span><span class="p">,</span> <span class="n">spy_on_heater_off</span><span class="p">())</span>

<span class="c1"># Confirm our buzzer works</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;buzz&#39;</span><span class="p">,</span> <span class="n">spy_on_buzz</span><span class="p">())</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-4-questions">
<span id="iter4-questions"></span><h4>Iteration 4 questions<a class="headerlink" href="#iteration-4-questions" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#zero-to-one-can-you-explain-how-the-unit-can-buzz-from-any-state4"><span class="std std-ref">Can you explain how the unit can buzz from any state?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-can-you-relate-the-buzz-hook-to-the-story4"><span class="std std-ref">Can you relate the buzz hook to the story?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-the-buzz-seems-like-a-pointless-feature-what-s-going-on4"><span class="std std-ref">The buzz seems like a pointless feature, what’s going on?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-are-entry-and-exit-events-hooks-too4"><span class="std std-ref">Are entry and exit events hooks too?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-are-you-showing-two-classes-on-the-diagram4"><span class="std std-ref">Why are you showing two classes on the diagram?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-what-is-a-hardware-abstraction-layer4"><span class="std std-ref">What is a hardware abstraction layer?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-where-is-the-hardware-abstraction-layer-you-listed-in-your-title4"><span class="std std-ref">Where is the hardware abstraction you listed in your title?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-in-your-tests-why-do-you-break-transition-tests-apart-from-calls-to-light-on-light-off-and-so-on4"><span class="std std-ref">Why do you break the transition-tests apart from the other tests?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-don-t-you-just-copy-out-your-spy-output-and-use-it-as-the-test-target4"><span class="std std-ref">Why don’t you just copy out your spy output and use it as the test target?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-where-did-you-get-your-trace-test-target-and-what-is-going-on-with-that-stripped-call4"><span class="std std-ref">Where did you get your trace-test-target, and what is going on with that stripped call?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-don-t-you-just-copy-out-your-trace-output-and-use-it-as-a-test-target4"><span class="std std-ref">Why don’t you just copy out your trace output and use it as a test target?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-your-light-on-light-off-tests-seem-pretty-light-are-you-sure-you-are-testing-these-features4"><span class="std std-ref">Your light_on, light_off … tests seem pretty light, are you sure you are testing these features?</span></a></li>
</ul>
<p id="zero-to-one-can-you-explain-how-the-unit-can-buzz-from-any-state4"><strong>Can you explain how the unit can buzz from any state?</strong></p>
<p>Let’s send some Buzz events to our statechart and see how it behaves:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>

<span class="c1"># start our oven</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># let the oven thread catch up to main</span>

<span class="c1"># What state?</span>
<span class="k">print</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>

<span class="c1"># Trigger the buzzer</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># What state?</span>
<span class="k">print</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>

<span class="c1"># Toast something</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># What state?</span>
<span class="k">print</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>

<span class="c1"># Trigger the buzzer</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># What state?</span>
<span class="k">print</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">off</span>
<span class="n">buzz</span>
<span class="n">off</span>
<span class="n">toasting</span>
<span class="n">buzz</span>
<span class="n">toasting</span>
</pre></div>
</div>
<p>The statechart reacts to the <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event without changing state.</p>
<a class="reference external image-reference" href="_static/ToasterOven_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_4.svg" src="_images/ToasterOven_4.svg" /></div>
</a>
<p>The buzz code is being hooked by the <code class="docutils literal notranslate"><span class="pre">common_features</span></code> state, you can see this
by looking at the top left corner of its rectangle in the diagram:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># short hand for what we see in the</span>
<span class="n">Buzz</span> <span class="o">/</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">buzz</span><span class="p">()</span>
</pre></div>
</div>
<p>To see how the code in the picture is manifested in our actual code, look at the
<code class="docutils literal notranslate"><span class="pre">common_features</span></code> callback function that represents this state:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Legend for mapping code onto diagram:</span>
<span class="c1"># s: draw as shorthand on your diagram</span>
<span class="c1"># f: completely write as code on your diagram</span>
<span class="c1"># g: drawn as a graph element on your diagram</span>
<span class="c1"># !: don&#39;t draw this code on your diagram</span>

<span class="nd">@spy_on</span>                             <span class="c1"># !</span>
<span class="k">def</span> <span class="nf">common_features</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>       <span class="c1"># g</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>  <span class="c1"># !</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">):</span>     <span class="c1"># s</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>                   <span class="c1"># f</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">buzz</span><span class="p">()</span>                     <span class="c1"># f</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>  <span class="c1"># !</span>
</span>  <span class="k">else</span><span class="p">:</span>                             <span class="c1"># !</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>        <span class="c1"># g</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>    <span class="c1"># !</span>
<span class="hll">  <span class="k">return</span> <span class="n">status</span>                     <span class="c1"># !</span>
</span></pre></div>
</td></tr></table></div>
<p>We see that when the <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event is reacted to by this function (10), it
prints <code class="docutils literal notranslate"><span class="pre">buzz</span></code> (11) then calls the <code class="docutils literal notranslate"><span class="pre">oven.buzz()</span></code> code of it’s derived
class (12), then returns <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code> (13,17).</p>
<p>When the event processor receives a <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code> it knows it can
stop searching, leaving its source state as it was.   Upon completing its search
the event processor relinquishes control back to its thread, which in turn goes
back to pending on its input queue.</p>
<p>But how did the event processor call the <code class="docutils literal notranslate"><span class="pre">common_features</span></code> callback in the
first place?</p>
<p>I’ll answer this by first imagining that our oven has settled in the
<code class="docutils literal notranslate"><span class="pre">toasting</span></code> state when it receives a <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event:</p>
<a class="reference external image-reference" href="_static/ToasterOven_4_Hook.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_4_Hook.svg" src="_images/ToasterOven_4_Hook.svg" /></div>
</a>
<ol class="arabic">
<li><p class="first">The source state <strong>S</strong> and target state <strong>T</strong> are both set to the
<code class="docutils literal notranslate"><span class="pre">toasting</span></code> state before the reaction.  Then the statechart receives the
<code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event from the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> call.</p>
<p>The event processor begins its reaction to the <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event by sending the
callback pointed to by <strong>T</strong> two arguments, a reference to the ToasterOven
object which is called <code class="docutils literal notranslate"><span class="pre">oven</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> set to <code class="docutils literal notranslate"><span class="pre">Event(signal=signals.Buzz)</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">toaster</span></code> callback’s if-elif logical structure doesn’t handle a
<code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event so it passes control to its <code class="docutils literal notranslate"><span class="pre">else</span></code> clause.  The <code class="docutils literal notranslate"><span class="pre">else</span></code>
clause updates the <strong>T</strong> to the parent state of the <code class="docutils literal notranslate"><span class="pre">toasting</span></code> state:
<code class="docutils literal notranslate"><span class="pre">heating</span></code>.  The <code class="docutils literal notranslate"><span class="pre">toasting</span></code> callback returns <code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code>,
telling the event processor that the event was not handled.  The event
processor continues searching.</p>
</li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">toasting</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">toasting</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>  <span class="c1"># T is now set to heating</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<ol class="arabic" start="2">
<li><p class="first">The source state <strong>S</strong> is <code class="docutils literal notranslate"><span class="pre">toasting</span></code> and the target state <strong>T</strong> is <code class="docutils literal notranslate"><span class="pre">heating</span></code>.</p>
<p>The event processor sends the callback pointed to by <strong>T</strong> two arguments, a
reference to the ToasterOven object which is called <code class="docutils literal notranslate"><span class="pre">oven</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> set to
<code class="docutils literal notranslate"><span class="pre">Event(signal=signals.Buzz)</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">heating</span></code> callback’s <code class="docutils literal notranslate"><span class="pre">if-elif</span></code> logical structure doesn’t handle a
<code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event so it passes control to its <code class="docutils literal notranslate"><span class="pre">else</span></code> clause.  The <code class="docutils literal notranslate"><span class="pre">else</span></code>
clause updates the <strong>T</strong> to the parent state of the <code class="docutils literal notranslate"><span class="pre">heating</span></code> state:
<code class="docutils literal notranslate"><span class="pre">door_closed</span></code>.  The <code class="docutils literal notranslate"><span class="pre">heating</span></code> callback returns <code class="docutils literal notranslate"><span class="pre">return_status.SUPER</span></code>,
telling the event processor that the event was not handled.  The event
processor continues searching.</p>
</li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>  <span class="c1"># T is not set to door_closed</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<ol class="arabic" start="3">
<li><p class="first">The source state <strong>S</strong> is <code class="docutils literal notranslate"><span class="pre">toasting</span></code> and the target state <strong>T</strong> is
<code class="docutils literal notranslate"><span class="pre">door_closed</span></code>.</p>
<p><strong>T</strong> doesn’t handle <code class="docutils literal notranslate"><span class="pre">Buzz</span></code>, <strong>T</strong> is set to <code class="docutils literal notranslate"><span class="pre">common_features</span></code> in the
<code class="docutils literal notranslate"><span class="pre">else</span></code> clause. (same logic as above).  The <code class="docutils literal notranslate"><span class="pre">door_closed</span></code> callback returns
return_status.SUPER, telling the event processor that the event was not
handled. The event processor continues searching.</p>
</li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">door_open</span><span class="p">)</span>
<span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">common_features</span>  <span class="c1"># T set to common_features</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span>  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>The source state <strong>S</strong> is <code class="docutils literal notranslate"><span class="pre">toasting</span></code> and the target state <strong>T</strong> is <code class="docutils literal notranslate"><span class="pre">common_features</span></code>.</li>
</ol>
<blockquote>
<div><p>The event processor sends the callback pointed to by <strong>T</strong> two arguments, a
reference to the ToasterOven object which is called <code class="docutils literal notranslate"><span class="pre">oven</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> set to
<code class="docutils literal notranslate"><span class="pre">Event(signal=signals.Buzz)</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">common_features</span></code> callback’s <code class="docutils literal notranslate"><span class="pre">if-elif</span></code> logical structure handles
a <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event.  It prints “buzz” then calls the <code class="docutils literal notranslate"><span class="pre">buzz</span></code> method of the
oven object, then returns <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>.</p>
<p>The event processor knows its search is complete.</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">common_features</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">buzz</span><span class="p">()</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><strong>T</strong> snaps back to <strong>S</strong>, <code class="docutils literal notranslate"><span class="pre">toasting</span></code>, the event processor stops searching
and the RTC process is finished.</li>
</ol>
<p>Because the <code class="docutils literal notranslate"><span class="pre">common_features</span></code> state encloses all of the other states (all
<code class="docutils literal notranslate"><span class="pre">else</span></code> clauses lead to it), it can hook any <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event from any state.</p>
<p>This is an example of <strong>behavioral inheritance</strong>.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-can-you-relate-the-buzz-hook-to-the-story4"><strong>Can you relate the buzz hook to the story?</strong></p>
<p><strong>T</strong> represents Tara, the explorer spirit, in our story.</p>
<div class="story">

<p><span class="story-intro">While Tara and Spike</span> were spending time together on an
upper terrace, someone from our world, put a "Buzz" event into their
universe's portal.
</p>

<p>
Theo, the god of their underworld (the statechart's thread), immediately notices
this and pulls the event out of his side of the portal. He casts his gaze up
into the sky to see Eve, the goddess of heaven (event processor). Eve awakens
and takes the event from Theo. She looks down on the earth until she sees Spike,
and beside him Tara.
</p>

<p>
Eve flies done to Tara and gives her the event. Eve says, "Tara, I want you
to go to the terrace where there is a bartender who knows what to do with
this event.  Then I want you to go to wherever he tells you to take it. Good
luck Tara, I believe in you."
</p>

<p>
Tara, upon seeing that there was no bartender named Buzz on her current
terrace, descends outward and downwards in the bar system.  She does this
until she is at the lowest bar on the earth, the common_feature.  There she
see's that there is a bartender named Buzz. she approaches him and asks if he
knows what to do with the event.   He says, "give me the event, I'll handle it,
don't worry about it anymore".
</p>

<p>
What Tara and the gods don't know is that Buzz is a member of a subversive
society called hack-the-humans.  He has some secret code which he will run
when he is activated by Tara's event and awakened from nonexistence by Theo's
attention.
</p>

<p>
He carefully pulls his code out of his jacket pocket so nobody can see what
he is doing, especially Eve, who he considers to be the worst kind of boss --
a micromanager. He runs "print("oven"); oven.buzz()", smiles, then destroys
the event.
</p>

<p>
Meanwhile, Tara has gone back up the terrace system to rejoin Spike.  He asks
her what happened (even though he knows already) and she tells him that the
bartender handled the event, to which he yells out "hook!" and is happy,
because he doesn't have to move.  Instead he orders another drink.
</p>

<p>
Theo, the solipsist, sees that the work is done.  He pulls his gaze from his
universe, freezing it into non-existence, and puts all of his attention back
onto the portal connecting him with you and me.
</p>
</div><a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-the-buzz-seems-like-a-pointless-feature-what-s-going-on4"><strong>The buzz seems like a pointless feature, what’s going on?</strong></p>
<p>In the next iteration we will tie the buzz event to a timer.  In this iteration
I’m trying to focus on hooks in isolation to make them easier to understand.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-are-entry-and-exit-events-hooks-too4"><strong>Are entry and exit events hooks too?</strong></p>
<p>I can see why you asked this.  It looks like they are, doesn’t it?</p>
<p>We can see this in the <code class="docutils literal notranslate"><span class="pre">heating</span></code> callback, which uses both an ENTRY_SIGNAL and
an EXIT_SIGNAL:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span>    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
</span>    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
<span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</td></tr></table></div>
<p>We see that the <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code> is caught by the if statement on line 4 and the
status is set to <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>.  Likewise the <code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code> is
caught by line 7 and the status is set to <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code> on line 9.</p>
<p>And this looks the same as our hook in the <code class="docutils literal notranslate"><span class="pre">common_features</span></code> callback:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">common_features</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">):</span>
</span>    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">buzz</span><span class="p">()</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>So are the entry and exit events hooks?</p>
<p>No, they aren’t.  If you don’t include the <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code> or <code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code>
catches in the <code class="docutils literal notranslate"><span class="pre">if-elif</span></code> logical structure of your callback, the entry and
exit events will not propagate outward to be handled by some super state;
instead, these events will just be ignored.</p>
<p>If this weren’t the case, you would have to include the <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code>,
<code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code>, not to mention the <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> in every single callback in
your design.  That would be annoying.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-are-you-showing-two-classes-on-the-diagram4"><strong>Why are you showing two classes on the diagram?</strong></p>
<p>There are two classes on the diagram to show how we can test our design.</p>
<p>We would like to test the code that is specific for the hardware, on that
hardware and we would like to be able to test the statechart’s statemachine
anywhere where Python can run.</p>
<a class="reference external image-reference" href="_static/ToasterOven_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_4.svg" src="_images/ToasterOven_4.svg" /></div>
</a>
<p>The ToasterOvenMock class is used to confirm that our statechart is working, and
it can be run anywhere where Python can run, you can see the test code that
confirms our design is working <a class="reference internal" href="#iter4-proof-code"><span class="std std-ref">here</span></a>.</p>
<p>The ToasterOven object would run on the computer inside of our toaster oven.
The <code class="docutils literal notranslate"><span class="pre">buzz</span></code>, <code class="docutils literal notranslate"><span class="pre">light_on</span></code>, <code class="docutils literal notranslate"><span class="pre">light_off</span></code>, <code class="docutils literal notranslate"><span class="pre">heater_on</span></code> and <code class="docutils literal notranslate"><span class="pre">heater_off</span></code>
methods of this ToasterOven object would call out to hardware abstraction layer.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-what-is-a-hardware-abstraction-layer4"><strong>What is a hardware abstraction layer?</strong></p>
<p>The hardware abstraction layer (HAL) is code that separates your software from
the hardware it runs on.</p>
<p>If we were building a real toaster oven, the code would run on a processor
inside of the toaster oven.  If you were making a toaster oven using the
Raspberry Pi 3, this processor would be a quad-core ARM Cortext-A53 CPU.  Any
code running inside of a CPU that is shipped with the product, is called
embedded code, because it’s embedded in the processor which is embedded in a
product.</p>
<p>Typically embedded projects, put a layer of software between the code that
provides the features that their customer’s want from the code that is needed to
drive the CPU to do what it needs. This software acts as a buttress against the
hardware. It doesn’t take a lot of effort to build, and it acts as cheap
insurance for your company. But why would you want to protect your software from
your CPU?  It’s not the CPU you have to worry about, it’s the price of the CPU
that you have to worry about.</p>
<p>Suppose that Larry Ellison, the guy currently <a class="reference external" href="https://en.wikipedia.org/wiki/Extortion">shaking down</a> the Java ecosystem, finds out that a
lot of products have been built using the Raspberry Pi.  He discovers companies
like using the Raspberry Pi, because it is cheap, has a nice stable version of
Linux and is easy to use.  Smelling an opportunity, he buys up the Raspberry Pi
foundation and immediately cranks up the price of the part from $35 to $500.</p>
<p>If we wrote our embedded code using a hardware abstraction layer, we could
quickly port our code over to the BeagleBoard-X15, which has an ARM Cortext-At15
CPU and is also $35.  Sure, it would cost us a bit of money to switch our
hardware and re-write the hardware drivers and part of the HAL, but we would
rather do that than lose $465 per unit.</p>
<a class="reference external image-reference" href="_static/HAL.pdf"><div align="center" class="align-center"><img alt="_images/HAL.svg" src="_images/HAL.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-where-is-the-hardware-abstraction-layer-you-listed-in-your-title4"><strong>Where is the hardware abstraction you listed in your title?</strong></p>
<p>In our design we present two different classes and an HSM.</p>
<a class="reference external image-reference" href="_static/ToasterOven_4.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_4.svg" src="_images/ToasterOven_4.svg" /></div>
</a>
<p>The purpose of the ToasterOvenMock class is to give us the ability to watch how
our statemachine would call out to the HAL as it reacts to different events.</p>
<a class="reference external image-reference" href="_static/ToasterOven_4_With_HAL.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_4_With_HAL.svg" src="_images/ToasterOven_4_With_HAL.svg" /></div>
</a>
<p>The ToasterOvenMock object calls out to the <code class="docutils literal notranslate"><span class="pre">spy</span></code> instrumentation, which acts
as a fake HAL. This fake HAL can be queried by our test code, to see if a call
to the hardware was made when we needed it to be made.</p>
<p>The ToasterOvenMock object can be tested on your development machine, or on a
continual integration server.  Once its statemachine has been proven to work,
you can confidently attach it to the ToasterOven object running on the computer
embedded in your product.</p>
<p>So, the hardware abstraction described in the title of this iteration, is
provided by the ToasterOvenMock and the code used to test it.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-in-your-tests-why-do-you-break-transition-tests-apart-from-calls-to-light-on-light-off-and-so-on4"><strong>Why do you break the transition-tests apart from the other tests?</strong></p>
<p>The transition-tests confirm that we can transition between all of the different parts of the state machine:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">stripped</span>

<span class="c1"># test helper functions</span>
<span class="k">def</span> <span class="nf">trace_through_all_states</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>

<span class="c1"># Confirm our state transitions work as designed</span>
<span class="n">trace_target</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[2019-02-04 06:37:04.538413] [oven] e-&gt;start_at() top-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540290] [oven] e-&gt;Door_Open() off-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.540534] [oven] e-&gt;Door_Close() door_open-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540825] [oven] e-&gt;Baking() off-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541109] [oven] e-&gt;Door_Open() baking-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.541393] [oven] e-&gt;Door_Close() door_open-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541751] [oven] e-&gt;Toasting() baking-&gt;toasting</span>
<span class="s2">[2019-02-04 06:37:04.542083] [oven] e-&gt;Door_Open() toasting-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.542346] [oven] e-&gt;Door_Close() door_open-&gt;toasting</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="n">stripped</span><span class="p">(</span><span class="n">trace_target</span><span class="p">)</span> <span class="k">as</span> <span class="n">stripped_target</span><span class="p">,</span> \
     <span class="n">stripped</span><span class="p">(</span><span class="n">trace_through_all_states</span><span class="p">())</span> <span class="k">as</span> <span class="n">stripped_trace_result</span><span class="p">:</span>

  <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stripped_target</span><span class="p">,</span> <span class="n">stripped_trace_result</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>They test the statemachine’s graphical structure, using the <code class="docutils literal notranslate"><span class="pre">trace</span></code>
instrumentation.</p>
<p>They don’t test the statemachine’s hooks or the use of the ToasterOven’s methods.</p>
<p>The are pulled out from the other tests, that use the <code class="docutils literal notranslate"><span class="pre">spy</span></code> instrumentation to
keep the test code organized into two different ways of thinking:</p>
<ol class="arabic simple">
<li>Is the graph working?</li>
<li>Is the statechart making the correct calls to the ToasterOven class when they
need to be made?</li>
</ol>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-don-t-you-just-copy-out-your-spy-output-and-use-it-as-the-test-target4"><strong>Why don’t you just copy out your spy output and use it as the test target?</strong></p>
<p>You could do this, but then your tests would be testing the event processor too.
I’m trying to show how you can test your code so that it is just coupled to your
design and not to the design of the miros library.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-where-did-you-get-your-trace-test-target-and-what-is-going-on-with-that-stripped-call4"><strong>Where did you get your trace-test-target, and what is going on with that stripped call?</strong></p>
<p>I got the trace-test-target by running a live trace on the code. I visually
inspected it and convinced myself that it was working.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">stripped</span></code> context manager pulls the time stamp off the front of the trace
strings.  Once you get rid of the timestamps you can compare a new trace output
against and old trace output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">stripped</span>

<span class="c1"># test helper functions</span>
<span class="k">def</span> <span class="nf">trace_through_all_states</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>

<span class="c1"># Confirm our state transitions work as designed</span>
<span class="n">trace_target</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[2019-02-04 06:37:04.538413] [oven] e-&gt;start_at() top-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540290] [oven] e-&gt;Door_Open() off-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.540534] [oven] e-&gt;Door_Close() door_open-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540825] [oven] e-&gt;Baking() off-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541109] [oven] e-&gt;Door_Open() baking-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.541393] [oven] e-&gt;Door_Close() door_open-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541751] [oven] e-&gt;Toasting() baking-&gt;toasting</span>
<span class="s2">[2019-02-04 06:37:04.542083] [oven] e-&gt;Door_Open() toasting-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.542346] [oven] e-&gt;Door_Close() door_open-&gt;toasting</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="n">stripped</span><span class="p">(</span><span class="n">trace_target</span><span class="p">)</span> <span class="k">as</span> <span class="n">stripped_target</span><span class="p">,</span> \
     <span class="n">stripped</span><span class="p">(</span><span class="n">trace_through_all_states</span><span class="p">())</span> <span class="k">as</span> <span class="n">stripped_trace_result</span><span class="p">:</span>

  <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stripped_target</span><span class="p">,</span> <span class="n">stripped_trace_result</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-don-t-you-just-copy-out-your-trace-output-and-use-it-as-a-test-target4"><strong>Why don’t you just copy out your trace output and use it as a test target?</strong></p>
<p>The timestamps wouldn’t match, so your tests would always fail.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-your-light-on-light-off-tests-seem-pretty-light-are-you-sure-you-are-testing-these-features4"><strong>Your light_on, light_off … tests seem pretty light, are you sure you are testing these features?</strong></p>
<p>Let’s break down one of these tests, while looking at the toaster oven design:</p>
<a class="reference external image-reference" href="_static/ToasterOven.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven.svg" src="_images/ToasterOven.svg" /></div>
</a>
<p>Suppose we want to test that the heater will turn on when we toast or bake
something.  Let’s toast something, and run a test:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># make an oven and put it into a heating state</span>
<span class="k">def</span> <span class="nf">spy_on_heater_on</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="c1"># Confirm the heater turns on in a heating state</span>
<span class="hll"><span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;heater_on&#39;</span><span class="p">,</span> <span class="n">spy_on_heater_on</span><span class="p">())</span>
</span></pre></div>
</td></tr></table></div>
<p>The highlighted code matches the <code class="docutils literal notranslate"><span class="pre">heater_on</span></code> string against the output of the
<code class="docutils literal notranslate"><span class="pre">spy_on_heater_on</span></code> test helper.  If this helper function weren’t a part of the
<code class="docutils literal notranslate"><span class="pre">assert</span></code> statement, it would have outputted this string:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">START</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">common_features</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">common_features</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">light_off</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">Toasting</span><span class="p">:</span><span class="n">off</span>
<span class="n">Toasting</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">off</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">door_closed</span>
<span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">heating</span>
<span class="hll"><span class="n">heater_on</span>
</span><span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">toasting</span>
<span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>So our test code: <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">re.search(r'heater_on',</span> <span class="pre">spy_on_heater_on())</span></code>, just
searches through a bunch of lines from our spy instrumentation and returns
<code class="docutils literal notranslate"><span class="pre">True</span></code> if it sees, <code class="docutils literal notranslate"><span class="pre">heater_on</span></code>, which it does, so the test passes.</p>
<p>Should we now start our test again and send our statechart a <cite>Bake`</cite> event?  No,
that would be a waste of time.  We tested that our transitions worked, so the
graph is correct: Bake is inside of Heating.  We tested that the entry condition
of the heating state calls out to our <code class="docutils literal notranslate"><span class="pre">heater_on()</span></code> code in the ToasterOvenMock, the
formalism of the Harel statecharts says if it happens for one thing inside of a
state, it will happen for all things inside that state.</p>
<p>We are done testing this thing.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">light_on</span></code>, <code class="docutils literal notranslate"><span class="pre">light_off</span></code>, <code class="docutils literal notranslate"><span class="pre">heater_off</span></code> and <code class="docutils literal notranslate"><span class="pre">buzz</span></code> tests follow a very similar pattern.</p>
<p>It is important to note that statecharts pack a lot of feature complexity into a
very small amount of code.  If you over-test your statecharts, your test code
will quickly balloon in size.  So use the statechart formalism to keep your test
suites under control.</p>
<a class="reference internal" href="zero_to_one.html#iter3"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter4-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
</div>
<div class="section" id="iteration-5-time-and-one-shots">
<span id="iter5"></span><h3>Iteration 5: time and one-shots<a class="headerlink" href="#iteration-5-time-and-one-shots" title="Permalink to this headline">¶</a></h3>
<p>Now we have two different software artifacts, the production code from which we
can make our toaster oven and some test code we can use to verify its
state machine.</p>
<p>In this iteration let’s add the dimension of time.  Let’s have the buzzer sound
20 seconds after a Baking event and 10 seconds after a Toasting event.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<div class="section" id="iteration-5-specification">
<span id="iter5-spec"></span><h4>Iteration 5 specification<a class="headerlink" href="#iteration-5-specification" title="Permalink to this headline">¶</a></h4>
<p>The toaster oven spec:</p>
<ul class="simple">
<li>The toaster oven will have an oven light, which can be turned on and off</li>
<li>The toaster oven will have a heater, which can be turned on and off</li>
<li>It will have two different heating modes, baking which can bake a potato
and toasting which can toast some bread</li>
<li>The toaster oven should start in the off state</li>
<li>The toaster can only heat when the door is closed</li>
<li>The toaster’s light should be off when the door is closed</li>
<li>The toaster should turn on its light when the door is opened</li>
<li>A customer should be able to open and close the door of our toaster oven</li>
<li>When a customer closes the door, the toaster oven should go back to behaving
like it did before</li>
<li><span class="dead-spec">While the toaster oven is in any state the customer should be able to press a
buzzer which will get the attention of anyone nearby.</span></li>
<li><span class="new-spec">The buzzer will sound 20 seconds after a Baking event</span></li>
<li><span class="new-spec">The buzzer will sound 10 seconds after a Toasting event</span></li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-5-design">
<span id="iter5-design"></span><h4>Iteration 5 design<a class="headerlink" href="#iteration-5-design" title="Permalink to this headline">¶</a></h4>
<a class="reference external image-reference" href="_static/ToasterOven_5.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_5.svg" src="_images/ToasterOven_5.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-5-code">
<span id="iter5-code"></span><h4>Iteration 5 code<a class="headerlink" href="#iteration-5-code" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>

<span class="hll">  <span class="n">TOAST_TIME_IN_SEC</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class="hll">  <span class="n">BAKE_TIME_IN_SEC</span> <span class="o">=</span> <span class="mi">20</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="hll">    <span class="k">if</span> <span class="n">toast_time_in_sec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">      <span class="n">toast_time_in_sec</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="o">.</span><span class="n">TOAST_TIME_IN_SEC</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">bake_time_in_sec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">      <span class="n">bake_time_in_sec</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="o">.</span><span class="n">BAKE_TIME_IN_SEC</span>
</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">toast_time_in_sec</span> <span class="o">=</span> <span class="n">toast_time_in_sec</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">bake_time_in_sec</span> <span class="o">=</span> <span class="n">bake_time_in_sec</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s light_on driver</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s light_off driver</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s heater on driver</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s heater off driver</span>
     <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s buzzer</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ToasterOvenMock</span><span class="p">(</span><span class="n">ToasterOven</span><span class="p">):</span>
<span class="hll">  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="hll">    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">toast_time_in_sec</span><span class="p">,</span> <span class="n">bake_time_in_sec</span><span class="p">)</span>
</span>
<span class="hll">  <span class="nd">@staticmethod</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">prepend_trace_timestamp</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
</span><span class="hll">    <span class="sd">&#39;&#39;&#39;Prepend the trace-style timestamp in front of a string</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Args**:</span>
</span><span class="hll"><span class="sd">       | ``string`` (str): a string you would like timestamped</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Returns**:</span>
</span><span class="hll"><span class="sd">       (string): datetime stamp prepended to input string</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Example(s)**:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    .. code-block:: python</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">      ToasterOven.prepend_trace_timestamp(&quot;example&quot;)</span>
</span><span class="hll"><span class="sd">      # =&gt; [2019-02-04 06:37:04.542346] example</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="hll">    <span class="k">return</span> <span class="s2">&quot;[{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">string</span><span class="p">)</span>
</span>
<span class="hll">  <span class="nd">@staticmethod</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">):</span>
</span><span class="hll">    <span class="sd">&#39;&#39;&#39;Get the 100ms part of a timestamp provided in the trace style</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Args**:</span>
</span><span class="hll"><span class="sd">       | ``timestamp_string`` (str): string with prepended timestamp</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Returns**:</span>
</span><span class="hll"><span class="sd">       | (string): The first three digits after the seconds decimal point</span>
</span><span class="hll"><span class="sd">       | (None): If no match</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Example(s)**:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    .. code-block:: python</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">      get_my_ms =  &quot;[2019-02-04 06:37:04.542346] example&quot;</span>
</span><span class="hll"><span class="sd">      ToasterOven.prepend_trace_timestamp(get_my_ms) # =&gt; 542</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="hll">    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[.+\.([0-9]{3}).+\]&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="k">try</span><span class="p">:</span>
</span><span class="hll">      <span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="hll">    <span class="k">except</span><span class="p">:</span>
</span><span class="hll">      <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">result</span>
</span>
<span class="hll">  <span class="nd">@staticmethod</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">time_difference</span><span class="p">(</span><span class="n">time_1_string</span><span class="p">,</span> <span class="n">time_2_string</span><span class="p">,</span> <span class="n">modulo_base</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="hll">    <span class="sd">&#39;&#39;&#39;Return the time difference between to ms readings of a timestamp</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Args**:</span>
</span><span class="hll"><span class="sd">       | ``time_1_string`` (str|int): part of a timestamp</span>
</span><span class="hll"><span class="sd">       | ``time_2_string`` (str|int): part of a timestamp</span>
</span><span class="hll"><span class="sd">       | ``modulo_base`` (int):  defaults to 1000, allows for time raps</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Returns**:</span>
</span><span class="hll"><span class="sd">       (int): (int(time_1_string) - int(time_2_string)) % modulo_base</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Example(s)**:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    .. code-block:: python</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">      # typical usage</span>
</span><span class="hll"><span class="sd">      ToasterOvenMock.time_difference(&#39;500&#39;, &#39;300&#39;) #=&gt; 200</span>
</span><span class="hll"><span class="sd">      ToasterOvenMock.time_difference(&#39;500&#39;, &#39;300&#39;, modulo_base=1000) #=&gt; 200</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">      # time wrap</span>
</span><span class="hll"><span class="sd">      # time_1_string from 1.010</span>
</span><span class="hll"><span class="sd">      # time_2_string from 0.790</span>
</span><span class="hll"><span class="sd">      ToasterOvenMock.time_difference(&#39;010&#39;, &#39;790&#39;) #=&gt; 200</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">modulo_base</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">      <span class="n">modulo_base</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span class="hll">    <span class="n">time_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_1_string</span><span class="p">)</span>
</span><span class="hll">    <span class="n">time_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_2_string</span><span class="p">)</span>
</span><span class="hll">    <span class="n">diff</span> <span class="o">=</span> <span class="n">time_2</span> <span class="o">-</span> <span class="n">time_1</span> <span class="k">if</span> <span class="n">time_1</span> <span class="o">&lt;=</span> <span class="n">time_2</span> <span class="k">else</span> <span class="p">(</span><span class="n">time_2</span> <span class="o">-</span> <span class="n">time_1</span><span class="p">)</span> <span class="o">%</span> <span class="n">modulo_base</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">diff</span>
</span>
<span class="hll">  <span class="nd">@staticmethod</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">instrumentation_line_of_match</span><span class="p">(</span><span class="n">spy_or_trace</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
</span><span class="hll">    <span class="sd">&#39;&#39;&#39;Get the line from a instrumentation collection</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Args**:</span>
</span><span class="hll"><span class="sd">       | ``spy_or_trace`` (str|list): instrumentation output</span>
</span><span class="hll"><span class="sd">       | ``string`` (str): thing to search for in the instrumentation output</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Returns**:</span>
</span><span class="hll"><span class="sd">       (str): part of the instrumentation that matches the string</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Example(s)**:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    .. code-block:: python</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">      spy_of_trace = &quot;&quot;&quot;</span>
</span><span class="hll"><span class="sd">        [2019-02-09 10:50:07.784989] [oven] e-&gt;start_at() top-&gt;off</span>
</span><span class="hll"><span class="sd">        [2019-02-09 10:50:07.785844] [oven] e-&gt;Toasting() off-&gt;toasting&quot;&quot;&quot;</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">      ToasterOvenMock.instrumentation_line_of_match(</span>
</span><span class="hll"><span class="sd">        spy_of_trace, &quot;Toasting&quot;)</span>
</span><span class="hll"><span class="sd">      # =&gt; &#39;[2019-02-09 10:50:07.785844] [oven] e-&gt;Toasting() off-&gt;toasting&#39;</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="hll">    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="hll">    <span class="n">i_list</span> <span class="o">=</span> <span class="n">spy_or_trace</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spy_or_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">spy_or_trace</span>
</span><span class="hll">    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span class="hll">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_list</span><span class="p">:</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</span><span class="hll">        <span class="n">result</span> <span class="o">=</span> <span class="n">line</span>
</span><span class="hll">        <span class="k">break</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">result</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">scribble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
</span><span class="hll">    <span class="sd">&#39;&#39;&#39;prepend a scribble string with the trace instrumentation style timestamp</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Args**:</span>
</span><span class="hll"><span class="sd">       | ``string`` (str): String to add to the scribble</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Example(s)**:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    .. code-block:: python</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">       oven = ToasterOvenMock(name=&#39;oven&#39;)</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">       # calls ActiveObject&#39;s scribble with something like:</span>
</span><span class="hll"><span class="sd">       # &quot;[2019-02-09 10:50:07.785844] buzz&quot;</span>
</span><span class="hll"><span class="sd">       oven.scribble(&quot;buzz&quot;)</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="hll">    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">prepend_trace_timestamp</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
</span>
  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_off&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_off&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>


<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">common_features</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">buzz</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">door_open</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">common_features</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">baking</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span>
</span><span class="hll">      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">),</span>
</span><span class="hll">      <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll">      <span class="n">period</span><span class="o">=</span><span class="n">oven</span><span class="o">.</span><span class="n">bake_time_in_sec</span><span class="p">,</span>
</span><span class="hll">      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span>
</span><span class="hll">    <span class="p">)</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">toasting</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">toasting</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span>
</span><span class="hll">      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">),</span>
</span><span class="hll">      <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll">      <span class="n">period</span><span class="o">=</span><span class="n">oven</span><span class="o">.</span><span class="n">toast_time_in_sec</span><span class="p">,</span>
</span><span class="hll">      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span>
</span><span class="hll">    <span class="p">)</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">off</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_open</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_on</span><span class="p">()</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">common_features</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-5-proof">
<span id="iter5-proof"></span><h4>Iteration 5 proof<a class="headerlink" href="#iteration-5-proof" title="Permalink to this headline">¶</a></h4>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p>Here are our test helpers</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">stripped</span>

<span class="k">def</span> <span class="nf">trace_through_all_states</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">spy_on_light_on</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door to turn on the light</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_light_off</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_buzz</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Send the buzz event</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_heater_on</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_heater_off</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">clear_spy</span><span class="p">()</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="hll"><span class="k">def</span> <span class="nf">test_toaster_buzz_one_shot_timing</span><span class="p">():</span>
</span><span class="hll">  <span class="c1"># set toasting time to 100 ms</span>
</span><span class="hll">  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">,</span> <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="mf">0.100</span><span class="p">)</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.106</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">trace_line</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">instrumentation_line_of_match</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="s2">&quot;Toasting&quot;</span><span class="p">)</span>
</span><span class="hll">  <span class="n">toasting_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">trace_line</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">spy_line</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">instrumentation_line_of_match</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">(),</span> <span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
</span><span class="hll">  <span class="n">buzz_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">spy_line</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">delay_in_ms</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">time_difference</span><span class="p">(</span><span class="n">toasting_time_ms</span><span class="p">,</span> <span class="n">buzz_time_ms</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># allow for 5 milliseconds of jitter (needed in jupyter)</span>
</span><span class="hll">  <span class="k">try</span><span class="p">:</span>
</span><span class="hll">    <span class="k">assert</span><span class="p">(</span><span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">delay_in_ms</span> <span class="o">&lt;=</span> <span class="mi">105</span><span class="p">)</span>
</span><span class="hll">  <span class="k">except</span><span class="p">:</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="n">delay_in_ms</span><span class="p">)</span>
</span>
<span class="hll"><span class="k">def</span> <span class="nf">test_baking_buzz_one_shot_timing</span><span class="p">():</span>
</span><span class="hll">  <span class="c1"># set bake time to 200 ms</span>
</span><span class="hll">  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">,</span> <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="mf">0.200</span><span class="p">)</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.206</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">trace_line</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">instrumentation_line_of_match</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="s2">&quot;Baking&quot;</span><span class="p">)</span>
</span><span class="hll">  <span class="n">baking_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">trace_line</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">spy_line</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">instrumentation_line_of_match</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">(),</span> <span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
</span><span class="hll">  <span class="n">buzz_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">spy_line</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">delay_in_ms</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">time_difference</span><span class="p">(</span><span class="n">baking_time_ms</span><span class="p">,</span> <span class="n">buzz_time_ms</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># allow for 5 milliseconds of jitter (needed in jupyter)</span>
</span><span class="hll">  <span class="k">try</span><span class="p">:</span>
</span><span class="hll">    <span class="k">assert</span><span class="p">(</span><span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">delay_in_ms</span> <span class="o">&lt;=</span> <span class="mi">205</span><span class="p">)</span>
</span><span class="hll">  <span class="k">except</span><span class="p">:</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="n">delay_in_ms</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>Calling our test helper functions to prove our design works:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">stripped</span>

<span class="c1"># Confirm our graph&#39;s structure</span>
<span class="n">trace_target</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[2019-02-04 06:37:04.538413] [oven] e-&gt;start_at() top-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540290] [oven] e-&gt;Door_Open() off-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.540534] [oven] e-&gt;Door_Close() door_open-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540825] [oven] e-&gt;Baking() off-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541109] [oven] e-&gt;Door_Open() baking-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.541393] [oven] e-&gt;Door_Close() door_open-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541751] [oven] e-&gt;Toasting() baking-&gt;toasting</span>
<span class="s2">[2019-02-04 06:37:04.542083] [oven] e-&gt;Door_Open() toasting-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.542346] [oven] e-&gt;Door_Close() door_open-&gt;toasting</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="n">stripped</span><span class="p">(</span><span class="n">trace_target</span><span class="p">)</span> <span class="k">as</span> <span class="n">stripped_target</span><span class="p">,</span> \
     <span class="n">stripped</span><span class="p">(</span><span class="n">trace_through_all_states</span><span class="p">())</span> <span class="k">as</span> <span class="n">stripped_trace_result</span><span class="p">:</span>

  <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stripped_target</span><span class="p">,</span> <span class="n">stripped_trace_result</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>

<span class="c1"># Confirm the our statemachine is triggering the methods we want when we want them</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;light_off&#39;</span><span class="p">,</span> <span class="n">spy_on_light_off</span><span class="p">())</span>

<span class="c1"># Confirm our light turns on</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;light_on&#39;</span><span class="p">,</span> <span class="n">spy_on_light_on</span><span class="p">())</span>

<span class="c1"># Confirm the heater turns on</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;heater_on&#39;</span><span class="p">,</span> <span class="n">spy_on_heater_on</span><span class="p">())</span>

<span class="c1"># Confirm the heater turns off</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;heater_off&#39;</span><span class="p">,</span> <span class="n">spy_on_heater_off</span><span class="p">())</span>

<span class="c1"># Confirm our buzzer works</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;buzz&#39;</span><span class="p">,</span> <span class="n">spy_on_buzz</span><span class="p">())</span>

<span class="hll"><span class="c1"># Confirm time features work</span>
</span><span class="hll"><span class="n">test_toaster_buzz_one_shot_timing</span><span class="p">()</span>
</span><span class="hll"><span class="n">test_baking_buzz_one_shot_timing</span><span class="p">()</span>
</span></pre></div>
</td></tr></table></div>
</div>
<div class="section" id="iteration-5-questions">
<span id="iter5-questions"></span><h4>Iteration 5 questions<a class="headerlink" href="#iteration-5-questions" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#zero-to-one-what-happens-if-they-don-t-take-out-there-food-after-a-buzz-rings5"><span class="std std-ref">What happens if they don’t take out there food after a buzz rings?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-what-is-a-one-shot5"><span class="std std-ref">What is a one shot?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-how-does-a-one-shot-work5"><span class="std std-ref">How does a one shot work?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-do-you-cancel-the-events-in-the-exit-states5"><span class="std std-ref">Why do you cancel the events in the exit states?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-can-you-relate-a-one-shot-to-the-story5"><span class="std std-ref">Can you relate a one shot to the story?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-what-is-the-remind-pattern5"><span class="std std-ref">What is the remind pattern?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-did-you-turn-toasterovenmock-into-a-subclass-of-toasteroven5"><span class="std std-ref">Why did you turn ToasterOvenMock into a subclass of ToasterOven?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-do-you-have-docstrings-in-the-test-code-and-not-elsewhere5"><span class="std std-ref">Why do you have docstrings in the test code and not elsewhere?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-what-is-jitter5"><span class="std std-ref">What is jitter?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-is-your-tolernance-of-jitter-so-high5"><span class="std std-ref">Why is your tolernance of jitter so high?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-how-can-i-reduce-the-jitter5"><span class="std std-ref">How can I reduce the jitter?</span></a></li>
</ul>
<p id="zero-to-one-what-happens-if-they-don-t-take-out-there-food-after-a-buzz-rings5"><strong>What happens if they don’t take out there food after a buzz rings?</strong></p>
<p>The toaster oven would continue to cook.  This will be fixed in the next iteration.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-what-is-a-one-shot5"><strong>What is a one shot?</strong></p>
<p>It is the code that issues an event to the statechart at a predetermined time in
the future.</p>
<p>Here is an example, when the following code is run, a <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> event will be
sent to the statechart in 10 seconds:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># send an Buzz event to this chart, 10 seconds from now</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">Buzz</span><span class="p">),</span>
  <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">period</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
  <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>An event which is issued by a one shot looks just like any other event that has
been received from outside of the statechart.  Our design already accomodates
Buzz events, they are handled by the <code class="docutils literal notranslate"><span class="pre">common_features</span></code> state.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-how-does-a-one-shot-work5"><strong>How does a one shot work?</strong></p>
<p>Any <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> or <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> call with the <code class="docutils literal notranslate"><span class="pre">period</span></code> argument set, spawns
another python daemonic-thread with an internal timer.  It will issue as many
events as indicated by the <code class="docutils literal notranslate"><span class="pre">times</span></code> argument; when it has completed its work,
the thread will stop running and python will garbage collect it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the <code class="docutils literal notranslate"><span class="pre">times</span></code> argument is set to zero, the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> or <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code>
will continue to post events until the program is stopped.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-do-you-cancel-the-events-in-the-exit-states5"><strong>Why do you cancel the events in the exit states?</strong></p>
<p>The deferred one shot pushes a behavior into the future.  It’s event will arrive
as if it was posted from outside of the chart, with no regard for the chart’s
current state.  This can lead to some confusing behavior.</p>
<p>I’ll illustrate this with an example.  Suppose we didn’t cancel our one-shot
events upon leaving either the baking or toasting states:</p>
<a class="reference external image-reference" href="_static/ToasterOven_5_without_cancel.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_5_without_cancel.svg" src="_images/ToasterOven_5_without_cancel.svg" /></div>
</a>
<p>Imagine that we toast something for 5 seconds, then quickly open and close the
door, then immediately press the bake button.</p>
<p>5 seconds after this moment we would hear a buzz, then 10 seconds after that,
then 20 seconds after that.</p>
<p>Without canceling our one shot, the diagram’s fidelity is reduced, because you
can’t just see the behavior, instead you have to run a full simulation in your
head.</p>
<p>However, if you cancel your one-shot upon exiting the state from which they were
created, you will avoid these strange behaviours.  When you look at the baking
or toasting states, you will know that if the unit remains in these states for
their respective one-shot times, the oven will behave as you expect it to.</p>
<a class="reference external image-reference" href="_static/ToasterOven.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven.svg" src="_images/ToasterOven.svg" /></div>
</a>
<p>Let’s re-imagine our scenario with the one-shot cancellations in the exit states
of baking and toasting.  We toast something for 5 seconds, open the door, close
the door, then immediately press the bake button.  The buzzer will sound in 20
seconds.</p>
<p>Typically, I cancel deferred events when exiting the states from which they were
initiated.  If you see a diagram where this isn’t the case; it might be a design
bug, or at least an indication that you have to think harder to understand what
is going on.</p>
<p>In the next iteration I will break this best-practice to make a different point.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-can-you-relate-a-one-shot-to-the-story5"><strong>Can you relate a one shot to the story?</strong></p>
<p>One-shot triggers and their cancellations can be initiated by any human when
they talk to Spike or Tara.</p>
<p>The one shot is a kind of event gun (<code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> or <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code>) which
invents a small universe then tears a portal to it.  Through this portal, an
event is placed in suspension for a given amount of time relative to our
universe (a statechart has no such time dimension).  The portal closes and the
universe (holding the event) persists for the duration of time specified by the
period argument.  Once this time has elapsed, the event attaches itself into the
portal that Theo is watching and the temporary universe is destroyed.</p>
<p>When Theo receives such an event he marvels at it, believing that it came from
some other universe, which is true, but he has no idea that it was initiated by
one of the humans in his own domain.  He treats it as he would any other event.</p>
<p>If the one shot was initiated using a <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> call, the event
will be placed at the last location available in the deque.</p>
<a class="reference external image-reference" href="_static/ToasterOven_5_Theo_1.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_5_Theo_1.svg" src="_images/ToasterOven_5_Theo_1.svg" /></div>
</a>
<p>If the one shot was initiated by a <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> call, the event
will barge its way to the front of the deque, shifting all other items to the
right by one.  Such a call will put the event immediately in front of Theo once
its time has elapsed.</p>
<a class="reference external image-reference" href="_static/ToasterOven_5_Theo_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_5_Theo_2.svg" src="_images/ToasterOven_5_Theo_2.svg" /></div>
</a>
<p><code class="docutils literal notranslate"><span class="pre">cancel_events</span></code> can be thought of as a gun that shoots bullets that destroys
bullets shot by other guns.  A call to <code class="docutils literal notranslate"><span class="pre">cancel_events</span></code> will tear into the
great beyond, looking for all of the one-shots that haven’t timed-out yet.  If
the event name of the one shot matches that which was fed to the
<code class="docutils literal notranslate"><span class="pre">cancel_events</span></code> call, that universe is annihilated before it’s event can be
presented Theo.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-what-is-the-remind-pattern5"><strong>What is the remind pattern?</strong></p>
<p>When you invent an event within a statechart, then post it back into the same
statechart, it is called the <a class="reference internal" href="patterns.html#patterns-reminder"><span class="std std-ref">reminder pattern</span></a>.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-did-you-turn-toasterovenmock-into-a-subclass-of-toasteroven5"><strong>Why did you turn ToasterOvenMock into a subclass of ToasterOven?</strong></p>
<p>A ToasterOvenMock object is intended to test a ToasterOven and its attached
statemachine.</p>
<p>In this iteration we introduced the <code class="docutils literal notranslate"><span class="pre">toast_time_in_sec</span></code> and
<code class="docutils literal notranslate"><span class="pre">bake_time_in_sec</span></code> attributes to the ToasterOven, and they are referenced within the
statemachine.  This means that the ToasterOvenMock needs them too.</p>
<p>To avoid repeating myself, by defining these attributes in both classes,
ToasterOvenMock inherits from the ToasterOven so I get these attributes
automatically.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-do-you-have-docstrings-in-the-test-code-and-not-elsewhere5"><strong>Why do you have docstrings in the test code and not elsewhere?</strong></p>
<p>I found the testing code a bit confusing so I added some documentation.  You can
see that I use some reStructuredText in my Docstring which adds some clutter.</p>
<p>When docstrings are written in this manner, then parsed and turned into
html, they will produce a document that looks like <a class="reference external" href="https://aleph2c.github.io/spaced/repetition.html#module-repetition">this</a></p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-what-is-jitter5"><strong>What is jitter?</strong></p>
<p>“Jitter is the deviation from true periodicity of a presumable periodic signal,
often in relation to a reference clock signal”. – Wikipedia</p>
<p>In our test code we try to produce two signals, one with a period of 100 ms and
the other 200 ms.  The signals only run once, but we still see evidence of
jitter, because they arrive late.</p>
<p>We account for this lateness in our test code by providing some tolerance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span><span class="p">(</span><span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">delay_in_ms</span> <span class="o">&lt;=</span> <span class="mi">105</span><span class="p">)</span>
<span class="c1"># ..</span>
<span class="k">assert</span><span class="p">(</span><span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">delay_in_ms</span> <span class="o">&lt;=</span> <span class="mi">205</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Our jitter is asymetric, an event will never arrive early; we slip into the
future.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-is-your-tolernance-of-jitter-so-high5"><strong>Why is your tolernance of jitter so high?</strong></p>
<p>I am testing this documentation using Jupyter (running in a web browser) which
is talking to a CPython, Python implementation, which is running within the
Windows Subsystem for Linux (wsl).  The Jupyter web interface communicates with the
Cpython interpreter using Json over the ZeroMQ messaging protocol.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">miros</span></code> library uses Python threads, which is to say a single process on
one CPU, that is shared between the threads.  To avoid concurrency problems –
deadlocks, priority-inversion etc, python uses something called the global
interpreter lock (GIL).</p>
<p>So there is a lot of technology between my demonstration-code and the actual CPU
and its timers.  As a python programmer using Threads I really don’t get to have
access to the precise time features offered by my computer; especially if I am
running code in Jupyter.</p>
<p>If you need tight time tolerances consider using the <a class="reference external" href="https://www.state-machine.com/">qp framework</a> without an OS.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-how-can-i-reduce-the-jitter5"><strong>How can I reduce the jitter?</strong></p>
<p>Well, don’t run your program in Jupyter for one.  Consider using the <a class="reference external" href="https://www.state-machine.com/">qp
framework</a> or its derived <a class="reference external" href="https://github.com/dwhall/farc">farc framework</a> in python.</p>
<p>In our design, we don’t really care about the 2-5 ms latency, because it is
0.02%-0.05% of the 10 second delay, and 0.01%-0.025% percent of the 20 second
delay.</p>
<p>Our customers won’t notice if they have to wait an additional 5 ms to hear their
toaster oven buzz.</p>
<a class="reference internal" href="zero_to_one.html#iter4"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter5-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
</div>
<div class="section" id="iteration-6-multi-shot-events-and-payloads">
<span id="iter6"></span><h3>Iteration 6: Multi-Shot events and Payloads<a class="headerlink" href="#iteration-6-multi-shot-events-and-payloads" title="Permalink to this headline">¶</a></h3>
<p>So far we have built a very basic toaster oven.</p>
<p>In this iteration we will add two new features:</p>
<ul class="simple">
<li>The oven will buzz once when it is almost done.</li>
<li>When the oven has finished cooking, it will buzz twice and turn off.</li>
</ul>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<div class="section" id="iteration-6-specification">
<span id="iter6-spec"></span><h4>Iteration 6 specification<a class="headerlink" href="#iteration-6-specification" title="Permalink to this headline">¶</a></h4>
<p>Iteration 6 specification:</p>
<p>The toaster oven spec:</p>
<ul class="simple">
<li>The toaster oven will have an oven light, which can be turned on and off</li>
<li>The toaster oven will have a heater, which can be turned on and off</li>
<li>It will have two different heating modes, baking which can bake a potato
and toasting which can toast some bread</li>
<li>The toaster oven should start in the off state</li>
<li>The toaster can only heat when the door is closed</li>
<li>The toaster’s light should be off when the door is closed</li>
<li>The toaster should turn on its light when the door is opened</li>
<li>A customer should be able to open and close the door of our toaster oven</li>
<li>When a customer closes the door, the toaster oven should go back to behaving
like it did before</li>
<li><span class="dead-spec">The buzzer will sound 10 seconds after a Toasting event</span></li>
<li><span class="dead-spec">The buzzer will sound 20 seconds after a Baking event</span></li>
<li><span class="new-spec">The toasting mode will cook for 10 seconds, then turn off</span></li>
<li><span class="new-spec">The baking mode will cook for 20 seconds, then turn off</span></li>
<li><span class="new-spec">One buzz means get ready, there is 1 second left</span></li>
<li><span class="new-spec">Two buzzes means something has finished cooking</span></li>
<li><span class="new-spec">Three buzzes means the white walkers are coming</span></li>
</ul>
</div>
<div class="section" id="iteration-6-design">
<span id="iter6-design"></span><h4>Iteration 6 design<a class="headerlink" href="#iteration-6-design" title="Permalink to this headline">¶</a></h4>
<p>If you can’t see the design in your browser, click on the diagram to look at the
pdf file.</p>
<a class="reference external image-reference" href="_static/ToasterOven_6.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_6.svg" src="_images/ToasterOven_6.svg" /></div>
</a>
<p>The entry condition of the baking state creates two deferred one-shot events,
<code class="docutils literal notranslate"><span class="pre">Get_Ready</span></code> and <code class="docutils literal notranslate"><span class="pre">Done</span></code>.  Each of these events contain a buzz specification
as a payload.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">Get_Ready</span></code> event is received by the statechart, it creates a <code class="docutils literal notranslate"><span class="pre">Buzz</span></code>
one-shot which fires immediately.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">Done</span></code> event is received, it creates a <code class="docutils literal notranslate"><span class="pre">Buzz</span></code> multishot (two
buzzes) which begins firing immediately, then the oven turns off.</p>
<p>The toasting state behaves exactly like the baking state, except it has a
different cook time.  To avoid having code repetition, the code that is common
between the <code class="docutils literal notranslate"><span class="pre">baking</span></code> and <code class="docutils literal notranslate"><span class="pre">toasting</span></code> states was pulled out of the
statemachine and into the <code class="docutils literal notranslate"><span class="pre">cook_time</span></code> method of the ToasterOven.</p>
<p>Here is a timing diagram describing how the statechart timing relates to the
hardware timing:</p>
<a class="reference external image-reference" href="_static/ToasterOven_6_Timing_Diagram.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_6_Timing_Diagram.svg" src="_images/ToasterOven_6_Timing_Diagram.svg" /></div>
</a>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-6-code">
<span id="iter6-code"></span><h4>Iteration 6 code<a class="headerlink" href="#iteration-6-code" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="hll"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
</span>
<span class="hll"><span class="n">BuzzSpec</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
</span><span class="hll">  <span class="s2">&quot;BuzzSpec&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;buzz_times&#39;</span><span class="p">])</span>
</span>
<span class="k">class</span> <span class="nc">ToasterOven</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>

  <span class="n">TOAST_TIME_IN_SEC</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="n">BAKE_TIME_IN_SEC</span> <span class="o">=</span> <span class="mi">20</span>
<span class="hll">  <span class="n">PRE_TIME_SEC</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="hll">  <span class="n">DONE_BUZZ_PERIOD_SEC</span> <span class="o">=</span> <span class="mf">0.5</span>
</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
    <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
<span class="hll">    <span class="n">get_ready_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
</span><span class="hll">    <span class="n">done_buzz_period_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">toast_time_in_sec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">toast_time_in_sec</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="o">.</span><span class="n">TOAST_TIME_IN_SEC</span>
    <span class="k">if</span> <span class="n">bake_time_in_sec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">bake_time_in_sec</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="o">.</span><span class="n">BAKE_TIME_IN_SEC</span>
<span class="hll">    <span class="k">if</span> <span class="n">get_ready_sec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">      <span class="n">get_ready_sec</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="o">.</span><span class="n">PRE_TIME_SEC</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">done_buzz_period_sec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="hll">      <span class="n">done_buzz_period_sec</span> <span class="o">=</span> <span class="n">ToasterOven</span><span class="o">.</span><span class="n">DONE_BUZZ_PERIOD_SEC</span>
</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">toast_time_in_sec</span> <span class="o">=</span> <span class="n">toast_time_in_sec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bake_time_in_sec</span> <span class="o">=</span> <span class="n">bake_time_in_sec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_ready_sec</span> <span class="o">=</span> <span class="n">get_ready_sec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">done_buzz_period_sec</span> <span class="o">=</span> <span class="n">done_buzz_period_sec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s light_on driver</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s light_off driver</span>
    <span class="k">pass</span>


  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s heater on driver</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s heater off driver</span>
     <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># call to your hardware&#39;s buzzer</span>
    <span class="k">pass</span>

<span class="hll">  <span class="k">def</span> <span class="nf">cook_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_in_sec</span><span class="p">):</span>
</span><span class="hll">    <span class="sd">&#39;&#39;&#39;Produce ``Get_Ready`` and ``Done`` one-shot events with their respect Buzz</span>
</span><span class="hll"><span class="sd">       specifications.</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Note**:</span>
</span><span class="hll"><span class="sd">       This code is used in both the baking and toasting states, so it was moved</span>
</span><span class="hll"><span class="sd">       into the ToasterOven class to avoid repeating code in the statemachine.</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    **Args**:</span>
</span><span class="hll"><span class="sd">       | ``time_in_sec`` (float): the cooking time in seconds</span>
</span><span class="hll"><span class="sd">    &#39;&#39;&#39;</span>
</span><span class="hll">    <span class="n">get_ready_sec</span> <span class="o">=</span> <span class="n">time_in_sec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ready_sec</span>
</span><span class="hll">
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
</span><span class="hll">      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Get_Ready</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">BuzzSpec</span><span class="p">(</span><span class="n">buzz_times</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
</span><span class="hll">      <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll">      <span class="n">period</span><span class="o">=</span><span class="n">get_ready_sec</span><span class="p">,</span>
</span><span class="hll">      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
</span><span class="hll">      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Done</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">BuzzSpec</span><span class="p">(</span><span class="n">buzz_times</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
</span><span class="hll">      <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll">      <span class="n">period</span><span class="o">=</span><span class="n">time_in_sec</span><span class="p">,</span>
</span><span class="hll">      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span>

<span class="k">class</span> <span class="nc">ToasterOvenMock</span><span class="p">(</span><span class="n">ToasterOven</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">get_ready_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">done_buzz_period_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
      <span class="n">toast_time_in_sec</span><span class="p">,</span>
      <span class="n">bake_time_in_sec</span><span class="p">,</span>
      <span class="n">get_ready_sec</span><span class="p">,</span>
      <span class="n">done_buzz_period_sec</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">prepend_trace_timestamp</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Prepend the trace-style timestamp in front of a string</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``string`` (str): a string you would like timestamped</span>

<span class="sd">    **Returns**:</span>
<span class="sd">       (string): datetime stamp prepended to input string</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      ToasterOven.prepend_trace_timestamp(&quot;example&quot;)</span>
<span class="sd">      # =&gt; [2019-02-04 06:37:04.542346] example</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="s2">&quot;[{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">string</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get the 100ms part of a timestamp provided in the trace style</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``timestamp_string`` (str): string with prepended timestamp</span>

<span class="sd">    **Returns**:</span>
<span class="sd">       | (string): The first three digits after the seconds decimal point</span>
<span class="sd">       | (None): If no match</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      get_my_ms =  &quot;[2019-02-04 06:37:04.542346] example&quot;</span>
<span class="sd">      ToasterOven.prepend_trace_timestamp(get_my_ms) # =&gt; 542</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[.+\.([0-9]{3}).+\]&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">timestamp_string</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">time_difference</span><span class="p">(</span><span class="n">time_1_string</span><span class="p">,</span> <span class="n">time_2_string</span><span class="p">,</span> <span class="n">modulo_base</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return the time difference between to ms readings of a timestamp</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``time_1_string`` (str|int): part of a timestamp</span>
<span class="sd">       | ``time_2_string`` (str|int): part of a timestamp</span>
<span class="sd">       | ``modulo_base`` (int):  defaults to 1000, allows for time raps</span>

<span class="sd">    **Returns**:</span>
<span class="sd">       (int): (int(time_1_string) - int(time_2_string)) % modulo_base</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      # typical usage</span>
<span class="sd">      ToasterOvenMock.time_difference(&#39;500&#39;, &#39;300&#39;) #=&gt; 200</span>
<span class="sd">      ToasterOvenMock.time_difference(&#39;500&#39;, &#39;300&#39;, modulo_base=1000) #=&gt; 200</span>

<span class="sd">      # time wrap</span>
<span class="sd">      # time_1_string from 1.010</span>
<span class="sd">      # time_2_string from 0.790</span>
<span class="sd">      ToasterOvenMock.time_difference(&#39;010&#39;, &#39;790&#39;) #=&gt; 200</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">modulo_base</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">modulo_base</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">time_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_1_string</span><span class="p">)</span>
    <span class="n">time_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_2_string</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">time_2</span> <span class="o">-</span> <span class="n">time_1</span> <span class="k">if</span> <span class="n">time_1</span> <span class="o">&lt;=</span> <span class="n">time_2</span> <span class="k">else</span> <span class="p">(</span><span class="n">time_2</span> <span class="o">-</span> <span class="n">time_1</span><span class="p">)</span> <span class="o">%</span> <span class="n">modulo_base</span>
    <span class="k">return</span> <span class="n">diff</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">instrumentation_line_of_match</span><span class="p">(</span><span class="n">spy_or_trace</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get the line from a instrumentation collection</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``spy_or_trace`` (str|list): instrumentation output</span>
<span class="sd">       | ``string`` (str): thing to search for in the instrumentation output</span>

<span class="sd">    **Returns**:</span>
<span class="sd">       (str): part of the instrumentation that matches the string</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      spy_of_trace = &quot;&quot;&quot;</span>
<span class="sd">        [2019-02-09 10:50:07.784989] [oven] e-&gt;start_at() top-&gt;off</span>
<span class="sd">        [2019-02-09 10:50:07.785844] [oven] e-&gt;Toasting() off-&gt;toasting&quot;&quot;&quot;</span>

<span class="sd">      ToasterOvenMock.instrumentation_line_of_match(</span>
<span class="sd">        spy_of_trace, &quot;Toasting&quot;)</span>
<span class="sd">      # =&gt; &#39;[2019-02-09 10:50:07.785844] [oven] e-&gt;Toasting() off-&gt;toasting&#39;</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">i_list</span> <span class="o">=</span> <span class="n">spy_or_trace</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spy_or_trace</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">spy_or_trace</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">i_list</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">line</span>
        <span class="k">break</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">def</span> <span class="nf">scribble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;prepend a scribble string with the trace instrumentation style timestamp</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``string`` (str): String to add to the scribble</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       oven = ToasterOvenMock(name=&#39;oven&#39;)</span>

<span class="sd">       # calls ActiveObject&#39;s scribble with something like:</span>
<span class="sd">       # &quot;[2019-02-09 10:50:07.785844] buzz&quot;</span>
<span class="sd">       oven.scribble(&quot;buzz&quot;)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">prepend_trace_timestamp</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">light_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">light_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;light_off&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_on&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">heater_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;heater_off&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">buzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
      <span class="n">output</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">prepend_trace_timestamp</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;buzz&quot;</span><span class="p">)</span>


<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">common_features</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">buzz</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_closed</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">baking</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">toasting</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">door_open</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">common_features</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">heating</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_on</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Get_Ready</span><span class="p">):</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">),</span>
</span><span class="hll">      <span class="n">times</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">buzz_times</span><span class="p">,</span>
</span><span class="hll">      <span class="n">period</span><span class="o">=</span><span class="n">oven</span><span class="o">.</span><span class="n">done_buzz_period_sec</span><span class="p">,</span>
</span><span class="hll">      <span class="n">deferred</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Done</span><span class="p">):</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">),</span>
</span><span class="hll">      <span class="n">times</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">buzz_times</span><span class="p">,</span>
</span><span class="hll">      <span class="n">period</span><span class="o">=</span><span class="n">oven</span><span class="o">.</span><span class="n">done_buzz_period_sec</span><span class="p">,</span>
</span><span class="hll">      <span class="n">deferred</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">heater_off</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">baking</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">baking</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">cook_time</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">bake_time_in_sec</span><span class="p">)</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Done</span><span class="p">))</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Get_Ready</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">toasting</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">toasting</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">cook_time</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">toast_time_in_sec</span><span class="p">)</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
<span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Done</span><span class="p">))</span>
</span><span class="hll">    <span class="n">oven</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Get_Ready</span><span class="p">))</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">heating</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">off</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">door_closed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">door_open</span><span class="p">(</span><span class="n">oven</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">light_on</span><span class="p">()</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">oven</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">oven</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">common_features</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="c1"># reduce our time delays so we don&#39;t have</span>
  <span class="c1"># to wait while we are testing</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">,</span>
    <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">get_ready_sec</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span>
    <span class="n">done_buzz_period_sec</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

  <span class="n">oven</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="c1"># start our oven in the door_closed state</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>

  <span class="c1"># Toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>

  <span class="c1"># Let it finish toasting</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

  <span class="c1"># Bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>

  <span class="c1"># let it finish backing</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-6-proof">
<span id="iter6-proof"></span><h4>Iteration 6 proof<a class="headerlink" href="#iteration-6-proof" title="Permalink to this headline">¶</a></h4>
<p>Our design hasn’t changed that much, but is the part that we changed working?</p>
<a class="reference external image-reference" href="_static/ToasterOven_6.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_6.svg" src="_images/ToasterOven_6.svg" /></div>
</a>
<p>Let’s give it some time parameters, turn on the trace and look at the output.
To avoid a long feedback cycle we will test in milliseconds.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">toast_time</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># 100 ms</span>
<span class="n">bake_time</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># 200 ms</span>
<span class="n">get_ready_sec</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 50 ms</span>
<span class="n">done_buzz_period_sec</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># 10 ms</span>

<span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">,</span>
  <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="n">toast_time</span><span class="p">,</span>
  <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="n">bake_time</span><span class="p">,</span>
<span class="hll">  <span class="n">get_ready_sec</span><span class="o">=</span><span class="n">get_ready_sec</span><span class="p">,</span>
</span><span class="hll">  <span class="n">done_buzz_period_sec</span><span class="o">=</span><span class="n">done_buzz_period_sec</span><span class="p">)</span>
</span><span class="n">oven</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
<span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>This results in something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">54.844655</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">54.845782</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Toasting</span><span class="p">()</span> <span class="n">off</span><span class="o">-&gt;</span><span class="n">toasting</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">54.897128</span><span class="p">]</span> <span class="n">buzz</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">54.948089</span><span class="p">]</span> <span class="p">[</span><span class="n">oven</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Done</span><span class="p">()</span> <span class="n">toasting</span><span class="o">-&gt;</span><span class="n">off</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">54.948708</span><span class="p">]</span> <span class="n">buzz</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mf">54.958674</span><span class="p">]</span> <span class="n">buzz</span>
</pre></div>
</div>
<p>These results match the “Statchmachine Timing” characteristics of our timing
diagram:</p>
<a class="reference external image-reference" href="_static/ToasterOven_6_Timing_Diagram.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_6_Timing_Diagram.svg" src="_images/ToasterOven_6_Timing_Diagram.svg" /></div>
</a>
<p>Here is a sequence diagram of the output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Statechart: oven]
      top            off         toasting
       +--start_at()-&gt;|              |
       |     (1)      |              |
       |              +--Toasting()-&gt;|
       |              |     (2)      |
       |              |              | buzz(3)
       |              |              |
       |              +&lt;---Done()----|
       |              |     (4)      | buzz(5)
       |              |              | buzz(6)
       |              |              |
</pre></div>
</div>
<ol class="arabic simple">
<li>Starting the oven</li>
<li>Sending the toasting event at 845 ms</li>
<li>Get ready buzz event at 897 ms. 897, roughly (845 + 100-50)</li>
<li>The toasting is Done at 948 ms. 948, roughly (845 + 100)</li>
<li>First off buzz event at 949 ms, telling the user the oven is done cooking. 949, roughly (845 + 100)</li>
<li>Second off buzz event at 959 ms, telling the user the oven is done cooking. 959, roughly (845 + 100 + 10)</li>
</ol>
<p>Our preliminary check tells us things are working.</p>
<p>Here is a complete test:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">stripped</span>

<span class="k">def</span> <span class="nf">trace_through_all_states</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Bake something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="c1"># Toast something</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="c1"># Open the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="c1"># Close the door</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Close</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">spy_on_light_on</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Open the door to turn on the light</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Door_Open</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_light_off</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_buzz</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="c1"># Send the buzz event</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Buzz</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_heater_on</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">spy_on_heater_off</span><span class="p">():</span>
  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">)</span>
  <span class="c1"># The light should be turned off when we start</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">clear_spy</span><span class="p">()</span>
  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Off</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
  <span class="c1"># turn our array into a paragraph</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>

<span class="hll"><span class="k">def</span> <span class="nf">test_buzz_timing</span><span class="p">():</span>
</span><span class="hll">  <span class="c1"># Test in the range of ms so we don&#39;t have to wait around for results</span>
</span><span class="hll">  <span class="n">toast_time</span><span class="p">,</span> <span class="n">bake_time</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span>
</span><span class="hll">  <span class="n">get_ready_sec</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span class="hll">  <span class="n">done_buzz_period_sec</span> <span class="o">=</span> <span class="mf">0.03</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">oven</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="p">(</span>
</span><span class="hll">    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;oven&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">toast_time_in_sec</span><span class="o">=</span><span class="n">toast_time</span><span class="p">,</span>
</span><span class="hll">    <span class="n">bake_time_in_sec</span><span class="o">=</span><span class="n">bake_time</span><span class="p">,</span>
</span><span class="hll">    <span class="n">get_ready_sec</span><span class="o">=</span><span class="n">get_ready_sec</span><span class="p">,</span>
</span><span class="hll">    <span class="n">done_buzz_period_sec</span><span class="o">=</span><span class="n">done_buzz_period_sec</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># start our oven in the door_closed state</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">door_closed</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Buzz timing testing specifications and helper functions</span>
</span><span class="hll">  <span class="n">TS</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;TargetAndToleranceSpec&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;tolerance&#39;</span><span class="p">])</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">make_test_spec</span><span class="p">(</span><span class="n">cook_time_sec</span><span class="p">,</span> <span class="n">get_ready_sec</span><span class="p">,</span> <span class="n">done_buzz_period_sec</span><span class="p">,</span> <span class="n">tolernance_in_ms</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
</span><span class="hll">    <span class="s2">&quot;create as specification where define everything in ms&quot;</span>
</span><span class="hll">    <span class="n">ts</span> <span class="o">=</span> <span class="p">[</span>
</span><span class="hll">      <span class="n">TS</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;get ready buzz&quot;</span><span class="p">,</span>
</span><span class="hll">        <span class="n">offset</span><span class="o">=</span><span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">cook_time_sec</span><span class="o">-</span><span class="n">get_ready_sec</span><span class="p">),</span>
</span><span class="hll">        <span class="n">tolerance</span><span class="o">=</span><span class="n">tolernance_in_ms</span><span class="p">),</span>
</span><span class="hll">      <span class="n">TS</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;first done buzz&quot;</span> <span class="p">,</span>
</span><span class="hll">        <span class="n">offset</span><span class="o">=</span><span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">cook_time_sec</span><span class="p">),</span>
</span><span class="hll">        <span class="n">tolerance</span><span class="o">=</span><span class="n">tolernance_in_ms</span><span class="p">),</span>
</span><span class="hll">      <span class="n">TS</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;second done buzz&quot;</span><span class="p">,</span>
</span><span class="hll">        <span class="n">offset</span><span class="o">=</span><span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">cook_time_sec</span><span class="o">+</span><span class="n">done_buzz_period_sec</span><span class="p">),</span>
</span><span class="hll">        <span class="n">tolerance</span><span class="o">=</span><span class="n">tolernance_in_ms</span><span class="p">)]</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">ts</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">def</span> <span class="nf">test_buzz_events</span><span class="p">(</span><span class="n">test_type</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">buzz_times</span><span class="p">):</span>
</span><span class="hll">    <span class="k">for</span> <span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">),</span> <span class="n">buzz_time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">buzz_times</span><span class="p">):</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># only keep track of ms, allow for wrapping of time</span>
</span><span class="hll">      <span class="n">bottom_bound</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_time</span><span class="o">+</span><span class="n">offset</span><span class="o">-</span><span class="n">tolerance</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span>
</span><span class="hll">      <span class="n">top_bound</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_time</span><span class="o">+</span><span class="n">offset</span><span class="o">+</span><span class="n">tolerance</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># allow for wrapping of time</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">bottom_bound</span> <span class="o">&gt;</span> <span class="n">top_bound</span><span class="p">:</span>
</span><span class="hll">        <span class="n">bottom_bound</span> <span class="o">-=</span> <span class="mi">1000</span>
</span><span class="hll">      <span class="k">try</span><span class="p">:</span>
</span><span class="hll">        <span class="k">assert</span><span class="p">(</span><span class="n">bottom_bound</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">buzz_time</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">top_bound</span><span class="p">)</span>
</span><span class="hll">      <span class="k">except</span><span class="p">:</span>
</span><span class="hll">        <span class="c1"># if you land here try increasing your tolerance</span>
</span><span class="hll">        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;FAILED: testing {} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_type</span><span class="p">,</span> <span class="n">desc</span><span class="p">))</span>
</span><span class="hll">        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{} &lt;= {} &lt;= {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bottom_bound</span><span class="p">,</span> <span class="n">buzz_time</span><span class="p">,</span> <span class="n">top_bound</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">toasting_buzz_test_spec</span> <span class="o">=</span> <span class="n">make_test_spec</span><span class="p">(</span><span class="n">toast_time</span><span class="p">,</span> <span class="n">get_ready_sec</span><span class="p">,</span> <span class="n">done_buzz_period_sec</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Toast something</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Toasting</span><span class="p">))</span>
</span><span class="hll">  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="hll">  <span class="n">trace_line</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">instrumentation_line_of_match</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="s2">&quot;Toasting&quot;</span><span class="p">)</span>
</span><span class="hll">  <span class="n">toasting_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">trace_line</span><span class="p">))</span>
</span><span class="hll">  <span class="n">buzz_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">for</span>
</span><span class="hll">                <span class="n">line</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[.+\] buzz&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">()))]</span>
</span><span class="hll">  <span class="n">test_buzz_events</span><span class="p">(</span><span class="s1">&#39;toasting&#39;</span><span class="p">,</span> <span class="n">toasting_time_ms</span><span class="p">,</span> <span class="n">toasting_buzz_test_spec</span><span class="p">,</span> <span class="n">buzz_times</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># clear the spy and trace logs for another test</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">clear_spy</span><span class="p">()</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">clear_trace</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">baking_buzz_test_spec</span> <span class="o">=</span> <span class="n">make_test_spec</span><span class="p">(</span><span class="n">bake_time</span><span class="p">,</span> <span class="n">get_ready_sec</span><span class="p">,</span> <span class="n">done_buzz_period_sec</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Bake something</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
</span><span class="hll">  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="hll">  <span class="n">oven</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Baking</span><span class="p">))</span>
</span><span class="hll">  <span class="n">trace_line</span> <span class="o">=</span> <span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">instrumentation_line_of_match</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="s2">&quot;Baking&quot;</span><span class="p">)</span>
</span><span class="hll">  <span class="n">baking_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">trace_line</span><span class="p">))</span>
</span><span class="hll">  <span class="n">buzz_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ToasterOvenMock</span><span class="o">.</span><span class="n">get_100ms_from_timestamp</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">for</span>
</span><span class="hll">                <span class="n">line</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[.+\] buzz&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oven</span><span class="o">.</span><span class="n">spy</span><span class="p">()))]</span>
</span><span class="hll">  <span class="n">test_buzz_events</span><span class="p">(</span><span class="s1">&#39;baking&#39;</span><span class="p">,</span> <span class="n">baking_time_ms</span><span class="p">,</span> <span class="n">baking_buzz_test_spec</span><span class="p">,</span> <span class="n">buzz_times</span><span class="p">)</span>
</span>
<span class="c1"># Confirm our graph&#39;s structure</span>
<span class="n">trace_target</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">[2019-02-04 06:37:04.538413] [oven] e-&gt;start_at() top-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540290] [oven] e-&gt;Door_Open() off-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.540534] [oven] e-&gt;Door_Close() door_open-&gt;off</span>
<span class="s2">[2019-02-04 06:37:04.540825] [oven] e-&gt;Baking() off-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541109] [oven] e-&gt;Door_Open() baking-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.541393] [oven] e-&gt;Door_Close() door_open-&gt;baking</span>
<span class="s2">[2019-02-04 06:37:04.541751] [oven] e-&gt;Toasting() baking-&gt;toasting</span>
<span class="s2">[2019-02-04 06:37:04.542083] [oven] e-&gt;Door_Open() toasting-&gt;door_open</span>
<span class="s2">[2019-02-04 06:37:04.542346] [oven] e-&gt;Door_Close() door_open-&gt;toasting</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="n">stripped</span><span class="p">(</span><span class="n">trace_target</span><span class="p">)</span> <span class="k">as</span> <span class="n">stripped_target</span><span class="p">,</span> \
     <span class="n">stripped</span><span class="p">(</span><span class="n">trace_through_all_states</span><span class="p">())</span> <span class="k">as</span> <span class="n">stripped_trace_result</span><span class="p">:</span>

  <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stripped_target</span><span class="p">,</span> <span class="n">stripped_trace_result</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>

<span class="c1"># Confirm the our statemachine is triggering the methods we want when we want them</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;light_off&#39;</span><span class="p">,</span> <span class="n">spy_on_light_off</span><span class="p">())</span>

<span class="c1"># Confirm our light turns on</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;light_on&#39;</span><span class="p">,</span> <span class="n">spy_on_light_on</span><span class="p">())</span>

<span class="c1"># Confirm the heater turns on</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;heater_on&#39;</span><span class="p">,</span> <span class="n">spy_on_heater_on</span><span class="p">())</span>

<span class="c1"># Confirm the heater turns off</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;heater_off&#39;</span><span class="p">,</span> <span class="n">spy_on_heater_off</span><span class="p">())</span>

<span class="c1"># Confirm our buzzer works</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;buzz&#39;</span><span class="p">,</span> <span class="n">spy_on_buzz</span><span class="p">())</span>

<span class="hll"><span class="c1"># Confirm the buzzer timing features are working</span>
</span><span class="hll"><span class="n">test_buzz_timing</span><span class="p">()</span>
</span></pre></div>
</td></tr></table></div>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
</div>
<div class="section" id="iteration-6-questions">
<span id="iter6-questions"></span><h4>Iteration 6 questions<a class="headerlink" href="#iteration-6-questions" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="#zero-to-one-do-you-really-test-things-like-this6"><span class="std std-ref">Do you really test things like this?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-do-you-typically-use-timing-diagrams-with-your-design6"><span class="std std-ref">Do you typically use timing diagrams with your design?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-how-do-you-generate-the-ascii-sequence-diagrams-from-the-trace6"><span class="std std-ref">How do you generate the ASCII sequence diagrams from the trace?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-what-is-a-payload6"><span class="std std-ref">What is a payload?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-do-you-use-a-namedtuple-to-make-a-payload6"><span class="std std-ref">Why do you use a namedtuple to make a payload?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-why-should-payloads-be-immutable6"><span class="std std-ref">Why should payloads be immutable?</span></a></li>
<li><a class="reference internal" href="#zero-to-one-can-you-explain-the-timing-diagram6"><span class="std std-ref">Can you explain the timing diagram?</span></a></li>
</ul>
<p id="zero-to-one-do-you-really-test-things-like-this6"><strong>Do you really test things like this?</strong></p>
<p>No.  I mostly rely on the spy and trace instrumentation to determine if a design
is working or not.</p>
<p>The graph confirmation and mock tests seem like a good idea to me; these can be
added to a regression test without a lot of effort.  They won’t slow down
development progress and they aren’t tightly coupled to the specifics of the
implementation.</p>
<p>This can not be said for the timing tests.  They are expensive, because you need
to:</p>
<ul class="simple">
<li>parameterize your timing features so you can reduce the time it takes to make
the test. (complexity is added to make the system testable)</li>
<li>add tunable tolerancing to account for task jitter</li>
<li>manage time wrapping when testing in the millisecond domain</li>
<li>explain how the test works to a maintenance developer in your docstrings.</li>
</ul>
<p>The burden of carrying these tests may outweigh the benefits they offer.</p>
<p>It is a worthwhile investment to pay the high cost of such rigorous regression
tests, when it is difficult to decouple a system for debugging purposes.  It
also makes sense when you can’t see your code with a debugger, like if
you are meta-programming with Ruby.  As far as I can tell the <a class="reference external" href="https://www.youtube.com/watch?time_continue=3&amp;v=YX3iRjKj7C0">test everything
ethos came from this community</a>.</p>
<p>But if you are using the statechart architectural pattern, it is trivial to
build up an elaborate design using small and knowable parts, each part having
its own diagram and rich instrumentation.  If you need to debug something, you
can just drop into that part of the system and look at it’s picture to
understand how it works, then test it in isolation to see if it’s misbehaving.</p>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-do-you-typically-use-timing-diagrams-with-your-design6"><strong>Do you typically use timing diagrams with your design?</strong></p>
<p>No. I think they look good, but they quickly add to your technical debt.  So
only use them if you need them.</p>
<p>To explain what I mean consider what would happen if I change the number of
buzzes used to tell someone their food is done, from 2 to 3.</p>
<p>Now I have to remember to go back into the timing diagram and mess about with
the drawn pulses, I have to re-size the picture and make sure all of the words
fit.  I’m not adding a lot of value here and this work would slow me down.</p>
<p>In comparison, to change the number of pulses from 2 to 3 in the statechart
diagram I would update one character in its picture, and I would be done.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Timing diagrams should be generative; they should automatically be
constructed from the instrumentation output.  I did this work for the
construction of the sequence diagrams but I did not do it for the timing
diagrams.</p>
</div>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-how-do-you-generate-the-ascii-sequence-diagrams-from-the-trace6"><strong>How do you generate the ASCII sequence diagrams from the trace?</strong></p>
<p>You can read about that <a class="reference internal" href="reading_diagrams.html#reading-diagrams-sequence-diagrams"><span class="std std-ref">here</span></a>.</p>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-what-is-a-payload6"><strong>What is a payload?</strong></p>
<p>The payload is the thing within the event.  You can use this to pass whatever
information you want between threads.  In our case we use a payload to
describe the number of buzz pulses:  The event is passed from the statechart to
a one shot thread and then from the one shot thread back to the statechart.
When the statechart receives the <code class="docutils literal notranslate"><span class="pre">Get_Ready</span></code> or <code class="docutils literal notranslate"><span class="pre">Done</span></code> events, it can look
within those event payloads to get the number of times we want the buzzer to
pulse:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># e is the event</span>
<span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">buzz_times</span>
</pre></div>
</div>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-do-you-use-a-namedtuple-to-make-a-payload6"><strong>Why do you use a namedtuple to make a payload?</strong></p>
<p>Nametuples are immutable and they are easy to make and describe; they make great payload data structures.</p>
<p>You don’t have to use a namedtuple; but I advice that you use something immutable.</p>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-why-should-payloads-be-immutable6"><strong>Why should payloads be immutable?</strong></p>
<p>Immutable means that it can’t be changed once it’s written.  This immutability
is precisely what we want because we are sharing information between two
different threads which operate at different times and have no knowledge of one
another.  If both threads try to change the information they share, as some
underlying process task-switches between them, the information will become
scrambled for both threads.</p>
<p>You can see how this could lead to a nasty bug.  These kinds of bugs appear to
happen randomly; so they are extremely difficult to reproduce and fix.  In fact,
this is why people advise against the use of threads.</p>
<p>If you do share memory between threads, you need to provide a locking mechanism.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is what the <a class="reference external" href="https://realpython.com/python-gil/#what-problem-did-the-gil-solve-for-python">GIL</a>
does in Python, it’s a locking mechanism that has gotten a lot of bad press.</p>
</div>
<p>Or, you can take a Charlie Munger approach and just pre-avoid the mistake:</p>
<p>Miros doesn’t share memory, so it doesn’t use a locking mechanism, it just
copies the data from one thing into the queue of another thing.  But, there is a
chance that Python won’t actually make a copy of your data, it might use a
reference (I can’t claim to understand the implementation details of Python
memory management.)</p>
<p>So to pre-lock all of your data in the payload, use an immutable data structure.
If you can’t change the data once it is written, you can’t have a bug.  This is
why namedtuples are great event payloads.</p>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<p id="zero-to-one-can-you-explain-the-timing-diagram6"><strong>Can you explain the timing diagram?</strong></p>
<p>The timing diagram contains two signals: the “hardware Timing” as the blue line
and the “Statemachine Timing” as the red line.  The horizontal axis is time and
the vertical axis represents voltage.</p>
<p>Monitoring a voltage change on the hardware makes sense but it doesn’t really
make sense when we are thinking about the statemachine.  So we need to wave our
hands and pretend we have peppered hardware-bit-toggling code through out the
statemachine and we are monitoring the output of its pin’s voltage with an
oscilloscope.  We aren’t going to do this, but you know it is possible.  If it
where added to the code, the results would be used to construct the
“Statemachine Timing” signal.</p>
<p>The positive edge would map to the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> call initiating the oneshot and
the negative edge would map to the moment the task managing the one shot
began to run.</p>
<a class="reference external image-reference" href="_static/ToasterOven_6_Timing_Diagram.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_6_Timing_Diagram.svg" src="_images/ToasterOven_6_Timing_Diagram.svg" /></div>
</a>
<p>The “thread start latency” is the time between when we want to initiate a one-shot or
multi-shot task, and when it actually starts.  This latency might be very small,
but it will always be there.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This “thread start latency” will very depending upon which version of python
you run, your os, your hardware etc.  It will not be reliably consistent.  If you need
tight time tolerancing switch to qp.</p>
</div>
<p>Here is the timing diagram with the code that initiates the timing.</p>
<a class="reference external image-reference" href="_static/ToasterOven_6_Timing_Diagram_2.pdf"><div align="center" class="align-center"><img alt="_images/ToasterOven_6_Timing_Diagram_2.svg" src="_images/ToasterOven_6_Timing_Diagram_2.svg" /></div>
</a>
<p>The diagram displays two different kinds of deferred event patterns.  The
“Get_Ready Oneshot” and “Done Oneshot” events occur sometime after they are
initiated, they are deferred.</p>
<p>This is not true for the buzz one-shot and multi-shot, they trigger almost
immediately after being started.</p>
<a class="reference internal" href="zero_to_one.html#iter5"<span class="std-ref">prev</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-spec"<span class="std-ref">spec</span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-design"<span class="std-ref">design</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-code"<span class="std-ref">code</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-proof"<span class="std-ref">proof</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter6-questions"<span class="std-ref">questions</span></a></span></a>,
<a class="reference internal" href="zero_to_one.html#iter7"><span class="std std-ref">next</span></a><hr class="docutils" />
<a class="reference internal" href="quickstart.html"<span class="std-ref">prev</span></a>, <a class="reference internal" href="index.html#top"><span class="std std-ref">top</span></a>, <a class="reference internal" href="reading_diagrams.html"><span class="std std-ref">next</span></a></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial: Zero To One</a><ul>
<li><a class="reference internal" href="#story">Story</a></li>
<li><a class="reference internal" href="#a-simple-example-toaster-oven">A Simple Example: Toaster Oven</a><ul>
<li><a class="reference internal" href="#iteration-1-setup">Iteration 1: setup</a><ul>
<li><a class="reference internal" href="#iteration-1-specification">Iteration 1 specification</a></li>
<li><a class="reference internal" href="#iteration-1-design">Iteration 1 design</a></li>
<li><a class="reference internal" href="#iteration-1-code">Iteration 1 code</a></li>
<li><a class="reference internal" href="#iteration-1-proof">Iteration 1 proof</a></li>
<li><a class="reference internal" href="#iteration-1-questions">Iteration 1 questions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iteration-2-basic-oven">Iteration 2: basic oven</a><ul>
<li><a class="reference internal" href="#iteration-2-specification">Iteration 2 specification</a></li>
<li><a class="reference internal" href="#iteration-2-design">Iteration 2 design</a></li>
<li><a class="reference internal" href="#iteration-2-code">Iteration 2 code</a></li>
<li><a class="reference internal" href="#iteration-2-proof">Iteration 2 proof</a></li>
<li><a class="reference internal" href="#iteration-2-questions">Iteration 2 questions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iteration-3-history">Iteration 3: history</a><ul>
<li><a class="reference internal" href="#iteration-3-specification">Iteration 3 specification</a></li>
<li><a class="reference internal" href="#iteration-3-design">Iteration 3 design</a></li>
<li><a class="reference internal" href="#iteration-3-code">Iteration 3 code</a></li>
<li><a class="reference internal" href="#iteration-3-proof">Iteration 3 proof</a></li>
<li><a class="reference internal" href="#iteration-3-questions">Iteration 3 questions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iteration-4-hook-testing-and-hardware-abstraction">Iteration 4: hook, testing and hardware abstraction</a><ul>
<li><a class="reference internal" href="#iteration-4-specification">Iteration 4 specification</a></li>
<li><a class="reference internal" href="#iteration-4-design">Iteration 4 design</a></li>
<li><a class="reference internal" href="#iteration-4-code">Iteration 4 code</a></li>
<li><a class="reference internal" href="#iteration-4-proof">Iteration 4 proof</a></li>
<li><a class="reference internal" href="#iteration-4-questions">Iteration 4 questions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iteration-5-time-and-one-shots">Iteration 5: time and one-shots</a><ul>
<li><a class="reference internal" href="#iteration-5-specification">Iteration 5 specification</a></li>
<li><a class="reference internal" href="#iteration-5-design">Iteration 5 design</a></li>
<li><a class="reference internal" href="#iteration-5-code">Iteration 5 code</a></li>
<li><a class="reference internal" href="#iteration-5-proof">Iteration 5 proof</a></li>
<li><a class="reference internal" href="#iteration-5-questions">Iteration 5 questions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iteration-6-multi-shot-events-and-payloads">Iteration 6: Multi-Shot events and Payloads</a><ul>
<li><a class="reference internal" href="#iteration-6-specification">Iteration 6 specification</a></li>
<li><a class="reference internal" href="#iteration-6-design">Iteration 6 design</a></li>
<li><a class="reference internal" href="#iteration-6-code">Iteration 6 code</a></li>
<li><a class="reference internal" href="#iteration-6-proof">Iteration 6 proof</a></li>
<li><a class="reference internal" href="#iteration-6-questions">Iteration 6 questions</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="quickstart.html" title="previous chapter">Quick Start</a></li>
      <li>Next: <a href="reading_diagrams.html" title="next chapter">Diagrams</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/zero_to_one.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Scott Volk.
      
      |
      <a href="_sources/zero_to_one.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>