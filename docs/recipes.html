
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Recipes &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reflection" href="reflection.html" />
    <link rel="prev" title="Mongol Horse Archer" href="i_mongol_example.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <blockquote>
<div><p><em>Simple things should be simple, complex things should be possible.</em></p>
<p class="attribution">&mdash;Alan Kay</p>
</div></blockquote>
<div class="section" id="recipes-recipes">
<span id="recipes"></span><span id="id1"></span><h1><a class="toc-backref" href="#id8">Recipes</a><a class="headerlink" href="#recipes-recipes" title="Permalink to this headline">Â¶</a></h1>
<p>This section contains a set of examples that can be referenced as you are
building up your own programs.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#recipes-recipes" id="id8">Recipes</a><ul>
<li><a class="reference internal" href="#demonstration-of-capabilities" id="id9">Demonstration of Capabilities</a><ul>
<li><a class="reference internal" href="#state-abstraction-in-miros" id="id10">State Abstraction in Miros</a></li>
<li><a class="reference internal" href="#minimal-viable-states" id="id11">Minimal Viable States</a></li>
<li><a class="reference internal" href="#attachment-points-and-a-working-state-machine" id="id12">Attachment Points and a Working State Machine</a></li>
<li><a class="reference internal" href="#feedback-about-behavior-through-instrumentation" id="id13">Feedback about Behavior through Instrumentation</a></li>
<li><a class="reference internal" href="#entry-conditions-and-handled-events" id="id14">Entry Conditions and Handled Events</a></li>
<li><a class="reference internal" href="#exit-conditions" id="id15">Exit Conditions</a></li>
<li><a class="reference internal" href="#inventing-your-own-signals-external-events" id="id16">Inventing your own Signals: External events</a></li>
<li><a class="reference internal" href="#hooks" id="id17">Hooks</a></li>
<li><a class="reference internal" href="#comprehensive-instrumentation-with-the-live-spy-and-scribble" id="id18">Comprehensive Instrumentation with the live_spy and scribble</a></li>
<li><a class="reference internal" href="#attaching-more-than-one-activeobject-to-an-hsm" id="id19">Attaching More than one ActiveObject to an HSM</a></li>
<li><a class="reference internal" href="#making-the-live-instrumentation-use-the-python-logger" id="id20">Making the Live Instrumentation use the Python Logger</a></li>
<li><a class="reference internal" href="#making-a-statechart-from-a-class" id="id21">Making a Statechart from a class</a></li>
<li><a class="reference internal" href="#communication-between-statecharts" id="id22">Communication between Statecharts</a></li>
<li><a class="reference internal" href="#overload-a-state-in-a-subclass" id="id23">Overload a State in a Subclass</a></li>
<li><a class="reference internal" href="#one-shots-multi-shots-and-heartbeats" id="id24">One-Shots, Multi-Shots and Heartbeats</a></li>
<li><a class="reference internal" href="#creating-thread-safe-class-attributes" id="id25">Creating thread-safe class Attributes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#states" id="id26">States</a><ul>
<li><a class="reference internal" href="#state-function-recipes" id="id27">State Function Recipes</a><ul>
<li><a class="reference internal" href="#boiler-plate-state-function-code" id="id28">Boiler-plate State Function Code</a></li>
<li><a class="reference internal" href="#describing-your-parent-state-function" id="id29">Describing your Parent State Function</a></li>
<li><a class="reference internal" href="#passing-events-to-the-parent-state-function" id="id30">Passing events to the Parent State Function</a></li>
<li><a class="reference internal" href="#transition-to-another-state-function" id="id31">Transition to another State Function</a></li>
<li><a class="reference internal" href="#state-function-entry-code" id="id32">State Function Entry Code</a></li>
<li><a class="reference internal" href="#state-function-initialization-code" id="id33">State Function Initialization Code</a></li>
<li><a class="reference internal" href="#state-function-exit-code" id="id34">State Function Exit Code</a></li>
<li><a class="reference internal" href="#creating-a-hook-in-a-state-function" id="id35">Creating a Hook in a State function</a></li>
<li><a class="reference internal" href="#catch-and-release-in-a-state-function" id="id36">Catch and Release in a State function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#state-method-recipes" id="id37">State Method Recipes</a><ul>
<li><a class="reference internal" href="#boiler-plate-state-method" id="id38">Boiler-plate State Method</a></li>
<li><a class="reference internal" href="#boiler-plate-state-handler-method" id="id39">Boiler-plate State Handler Method</a></li>
<li><a class="reference internal" href="#describing-your-parent-state-using-the-factory" id="id40">Describing your Parent State using the Factory</a></li>
<li><a class="reference internal" href="#passing-events-to-the-parent-state-method" id="id41">Passing Events to the Parent State Method</a></li>
<li><a class="reference internal" href="#transition-to-another-state-method" id="id42">Transition to another State Method</a></li>
<li><a class="reference internal" href="#state-handlers-for-entry-exit-and-initialization-signals" id="id43">State Handlers for Entry/Exit and Initialization Signals</a></li>
<li><a class="reference internal" href="#creating-a-hook-in-a-state-handler" id="id44">Creating a Hook in a State Handler</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#events-and-signals" id="id45">Events And Signals</a><ul>
<li><a class="reference internal" href="#creating-an-event" id="id46">Creating an Event</a></li>
<li><a class="reference internal" href="#creating-a-signal" id="id47">Creating a Signal</a></li>
<li><a class="reference internal" href="#posting-events" id="id48">Posting Events</a></li>
<li><a class="reference internal" href="#posting-an-event-to-the-fifo" id="id49">Posting an Event to the Fifo</a></li>
<li><a class="reference internal" href="#posting-an-event-to-the-lifo" id="id50">Posting an Event to the LIFO</a></li>
<li><a class="reference internal" href="#create-a-guard" id="id51">Create a Guard</a></li>
<li><a class="reference internal" href="#creating-a-one-shot-event" id="id52">Creating a One-Shot Event</a></li>
<li><a class="reference internal" href="#creating-a-multishot-event" id="id53">Creating a Multishot Event</a></li>
<li><a class="reference internal" href="#canceling-a-specific-event-source" id="id54">Canceling a Specific Event Source</a></li>
<li><a class="reference internal" href="#canceling-event-source-by-signal-name" id="id55">Canceling Event Source By Signal Name</a></li>
<li><a class="reference internal" href="#deferring-and-recalling-an-event" id="id56">Deferring and Recalling an Event</a></li>
<li><a class="reference internal" href="#adding-a-payload-to-an-event" id="id57">Adding a Payload to an Event</a></li>
<li><a class="reference internal" href="#determining-if-an-event-has-a-payload" id="id58">Determining if an Event Has a Payload</a></li>
<li><a class="reference internal" href="#subscribing-to-an-event-posted-by-another-active-object" id="id59">Subscribing to an Event Posted by Another Active Object</a></li>
<li><a class="reference internal" href="#publishing-events-to-other-active-objects" id="id60">Publishing events to other Active Objects</a></li>
<li><a class="reference internal" href="#avoiding-bugs-which-travel-through-time" id="id61">Avoiding Bugs Which Travel Through Time</a></li>
<li><a class="reference internal" href="#avoiding-double-time-heart-beat-bugs" id="id62">Avoiding double time heart beat bugs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoiding-heart-beat-bleed-bugs" id="id63">Avoiding Heart-Beat-Bleed Bugs</a></li>
<li><a class="reference internal" href="#activeobjects" id="id64">ActiveObjects</a><ul>
<li><a class="reference internal" href="#starting-an-activeobject" id="id65">Starting an ActiveObject</a></li>
<li><a class="reference internal" href="#stopping-an-activeobject" id="id66">Stopping an ActiveObject</a></li>
<li><a class="reference internal" href="#augmentng-your-activeobject" id="id67">Augmentng your ActiveObject</a></li>
<li><a class="reference internal" href="#sharing-attributes-between-threads-activeobjects" id="id68">Sharing Attributes between Threads (ActiveObjects)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#factories" id="id69">Factories</a><ul>
<li><a class="reference internal" href="#creating-a-statechart-inside-of-a-class" id="id70">Creating a Statechart Inside of a Class</a></li>
<li><a class="reference internal" href="#inheritance-and-starting-factories" id="id71">Inheritance and Starting (Factories)</a></li>
<li><a class="reference internal" href="#sharing-attributes-between-threads-factories" id="id72">Sharing Attributes between Threads (Factories)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiple-statecharts" id="id73">Multiple Statecharts</a><ul>
<li><a class="reference internal" href="#building-and-destroying-workers" id="id74">Building and Destroying Workers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#seeing-what-is-going-on" id="id75">Seeing What is Going On</a><ul>
<li><a class="reference internal" href="#determining-the-current-state" id="id76">Determining the Current State</a></li>
<li><a class="reference internal" href="#seeing-what-signals-you-have-in-your-system" id="id77">Seeing what Signals You Have In Your System</a></li>
<li><a class="reference internal" href="#using-the-trace" id="id78">Using the Trace</a></li>
<li><a class="reference internal" href="#using-the-spy" id="id79">Using the Spy</a></li>
<li><a class="reference internal" href="#add-timing-information-to-the-spy" id="id80">Add Timing Information to the Spy</a></li>
<li><a class="reference internal" href="#tracing-live" id="id81">Tracing Live</a></li>
<li><a class="reference internal" href="#spying-live" id="id82">Spying Live</a></li>
<li><a class="reference internal" href="#scribble-on-the-spy" id="id83">Scribble On the Spy</a></li>
<li><a class="reference internal" href="#flatting-a-state-method" id="id84">Flatting a State Method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#describing-your-work" id="id85">Describing your Work</a><ul>
<li><a class="reference internal" href="#drawing-a-statechart" id="id86">Drawing a StateChart</a></li>
<li><a class="reference internal" href="#drawing-a-sequence-diagram" id="id87">Drawing a Sequence Diagram</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing" id="id88">Testing</a><ul>
<li><a class="reference internal" href="#using-a-trace-as-a-test-target" id="id89">Using a Trace As a Test Target</a></li>
<li><a class="reference internal" href="#using-a-spy-as-a-test-target" id="id90">Using a Spy as a Test Target</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="demonstration-of-capabilities">
<span id="recipes-demo"></span><h2><a class="toc-backref" href="#id9">Demonstration of Capabilities</a><a class="headerlink" href="#demonstration-of-capabilities" title="Permalink to this headline">Â¶</a></h2>
<p>In this section Iâll show you how you can use the miros library by layering more
and more of its features into a simple program.  This program will be arbitrary,
it serves no purpose other than to show how to do some common things.</p>
<div class="contents local topic" id="id2">
<ul class="simple">
<li><a class="reference internal" href="#state-abstraction-in-miros" id="id91">State Abstraction in Miros</a></li>
<li><a class="reference internal" href="#minimal-viable-states" id="id92">Minimal Viable States</a></li>
<li><a class="reference internal" href="#attachment-points-and-a-working-state-machine" id="id93">Attachment Points and a Working State Machine</a></li>
<li><a class="reference internal" href="#feedback-about-behavior-through-instrumentation" id="id94">Feedback about Behavior through Instrumentation</a></li>
<li><a class="reference internal" href="#entry-conditions-and-handled-events" id="id95">Entry Conditions and Handled Events</a></li>
<li><a class="reference internal" href="#exit-conditions" id="id96">Exit Conditions</a></li>
<li><a class="reference internal" href="#inventing-your-own-signals-external-events" id="id97">Inventing your own Signals: External events</a></li>
<li><a class="reference internal" href="#hooks" id="id98">Hooks</a></li>
<li><a class="reference internal" href="#comprehensive-instrumentation-with-the-live-spy-and-scribble" id="id99">Comprehensive Instrumentation with the live_spy and scribble</a></li>
<li><a class="reference internal" href="#attaching-more-than-one-activeobject-to-an-hsm" id="id100">Attaching More than one ActiveObject to an HSM</a></li>
<li><a class="reference internal" href="#making-the-live-instrumentation-use-the-python-logger" id="id101">Making the Live Instrumentation use the Python Logger</a></li>
<li><a class="reference internal" href="#making-a-statechart-from-a-class" id="id102">Making a Statechart from a class</a></li>
<li><a class="reference internal" href="#communication-between-statecharts" id="id103">Communication between Statecharts</a></li>
<li><a class="reference internal" href="#overload-a-state-in-a-subclass" id="id104">Overload a State in a Subclass</a></li>
<li><a class="reference internal" href="#one-shots-multi-shots-and-heartbeats" id="id105">One-Shots, Multi-Shots and Heartbeats</a></li>
<li><a class="reference internal" href="#creating-thread-safe-class-attributes" id="id106">Creating thread-safe class Attributes</a></li>
</ul>
</div>
<div class="section" id="state-abstraction-in-miros">
<span id="recipes-state-abstraction"></span><h3><a class="toc-backref" href="#id91">State Abstraction in Miros</a><a class="headerlink" href="#state-abstraction-in-miros" title="Permalink to this headline">Â¶</a></h3>
<p>In miros a state is a behavioral specification for an event processor.  A state
is a function that does the following:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>It accepts two arguments:</dt>
<dd><ol class="first last arabic">
<li>an object of type/subclass of <code class="docutils literal notranslate"><span class="pre">miros.ActiveObject</span></code>, which has an event processor.</li>
<li>an event of type/subclass of  <code class="docutils literal notranslate"><span class="pre">miros.Event</span></code></li>
</ol>
</dd>
</dl>
</li>
<li>It describes how it is situated in a hierarchy and how it is connected to
other states, by changing the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> attribute of itâs first argument.</li>
<li>It returns an <code class="docutils literal notranslate"><span class="pre">miros.return_status</span></code> attribute, which tells the event processor
how the state function reacted to the event.</li>
</ul>
<p>The user starts and then posts events to the ActiveObject, and its event
processor reacts to these events by calling your state functions over and over
again with a set of internal and external events.  The internal events are used
to search the hierarchical state machine, to run itâs entry and exit conditions
and to initialize the state once it has been settled into.  The external events
are user defined (more will be said about this shortly).</p>
<p>The state functions do two different things, they describe how they are
topologically related to other states and they contain code which will run as
the event processor calls them over and over again.  What emerges from this
interplay is a Hierarchical State Machine (HSM) behavior which follows the Harel
Formalism (picture-to-behavior rules).</p>
<p>Now that we understand a bit of theory and how the miros abstraction works,
letâs write some code.</p>
</div>
<div class="section" id="minimal-viable-states">
<span id="recipes-minimal-viable-states"></span><h3><a class="toc-backref" href="#id92">Minimal Viable States</a><a class="headerlink" href="#minimal-viable-states" title="Permalink to this headline">Â¶</a></h3>
<p>In a statechart diagram, a state is represented by a named rounded rectangle.
In a hierarchical state machine a state can exist within a state.  Here we see
an inner_state placed within an outer_state:</p>
<a class="reference external image-reference" href="_static/state_recipe_1.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_1.svg" src="_images/state_recipe_1.svg" /></div>
</a>
<p>Every state function, must at least describe where it is situated in the HSM
hierarchy. Here is the miros code for the above diagram:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">   <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>  <span class="c1"># describe how we fit in the hierarchy</span>
</span>   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>  <span class="c1"># describe how we reacted to the event</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">   <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>  <span class="c1"># describe how we fit in the hierarchy</span>
</span>   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>  <span class="c1"># describe how we reacted to the event</span>
   <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Above we see two minimal-viable state functions, which react to every possible
event the same way.  They set the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> to their super state (itâs outer
state) and return a status telling the event processor that they did this.</p>
<p>Now that we know how to make a minimal-viable state function, and how it relates to a
hierarchical state machine, letâs talk about how to connect it to a thread, how
to start it and how to give it some behavior.</p>
</div>
<div class="section" id="attachment-points-and-a-working-state-machine">
<span id="recipes-attachment-points-and-a-working-state-machine"></span><h3><a class="toc-backref" href="#id93">Attachment Points and a Working State Machine</a><a class="headerlink" href="#attachment-points-and-a-working-state-machine" title="Permalink to this headline">Â¶</a></h3>
<p>A state function is lazy about how it describes its graphical relationship to
the other states in its hierarchical state machine.  To ask it a question about
how it sits in the hierarchy, or how it is connected to another part of the
state machine, the event processor needs to send it an event.  The state
function will respond by setting itâs return status to something and it will
change the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> attribute of its first argument.</p>
<p>But before it can do either of these things, an event processor needs to be
connected to a state function.  This is done with the Active objectâs <code class="docutils literal notranslate"><span class="pre">start_at</span></code>
method.  On the diagram, this is called the attachment point.  It is where the
ball and the socket meet.</p>
<p>Iâll redraw our simple state machine with some more details:</p>
<a class="reference external image-reference" href="_static/state_recipe_2.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_2.svg" src="_images/state_recipe_2.svg" /></div>
</a>
<p>The above diagram is saying that there is an attachment point between an
<code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> and the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code>.  To create and run a state machine, we
will instantiate the <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code>, then <code class="docutils literal notranslate"><span class="pre">start_at</span></code> the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code>.
When we call this <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method, the miros library will create a thread
for this statechart and run it until the main program is stopped.</p>
<p>We have also added a new graphing element called the init pseudostate, the black
dot.  The black dot has an arrow pointing to the <code class="docutils literal notranslate"><span class="pre">inner_state</span></code>.  This means,
after I have entered into the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> and I have settled, transition
into the <code class="docutils literal notranslate"><span class="pre">inner_state</span></code>.</p>
<p>To make our new design work, we will have to change our <code class="docutils literal notranslate"><span class="pre">outer_state</span></code>
function.  It will need to provide graphical information about an init event.
It will set the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> to <code class="docutils literal notranslate"><span class="pre">inner_state</span></code> and it will have to tell the
event processor it needs to perform a transition into another state.  This is
all done within the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">import</span> <span class="nn">time</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span>   <span class="c1"># the event processor is asking us about events called INIT_SIGNAL</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="c1"># we are transitioning to inner_state</span>
</span><span class="hll">     <span class="c1"># we let the trans method, set temp.fun and our return status</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
</span>   <span class="c1"># we do this for any other event</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="c1"># we do this for all events</span>
   <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;ao&#39;</span><span class="p">)</span>

   <span class="c1"># Create a thread and start our state machine</span>
<span class="hll">   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
</span>
   <span class="c1"># Run our main program so that the state machine&#39;s thread</span>
   <span class="c1"># can do some stuff.</span>
   <span class="c1"># The state machine&#39;s thread will be stopped when our main thread stops</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>I have highlighted the code that would cause the init transition and the
attachment point (<code class="docutils literal notranslate"><span class="pre">start_at</span></code>).  If we run this code, the statechart will start
in the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code>, then settle, then transition into the <code class="docutils literal notranslate"><span class="pre">inner_state</span></code>.
But you will have to trust me about this, since the code doesnât provide any
user feedback.</p>
<p>Now that we know how to build and start a small statechart.  Letâs look at
how to instrument it so it provides feedback about its behavior.</p>
</div>
<div class="section" id="feedback-about-behavior-through-instrumentation">
<span id="recipes-feedback-about-behavior-through-instrumentation"></span><h3><a class="toc-backref" href="#id94">Feedback about Behavior through Instrumentation</a><a class="headerlink" href="#feedback-about-behavior-through-instrumentation" title="Permalink to this headline">Â¶</a></h3>
<p>We will include the <code class="docutils literal notranslate"><span class="pre">spy_on</span></code> decorator from the miros library, then we will
use it to decorate our state functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">import</span> <span class="nn">time</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="hll"> <span class="nd">@spy_on</span>  <span class="c1"># enables the live_trace/live_spy capabilities</span>
</span> <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="c1"># the event processor is asking us about events called INIT_SIGNAL</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="c1"># we are transitioning to inner_state</span>
     <span class="c1"># we let the trans method, set temp.fun and our return status</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="c1"># we do this for any other event</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

<span class="hll"> <span class="nd">@spy_on</span>  <span class="c1"># enables the live_trace/live_spy capabilities</span>
</span> <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="c1"># we do this for all events</span>
   <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;ao&#39;</span><span class="p">)</span>
<span class="hll">   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># so we can see what is happening</span>
</span>   <span class="c1"># Create a thread and start our state machine</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="c1"># Run our main program so that the state machine&#39;s thread</span>
   <span class="c1"># can do some stuff.</span>
   <span class="c1"># The state machine&#39;s thread will be stopped when our main thread stops</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;spy_on</span></code> decorators enables the live_trace and live_spy instrumentation
capabilities of the statechart library.</p>
<p>So if I run the above code I will see something like this in my terminal:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">22</span> <span class="mi">12</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">34.050461</span><span class="p">]</span> <span class="p">[</span><span class="n">ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">inner_state</span>
</pre></div>
</div>
<p>Now that we know how to instrument a statechart, letâs look at how to add some
state entry conditions.</p>
</div>
<div class="section" id="entry-conditions-and-handled-events">
<span id="recipes-entry-conditions-and-handled-events"></span><h3><a class="toc-backref" href="#id95">Entry Conditions and Handled Events</a><a class="headerlink" href="#entry-conditions-and-handled-events" title="Permalink to this headline">Â¶</a></h3>
<p>We will add some entry code to both the outer_state and inner_state functions:</p>
<a class="reference external image-reference" href="_static/state_recipe_3.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_3.svg" src="_images/state_recipe_3.svg" /></div>
</a>
<p>The above diagram is saying, when we enter the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code>, run a print
statement.  Then settle, which will cause an init transition into the
<code class="docutils literal notranslate"><span class="pre">inner_state</span></code>.  When we enter the <code class="docutils literal notranslate"><span class="pre">inner_state</span></code> run a different print
statement.  If a state function receives an entry event, we donât want to change
our active state and we donât want to describe our super state.  We just want to
run some code, then tell the event processor that the event was handled so it
will stop trying to figure out what to do with it.</p>
<p>Here is the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_3.py</span>
 <span class="kn">import</span> <span class="nn">time</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="c1"># the event process automatically sends</span>
   <span class="c1"># an event named ENTRY_SIGNAL when a state is entered</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="c1"># the event process automatically sends</span>
   <span class="c1"># an event named ENTRY_SIGNAL when a state is entered</span>
<span class="hll">   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;ao&#39;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If we run the code we see something like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hello from outer_state
init
hello from inner_state
<span class="o">[</span><span class="m">2019</span>-07-22 <span class="m">12</span>:22:34.050461<span class="o">]</span> <span class="o">[</span>ao<span class="o">]</span> e-&gt;start_at<span class="o">()</span> top-&gt;inner_state
</pre></div>
</div>
<p>So far we have been talking about signals that are included within the
miros library: INIT_SIGNAL, ENTRY_SIGNAL.</p>
<p>Letâs adjust our design to use another internal signal, EXIT_SIGNAL.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you use miros to build active objects, you are making a multithreaded
system.  Pythonâs <code class="docutils literal notranslate"><span class="pre">print</span></code> function is not thread safe, which means if two or
more of your active objects try to print something at the exact same time, a
run time error could occur.</p>
<p class="last">As of miros <code class="docutils literal notranslate"><span class="pre">4.2.1</span></code> miros provides a thread safe <code class="docutils literal notranslate"><span class="pre">print</span></code> function.  To
access it in this example you could write <code class="docutils literal notranslate"><span class="pre">self.print(&quot;hello</span> <span class="pre">from</span>
<span class="pre">inner_state&quot;)</span></code> instead of <code class="docutils literal notranslate"><span class="pre">print(&quot;hello</span> <span class="pre">from</span> <span class="pre">inner_state&quot;)</span></code>.</p>
</div>
</div>
<div class="section" id="exit-conditions">
<span id="recipes-exit-conditions"></span><h3><a class="toc-backref" href="#id96">Exit Conditions</a><a class="headerlink" href="#exit-conditions" title="Permalink to this headline">Â¶</a></h3>
<a class="reference external image-reference" href="_static/state_recipe_4.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_4.svg" src="_images/state_recipe_4.svg" /></div>
</a>
<p>Our new design describes some code that will run when we exit either state.  But
how would we ever exit?  There is nothing on our diagram that can cause an exit,
we can only climb into the inner_state, then sit their forever.</p>
<p>To add some more behavior, we will have to invent a signal.</p>
</div>
<div class="section" id="inventing-your-own-signals-external-events">
<span id="recipes-inventing-your-own-signals"></span><h3><a class="toc-backref" href="#id97">Inventing your own Signals: External events</a><a class="headerlink" href="#inventing-your-own-signals-external-events" title="Permalink to this headline">Â¶</a></h3>
<p>Letâs invent a signal and call it <code class="docutils literal notranslate"><span class="pre">Reset</span></code>, because it will reset the chart, or
put it back into the state it was when we first started it at the
<code class="docutils literal notranslate"><span class="pre">outer_state</span></code>.  Any signal that is not an internal signal, like INIT_SIGNAL,
ENTRY_SIGNAL, EXIT_SIGNAL.. is called an external signal.  In this case our
external signal <code class="docutils literal notranslate"><span class="pre">Reset</span></code> will be invented the moment we write it into the code;
it is automatically declared.</p>
<p>So, how do we invent an event and give it a signal name and send it at our
chart?  Well, the chart runs in a thread and it has a set of queues that it
watches for events.  To send this chart information we just have to make an
event, assign it to a signal, then post it into one of these queues.  Here is
the code that will do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_5.py</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;resetting the chart&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;exiting outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s2">&quot;ao&quot;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
<span class="hll">   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
</span>   <span class="c1"># let the thread catch up before we exit main</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If we run this code we see the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>hello from outer_state
init
hello from inner_state
[2019-07-22 12:44:29.470827] [ao] e-&gt;start_at() top-&gt;inner_state
resetting the chart
exiting inner_state
exiting outer_state
hello from outer_state
init
hello from inner_state
[2019-07-22 12:44:29.471806] [ao] e-&gt;Reset() inner_state-&gt;inner_state
</pre></div>
</div>
<p>It behaves in a sensible way.  But there is something interesting going on.  The
state machine was in the <code class="docutils literal notranslate"><span class="pre">inner_state</span></code> when it got our <code class="docutils literal notranslate"><span class="pre">Reset</span></code> signal.  It
ran the print statement associated with this signal, while it was still in the
<code class="docutils literal notranslate"><span class="pre">inner_state</span></code> before it climbed out of the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> and the
<code class="docutils literal notranslate"><span class="pre">inner_state</span></code>, only to climb back into where it was.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Another way to think about internal and external signals is that internal
signals are sent from the event processor to the state functions without the
user explicitly asking it to do so.  But, external signals are only sent to the
chart when a user explicitly posts the event into the statechart.</p>
</div>
<p>So the event processor needed to follow some rules.  It needed to figure out how
and when to post each event to our two simple state functions.  It needed to
figure out, who was the super state of <code class="docutils literal notranslate"><span class="pre">inner_state</span></code> so it could call itâs
state function with the <code class="docutils literal notranslate"><span class="pre">Reset</span></code> event to see what it should do.</p>
<p>The event processor does this work, and it keeps you from having to write code
to solve these types of topological problems.  You just need to write simple
state functions, which act as a behavioral specification and then connect this
to an <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code>, start it, and then post events to it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The code that is on the init arrow in our diagram and the code that is listed
under entry and exit signals is run while the event processor is trying to
figure out what to do next.  The event processor is not aware of this code,
the code is run as a side-effect of its efforts to search the graph then act
upon its results.</p>
</div>
<p>What would have happened had our <code class="docutils literal notranslate"><span class="pre">Reset</span></code> <code class="docutils literal notranslate"><span class="pre">elif</span></code> clause just returned
<code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>?  There wouldnât have been a state transition.
When an event is caught this way it is called a hook.</p>
</div>
<div class="section" id="hooks">
<span id="recipes-hooks"></span><h3><a class="toc-backref" href="#id98">Hooks</a><a class="headerlink" href="#hooks" title="Permalink to this headline">Â¶</a></h3>
<p>Hook code can be run when you sent an event to the state or any of itâs
substates which has the name of that hook.  You are using the search feature of
the event processor to do work for you, without asking it to change the state of
your statechart as it reacts to your hook event.  This is easier to understand
with a picture.</p>
<a class="reference external image-reference" href="_static/state_recipe_6.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_6.svg" src="_images/state_recipe_6.svg" /></div>
</a>
<p>Here is the code, with the hook highlighted</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_6.py</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
<span class="hll">   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
</span><span class="hll">     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;resetting the chart&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;exiting outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
     <span class="k">print</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s2">&quot;ao&quot;</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
   <span class="c1"># let the thread catch up before we exit main</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If you run this code you will see something like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>hello from outer_state
init
hello from inner_state
[2019-07-22 13:13:59.860092] [ao] e-&gt;start_at() top-&gt;inner_state
run some code, but don&#39;t transition
resetting the chart
exiting inner_state
exiting outer_state
hello from outer_state
init
hello from inner_state
[2019-07-22 13:13:59.861465] [ao] e-&gt;Reset() inner_state-&gt;inner_state
</pre></div>
</div>
<p>We see that the â<code class="docutils literal notranslate"><span class="pre">run</span> <span class="pre">some</span> <span class="pre">code,</span> <span class="pre">but</span> <span class="pre">don't</span> <span class="pre">transition</span></code>â print output occurred
between the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call and the posting of the <code class="docutils literal notranslate"><span class="pre">Reset</span></code> event.  But there
is no mention of this hook in the time-stamped trace output.  This is because
the trace instrumentation only presents high level state transition information.
The trace intentionally hides details.</p>
<p>Print statements are useful if you want to see if something is working; but you
donât always want them cluttering up your code.</p>
</div>
<div class="section" id="comprehensive-instrumentation-with-the-live-spy-and-scribble">
<span id="recipes-comprehensive-instrumentation-with-the-live-spy"></span><h3><a class="toc-backref" href="#id99">Comprehensive Instrumentation with the live_spy and scribble</a><a class="headerlink" href="#comprehensive-instrumentation-with-the-live-spy-and-scribble" title="Permalink to this headline">Â¶</a></h3>
<p>The miros library provides a second kind of instrumentation when you wrap your
state functions inside of the <code class="docutils literal notranslate"><span class="pre">&#64;spy_on</span></code> decorators.  You can turn on the
<code class="docutils literal notranslate"><span class="pre">live_spy</span></code> instrumentation to spy on everything your event processor is
doing.  Instead of printing, you can inject your messages into this spy stream,
by using the <code class="docutils literal notranslate"><span class="pre">scribble</span></code> call.  Letâs change our design a bit to demonstrate
these features:</p>
<a class="reference external image-reference" href="_static/state_recipe_7.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_7.svg" src="_images/state_recipe_7.svg" /></div>
</a>
<p>Here is the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_7.py</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;resetting the chart&quot;</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting outer_state&quot;</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s2">&quot;ao&quot;</span><span class="p">)</span>
<span class="hll">   <span class="n">ao</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>
</span>   <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
   <span class="c1"># let the thread catch up before we exit main</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>If we run it we will see (I have highlighted the scribble statements):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> START
 SEARCH_FOR_SUPER_SIGNAL:outer_state
 ENTRY_SIGNAL:outer_state
<span class="hll"> hello from outer_state
</span> INIT_SIGNAL:outer_state
<span class="hll"> init
</span> SEARCH_FOR_SUPER_SIGNAL:inner_state
 ENTRY_SIGNAL:inner_state
<span class="hll"> hello from inner_state
</span> INIT_SIGNAL:inner_state
 &lt;- Queued:(0) Deferred:(0)
 Hook:inner_state
 Hook:outer_state
<span class="hll"> run some code, but don&#39;t transition
</span> Hook:outer_state:HOOK
 &lt;- Queued:(1) Deferred:(0)
 Reset:inner_state
 Reset:outer_state
<span class="hll"> resetting the chart
</span> EXIT_SIGNAL:inner_state
<span class="hll"> exiting inner_state
</span> SEARCH_FOR_SUPER_SIGNAL:inner_state
 EXIT_SIGNAL:outer_state
<span class="hll"> exiting outer_state
</span> ENTRY_SIGNAL:outer_state
<span class="hll"> hello from outer_state
</span> INIT_SIGNAL:outer_state
<span class="hll"> init
</span> SEARCH_FOR_SUPER_SIGNAL:inner_state
 ENTRY_SIGNAL:inner_state
<span class="hll"> hello from inner_state
</span> INIT_SIGNAL:inner_state
 &lt;- Queued:(0) Deferred:(0)
</pre></div>
</div>
<p>You can interleave the trace information into the spy information
by turning on both the <code class="docutils literal notranslate"><span class="pre">live_spy</span></code> and the <code class="docutils literal notranslate"><span class="pre">live_trace</span></code>.  This would result in
this output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[2019-07-26 06:29:33.774768] [ao] e-&gt;start_at() top-&gt;inner_state
START
SEARCH_FOR_SUPER_SIGNAL:outer_state
ENTRY_SIGNAL:outer_state
hello from outer_state
INIT_SIGNAL:outer_state
init
SEARCH_FOR_SUPER_SIGNAL:inner_state
ENTRY_SIGNAL:inner_state
hello from inner_state
INIT_SIGNAL:inner_state
&lt;- Queued:(0) Deferred:(0)
Hook:inner_state
Hook:outer_state
run some code, but don&#39;t transition
Hook:outer_state:HOOK
&lt;- Queued:(1) Deferred:(0)
[2019-07-26 06:29:33.776462] [ao] e-&gt;Reset() inner_state-&gt;inner_state
Reset:inner_state
Reset:outer_state
resetting the chart
EXIT_SIGNAL:inner_state
exiting inner_state
SEARCH_FOR_SUPER_SIGNAL:inner_state
EXIT_SIGNAL:outer_state
exiting outer_state
ENTRY_SIGNAL:outer_state
hello from outer_state
INIT_SIGNAL:outer_state
init
SEARCH_FOR_SUPER_SIGNAL:inner_state
ENTRY_SIGNAL:inner_state
hello from inner_state
INIT_SIGNAL:inner_state
&lt;- Queued:(0) Deferred:(0)
</pre></div>
</div>
<p>This kind of feedback will become more and more important to you as you build
more and more complex systems.</p>
<p>The attachment point between the <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> and the HSM in the diagram
serves double duty.  It shows that there is an event processor that is using
these two state functions and it shows where the HSM is started.  An
<code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> has its own thread and all of the state machines memory is held
within it.  The functions merely describe how and when different memory
operations should be performed, but the functions do not have their own memory.
For this reason, you can attach more than one <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> to the same HSM.</p>
</div>
<div class="section" id="attaching-more-than-one-activeobject-to-an-hsm">
<span id="recipes-attaching-more-than-one-active-object-to-an-hsm"></span><h3><a class="toc-backref" href="#id100">Attaching More than one ActiveObject to an HSM</a><a class="headerlink" href="#attaching-more-than-one-activeobject-to-an-hsm" title="Permalink to this headline">Â¶</a></h3>
<p>Here we see two different <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> objects attached to the same HSM.</p>
<a class="reference external image-reference" href="_static/state_recipe_8.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_8.svg" src="_images/state_recipe_8.svg" /></div>
</a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Technically speaking, the above UML diagram is incorrect.  A class should not
be drawn on a UML diagram more than once.  Iâm drawing it twice to make a
point.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">miros runs in python3.5 and above, so I am not using fstrings, since they were
not included in python3.5</p>
</div>
<p>Here is the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># simple_state_8.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: hello from outer_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: init&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: run some code, but don&#39;t transition&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: resetting the chart&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: exiting outer_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: hello from inner_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: exiting inner_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">ao1</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s2">&quot;ao1&quot;</span><span class="p">)</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

  <span class="n">ao2</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s2">&quot;ao2&quot;</span><span class="p">)</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
  <span class="c1"># let the thread catch up before we exit main</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>We have placed our print statements back into the state functions and we have
created two different <code class="docutils literal notranslate"><span class="pre">ActiveObjects</span></code> starting the first in the outer_state
and starting the second in the inner_state.  Then we send the <code class="docutils literal notranslate"><span class="pre">Hook</span></code> and
<code class="docutils literal notranslate"><span class="pre">Reset</span></code> events to both active objects.</p>
<p>Since each <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> runs in itâs own thread they will process their
events independent of each other; here is the output of this little program:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>ao1: hello from outer_state
ao1: init
ao1: hello from inner_state
[2019-07-26 07:41:53.077229] [ao1] e-&gt;start_at() top-&gt;inner_state
ao2: hello from outer_state
ao2: hello from inner_state
ao1: run some code, but don&#39;t transition
[2019-07-26 07:41:53.080259] [ao2] e-&gt;start_at() top-&gt;inner_state
ao1: resetting the chart
ao1: exiting inner_state
ao1: exiting outer_state
ao1: hello from outer_state
ao1: init
ao1: hello from inner_state
[2019-07-26 07:41:53.080885] [ao1] e-&gt;Reset() inner_state-&gt;inner_state
ao2: run some code, but don&#39;t transition
ao2: resetting the chart
ao2: exiting inner_state
ao2: exiting outer_state
ao2: hello from outer_state
ao2: init
ao2: hello from inner_state
[2019-07-26 07:41:53.082678] [ao2] e-&gt;Reset() inner_state-&gt;inner_state
</pre></div>
</div>
<p>We can see that our output is kind of messy.  The print messages are interleaved
because we have two ActiveObjects running in parallel, each in their own
thread.  It turns out that the <code class="docutils literal notranslate"><span class="pre">print</span></code> function is not thread safe, but the
Python logger is.</p>
</div>
<div class="section" id="making-the-live-instrumentation-use-the-python-logger">
<span id="recipes-over-riding-the-live-instrumentation-to-the-python-logger"></span><h3><a class="toc-backref" href="#id101">Making the Live Instrumentation use the Python Logger</a><a class="headerlink" href="#making-the-live-instrumentation-use-the-python-logger" title="Permalink to this headline">Â¶</a></h3>
<p>Letâs adjust our design a bit so that our live_trace and our live_spy will write
to the Python logger instead of the terminalâs output.</p>
<a class="reference external image-reference" href="_static/state_recipe_9.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_9.svg" src="_images/state_recipe_9.svg" /></div>
</a>
<p>We subclass the <code class="docutils literal notranslate"><span class="pre">Activeobject</span></code> into a class which âhas aâ logger.  This class will
have two custom instrumentation callbacks, one for our trace and one for our
spy.  We will instantiate the class twice, and start one of the statecharts in
the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> and the other in the <code class="docutils literal notranslate"><span class="pre">inner_state</span></code>.  Then we will send the
<code class="docutils literal notranslate"><span class="pre">Hook</span></code> and <code class="docutils literal notranslate"><span class="pre">Reset</span></code> events to both statecharts.</p>
<p>Here is the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># simple_state_9.py</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;resetting the chart&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting outer_state&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer_state</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">class</span> <span class="nc">ActiveObjectInstrumentToLog</span><span class="p">(</span><span class="n">ActiveObject</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;simple_state_9.log&#39;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
      <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
      <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="c1"># ActiveObject has a register_live_trace_callback and a</span>
    <span class="c1"># register_live_spy_callback interface, which can be used to</span>
    <span class="c1"># change the live_trace and live_spy behavior.  To use these</span>
    <span class="c1"># registration methods, you write a function which accepts a</span>
    <span class="c1"># string argument, provide this function as the input argument</span>
    <span class="c1"># to the registration method and your custom function will</span>
    <span class="c1"># stored, and then called each time a trace/spy string is</span>
    <span class="c1"># generated from within the ActiveObject&#39;s instrumentation</span>
    <span class="c1"># functions.  By providing your own functions, you can log</span>
    <span class="c1"># trace/spy information, or send it out over the network or do</span>
    <span class="c1"># whatever you like with it.</span>

    <span class="c1"># The register functions do not accept methods, they only accept</span>
    <span class="c1"># functions that take a single argument.  So we use the</span>
    <span class="c1"># functool.partial to create a function with the self baked into</span>
    <span class="c1"># it before it is passed into the register function. This way</span>
    <span class="c1"># when miros calls this function with a string, we do not get a</span>
    <span class="c1"># runtime error resulting from sending our customer function it</span>
    <span class="c1"># too few arguments.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;trace without datetime-stamp&#39;&#39;&#39;</span>
    <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;spy with machine name pre-pended&#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="n">ao1</span> <span class="o">=</span> <span class="n">ActiveObjectInstrumentToLog</span><span class="p">(</span><span class="s2">&quot;ao1&quot;</span><span class="p">)</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="n">ao2</span> <span class="o">=</span> <span class="n">ActiveObjectInstrumentToLog</span><span class="p">(</span><span class="s2">&quot;ao2&quot;</span><span class="p">)</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="n">ao1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer_state</span><span class="p">)</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">ao1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

  <span class="n">ao2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner_state</span><span class="p">)</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">ao2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

  <span class="c1"># let the threads catch up before we exit main</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>The log file created by this program would look something like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>2019-07-26 11:37:22,674 DEBUG:T: [ao1] e-&gt;start_at() top-&gt;inner_state
2019-07-26 11:37:22,675 DEBUG:S: [ao1] START
2019-07-26 11:37:22,675 DEBUG:S: [ao1] SEARCH_FOR_SUPER_SIGNAL:outer_state
2019-07-26 11:37:22,675 DEBUG:S: [ao1] ENTRY_SIGNAL:outer_state
2019-07-26 11:37:22,675 DEBUG:S: [ao1] hello from outer_state
2019-07-26 11:37:22,675 DEBUG:S: [ao1] INIT_SIGNAL:outer_state
2019-07-26 11:37:22,675 DEBUG:S: [ao1] init
2019-07-26 11:37:22,676 DEBUG:S: [ao1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-26 11:37:22,676 DEBUG:S: [ao1] ENTRY_SIGNAL:inner_state
2019-07-26 11:37:22,676 DEBUG:S: [ao1] hello from inner_state
2019-07-26 11:37:22,676 DEBUG:S: [ao1] INIT_SIGNAL:inner_state
2019-07-26 11:37:22,676 DEBUG:S: [ao1] &lt;- Queued:(0) Deferred:(0)
2019-07-26 11:37:22,678 DEBUG:T: [ao2] e-&gt;start_at() top-&gt;inner_state
2019-07-26 11:37:22,678 DEBUG:S: [ao2] START
2019-07-26 11:37:22,678 DEBUG:S: [ao2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-26 11:37:22,679 DEBUG:S: [ao2] SEARCH_FOR_SUPER_SIGNAL:outer_state
2019-07-26 11:37:22,679 DEBUG:S: [ao2] ENTRY_SIGNAL:outer_state
2019-07-26 11:37:22,679 DEBUG:S: [ao2] hello from outer_state
2019-07-26 11:37:22,679 DEBUG:S: [ao2] ENTRY_SIGNAL:inner_state
2019-07-26 11:37:22,679 DEBUG:S: [ao2] hello from inner_state
2019-07-26 11:37:22,679 DEBUG:S: [ao2] INIT_SIGNAL:inner_state
2019-07-26 11:37:22,680 DEBUG:S: [ao1] Hook:inner_state
2019-07-26 11:37:22,680 DEBUG:S: [ao2] &lt;- Queued:(0) Deferred:(0)
2019-07-26 11:37:22,680 DEBUG:S: [ao1] Hook:outer_state
2019-07-26 11:37:22,681 DEBUG:S: [ao1] run some code, but don&#39;t transition
2019-07-26 11:37:22,681 DEBUG:S: [ao1] Hook:outer_state:HOOK
2019-07-26 11:37:22,681 DEBUG:S: [ao1] &lt;- Queued:(1) Deferred:(0)
2019-07-26 11:37:22,682 DEBUG:T: [ao1] e-&gt;Reset() inner_state-&gt;inner_state
2019-07-26 11:37:22,682 DEBUG:S: [ao1] Reset:inner_state
2019-07-26 11:37:22,682 DEBUG:S: [ao1] Reset:outer_state
2019-07-26 11:37:22,682 DEBUG:S: [ao1] resetting the chart
2019-07-26 11:37:22,683 DEBUG:S: [ao1] EXIT_SIGNAL:inner_state
2019-07-26 11:37:22,683 DEBUG:S: [ao1] exiting inner_state
2019-07-26 11:37:22,683 DEBUG:S: [ao1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-26 11:37:22,683 DEBUG:S: [ao1] EXIT_SIGNAL:outer_state
2019-07-26 11:37:22,683 DEBUG:S: [ao1] exiting outer_state
2019-07-26 11:37:22,683 DEBUG:S: [ao1] ENTRY_SIGNAL:outer_state
2019-07-26 11:37:22,684 DEBUG:S: [ao2] Hook:inner_state
2019-07-26 11:37:22,684 DEBUG:S: [ao1] hello from outer_state
2019-07-26 11:37:22,684 DEBUG:S: [ao2] Hook:outer_state
2019-07-26 11:37:22,684 DEBUG:S: [ao1] INIT_SIGNAL:outer_state
2019-07-26 11:37:22,684 DEBUG:S: [ao2] run some code, but don&#39;t transition
2019-07-26 11:37:22,684 DEBUG:S: [ao1] init
2019-07-26 11:37:22,685 DEBUG:S: [ao2] Hook:outer_state:HOOK
2019-07-26 11:37:22,685 DEBUG:S: [ao1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-26 11:37:22,685 DEBUG:S: [ao2] &lt;- Queued:(1) Deferred:(0)
2019-07-26 11:37:22,685 DEBUG:S: [ao1] ENTRY_SIGNAL:inner_state
2019-07-26 11:37:22,686 DEBUG:T: [ao2] e-&gt;Reset() inner_state-&gt;inner_state
2019-07-26 11:37:22,687 DEBUG:S: [ao1] hello from inner_state
2019-07-26 11:37:22,687 DEBUG:S: [ao2] Reset:inner_state
2019-07-26 11:37:22,687 DEBUG:S: [ao1] INIT_SIGNAL:inner_state
2019-07-26 11:37:22,687 DEBUG:S: [ao2] Reset:outer_state
2019-07-26 11:37:22,687 DEBUG:S: [ao1] &lt;- Queued:(0) Deferred:(0)
2019-07-26 11:37:22,688 DEBUG:S: [ao2] resetting the chart
2019-07-26 11:37:22,688 DEBUG:S: [ao2] EXIT_SIGNAL:inner_state
2019-07-26 11:37:22,688 DEBUG:S: [ao2] exiting inner_state
2019-07-26 11:37:22,688 DEBUG:S: [ao2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-26 11:37:22,688 DEBUG:S: [ao2] EXIT_SIGNAL:outer_state
2019-07-26 11:37:22,689 DEBUG:S: [ao2] exiting outer_state
2019-07-26 11:37:22,689 DEBUG:S: [ao2] ENTRY_SIGNAL:outer_state
2019-07-26 11:37:22,689 DEBUG:S: [ao2] hello from outer_state
2019-07-26 11:37:22,689 DEBUG:S: [ao2] INIT_SIGNAL:outer_state
2019-07-26 11:37:22,689 DEBUG:S: [ao2] init
2019-07-26 11:37:22,689 DEBUG:S: [ao2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-26 11:37:22,689 DEBUG:S: [ao2] ENTRY_SIGNAL:inner_state
2019-07-26 11:37:22,690 DEBUG:S: [ao2] hello from inner_state
2019-07-26 11:37:22,690 DEBUG:S: [ao2] INIT_SIGNAL:inner_state
2019-07-26 11:37:22,690 DEBUG:S: [ao2] &lt;- Queued:(0) Deferred:(0)
</pre></div>
</div>
<p>Thatâs a lot of information. Suppose we just wanted to see the <code class="docutils literal notranslate"><span class="pre">ao1</span></code> trace:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat simple_state_9.log <span class="p">|</span> grep T:*.a01
</pre></div>
</div>
<p>This would result in the following output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">26</span> <span class="mi">11</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="mi">674</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">T</span><span class="p">:</span> <span class="p">[</span><span class="n">ao1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">inner_state</span>
<span class="mi">2019</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">26</span> <span class="mi">11</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="mi">682</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">T</span><span class="p">:</span> <span class="p">[</span><span class="n">ao1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">()</span> <span class="n">inner_state</span><span class="o">-&gt;</span><span class="n">inner_state</span>
</pre></div>
</div>
<p>If you wanted to see the spy of <code class="docutils literal notranslate"><span class="pre">a02</span></code>, you could grep <code class="docutils literal notranslate"><span class="pre">S:*.a02</span></code>â¦ etc.</p>
<p>So far we have seen how to create state functions, how to link them to an
<code class="docutils literal notranslate"><span class="pre">Activeobject</span></code>, which collectively makes a statechart.  If you would like to
see a comprehensive example of all of the signal pathways supported by the Miro
Samek event processor, look at this <a class="reference internal" href="comprehensive.html#comprehensive-comprehensive"><span class="std std-ref">example</span></a>.</p>
</div>
<div class="section" id="making-a-statechart-from-a-class">
<span id="recipes-making-a-statechart-from-a-class"></span><h3><a class="toc-backref" href="#id102">Making a Statechart from a class</a><a class="headerlink" href="#making-a-statechart-from-a-class" title="Permalink to this headline">Â¶</a></h3>
<p>Is there a way to just make a statechart by instantiating a class?</p>
<p>Yes, this is what the <code class="docutils literal notranslate"><span class="pre">Factory</span></code> class is for.  It links a set of signals to
static methods; and assigns this linked collection to a state.  You do this once
per state, then you nest the states within one another; and the resulting object
is a statechart.  To start itâs thread, you call itâs start_at method, just as
you would with an <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code>.</p>
<p>Letâs rebuild our previous example using the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code> class.</p>
<a class="reference external image-reference" href="_static/state_recipe_10.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_10.svg" src="_images/state_recipe_10.svg" /></div>
</a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The above image is probably breaking the UML specification, since Iâm packing an
HSM diagram into a class icon.  But I donât care, since I have found that this
is a compact way of drawing my design intentions.</p>
</div>
<p>The diagram is saying that the <code class="docutils literal notranslate"><span class="pre">FactoryInstrumentationToLog</span></code> class has a
logging object and is inherited from the <code class="docutils literal notranslate"><span class="pre">Factory</span></code> class, and the <code class="docutils literal notranslate"><span class="pre">Factory</span></code>
class is inherited from the <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> class.  It has two attributes,
<code class="docutils literal notranslate"><span class="pre">live_spy</span></code> and <code class="docutils literal notranslate"><span class="pre">live_trace</span></code> and three methods, <code class="docutils literal notranslate"><span class="pre">trace_callback</span></code>,
<code class="docutils literal notranslate"><span class="pre">spy_callback</span></code> and <code class="docutils literal notranslate"><span class="pre">start_at</span></code>.</p>
<p>I donât know how to draw UML to describe that I want this class to start itâs
statemachine in two different ways, so I write the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> code onto the
diagram to remind myself that Iâm thinking this way.</p>
<p>Within the class, we see the same state machine we described in the
<code class="docutils literal notranslate"><span class="pre">simple_state_9.py</span></code> code listing.</p>
<p>Here is the above design in code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># simple_state_10.py</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">FactoryInstrumentationToLog</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> \
      <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> \
      <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span> <span class="o">=</span> \
      <span class="s1">&#39;simple_state_10.log&#39;</span> <span class="k">if</span> <span class="n">log_file_name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file_name</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
      <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span>
      <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;trace without datetime-stamp&#39;&#39;&#39;</span>
    <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;spy with machine name pre-pended&#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_reset</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">outer_state_exit_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting the outer_state&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="n">f1</span> <span class="o">=</span> <span class="n">FactoryInstrumentationToLog</span><span class="p">(</span>
    <span class="s2">&quot;f1&quot;</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
  <span class="p">)</span>

  <span class="n">f2</span> <span class="o">=</span> <span class="n">FactoryInstrumentationToLog</span><span class="p">(</span>
    <span class="s2">&quot;f2&quot;</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
  <span class="p">)</span>

  <span class="n">f1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
  <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

  <span class="n">f2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
  <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

  <span class="c1"># let the threads catch up before we exit main</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>The benefit of programming a statechart this way is in itâs containment.  You
donât have functions drifting in your packageâs name space, they are nicely
contained as static methods within your statechartâs class.  In addition to
this, you no longer have to manipulate the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> attribute of the event
processor, this complexity is hidden within the <code class="docutils literal notranslate"><span class="pre">Factory</span></code> objectâs
state-function-manufacturing process.  To move the state functions into a class,
you can just add a <code class="docutils literal notranslate"><span class="pre">&#64;staticmethod</span></code> decorator on top of them.  Any static
method is just a function forced into a class.</p>
<p>If you like, you can point the <code class="docutils literal notranslate"><span class="pre">handler</span></code> of the Factoryâs <code class="docutils literal notranslate"><span class="pre">create</span></code> method to
a method instead of a function (or staticmethod).  To write the code this way
only slightly changes our diagram, we need to replace all <code class="docutils literal notranslate"><span class="pre">chart</span></code> variables
with <code class="docutils literal notranslate"><span class="pre">self</span></code>:</p>
<a class="reference external image-reference" href="_static/state_recipe_11.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_11.svg" src="_images/state_recipe_11.svg" /></div>
</a>
<p>To write this design, our state functions become state methods (this feature
was added in miros 4.1.2):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># simple_state_11.py</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">FactoryInstrumentationToLog</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> \
      <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> \
      <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span> <span class="o">=</span> \
      <span class="s1">&#39;simple_state_11.log&#39;</span> <span class="k">if</span> <span class="n">log_file_name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file_name</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
      <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span>
      <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;trace without datetime-stamp&#39;&#39;&#39;</span>
    <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;spy with machine name pre-pended&#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">outer_state_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">outer_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting the outer_state&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="n">f1</span> <span class="o">=</span> <span class="n">FactoryInstrumentationToLog</span><span class="p">(</span>
    <span class="s2">&quot;f1&quot;</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
  <span class="p">)</span>

  <span class="n">f2</span> <span class="o">=</span> <span class="n">FactoryInstrumentationToLog</span><span class="p">(</span>
    <span class="s2">&quot;f2&quot;</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
  <span class="p">)</span>

  <span class="n">f1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
  <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

  <span class="n">f2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
  <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
  <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

  <span class="c1"># let the threads catch up before we exit main</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Itâs nice to look at code that looks like a typical python class.  But be
warned, the methods you assigned to your create handlers will actually be run in
a separate thread from your <code class="docutils literal notranslate"><span class="pre">__init__</span></code> and <code class="docutils literal notranslate"><span class="pre">start_at</span></code> methods.  The
<code class="docutils literal notranslate"><span class="pre">trace_callback</span></code> and <code class="docutils literal notranslate"><span class="pre">spy_callback</span></code> and all of your state handler methods
will run in the statechartâs thread.  This mostly isnât a problem, unless you
are trying to get data from your statechart into your main program.  We will see
how to do this shortly</p>
</div>
<p>If we ran the code and looked at itâs log file we would see:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>2019-07-30 06:25:43,725 DEBUG:T: [f1] e-&gt;start_at() top-&gt;inner_state
2019-07-30 06:25:43,726 DEBUG:S: [f1] START
2019-07-30 06:25:43,726 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:outer_state
2019-07-30 06:25:43,726 DEBUG:S: [f1] ENTRY_SIGNAL:outer_state
2019-07-30 06:25:43,726 DEBUG:S: [f1] hello from outer_state
2019-07-30 06:25:43,726 DEBUG:S: [f1] INIT_SIGNAL:outer_state
2019-07-30 06:25:43,726 DEBUG:S: [f1] init
2019-07-30 06:25:43,726 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-30 06:25:43,727 DEBUG:S: [f1] ENTRY_SIGNAL:inner_state
2019-07-30 06:25:43,727 DEBUG:S: [f1] hello from inner_state
2019-07-30 06:25:43,727 DEBUG:S: [f1] INIT_SIGNAL:inner_state
2019-07-30 06:25:43,727 DEBUG:S: [f1] &lt;- Queued:(0) Deferred:(0)
2019-07-30 06:25:43,729 DEBUG:T: [f2] e-&gt;start_at() top-&gt;inner_state
2019-07-30 06:25:43,729 DEBUG:S: [f2] START
2019-07-30 06:25:43,729 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-30 06:25:43,730 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:outer_state
2019-07-30 06:25:43,730 DEBUG:S: [f2] ENTRY_SIGNAL:outer_state
2019-07-30 06:25:43,730 DEBUG:S: [f2] hello from outer_state
2019-07-30 06:25:43,730 DEBUG:S: [f2] ENTRY_SIGNAL:inner_state
2019-07-30 06:25:43,730 DEBUG:S: [f2] hello from inner_state
2019-07-30 06:25:43,730 DEBUG:S: [f2] INIT_SIGNAL:inner_state
2019-07-30 06:25:43,730 DEBUG:S: [f2] &lt;- Queued:(0) Deferred:(0)
2019-07-30 06:25:43,731 DEBUG:S: [f2] Hook:inner_state
2019-07-30 06:25:43,731 DEBUG:S: [f2] Hook:outer_state
2019-07-30 06:25:43,731 DEBUG:S: [f2] run some code, but don&#39;t transition
2019-07-30 06:25:43,732 DEBUG:S: [f2] Hook:outer_state:HOOK
2019-07-30 06:25:43,732 DEBUG:S: [f2] &lt;- Queued:(1) Deferred:(0)
2019-07-30 06:25:43,733 DEBUG:T: [f2] e-&gt;Reset() inner_state-&gt;inner_state
2019-07-30 06:25:43,733 DEBUG:S: [f2] Reset:inner_state
2019-07-30 06:25:43,733 DEBUG:S: [f2] Reset:outer_state
2019-07-30 06:25:43,733 DEBUG:S: [f2] EXIT_SIGNAL:inner_state
2019-07-30 06:25:43,734 DEBUG:S: [f2] exiting inner_state
2019-07-30 06:25:43,734 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-30 06:25:43,734 DEBUG:S: [f2] EXIT_SIGNAL:outer_state
2019-07-30 06:25:43,734 DEBUG:S: [f2] exiting the outer_state
2019-07-30 06:25:43,734 DEBUG:S: [f2] ENTRY_SIGNAL:outer_state
2019-07-30 06:25:43,734 DEBUG:S: [f2] hello from outer_state
2019-07-30 06:25:43,734 DEBUG:S: [f2] INIT_SIGNAL:outer_state
2019-07-30 06:25:43,735 DEBUG:S: [f2] init
2019-07-30 06:25:43,735 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-30 06:25:43,735 DEBUG:S: [f2] ENTRY_SIGNAL:inner_state
2019-07-30 06:25:43,735 DEBUG:S: [f2] hello from inner_state
2019-07-30 06:25:43,735 DEBUG:S: [f2] INIT_SIGNAL:inner_state
2019-07-30 06:25:43,736 DEBUG:S: [f1] Hook:inner_state
2019-07-30 06:25:43,736 DEBUG:S: [f2] &lt;- Queued:(0) Deferred:(0)
2019-07-30 06:25:43,736 DEBUG:S: [f1] Hook:outer_state
2019-07-30 06:25:43,736 DEBUG:S: [f1] run some code, but don&#39;t transition
2019-07-30 06:25:43,736 DEBUG:S: [f1] Hook:outer_state:HOOK
2019-07-30 06:25:43,737 DEBUG:S: [f1] &lt;- Queued:(1) Deferred:(0)
2019-07-30 06:25:43,738 DEBUG:T: [f1] e-&gt;Reset() inner_state-&gt;inner_state
2019-07-30 06:25:43,738 DEBUG:S: [f1] Reset:inner_state
2019-07-30 06:25:43,738 DEBUG:S: [f1] Reset:outer_state
2019-07-30 06:25:43,738 DEBUG:S: [f1] EXIT_SIGNAL:inner_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] exiting inner_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] EXIT_SIGNAL:outer_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] exiting the outer_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] ENTRY_SIGNAL:outer_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] hello from outer_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] INIT_SIGNAL:outer_state
2019-07-30 06:25:43,739 DEBUG:S: [f1] init
2019-07-30 06:25:43,740 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-07-30 06:25:43,740 DEBUG:S: [f1] ENTRY_SIGNAL:inner_state
2019-07-30 06:25:43,740 DEBUG:S: [f1] hello from inner_state
2019-07-30 06:25:43,740 DEBUG:S: [f1] INIT_SIGNAL:inner_state
2019-07-30 06:25:43,740 DEBUG:S: [f1] &lt;- Queued:(0) Deferred:(0)
2019-08-01 06:28:10,237 DEBUG:T: [f1] e-&gt;start_at() top-&gt;inner_state
2019-08-01 06:28:10,238 DEBUG:S: [f1] START
2019-08-01 06:28:10,238 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:outer_state
2019-08-01 06:28:10,238 DEBUG:S: [f1] ENTRY_SIGNAL:outer_state
2019-08-01 06:28:10,238 DEBUG:S: [f1] hello from outer_state
2019-08-01 06:28:10,238 DEBUG:S: [f1] INIT_SIGNAL:outer_state
2019-08-01 06:28:10,238 DEBUG:S: [f1] init
2019-08-01 06:28:10,239 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-08-01 06:28:10,239 DEBUG:S: [f1] ENTRY_SIGNAL:inner_state
2019-08-01 06:28:10,239 DEBUG:S: [f1] hello from inner_state
2019-08-01 06:28:10,239 DEBUG:S: [f1] INIT_SIGNAL:inner_state
2019-08-01 06:28:10,239 DEBUG:S: [f1] &lt;- Queued:(0) Deferred:(0)
2019-08-01 06:28:10,241 DEBUG:T: [f2] e-&gt;start_at() top-&gt;inner_state
2019-08-01 06:28:10,241 DEBUG:S: [f1] Hook:inner_state
2019-08-01 06:28:10,241 DEBUG:S: [f2] START
2019-08-01 06:28:10,242 DEBUG:S: [f1] Hook:outer_state
2019-08-01 06:28:10,242 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-08-01 06:28:10,242 DEBUG:S: [f1] run some code, but don&#39;t transition
2019-08-01 06:28:10,242 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:outer_state
2019-08-01 06:28:10,242 DEBUG:S: [f1] Hook:outer_state:HOOK
2019-08-01 06:28:10,243 DEBUG:S: [f2] ENTRY_SIGNAL:outer_state
2019-08-01 06:28:10,243 DEBUG:S: [f1] &lt;- Queued:(1) Deferred:(0)
2019-08-01 06:28:10,243 DEBUG:S: [f2] hello from outer_state
2019-08-01 06:28:10,245 DEBUG:T: [f1] e-&gt;Reset() inner_state-&gt;inner_state
2019-08-01 06:28:10,245 DEBUG:S: [f2] ENTRY_SIGNAL:inner_state
2019-08-01 06:28:10,245 DEBUG:S: [f1] Reset:inner_state
2019-08-01 06:28:10,245 DEBUG:S: [f2] hello from inner_state
2019-08-01 06:28:10,245 DEBUG:S: [f1] Reset:outer_state
2019-08-01 06:28:10,246 DEBUG:S: [f2] INIT_SIGNAL:inner_state
2019-08-01 06:28:10,246 DEBUG:S: [f1] EXIT_SIGNAL:inner_state
2019-08-01 06:28:10,246 DEBUG:S: [f2] &lt;- Queued:(0) Deferred:(0)
2019-08-01 06:28:10,246 DEBUG:S: [f1] exiting inner_state
2019-08-01 06:28:10,247 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-08-01 06:28:10,247 DEBUG:S: [f1] EXIT_SIGNAL:outer_state
2019-08-01 06:28:10,247 DEBUG:S: [f1] exiting the outer_state
2019-08-01 06:28:10,247 DEBUG:S: [f1] ENTRY_SIGNAL:outer_state
2019-08-01 06:28:10,247 DEBUG:S: [f1] hello from outer_state
2019-08-01 06:28:10,247 DEBUG:S: [f1] INIT_SIGNAL:outer_state
2019-08-01 06:28:10,248 DEBUG:S: [f1] init
2019-08-01 06:28:10,248 DEBUG:S: [f1] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-08-01 06:28:10,248 DEBUG:S: [f1] ENTRY_SIGNAL:inner_state
2019-08-01 06:28:10,248 DEBUG:S: [f1] hello from inner_state
2019-08-01 06:28:10,248 DEBUG:S: [f1] INIT_SIGNAL:inner_state
2019-08-01 06:28:10,248 DEBUG:S: [f1] &lt;- Queued:(0) Deferred:(0)
2019-08-01 06:28:10,249 DEBUG:S: [f2] Hook:inner_state
2019-08-01 06:28:10,249 DEBUG:S: [f2] Hook:outer_state
2019-08-01 06:28:10,249 DEBUG:S: [f2] run some code, but don&#39;t transition
2019-08-01 06:28:10,249 DEBUG:S: [f2] Hook:outer_state:HOOK
2019-08-01 06:28:10,250 DEBUG:S: [f2] &lt;- Queued:(1) Deferred:(0)
2019-08-01 06:28:10,251 DEBUG:T: [f2] e-&gt;Reset() inner_state-&gt;inner_state
2019-08-01 06:28:10,251 DEBUG:S: [f2] Reset:inner_state
2019-08-01 06:28:10,251 DEBUG:S: [f2] Reset:outer_state
2019-08-01 06:28:10,251 DEBUG:S: [f2] EXIT_SIGNAL:inner_state
2019-08-01 06:28:10,252 DEBUG:S: [f2] exiting inner_state
2019-08-01 06:28:10,252 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-08-01 06:28:10,252 DEBUG:S: [f2] EXIT_SIGNAL:outer_state
2019-08-01 06:28:10,252 DEBUG:S: [f2] exiting the outer_state
2019-08-01 06:28:10,252 DEBUG:S: [f2] ENTRY_SIGNAL:outer_state
2019-08-01 06:28:10,252 DEBUG:S: [f2] hello from outer_state
2019-08-01 06:28:10,252 DEBUG:S: [f2] INIT_SIGNAL:outer_state
2019-08-01 06:28:10,253 DEBUG:S: [f2] init
2019-08-01 06:28:10,253 DEBUG:S: [f2] SEARCH_FOR_SUPER_SIGNAL:inner_state
2019-08-01 06:28:10,253 DEBUG:S: [f2] ENTRY_SIGNAL:inner_state
2019-08-01 06:28:10,253 DEBUG:S: [f2] hello from inner_state
2019-08-01 06:28:10,253 DEBUG:S: [f2] INIT_SIGNAL:inner_state
2019-08-01 06:28:10,253 DEBUG:S: [f2] &lt;- Queued:(0) Deferred:(0)
</pre></div>
</div>
<p>You can see as much information as you like about your statechart dynamics.
Typically I only turn on the spy when Iâm debugging a problem; and Iâll leave
the trace on when Iâm trying to see how a statechart behaves.</p>
</div>
<div class="section" id="communication-between-statecharts">
<span id="recipes-communication-between-statecharts"></span><h3><a class="toc-backref" href="#id103">Communication between Statecharts</a><a class="headerlink" href="#communication-between-statecharts" title="Permalink to this headline">Â¶</a></h3>
<p>To have two different statecharts communicate with one another we use the
publish and subscribe methods (available in the ActiveObject and its
subclasses).  Letâs adjust our example a bit so that we can send a Broadcast
event to one statechart, which will cause both charts to act.</p>
<a class="reference external image-reference" href="_static/state_recipe_12.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_12.svg" src="_images/state_recipe_12.svg" /></div>
</a>
<p>Here is the code (highlighting pub/sub/action code):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_12.py</span>
 <span class="kn">import</span> <span class="nn">re</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">import</span> <span class="nn">logging</span>
 <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="k">class</span> <span class="nc">FactoryInstrumentationToLog</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
       <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span> <span class="o">=</span> \
       <span class="s1">&#39;simple_state_12.log&#39;</span> <span class="k">if</span> <span class="n">log_file_name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file_name</span>

     <span class="c1"># clear our log every time we run this program</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
       <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

     <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
       <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
       <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span>
       <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">))</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
<span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">,</span> \
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_send_broadcast</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">,</span> \
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_broadcast</span><span class="p">)</span><span class="o">.</span> \
</span>       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;trace without datetime-stamp&#39;&#39;&#39;</span>
     <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;spy with machine name pre-pended&#39;&#39;&#39;</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>

   <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
</span>     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

<span class="hll">   <span class="k">def</span> <span class="nf">outer_state_send_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">   <span class="k">def</span> <span class="nf">outer_state_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;received broadcast&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
   <span class="k">def</span> <span class="nf">outer_state_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting the outer_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

   <span class="n">f1</span> <span class="o">=</span> <span class="n">FactoryInstrumentationToLog</span><span class="p">(</span>
     <span class="s2">&quot;f1&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
   <span class="p">)</span>

   <span class="n">f2</span> <span class="o">=</span> <span class="n">FactoryInstrumentationToLog</span><span class="p">(</span>
     <span class="s2">&quot;f2&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
   <span class="p">)</span>

   <span class="n">f1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

   <span class="n">f2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

<span class="hll">   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">))</span>
</span>
   <span class="c1"># let the threads catch up before we exit main</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code posts a <code class="docutils literal notranslate"><span class="pre">Send_Broadcast</span></code> event to f1, which in turn, publishes
the <code class="docutils literal notranslate"><span class="pre">Broadcast</span></code> event.  Since both charts subscribed to this event, they will
react to the <code class="docutils literal notranslate"><span class="pre">Broadcast</span></code> event.  The <code class="docutils literal notranslate"><span class="pre">Broadcast</span></code> signal is attached to both
charts as a hook in their <code class="docutils literal notranslate"><span class="pre">outer_state</span></code>, which means this hookâs reactive
behavior will be common for the outer_state and the inner_state.  The âreceived
broadcastâ message will be written into the spy log via the <code class="docutils literal notranslate"><span class="pre">scribble</span></code> method,
if a <code class="docutils literal notranslate"><span class="pre">Broadcast</span></code> event is received in either state.  No state transition will
occur as a result of the reaction to a <code class="docutils literal notranslate"><span class="pre">Broadcast</span></code> event; <code class="docutils literal notranslate"><span class="pre">Broadcast</span></code> is a
hook and hooks donât cause state transitions.</p>
<p>If we run our code, then filter its log file through a grep search pattern, we
will see that both charts received the <code class="docutils literal notranslate"><span class="pre">BROADCAST</span></code> event:</p>
<div class="highlight-text notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">python simple_state_12.py ; cat simple_state_12.log | grep broadcast
</span>2019-08-02 07:03:17,352 DEBUG:S: [f1] received broadcast
2019-08-02 07:03:17,355 DEBUG:S: [f2] received broadcast
</pre></div>
</td></tr></table></div>
<p>So now we know how:</p>
<ul class="simple">
<li>to build a statechart within a class</li>
<li>to tie the statechart instrumentation features to the logging system (or whatever you want)</li>
<li>to have two or more statecharts communicate with one another</li>
<li>to map the statechart features into functions of static methods or methods.</li>
</ul>
<p>Can we program our states by difference?</p>
</div>
<div class="section" id="overload-a-state-in-a-subclass">
<span id="recipes-overload-a-state-in-a-subclass"></span><h3><a class="toc-backref" href="#id104">Overload a State in a Subclass</a><a class="headerlink" href="#overload-a-state-in-a-subclass" title="Permalink to this headline">Â¶</a></h3>
<p>Suppose our specification poses a problem that can be broken into two or more
subdesigns, and these designs are very similar.  Since we know how to tie our
event handlers to methods in a class, we can just subclass one statechart and
overload the event handlers that we need to change.</p>
<p>Here is how to draw this as a UML diagram.  The F1 class is our first completed
subdesign and F2 is just like F1, except we change the behavior of the
inner_stateâs entry and exit conditions:</p>
<a class="reference external image-reference" href="_static/state_recipe_13.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_13.svg" src="_images/state_recipe_13.svg" /></div>
</a>
<p>The diagram mostly tells us what is going on, and I have added a few notes to
belabor the point.  Here is the code, I have highlighted the
statechart-by-difference part of the design:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_13.py</span>
 <span class="kn">import</span> <span class="nn">re</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">import</span> <span class="nn">logging</span>
 <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="k">class</span> <span class="nc">F1</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
       <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span> <span class="o">=</span> \
       <span class="s1">&#39;simple_state_13.log&#39;</span> <span class="k">if</span> <span class="n">log_file_name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file_name</span>

     <span class="c1"># clear our log every time we run this program</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
       <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

     <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
       <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
       <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span>
       <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">))</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">,</span> \
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_send_broadcast</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">,</span> \
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_broadcast</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;trace without datetime-stamp&#39;&#39;&#39;</span>
     <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;spy with machine name pre-pended&#39;&#39;&#39;</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>

   <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_send_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;received broadcast&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting the outer_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

<span class="hll"> <span class="k">class</span> <span class="nc">F2</span><span class="p">(</span><span class="n">F1</span><span class="p">):</span>
</span><span class="hll">   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="hll">     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span>
<span class="hll">   <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from new inner_state&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">   <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting new inner_state&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

   <span class="n">f1</span> <span class="o">=</span> <span class="n">F1</span><span class="p">(</span>
     <span class="s2">&quot;f1&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
   <span class="p">)</span>

   <span class="n">f2</span> <span class="o">=</span> <span class="n">F2</span><span class="p">(</span>
     <span class="s2">&quot;f2&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span>
   <span class="p">)</span>

   <span class="n">f1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

   <span class="n">f2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>

   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">))</span>

   <span class="c1"># let the threads catch up before we exit main</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
</pre></div>
</div>
<p>This kind of abstraction requires a lot of understanding on the part of the
maintenance developer.  Statechart code is already hard enough to understand
without a diagram, but now parts of our diagram are missing too: to understand
one diagram we need to reference another.</p>
<p>If you find that your subdesign requirements change a lot you might want to just
copy its superclassâs code into a flat, easy-to-read/easy-to-change form,
at the cost of repeating yourself a bit.  Then copy your diagram as a second
stand-alone design artifact.  Subclassing is software coupling, so you will have
to weigh the engineering-trade-offs as you build up your system.</p>
</div>
<div class="section" id="one-shots-multi-shots-and-heartbeats">
<span id="recipes-one-shots-and-heartbeats"></span><h3><a class="toc-backref" href="#id105">One-Shots, Multi-Shots and Heartbeats</a><a class="headerlink" href="#one-shots-multi-shots-and-heartbeats" title="Permalink to this headline">Â¶</a></h3>
<p>We have seen that we can post events using the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> (first in first
out) method call.  If your event needs to push itself to the front of the event
queue (force itself to have the highest priority), you would use the
<code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> (last in first out) method.</p>
<p>The miros library can be used to send events at regular time intervals.  The
number of times these events are sent and the regular time duration between
these events are configurable.  To keep the libraryâs api simple, the
<code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> and <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> methods are used for this feature.  If you just
give a posting method an event it will put it into the event queue.  But if you
give the posting method additional timing information, it will create a
background thread and program that thread to post your event to your statechart
using your timing specification.</p>
<p>To demonstrate this feature, Iâll adjust the design so that between the
outer_state and inner_state there will be a middle_state.  The purpose of the
middle_state will be to add a one second delay between the transition into the
inner_state from the outer_state.  The code to make a delayed event work this
way is called a one-shot  (if it fired more than once it would be called a
multishot, if it fired at a regular interval forever, it would be called a
heartbeat).</p>
<a class="reference external image-reference" href="_static/state_recipe_14.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_14.svg" src="_images/state_recipe_14.svg" /></div>
</a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Our <code class="docutils literal notranslate"><span class="pre">F2</span></code> statechart is blissfully unaware the we have made this change to it,
as it only has visibility to the inner_state event handlers.</p>
</div>
<p>In our design we use the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> method to make the one-shot.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>/<code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> time features can be used within, or outside of,
a statechart.  In the following code example I show a one shot within (Ready)
and outside of (Reset for f1) of a statechart.  The code that has been changed
from the previous example has been highlighted.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_14.py</span>
 <span class="kn">import</span> <span class="nn">re</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">import</span> <span class="nn">logging</span>
 <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="k">class</span> <span class="nc">F1</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
       <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">=</span> <span class="mi">0</span>
</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span> <span class="o">=</span> \
       <span class="s1">&#39;simple_state_14.log&#39;</span> <span class="k">if</span> <span class="n">log_file_name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file_name</span>

     <span class="c1"># clear our log every time we run this program</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
       <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

     <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
       <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
       <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span>
       <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">))</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">,</span> \
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_send_broadcast</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">,</span> \
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_broadcast</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;middle_state&quot;</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Ready</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state_ready</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">to_method</span><span class="p">()</span>
</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
<span class="hll">       <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">)</span>
</span>
   <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;trace without datetime-stamp&#39;&#39;&#39;</span>
     <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;spy with machine name pre-pended&#39;&#39;&#39;</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>

   <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
<span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">)</span>
</span>     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_send_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;received broadcast&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting the outer_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

<span class="hll">   <span class="k">def</span> <span class="nf">middle_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;arming one-shot&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Ready</span><span class="p">),</span>
</span><span class="hll">       <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll">       <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span class="hll">       <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">   <span class="k">def</span> <span class="nf">middle_state_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">   <span class="k">def</span> <span class="nf">middle_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Ready</span><span class="p">))</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
   <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span>
</span><span class="hll">       <span class="s2">&quot;hello from inner_state {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span><span class="p">))</span>
</span>     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

 <span class="k">class</span> <span class="nc">F2</span><span class="p">(</span><span class="n">F1</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from new inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting new inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

   <span class="n">f1</span> <span class="o">=</span> <span class="n">F1</span><span class="p">(</span>
     <span class="s2">&quot;f1&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
   <span class="p">)</span>

   <span class="n">f2</span> <span class="o">=</span> <span class="n">F2</span><span class="p">(</span>
     <span class="s2">&quot;f2&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
   <span class="p">)</span>

   <span class="n">f1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
<span class="hll">   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
</span><span class="hll">     <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">),</span>
</span><span class="hll">     <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span class="hll">     <span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
</span><span class="hll">     <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span>
</span><span class="hll">     <span class="p">)</span>
</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">))</span>

   <span class="c1"># delay long enough so we can see how the program behaves in time</span>
<span class="hll">   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">4.00</span><span class="p">)</span>
</span></pre></div>
</div>
<p>Letâs look at the design again prior to running our program:</p>
<a class="reference external image-reference" href="_static/state_recipe_14.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_14.svg" src="_images/state_recipe_14.svg" /></div>
</a>
<p>The diagram describes how the different charts are started, but there is no
mention of the 2 second delay before we post the <code class="docutils literal notranslate"><span class="pre">Reset</span></code> event to our f1 chart
from our main thread.  We can see that in the exit condition of the f1
middle_state the <code class="docutils literal notranslate"><span class="pre">Reset</span></code> one-shot is canceled.  There is a good reason for
this: imagine that we didnât cancel the one-shot and that we were 0.5 seconds
into our 1 second wait when a <code class="docutils literal notranslate"><span class="pre">Reset</span></code> event was fired at our chart from the
main thread.  This would mean that the task managing the <code class="docutils literal notranslate"><span class="pre">Ready</span></code> event would
continue to run for another 0.5 seconds, then fire the <code class="docutils literal notranslate"><span class="pre">Ready</span></code> event.  The
<code class="docutils literal notranslate"><span class="pre">Ready</span></code> event would appear to fire 0.5 seconds too early; then it would fire
again 0.5 seconds after that (from the arming of the next one-shot event).  This
is weird behavior that defies the spirit of our diagram.  As a rule, cancel your
one-shots in the exit conditions of the state that created them.</p>
<p>We have configured our live instrumentation in an NSA style: log everything so
you can query it later if you feel like it.  After running our program we
can take a look at the different aspects, like, what the f1 trace looks like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="hll">python simple_state_14.py ; cat simple_state_14.log | grep T:.*f1
</span>
2019-08-05 12:18:37,055 DEBUG:T: [f1] e-&gt;start_at() top-&gt;middle_state
2019-08-05 12:18:38,056 DEBUG:T: [f1] e-&gt;Ready() middle_state-&gt;inner_state
2019-08-05 12:18:39,060 DEBUG:T: [f1] e-&gt;Reset() inner_state-&gt;middle_state
2019-08-05 12:18:40,061 DEBUG:T: [f1] e-&gt;Ready() middle_state-&gt;inner_state
</pre></div>
</div>
<p>Here we see that 1 second after starting, the <code class="docutils literal notranslate"><span class="pre">Ready</span></code> one-shot is fired and
the statechart transitions from the middle_state into the inner_state.  Then 1
second later, it receives the <code class="docutils literal notranslate"><span class="pre">Reset</span></code> event putting it back into the
middle_state.  Then 1 second after that, the <code class="docutils literal notranslate"><span class="pre">Ready</span></code> one-shot is fired again
causing a transition into the inner_state.  The <code class="docutils literal notranslate"><span class="pre">Ready</span></code> one shot appears to be
working as designed.</p>
<p>What about our new <code class="docutils literal notranslate"><span class="pre">times_in_inner</span></code> code in F1?  We would expect to see that
it has written to the spy scribble twice:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="hll">python simple_state_14.py ; \
</span><span class="hll">  cat simple_state_14.log | grep S:.*f1 | grep &quot;hello from inner&quot;
</span>
2019-08-05 12:23:23,054 DEBUG:S: [f1] hello from inner_state 1
2019-08-05 12:23:25,059 DEBUG:S: [f1] hello from inner_state 2
</pre></div>
</div>
<p>There we go, the code works.  How about F2?  What is its inner state saying?</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="hll">python simple_state_14.py ; \
</span><span class="hll">  cat simple_state_14.log | grep S:.*f2 | grep &quot;hello from new inner&quot;
</span>
2019-08-05 12:29:55,678 DEBUG:S: [f2] hello from new inner_state
2019-08-05 12:29:56,686 DEBUG:S: [f2] hello from new inner_state
</pre></div>
</div>
<p>So our update to F1âs inner_state was not seen by the F2 statechart.  This
indicates that the inheritance structure is working.  How does F2 run
differently from F1?</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="hll">python simple_state_14.py ; cat simple_state_14.log | grep T:.*f2
</span>
2019-08-05 12:32:08,195 DEBUG:T: [f2] e-&gt;start_at() top-&gt;inner_state
2019-08-05 12:32:08,200 DEBUG:T: [f2] e-&gt;Reset() inner_state-&gt;middle_state
2019-08-05 12:32:09,201 DEBUG:T: [f2] e-&gt;Ready() middle_state-&gt;inner_state
</pre></div>
</div>
<p>We see that the F2 statechart immediately transitions into the inner_state.
This is because we asked it to do so, the 1 second time delay offered by the
<code class="docutils literal notranslate"><span class="pre">Ready</span></code> one-shot is by-passed, though it is still armed.  But this first
<code class="docutils literal notranslate"><span class="pre">Ready</span></code> one-shot is never given a chance to fire, since the <code class="docutils literal notranslate"><span class="pre">Reset</span></code> is sent
to f2 immediately after it is in the inner_state.  This cancels the one-shot
event.  The <code class="docutils literal notranslate"><span class="pre">Reset</span></code> eventually causes a transition into the middle_state,
which re-arms the <code class="docutils literal notranslate"><span class="pre">Ready</span></code> one-shot, and we see a transition into the
inner_state about 1 second after the middle_state was entered.</p>
</div>
<div class="section" id="creating-thread-safe-class-attributes">
<span id="recipes-getting-information-out-of-your-statechart"></span><h3><a class="toc-backref" href="#id106">Creating thread-safe class Attributes</a><a class="headerlink" href="#creating-thread-safe-class-attributes" title="Permalink to this headline">Â¶</a></h3>
<p>If you build a statechart using miros your program is multithreaded.  This means
that if you would like to access the same variable across two threads, you need
to lock it so that one thread doesnât write to it while another thread is using
it.</p>
<p>Here is an example design of where we turn the <code class="docutils literal notranslate"><span class="pre">times_in_inner</span></code> attribute into a
thread-safe property using the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class (available in
miros &gt;= 4.1.3).</p>
<a class="reference external image-reference" href="_static/state_recipe_15.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_15.svg" src="_images/state_recipe_15.svg" /></div>
</a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no UML drawing syntax for describing an attribute wrapped by a
property.  There is no UML diagram to show a thread lock, or how multiple
inheritance works through <a class="reference external" href="https://www.youtube.com/watch?v=EiOglTERPEo">linearization of parent classes</a> using Python <code class="docutils literal notranslate"><span class="pre">super()</span></code>.
Our UML is just a sketch, so we make a note that the <code class="docutils literal notranslate"><span class="pre">times_in_inner</span></code>
is a thread safe attribute and move on.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class tries to protect you from race conditions by
inspecting the line of code where the <code class="docutils literal notranslate"><span class="pre">times_in_inner</span></code> variable is used and
wrap it within a thread lock.  The <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> is <a class="reference internal" href="thread_safe_attributes.html#thread-safe-attributes-thread-safe-attributes"><span class="std std-ref">limited in
itâs capabilities</span></a>, but it will
lock the non-atomic <code class="docutils literal notranslate"><span class="pre">+=</span></code> operation seen below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="c1"># simple_state_15.py</span>
 <span class="kn">import</span> <span class="nn">re</span>
 <span class="kn">import</span> <span class="nn">time</span>
 <span class="kn">import</span> <span class="nn">logging</span>
 <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="hll"> <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ThreadSafeAttributes</span>
</span>
 <span class="k">class</span> <span class="nc">F1</span><span class="p">(</span><span class="n">Factory</span><span class="p">,</span> <span class="n">ThreadSafeAttributes</span><span class="p">):</span>

<span class="hll">   <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;times_in_inner&#39;</span><span class="p">]</span>
</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
       <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> \
       <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span> <span class="o">=</span> \
       <span class="s1">&#39;simple_state_15.log&#39;</span> <span class="k">if</span> <span class="n">log_file_name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file_name</span>

     <span class="c1"># clear our log every time we run this program</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
       <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

     <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
       <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
       <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span>
       <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">))</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">,</span> \
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_send_broadcast</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">,</span> \
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_broadcast</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;middle_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Ready</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state_ready</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;inner_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;trace without datetime-stamp&#39;&#39;&#39;</span>
     <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
     <span class="sd">&#39;&#39;&#39;spy with machine name pre-pended&#39;&#39;&#39;</span>
     <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>

   <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_send_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_broadcast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;received broadcast&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">outer_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting the outer_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">middle_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;arming one-shot&quot;</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Ready</span><span class="p">),</span>
       <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
       <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
       <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">middle_state_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">middle_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Ready</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">+=</span> <span class="mi">1</span>
</span>     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span>
       <span class="s2">&quot;hello from inner_state {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

 <span class="k">class</span> <span class="nc">F2</span><span class="p">(</span><span class="n">F1</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">inner_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from new inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

   <span class="k">def</span> <span class="nf">inner_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting new inner_state&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

   <span class="n">f1</span> <span class="o">=</span> <span class="n">F1</span><span class="p">(</span>
     <span class="s2">&quot;f1&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
   <span class="p">)</span>

   <span class="n">f2</span> <span class="o">=</span> <span class="n">F2</span><span class="p">(</span>
     <span class="s2">&quot;f2&quot;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
     <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
   <span class="p">)</span>

   <span class="n">f1</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
     <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">),</span>
     <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
     <span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
     <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span>
     <span class="p">)</span>

   <span class="n">f2</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">inner_state</span><span class="p">)</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">))</span>
   <span class="n">f2</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">))</span>
   <span class="n">f1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Send_Broadcast</span><span class="p">))</span>

   <span class="c1"># delay long enough so we can see how the program behaves in time</span>
   <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">4.00</span><span class="p">)</span>

   <span class="c1"># read information from other threads</span>
<span class="hll">   <span class="k">print</span><span class="p">(</span><span class="s2">&quot;f1 was in its inner state {} times&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">times_in_inner</span><span class="p">))</span>
</span><span class="hll">   <span class="k">print</span><span class="p">(</span><span class="s2">&quot;f2 was in its inner state {} times&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">times_in_inner</span><span class="p">))</span>
</span></pre></div>
</div>
<p>So where is the lock?</p>
<p>Itâs hidden from view.  The <code class="docutils literal notranslate"><span class="pre">times_in_inner</span></code> is a kind of <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> and
the variable that holds its information is protected by another hidden variable
that is the lock.</p>
<p>Running this program will provide the following output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f1</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">its</span> <span class="n">inner</span> <span class="n">state</span> <span class="mi">2</span> <span class="n">times</span>
<span class="n">f2</span> <span class="n">was</span> <span class="ow">in</span> <span class="n">its</span> <span class="n">inner</span> <span class="n">state</span> <span class="mi">0</span> <span class="n">times</span>
</pre></div>
</div>
<p>The f1 statechart properly reports how many times it was in its inner_state.
The f2 inner_state doesnât write to the <code class="docutils literal notranslate"><span class="pre">times_in_inner</span></code> property, so itâs
output only shows how that property was initialized.</p>
<p>Letâs look at the thread safe code in isolation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="c1"># ...</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ThreadSafeAttributes</span>

<span class="k">class</span> <span class="nc">F1</span><span class="p">(</span><span class="n">Factory</span><span class="p">,</span> <span class="n">ThreadSafeAttributes</span><span class="p">):</span>
   <span class="n">_attribute</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;times_in_inner&#39;</span><span class="p">]</span>  <span class="c1"># Uses a metaclass to make the</span>
                                    <span class="c1"># times_in_inner property, with its</span>
                                    <span class="c1"># protecting lock</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">some_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="c1"># ..</span>
    <span class="c1"># Inside of the state thread small operations on the times_in_inner</span>
    <span class="c1"># attribute can use used in a thread safe way</span>
    <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span><span class="p">)</span>  <span class="c1"># safe</span>
    <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span>     <span class="c1"># safe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">=</span> <span class="mi">1</span>     <span class="c1"># safe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">+=</span> <span class="mi">1</span>    <span class="c1"># safe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="c1"># NOT safe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># NOT safe</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">times_in_inner</span>  <span class="c1"># NOT safe</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class behaves like a macro, wrapping the getting
and setting of the thread safe attribute within a thread lock.  It also wraps
simple, <code class="docutils literal notranslate"><span class="pre">+=</span></code>, <code class="docutils literal notranslate"><span class="pre">-=</span></code>, â¦, <code class="docutils literal notranslate"><span class="pre">&lt;&lt;=</span></code> statements within a lock.  But thatâs it.
It canât protect other types of statements from race conditions.  If you need to
use your thread safe attribute to perform more complex operations, use a
temporary variable and copy the results into the thread safe attribute when you
are done.</p>
<p>Better yet, share information using published events.  But, the thread safe
attributes feature is very useful when you are sharing information between a
statechart and a thread which is not a statechart, like main.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Accessing a thread safe attribute will be very slow.  In the background
the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> uses a metaclass, and the descriptor protocol.
Within the descriptor protocol it uses the <code class="docutils literal notranslate"><span class="pre">inspect</span></code> library to read the
previous line of code and compares it to a regular expression.  Keep this in
mind when you use this feature.</p>
</div>
<ul class="simple">
<li><a class="reference internal" href="#recipes-sharing-attributes-between-threads-activeobjects"><span class="std std-ref">Sharing attributes between threads (ActiveObjects)</span></a></li>
<li><a class="reference internal" href="#recipes-sharing-attributes-between-threads-factories"><span class="std std-ref">Sharing attributes between threads (Factories)</span></a></li>
</ul>
<p>If you have gotten this far, you have a good handle on how to use this library
and all of its features.  But you can take it to another level though.  Your
statecharts can send encrypted messages to one another and act in concert while
running on different machines.  To see how to do this, look at the
<a class="reference external" href="https://aleph2c.github.io/miros-rabbitmq/index.html">miros-rabbitmq</a> library.</p>
<hr class="docutils" />
<p>Here is a collection of tiny programs that each demonstrate how to do things in miros.</p>
</div>
</div>
<div class="section" id="states">
<span id="recipes-states"></span><h2><a class="toc-backref" href="#id26">States</a><a class="headerlink" href="#states" title="Permalink to this headline">Â¶</a></h2>
<div class="contents local topic" id="id3">
<ul class="simple">
<li><a class="reference internal" href="#state-function-recipes" id="id107">State Function Recipes</a><ul>
<li><a class="reference internal" href="#boiler-plate-state-function-code" id="id108">Boiler-plate State Function Code</a></li>
<li><a class="reference internal" href="#describing-your-parent-state-function" id="id109">Describing your Parent State Function</a></li>
<li><a class="reference internal" href="#passing-events-to-the-parent-state-function" id="id110">Passing events to the Parent State Function</a></li>
<li><a class="reference internal" href="#transition-to-another-state-function" id="id111">Transition to another State Function</a></li>
<li><a class="reference internal" href="#state-function-entry-code" id="id112">State Function Entry Code</a></li>
<li><a class="reference internal" href="#state-function-initialization-code" id="id113">State Function Initialization Code</a></li>
<li><a class="reference internal" href="#state-function-exit-code" id="id114">State Function Exit Code</a></li>
<li><a class="reference internal" href="#creating-a-hook-in-a-state-function" id="id115">Creating a Hook in a State function</a></li>
<li><a class="reference internal" href="#catch-and-release-in-a-state-function" id="id116">Catch and Release in a State function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#state-method-recipes" id="id117">State Method Recipes</a><ul>
<li><a class="reference internal" href="#boiler-plate-state-method" id="id118">Boiler-plate State Method</a></li>
<li><a class="reference internal" href="#boiler-plate-state-handler-method" id="id119">Boiler-plate State Handler Method</a></li>
<li><a class="reference internal" href="#describing-your-parent-state-using-the-factory" id="id120">Describing your Parent State using the Factory</a></li>
<li><a class="reference internal" href="#passing-events-to-the-parent-state-method" id="id121">Passing Events to the Parent State Method</a></li>
<li><a class="reference internal" href="#transition-to-another-state-method" id="id122">Transition to another State Method</a></li>
<li><a class="reference internal" href="#state-handlers-for-entry-exit-and-initialization-signals" id="id123">State Handlers for Entry/Exit and Initialization Signals</a></li>
<li><a class="reference internal" href="#creating-a-hook-in-a-state-handler" id="id124">Creating a Hook in a State Handler</a></li>
</ul>
</li>
</ul>
</div>
<p>A lot of Python developers are moving away from using its object oriented
features and writing most of their code within functions which call each other.
This kind of programming is supported by miros.  You can build up your
statechart by constructing a set of state functions, attaching one of them to a
<code class="docutils literal notranslate"><span class="pre">miros.ActiveObject</span></code>, then using that active object as the thing to post
events to.  The functions and the active object work together to form a
statechart.  If you intend on porting your designs to the <code class="docutils literal notranslate"><span class="pre">qp</span></code> framework, I
recommend that you write your code this way.</p>
<p>You can also build a statechart directly within one class, by inheriting from
the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code>.  Within the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method of the derived class, you
describe the states, link signals to state methods then add hierarchy using
the <code class="docutils literal notranslate"><span class="pre">nest</span></code> method.</p>
<p>The state recipes will be broken down into two groups, state function recipes
and state method recipes.</p>
<div class="section" id="state-function-recipes">
<span id="recipes-state-function-recipes"></span><h3><a class="toc-backref" href="#id107">State Function Recipes</a><a class="headerlink" href="#state-function-recipes" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="boiler-plate-state-function-code">
<span id="recipes-boiler-plate-state-function-code"></span><h4><a class="toc-backref" href="#id108">Boiler-plate State Function Code</a><a class="headerlink" href="#boiler-plate-state-function-code" title="Permalink to this headline">Â¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="o">&lt;</span><span class="n">your_state_method_name</span><span class="o">&gt;</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1"># if your state method doesn&#39;t know what to do, it should return this</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">:</span>
    <span class="c1"># call your entry application code</span>

    <span class="c1"># make sure you tell the event processor you handled this event</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">:</span>
    <span class="c1"># call your initialization (big black dot) application code</span>

    <span class="c1"># make sure you tell the event processor you handled this event</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1">#</span>
  <span class="c1"># Write your custom</span>
  <span class="c1"># event handlers in here as their own elif clauses</span>
  <span class="c1">#</span>

  <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">:</span>
    <span class="c1"># call your exit application code</span>

    <span class="c1"># make sure you tell the event processor you handled this event</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># this logic will run when your event processor sends an event with the</span>
    <span class="c1"># SEARCH_FOR_SUPER_SIGNAL name</span>

    <span class="c1"># 1) place your parent state method into the self.temp.fun</span>
    <span class="c1"># 1.1) if this is the top-most state, use ``chart.top`` as your</span>
    <span class="c1">#      &lt;your_parent_state_method&gt;</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">your_parent_state_method</span><span class="o">&gt;</span>

    <span class="c1"># 2) make sure you return this value</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="c1"># return the status value</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>If your state method didnât include handling for the <code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code>,
<code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> or <code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code>, the event processor will just assume it did
and returned return_state.HANDLED.</p>
<p>To see factory boiler plate go, see <span class="xref std std-ref">this</span></p>
</div>
<div class="section" id="describing-your-parent-state-function">
<span id="recipes-describing-your-parent-state-function"></span><h4><a class="toc-backref" href="#id109">Describing your Parent State Function</a><a class="headerlink" href="#describing-your-parent-state-function" title="Permalink to this headline">Â¶</a></h4>
<p>To describe your parent state:</p>
<ol class="arabic simple">
<li>setting the <code class="docutils literal notranslate"><span class="pre">temp.fun</span></code> attribute of the first argument to point at their
parent state.</li>
<li>return the value of <code class="docutils literal notranslate"><span class="pre">return_state.SUPER</span></code></li>
</ol>
<p>Generally speaking this is how it is done:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="o">&lt;</span><span class="n">state_method_name</span><span class="o">&gt;</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1"># .</span>
  <span class="c1"># .</span>
  <span class="k">else</span><span class="p">:</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">parent_state_of_this_state_method</span><span class="o">&gt;</span>
</span>  <span class="k">return</span> <span class="n">status</span><span class="o">.</span>
</pre></div>
</div>
<p>If you need to define your parent state as the outermost state of your diagram, you would
set the <code class="docutils literal notranslate"><span class="pre">&lt;parent_state_of_this_state_method&gt;</span></code> to the <code class="docutils literal notranslate"><span class="pre">top</span></code> attribute of the
first argument provided to your state method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="o">&lt;</span><span class="n">state_method_name</span><span class="o">&gt;</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1"># .</span>
  <span class="c1"># .</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
<span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
</span>  <span class="k">return</span> <span class="n">status</span><span class="o">.</span>
</pre></div>
</div>
<p>To read more about why you structure your state methods this way, read <span class="xref std std-ref">this.</span></p>
<p>To see how to define a parent state with a factory, read <span class="xref std std-ref">this</span></p>
</div>
<div class="section" id="passing-events-to-the-parent-state-function">
<span id="recipes-passing-events-to-the-parent-state-function"></span><h4><a class="toc-backref" href="#id110">Passing events to the Parent State Function</a><a class="headerlink" href="#passing-events-to-the-parent-state-function" title="Permalink to this headline">Â¶</a></h4>
<p>The easiest way to pass an event outward in your statechart is not to handle it
in your <code class="docutils literal notranslate"><span class="pre">if-elif</span></code> clauses and let your <code class="docutils literal notranslate"><span class="pre">else</span></code>
<span class="xref std std-ref">clause</span> handle it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sending Event(signal=signals.B) to c1 would cause</span>
<span class="c1"># the parent state c to be called with this event,</span>
<span class="c1"># since it is not handled in the ``if-elif``</span>
<span class="c1"># logic structure or c1.</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Another way to pass an event out to your parent state is to handle the event in
the <code class="docutils literal notranslate"><span class="pre">if-elif</span></code> clause, then return <code class="docutils literal notranslate"><span class="pre">return_status.UNHANDLED</span></code> to the event
processor.  When it sees that your state method couldnât handle the event it
will call it again to find itâs parent state and then call that parent state
method with the event that you want to trickle outward in your diagram.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sending Event(signal=signals.B) to c1 would cause</span>
<span class="c1"># the parent state c to be called with this event,</span>
<span class="c1"># since c1 returns a `UNHANDLED` value to the event</span>
<span class="c1"># processor</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">):</span>
<span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;saw signal B, but letting it trickle through to my parent&quot;</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<div class="section" id="transition-to-another-state-function">
<span id="recipes-transition-to-another-state-function"></span><h4><a class="toc-backref" href="#id111">Transition to another State Function</a><a class="headerlink" href="#transition-to-another-state-function" title="Permalink to this headline">Â¶</a></h4>
<p>To transition to another state, use the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sending Event(signal=signals.A) will cause a transition to c2</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">trans</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Make sure that you return the result of the call to your <code class="docutils literal notranslate"><span class="pre">trans</span></code> method, or
the event processor will break.</p>
</div>
<div class="section" id="state-function-entry-code">
<span id="recipes-state-function-entry-code"></span><h4><a class="toc-backref" href="#id112">State Function Entry Code</a><a class="headerlink" href="#state-function-entry-code" title="Permalink to this headline">Â¶</a></h4>
<p>To have your application code run when a state is entered place it in the
<code class="docutils literal notranslate"><span class="pre">ENTRY_SIGNAL</span></code> clause of your stateâs if-elif structure.  An entry event will
occur anytime the event processor detects a transition from the outside to the
inside of your state methodâs boundary.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running application code when the state is entered</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running my entry application code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<div class="section" id="state-function-initialization-code">
<span id="recipes-state-function-initialization-code"></span><h4><a class="toc-backref" href="#id113">State Function Initialization Code</a><a class="headerlink" href="#state-function-initialization-code" title="Permalink to this headline">Â¶</a></h4>
<p>To have your application code run when a state is initialized place it in the
<code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> clause of your stateâs if-elif structure.  An init event will
occur after the entry event, if a transition is moving from the outside to the
inside of your state methodâs boundary.  It will also occur if there is a
transition into this state from one of its child states.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running application code when the state is initialized</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="c1"># BIG BLACK DOT ON DIAGRAM</span>
</span><span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running my init application code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">NOTE:</th><td class="field-body">If you only want to run initialization code and do not want your state
to immediately transition into another state, make sure you return
<code class="docutils literal notranslate"><span class="pre">HANDLED</span></code> after running your application code, otherwise your
statechart will not behave properly.</td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> handler is often used as the place where your state can
immediately transition into another state.  To do this, just use the
<span class="xref std std-ref">trans</span> method and return its result
from your state method call:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running application code when the state is initialized</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="c1"># BIG BLACK DOT ON DIAGRAM</span>
</span><span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running my init application code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># now transition into the c2 state</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you use an init signal to transition out of your parent state an
<code class="docutils literal notranslate"><span class="pre">HsmTopologyException</span></code> will be issued.  Init signals should only be used to
run code with no transitions or to transition deeper into your statechart.
If you absolutely need to leave a state after entering  you can post an
<a class="reference internal" href="glossary.html#term-artificial-event"><span class="xref std std-term">artificial event</span></a> into the fifo/lifo.  This will
cause this signal to be caught on the next <a class="reference internal" href="glossary.html#term-run-to-completion"><span class="xref std std-term">rtc</span></a>
process and your statechart will behave as you want it to (though, you should
probably re-visit your design).</p>
</div>
</div>
<div class="section" id="state-function-exit-code">
<span id="recipes-state-function-exit-code"></span><h4><a class="toc-backref" href="#id114">State Function Exit Code</a><a class="headerlink" href="#state-function-exit-code" title="Permalink to this headline">Â¶</a></h4>
<p>To have your application code run when a state is exited place it in the
<code class="docutils literal notranslate"><span class="pre">EXIT_SIGNAL</span></code> clause of your stateâs if-elif structure.  An exit event will
occur anytime the event processor detects a transition from the inside to the
outside of of your state methodâs boundary.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running application code when the state is entered</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running my exit application code here&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-a-hook-in-a-state-function">
<span id="recipes-creating-a-hook-in-a-state-function"></span><h4><a class="toc-backref" href="#id115">Creating a Hook in a State function</a><a class="headerlink" href="#creating-a-hook-in-a-state-function" title="Permalink to this headline">Â¶</a></h4>
<p>A hook is some application code that is shared between your state method and
all of its child state methodâs.</p>
<p>Here we will create a hook in the c1 state, linking some application code to an
event with the signal name <code class="docutils literal notranslate"><span class="pre">MY_HOOK</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sending Event(signal=signals.A) will cause a transition to c2</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">MY_HOOK</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;running the code defined in c1&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Now we will make a child state.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a child state of c1</span>
<span class="k">def</span> <span class="nf">c11</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c1</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>We will start up our state chart, in c11 and send the <code class="docutils literal notranslate"><span class="pre">MY_HOOK</span></code> event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">c11</span><span class="p">)</span>
<span class="c1"># run code in c1 from c11 by using a hook</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">MY_HOOK</span><span class="p">))</span>
  <span class="c1"># =&gt; &quot;running the code from defined in c1&quot;</span>
<span class="c1"># demonstrate the state didn&#39;t change</span>
<span class="k">assert</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;c11&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above code we see evidence that our statechart ran some application code
contained in the parent state (<code class="docutils literal notranslate"><span class="pre">c1</span></code>) while it stayed within its child state
(<code class="docutils literal notranslate"><span class="pre">c11</span></code>).</p>
<p>The child state received an event called <code class="docutils literal notranslate"><span class="pre">MY_HOOK</span></code> which it didnât know what
to do with.  So the event processor searched the parent state and saw that there was a
handler for this event in <code class="docutils literal notranslate"><span class="pre">c1</span></code>.  The <code class="docutils literal notranslate"><span class="pre">MY_HOOK</span></code> handler (the if-elif
clause) returned <code class="docutils literal notranslate"><span class="pre">return_status.HANDLED</span></code>.  Upon seeing this value, the event
processor determined that no transition is needed and it stopped running.</p>
<a class="reference external image-reference" href="_static/hook1.pdf"><div align="center" class="align-center"><img alt="_images/hook1.svg" src="_images/hook1.svg" /></div>
</a>
<p>In this way hook code is run in the search phase of the search-then-transition
part of the event processor algorithm.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">c1</span></code> state method, âhooksâ the <code class="docutils literal notranslate"><span class="pre">MY_HOOK</span></code> event, by capturing it, running
its application code and returning the <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code> value.  It stops the
<code class="docutils literal notranslate"><span class="pre">MY_HOOK</span></code> event from falling off the edge of the map and returns control to
the state that originally experienced the event.</p>
</div>
<div class="section" id="catch-and-release-in-a-state-function">
<span id="recipes-catch-and-release-in-a-state-function"></span><h4><a class="toc-backref" href="#id116">Catch and Release in a State function</a><a class="headerlink" href="#catch-and-release-in-a-state-function" title="Permalink to this headline">Â¶</a></h4>
<p>The catch and release recipe is similar to the
<span class="xref std std-ref">hook</span> recipe in that you are using the search phase
of the event processor algorithm to run your code.</p>
<p>Instead of hooking the code with an <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code> response, your state method
returns an <code class="docutils literal notranslate"><span class="pre">UNHANDLED</span></code> status.  This causes the event processor, to query it
again to find its parent, then dispatch the event to that state method.</p>
<a class="reference external image-reference" href="_static/catchandrelease1.pdf"><div align="center" class="align-center"><img alt="_images/catchandrelease1.svg" src="_images/catchandrelease1.svg" /></div>
</a>
<p>Here we create the state in the picture, notice that <code class="docutils literal notranslate"><span class="pre">inner</span></code> and <code class="docutils literal notranslate"><span class="pre">middle</span></code>
do not return <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code> when they see the <code class="docutils literal notranslate"><span class="pre">BUBBLED</span></code> signal.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BUBBLED</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hooked by the outer state&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BUBBLED</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;processed in middle&quot;</span><span class="p">)</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BUBBLED</span><span class="p">):</span>
</span><span class="hll">    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;processed in inner&quot;</span><span class="p">)</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="hll"><span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
</span><span class="c1"># run each state&#39;s application code for the bubble event</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BUBBLED</span><span class="p">))</span>
  <span class="c1"># =&gt; &quot;processed in inner&quot;</span>
  <span class="c1">#    &quot;processed in middle&quot;</span>
  <span class="c1">#    &quot;hooked by the outer state&quot;</span>
<span class="c1"># demonstrate the state didn&#39;t change</span>
<span class="hll"><span class="k">assert</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
</div>
</div>
<div class="section" id="state-method-recipes">
<span id="recipes-state-method-recipes"></span><h3><a class="toc-backref" href="#id117">State Method Recipes</a><a class="headerlink" href="#state-method-recipes" title="Permalink to this headline">Â¶</a></h3>
<p>A statechart can be made using the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code> class.  To see how to do
this <a class="reference internal" href="#recipes-making-a-statechart-from-a-class"><span class="std std-ref">look here</span></a>.</p>
<div class="section" id="boiler-plate-state-method">
<span id="recipes-boiler-plate-state-handler-method"></span><h4><a class="toc-backref" href="#id118">Boiler-plate State Method</a><a class="headerlink" href="#boiler-plate-state-method" title="Permalink to this headline">Â¶</a></h4>
<p>A state method is constructed by using the <code class="docutils literal notranslate"><span class="pre">create</span></code>, <code class="docutils literal notranslate"><span class="pre">catch</span></code> and <code class="docutils literal notranslate"><span class="pre">to_method</span></code>
interface of the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code> object.</p>
<p>Consider the outer_state of <a class="reference internal" href="#recipes-making-a-statechart-from-a-class"><span class="std std-ref">this example</span></a>:</p>
<a class="reference external image-reference" href="_static/state_recipe_10.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_10.svg" src="_images/state_recipe_10.svg" /></div>
</a>
<p>Your outer_state state method code (highlighted) would look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="k">class</span> <span class="nc">FactoryInstrumentationToLog</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
       <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
     <span class="c1"># ..</span>

<span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Reset</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_reset</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">to_method</span><span class="p">()</span>
</span>
    <span class="c1"># ..</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">self.outer_state</span></code> method construction is started with a call to the
<code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code> <code class="docutils literal notranslate"><span class="pre">create</span></code> method.  Then the <code class="docutils literal notranslate"><span class="pre">catch</span></code> method is chained once
for every signal your state needs to handle.  The <code class="docutils literal notranslate"><span class="pre">catch</span></code> method requires a
signal and a reference to a method which will be called when an event of this
signal is passed to your state method. To end the chain, the <code class="docutils literal notranslate"><span class="pre">to_method</span></code> is
called, which converts the state into a state method.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">self.outer_state</span></code> method does not describe itâs parent, this is
done separately with the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code>âs <code class="docutils literal notranslate"><span class="pre">nest</span></code> interface.</p>
</div>
<div class="section" id="boiler-plate-state-handler-method">
<span id="id4"></span><h4><a class="toc-backref" href="#id119">Boiler-plate State Handler Method</a><a class="headerlink" href="#boiler-plate-state-handler-method" title="Permalink to this headline">Â¶</a></h4>
<p>When you use the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code> to build a statechart, you assign one state
handler to each signal of the state.  This means that you can have multiple state
handlers per state.</p>
<p>A state method tends to have the following form:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="o">&lt;</span><span class="n">name_of_state_name_of_event</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="c1"># .. code to handle specific event</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Here is an example of the outer_state methodâs entry event handler taken from
<a class="reference internal" href="#recipes-making-a-statechart-from-a-class"><span class="std std-ref">this example</span></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<div class="section" id="describing-your-parent-state-using-the-factory">
<span id="recipes-describing-your-parent-state-method"></span><h4><a class="toc-backref" href="#id120">Describing your Parent State using the Factory</a><a class="headerlink" href="#describing-your-parent-state-using-the-factory" title="Permalink to this headline">Â¶</a></h4>
<p>A state method does not describe its parent state, this is done with the
<code class="docutils literal notranslate"><span class="pre">nest</span></code> method which follows the state definition descriptions in the
<code class="docutils literal notranslate"><span class="pre">__init__</span></code> of your derived factory class.</p>
<p>If we were to add the hierarchy information for the following design:</p>
<a class="reference external image-reference" href="_static/state_recipe_10.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_10.svg" src="_images/state_recipe_10.svg" /></div>
</a>
<p>The code would look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span><span class="p">)</span>
</pre></div>
</div>
<p>To see the full example, reference: <a class="reference internal" href="#recipes-making-a-statechart-from-a-class"><span class="std std-ref">making a statechart from a class</span></a>.</p>
</div>
<div class="section" id="passing-events-to-the-parent-state-method">
<span id="recipes-passing-events-to-the-parent-state-method"></span><h4><a class="toc-backref" href="#id121">Passing Events to the Parent State Method</a><a class="headerlink" href="#passing-events-to-the-parent-state-method" title="Permalink to this headline">Â¶</a></h4>
<p>By default a state method will pass an event outward to its super state if it is
not handled by any of its handlers.</p>
</div>
<div class="section" id="transition-to-another-state-method">
<span id="recipes-transition-to-another-state-method"></span><h4><a class="toc-backref" href="#id122">Transition to another State Method</a><a class="headerlink" href="#transition-to-another-state-method" title="Permalink to this headline">Â¶</a></h4>
<p>To transition to another state, use the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
  <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>To see the full example, reference: <a class="reference internal" href="#recipes-making-a-statechart-from-a-class"><span class="std std-ref">making a statechart from a class</span></a>.</p>
</div>
<div class="section" id="state-handlers-for-entry-exit-and-initialization-signals">
<span id="recipes-state-method-entry-code"></span><h4><a class="toc-backref" href="#id123">State Handlers for Entry/Exit and Initialization Signals</a><a class="headerlink" href="#state-handlers-for-entry-exit-and-initialization-signals" title="Permalink to this headline">Â¶</a></h4>
<a class="reference external image-reference" href="_static/state_recipe_10.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_10.svg" src="_images/state_recipe_10.svg" /></div>
</a>
<p>We would create the outer_state and its entry/exit/initialization handlers
this way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
 <span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

 <span class="k">class</span> <span class="nc">FactoryInstrumentationToLog</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
       <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
     <span class="c1"># ...</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
<span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_entry_signal</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_init_signal</span><span class="p">)</span><span class="o">.</span> \
</span>       <span class="c1"># ...</span>
<span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_exit_signal</span><span class="p">)</span><span class="o">.</span> \
</span>       <span class="n">to_method</span><span class="p">()</span>

       <span class="c1"># ...</span>

<span class="hll">   <span class="k">def</span> <span class="nf">outer_state_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BROADCAST</span><span class="p">))</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;hello from outer_state&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">   <span class="k">def</span> <span class="nf">outer_state_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">middle_state</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">   <span class="k">def</span> <span class="nf">outer_state_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;exiting the outer_state&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</div>
<p>To see the full example, reference: <a class="reference internal" href="#recipes-making-a-statechart-from-a-class"><span class="std std-ref">making a statechart from a class</span></a>.</p>
</div>
<div class="section" id="creating-a-hook-in-a-state-handler">
<span id="recipes-creating-a-hook-in-a-state-method"></span><h4><a class="toc-backref" href="#id124">Creating a Hook in a State Handler</a><a class="headerlink" href="#creating-a-hook-in-a-state-handler" title="Permalink to this headline">Â¶</a></h4>
<a class="reference external image-reference" href="_static/state_recipe_10.pdf"><div align="center" class="align-center"><img alt="_images/state_recipe_10.svg" src="_images/state_recipe_10.svg" /></div>
</a>
<p>We would create the outer_state and its Hook handlers this way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="k">class</span> <span class="nc">FactoryInstrumentationToLog</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
       <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
     <span class="c1"># ..</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">outer_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;outer_state&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="c1"># ..</span>
<span class="hll">       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Hook</span><span class="p">,</span>
</span><span class="hll">         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_state_hook</span><span class="p">)</span><span class="o">.</span> \
</span>       <span class="c1"># ..</span>
       <span class="n">to_method</span><span class="p">()</span>

    <span class="c1"># ..</span>

<span class="hll">   <span class="k">def</span> <span class="nf">outer_state_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;run some code, but don&#39;t transition&quot;</span><span class="p">)</span>
</span><span class="hll">     <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span></pre></div>
</div>
<p>To see the full example, reference: <a class="reference internal" href="#recipes-making-a-statechart-from-a-class"><span class="std std-ref">making a statechart from a class</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="events-and-signals">
<span id="recipes-events-and-signals"></span><h2><a class="toc-backref" href="#id45">Events And Signals</a><a class="headerlink" href="#events-and-signals" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="#recipes-subscribing-to-an-event-posted-by-another-active-object"><span class="std std-ref">Subscribing to an event posted by another Activeobject and Factories</span></a></li>
<li><a class="reference internal" href="#recipes-publishing-event-to-other-active-objects"><span class="std std-ref">Publishing events to other Activeobjects and Factories</span></a></li>
</ul>
<div class="section" id="creating-an-event">
<span id="recipes-creating-an-event"></span><h3><a class="toc-backref" href="#id46">Creating an Event</a><a class="headerlink" href="#creating-an-event" title="Permalink to this headline">Â¶</a></h3>
<p>An event is something that will be passed into your statechart, it will be
reacted to, then removed from memory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>

<span class="n">event_1</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="s2">&quot;name_of_signal&quot;</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">event_2</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">name_of_signal</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-a-signal">
<span id="recipes-creating-a-signal"></span><h3><a class="toc-backref" href="#id47">Creating a Signal</a><a class="headerlink" href="#creating-a-signal" title="Permalink to this headline">Â¶</a></h3>
<p>A signal is the name of an event.  Many different events can have the same
name, or signal.  When a signal is created, it is given a number which is one
higher than the oldest signal that was within your program.  You shouldnât have
to worry about what a signal number is, they are only used to speed up the
event processor. (it is faster to compare two numbers than two strings)</p>
<p>When you create a signal it will not be removed from memory until your program
finishes.  They are created at the moment they are referenced, so you donât
have to explicitly define them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>

<span class="c1"># signal named &quot;name_of_signaL&quot; invented</span>
<span class="c1"># here and given a unique number</span>
<span class="hll"><span class="n">event_1</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="s2">&quot;name_of_signal&quot;</span><span class="p">)</span>
</span><span class="c1"># the signal number of this event will have</span>
<span class="c1"># the same number as in line 6</span>
<span class="n">event_2</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">name_of_signal</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that the signal was invented on line <strong>6</strong> then re-used on line <strong>9</strong>.</p>
<p>The signals are shared across your whole program.  To see reflect upon your
signals read <a class="reference internal" href="#recipes-seeing-your-signals"><span class="std std-ref">this</span></a>.</p>
</div>
<div class="section" id="posting-events">
<span id="id5"></span><h3><a class="toc-backref" href="#id48">Posting Events</a><a class="headerlink" href="#posting-events" title="Permalink to this headline">Â¶</a></h3>
<p>The Active Object <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>, <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code>, <code class="docutils literal notranslate"><span class="pre">defer</span></code> and <code class="docutils literal notranslate"><span class="pre">recall</span></code>
methods are use to feed events to the statechart.  An Event can be thought of
as a kind of named marble that is placed onto a topological map.  If a
particular elevation doesnât know what to do with the marble, it rolls the
marble to the next lower elevation, or state.  If the lowest elevation is
reached and the program doesnât know what to do, it just ignores the event, or
lets the marble fall out of play.</p>
<p>The name of the marble is the signal name. An event can have a payload, but it
doesnât have to.  An event can only be posted to a chart after the chart has
started.  Otherwise the behavior of the active object is undefined.</p>
<p>The state methods typically react to the names of a event, or the signal names.
This means that the if-else structures that you write will use the signal names
in their logic.</p>
<p>If you use the chartâs post event methods within the chart, the chart will not
concern itself with <em>where</em> you initiated that event.  It will post its events
into its queue as if they were provided by the outside world.  In this way
these events are called <em>artificial</em>; instead of the world creating the event,
the chart does.  There are a number of situations where it makes sense to do
this, they will be described in the patterns section.</p>
</div>
<div class="section" id="posting-an-event-to-the-fifo">
<span id="recipes-posting-an-event-to-the-fifo"></span><h3><a class="toc-backref" href="#id49">Posting an Event to the Fifo</a><a class="headerlink" href="#posting-an-event-to-the-fifo" title="Permalink to this headline">Â¶</a></h3>
<p>To post an event to the active object first-in-first-out (fifo) buffer, you
must have first started your statechart.  Here is a simple example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="c1"># start at &#39;outer&#39; for the sake of our example</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>

<span class="c1"># Send an event with the signal name &#39;mary&#39;</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">mary</span><span class="p">))</span>
</pre></div>
</div>
<p>The signal names used by the events are common across the entire system.  You
do not need to declare them.  If the system had not seen the <code class="docutils literal notranslate"><span class="pre">signals.mary</span></code>
signal code before in our above example, this name would be added and assigned
a unique number automatically.</p>
</div>
<div class="section" id="posting-an-event-to-the-lifo">
<span id="recipes-posting-an-event-to-the-lifo"></span><h3><a class="toc-backref" href="#id50">Posting an Event to the LIFO</a><a class="headerlink" href="#posting-an-event-to-the-lifo" title="Permalink to this headline">Â¶</a></h3>
<p>To post an event to the active object last-in-first-out (lifo) buffer, you
must have first started your statechart.  Here is a simple example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="c1"># start at &#39;outer&#39; for the sake of our example</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>

<span class="c1"># Now say we want to send an event with</span>
<span class="c1"># th the signal name of &#39;mary&#39; to the chart</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">mary</span><span class="p">))</span>
</pre></div>
</div>
<p>You would post to the âlifoâ buffer if you needed your event to be moved to the
front of the active objectâs collection of unprocessed events.  You might want
to do this with a timing heart beat or for any event that needs to be processed
with a greater priority than other events.</p>
</div>
<div class="section" id="create-a-guard">
<span id="recipes-create-a-guard"></span><h3><a class="toc-backref" href="#id51">Create a Guard</a><a class="headerlink" href="#create-a-guard" title="Permalink to this headline">Â¶</a></h3>
<p>There will be situations where you only would like an event to cause a
transition between two states if a condition is true.  This is called a guard,
in UML it looks like this:</p>
<a class="reference external image-reference" href="_static/guard.pdf"><div align="center" class="align-center"><img alt="_images/guard.svg" src="_images/guard.svg" /></div>
</a>
<p>The logic between the square brackets must be true for this event to work.  In
this case the <code class="docutils literal notranslate"><span class="pre">T</span></code> event is guarded, it can only cause a transition if the the
function <code class="docutils literal notranslate"><span class="pre">g()</span></code> returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, otherwise nothing will happen.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">t()</span></code> function is a function that runs if the <code class="docutils literal notranslate"><span class="pre">g()</span></code> returns True.</p>
<p>To implement a guard in your state method is very straight forward, you use an
if statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
<span class="hll">  <span class="k">if</span> <span class="n">g</span><span class="p">():</span>
</span>    <span class="n">t</span><span class="p">()</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="o">&lt;</span><span class="n">state_to_transition_to</span><span class="p">)</span>
</pre></div>
</div>
<p>The highlighted code is the guard.</p>
<p>To learn more about guards read the
<a class="reference internal" href="scribbleexample.html#scribbleexample-hacking-to-learn-the-deeper-dynamics"><span class="std std-ref">hacking to learn example.</span></a></p>
</div>
<div class="section" id="creating-a-one-shot-event">
<span id="recipes-creating-a-one-shot-event"></span><h3><a class="toc-backref" href="#id52">Creating a One-Shot Event</a><a class="headerlink" href="#creating-a-one-shot-event" title="Permalink to this headline">Â¶</a></h3>
<p>A one-shot event can be used to add some delay between state transitions.  You
can think of them as delayed <strong>init</strong> signals.  You might want to use a one-shot if
you need a system to settle down a bit before transitioning into an inner
state.</p>
<p>Generally speaking, you should cancel your one-shot events as your chart passes
control to outer states.  You donât need to do this, but if you donât your
outer states will be hit with one-shot messages that they donât care about
and your chart will needlessly search as it reacts to these events.</p>
<p>It is important to know that if your chart changes state, the event posted to
it will look like it came from outside of your statechart, even though it was
originally generated within a given state.  The construction of any event with
the <code class="docutils literal notranslate"><span class="pre">fifo</span></code> or <code class="docutils literal notranslate"><span class="pre">lifo</span></code> api behaves like this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here define a middle state the creates a one-shot event called</span>
<span class="c1"># delayed_one_second.  The same delayed_one_second signal is captured</span>
<span class="c1"># by the middle state and used to transition into the inner state</span>
<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># we have entered the state and we would like to delay one</span>
  <span class="c1"># second prior to entering the inner state</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
      <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
        <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">delay_one_second</span><span class="p">),</span>
        <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span>
      <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="c1"># we are leaving this state for an outer state</span>
    <span class="c1"># so we cancel our one-shot in case it hasn&#39;t gone off yet</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">delay_one_second</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1"># ignore our init</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="c1"># our one-shot has fired, one second has passed since</span>
  <span class="c1"># we transitioned into this state, now transition</span>
  <span class="c1"># to our desired target; &#39;inner&#39;</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">delay_one_second</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-a-multishot-event">
<span id="recipes-creating-a-multishot-event"></span><h3><a class="toc-backref" href="#id53">Creating a Multishot Event</a><a class="headerlink" href="#creating-a-multishot-event" title="Permalink to this headline">Â¶</a></h3>
<p>A multi-shot event is just an extension of the one-shot idea.  Instead of only
being fired once on entry, it can be fired between 2 and an infinite number of
times.  You would use a multi-shot event if you would like to provide an inner
part of your chart with a heart beat that the outer part of your chart doesnât
need to know about.  In this way you could save cycles by avoiding unnecessary
event processing in the parts of the chart that donât need these heart beats.
This will also be useful while debugging your chart, your logs wonât be filled
with unnecessary events.</p>
<p>You should cancel your multi-shot events in the exit handler of the state that
created them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here define a middle state the creates a multi-shot event called</span>
<span class="c1"># three_pulse.  The same three_pulse signal is captured</span>
<span class="c1"># by the middle state and used to transition into the inner state</span>
<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">multi_shot_thread</span> <span class="o">=</span> \
      <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">three_pulse</span><span class="p">),</span>
                      <span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                      <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># We mark up the ao with this id, so that</span>
    <span class="c1"># state function can be used by many different aos</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">multi_shot_thread</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;multi_shot_thread&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">cancel_event</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">multi_shot_thread</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">three_pulse</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>By setting the <code class="docutils literal notranslate"><span class="pre">times</span></code> argument of the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> to 0, you can create an
infinite multi-shot event.  This is how you could make an inner heart beat.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> api can be used the same as the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> api for
creating these types of repeating events.  You would use the <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> api
when you would need your heart beat event signal to barge ahead of all other
events waiting to be processed by the active object.</p>
</div>
<div class="section" id="canceling-a-specific-event-source">
<span id="recipes-cancelling-a-specific-event-source"></span><h3><a class="toc-backref" href="#id54">Canceling a Specific Event Source</a><a class="headerlink" href="#canceling-a-specific-event-source" title="Permalink to this headline">Â¶</a></h3>
<p>The requests to the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> and <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> methods, where <code class="docutils literal notranslate"><span class="pre">times</span></code> are
specified, can be thought of as event sources.  This is because they create
background threads which track time and periodically post events to the active
object.</p>
<p>There are two different ways to cancel event sources.  You can cancel a
specific event source, or you can cancel all event sources that create a
specific signal name (easier).  Read the
<a class="reference internal" href="#recipes-cancelling-event-source-by-signal-name"><span class="std std-ref">Canceling Event Source By Signal Name</span></a> recipe to see how to do
this.</p>
<p>To cancel a specific signal source, you need to track the thread id which was
created when it was made, then use that id to cancel the event.  Since a state
method can be used by many different active objects, you donât want to store
this id on the method itself, or in its variable name space.  Instead, you can
markup the name of the chart that is using the method, this <code class="docutils literal notranslate"><span class="pre">chart</span></code> object is
passed to the state method as the first argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here define a middle state the creates a multi-shot event called</span>
<span class="c1"># three_pulse.  The same three_pulse signal is captured</span>
<span class="c1"># by the middle state and used to transition into the inner state</span>
<span class="c1">#</span>
<span class="c1"># We want to cancel this specific event source when we are exiting this</span>
<span class="c1"># state</span>
<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">multi_shot_thread</span> <span class="o">=</span> \
      <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">three_pulse</span><span class="p">),</span>
                      <span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                      <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># We graffiti the provided chart object with this id</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">multi_shot_thread</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;multi_shot_thread&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">cancel_event</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">multi_shot_thread</span><span class="p">)</span>

    <span class="c1"># remove our graffiti</span>
    <span class="k">del</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">multi_shot_thread</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">three_pulse</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">augment</span></code> api is used to graffiti our chart upon entering the state.
We write the event-source id onto the <code class="docutils literal notranslate"><span class="pre">multi_shot_thread</span></code> chart attribute,
so that we can use it later.  By marking this specific <code class="docutils literal notranslate"><span class="pre">chart</span></code> object, the
middle state method handler can be shared by other active objects.</p>
<p>You would use this method of canceling an event source if you need the
three_pulse signal name elsewhere in your statechart.  If you do not intend on
re-using this signal name you can just cancel event sources using a much
simpler api: the <code class="docutils literal notranslate"><span class="pre">cancel_event</span></code>.</p>
</div>
<div class="section" id="canceling-event-source-by-signal-name">
<span id="recipes-cancelling-event-source-by-signal-name"></span><h3><a class="toc-backref" href="#id55">Canceling Event Source By Signal Name</a><a class="headerlink" href="#canceling-event-source-by-signal-name" title="Permalink to this headline">Â¶</a></h3>
<p>If you would like to re-use your event source signal names through your chart,
then you can use the <a class="reference internal" href="#recipes-cancelling-a-specific-event-source"><span class="std std-ref">Canceling a Specific Event Source</span></a> recipe
to cancel a specific source and leave your other event sources running.
Otherwise, you can use the simpler <code class="docutils literal notranslate"><span class="pre">cancel_sources</span></code> api provided by the
Active Object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here we define a middle state the creates a multi-shot event called</span>
<span class="c1"># three_pulse.  The same three_pulse signal is captured</span>
<span class="c1"># by the middle state and used to transition into the inner state</span>
<span class="c1">#</span>
<span class="c1"># We want to cancel this specific event source when we are exiting this</span>
<span class="c1"># state</span>
<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">three_pulse</span><span class="p">),</span>
                    <span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="c1"># cancel all event sources with the signal named three_pulses</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">three_pulse</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">three_pulse</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>There is no need to keep a thread id for the event source, since the Active
Object can just look at all of the event source threads and kill any of them
that have this signal name provided to the <code class="docutils literal notranslate"><span class="pre">cancel_events</span></code> call.</p>
</div>
<div class="section" id="deferring-and-recalling-an-event">
<span id="recipes-deferring-an-event"></span><h3><a class="toc-backref" href="#id56">Deferring and Recalling an Event</a><a class="headerlink" href="#deferring-and-recalling-an-event" title="Permalink to this headline">Â¶</a></h3>
<p>There will be situations where you want to post a kind of artificial event into
a queue which wonât immediately be acted upon by your startchart.  It is an
<cite>artificial</cite> event, because your chart is making it up, it isnât being given to
it by the outside world.  It is a way for your chart to build up a kind of
processing pressure that can be relieved when you have the cycles to work on
things.</p>
<p>This is a two stage process, one, deferring the event, and two, recalling the
event.  It is called a deferment of an event because we are holding off our
reaction to it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># code to place in the state that is deferring the event:</span>
<span class="n">chart</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">signal_that_is_deferred</span><span class="p">)</span>

<span class="c1"># code to place in the state where you would like the event reposted into</span>
<span class="c1"># the chart&#39;s first in first out queue</span>
<span class="n">chart</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span> <span class="c1"># posts our deferred event to the chart.</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-a-payload-to-an-event">
<span id="recipes-adding-a-payload-to-an-event"></span><h3><a class="toc-backref" href="#id57">Adding a Payload to an Event</a><a class="headerlink" href="#adding-a-payload-to-an-event" title="Permalink to this headline">Â¶</a></h3>
<p>To add a payload to your event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">e</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">YOUR_SIGNAL_NAME</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="s2">&quot;My Payload&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you are creating a payload that will be shared across statecharts put it
within an immutable object like a namedtuple before you send it out.  Then draw
the named tuple onto your diagrams, because the structure of the payload will
become extremely important when you are trying to understand your design later.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We want to use an immutable object when sharing data between threads to avoid
nasty multi-threading bugs.  If you canât change the object in two different
locations at the same time, then you canât accidently create this kind of bug.</p>
</div>
<p>Here is an example of a payload picture, taken from the miros-random project:</p>
<a class="reference external image-reference" href="_static/named_tuple_payload.pdf"><div align="center" class="align-center"><img alt="_images/named_tuple_payload.svg" src="_images/named_tuple_payload.svg" /></div>
</a>
<p>You can see, itâs just the code used to make it, placed within a UML note.</p>
<p>Here is the code to make this payloadâs class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># collections are in the Python standard library</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="c1"># create a structured immutable object that has useful names related</span>
<span class="c1"># to your problem</span>
<span class="n">PioneerRequestSpec</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
  <span class="s1">&#39;PioneerRequestSpec&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cells_per_generation&#39;</span><span class="p">,</span> <span class="s1">&#39;deque_depth&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is how you would create an event with this payload class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># There is often a relationship between your signal names and your payload</span>
<span class="c1"># name</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">PioneerRequest</span><span class="p">,</span>
      <span class="n">payload</span><span class="o">=</span><span class="n">PioneerRequestSpec</span><span class="p">(</span>
        <span class="n">cells_per_generation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
        <span class="n">queue_depth</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is how you would access the payload elsewhere in your design:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># to get access to the payload information when you receive this event in one</span>
<span class="c1"># of your event handlers:</span>
<span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">cells_per_generation</span>  <span class="c1"># =&gt; 45</span>
<span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">queue_depth</span>  <span class="c1"># =&gt; 11</span>
</pre></div>
</div>
<p>I would recommend that you always place your payloads in immutable objects,
even if you arenât intending to share them between statecharts.</p>
</div>
<div class="section" id="determining-if-an-event-has-a-payload">
<span id="recipes-determining-if-an-event-has-a-payload"></span><h3><a class="toc-backref" href="#id58">Determining if an Event Has a Payload</a><a class="headerlink" href="#determining-if-an-event-has-a-payload" title="Permalink to this headline">Â¶</a></h3>
<p>To determine if an event has a payload:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">e1</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">YOUR_SIGNAL_NAME</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;My Payload&quot;</span><span class="p">)</span>
<span class="n">e2</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">YOUR_SIGNAL_NAME</span><span class="p">)</span>

<span class="k">assert</span><span class="p">(</span><span class="n">e1</span><span class="o">.</span><span class="n">has_payload</span><span class="p">()</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">has_payload</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="subscribing-to-an-event-posted-by-another-active-object">
<span id="recipes-subscribing-to-an-event-posted-by-another-active-object"></span><h3><a class="toc-backref" href="#id59">Subscribing to an Event Posted by Another Active Object</a><a class="headerlink" href="#subscribing-to-an-event-posted-by-another-active-object" title="Permalink to this headline">Â¶</a></h3>
<p>Your active object can subscribe to the events published by other active objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subscribing_ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">subscribing_ao</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">))</span>
</pre></div>
</div>
<p>An active object can set how the ActiveFabric (the infrastructure connecting all
of your statecharts together) posts events to it.  If it would like a message to
take priority over all other events waiting to be managed, you would use the
<code class="docutils literal notranslate"><span class="pre">lifo</span></code> technique:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subscribing_ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">subscribing_ao</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">),</span>
  <span class="n">queue_type</span><span class="o">=</span><span class="s1">&#39;lifo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This approach would make sense if you were subscribed to a timed heart beat
being sent out by another active object, or if this event was some sort of
safety related thing.</p>
<p>In most situations you can use the subscription defaults:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subscribing_ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">subscribing_ao</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">)</span>
<span class="c1"># which is the same as writing</span>
<span class="n">subscribing_ao</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
  <span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">,</span> <span class="n">queue_type</span><span class="o">=</span><span class="s1">&#39;fifo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It may seem a little bit strange to subscribe to an event, since an event is a
specific thing, which contains a general thing; the signal.  But the <code class="docutils literal notranslate"><span class="pre">subscribe</span></code>
method supports subscribing to events so that itâs method signature looks like
the other method signatures in the library.  (Less things for you to remember)</p>
<p>If you chose to subscribe to events and not directly to signals, think of your
call as saying, âI would like to subscribe to this type of eventâ.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># subscribing to a `type` of event</span>
<span class="n">subscribing_ao</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">),</span>
  <span class="n">queue_type</span><span class="o">=</span><span class="s1">&#39;fifo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="publishing-events-to-other-active-objects">
<span id="recipes-publishing-event-to-other-active-objects"></span><h3><a class="toc-backref" href="#id60">Publishing events to other Active Objects</a><a class="headerlink" href="#publishing-events-to-other-active-objects" title="Permalink to this headline">Â¶</a></h3>
<p>Your active object can send data to other active objects in the system by
publishing events.</p>
<p>But your active object can only control <em>how it talks to others</em>, not <em>who
listens to it</em>; so, if another active object wants to receive a published event
it must subscribe to it first.</p>
<p>If you would like to publish data that will be used by another ActiveObject,
copy your data into some sort of immutable object before you publish it:
namedtuple objects are perfect for these situations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="c1"># draw these payloads on your statechart diagram</span>
<span class="n">MyPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;MyPayload&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name_of_item_1&#39;</span><span class="p">,</span> <span class="s1">&#39;name_of_item2&#39;</span><span class="p">])</span>

<span class="n">publishing_ao</span> <span class="o">=</span> <span class="n">ActiveObect</span><span class="p">()</span>

<span class="c1"># This is how you can send an &#39;THING_SUBSCRIBING_AO_CARES_ABOUT&#39; event</span>
<span class="c1"># to anything that has subscribed to it</span>
<span class="n">publishing_ao</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">MyPayload</span><span class="p">(</span>
      <span class="n">name_of_item_1</span><span class="o">=</span><span class="s1">&#39;something&#39;</span><span class="p">,</span>
      <span class="n">name_of_item_2</span><span class="o">=</span><span class="s1">&#39;something_else&#39;</span>
    <span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here is how to publish an event with a specific priority:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">publishing_ao</span> <span class="o">=</span> <span class="n">ActiveObect</span><span class="p">()</span>
<span class="n">publishing_ao</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">))</span>

<span class="c1"># or you can set the priority (1 is the highest priority see note):</span>
<span class="n">publishing_ao</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">THING_SUBSCRIBING_AO_CARES_ABOUT</span><span class="p">),</span>
  <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The priority numbering scheme is counter-intuitive: low numbers mean high
priority while high numbers mean low priority.  The highest published event
priority is 1.  By default all published events are given a priority of 1000.
If two events have the same priority the queue will behave like a first in
first out queue.</p>
</div>
</div>
<div class="section" id="avoiding-bugs-which-travel-through-time">
<span id="recipes-avoiding-bugs-which-travel-through-time"></span><h3><a class="toc-backref" href="#id61">Avoiding Bugs Which Travel Through Time</a><a class="headerlink" href="#avoiding-bugs-which-travel-through-time" title="Permalink to this headline">Â¶</a></h3>
<p>If you have build a statechart which is dependent upon an internal heartbeat to
track time, you have built a clock.  Such a clock will slip backward in time
relative to your Operating Systemâs clock.  This is because the threads which
are created to drive your heart beat use Pythonâs <code class="docutils literal notranslate"><span class="pre">time.sleep</span></code> function, and it
is not precise in how it works.  A call to <code class="docutils literal notranslate"><span class="pre">time.sleep</span></code> means it will sleep
for at-least a given amount of time, not the precise number giving to it as
an argument.</p>
<p>If you mix another clock into your design, by calling out to get the your
operating systemâs version of time, and mix that information with the time you
have calculated from your heart beat, you will have created a time traveling
bug.  One time measurement will be in the future of the others time reference.</p>
<p>This relative time slippage is non-deterministic because <code class="docutils literal notranslate"><span class="pre">time.sleep</span></code> is
dependent upon what your computer is doing outside of your program.  The time
distortion will get larger the longer your program runs.</p>
<p>To avoid such issues, only use one clock reference per statechart.  If you have
constructed a federation of statecharts which need to have their time
synchronized, then use one time reference for the federation.</p>
</div>
<div class="section" id="avoiding-double-time-heart-beat-bugs">
<span id="recipes-avoiding-double-time-heart-beat-bugs"></span><h3><a class="toc-backref" href="#id62">Avoiding double time heart beat bugs</a><a class="headerlink" href="#avoiding-double-time-heart-beat-bugs" title="Permalink to this headline">Â¶</a></h3>
<p>If you are seeing more heart beats than you want, look to see if you have
designed in the <a class="reference internal" href="#recipes-inheritance-and-starting-factories"><span class="std std-ref">double start bug</span></a> or the
<a class="reference internal" href="#recipes-avoiding-heart-beat-bleed-bugs"><span class="std std-ref">heart-beat-bleed bug</span></a>.</p>
</div>
</div>
<div class="section" id="avoiding-heart-beat-bleed-bugs">
<span id="recipes-avoiding-heart-beat-bleed-bugs"></span><h2><a class="toc-backref" href="#id63">Avoiding Heart-Beat-Bleed Bugs</a><a class="headerlink" href="#avoiding-heart-beat-bleed-bugs" title="Permalink to this headline">Â¶</a></h2>
<p>When you create a heart beat in an entry condition to a state, you will want to
turn it off in the exit condition of the same state.  If you donât, the thread
producing its events will continue to run and post events to your chart.  This
may not be an issue outside of the state that is reacting to these events, but
once you re-enter the state and re-create the heart beat, you will now have two
threads sending beats into that part of your system.</p>
<p>You can find such bugs by monitoring the spy output of your statechart, or by
remembering that every time you create a heart beat, you must cancel it in the
exit condition.</p>
</div>
<div class="section" id="activeobjects">
<span id="recipes-activeobjects-and-factories"></span><h2><a class="toc-backref" href="#id64">ActiveObjects</a><a class="headerlink" href="#activeobjects" title="Permalink to this headline">Â¶</a></h2>
<p>To build a statechart, you can create an <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> and connect it to one of
your state functions using the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method.  Together, the
<code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> and the state functions work as a statechart.</p>
<div class="contents local topic" id="id6">
<ul class="simple">
<li><a class="reference internal" href="#starting-an-activeobject" id="id125">Starting an ActiveObject</a></li>
<li><a class="reference internal" href="#stopping-an-activeobject" id="id126">Stopping an ActiveObject</a></li>
<li><a class="reference internal" href="#augmentng-your-activeobject" id="id127">Augmentng your ActiveObject</a></li>
<li><a class="reference internal" href="#sharing-attributes-between-threads-activeobjects" id="id128">Sharing Attributes between Threads (ActiveObjects)</a></li>
</ul>
</div>
<div class="section" id="starting-an-activeobject">
<span id="recipes-starting-an-activeojbect-or-factory"></span><h3><a class="toc-backref" href="#id125">Starting an ActiveObject</a><a class="headerlink" href="#starting-an-activeobject" title="Permalink to this headline">Â¶</a></h3>
<p>Once you have created an Activeobject you can start its statemachine and thread
with its <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method.</p>
<p>There is a set of queues and threads which connect <em>all of your ActiveObjects
together</em> (the ActiveFabric), if it hasnât been started yet, the <code class="docutils literal notranslate"><span class="pre">start_at</span></code>
method will turn on this infrastructure as well.</p>
<p>Here is a simple example:</p>
<a class="reference external image-reference" href="_static/start_at.pdf"><div align="center" class="align-center"><img alt="_images/start_at.svg" src="_images/start_at.svg" /></div>
</a>
<p>The <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method can start the statechart in any of its states.</p>
<p>Here is the code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;c1 entered&quot;</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">c2</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;c2 entered&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">(</span><span class="s1">&#39;start_example&#39;</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;calling: start_at(c2)&quot;</span><span class="p">)</span>
<span class="hll">  <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span> <span class="c1"># print what happened from the start_at call</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">clear_trace</span><span class="p">()</span>  <span class="c1"># clear our instrumentation</span>

  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;sending B, then A, then A:&quot;</span><span class="p">)</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>
  <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span> <span class="c1"># print what happened</span>
</pre></div>
</div>
<p>When we run this code we will see this result:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">calling</span><span class="p">:</span> <span class="n">start_at</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
<span class="n">c1</span> <span class="n">entered</span>
<span class="n">c2</span> <span class="n">entered</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">21</span> <span class="mo">06</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">36.234137</span><span class="p">]</span> <span class="p">[</span><span class="n">start_example</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">c2</span>

<span class="n">sending</span> <span class="n">B</span><span class="p">,</span> <span class="n">then</span> <span class="n">A</span><span class="p">,</span> <span class="n">then</span> <span class="n">A</span>
<span class="n">c1</span> <span class="n">entered</span>
<span class="n">c2</span> <span class="n">entered</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">21</span> <span class="mo">06</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">36.435853</span><span class="p">]</span> <span class="p">[</span><span class="n">start_example</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">()</span> <span class="n">c2</span><span class="o">-&gt;</span><span class="n">c1</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">21</span> <span class="mo">06</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">36.436074</span><span class="p">]</span> <span class="p">[</span><span class="n">start_example</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">()</span> <span class="n">c1</span><span class="o">-&gt;</span><span class="n">c2</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">21</span> <span class="mo">06</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">36.436228</span><span class="p">]</span> <span class="p">[</span><span class="n">start_example</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">A</span><span class="p">()</span> <span class="n">c2</span><span class="o">-&gt;</span><span class="n">c1</span>
</pre></div>
</div>
</div>
<div class="section" id="stopping-an-activeobject">
<span id="recipes-stopping-an-activeobject-or-factory"></span><h3><a class="toc-backref" href="#id126">Stopping an ActiveObject</a><a class="headerlink" href="#stopping-an-activeobject" title="Permalink to this headline">Â¶</a></h3>
<p>If you would like to stop an <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> you can use its <code class="docutils literal notranslate"><span class="pre">stop</span></code> method.</p>
<p>This will stop its thread, and it will stop all of that <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code>âs slave
threads (constructed by the post_fifo or post_lifo heartbeat constructors).  The
<code class="docutils literal notranslate"><span class="pre">stop</span></code> method sets the <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code>âs ActiveFabric-facing queue to None, so that
the ActiveFabric will not post items to it anymore.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Calling the <code class="docutils literal notranslate"><span class="pre">stop</span></code> method will not stop the ActiveFabric.  But the
ActiveFabric, like all threads in miros, is a daemonic thread, so it will stop
running when your program has stopped running.</p>
</div>
</div>
<div class="section" id="augmentng-your-activeobject">
<span id="recipes-markup-your-event-processor"></span><h3><a class="toc-backref" href="#id127">Augmentng your ActiveObject</a><a class="headerlink" href="#augmentng-your-activeobject" title="Permalink to this headline">Â¶</a></h3>
<p>It is a bad idea to add variables to the state methods, instead augment your
active objects using the <code class="docutils literal notranslate"><span class="pre">augment</span></code> command.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">chart</span> <span class="o">=</span> <span class="n">ActiveObect</span><span class="p">()</span>
<span class="n">chart</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;counter&#39;</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An even better idea would be to include the attributes in a subclass of an
Activeobject or Factory.</p>
</div>
</div>
<div class="section" id="sharing-attributes-between-threads-activeobjects">
<span id="recipes-sharing-attributes-between-threads-activeobjects"></span><h3><a class="toc-backref" href="#id128">Sharing Attributes between Threads (ActiveObjects)</a><a class="headerlink" href="#sharing-attributes-between-threads-activeobjects" title="Permalink to this headline">Â¶</a></h3>
<p>As of miros version v4.1.3 (fixed in v4.1.4), you can create
<a class="reference internal" href="thread_safe_attributes.html#thread-safe-attributes-thread-safe-attributes"><span class="std std-ref">thread-safe-attributes</span></a> in
your derived <code class="docutils literal notranslate"><span class="pre">ActiveObject</span></code> class by also inheriting the
<code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code>.</p>
<p>To create one or more thread safe attribute, you add them to the list defined
<code class="docutils literal notranslate"><span class="pre">_attributes</span></code>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ThreadSafeAttributes</span>

<span class="hll"><span class="k">class</span> <span class="nc">ThreadSafeAttributesInActiveObject</span><span class="p">(</span><span class="n">ThreadSafeAttributes</span><span class="p">,</span> <span class="n">ActiveObject</span><span class="p">):</span>
</span>
<span class="hll">  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;thread_safe_attr_1&#39;</span><span class="p">,</span> <span class="s1">&#39;thread_safe_attr_2&#39;</span><span class="p">]</span>
</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">thread_safe_attr_2</span> <span class="o">=</span> <span class="bp">False</span>
</span>   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="bp">True</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">c1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="bp">True</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="bp">False</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">c</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">c2</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">thread_safe_attr_2</span> <span class="o">=</span> <span class="bp">True</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
<span class="hll">     <span class="n">chart</span><span class="o">.</span><span class="n">thread_safe_attr_2</span> <span class="o">=</span> <span class="bp">False</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="k">else</span><span class="p">:</span>
     <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">c</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
   <span class="k">return</span> <span class="n">status</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">ao</span> <span class="o">=</span> <span class="n">ThreadSafeAttributesInActiveObject</span><span class="p">(</span><span class="s2">&quot;ao&quot;</span><span class="p">)</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># Change the ActiveObject&#39;s attributes while it is starting it&#39;s thread</span>
    <span class="c1"># and starting its statemachine</span>
<span class="hll">    <span class="n">ao</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="hll">    <span class="n">ao</span><span class="o">.</span><span class="n">thread_safe_attr_2</span> <span class="o">=</span> <span class="bp">False</span>
</span>    <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
    <span class="c1"># Main thread can access attribute used by the ActiveObject&#39;s thread</span>
<span class="hll">    <span class="k">print</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">thread_safe_attr_2</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="factories">
<h2><a class="toc-backref" href="#id69">Factories</a><a class="headerlink" href="#factories" title="Permalink to this headline">Â¶</a></h2>
<p>You can build a statechart within a class by using the <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code> class.
The <code class="docutils literal notranslate"><span class="pre">miros.Factory</span></code> lets you build state methods, state handlers and start the
chart in whichever state you need.</p>
<div class="section" id="creating-a-statechart-inside-of-a-class">
<span id="recipes-creating-a-statechart-inside-of-a-class"></span><h3><a class="toc-backref" href="#id70">Creating a Statechart Inside of a Class</a><a class="headerlink" href="#creating-a-statechart-inside-of-a-class" title="Permalink to this headline">Â¶</a></h3>
<p>You can create a class that has a statechart within it.  Here are some of the benefits
of programming this way:</p>
<blockquote>
<div><ul class="simple">
<li>it is easy to draw using a mixture of class and statechart UML</li>
<li>state names can be re-used in the same file</li>
<li>provides a clear synchronous interface (methods)</li>
<li>provides a clear asynchronous interface (post_fifo/post_lifo/publish/subscribe)</li>
<li>packages all of your states, transitions and starting code within a single
location in your file, within its class.</li>
<li>the start_at code is held within the classâs <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method</li>
<li>hides the state complexity from the rest of your code base</li>
<li>effortlessly provides multi-threading without its dangers</li>
<li>complicated <code class="docutils literal notranslate"><span class="pre">else</span></code> clauses in state callback handlers are avoided</li>
<li>it is trivial for main to inject asynchronous information</li>
<li>it is not hard for main to <span class="xref std std-ref">extract asynchronous information</span></li>
<li>it is easy to build lots of these different kinds of objects and have them work as a
federation. (systems programming)</li>
<li>it is easy to document federations (systems design)</li>
<li>it is not hard to network your federations with other federations across
the internet (<a class="reference external" href="https://aleph2c.github.io/miros-rabbitmq/index.html">systems of systems: miros-rabbitmq</a>)</li>
</ul>
</div></blockquote>
<p>To program this way we use the <span class="xref std std-ref">Factory</span> class from miros.</p>
<p>Here is a simple example of a statechart within an object:</p>
<a class="reference external image-reference" href="_static/factory_in_class_simple.pdf"><div align="center" class="align-center"><img alt="_images/factory_in_class_simple.svg" src="_images/factory_in_class_simple.svg" /></div>
</a>
<p>Familiar stuff first:  The <code class="docutils literal notranslate"><span class="pre">ClassWithStatechartInIt</span></code> inherits from
<code class="docutils literal notranslate"><span class="pre">Factory</span></code>, it has three attributes and two methods.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ClassWithStatechartInIt</span></code> also has an asynchronous statechart (blue),
which is attached to an event processor, and it starts in the
<code class="docutils literal notranslate"><span class="pre">common_behaviors</span></code> state.</p>
<p>Letâs bring this design to life with some code (we will highlight the
asynchronous aspects of the program):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">ClassWithStatechartInIt</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="n">Default_Name</span> <span class="o">=</span> <span class="s1">&#39;default_name&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># call the Factory ctor</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
      <span class="n">ClassWithStatechartInIt</span><span class="o">.</span><span class="n">Default_Name</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">name</span>
    <span class="p">)</span>
    <span class="c1"># determine how this object will be instrumented</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>

    <span class="c1"># define our states and their statehandlers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;common_behaviors&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_init</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_1</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_hook_1</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_2</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_hook_2</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_reset</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;a1&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_b1</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_to_b1</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1_init</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1_exit</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">b11</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;b11&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="c1"># nest our states within other states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b11</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># start our statechart, which will start its thread</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span>
</span>    <span class="c1"># give your thread a moment to start and climb into</span>
    <span class="c1"># the appropriate state prior to handing back control</span>
    <span class="c1"># to our client code</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>

<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_hook_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># call the ClassWithStatechartInIt work2 method</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">worker1</span><span class="p">()</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_hook_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># call the ClassWithStatechartInIt work2 method</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">worker2</span><span class="p">()</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">a1_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># post an event to ourselves</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_b1</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">a1_to_b1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b1</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b1_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b1_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># post an event to ourselves</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_1</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b1_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># post an event to ourselves</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_2</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
  <span class="k">def</span> <span class="nf">worker1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;worker1 called&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">worker2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;worker2 called&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">chart</span> <span class="o">=</span> <span class="n">ClassWithStatechartInIt</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;chart&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">reset</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This will result in the following output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mo">06</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">02.662672</span><span class="p">]</span> <span class="p">[</span><span class="n">chart</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mo">06</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">02.662869</span><span class="p">]</span> <span class="p">[</span><span class="n">chart</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_b1</span><span class="p">()</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">b1</span>
<span class="n">worker1</span> <span class="n">called</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mo">06</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">02.664588</span><span class="p">]</span> <span class="p">[</span><span class="n">chart</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">()</span> <span class="n">b1</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="n">worker2</span> <span class="n">called</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mo">06</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mf">02.665011</span><span class="p">]</span> <span class="p">[</span><span class="n">chart</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_b1</span><span class="p">()</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">b1</span>
<span class="n">worker1</span> <span class="n">called</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To see why we start the statechart this way read <a class="reference internal" href="#recipes-inheritance-and-starting-factories"><span class="std std-ref">avoiding the double start bug</span></a>.</p>
</div>
<p>Here is something a bit weirder, a concurrent statechart:</p>
<a class="reference external image-reference" href="_static/factory_in_class.pdf"><div align="center" class="align-center"><img alt="_images/factory_in_class.svg" src="_images/factory_in_class.svg" /></div>
</a>
<p>Above we define a class that contains a statechart that subscribes to, and
publishes events to other statecharts.  The class will be used to create three
objects which will message each other.</p>
<p>Upon starting, there is a 2/5 chance the statechart within
<code class="docutils literal notranslate"><span class="pre">ClassWithStatechartInIt</span></code> will end up within <code class="docutils literal notranslate"><span class="pre">b11</span></code> state.  If a chart ends
up in this state, it will publish the <code class="docutils literal notranslate"><span class="pre">OTHER_INNER_MOST</span></code> signal to any chart
that has subscribed to the signal_name.</p>
<p>The chart sending the <code class="docutils literal notranslate"><span class="pre">OTHER_INNER_MOST</span></code> event ignores it, and all other
charts will respond by re-entering their <code class="docutils literal notranslate"><span class="pre">common_behaviors</span></code> state if they are
not in the <code class="docutils literal notranslate"><span class="pre">b11</span></code> state.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The red and green dots are not UML.  They are markers that act to highlight
the important parts of a concurrent statechart design.</p>
<p>I put the red dot on the part of the chart that is publishing an
event.  It is red because once an item is published, it is put in a queue and the
message flows stops momentarily.</p>
<p class="last">I put the green dot beside events that have been subscribed to and have been
posted to the chart.  They are green, because they have been extracted from a
queue by a thread and are being posted to the event processor attached to the
chart.</p>
</div>
<p>We will make three of these charts, turn on some instrumentation, run them in
parallel and see what happens.</p>
<p>Here is the code (asynchronous parts highlighted):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="k">class</span> <span class="nc">ClassWithStatechartInIt</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c1"># call the Factory ctor</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># determine how this object will be instrumented</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>

    <span class="c1"># define our states and their statehandlers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;common_behaviors&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_init</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_1</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_hook_1</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_2</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_hook_2</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_reset</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OTHER_INNER_MOST</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors_other_inner_most</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;a1&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_b1</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_to_b1</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">b1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1_init</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1_exit</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">b11</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;b11&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b11_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">inner_most</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b11_inner_most</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OTHER_INNER_MOST</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b11_other_inner_most</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="c1"># nest our states within other states</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b11</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b1</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># start our statechart, which will start its thread</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span>
</span>    <span class="c1"># give your thread a moment to start and climb into</span>
    <span class="c1"># the appropriate state prior to handing back control</span>
    <span class="c1"># to our client code</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>

<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OTHER_INNER_MOST</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_hook_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># call the ClassWithStatechartInIt work2 method</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">worker1</span><span class="p">()</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_hook_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># call the ClassWithStatechartInIt work2 method</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">worker2</span><span class="p">()</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_behaviors</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">common_behaviors_other_inner_most</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b11</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">a1_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># post an event to ourselves 2/5 of the time</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_b1</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">a1_to_b1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b1</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b1_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b11</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b1_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># post an event to ourselves</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_1</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b1_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="c1"># post an event to ourselves</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">hook_2</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b11_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">inner_most</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b11_inner_most</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">OTHER_INNER_MOST</span><span class="p">))</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
<span class="hll">  <span class="k">def</span> <span class="nf">b11_other_inner_most</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">status</span>
</span>
  <span class="k">def</span> <span class="nf">worker1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} worker1 called&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">worker2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} worker2 called&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">chart1</span> <span class="o">=</span> <span class="n">ClassWithStatechartInIt</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;chart1&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="n">chart2</span> <span class="o">=</span> <span class="n">ClassWithStatechartInIt</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;chart2&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="n">chart3</span> <span class="o">=</span> <span class="n">ClassWithStatechartInIt</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;chart3&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="c1"># send a reset event to chart1</span>
  <span class="n">chart1</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">reset</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>There is a probabilistic aspect to this program, so it could behave differently
every time you run it.  Here is what I saw when I ran it for the first time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.949042</span><span class="p">]</span> <span class="p">[</span><span class="n">chart1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.949227</span><span class="p">]</span> <span class="p">[</span><span class="n">chart1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_b1</span><span class="p">()</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">b11</span>
<span class="n">chart1</span> <span class="n">worker1</span> <span class="n">called</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.962356</span><span class="p">]</span> <span class="p">[</span><span class="n">chart2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.962482</span><span class="p">]</span> <span class="p">[</span><span class="n">chart2</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_b1</span><span class="p">()</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">b11</span>
<span class="n">chart2</span> <span class="n">worker1</span> <span class="n">called</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.975225</span><span class="p">]</span> <span class="p">[</span><span class="n">chart3</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.985577</span><span class="p">]</span> <span class="p">[</span><span class="n">chart1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">()</span> <span class="n">b11</span><span class="o">-&gt;</span><span class="n">a1</span>
<span class="n">chart1</span> <span class="n">worker2</span> <span class="n">called</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.986041</span><span class="p">]</span> <span class="p">[</span><span class="n">chart1</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_b1</span><span class="p">()</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">b11</span>
<span class="n">chart1</span> <span class="n">worker1</span> <span class="n">called</span>
<span class="p">[</span><span class="mi">2019</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">12</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mf">17.986845</span><span class="p">]</span> <span class="p">[</span><span class="n">chart3</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OTHER_INNER_MOST</span><span class="p">()</span> <span class="n">a1</span><span class="o">-&gt;</span><span class="n">b11</span>
<span class="n">chart3</span> <span class="n">worker1</span> <span class="n">called</span>
</pre></div>
</div>
<p>The diagram describing this concurrent statechart is very compact and detailed,
but we may want an even smaller version which hides the specifics of how the
statechart behaves.</p>
<p>Typically class diagrams are suppose to describe the attributes and the
<code class="docutils literal notranslate"><span class="pre">messages</span></code> (methods) which can be received by an object instantiated from the
class.  When you pack a statechart into a class, the idea of a message brakes
into two things:</p>
<blockquote>
<div><ul class="simple">
<li>synchronous messages (methods), and</li>
<li>asynchronous messages (events)</li>
</ul>
</div></blockquote>
<p>The asynchronous messages should be more nuanced: broken into events intended
only for one statechart (using post_fifo/post_lifo) and events that are intended
to be published into other statecharts which have subscribed to their signal
names.</p>
<p>As far as I know there is no standard way of describing how to do this, so Iâll
show you how I do it:</p>
<a class="reference external image-reference" href="_static/factory_in_class_compact.pdf"><div align="center" class="align-center"><img alt="_images/factory_in_class_compact.svg" src="_images/factory_in_class_compact.svg" /></div>
</a>
<p>We see that the <code class="docutils literal notranslate"><span class="pre">ClassWithStatechartInIt</span></code> state inherits from the <code class="docutils literal notranslate"><span class="pre">Factory</span></code>
and that it has three attributes: <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">live_spy</span></code> and <code class="docutils literal notranslate"><span class="pre">live_trace</span></code>.  It
has two methods, <code class="docutils literal notranslate"><span class="pre">worker1</span></code> and <code class="docutils literal notranslate"><span class="pre">worker2</span></code>.</p>
<p>The rest of the diagram is non-standard:  I put an <code class="docutils literal notranslate"><span class="pre">e</span></code> in front of the
internal (e)vents from the chart, the <code class="docutils literal notranslate"><span class="pre">to_b1</span></code> and the <code class="docutils literal notranslate"><span class="pre">reset</span></code> then I mark the
asynchronous interface, by placing red and green dots on the compact form of a
state icon.  Then place the signal names beside arrows showing how they publish or
subscribe to these signal names.</p>
<p>UML isnât descriptive enough to actually capture a designâs intention, so I
never hesitate to mark up a diagram with code.  In this case, my code is
saying, letâs make three of these things and run them together.</p>
<p>As you become more experienced building statecharts that work in concert, you
will notice that you stop paying any attention to what attributes or methods a
specific class has.  You donât care about itâs internal events and you donât
care about from what it was inherited.  You only care about what published
events it consumes and what events it publishes:</p>
<a class="reference external image-reference" href="_static/factory_in_class_compact_2.pdf"><div align="center" class="align-center"><img alt="_images/factory_in_class_compact_2.svg" src="_images/factory_in_class_compact_2.svg" /></div>
</a>
<p>Then to draw a federation:</p>
<a class="reference external image-reference" href="_static/federation_drawing.pdf"><div align="center" class="align-center"><img alt="_images/federation_drawing.svg" src="_images/federation_drawing.svg" /></div>
</a>
<p>There is probably a much better way to do this, since it looks like three
classes are working together rather than three instantiated objects from the
same class.  UML really falls-over in describing object interactions.</p>
<p>If you have any suggestions about how to draw this better, email me.</p>
</div>
<div class="section" id="inheritance-and-starting-factories">
<span id="recipes-inheritance-and-starting-factories"></span><h3><a class="toc-backref" href="#id71">Inheritance and Starting (Factories)</a><a class="headerlink" href="#inheritance-and-starting-factories" title="Permalink to this headline">Â¶</a></h3>
<p>If you write the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> call inside of the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method of a
Factory object which you are intending to overload using inheritance, you are in
for a world of trouble-shooting pain.  Your inherited class will inadvertently
start its parent active object, your heart-beat events will be duplicated and
your chart will appear to run (n+1)X as fast, where n is the number of inheritance
actions you have taken on your factory-derived class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Charger</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">):</span>

      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

      <span class="c1"># define attributes ...</span>
      <span class="c1"># define states ...</span>
      <span class="c1"># nest states ...</span>
      <span class="c1"># start the chart (making a debugging time-bomb by having this in the</span>
      <span class="c1"># __init__ method)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="o">&lt;</span><span class="n">state_name</span><span class="o">&gt;</span><span class="p">)</span> <span class="c1"># starts a thread</span>

<span class="k">class</span> <span class="nc">ChargerChild</span><span class="p">(</span><span class="n">Charger</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">):</span>

      <span class="c1"># this will construct the parents state machine and start it</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">)</span>

      <span class="c1"># overload attributes ...</span>
      <span class="c1"># overload states ...</span>
      <span class="c1"># nest states ...</span>
      <span class="c1"># start the chart, BUT IT IS ALREADY RUNNING!</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="o">&lt;</span><span class="n">state_name</span><span class="o">&gt;</span><span class="p">)</span> <span class="c1"># starts another thread</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

   <span class="c1"># This object has two threads running its active object, so any</span>
   <span class="c1"># heart beat will be running twice as fast and along with other weird</span>
   <span class="c1"># multithreading race bugs.</span>
   <span class="n">charger_child</span> <span class="o">=</span> <span class="n">ChargerChild</span><span class="p">(</span>
     <span class="n">name</span><span class="o">=</span><span class="s2">&quot;charger&quot;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">False</span>
   <span class="p">)</span>
</pre></div>
</div>
<p>To avoid such an issue, you can explicitly call the <code class="docutils literal notranslate"><span class="pre">start_at</span></code> method with the
state you would like your statechart to start in <em>outside</em> of the <code class="docutils literal notranslate"><span class="pre">__init__</span></code>
call.  But, if you do this <code class="docutils literal notranslate"><span class="pre">state_at</span></code> call is made entirely outside of the
Factory, you will no longer be data-hiding its state information from the client
code, (which defeats one of the reasons to use a Factory in the first place).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Charger</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">):</span>

      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

      <span class="c1"># define attributes ...</span>
      <span class="c1"># define states ...</span>
      <span class="c1"># nest states ...</span>

<span class="k">class</span> <span class="nc">ChargerChild</span><span class="p">(</span><span class="n">Charger</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">):</span>

      <span class="c1"># this will construct the parents state machine and start it</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">)</span>

      <span class="c1"># overload attributes ...</span>
      <span class="c1"># overload states ...</span>
      <span class="c1"># nest states ...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

   <span class="n">charger_child</span> <span class="o">=</span> <span class="n">ChargerChild</span><span class="p">(</span>
     <span class="n">name</span><span class="o">=</span><span class="s2">&quot;charger&quot;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">False</span>
   <span class="p">)</span>
   <span class="c1"># Create a thread and start the object in the &lt;state_name&gt; state</span>
   <span class="c1"># (but I don&#39;t want to have to know how the charger_child object works.</span>
   <span class="c1"># The Charger knows where it needs to start, but I don&#39;t want it to start</span>
   <span class="c1"># itself in the __init__ state (for the reasons described above).</span>
   <span class="n">charger_child</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">charger_child</span><span class="o">.&lt;</span><span class="n">state_name</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead, create a <code class="docutils literal notranslate"><span class="pre">start</span></code> method which returns self.  This way you can create
and start an active object in one chained-call, hide state from the client and
still have the option of opening up the active object for re-writes through
inheritance without accidently starting parent renegade threads.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Charger</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">):</span>

      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

      <span class="c1"># define attributes ...</span>
      <span class="c1"># define states ...</span>
      <span class="c1"># nest states ...</span>

   <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.&lt;</span><span class="n">state_name</span><span class="o">&gt;</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">ChargerChild</span><span class="p">(</span><span class="n">Charger</span><span class="p">):</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">):</span>

      <span class="c1"># this will construct the parents state machine and start it</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">)</span>

      <span class="c1"># overload attributes ...</span>
      <span class="c1"># overload states ...</span>
      <span class="c1"># nest states ...</span>
      <span class="c1"># start the chart, BUT IT IS ALREADY RUNNING!</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

   <span class="c1"># Initialize the ChargerChild statechart and start it, the starting state</span>
   <span class="c1"># is hidden within the obj, so as a client I don&#39;t have to know how its</span>
   <span class="c1"># inner state machine works.</span>
   <span class="n">charger_child</span> <span class="o">=</span> <span class="n">ChargerChild</span><span class="p">(</span>
     <span class="n">name</span><span class="o">=</span><span class="s2">&quot;charger&quot;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">False</span>
   <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>The added benefit of this approach is that the subclass can start the object in
a different initial state by overloading the <code class="docutils literal notranslate"><span class="pre">start</span></code> method.</p>
</div>
<div class="section" id="sharing-attributes-between-threads-factories">
<span id="recipes-sharing-attributes-between-threads-factories"></span><h3><a class="toc-backref" href="#id72">Sharing Attributes between Threads (Factories)</a><a class="headerlink" href="#sharing-attributes-between-threads-factories" title="Permalink to this headline">Â¶</a></h3>
<p>As of miros version v4.1.3 (fixed in v4.1.4), you can create
<a class="reference internal" href="thread_safe_attributes.html#thread-safe-attributes-thread-safe-attributes"><span class="std std-ref">thread-safe-attributes</span></a> in
your derived <code class="docutils literal notranslate"><span class="pre">Factory</span></code> class by inheriting from <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code>.</p>
<p>To create one or more thread safe attribute, you add them to the list defined
<code class="docutils literal notranslate"><span class="pre">_attributes</span></code> within the class body before the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method is defined.
See below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ThreadSafeAttributes</span>

<span class="c1"># By inheriting from ThreadSafeAttributes, you can define as many thread safe</span>
<span class="c1"># attributes you need by assigning their names as strings to the</span>
<span class="c1"># `_attributes` list.</span>
<span class="k">class</span> <span class="nc">Example2</span><span class="p">(</span><span class="n">Factory</span><span class="p">,</span> <span class="n">ThreadSafeAttributes</span><span class="p">):</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;thread_safe_attr_1&#39;</span><span class="p">,</span> <span class="s1">&#39;thread_safe_attr_2&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

  <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># .. you can access this from main or other</span>
                                  <span class="c1"># threads in the same way</span>

  <span class="c1"># ... define states, link them to their signals</span>
  <span class="c1"># ... nesting code, etc.</span>

  <span class="c1"># statechart thread is created and started when `start_at` is called</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>  <span class="c1">#</span>

<span class="c1"># ... state methods defined here</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

  <span class="n">statechart</span> <span class="o">=</span> <span class="n">Example2</span><span class="p">(</span><span class="s1">&#39;example2&#39;</span><span class="p">)</span>     <span class="c1"># thread is started and is running</span>
                                        <span class="c1"># because `start_at` called within</span>
                                        <span class="c1"># the `__init__` method.</span>

  <span class="k">print</span><span class="p">(</span><span class="n">statechart</span><span class="o">.</span><span class="n">thread_safe_attr_1</span><span class="p">)</span>  <span class="c1"># you can access the attribute which</span>
                                        <span class="c1"># is being used by the statechart&#39;s</span>
                                        <span class="c1"># thread, since it&#39;s wrapped</span>
                                        <span class="c1"># by a thread-safe datastructure</span>
</pre></div>
</div>
<p>By inheriting from the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class, we get access to the
<code class="docutils literal notranslate"><span class="pre">_attributes</span></code> feature.  By assigning a list of strings to this <code class="docutils literal notranslate"><span class="pre">_attributes</span></code>
class attribute, a set of thread safe attributes are created an initialized in
the background before the Example2 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method is called.</p>
<p>To see a full example look <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/thread_safe_attributes_in_factory.py">here</a>.</p>
</div>
</div>
<div class="section" id="multiple-statecharts">
<span id="recipes-multiple-statecharts"></span><h2><a class="toc-backref" href="#id73">Multiple Statecharts</a><a class="headerlink" href="#multiple-statecharts" title="Permalink to this headline">Â¶</a></h2>
<p>Break your design down into different interacting charts by using the
ActiveFabric.</p>
<p>The active fabric is a set of background tasks which act together to dispatch
events between the active objects in your system.</p>
<p>As a user of the software you wouldnât touch the active fabric directly, but
instead would use your active objectâs <code class="docutils literal notranslate"><span class="pre">publish</span></code> and <code class="docutils literal notranslate"><span class="pre">subscribe</span></code> methods.  The
active fabric has two different priority queues and two different tasks which
pend upon them.  One is for managing subscriptions in a first in first (fifo)
out manner, the other is for managing messages in a last in first out (lifo)
manner.  By having two different queues and two different tasks an active
object is given the option to subscribe to another active objectâs published
events, using one of two different strategies:</p>
<ol class="arabic simple">
<li>If it subscribes to an event using the <code class="docutils literal notranslate"><span class="pre">fifo</span></code> strategy, the active fabric
will post events to it using its <a class="reference internal" href="#recipes-posting-an-event-to-the-fifo"><span class="std std-ref">post_fifo</span></a> method.</li>
<li>If it subscribes in a <code class="docutils literal notranslate"><span class="pre">lifo</span></code> way it will post using the <a class="reference internal" href="#recipes-posting-an-event-to-the-lifo"><span class="std std-ref">post_lifo</span></a> method.</li>
</ol>
<p>You can also set the priority of the event while it is in transit within the
active fabric.  This would only be useful if you are expecting contention
between various events being dispatched across your system.</p>
<div class="section" id="building-and-destroying-workers">
<span id="recipes-building-workers"></span><h3><a class="toc-backref" href="#id74">Building and Destroying Workers</a><a class="headerlink" href="#building-and-destroying-workers" title="Permalink to this headline">Â¶</a></h3>
<p>If you have a long running task that has to access blocking IO or connect to a
slow API, you can wrap it up into a worker.  Unlike stateless architectures,
with miros you can make your workers as complicated as you want, sending them
events as they sit or pend; change their behaviors in response to unexpected
things, or even have rich communications with them prior to having them destroy
themselves.</p>
<p>A worker can be thought of as some code sitting in a parallel thread, which will
do work, then post the results of this work back to their federation before they
prepare themselves for garbage collection.</p>
</div>
</div>
<div class="section" id="seeing-what-is-going-on">
<span id="recipes-seeing-what-is"></span><h2><a class="toc-backref" href="#id75">Seeing What is Going On</a><a class="headerlink" href="#seeing-what-is-going-on" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="determining-the-current-state">
<span id="recipes-determining-the-current-state"></span><h3><a class="toc-backref" href="#id76">Determining the Current State</a><a class="headerlink" href="#determining-the-current-state" title="Permalink to this headline">Â¶</a></h3>
<p>To see what state your chart is in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll">  <span class="c1"># state name as a string</span>
</span><span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">state_name</span>
</span>
  <span class="c1"># state as a function</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">state_fn</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This will only work if you have wrapped your statemethod with a <code class="docutils literal notranslate"><span class="pre">&#64;spy_on</span></code>
decorator or if you have constructed your statechart with the Factory class.</p>
</div>
</div>
<div class="section" id="seeing-what-signals-you-have-in-your-system">
<span id="recipes-seeing-what-signals-you-have-in-your-system"></span><h3><a class="toc-backref" href="#id77">Seeing what Signals You Have In Your System</a><a class="headerlink" href="#seeing-what-signals-you-have-in-your-system" title="Permalink to this headline">Â¶</a></h3>
<span class="target" id="recipes-seeing-your-signals"></span><p>A signal is the name that can be given to an event.  To get access to your
signals:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
</pre></div>
</div>
<p>The signals object is provided by a singleton of the SignalSource class, which
is just an OrderedDictionary with a <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> method to make the syntax
easier to use.</p>
<p><cite>This basically means that you can think of the signals object as being a dict
that is shared across your whole program.</cite></p>
<p>To see your signals, you just reflect upon it like you would with any other
Python dictionary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># To see your signal names:</span>
<span class="n">signal_names</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<span class="c1"># To see your signal numbers:</span>
<span class="n">signal_numbers</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

<span class="c1"># To output your names and number:</span>
<span class="k">for</span> <span class="n">signal_name</span><span class="p">,</span> <span class="n">signal_number</span> <span class="ow">in</span> <span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">signal_number</span><span class="p">)</span>

<span class="c1"># same output with some formatting</span>
<span class="n">max_name_len</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">))</span>
<span class="n">max_number_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="nb">int</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">signal_name</span><span class="p">,</span> <span class="n">signal_number</span> <span class="ow">in</span> <span class="n">signals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{1: &lt;{0}} {2:{3}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_name_len</span><span class="p">,</span>
                                   <span class="n">signal_name</span><span class="p">,</span>
                                   <span class="n">signal_number</span><span class="p">,</span>
                                   <span class="n">max_number_len</span><span class="p">))</span>  <span class="c1"># output below -&gt;</span>
  <span class="c1"># ENTRY_SIGNAL            1</span>
  <span class="c1"># EXIT_SIGNAL             2</span>
  <span class="c1"># INIT_SIGNAL             3</span>
  <span class="c1"># REFLECTION_SIGNAL       4</span>
  <span class="c1"># SEARCH_FOR_SUPER_SIGNAL 5</span>
  <span class="c1"># ..</span>
</pre></div>
</div>
<p>To compare a received event against a signal, compare the signal numbers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">some_example_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANLDED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span>    <span class="c1"># do something</span>
</pre></div>
</div>
<p>It you wanted to read an eventâs signals name as a string, you would call the
<code class="docutils literal notranslate"><span class="pre">signal_name</span></code> method of the Event class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">some_example_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANLDED</span>
<span class="hll">  <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span> <span class="c1"># &quot;ENTRY_SIGNAL&quot;</span>
</span></pre></div>
</div>
<p>If you have a signal number and you want to determine itâs name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">signal_name</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">name_for_signal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># ENTRY_SIGNAL</span>
<span class="n">signal_name</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">name_for_signal</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">)</span> <span class="c1"># ENTRY_SIGNAL</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-trace">
<span id="recipes-using-the-trace"></span><h3><a class="toc-backref" href="#id78">Using the Trace</a><a class="headerlink" href="#using-the-trace" title="Permalink to this headline">Â¶</a></h3>
<p>If you would like to see what your active object was doing from a <strong>very high
level</strong>, you can look at itâs <cite>trace</cite> instrumentation.  The trace will only
create a log item if a state transition has occurred. Each line in the <cite>trace</cite>
will contain:</p>
<ol class="arabic simple">
<li>A datetime stamp between square brackets</li>
<li>The active object name, between square brackets</li>
<li>The event that caused the transition, its signal number and its payload</li>
<li>The starting state</li>
<li>The ending state</li>
</ol>
<p>If you havenât named your active object, a unique identifier is given to it,
and the first 5 characters of this unique identifier will be used in the trace.
The reason that an identifier is given to it is so that the trace outputs, from
multiple active objects, can be distinguished from one another.</p>
<p>Suppose you have built the tazor active object described in the <span class="xref std std-ref">second
example</span>. Suppose you named this active object <cite>tazor</cite>:
To see the trace you would type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tazor</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
</pre></div>
</div>
<p>This would output the following trace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">28.268873</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">arming</span>
</span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">arming</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
</pre></div>
</div>
<p>Notice that on line one, the signal is called <cite>start_at</cite>.  There is no signal
called <cite>start_at</cite>, here the trace is actually using the method name <cite>start_at</cite>
to indicate how the chart was started.</p>
<p>A trace can be used with the <cite>sequence</cite> project to generate a sequence diagram,
more about that is described <span class="xref std std-ref">here.</span></p>
</div>
<div class="section" id="using-the-spy">
<span id="recipes-using-the-spy"></span><span id="reflection-an-extremely-detailed-view"></span><h3><a class="toc-backref" href="#id79">Using the Spy</a><a class="headerlink" href="#using-the-spy" title="Permalink to this headline">Â¶</a></h3>
<p>If you need a <strong>very detailed description</strong> of your systemâs behavior you will want
to use the <cite>spy</cite> instrumentation.  The spy outputs:</p>
<ol class="arabic simple">
<li>All of the internal activity that is run by the event processor</li>
<li>How your chart reacts to the events it has received</li>
<li>Information about what happened between each of the rtc activities.</li>
<li>If a signal was hooked by a state</li>
<li>If and when a signal was <a class="reference internal" href="#recipes-deferring-an-event"><span class="std std-ref">deferred</span></a></li>
<li>If and when a signal was <a class="reference internal" href="#recipes-deferring-an-event"><span class="std std-ref">recalled</span></a></li>
<li>The number of events awaiting immediate processing after a specific rtc activity.</li>
<li>The number of events which have had their processing deferred.</li>
</ol>
<p>If you donât understand what these terms mean, read the
<a class="reference internal" href="postingexample.html#examples-simple-posting-example"><span class="std std-ref">simple posting example</span></a>, since it
introduces all of these ideas.</p>
<p>To access the full spy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import a pretty printer (like print)</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>

<span class="c1"># .. state charts and other code here</span>

<span class="c1"># Assuming your active object is called `ao`</span>
<span class="c1"># we use the pretty printer to write the</span>
<span class="c1"># full spy log to the terminal</span>
<span class="n">pp</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</pre></div>
</div>
<p>This might output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:middle&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;A:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;A:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;A:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(2)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;A:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;A:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_DEFERRED:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:inner&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(3)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;D:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;D:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;D:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;D:outer:HOOK&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(2)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;B:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;B:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;B:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:inner&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;RECALL:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:outer&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(1)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;B:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;POST_FIFO:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;RECALL:B&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:outer&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span><span class="p">,</span>
</span> <span class="s1">&#39;B:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EXIT_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;INIT_SIGNAL:outer&#39;</span><span class="p">,</span>
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>
</span></pre></div>
</div>
<p>If you would like to understand in detail how to read this log, and how it
might have occurred, reference <a class="reference internal" href="postingexample.html#examples-simple-posting-example"><span class="std std-ref">the example from which it
came</span></a>.</p>
<p>The spy log is a ring buffer that contains 500 spots.  This is so your system
can run forever without using an infinite amount of memory.  Once the internal
spy log has run out of room, it will shift out the old data and write the new
data at the tail end of its log.</p>
</div>
<div class="section" id="add-timing-information-to-the-spy">
<span id="recipes-add-timing-information-to-the-spy"></span><h3><a class="toc-backref" href="#id80">Add Timing Information to the Spy</a><a class="headerlink" href="#add-timing-information-to-the-spy" title="Permalink to this headline">Â¶</a></h3>
<p>The spy doesnât contain timing information, if you would like to mark it up
with time so that you can compare it with the trace output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="c1"># .</span>
<span class="c1"># .</span>
<span class="c1"># In your state method or callback code write:</span>
<span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;{} at {}&quot;</span><span class="o">.</span> \
    <span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M:%S:</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="section" id="tracing-live">
<span id="recipes-tracing-live"></span><h3><a class="toc-backref" href="#id81">Tracing Live</a><a class="headerlink" href="#tracing-live" title="Permalink to this headline">Â¶</a></h3>
<p>There are situations where you would like to see what an active object is doing
while it is running.  Each active object has an attribute called
<code class="docutils literal notranslate"><span class="pre">live_trace</span></code>.  By setting this attribute to <code class="docutils literal notranslate"><span class="pre">True</span></code> the active object will
output itâs trace information to the terminal while it reacts to events:</p>
<p>To turn on/off the live trace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao1</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="c1"># turn on the live trace</span>
<span class="hll"><span class="n">ao1</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="c1"># your code and state interactions here</span>
<span class="c1"># live trace information will be displayed on the terminal</span>

<span class="c1"># turn off the live trace</span>
<span class="hll"><span class="n">ao1</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span>
</span></pre></div>
</div>
</div>
<div class="section" id="spying-live">
<span id="recipes-spying-live"></span><h3><a class="toc-backref" href="#id82">Spying Live</a><a class="headerlink" href="#spying-live" title="Permalink to this headline">Â¶</a></h3>
<p>There are situations where you would like to see what an active object is doing
while it is running.  Each active object has an attribute called
<code class="docutils literal notranslate"><span class="pre">live_spy</span></code>.  By setting this attribute to <code class="docutils literal notranslate"><span class="pre">True</span></code> the active object will
output itâs spy information to the terminal while it reacts to events:</p>
<p>To turn on/off the live spy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao1</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="c1"># turn on the live spy</span>
<span class="hll"><span class="n">ao1</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class="c1"># your code and state interactions here</span>
<span class="c1"># live spy information will be displayed on the terminal</span>

<span class="c1"># turn off the live spy</span>
<span class="hll"><span class="n">ao1</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span>
</span></pre></div>
</div>
</div>
<div class="section" id="scribble-on-the-spy">
<span id="recipes-scribble-on-the-spy"></span><h3><a class="toc-backref" href="#id83">Scribble On the Spy</a><a class="headerlink" href="#scribble-on-the-spy" title="Permalink to this headline">Â¶</a></h3>
<p>To add messaging to your spy log so that you can see how an activity is
situated within the statechartâs behavior, use the <code class="docutils literal notranslate"><span class="pre">scribble</span></code> api within your
state method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">s2_state</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">chart</span><span class="p">):</span>
<span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;running c()&quot;</span><span class="p">)</span>
</span>
  <span class="k">def</span> <span class="nf">d</span><span class="p">(</span><span class="n">chart</span><span class="p">):</span>
<span class="hll">    <span class="n">chart</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;running d()&quot;</span><span class="p">)</span>
</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">d</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">s21_state</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">s_state</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</div>
<div class="section" id="flatting-a-state-method">
<span id="recipes-flatting-a-state-method"></span><h3><a class="toc-backref" href="#id84">Flatting a State Method</a><a class="headerlink" href="#flatting-a-state-method" title="Permalink to this headline">Â¶</a></h3>
<p>If you have created a state method using either a <code class="docutils literal notranslate"><span class="pre">template</span></code> or a <code class="docutils literal notranslate"><span class="pre">Factory</span></code>
and you would like to see itâs code as if it where written by hand, use the
<code class="docutils literal notranslate"><span class="pre">to_code</span></code> call.</p>
<p>Letâs first look how to flatten a template state method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">state_method_template</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>

<span class="k">def</span> <span class="nf">trans_to_fc1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">fc1</span><span class="p">)</span>

<span class="c1"># create a state method using a template</span>
<span class="n">fc</span> <span class="o">=</span> <span class="n">state_method_template</span><span class="p">(</span><span class="s1">&#39;fc&#39;</span><span class="p">)</span>

<span class="c1"># build an active object, which has an event processor</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>

<span class="c1"># write the design information into the fc state method</span>
<span class="n">ao</span><span class="o">.</span><span class="n">register_signal_callback</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">signals</span><span class="o">.</span><span class="n">BB</span><span class="p">,</span> <span class="n">trans_to_fc</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">register_signal_callback</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>  <span class="n">trans_to_fc1</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">register_parent</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>

<span class="c1"># to see how fc would be written as a flat method:</span>
<span class="hll"><span class="k">print</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="c1"># -&gt;</span>
</span>  <span class="c1"># @spy_on</span>
  <span class="c1"># def fc(chart, e):</span>
  <span class="c1">#   status = return_status.UNHANDLED</span>
  <span class="c1">#   if(e.signal == signals.ENTRY_SIGNAL):</span>
  <span class="c1">#     status = return_status.HANDLED</span>
  <span class="c1">#   elif(e.signal == signals.INIT_SIGNAL):</span>
  <span class="c1">#     status = trans_to_fc1(chart, e)</span>
  <span class="c1">#   elif(e.signal == signals.BB):</span>
  <span class="c1">#     status = trans_to_fc(chart, e)</span>
  <span class="c1">#   elif(e.signal == signals.EXIT_SIGNAL):</span>
  <span class="c1">#     status = return_status.HANDLED</span>
  <span class="c1">#   else:</span>
  <span class="c1">#     status, chart.temp.fun = return_status.SUPER, chart.top</span>
  <span class="c1">#   return status</span>
</pre></div>
</div>
<p>Above we see that the state method is flattened using the <code class="docutils literal notranslate"><span class="pre">to_code</span></code> method of
the active object.  You could copy this and drop it into your design for
debugging purposes.</p>
<p>The same process applies for a state method built using the <code class="docutils literal notranslate"><span class="pre">Factory</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ActiveObject</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>

<span class="c1"># create the specific behavior we want in our state chart</span>
<span class="k">def</span> <span class="nf">trans_to_fc1</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">fc1</span><span class="p">)</span>

<span class="n">chart</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="s1">&#39;factory_class_recipe_example&#39;</span><span class="p">)</span>

<span class="n">fc</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;fc&#39;</span><span class="p">)</span><span class="o">.</span>                             \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BB</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">trans_to_fc</span><span class="p">)</span><span class="o">.</span>           \
  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">trans_to_fc1</span><span class="p">)</span><span class="o">.</span> \
  <span class="n">to_method</span><span class="p">()</span>

<span class="hll"><span class="n">chart</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="c1"># =&gt;</span>
</span>  <span class="c1"># @spy_on</span>
  <span class="c1"># def fc(chart, e):</span>
  <span class="c1">#   status = return_status.UNHANDLED</span>
  <span class="c1">#   if(e.signal == signals.ENTRY_SIGNAL):</span>
  <span class="c1">#     status = return_status.HANDLED</span>
  <span class="c1">#   elif(e.signal == signals.INIT_SIGNAL):</span>
  <span class="c1">#     status = trans_to_fc1(chart, e)</span>
  <span class="c1">#   elif(e.signal == signals.BB):</span>
  <span class="c1">#     status = trans_to_fc(chart, e)</span>
  <span class="c1">#   elif(e.signal == signals.EXIT_SIGNAL):</span>
  <span class="c1">#     status = return_status.HANDLED</span>
  <span class="c1">#   else:</span>
  <span class="c1">#     status, chart.temp.fun = return_status.SUPER, chart.top</span>
  <span class="c1">#   return status</span>
</pre></div>
</div>
<p>To see how to unwind an auto-generated statechart read
<a class="reference internal" href="towardsthefactoryexample.html#towardsthefactoryexample-unwinding-a-factory-state-method"><span class="std std-ref">unwinding a state method</span></a></p>
</div>
</div>
<div class="section" id="describing-your-work">
<span id="recipes-describing-your-work"></span><h2><a class="toc-backref" href="#id85">Describing your Work</a><a class="headerlink" href="#describing-your-work" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="drawing-a-statechart">
<span id="recipes-drawing-a-statechart"></span><h3><a class="toc-backref" href="#id86">Drawing a StateChart</a><a class="headerlink" href="#drawing-a-statechart" title="Permalink to this headline">Â¶</a></h3>
<p>The Harel formalism was consumed by the UML standard.</p>
<p>The UML standards were not properly curated and became overly-complicated and
full of contradictions.  As a result, they are largely disregarded by the
software community, so most of the open source drawing tool projects
have been abandoned.</p>
<p>A lot of the commercial drawing tools have tried to keep up with the overly
complicated UML standards, so you end up fighting with the tools when you just
want to draw a simple picture.  The point of the picture is to be expressive
enough to explain something to someone else.</p>
<p>So in many ways UML has become a kind of anti-brand but it has itâs good parts.
Skip the class diagrams and use the <a class="reference internal" href="#recipes-drawing-a-sequence-diagram"><span class="std std-ref">sequence
diagram</span></a> and the statecharts.</p>
<p>A statechart drawing tool only needs to provide the following features:</p>
<ol class="arabic simple">
<li>zoom in and out of a diagram.</li>
<li>draw the basic Harel statemachine building blocks.</li>
<li>draw arrows and the other useful parts of UML.</li>
<li>mark up the diagram with code</li>
<li>be simple to change a design</li>
</ol>
<p>Pencil and paper are great for drawing your designs.  It is good to work on
them over and over again without the impediment of the computer interface
getting in your way.</p>
<p>Once you think you have it figured out you can transfer the picture into
something digital using a free tool called <a class="reference external" href="http://www.umlet.com/">umlet</a>.</p>
<p>There is also an online version of the tool, which is called <a class="reference external" href="http://www.umlet.com/umletino/umletino.html">umletino</a>.</p>
<p>It is easy to use and it has a lot of youtube training videos.  It doesnât
provide the zooming features asked for by the original Harel paper (1987), but
this could be implemented using HTML/SVG if you have a lot of spare time.</p>
<p>If you want to drop an ASCII art picture into your code (which you will see in
the examples) you can use the <a class="reference external" href="https://github.com/vim-scripts/DrawIt">drawit</a> vim plugin, or something like it for
your text editor.  If you donât know how to do it yet, look up vertical
editing, this is required if you are going to sketch in meaningful pictures.</p>
</div>
<div class="section" id="drawing-a-sequence-diagram">
<span id="recipes-drawing-a-sequence-diagram"></span><h3><a class="toc-backref" href="#id87">Drawing a Sequence Diagram</a><a class="headerlink" href="#drawing-a-sequence-diagram" title="Permalink to this headline">Â¶</a></h3>
<p>To create effective, yet inexpensive documentation, you can <a class="reference internal" href="reflection.html#reflection-a-high-level-description-of-the-behavior"><span class="std std-ref">first obtain
a trace of your system</span></a>,
then use it to generate a sequence diagram, with <a class="reference external" href="https://github.com/aleph2c/sequence">sequence</a>.</p>
<p>Without a lot of effort, you can configure your text editor to write these
pictures for you.  When I select this in my editor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">28.268873</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">arming</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">arming</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
</pre></div>
</div>
<p>Then press &lt;ctrl-T&gt;, it becomes this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>[ Chart: 75c8c ] (?)
     top        arming        armed
      +-tart_at()-&gt;|            |
      |    (?)     |            |
      |            +---BC()----&gt;|
      |            |    (?)     |
      |            |            +
      |            |             \ (?)
      |            |             BC()
      |            |             /
      |            |            &lt;
</pre></div>
</div>
<p>Then I would manually replace the question marks with numbers, so that
I could explained each event by referencing its number.  Since my diagram is in
ASCII, I could place it in my code comments.</p>
<p><a class="reference external" href="https://github.com/aleph2c/sequence">sequence</a> also works with interleaving trace outputs that would come from two
different interacting active objects:</p>
<p>Suppose you got this from your terminal while testing two different
statecharts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">28.268873</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">arming</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">28.268873</span><span class="p">]</span> <span class="p">[</span><span class="mi">95</span><span class="n">a8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">arming</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">arming</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">95</span><span class="n">a8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">OTHER</span><span class="p">()</span> <span class="n">arming</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">75</span><span class="n">c8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">95</span><span class="n">a8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mi">08</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">26.312241</span><span class="p">]</span> <span class="p">[</span><span class="mi">95</span><span class="n">a8c</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
</pre></div>
</div>
<p>By running it through <a class="reference external" href="https://github.com/aleph2c/sequence">sequence</a> we would see:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>[ Chart: 75c8c ] (?)
     top        arming        armed
      +-tart_at()-&gt;|            |
      |    (?)     |            |
      |            +---BC()----&gt;|
      |            |    (?)     |
      |            |            +
      |            |             \ (?)
      |            |             BC()
      |            |             /
      |            |            &lt;

[ Chart: 95a8c ] (?)
     top        arming        armed
      +-tart_at()-&gt;|            |
      |    (?)     |            |
<span class="hll">      |            +--OTHER()--&gt;|
</span>      |            |    (?)     |
      |            |            +
      |            |             \ (?)
      |            |             BC()
      |            |             /
      |            |            &lt;
</pre></div>
</div>
<p>Now Iâll write some fake documentation to make a point, notice how I update the
numbers in the diagram:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="n">Chart</span><span class="p">:</span> <span class="n">Unit</span> <span class="mi">1</span> <span class="p">]</span>
     <span class="n">top</span>        <span class="n">arming</span>        <span class="n">armed</span>
      <span class="o">+</span><span class="n">start_at</span><span class="p">()</span><span class="o">-&gt;|</span>            <span class="o">|</span>
      <span class="o">|</span>    <span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="o">|</span>            <span class="o">|</span>
      <span class="o">|</span>            <span class="o">+---</span><span class="n">BC</span><span class="p">()</span><span class="o">----&gt;|</span>
      <span class="o">|</span>            <span class="o">|</span>    <span class="p">(</span><span class="mi">3</span><span class="p">)</span>     <span class="o">|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">+</span>
      <span class="o">|</span>            <span class="o">|</span>             \ <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="o">|</span>            <span class="o">|</span>             <span class="n">BC</span><span class="p">()</span>
      <span class="o">|</span>            <span class="o">|</span>             <span class="o">/</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">&lt;</span>

<span class="p">[</span> <span class="n">Chart</span><span class="p">:</span> <span class="n">Unit</span> <span class="mi">2</span> <span class="p">]</span>
     <span class="n">top</span>        <span class="n">arming</span>        <span class="n">armed</span>
      <span class="o">+</span><span class="n">start_at</span><span class="p">()</span><span class="o">-&gt;|</span>            <span class="o">|</span>
      <span class="o">|</span>    <span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="o">|</span>            <span class="o">|</span>
<span class="hll">      <span class="o">|</span>            <span class="o">+--</span><span class="n">OTHER</span><span class="p">()</span><span class="o">--&gt;|</span>
</span>      <span class="o">|</span>            <span class="o">|</span>    <span class="p">(</span><span class="mi">4</span><span class="p">)</span>     <span class="o">|</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">+</span>
      <span class="o">|</span>            <span class="o">|</span>             \ <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
      <span class="o">|</span>            <span class="o">|</span>             <span class="n">BC</span><span class="p">()</span>
      <span class="o">|</span>            <span class="o">|</span>             <span class="o">/</span>
      <span class="o">|</span>            <span class="o">|</span>            <span class="o">&lt;</span>
</pre></div>
</div>
<p>You can gang two tazors together to act as one tazor.  The first arming event
in your tazor network will also arm all of the other tazors, consider the
diagram above to see this interaction.</p>
<ol class="arabic simple">
<li>Tazor labeled âUnit 1â turns on in the <cite>arming</cite> state.</li>
<li>Tazor labeled âUnit 2â turns on in the <cite>arming</cite> state.</li>
<li>Unit 1 begins a battery charge (BC) which will send a broadcast message to
all other tazors in the network.</li>
<li>Unit 2 detects another tazor is beginning a battery charge, so it too begins
itâs battery charge (OTHER)</li>
</ol>
<p>â¦. and so on</p>
<p>If I changed the above design, it would be simple to adjust these diagrams and
their description.  Sequence diagrams are great for explaining small things,
but they do break the <a class="reference external" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> principle.  You are effectively replicating your
data by having these descriptions in your documentation.  The source <cite>image</cite> is
your state chart diagram.  Give it a lot of attention, since it is actually
your specification.  The sequence diagrams are little throw away things, that
can be used to assist in telling a very specific story about how your system
behaves.</p>
<p>Iâm probably not following the UML standard and I donât care.  The utility of
the sequence diagram picture is in its simplicity.</p>
<p>I know that you can represent loops and object destructorâs using these
diagrams, but why bother?  It is easier to write a loop in the code than it is
in a picture, so why not copy and paste the code onto the sequence diagram if
you need to explain a loop?</p>
<p>If you would like to create sequence diagrams that are UML compliant, the
<a class="reference external" href="http://www.umlet.com/">umlet</a> program supports these features.</p>
</div>
</div>
<div class="section" id="testing">
<span id="recipes-testing"></span><h2><a class="toc-backref" href="#id88">Testing</a><a class="headerlink" href="#testing" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="using-a-trace-as-a-test-target">
<span id="recipes-using-a-trace-as-a-test-target"></span><h3><a class="toc-backref" href="#id89">Using a Trace As a Test Target</a><a class="headerlink" href="#using-a-trace-as-a-test-target" title="Permalink to this headline">Â¶</a></h3>
<p>If you would like to sketch out the high level behavior of your statechart using
a trace output as the target for a regression test, you would:</p>
<ol class="arabic simple">
<li>Run your program and print your trace to the output.</li>
<li>Copy this trace as the target behavior of your test.</li>
<li>Run this trace target and the future output of the statechart trace through
the <a class="reference internal" href="#stripped-example"><span class="std std-ref">stripped context manager</span></a> to remove the date
timestamp information.</li>
<li>Compare your target with the results.</li>
</ol>
<p>This should become clear with an example.</p>
<p>Consider a statechart that outputted the following at the point when you were
working on it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="mi">21</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mf">56.098526</span><span class="p">]</span> <span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">arming</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="mi">21</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mf">56.200047</span><span class="p">]</span> <span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">arming</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="mi">21</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mf">56.300974</span><span class="p">]</span> <span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">05</span> <span class="mi">21</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mf">56.401682</span><span class="p">]</span> <span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
</pre></div>
</div>
<p>You might have gotten this output with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">tazor</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
</pre></div>
</div>
<p>It does a decent job describing what we want, but it has timestamps.  With the
<cite>stripped</cite> context manager we can turn the above into something that would look
like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">arming</span>
<span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">arming</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
<span class="p">[</span><span class="n">tazor</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">BATTERY_CHARGE</span><span class="p">()</span> <span class="n">armed</span><span class="o">-&gt;</span><span class="n">armed</span>
</pre></div>
</div>
<p>That is something that shouldnât change over time, it looks like something we
could use as a test specification.  The only problem is that when we run the
code in the future and generate a new trace we get a trace with a pre-pended
date timestamp.  We can get around this issue like this:</p>
<div class="highlight-python notranslate" id="stripped-example"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">stripped</span>

<span class="n">target</span> <span class="o">=</span> \
<span class="sd">&#39;&#39;&#39;[2017-11-05 21:31:56.098526] [tazor] e-&gt;start_at() top-&gt;arming</span>
<span class="sd">   [2017-11-05 21:31:56.200047] [tazor] e-&gt;BATTERY_CHARGE() arming-&gt;armed</span>
<span class="sd">   [2017-11-05 21:31:56.300974] [tazor] e-&gt;BATTERY_CHARGE() armed-&gt;armed</span>
<span class="sd">   [2017-11-05 21:31:56.401682] [tazor] e-&gt;BATTERY_CHARGE() armed-&gt;armed</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="k">with</span> <span class="n">stripped</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">as</span> <span class="n">stripped_target</span><span class="p">,</span> \
     <span class="n">stripped</span><span class="p">(</span><span class="n">tazor</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span> <span class="k">as</span> <span class="n">stripped_trace_result</span><span class="p">:</span>

  <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stripped_target</span><span class="p">,</span> <span class="n">stripped_trace_result</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>On line <strong>1</strong> we import the stripped context manager.</p>
<p>On lines <strong>3-7</strong> we define the target as just being the trace that we copied
when we were first designing our statechart.</p>
<p>On line <strong>9</strong>, we map this target to the <code class="docutils literal notranslate"><span class="pre">stripped_target</span></code> which contains the
same string with the date timestamps removed.</p>
<p>On line <strong>10</strong>, we use the same stripped context manager to strip our tazor active
objectâs trace output of itâs date timestamp information and place the result
into the <code class="docutils literal notranslate"><span class="pre">stripped_trace_result</span></code> variable.</p>
<p>Lines <strong>12-13</strong> are for testing each line of our output against our target.</p>
<p>If our design changes, it is easy to update the test, we just copy the new
trace of of new design into the target string and everything should be peachy.</p>
</div>
<div class="section" id="using-a-spy-as-a-test-target">
<h3><a class="toc-backref" href="#id90">Using a Spy as a Test Target</a><a class="headerlink" href="#using-a-spy-as-a-test-target" title="Permalink to this headline">Â¶</a></h3>
<p>A trace does not tell the full story about what your system is doing.  For
instance it is blind to hooks, deferred events and many other things that might
happen in the dynamics of your active object.  If you need to look at the
<cite>exact</cite> behavior of your system, you can:</p>
<ol class="arabic simple">
<li>Run your program and print your spy to the output.</li>
<li>Copy the spy as your target behavior.</li>
<li>Compare the target with the results.</li>
</ol>
<p>Here is an example:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># pp(tazor.spy())</span>
</span><span class="hll"><span class="c1"># import pdb.set_trace()</span>
</span><span class="hll"><span class="k">assert</span><span class="p">(</span><span class="n">tazor</span><span class="o">.</span><span class="n">spy</span><span class="p">()</span> <span class="o">==</span>
</span>  <span class="p">[</span><span class="s1">&#39;START&#39;</span><span class="p">,</span>
   <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:arming&#39;</span><span class="p">,</span>
   <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:tazor_operating&#39;</span><span class="p">,</span>
   <span class="s1">&#39;ENTRY_SIGNAL:tazor_operating&#39;</span><span class="p">,</span>
   <span class="s1">&#39;ENTRY_SIGNAL:arming&#39;</span><span class="p">,</span>
   <span class="s1">&#39;INIT_SIGNAL:arming&#39;</span><span class="p">,</span>
   <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
   <span class="s1">&#39;BATTERY_CHARGE:arming&#39;</span><span class="p">,</span>
   <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:armed&#39;</span><span class="p">,</span>
   <span class="s1">&#39;ENTRY_SIGNAL:armed&#39;</span><span class="p">,</span>
   <span class="s1">&#39;POST_DEFERRED:CAPACITOR_CHARGE&#39;</span><span class="p">,</span>
   <span class="s1">&#39;INIT_SIGNAL:armed&#39;</span><span class="p">,</span>
   <span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
<p>On line <strong>1</strong> we have a commented pretty print command ready to go for when we
need to rebuild our test specification.  When the test fails in the future,
which it will because this is a tightly coupled test, we will uncomment lines
<strong>1-2</strong> then re-run the test.</p>
<p>This will drop us into a debugging session just after our next spy output has
been printed to the screen.  At this point we would carefully determine if it
actually describes the new behavior we are looking for. If it wasnât, we would
fix the issue, otherwise we over-write lines <strong>4-16</strong> with this new
specification.</p>
<p>We would re-comment lines <strong>1-2</strong> and re-run our tests.</p>
<a class="reference internal" href="examples.html"<span class="std-ref">prev</span></a>, <a class="reference internal" href="index.html#top"><span class="std std-ref">top</span></a>, <a class="reference internal" href="patterns.html"><span class="std std-ref">next</span></a></div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Recipes</a><ul>
<li><a class="reference internal" href="#demonstration-of-capabilities">Demonstration of Capabilities</a><ul>
<li><a class="reference internal" href="#state-abstraction-in-miros">State Abstraction in Miros</a></li>
<li><a class="reference internal" href="#minimal-viable-states">Minimal Viable States</a></li>
<li><a class="reference internal" href="#attachment-points-and-a-working-state-machine">Attachment Points and a Working State Machine</a></li>
<li><a class="reference internal" href="#feedback-about-behavior-through-instrumentation">Feedback about Behavior through Instrumentation</a></li>
<li><a class="reference internal" href="#entry-conditions-and-handled-events">Entry Conditions and Handled Events</a></li>
<li><a class="reference internal" href="#exit-conditions">Exit Conditions</a></li>
<li><a class="reference internal" href="#inventing-your-own-signals-external-events">Inventing your own Signals: External events</a></li>
<li><a class="reference internal" href="#hooks">Hooks</a></li>
<li><a class="reference internal" href="#comprehensive-instrumentation-with-the-live-spy-and-scribble">Comprehensive Instrumentation with the live_spy and scribble</a></li>
<li><a class="reference internal" href="#attaching-more-than-one-activeobject-to-an-hsm">Attaching More than one ActiveObject to an HSM</a></li>
<li><a class="reference internal" href="#making-the-live-instrumentation-use-the-python-logger">Making the Live Instrumentation use the Python Logger</a></li>
<li><a class="reference internal" href="#making-a-statechart-from-a-class">Making a Statechart from a class</a></li>
<li><a class="reference internal" href="#communication-between-statecharts">Communication between Statecharts</a></li>
<li><a class="reference internal" href="#overload-a-state-in-a-subclass">Overload a State in a Subclass</a></li>
<li><a class="reference internal" href="#one-shots-multi-shots-and-heartbeats">One-Shots, Multi-Shots and Heartbeats</a></li>
<li><a class="reference internal" href="#creating-thread-safe-class-attributes">Creating thread-safe class Attributes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#states">States</a><ul>
<li><a class="reference internal" href="#state-function-recipes">State Function Recipes</a><ul>
<li><a class="reference internal" href="#boiler-plate-state-function-code">Boiler-plate State Function Code</a></li>
<li><a class="reference internal" href="#describing-your-parent-state-function">Describing your Parent State Function</a></li>
<li><a class="reference internal" href="#passing-events-to-the-parent-state-function">Passing events to the Parent State Function</a></li>
<li><a class="reference internal" href="#transition-to-another-state-function">Transition to another State Function</a></li>
<li><a class="reference internal" href="#state-function-entry-code">State Function Entry Code</a></li>
<li><a class="reference internal" href="#state-function-initialization-code">State Function Initialization Code</a></li>
<li><a class="reference internal" href="#state-function-exit-code">State Function Exit Code</a></li>
<li><a class="reference internal" href="#creating-a-hook-in-a-state-function">Creating a Hook in a State function</a></li>
<li><a class="reference internal" href="#catch-and-release-in-a-state-function">Catch and Release in a State function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#state-method-recipes">State Method Recipes</a><ul>
<li><a class="reference internal" href="#boiler-plate-state-method">Boiler-plate State Method</a></li>
<li><a class="reference internal" href="#boiler-plate-state-handler-method">Boiler-plate State Handler Method</a></li>
<li><a class="reference internal" href="#describing-your-parent-state-using-the-factory">Describing your Parent State using the Factory</a></li>
<li><a class="reference internal" href="#passing-events-to-the-parent-state-method">Passing Events to the Parent State Method</a></li>
<li><a class="reference internal" href="#transition-to-another-state-method">Transition to another State Method</a></li>
<li><a class="reference internal" href="#state-handlers-for-entry-exit-and-initialization-signals">State Handlers for Entry/Exit and Initialization Signals</a></li>
<li><a class="reference internal" href="#creating-a-hook-in-a-state-handler">Creating a Hook in a State Handler</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#events-and-signals">Events And Signals</a><ul>
<li><a class="reference internal" href="#creating-an-event">Creating an Event</a></li>
<li><a class="reference internal" href="#creating-a-signal">Creating a Signal</a></li>
<li><a class="reference internal" href="#posting-events">Posting Events</a></li>
<li><a class="reference internal" href="#posting-an-event-to-the-fifo">Posting an Event to the Fifo</a></li>
<li><a class="reference internal" href="#posting-an-event-to-the-lifo">Posting an Event to the LIFO</a></li>
<li><a class="reference internal" href="#create-a-guard">Create a Guard</a></li>
<li><a class="reference internal" href="#creating-a-one-shot-event">Creating a One-Shot Event</a></li>
<li><a class="reference internal" href="#creating-a-multishot-event">Creating a Multishot Event</a></li>
<li><a class="reference internal" href="#canceling-a-specific-event-source">Canceling a Specific Event Source</a></li>
<li><a class="reference internal" href="#canceling-event-source-by-signal-name">Canceling Event Source By Signal Name</a></li>
<li><a class="reference internal" href="#deferring-and-recalling-an-event">Deferring and Recalling an Event</a></li>
<li><a class="reference internal" href="#adding-a-payload-to-an-event">Adding a Payload to an Event</a></li>
<li><a class="reference internal" href="#determining-if-an-event-has-a-payload">Determining if an Event Has a Payload</a></li>
<li><a class="reference internal" href="#subscribing-to-an-event-posted-by-another-active-object">Subscribing to an Event Posted by Another Active Object</a></li>
<li><a class="reference internal" href="#publishing-events-to-other-active-objects">Publishing events to other Active Objects</a></li>
<li><a class="reference internal" href="#avoiding-bugs-which-travel-through-time">Avoiding Bugs Which Travel Through Time</a></li>
<li><a class="reference internal" href="#avoiding-double-time-heart-beat-bugs">Avoiding double time heart beat bugs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoiding-heart-beat-bleed-bugs">Avoiding Heart-Beat-Bleed Bugs</a></li>
<li><a class="reference internal" href="#activeobjects">ActiveObjects</a><ul>
<li><a class="reference internal" href="#starting-an-activeobject">Starting an ActiveObject</a></li>
<li><a class="reference internal" href="#stopping-an-activeobject">Stopping an ActiveObject</a></li>
<li><a class="reference internal" href="#augmentng-your-activeobject">Augmentng your ActiveObject</a></li>
<li><a class="reference internal" href="#sharing-attributes-between-threads-activeobjects">Sharing Attributes between Threads (ActiveObjects)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#factories">Factories</a><ul>
<li><a class="reference internal" href="#creating-a-statechart-inside-of-a-class">Creating a Statechart Inside of a Class</a></li>
<li><a class="reference internal" href="#inheritance-and-starting-factories">Inheritance and Starting (Factories)</a></li>
<li><a class="reference internal" href="#sharing-attributes-between-threads-factories">Sharing Attributes between Threads (Factories)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiple-statecharts">Multiple Statecharts</a><ul>
<li><a class="reference internal" href="#building-and-destroying-workers">Building and Destroying Workers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#seeing-what-is-going-on">Seeing What is Going On</a><ul>
<li><a class="reference internal" href="#determining-the-current-state">Determining the Current State</a></li>
<li><a class="reference internal" href="#seeing-what-signals-you-have-in-your-system">Seeing what Signals You Have In Your System</a></li>
<li><a class="reference internal" href="#using-the-trace">Using the Trace</a></li>
<li><a class="reference internal" href="#using-the-spy">Using the Spy</a></li>
<li><a class="reference internal" href="#add-timing-information-to-the-spy">Add Timing Information to the Spy</a></li>
<li><a class="reference internal" href="#tracing-live">Tracing Live</a></li>
<li><a class="reference internal" href="#spying-live">Spying Live</a></li>
<li><a class="reference internal" href="#scribble-on-the-spy">Scribble On the Spy</a></li>
<li><a class="reference internal" href="#flatting-a-state-method">Flatting a State Method</a></li>
</ul>
</li>
<li><a class="reference internal" href="#describing-your-work">Describing your Work</a><ul>
<li><a class="reference internal" href="#drawing-a-statechart">Drawing a StateChart</a></li>
<li><a class="reference internal" href="#drawing-a-sequence-diagram">Drawing a Sequence Diagram</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing">Testing</a><ul>
<li><a class="reference internal" href="#using-a-trace-as-a-test-target">Using a Trace As a Test Target</a></li>
<li><a class="reference internal" href="#using-a-spy-as-a-test-target">Using a Spy as a Test Target</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="i_mongol_example.html" title="previous chapter">Mongol Horse Archer</a></li>
      <li>Next: <a href="reflection.html" title="next chapter">Reflection</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/recipes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Scott Volk.
      
      |
      <a href="_sources/recipes.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>