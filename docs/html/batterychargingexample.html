







<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Distributed Battery Charging | miros</title>
    <link rel="shortcut icon" href="_static/favicon.ico">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="_static/theme.css" type="text/css">
    
      
    <link rel="stylesheet" type="text/css" href="_static/css/miros_docs.css" />
      
    
    

    
    <script type="text/javascript" src="_static/theme.js" defer></script>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    
    <script src="_static/jquery.js"></script>
    
    <script src="_static/underscore.js"></script>
    
    <script src="_static/doctools.js"></script>
    
    <script src="_static/language_data.js"></script>
    
    

    
      
      
    <link rel="index" title="Index" href="genindex.html">
      
      
    <link rel="search" title="Search" href="search.html">
      
      
      
    <link rel="next" title="Cellular Automata" href="cellular_automata.html">
      
      
    <link rel="prev" title="Orthogonal Regions" href="othogonalregions.html">
      
    

    

    

    
  </head>

  <body>
    <header class="main-header">
      <div class="navbar">
        <div id="js-sidebar-mask" class="sidebar-mask"></div>
        <div id="js-sidebar-menu-button" class="sidebar-menu-button">
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg>
        </div>
        <a href="index.html" class="site-link">
          
          miros
          
        </a>
        <div class="navbar-links">
          <a href="installation.html" class="navbar-link">Docs</a>
          
          <a href="https://github.com/aleph2c/miros" class="navbar-link">GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
          
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      
      <div id="js-main-sidebar" class="main-sidebar">
        
        <div class="sidebar-content sidebar-content--divider sidebar-navbar-links">
          <a href="https://github.com/aleph2c/miros" class="sidebar-navbar-link">GitHub</a>
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
        </div>
        
        
        <div class="sidebar-content sidebar-logo">
    <a href="index.html">
      <img class="logo" src="_static/miros_logo.svg" alt="miros" >
    </a>
</div>
        
        

<h2 class="sidebar-heading">Contents</h2>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="zero_to_one.html">Tutorial: Zero To One</a></li>
<li class="toctree-l1"><a class="reference internal" href="reading_diagrams.html">Diagrams</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="comprehensive.html">Comprehensive</a></li>
<li class="toctree-l2"><a class="reference internal" href="comprehensive.html#comprehensive-with-instrumentation">Comprehensive with Instrumentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread_safe_attributes.html">Thread Safe Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="scribbleexample.html">Hacking to Learn</a></li>
<li class="toctree-l2"><a class="reference internal" href="interactingcharts.html">Interacting Statecharts (Same Machine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="towardsthefactoryexample.html">Using and Unwinding a Factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="othogonalregions.html">Orthogonal Regions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Distributed Battery Charging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#high-level-introduction-to-how-batteries-and-chargers-work">High Level Introduction to how Batteries and Chargers Work</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-1-control-systems">Spec 1: Control Systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-2-battery-parameters">Spec 2: Battery Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-3-electrical-charging-profile">Spec 3: Electrical Charging Profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-4-charger-behavioral-design">Spec 4: Charger Behavioral Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-5-high-level-verification-goals">Spec 5: High Level Verification Goals</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-6-battery-simulator">Spec 6: Battery Simulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-7-testing-with-physics-simulation">Spec 7: Testing with Physics Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spec-8-current-derating-in-constant-voltage-modes">Spec 8: Current Derating in Constant Voltage Modes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cellular_automata.html">Cellular Automata</a></li>
<li class="toctree-l2"><a class="reference internal" href="i_mongol_example.html">Mongol Horse Archer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="reflection.html">Reflection</a></li>
<li class="toctree-l1"><a class="reference internal" href="patterns.html">Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
</ul>

        
        
<h2 class="sidebar-heading">Useful Links</h2>

<ul>
  <li><a href="https://github.com/aleph2c/py-activeobject">miros on github</a></li>
  <li><a href="https://github.com/aleph2c/sequence">sequence on github</a></li>
  <li><a href="https://aleph2c.github.io/miros-rabbitmq/index.html">miros-rabbitmq plugin</a></li>
  <li><a href="http://www.umlet.com">UMLet Download</a></li>
  <li><a href="http://www.inf.ed.ac.uk/teaching/courses/seoc/2005_2006/resources/statecharts.pdf">formalism explained</a></li>
</ul>


<h2 class="sidebar-heading">For Embedded</h2>

<ul>
  <li><a href="https://state-machine.com/">Quantum Leaps for Embedded</a></li>
  <li><a href="https://github.com/QuantumLeaps/">Quantum Leaps On Github</a></li>
</ul>


<h2 class="sidebar-heading">Statechart Videos</h2>

<ul>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 1 (What)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-why-use-them-2-of-4-90489.html">Part 2 (Why)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 3 (Mealy/Moore)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-harel-state-machines-4-of-4-90491.html">Part 4 (Harel Statecharts)</a></li>
  <li><a href="https://barrgroup.com/Embedded-Systems/How-To/Introduction-Hierarchical-State-Machines">Introduction to HSMs</a></li>
</ul>
        
        

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel" class="sidebar-heading">Quick search</h2>
  <div class="searchformwrapper sidebar-content">
    <form class="search" action="search.html" method="get">
      <input class="sidebar-search sidebar-search--input" type="text" name="q" aria-labelledby="searchlabel"><input class="sidebar-search sidebar-search--btn" type="submit" value="Go">
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

        
      </div>
      

      
      <div class="main-content main-content--sidebar">
      
        
          
  <blockquote class="epigraph">
<div><p>Software should be treated not as a static product, but as a living
manifestation of the development team’s collective understanding.</p>
<p class="attribution">—From <a class="reference external" href="https://www.csc.gov.sg/articles/how-to-build-good-software">How to Build Good Software</a>, by Li Hongyi</p>
</div></blockquote>
<div class="section" id="distributed-battery-charging">
<span id="batterychargingexample-battery-charging-example"></span><h1>Distributed Battery Charging<a class="headerlink" href="#distributed-battery-charging" title="Permalink to this headline">#</a></h1>
<p>This essay describes two engineers working together to build a distributed three
stage battery charger.  It follows them as they learn from one another and
challenge each other’s work.  As their progress evolves against their shared
knowledge, they pack what they have learned and what they have done, into a very
short document called the specification (spec).</p>
<p>They treat their specification as a time capsule they are sending into the
future, as an artifact to help the engineers of tomorrow (who might just be older
versions of themselves) make sense of their system.</p>
<p>Before we start with the story, here is a bit of background information that
will help provide some context.</p>
<div class="section" id="high-level-introduction-to-how-batteries-and-chargers-work">
<span id="batterychargingexample-high-level-summary-of-batteries-and-chargers"></span><h2>High Level Introduction to how Batteries and Chargers Work<a class="headerlink" href="#high-level-introduction-to-how-batteries-and-chargers-work" title="Permalink to this headline">#</a></h2>
<p>Lead acid batteries are very heavy.  But they are cheaper than lithium ion
batteries and this is why they are used in a lot of off-grid electrical systems.</p>
<a class="reference external image-reference" href="https://www.lowtechmagazine.com/2015/05/sustainability-off-grid-solar-power.html"><img alt="https://krisdedecker.typepad.com/.a/6a00e0099229e8883301bb0820445e970d-pi" class="scale-to-fit" src="https://krisdedecker.typepad.com/.a/6a00e0099229e8883301bb0820445e970d-pi" /></a>
<p>A large lead-acid battery is made up of a set of smaller lead-acid batteries
connected together in series.  These smaller batteries are called cells.</p>
<a class="reference external image-reference" href="https://chargetek.com/images/pdfs/equal.pdf"><img alt="_images/cells_in_series.PNG" class="scale-to-fit" src="_images/cells_in_series.PNG" /></a>
<p>Each cell contains two terminals, and each terminal is connected to a plate that
reaches down into a bath of sulphuric acid (H2SO4) and water (H2O).  There is a
positive and a negative terminal.  The positive terminal of a cell is made up of
lead dioxide (PbO2) and the negative terminal is made out of lead (Pb).</p>
<p>A battery is a chemical reaction that wants to happen, but can’t until there is
a path for electrons to flow from one material to another.  As a result, there
is a voltage potential expressed across the positive and negative terminals of
the battery.  If an electrical device is connected across these terminals an
electron path is made, the battery can begin its chemical reaction.  As a side
effect the electrical device is powered on.  The flow of current leaves the
positive terminal and enters the negative terminal.  When this happens the
battery is said to discharge.</p>
<a class="reference external image-reference" href="https://circuitglobe.com/lead-acid-battery.html"><img alt="https://circuitglobe.com/wp-content/uploads/2017/01/lead-acid-cell-112.jpg" class="noscale-center" src="https://circuitglobe.com/wp-content/uploads/2017/01/lead-acid-cell-112.jpg" /></a>
<p>Charging of a battery occurs when current is forced to flow in the opposite
direction: current leaves the negative terminal and enters the positive
terminal. This causes the chemical reaction to reverse, sequestering the
electrons back into the various materials of the battery.  You can charge a
battery with a battery charger.</p>
<a class="reference external image-reference" href="https://circuitglobe.com/lead-acid-battery.html"><img alt="https://circuitglobe.com/wp-content/uploads/2017/01/recharging-of-lead-acid-battery.jpg" class="noscale-center" src="https://circuitglobe.com/wp-content/uploads/2017/01/recharging-of-lead-acid-battery.jpg" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you aren’t familiar with the terminology of electricity, imagine a water
tower.  The water is trying to get to the ground, due to gravity,
but it is held in place by the walls of the tower.  This means that there is a
potential for the water to flow, the height of the tower determines how much
energy is stored within it.  The higher the tower, the higher the potential
energy.  Voltage is analogous to height of the held water in the tower.</p>
<a class="reference external image-reference" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtYw4fJS9o3meW9yv5ZGJ5enzVpyJ0sfw5L45UifmATQERiArD"><img alt="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtYw4fJS9o3meW9yv5ZGJ5enzVpyJ0sfw5L45UifmATQERiArD" class="noscale-right-wrap" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtYw4fJS9o3meW9yv5ZGJ5enzVpyJ0sfw5L45UifmATQERiArD" /></a>
<p>Now imagine connecting a pipe from the tower to the ground, and letting the
water flow through it.  This flow is like current in an electrical system, and
the pipe width would limit that flow, so that would be like an electrical load.</p>
<p>Our battery is like a water tower; if no pipe is connected, current can’t flow.
If a pipe is connected, it can, and the energy of the battery reduces just like
the potential energy of our water tower would reduce as its water leaves it
through a pipe.  If you were to push the current back into the pipe, by
connecting a higher water tower, or by just driving the current back up the
tube with a pump, you would cause the potential of the water tower to increase.
We would be charging the tower.</p>
<p>As mentioned before, a battery is made up of stacking cells in series.  Think of
that as a very tall water tower made up of stacked shorter water towers.  You
can increase their potential energy by stacking them this way.</p>
</div>
<p>As a lead acid battery is discharged, a crust of lead sulphate (PbSO4) forms on the
plates.  This crust reduces the surface area of the lead plates exposed to the
acid, reducing its ability to react and drive current.</p>
<a class="reference external image-reference" href="https://stevedmarineconsulting.com/sulfation-too-many-batteries-die-an-unnecessarily-early-death-from-this-phenomenon/"><img alt="https://stevedmarineconsulting.com/wp-content/uploads/2019/06/082504179.jpg" class="noscale-center" src="https://stevedmarineconsulting.com/wp-content/uploads/2019/06/082504179.jpg" /></a>
<p>There are electrical charging techniques which can remove this lead sulphate
(PbSO4), by reversing the chemical reaction, and even sometimes bubbling the
acid.  These bubbles physically massage away the lead sulphate crystals,
dislodging them from the plate, dropping them into the acid bath where they can
break down, crystallizing their lead atoms back onto the plates.</p>
<p>An electrical charger can control one of two things, it can act to control
current flow or it can control the voltage across the terminals of the
battery.  If it holds the current constant, electrons are pushed back into the
battery, which will cause the voltage of the battery to slowly rise over time.</p>
<p>If the charger holds the voltage at a higher potential than the battery voltage,
current will flow into the battery.  At first it will flow quickly, but over
time the battery’s ability to accept electrons will be limited by the amount of
material within it, causing the current flow to subside.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Thinking back to the water tower.  If we re-filled our water tower using a
pump to push a constant amount of water, this would be like controlling the
current being pushed into the battery.  If we connected a higher water tower,
and let it passively drain some of its water into the lower tower, this would
be like controlling the voltage of our charger.  Together the two towers
would have the potential energy of the taller tower, so its voltage would be
set to this.</p>
</div>
<p>When you hear people talk about the stages of charging of a battery, they are
talking about either a constant current or a constant voltage charging
technique.  In two stage charging, a constant current technique starts the
charging process, then once the battery voltage rises to a high enough level, a
constant voltage technique takes over.  In three stage charging, the third stage
is a constant voltage technique, but held at a lower value than the second
stage.  A forth stage of charging can be applied very infrequently, it’s called
equalization.  It is a constant voltage technique that applies such a high
voltage across the battery terminals, that the acid boils, and explosive
hydrogen is expelled from the batteries (this is why battery rooms need to be
well vented).</p>
<p>There are arbitrary naming conventions that have been applied to these stages of
charging:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name of Stage</p></th>
<th class="head"><p>Constant
Current?</p></th>
<th class="head"><p>Constant
Voltage?</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><em>bulk stage</em></p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
<td><p>80 percent of charge put back</p></td>
</tr>
<tr class="row-odd"><td><p><em>absorption stage</em></p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><em>float stage</em></p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
<td><p>voltage is lower than absorption</p></td>
</tr>
<tr class="row-odd"><td><p><em>equalization</em></p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
<td><p>voltage is very high</p></td>
</tr>
</tbody>
</table>
<p>A charger is typically called one of these:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name of Charger</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><em>trickle charger</em></p></td>
<td><p>float stage only</p></td>
</tr>
<tr class="row-odd"><td><p><em>two stage charger</em></p></td>
<td><p>bulk followed by the float stage</p></td>
</tr>
<tr class="row-even"><td><p><em>three stage charger</em></p></td>
<td><p>bulk followed by absorption, followed by float</p></td>
</tr>
</tbody>
</table>
<p>The <em>equalization</em> stage is so dangerous that it doesn’t happen automatically,
it has to be manually set by the user.</p>
<p>It has been found that when you charge batteries with three stage chargers, the
process of plate sulphation is slower than it would be with a two stage charger.
If such a charger is also equipped with the equalization feature, a knowledgeable
user can keep their battery’s healthy for a long time.</p>
<p>Let’s look at the three stage charging electrical profile:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_all.pdf"><img alt="_images/three_stage_charging_all.svg" class="scale-to-fit" src="_images/three_stage_charging_all.svg" /></a>
<p>That diagram is not going to win any graphic design awards, but it shows you
everything you need to know about building a charger.  We need two control
systems, one that can hold current to a constant level and one that can hold the
voltage to a constant level.  We need to track time, so that we can exit a stage
if the charger has been in it too long.  And we need to be able to set some
parameters based on the kind of battery we are attached too.</p>
<p>The bulk stage is where the battery is charged quickly.  Charging the battery is
what our customer’s care about the most, but battery maintenance is very
important too.</p>
<p>The charger will have a rated current, the more money we put into its hardware,
the higher this current can be.  The problem is if we over-build this, our
charger will be too big for a lot of systems and these customers will buy
someone else’s product because it is cheaper than ours.</p>
<p>A way to solve this problem is to build a charger that can be ganged together
with more versions of itself.  That way we can keep the costs low, and if a
customer needs a lot of current, they can buy as many of our products as they
need and gang them together in parallel.</p>
<p>The added benefit of this approach is that if one of their chargers fails, there
batteries can still be charged by the others in their system.  It offers them
some resilience.  If they felt so inclined, they could actually over-build their
charging system to increase their system’s reliability (think military
contracts).  Batteries are expensive, heavy and dangerous, and chargers are
relatively cheap and easy to work with and install.</p>
<p>Another problem our customers have is with the parameters.  We can’t expect them
to figure out what all of the values and time-outs mean.  They really don’t
care, we need to eat this complexity on their behalf, especially if we are
expecting them to buy a bunch of our products for a single installation.</p>
<p>Often the hardest thing to do on a project is to pack knowledge into a
specification (spec).  The specification should be simple and full of pictures,
if it isn’t nobody will look a it, and nobody will change it to match what the
system actually does.  Engineers talk with pictures, because pictures transmit
more information than writing.  Pictures also illicit conversation which moves
relevant personal knowledge into project knowledge:  When you are talking to
technical people they often forget that they know a lot of things you don’t
know. If you are both pointing to and talking about a picture, you will both
learn more about each others contribution and thinking in regards to the
project.  Once things are discovered from one another they should be packed into
a couple of notes and pictures and added to the spec.</p>
<p>The spec should be short enough that it can be read and understood by everyone
involved.  If specific drawings are too technical for some members, efforts
should be made to explain what they mean so everyone can participate in the
conversation.  Here is an example of such a conversation to discover how to
build a single three stage battery charger.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>New knowledge and things said by other imagined people will be
<span class="new-spec">highlighted.</span></p>
</div>
</div>
<div class="section" id="spec-1-control-systems">
<span id="batterychargingexample-spec-1-control-systems"></span><h2>Spec 1: Control Systems<a class="headerlink" href="#spec-1-control-systems" title="Permalink to this headline">#</a></h2>
<p><strong>Specification (1)</strong></p>
<ul class="simple">
<li><p><span class="new-spec">A charger has two control systems: constant current and constant voltage.</span></p></li>
<li><p><span class="new-spec">The bulk stage is a constant current control technique.</span></p></li>
<li><p><span class="new-spec">The absorption, float and equalization stages are constant voltage control
techniques.</span></p></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><img alt="_images/three_stage_charging_chart_1.svg" class="noscale-center" src="_images/three_stage_charging_chart_1.svg" /></a>
<p>I show the above diagram to the <span class="new-spec">electrical engineer</span> I’m working
with, and he says, <span class="new-spec">Yeah, it looks good, but can you make sure the two
control systems are generalizeable?</span></p>
<p>“What do you mean?”</p>
<p><span class="new-spec">Well, I want to just give the current control system a reference
current and it will drive the device to output that current.  The same idea
applies to the voltage controller.</span></p>
<p>He continues, <span class="new-spec">A control system is just some math, you give it a goal
called a “reference”.  then you give it the value of the thing it is trying to
control, call this the “input” and the math will drive the “output” towards the
goal.  We connect this output value to our hardware and it will behave as
expected.  I want to use the same math to solve the current and voltage control
problems, so give me a reference and give me the input and I’ll make it work.</span></p>
<p>You turn to leave and he says, <span class="new-spec">Oh, one more thing, I need to tune the
two control systems differently, so make sure I can set some variables “ki”,
“kp” and “kd”.  That should be good</span>.</p>
<p>So now we have to start thinking about all of the parameters, each can be
changed for a different battery type.  We change the language on the diagram to
match how our electrical engineer speaks.</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><img alt="_images/three_stage_charging_parameters.svg" class="scale-to-fit" src="_images/three_stage_charging_parameters.svg" /></a>
<p>After we update the image we show our electrical engineer the new picture.</p>
<p>He looks at it and asks, <span class="new-spec">What are these arrows connecting the boxes
together?</span></p>
<p>You answer, “It’s just a way of saying that the <code class="docutils literal notranslate"><span class="pre">reference</span></code>,
<code class="docutils literal notranslate"><span class="pre">input</span></code>, <code class="docutils literal notranslate"><span class="pre">kp</span></code>, <code class="docutils literal notranslate"><span class="pre">ki</span></code> and <code class="docutils literal notranslate"><span class="pre">kd</span></code> values will be in both of the current and
voltage control classes.  Think of it as a drawing short hand.”</p>
<p>He says, <span class="new-spec">Ok, it looks good.</span></p>
</div>
<div class="section" id="spec-2-battery-parameters">
<span id="batterychargingexample-spec-2-battery-parameters"></span><h2>Spec 2: Battery Parameters<a class="headerlink" href="#spec-2-battery-parameters" title="Permalink to this headline">#</a></h2>
<p><strong>Specification (2)</strong></p>
<ul class="simple">
<li><p>A charger has two control systems: constant current and constant voltage.</p></li>
<li><p>The bulk stage is a constant current control technique.</p></li>
<li><p>The absorption, float and equalization stages are constant voltage control
techniques.</p></li>
</ul>
<p><span class="new-spec">The electrical profile of the system will look like this:</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><img alt="_images/three_stage_charging_parameters.svg" class="scale-to-fit" src="_images/three_stage_charging_parameters.svg" /></a>
<p><span class="new-spec">The behavior of the system will look like this:</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_1.pdf"><img alt="_images/three_stage_charging_chart_1.svg" class="noscale-center" src="_images/three_stage_charging_chart_1.svg" /></a>
<p>But we still haven’t solved the parameter issue.  To create a data structure
that has the control system information and the battery stuff in one place we
adjust our data model to look like this:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_parameters_2.pdf"><img alt="_images/three_stage_charging_parameters_2.svg" class="scale-to-fit" src="_images/three_stage_charging_parameters_2.svg" /></a>
<p>The <code class="docutils literal notranslate"><span class="pre">ChargerParameter</span></code> class “has a” (black diamond arrow)
<code class="docutils literal notranslate"><span class="pre">CurrentControlSystem</span></code>, a <code class="docutils literal notranslate"><span class="pre">VoltageControlSystem</span></code> and some
<code class="docutils literal notranslate"><span class="pre">BatterySpecificInformation</span></code>.</p>
<p>Now that we have a plan for structuring our data, we need to go back to our
behavioral diagram and figure out how to get information from the world.</p>
<p>We track down our electrical engineer and ask him, “How fast to I need to read
the voltage and the current?”</p>
<p>He says, <span class="new-spec">Well, I have to read these values very quickly in the
embedded device’s interrupt service routines, the control systems will be
running at 20 Khz, but you don’t have to worry about that.  Changing between the
various stages can happen slowly.  I’ll be reading the input, I’ll use raw ADC
readings to keep my code fast and I’ll use the PWM peripherals on the part to
set the output current and voltage via an H-bridge.  But I will need you to
determine which control system to run and I’ll need you to set its reference.
Make it so I can tune these values later if I need to, but for now you can
sample the current, voltage and make decisions at 2 Hz”.  (every 0.5 seconds)</span></p>
<p>You say, “Wait, I’m not controlling the current or voltage?”.</p>
<p>He laughs and says, <span class="new-spec">Not with Python you aren’t, but you control which
control system will run, and you will control that controllers reference and
tuning parameters, think meta, man!</span></p>
<hr class="docutils" />
<p>Here we are seeing some of the power of statecharts.  They allow us to wrap deep
expertise inside of a system with a rich set of other features.  The electrical
engineer will manage the control system and the circuits needed to make the
device work, but that is where his expertise stops.  We need to manage which of
the control strategies are applied, and what their goals are.</p>
<p>Let’s pack this new knowledge into our pictures.  Let’s start with the data
model.  We want to attach it to our statechart so that our statechart can use
it:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_data.pdf"><img alt="_images/three_stage_charging_chart_2_data.svg" class="noscale-center" src="_images/three_stage_charging_chart_2_data.svg" /></a>
<p>We show our design to the electrical engineer and he says, <span class="new-spec">What are
those diamond arrows?</span></p>
<p>You answer, “It’s just a way of saying one class has an
attribute of another class.  For instance the <code class="docutils literal notranslate"><span class="pre">battery_spec</span></code> in the
<code class="docutils literal notranslate"><span class="pre">ChargerParameter</span></code> class “has a” <code class="docutils literal notranslate"><span class="pre">BatterySpecificInformation</span></code> class.  You leave
the <code class="docutils literal notranslate"><span class="pre">BatterySpecificInformation</span></code> class on the picture so you can see what its
attribute names are.”</p>
<p><span class="new-spec">It seems kind of complicated, can you just show me in code?</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ControlSystem</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># ..</span>

 <span class="k">class</span> <span class="nc">CurrentControlSystem</span><span class="p">(</span><span class="n">ControlSystem</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

 <span class="k">class</span> <span class="nc">VoltageControlSystem</span><span class="p">(</span><span class="n">ControlSystem</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

 <span class="k">class</span> <span class="nc">BatterySpecificSettings</span><span class="p">:</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">bulk_timeout_sec</span> <span class="o">=</span> <span class="mi">700</span>
     <span class="c1"># ..</span>

 <span class="k">class</span> <span class="nc">ChargerParameters</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">c_control</span> <span class="o">=</span> <span class="n">CurrentControlSystem</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">v_control</span> <span class="o">=</span> <span class="n">VoltageControlSystem</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span> <span class="o">=</span> <span class="n">BatterySpecificSettings</span><span class="p">()</span>

 <span class="k">class</span> <span class="nc">Charger</span><span class="p">(</span><span class="n">ChargerParameters</span><span class="p">,</span> <span class="n">CustomFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="c1"># ..</span>

 <span class="k">if</span> <span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">charger</span> <span class="o">=</span> <span class="n">Charger</span><span class="p">()</span>
    <span class="n">charge</span><span class="o">.</span><span class="n">c_control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="mf">40.0</span>
    <span class="n">charge</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_timeout_sec</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="c1"># ..</span>
</pre></div>
</div>
<p>He looks at the picture and the code for a while, then says, <span class="new-spec">OK, I
see how it works, but why are the diamond arrows backwards?</span></p>
<p>You answer, “The head of the diamond describes who owns the other thing.  If you
want to know why it was set that way you will have to ask the committee that
decided this in the 1990’s”</p>
<p>Then he asks, <span class="new-spec">What’s the ball and the stick?</span></p>
<p>“That’s where the data will connect to the software that drives the charger’s
behavior.  The behavior will need the data, and if you see the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> class
inherits from the <code class="docutils literal notranslate"><span class="pre">CustomFactory</span></code> class which contains all of the code that
can drive behavior.  Inheritance is just programming by difference, that arrow
is like a copy and paste, it’s as if I have copied and pasted all of that
<code class="docutils literal notranslate"><span class="pre">CustomFactory</span></code> and <code class="docutils literal notranslate"><span class="pre">ChargerParameters</span></code> code into the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> class.
The ball is just short hand for saying the data attaches to the behavior “here”.
The “here” in this case is the “charging state” which will be described
somewhere else.”</p>
<p>He looks confused, and says, <span class="new-spec">I guess you will have to show me when you make it.</span></p>
<hr class="docutils" />
<p>The data model seems good enough so let’s start designing the system behavior.
We need to start programming time, so we will construct three heart beats,
something that will sample the current, something that will sample the voltage
and something that will drive the statechart’s decisions.  To make current and
voltage readings, we create two hooks in the charging state.  Finally, we make
sure that these heart beats are turned off when we leave the state; <a class="reference internal" href="recipes.html#recipes-avoiding-heart-beat-bleed-bugs"><span class="std std-ref">we
can’t remember why this is important, but we know it is.</span></a></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_chart.pdf"><img alt="_images/three_stage_charging_chart_2_chart.svg" class="noscale-center" src="_images/three_stage_charging_chart_2_chart.svg" /></a>
<p>We also adjust the chart so that the correct control system is selected when we
enter a charging stage, and then we use our data model and our behavior to
select which current or voltage reference will be set in each stage.</p>
<p>Now we want to talk to our electrical engineer about behavior, but we know we
should accompany the statechart diagram with the electrical profile, or it might
be a bit much for him.</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<p>We show him the diagram, and say, “Listen, some stuff is missing on this, but I
just want you to look at how the current and voltage are sampled, and how the
control systems are set up.”</p>
<p>He says, <span class="new-spec">Ok, show me.</span></p>
<p>You say, “In the entry stage we create three different named pulses that repeat
forever, or until the charging state is exited. The chart can react to these
named pulses and change state, or just run some code.”</p>
<p>I pause and look at him, he says, <span class="new-spec">Keep going.</span></p>
<p>“Alright, see that <code class="docutils literal notranslate"><span class="pre">Sample_Current</span></code> pulse, it will fire forever with a period of
<code class="docutils literal notranslate"><span class="pre">cur_in_sec</span></code> which we will probably just set to 0.5 seconds, but we can tune
it, we can make this something else if we need to.”</p>
<p>“The <code class="docutils literal notranslate"><span class="pre">Sample_Current</span></code> and <code class="docutils literal notranslate"><span class="pre">Sample_Voltage</span></code> events will be sent at the chart
and the chart will react to them, but in our case, we just hook these signals
to sample the current and voltage.  The chart won’t actually change state when
these events are seen by it, it will just use the events to update a <code class="docutils literal notranslate"><span class="pre">curr</span></code>
and <code class="docutils literal notranslate"><span class="pre">volt</span></code> attribute in its data structure so these values can be kept fresh
enough that the chart can make good decisions with the information.”</p>
<p>“Does that make sense?”</p>
<p><span class="new-spec">Yeah, it’s just a timer right?</span></p>
<p>You answer, “Yeah, but look there is another one, called <code class="docutils literal notranslate"><span class="pre">Pulse</span></code>, it’s not
wired up yet, but soon it will be the thing that drives the chart’s decisions”</p>
<p>“Now I’ll show you how the controllers are set up.  After the charging state is
entered, it will set up these pulses, then it will enter the bulk state.  When
it enters the <code class="docutils literal notranslate"><span class="pre">constant_current_state</span></code>, it sets the control system to use the
<code class="docutils literal notranslate"><span class="pre">CurrentControlSystem</span></code> and then when it enters the bulk state, it sets the
reference of this control system to be <code class="docutils literal notranslate"><span class="pre">battery_spec.ref_amps</span></code> from our data
model.”</p>
<p>He looks at it for a while, and says, <span class="new-spec">Yeah, this is what I wanted, ok,
yeah, I get it.  How do I get into the other states?</span></p>
<p>“I haven’t set that up yet, but suppose we were to enter the <code class="docutils literal notranslate"><span class="pre">absorption</span></code>
state, we would first have to enter the <code class="docutils literal notranslate"><span class="pre">constant_voltage_state</span></code>.  This would
cause our control system to change, we would detach the current control system,
and attach the voltage control system.  We would then use all of that control
system’s <code class="docutils literal notranslate"><span class="pre">kp</span></code>, <code class="docutils literal notranslate"><span class="pre">ki</span></code> and <code class="docutils literal notranslate"><span class="pre">kd</span></code> parameters.”</p>
<p><span class="new-spec">Yeah, ok, good, this is what I wanted.</span></p>
<p>Things seem to be coming together, so we go back and work on our spec, teasing
apart our high level descriptions from our technical design.</p>
</div>
<div class="section" id="spec-3-electrical-charging-profile">
<span id="batterychargingexample-spec-3-electrical-charging-profile"></span><h2>Spec 3: Electrical Charging Profile<a class="headerlink" href="#spec-3-electrical-charging-profile" title="Permalink to this headline">#</a></h2>
<p><strong>High level Specification (3)</strong></p>
<ul class="simple">
<li><p>This product will be a three stage charger with an equalization feature.</p></li>
<li><p>The charger has two control systems: constant current and constant voltage.</p></li>
<li><p>The bulk stage is a constant current control technique.</p></li>
<li><p>The absorption, float and equalization stages are constant voltage control
techniques.</p></li>
</ul>
<p><span class="new-spec">The charging electrical profile can be seen here:</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<p><strong>Sofware Functional Specification (3)</strong></p>
<ul class="simple">
<li><p><span class="new-spec">The software system will be broken into two parts, fast running c code and slower running Python code</span></p></li>
<li><p><span class="new-spec">The c code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</span></p></li>
<li><p><span class="new-spec">The Python code will determine which control strategy the c code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit</span></p></li>
<li><p><span class="new-spec">The Python code will sample the current and voltage and make decisions every 0.5 seconds</span></p></li>
</ul>
<p><span class="new-spec">The Python data architecture can be seen here:</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_data.pdf"><img alt="_images/three_stage_charging_chart_2_data.svg" class="noscale-center" src="_images/three_stage_charging_chart_2_data.svg" /></a>
<p><span class="new-spec">The Python behavioral architecture can be seen here.</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_chart.pdf"><img alt="_images/three_stage_charging_chart_2_chart.svg" class="noscale-center" src="_images/three_stage_charging_chart_2_chart.svg" /></a>
<p>Let’s wire up the <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> event and add more functionality to our chart.  We
want the charger to:</p>
<ul class="simple">
<li><p>change its charging state to match our electrical/time profile</p></li>
<li><p>be able to be forced into any of the charge states</p></li>
</ul>
<p>Here is a new design that does these things:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_chart.pdf"><img alt="_images/three_stage_charging_chart_3_chart.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_3_chart.svg" /></a>
<p>Since there is a need for timeouts in various states, we invent a new signal
called <code class="docutils literal notranslate"><span class="pre">Tick</span></code>.  <code class="docutils literal notranslate"><span class="pre">Tick</span></code> is driven by our <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> event, and it is given a
payload which is the time in seconds since the charging state was entered.</p>
<p>Time to show our electrical engineer.</p>
<p>We approach him with the diagrams and he says, <span class="new-spec">Ok walk me through
it</span>.</p>
<p>“When the <code class="docutils literal notranslate"><span class="pre">charging</span></code> state is entered the <code class="docutils literal notranslate"><span class="pre">sec</span></code> is set to 0, then the
three heart beats are initiated.  Two of the heart beats drive the current and
voltage readings, but the third heart beat, <code class="docutils literal notranslate"><span class="pre">Pulse</span></code>, will fire every
<code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code> seconds.  We will probably set <code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code> to 0.5.  The key
thing to notice on this picture is that Pulse drives another event called
<code class="docutils literal notranslate"><span class="pre">Tick</span></code> which is given a payload of <code class="docutils literal notranslate"><span class="pre">sec</span></code> which is how much time has passed
since the charging state was entered.”</p>
<p><span class="new-spec">Wait, how does this tick thing work?</span>.</p>
<p>“When system turns on the
first thing that will happen is it will enter the <code class="docutils literal notranslate"><span class="pre">charging</span></code> state. When the
<code class="docutils literal notranslate"><span class="pre">charging</span></code> state is entered a bunch of heart beats are setup, these are
basically named timers, <code class="docutils literal notranslate"><span class="pre">Sample_Current</span></code>, <code class="docutils literal notranslate"><span class="pre">Sample_Voltage</span></code> and <code class="docutils literal notranslate"><span class="pre">Pulse</span></code>.
Then the charging state initializes, causing a transition into the <code class="docutils literal notranslate"><span class="pre">bulk</span></code>
state.  While this happens, the <code class="docutils literal notranslate"><span class="pre">constant_current_state</span></code> is entered, setting
the control system to use your current control system, then it enters the
<code class="docutils literal notranslate"><span class="pre">bulk</span></code> state, which sets the reference of your current control system.”</p>
<p>He looks at the diagram and after some time says, <span class="new-spec">Ok, yeah, I see
that, but how does this pulse stuff work?</span></p>
<p>“The Pulse event will fire every, say 0.5 seconds, but it is caught by a hook,
which invents another signal called <code class="docutils literal notranslate"><span class="pre">Tick</span></code> which has a payload, <code class="docutils literal notranslate"><span class="pre">sec</span></code>.  The
<code class="docutils literal notranslate"><span class="pre">sec</span></code> payload of the Tick signal will have the time in seconds since the
charging state was entered.  It’s this <code class="docutils literal notranslate"><span class="pre">Tick</span></code> event, which can make stuff
happen.  Do you see it?”</p>
<p><span class="new-spec">I see it.  So how do these charging stage time outs work?  Can you
show me the electrical profile and the statechart timing mechanisms together?</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_graph.pdf"><img alt="_images/three_stage_charging_chart_3_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_3_graph.svg" /></a>
<p>“Ok, so first of all we enter the bulk state, then we start getting <code class="docutils literal notranslate"><span class="pre">Tick</span></code>
events with <code class="docutils literal notranslate"><span class="pre">sec</span></code> payloads representing the amount of time in seconds since
the beginning of <code class="docutils literal notranslate"><span class="pre">charging</span></code>.  Notice that when the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state is entered,
the time at which this happened is squirreled away in the <code class="docutils literal notranslate"><span class="pre">start_sec</span></code>
attribute.  From then on, every <code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code> a <code class="docutils literal notranslate"><span class="pre">Tick</span></code> signal will be seen by
the bulk state.  Your current control system will charge the battery.  While this
is happening the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state will see a whole lot of <code class="docutils literal notranslate"><span class="pre">Tick</span></code> events which it
will ignore.  But once the time in bulk is equal to or greater than
<code class="docutils literal notranslate"><span class="pre">abs_timeout_sec</span></code> or if the battery voltage is equal to or greater than
<code class="docutils literal notranslate"><span class="pre">bulk_exit_volt</span></code>, the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state will post a <code class="docutils literal notranslate"><span class="pre">To_Abs</span></code> event to the chart.”</p>
<p>“The <code class="docutils literal notranslate"><span class="pre">To_Abs</span></code> event, will cause an exit from the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state, then an exit
from the <code class="docutils literal notranslate"><span class="pre">constant_current_control</span></code> state.  Then it will enter into the
<code class="docutils literal notranslate"><span class="pre">constant_voltage_control</span></code> state, which will switch the control system to use
a voltage controller, then enter the <code class="docutils literal notranslate"><span class="pre">absorption</span></code> state which will set the
voltage reference to <code class="docutils literal notranslate"><span class="pre">abs_ref_volts</span></code>”.</p>
<p><span class="new-spec">I see how it works and I see how the same thing happens for
transitions to float from absorption.  Also, I see that you can only force your
way into the equalize state, that’s good.</span></p>
<p>He looks a bit longer and says, <span class="new-spec">So the charger will try and spend
most of its time in float? But how to we get back into bulk if there is a big
draw on the batteries? Say our customer has a big DC load that draws the voltage
down below the bulk_entry_volts.  What happens then?</span></p>
<p>You look at the chart and see that you can’t get back into bulk, “Right now you
can’t, I missed that, but let me fix it”  You spend a moment adjusting the
chart, “Look at this:”</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_chart_1.pdf"><img alt="_images/three_stage_charging_chart_3_chart_1.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_3_chart_1.svg" /></a>
<p>“See how I adjusted the <code class="docutils literal notranslate"><span class="pre">Sample_Voltage</span></code> hook to post a <code class="docutils literal notranslate"><span class="pre">To_Bulk</span></code> signal when
the voltage is below the <code class="docutils literal notranslate"><span class="pre">bulk_entry_volts</span></code>.  I have added a <code class="docutils literal notranslate"><span class="pre">To_Bulk</span></code> hook
in the <code class="docutils literal notranslate"><span class="pre">bulk</span></code> state which blocks this event from causing a transition from
<code class="docutils literal notranslate"><span class="pre">charging</span></code> to <code class="docutils literal notranslate"><span class="pre">bulk</span></code> while the unit is in bulk but the voltage is still
lower than the <code class="docutils literal notranslate"><span class="pre">bulk_exit_volts</span></code>.”</p>
<p>He asks, <span class="new-spec">Why would that happen?</span>.</p>
<p>“The charger would probably need some time to get the voltage above the
<code class="docutils literal notranslate"><span class="pre">bulk_entry_volts</span></code> once it fell below this threshold, maybe because of a big
DC draw on the battery.”</p>
<p>He says, <span class="new-spec">Yeah, that will probably happen in some situations</span>.</p>
<p>You ask him, “Do we need to separate the timing of our current, voltage and
decision pulses?”</p>
<p>He says, <span class="new-spec">No, it’s not that important, what’s the cost of having extra
timers anyway?</span></p>
<p>“It’s not a big deal, just each heart beat will have its own thread, and when
I’m looking at the logs it could get kind of cluttered having all of those
signals firing at the same time.  So, maybe I could simplify the design by just
having one heart beat.”</p>
<p><span class="new-spec">Yeah, simple is good, we probably won’t need separate timers.</span></p>
<p>You spend a moment adjusting the chart.  “Here, it’s less cluttered now”:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_3_chart_2.pdf"><img alt="_images/three_stage_charging_chart_3_chart_2.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_3_chart_2.svg" /></a>
<p>Do you see anything else we could pull out of there?</p>
<p><span class="new-spec">No, it seems pretty compact, how are you going to test this thing
anyway?  I’m not going to have hardware for you for a couple of weeks, can you
test it before that?</span>.</p>
<p>“I will run it on a PC and feed it fake electrical profiles, I also plan
to squeeze time so I can run it through all of its states quickly”.</p>
<p>Things seem to be coming together, so we go back and work on our spec, teasing
apart our high level descriptions from our technical design.</p>
</div>
<div class="section" id="spec-4-charger-behavioral-design">
<span id="batterychargingexample-spec-4-charger-behavior-design"></span><h2>Spec 4: Charger Behavioral Design<a class="headerlink" href="#spec-4-charger-behavioral-design" title="Permalink to this headline">#</a></h2>
<p><strong>High level Specification (4)</strong></p>
<ul class="simple">
<li><p>This product will be a three stage charger with an equalization feature.</p></li>
<li><p>The charger has two control systems: constant current and constant voltage.</p></li>
<li><p>The bulk stage is a constant current control technique.</p></li>
<li><p>The absorption, float and equalization stages are constant voltage control
techniques.</p></li>
</ul>
<p>The charging electrical profile can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<p><strong>Sofware Functional Specification (4)</strong></p>
<ul class="simple">
<li><p>The software system will be broken into two parts, fast running c code and slower running Python code.</p></li>
<li><p>The c code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</p></li>
<li><p>The Python code will determine which control strategy the c code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit.</p></li>
<li><p>The Python code will sample the current and voltage and make decisions every 0.5 seconds.</p></li>
</ul>
<p>The Python data architecture can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_data.pdf"><img alt="_images/three_stage_charging_chart_4_data.svg" class="noscale-center" src="_images/three_stage_charging_chart_4_data.svg" /></a>
<p>The Python behavioral architecture can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_chart.pdf"><img alt="_images/three_stage_charging_chart_4_chart.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_4_chart.svg" /></a>
<p>We have enough knowledge now to build something.  Let’s start with the data
model:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_data.pdf"><img alt="_images/three_stage_charging_chart_4_data.svg" class="noscale-center" src="_images/three_stage_charging_chart_4_data.svg" /></a>
<p>The <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/single_unit_three_stage_charger_1.py">code to make this model can be found here</a></p>
<p>It would be simple enough to adjust our code to use a SQL database, or an
object-relational-mapper, like <a class="reference external" href="https://www.sqlalchemy.org">SQLAlchemy</a> to
track the different types of battery specifications.  For now we will leave our
model as Python code, but if you had a lot of different battery types, you might
want to keep them in a database.</p>
<p>Next, let’s write the statechart:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_chart.pdf"><img alt="_images/three_stage_charging_chart_4_chart.svg" class="noscale-center" src="_images/three_stage_charging_chart_4_chart.svg" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Charger</span><span class="p">(</span><span class="n">ChargerParameters</span><span class="p">,</span> <span class="n">LoggedBehavior</span><span class="p">,</span> <span class="n">ThreadSafeAttributes</span><span class="p">):</span>

  <span class="c1"># The charger will be multithreaded, provide simple locks around data</span>
  <span class="c1"># accesses to these attributes</span>
  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;amps&#39;</span><span class="p">,</span>
    <span class="s1">&#39;volts&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sec&#39;</span><span class="p">,</span>
    <span class="s1">&#39;control&#39;</span><span class="p">,</span>
  <span class="p">]</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">charger_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
      <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pulse_sec</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Three stage battery charger feature management</span>

<span class="sd">    This class will manage the data and the behavior of our three stage</span>
<span class="sd">    battery charger.  The control systems used by the charge will be</span>
<span class="sd">    written in c, but the reference and turning parameters of these</span>
<span class="sd">    controllers will be accessible to this python code via SWIG.</span>

<span class="sd">    To understand this class reference:</span>

<span class="sd">      1) the three stage charging electrical profile drawing:</span>

<span class="sd">      2) the three stage charging data architecture drawing:</span>

<span class="sd">      3) the three stage charging state chart drawing:</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``name`` (str): name of the charging state chart</span>
<span class="sd">       | ``charger_params=None`` (ChargerParameters):</span>
<span class="sd">       |                           parameters/controller</span>
<span class="sd">       |                           needed by charger</span>
<span class="sd">       | ``live_trace=None(bool)``: enable live_trace feature?</span>
<span class="sd">       | ``live_spy=None(bool)``: enable live_spy feature?</span>
<span class="sd">       | ``pulse_sec=None``(float): how often to same current/voltage</span>
<span class="sd">       |                            and make decisions about</span>
<span class="sd">       |                            state changes</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      ccs = CurrentControlSystem(# ...)</span>
<span class="sd">      vcs = VoltageControlSystem(# ...)</span>
<span class="sd">      battery_spec = BatterySpecificationSettings(# ...)</span>
<span class="sd">      charge_params = ChargerParameters(</span>
<span class="sd">        c_control=ccs,</span>
<span class="sd">        v_control=vcs,</span>
<span class="sd">        battery_spec=battery_spec)</span>

<span class="sd">      three_stage_charger = Charger(</span>
<span class="sd">        &#39;charger&#39;,</span>
<span class="sd">        charger_params=charger_params,</span>
<span class="sd">        live_trace=True)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pulse_sec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">pulse_sec</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">pulse_sec</span>
    <span class="n">c_control</span> <span class="o">=</span> <span class="n">charger_params</span><span class="o">.</span><span class="n">c_control</span>
    <span class="n">v_control</span> <span class="o">=</span> <span class="n">charger_params</span><span class="o">.</span><span class="n">v_control</span>
    <span class="n">battery_spec</span> <span class="o">=</span> <span class="n">charger_params</span><span class="o">.</span><span class="n">battery_spec</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
      <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
      <span class="n">live_trace</span><span class="o">=</span><span class="n">live_trace</span><span class="p">,</span>
      <span class="n">live_spy</span><span class="o">=</span><span class="n">live_spy</span><span class="p">,</span>
      <span class="n">c_control</span><span class="o">=</span><span class="n">c_control</span><span class="p">,</span>
      <span class="n">v_control</span><span class="o">=</span><span class="n">v_control</span><span class="p">,</span>
      <span class="n">battery_spec</span><span class="o">=</span><span class="n">battery_spec</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">charging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;charging&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Pulse</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_pulse</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Bulk</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_to_bulk</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Bulk</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_bulk</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Abs</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_to_abs</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Abs</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_abs</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Float</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_to_float</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Float</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_float</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Force_Equ</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_force_equ</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging_exit_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;constant_current_control&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
          <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;constant_voltage_control&quot;</span><span class="p">)</span><span class="o">.</span> \
        <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY</span><span class="p">,</span>
          <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contant_voltage_control_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bulk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;bulk&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Bulk</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_to_bulk</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_tick</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">absorption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;absorption&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_tick</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">float_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">equalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;equalize&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize_tick</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_voltage_control</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charging</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">charging_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Pulse</span><span class="p">),</span>
      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
      <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse_sec</span><span class="p">,</span>
      <span class="n">times</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_init_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant_current_control</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">amps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_current</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">volts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_voltage</span><span class="p">()</span>
    <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_entry_volts</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Bulk</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse_sec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Tick</span><span class="p">,</span>
      <span class="n">payload</span><span class="o">=</span><span class="n">SecInCharge</span><span class="p">(</span><span class="n">sec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_to_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_to_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_to_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_force_equ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equalize</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">charging_exit_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">Pulse</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">constant_current_control_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_control</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">contant_voltage_control_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_voltage</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">bulk_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">referece</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_ref_amps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">bulk_to_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">bulk_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">&gt;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_timeout_sec</span> <span class="ow">or</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">volts</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">bulk_exit_volts</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Abs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">absorption_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">abs_ref_volts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">absorption_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">&gt;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">abs_timeout_sec</span> <span class="ow">or</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">amps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">abs_exit_amps</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Float</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">float_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">float_ref_volts</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">equalize_entry_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">equ_ref_volts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">equalize_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">sec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_sec</span> <span class="o">&gt;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">battery_spec</span><span class="o">.</span><span class="n">equ_timeout_sec</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">To_Float</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="k">def</span> <span class="nf">sample_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return 20 amps&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="mi">20</span>

  <span class="k">def</span> <span class="nf">sample_voltage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return 12 volts&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="mi">12</span>
</pre></div>
</div>
<p>You can <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/single_unit_three_stage_charger_2.py">see the full code here</a>.</p>
<p>Before we continue, let’s tune the trace and spy instrumentation to write to a
log file.  We will do this by writing a <code class="docutils literal notranslate"><span class="pre">LoggedBehavior</span></code> class which forces
the trace and spy to write to a log file called <em>single_unit_three_stage_charger.log</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LoggedBehavior</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">log_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> \
      <span class="k">else</span> <span class="n">live_trace</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> \
      <span class="k">else</span> <span class="n">live_spy</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="s1">&#39;single_unit_three_stage_charger.log&#39;</span> \
      <span class="k">if</span> <span class="n">log_file</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">log_file</span>

    <span class="c1"># clear our old log file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
      <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
      <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span>
      <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span>
      <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spy_callback</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span>
      <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace_callback</span><span class="p">)</span>
    <span class="p">)</span>

  <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;trace without datetimestamp&#39;&#39;&#39;</span>
    <span class="n">trace_without_datetime</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[.+\]) (\[.+\].+)&#39;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;T: &quot;</span> <span class="o">+</span> <span class="n">trace_without_datetime</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;spy with machine name pre-pending&#39;&#39;&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;S: [{}] {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>
</pre></div>
</div>
<p>To see the behavior of the chart we need to setup a data model, then create
the statechart.  We will do this at the bottom of the file so it’s easy to test.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

  <span class="c1"># current control system</span>
  <span class="n">ccs</span> <span class="o">=</span> <span class="n">CurrentControlSystem</span><span class="p">(</span>
    <span class="n">reference</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span>  <span class="c1"># 50 amps</span>
    <span class="n">kp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">ki</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
    <span class="n">kd</span><span class="o">=</span><span class="mf">0.04</span>
  <span class="p">)</span>

  <span class="c1"># voltage control system</span>
  <span class="n">vcs</span> <span class="o">=</span> <span class="n">VoltageControlSystem</span><span class="p">(</span>
    <span class="n">reference</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span> <span class="c1"># 12 volts</span>
    <span class="n">kp</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">ki</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="n">kd</span><span class="o">=</span><span class="mf">0.005</span>
  <span class="p">)</span>

  <span class="c1"># battery specification</span>
  <span class="n">battery_spec</span> <span class="o">=</span> <span class="n">BatterySpecificationSettings</span><span class="p">(</span>
    <span class="n">bulk_timeout_sec</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
    <span class="n">abs_timeout_sec</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
    <span class="n">equ_timeout_sec</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>
    <span class="n">bulk_entry_volts</span><span class="o">=</span><span class="mf">18.0</span><span class="p">,</span>
    <span class="n">bulk_exit_volts</span><span class="o">=</span><span class="mf">28.0</span><span class="p">,</span>
    <span class="n">abs_exit_amps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">bulk_ref_amps</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
    <span class="n">float_ref_volts</span><span class="o">=</span><span class="mf">24.0</span><span class="p">,</span>
    <span class="n">abs_ref_volts</span><span class="o">=</span><span class="mf">28.0</span><span class="p">,</span>
    <span class="n">equ_ref_volts</span><span class="o">=</span><span class="mf">30.0</span>
  <span class="p">)</span>

  <span class="c1"># aggregated charger paramters</span>
  <span class="n">charger_params</span> <span class="o">=</span> <span class="n">ChargerParameters</span><span class="p">(</span>
    <span class="n">c_control</span><span class="o">=</span><span class="n">ccs</span><span class="p">,</span>
    <span class="n">v_control</span><span class="o">=</span><span class="n">vcs</span><span class="p">,</span>
    <span class="n">battery_spec</span><span class="o">=</span><span class="n">battery_spec</span>
  <span class="p">)</span>

  <span class="c1"># the charger data and behavior</span>
  <span class="n">three_stage_charger</span> <span class="o">=</span> <span class="n">Charger</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;charger&#39;</span><span class="p">,</span>
    <span class="n">charger_params</span><span class="o">=</span><span class="n">charger_params</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>When we run <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/single_unit_three_stage_charger_2.py">this code</a>
it will write our custom <code class="docutils literal notranslate"><span class="pre">spy</span></code> and <code class="docutils literal notranslate"><span class="pre">trace</span></code> output to the log file.</p>
<p>To view the results, you can <cite>cat</cite> and grep for the <code class="docutils literal notranslate"><span class="pre">trace</span></code> log:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat <span class="s1">&#39;single_unit_three_stage_charger.log&#39;</span> <span class="p">|</span> grep T:
<span class="m">19</span>:54:21,801 DEBUG:T: <span class="o">[</span>charger<span class="o">]</span> e-&gt;start_at<span class="o">()</span> top-&gt;constant_current_control
<span class="m">19</span>:54:22,304 DEBUG:T: <span class="o">[</span>charger<span class="o">]</span> e-&gt;To_Bulk<span class="o">()</span> constant_current_control-&gt;bulk
</pre></div>
</div>
<p>Or view the <code class="docutils literal notranslate"><span class="pre">spy</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat <span class="s1">&#39;single_unit_three_stage_charger.log&#39;</span> <span class="p">|</span> grep S:
.
.
.
<span class="m">19</span>:56:38,706 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">0</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="m">19</span>:56:39,204 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:bulk
<span class="m">19</span>:56:39,204 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:constant_current_control
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:charging
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> POST_FIFO:To_Bulk
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> POST_FIFO:Tick
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Pulse:charging:HOOK
<span class="m">19</span>:56:39,205 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">2</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="m">19</span>:56:39,206 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> To_Bulk:bulk
<span class="m">19</span>:56:39,206 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> To_Bulk:bulk:HOOK
<span class="m">19</span>:56:39,206 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">1</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="m">19</span>:56:39,207 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Tick:bulk
<span class="m">19</span>:56:39,207 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> Tick:bulk:HOOK
<span class="m">19</span>:56:39,207 DEBUG:S: <span class="o">[</span>charger<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">0</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
</pre></div>
</div>
<p>Our electrical engineer comes up to us, <span class="new-spec">How is it going?</span>.</p>
<p>You answer, “No plan ever survives first contact with the enemy.”</p>
<p><span class="new-spec">That well hey?</span></p>
<p>“It’s going well enough, I have the data model and statechart written, I can see
that it might be working, and I only had to change a few things in the design do
get it there.  Now I have to figure out how to test it. I have no idea if it
<em>actually</em> works”</p>
<p><span class="new-spec">Any ideas?</span></p>
<p>“I would like to feed in a graph or a CSV file, and have the statechart respond
to the graph.  I would have to instrument it in such a way that the statechart’s
log output would be easy to interpret next to the graph.”</p>
<p><span class="new-spec">If you figure that out, i would like to use it too.  that’s the nice
thing about software, it’s so gullible, it’s so easy to lie to software?</span></p>
<p>You look at him for a while, and say, “Yeah, I guess you are right, maybe I could
mock it out using dependency injection via subclassing or something like that”.</p>
<p><span class="new-spec">Why do you software guys always invent these complicated names for
things?</span></p>
<p>You think for a while and surprise him with an answer, “I think it happens
because we try to keep everything as general as possible, and we aren’t that
creative about naming, because naming isn’t the thing we think is important at
the time. We are usually trying to solve some other specific problem when we
have to come up with a name.  So, a name just becomes the first, most general
description that pops into our mind, and first ideas are usually bad. But
we don’t care because we don’t think that the name is important when we invent
it. Then that name sticks, and whatever the specific problem we were trying to
solve is forgotten. Nobody has control of the language once it is released to
the public (unless it’s French), so the dumb language just lingers like a bad
smell.”</p>
<p>He laughs and says, <span class="new-spec">Well at least you aren’t using Latin.  I think
your industry comes up with bad names because the names are made by academics,
and they will increase their chances of being published, – paid –, if they
make things sound as complicated and mysterious as possible.</span></p>
<p><span class="new-spec">Why don’t you just add your testing design into the spec, this stuff
you have written needs to work, or you could burn down someone’s house eh?  No
pressure.</span> He smiles. <span class="new-spec">Just add it to the spec, then make it happen.
Oh, and try and keep your gobbledegook out of the spec, I have to read it too.</span></p>
</div>
<div class="section" id="spec-5-high-level-verification-goals">
<span id="batterychargingexample-spec-5-high-level-verification-goals"></span><h2>Spec 5: High Level Verification Goals<a class="headerlink" href="#spec-5-high-level-verification-goals" title="Permalink to this headline">#</a></h2>
<p><strong>High level Specification (5)</strong></p>
<ul class="simple">
<li><p>This product will be a three stage charger with an equalization feature.</p></li>
<li><p>The charger has two control systems: constant current and constant voltage.</p></li>
<li><p>The bulk stage is a constant current control technique.</p></li>
<li><p>The absorption, float and equalization stages are constant voltage control
techniques.</p></li>
</ul>
<p>The charging electrical profile can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<p><strong>Sofware Functional Specification (5)</strong></p>
<ul class="simple">
<li><p>The software system will be broken into two parts, fast running c code and slower running Python code.</p></li>
<li><p>The c code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</p></li>
<li><p>The Python code will determine which control strategy the c code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit.</p></li>
<li><p>The Python code will sample the current and voltage and make decisions every 0.5 seconds</p></li>
</ul>
<p>The Python data architecture can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_data.pdf"><img alt="_images/three_stage_charging_chart_4_data.svg" class="noscale-center" src="_images/three_stage_charging_chart_4_data.svg" /></a>
<p>The Python behavioral architecture can be seen here.</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_chart.pdf"><img alt="_images/three_stage_charging_chart_4_chart.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_4_chart.svg" /></a>
<p><strong>Software Testing Specification (5)</strong></p>
<ul class="simple">
<li><p><span class="new-spec">The charger’s data/behavioral software will be adjusted to use
data instead of real electrical readings.</span></p></li>
<li><p><span class="new-spec">The software that will be shipped (production code) should be
identical to the software that is being tested.  The software testing code
should pass data into the production code and observe the production code’s
behavior without the production code knowing it is under test.</span></p></li>
<li><p><span class="new-spec">A simple physics model will be developed to describe the
relationship between the battery and the charger.  The testing code will use
this model to confirm that the charger’s behavioral software is working as
designed.  The physics model should be parameterized so that it can test
different battery types.</span></p></li>
</ul>
<hr class="docutils" />
<p>I approach my electrical engineer, “Hey, can I get some help about how to think
about my model?”</p>
<p><span class="new-spec">Sure, what do you need to know that you don’t know already?</span>.</p>
<p>“Well, I need to build something that will give me different voltages over time
after I feed in the bulk current, and different current over time when I express a constant
voltage across its “virtual” battery terminals.”</p>
<p><span class="new-spec">Hold on, show me what you want</span>.</p>
<p>You place the electrical profile in front of him:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<p>“I have to be able to fake out these electrical profiles.  Any ideas?”</p>
<p><span class="new-spec">Yeah, I can help you with that, but first you have to understand a
few things about batteries.  Do you have time?</span></p>
<p>“Of course.”</p>
<p><span class="new-spec">Ok, well, batteries are very complicated, their behaviors are
effected by their chemistry, age, the temperature, how fast they have been
discharged, how they have been charged.. it goes on.  But, there are some common
ways of thinking about battery characteristics.  Once you understand some of
these ideas, I will draw some pictures which simplify how a battery works well
enough so that you can build your software model.</span></p>
<p><span class="new-spec">Now suppose, the battery in your car is “dead”.  It still has some
charge in it, but it can’t drive enough current to turn your car on.  When you
place a voltage meter across its terminals you see that it measures 11 volts.
That’s lower than it should be, so you connect a trickle charger across the
terminals and plug it in.  When you measure the battery terminal voltage again,
you see that it’s the same as the voltage of the trickle charger, 13.5 Volts.
You go and get a cup of coffee.  Later, you come back to your car and out of
curiosity, you disconnect the charger and measure the battery voltage, then you
watch the number on your meter fall from 13 to 12 to 11.5.  It stabilizes onto
11.5 V.  This stabilized voltage is called the “Open Circuit Voltage” of the
battery.</span></p>
<p><span class="new-spec">The “Open Circuit Voltage” is a kind of hidden state.  When the
charger was connected, we could not read this “Open Circuit Voltage” from the
terminals, because the charger was holding the voltage at 13.5 V.</span></p>
<p><span class="new-spec">But, this “Open Circuit Voltage” isn’t what you really care about,
you just want to turn your car on right?  To do that, your battery will need to
drive enough current to crank your engine and start the car.  When you drive
charge through a circuit it’s called current, or how much charge passes through
the circuit in a given amount of time.  If your battery is “dead”, it means that
the charge it is holding is less than the charge you need to deliver to your
car’s starter for the time needed for the engine to start.</span></p>
<p>He pauses for a moment and takes a breath.  Then he says,  <span class="new-spec">But how
much charge can your battery hold anyway?  Well The total amount of charge a
battery can hold is dependent upon its physical size and its chemistry.  A
battery’s capacity to store charge will go down over time, since you break down
some of the materials required to make the electro-chemical reaction as you
charge and discharge the battery.  But your *new* battery would have been rated
in “amp-hours”.  This “amp-hours” rating describes the constant current it could
deliver for one full hour.</span></p>
<p><span class="new-spec">To make it easy to compare the characteristics of batteries of
different “amp-hour” ratings, we talk about it indirectly, we talk about the
“state of charge” of the battery, or what percentage of charge exists in the
battery.  For our car, when the battery was dead, this might have been 10
percent.  When we tested it, after having the coffee, it might have been 25
percent.  It turns out that measuring the “state of charge” of a battery is a very
challenging problem.</span></p>
<p><span class="new-spec">So you climb in your car, and try the engine again and hurray, it
starts.  You drive to work, and here you are with me, now we have a different
problem. You need to make a battery model to test your software, eh?</span></p>
<p><span class="new-spec">Let me show you how the “Open Circuit Voltage” relates to a lead
acid battery’s “State of Charge”.  It kind of looks like this</span>.  He draws this
on a napkin:</p>
<a class="reference external image-reference" href="_static/ocv_soc.pdf"><img alt="_images/ocv_soc.svg" class="noscale-center" src="_images/ocv_soc.svg" /></a>
<p><span class="new-spec">Now get this, for a lead acid battery, it takes 24 hours for the open
circuit voltage to stabilize.  So if you wanted to make that graph, you would
have to completely discharge a battery, then wait a day then charge it a bit and
wait a day, and a couple of months later you would have a graph.  I’m glad I
don’t have to do that.  God bless the researcher.  Oh! And get this: the curve
changes depending on direction of the charge flow, you will make a different
graph if you start from a dead battery and incrementally charge it,  or if you
start from a full battery and incrementally discharge it. So things can get
complicated.</span></p>
<p>“Yeah, it seems that way.”</p>
<p><span class="new-spec">Don’t worry, your simulator doesn’t have to be that good.  You just
want to generate currents and voltages that kind of look like something we could
get from a lead acid system.</span></p>
<p><span class="new-spec">Now remember what I said about the “Open circuit Voltage” being a
hidden voltage within the battery? To make a simple equivalent circuit, we
pretend that the battery has a resistor in series with its hidden “Open circuit
Voltage”</span>:</p>
<a class="reference external image-reference" href="_static/battery_model_1.pdf"><img alt="_images/battery_model_1.svg" class="noscale-center" src="_images/battery_model_1.svg" /></a>
<p><span class="new-spec">Look</span>  He points to the diagram. <span class="new-spec">When there is no current
the voltage across the resistor falls to zero and the “Open circuit Voltage” is
expressed at the battery terminals.</span>  He pauses and waits.  “I see that”.</p>
<p><span class="new-spec">When a constant voltage charger is connected, the “Battery Terminal Voltage”
is equal to the voltage across the resistor plus the “Open Circuit Voltage”.
You can calculate the current, then use that information to update the battery’s
state of charge, for your next increment of time.</span></p>
<p><span class="new-spec">When a constant current charger is connected, the “Battery Terminal
Voltage” is equal to the voltage across the resistor plus the “Open Circuit
Voltage”.  You can calculate the V_r and add it to the “Open Circuit Voltage”
and that will be your terminal voltage.  Like before, you can use the current to
update the battery’s state of charge for your next increment of time.</span></p>
<p><span class="new-spec">You now know enough to make a simulator.  But there is something else
I think you should add to it.  We are going to over-charge the battery, and we
aren’t going to let the battery settle to its true open circuit voltage.  We will be
charging at c/3.</span></p>
<p>You ask, “What is c?”</p>
<p><span class="new-spec">C is a measure of the rate of the battery’s charge or discharge.  If
your battery was rated at 1Ah it should be able to source 1 Amp for 1 hour.  If
you discharged at 2C your battery could source 2 Amps for 30 minutes.</span></p>
<p>“Then why don’t we charge at 5C or 100C?  Why wait around?”</p>
<p><span class="new-spec">Heat.  Your lead-acid battery would probably bubble and explode in
flames if you did that.  Think flaming acid, eh?  I don’t know what would happen,
but it would be bad.  See that equivalent resistor in the diagram, it does a
decent job of modelling what is happening in our system.  The heat produced from
the battery while we charge it is proportional to the current times itself.
This squared relationship limits how fast we can charge the system.</span></p>
<p><span class="new-spec">I probably should have explained the C-rating first, since it’s
actually from this that the amp-hour rating comes from.  Battery manufacturers
cheat using these ideas.</span></p>
<p>“What do you mean?”</p>
<p><span class="new-spec">Well, if you discharge your battery over a very very long time, you
avoid losing energy through heat.  So, if you discharge a full battery at 0.2C,
or 5 hours, then set your battery’s amp hour rating based on this information,
you will fool your customer into thinking that your battery can source this
amp-hour rating at 1 hour.  This is not true, there is a non-linear relationship
which means you will produce a lot of heat and you won’t get anywhere near as
much current as has been advertized.</span></p>
<p>“Wow, so the rating isn’t the rating?”</p>
<p><span class="new-spec">Well, it’s all complicated, so the manufacturers find ways of making
their numbers look better than their competition’s numbers.  The market settles
things out.  Anyway, an amp-hour rating really isn’t what they say it is, so we
will charge at C/3 to avoid any problems.</span></p>
<p>“Wait a minute, if we can’t trust the ratings, how can you safely charge the
battery?”</p>
<p><span class="new-spec">Don’t worry, C/3 is typically ok, and we will also attach a battery
temperature sensor.  If the temperature gets too high we will change the control
system’s reference to a lower number, reducing the amount of current sourced
from our charger.</span></p>
<p><span class="new-spec">Here is the graph I would like you to use:</span></p>
<a class="reference external image-reference" href="_static/ocv_soc_2.pdf"><img alt="_images/ocv_soc_2.svg" class="noscale-center" src="_images/ocv_soc_2.svg" /></a>
<p><span class="new-spec">Use the blue line.</span></p>
<p>“This graph doesn’t really make any sense to me, you said the open circuit
voltage on a lead acid battery can’t be found for 24 hours, how can we talk
about it while we are charging?”</p>
<p><span class="new-spec">Exactly, the black line is the one a researcher might get for us, and
the blue line is the “hidden” voltage of our battery while we charge at c/3.
It’s technically not an “open circuit voltage” anymore because we won’t let the
voltage truly settle, but it’s useful anyway.  Imagine that it was measured 20
seconds after we have disconnected the charger.  The blue line represents a kind
of instantaneous hidden voltage of the battery.  But, if you were to stop
charging at some point along the x-axis, in 24 hours the voltage would settle to
the black line for the same state of charge. I just want you to make the line go
up once we have over-charged the battery.  Like “horse shoes” and “hand
grenades”; we just need to be close enough.</span></p>
<p>“How can I put more than 100 percent charge in the battery?”</p>
<p><span class="new-spec">Good question, you can’t really, but if you drive more current than
what it was rated for, the voltage will start to go up like I drew on the
picture.  This is a useful property it tells us when we are done, so I would
like you to add it to your model.</span></p>
<p><span class="new-spec">Use this equivalent circuit:</span></p>
<a class="reference external image-reference" href="_static/battery_model_2.pdf"><img alt="_images/battery_model_2.svg" class="noscale-center" src="_images/battery_model_2.svg" /></a>
<p>“What numbers should I use?”  <span class="new-spec">I would like you to make your battery
model parameterizable, but for now set the far right knee on the graph to 13.0
V.  Make your model’s “C/3” profile dependent upon data, since this is
all emperical stuff.  Good luck!</span></p>
<hr class="docutils" />
<p>You grab a pad of paper and a pencil and head out to a cafe.  Once you sit down
you determine that you need to start with a data set, and from that data set to
be able to create a function that can give you an open circuit voltage given a
battery state of charge.  You head back, and build the following <code class="docutils literal notranslate"><span class="pre">ocv_soc.csv</span></code>
file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">state_of_charge</span><span class="p">,</span><span class="n">open_circuit_voltage</span>
<span class="mi">0</span><span class="p">,</span><span class="mf">0.00</span>
<span class="mi">3</span><span class="p">,</span><span class="mf">3.23</span>
<span class="mi">6</span><span class="p">,</span><span class="mf">7.52</span>
<span class="mi">9</span><span class="p">,</span><span class="mf">9.89</span>
<span class="mi">12</span><span class="p">,</span><span class="mf">10.75</span>
<span class="mi">15</span><span class="p">,</span><span class="mf">11.61</span>
<span class="mi">18</span><span class="p">,</span><span class="mf">12.04</span>
<span class="mi">19</span><span class="p">,</span><span class="mf">12.10</span>
<span class="mi">20</span><span class="p">,</span><span class="mf">12.15</span>
<span class="mi">30</span><span class="p">,</span><span class="mf">12.26</span>
<span class="mi">40</span><span class="p">,</span><span class="mf">12.36</span>
<span class="mi">50</span><span class="p">,</span><span class="mf">12.47</span>
<span class="mi">60</span><span class="p">,</span><span class="mf">12.59</span>
<span class="mi">70</span><span class="p">,</span><span class="mf">12.69</span>
<span class="mi">80</span><span class="p">,</span><span class="mf">12.79</span>
<span class="mi">90</span><span class="p">,</span><span class="mf">12.90</span>
<span class="mi">100</span><span class="p">,</span><span class="mf">12.90</span>
<span class="mi">101</span><span class="p">,</span><span class="mf">13.01</span>
<span class="mi">103</span><span class="p">,</span><span class="mf">13.33</span>
<span class="mi">105</span><span class="p">,</span><span class="mf">13.65</span>
<span class="mi">107</span><span class="p">,</span><span class="mf">14.62</span>
<span class="mi">110</span><span class="p">,</span><span class="mf">15.80</span>
<span class="mi">120</span><span class="p">,</span><span class="mf">20.80</span>
</pre></div>
</div>
<p>Then using something like the following code you plot your data and the
functional approximation of the data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">data_ocv_soc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span>
  <span class="s1">&#39;ocv_soc.csv&#39;</span><span class="p">,</span>
  <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
  <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;state_of_charge&#39;</span><span class="p">,</span> <span class="s1">&#39;open_circuit_voltage&#39;</span><span class="p">],</span>
  <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float, float&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># build the function which will approximate the data set</span>
<span class="n">fn_soc_to_ocv</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
  <span class="n">data_ocv_soc</span><span class="p">[</span><span class="s1">&#39;state_of_charge&#39;</span><span class="p">],</span>
  <span class="n">data_ocv_soc</span><span class="p">[</span><span class="s1">&#39;open_circuit_voltage&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;csv_color&#39;</span><span class="p">:</span> <span class="s1">&#39;tab:red&#39;</span><span class="p">,</span>
  <span class="s1">&#39;function_color&#39;</span><span class="p">:</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># plot the data and the approximation function</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
  <span class="n">data_ocv_soc</span><span class="p">[</span><span class="s1">&#39;state_of_charge&#39;</span><span class="p">],</span>
  <span class="n">data_ocv_soc</span><span class="p">[</span><span class="s1">&#39;open_circuit_voltage&#39;</span><span class="p">],</span>
  <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;csv_color&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Battery Profile&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;open_circuit_voltage csv&quot;</span><span class="p">)</span>
<span class="n">x_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
  <span class="n">data_ocv_soc</span><span class="p">[</span><span class="s1">&#39;state_of_charge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
  <span class="n">data_ocv_soc</span><span class="p">[</span><span class="s1">&#39;state_of_charge&#39;</span><span class="p">],</span>
  <span class="mi">50</span>
<span class="p">)</span>
<span class="n">y_new</span> <span class="o">=</span> <span class="n">fn_soc_to_ocv</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="s1">&#39;function_color&#39;</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;state_of_charge&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;fn_soc_to_ocv&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;battery_profile.svg&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;battery_profile.pdf&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The data plot looks like this:</p>
<a class="reference external image-reference" href="_static/battery_profile.pdf"><img alt="_images/battery_profile.svg" class="noscale-center" src="_images/battery_profile.svg" /></a>
<p>After <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/battery_model.py">completing the work</a> you
track down your electrical engineer and say, “Hey I have a battery simulator, do
you want to see it?”</p>
<p><span class="new-spec">Sure</span>.</p>
<p>“I wrote everything onto a picture before I wrote the code, then I went back and
forth between my picture and the code until I got it working, here is what I
have so far:”</p>
<a class="reference external image-reference" href="_static/battery_model_3.pdf"><img alt="_images/battery_model_3.svg" class="scale-to-fit" src="_images/battery_model_3.svg" /></a>
<p><span class="new-spec">Another statechart eh?</span></p>
<p>“Yes, shall we start from the top?”  Not waiting for his answer you begin.</p>
<p>“Like before, the top of the diagram describes data and some methods and the
bottom part of the diagram describes the behavior of the software.”</p>
<p>“I have written two methods, <code class="docutils literal notranslate"><span class="pre">_amp_given_terminal_volts</span></code> and
<code class="docutils literal notranslate"><span class="pre">_amp_hours_given_amps</span></code> at the top of the diagram, near the simple circuit
drawing so I can see them near that picture.”</p>
<p>He reads these methods, and nods, then his eyes shift to the
<code class="docutils literal notranslate"><span class="pre">BatteryAttributes</span></code> class and asks, <span class="new-spec">What are the BatteryAttributes
and why aren’t they just in the Battery?</span>.</p>
<p>“I pulled those out into their own class, because I want to read and write
those attributes from more than one thread. The <code class="docutils literal notranslate"><span class="pre">BatteryAttributes</span></code> class
inherits from the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class so it can access thread safe
features.  Then I pulled the <code class="docutils literal notranslate"><span class="pre">BatteryAttributes</span></code> code into the <code class="docutils literal notranslate"><span class="pre">Battery</span></code>
class using the multiple inheritance feature of Python (which is just kind of
like a copy and paste).  Since they are in their own box on the diagram, with a
glance I can see what attributes are thread safe and what aren’t.”</p>
<p><span class="new-spec">How does the circuit work with your software?</span></p>
<p>“It describes the relationship between the terminal volts, the battery current
and the open_circuit_volts.  The open_circuit_volts has a relationship with the
state_of_charge of the battery, so from this simple circuit and the function
derived from the battery_profile_csv data, you can build the full simulator.
You can charge and discharge a simulated battery.”</p>
<p><span class="new-spec">How can you do that from this?</span> and points to the picture.</p>
<p>“I wanted the model to be ‘generalizeable’, as you say.  So, its based on
data that you feed it via the <code class="docutils literal notranslate"><span class="pre">battery_profile.csv</span></code>.  Which is a simple spread
sheet describing the battery’s state_of_charge vrs the open_circuit_volts. Here
is a graph of that data:”</p>
<a class="reference external image-reference" href="_static/battery_profile.pdf"><img alt="_images/battery_profile.svg" class="noscale-center" src="_images/battery_profile.svg" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can find the <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.csv">data to generate this model</a> here, and the
<a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.py">code to make the graphs</a> here.</p>
</div>
<p>He looks at it and says, <span class="new-spec">Where did you get your data?</span>.</p>
<p>“<a class="reference external" href="https://www.cadex.com/en">Cadex</a> posts a lot of their information online.  I
used one of their pictures as a reference. My CSV file isn’t real though, I just
eyeballed their graph to make mine.”</p>
<p>He says, <span class="new-spec">Good enough, what is the second graph?</span></p>
<p>“The software can’t use the CSV file directly, it needs a function, so I built a
function from this data and this function was used to draw the second graph.”</p>
<p><span class="new-spec">So the second graph isn’t the data?  Not bad, it looks the same
as the CSV file.</span></p>
<p>“It took me a while to find something that would work, at first I tried to match
the data with a polynomial but it was very wiggly, I had something that looked
alright at order 8 but at order 9 it was starting to over-fit.  In the end I
just went with an interpolation provided by <code class="docutils literal notranslate"><span class="pre">scipy.interpolate</span></code>.  I think its
called a linear spline or something.  The point is that from the data I can
build a function.  From this function I can get the open_circuit_voltage given a
battery state_of_charge.”</p>
<p>“You can see that I build this function when the statechart enters the
<code class="docutils literal notranslate"><span class="pre">build_ocv_soc_profile</span></code>.” as I point to the statechart.</p>
<p>He asks, <span class="new-spec">Why did you put that in the statechart and not just in the
constructor of your python Battery class?</span></p>
<p>“I wanted to be able to switch graphs. If we decide to make the battery more
sophisticated we will have to do something like that;  when I was researching
how this relationship works I saw that the graph profile changes based on
charge-current, temperature and so on.  If I leave the function construction in
the statechart I can hot-swap it based on what is happening in the battery.”</p>
<p><span class="new-spec">I don’t think we will need something that sophisticated.  How does
the behavior work anyway?</span></p>
<p>“I wanted something that would look like how it looks when you are using a real
battery, so I made its time our time.</p>
<p><span class="new-spec">What do you mean by that?</span></p>
<p>“You can feed the statechart <code class="docutils literal notranslate"><span class="pre">amp</span></code> or <code class="docutils literal notranslate"><span class="pre">volt</span></code> events once it has started, and
the simulator will just assume that is what you are doing until you send it
another sample.  It’s like you are feeding it DC Amps or Volts until you send it
new information.  So, if we build a 100 Amp Hour battery, it will take in the
order of an hour to charge the battery at 100 Amps while we run it.”</p>
<p><span class="new-spec">So it literally acts like a battery in real time?</span></p>
<p>“Yeah, but I also wanted the option of compressing time, so that I don’t have to
sit around while I’m testing the software.  I’ll use the battery in our time
frame, to build data sets which can be run almost instantaneously later.”</p>
<p><span class="new-spec">Ok, how does that work, pull up the design and show me.</span></p>
<a class="reference external image-reference" href="_static/battery_model_3.pdf"><img alt="_images/battery_model_3.svg" class="scale-to-fit" src="_images/battery_model_3.svg" /></a>
<p>“So to build one of these you would write something like this:”</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">battery</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span>
 <span class="n">rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
 <span class="n">batt_r_ohms</span><span class="o">=</span><span class="mf">0.014</span><span class="p">,</span>
 <span class="n">battery_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_soc.csv&#39;</span><span class="p">,</span>
 <span class="n">initial_soc_per</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;battery_example&quot;</span><span class="p">,</span>
 <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>“Here we would have a battery that’s rated at 100 Amp hours, with an internal
resistance of 0.014 Ohms that is 10 percent full.  I already showed you the
state_of_charge versus open_circuit_voltage graph which will be used.”</p>
<p>“When the chart starts, it builds a <code class="docutils literal notranslate"><span class="pre">fn_soc_to_ocv</span></code> which we already talked
about, then climbs into the <code class="docutils literal notranslate"><span class="pre">update_charge_state</span></code> and waits for events.  From
here you can sent it <code class="docutils literal notranslate"><span class="pre">amp_hours</span></code>, <code class="docutils literal notranslate"><span class="pre">amps</span></code>, <code class="docutils literal notranslate"><span class="pre">amps_and_time</span></code>, <code class="docutils literal notranslate"><span class="pre">volts</span></code> or
<code class="docutils literal notranslate"><span class="pre">volts_and_time</span></code> events.  Any one of these events can change the battery state.”</p>
<p>“Suppose we wanted to control the battery in constant voltage mode.  We would
send it a <code class="docutils literal notranslate"><span class="pre">volts</span></code> event containing a <code class="docutils literal notranslate"><span class="pre">Volts</span></code> payload.  The code would look like
this:”</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">battery</span><span class="o">.</span><span class="n">send_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">volts</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">Volts</span><span class="p">(</span><span class="mf">11.7</span><span class="p">)))</span>
</pre></div>
</div>
<p>“This event would be caught by the <code class="docutils literal notranslate"><span class="pre">volts</span></code> hook in the <code class="docutils literal notranslate"><span class="pre">volts_to_amps</span></code> state
and it would be turned into a <code class="docutils literal notranslate"><span class="pre">volts_and_time</span></code>.”</p>
<p><span class="new-spec">What is that time relative to?</span></p>
<p>“When the battery is started, the <code class="docutils literal notranslate"><span class="pre">last_sample_time</span></code> is stored, so it will be
relative to that.”</p>
<p>You pause, he nods.</p>
<p>So you continue, “There is a <code class="docutils literal notranslate"><span class="pre">volts_and_time</span></code> event, which is captured by the
<code class="docutils literal notranslate"><span class="pre">volts_to_amps</span></code> state, which calculates the amps based on the current state of
charge and the terminal volts.  The <code class="docutils literal notranslate"><span class="pre">last_terminal_voltage</span></code> is squirreled
away, and then a <code class="docutils literal notranslate"><span class="pre">amps_and_time</span></code> event is invented and posted to the chart.
Following that, a transition is made into the <code class="docutils literal notranslate"><span class="pre">amps_to_amp_hours</span></code> state.”</p>
<p>“The <code class="docutils literal notranslate"><span class="pre">amps_to_amps_hours</span></code> state, catches this <code class="docutils literal notranslate"><span class="pre">amps_to_time</span></code> event, and
figures out the <code class="docutils literal notranslate"><span class="pre">terminal_voltage</span></code> again and calculates the <code class="docutils literal notranslate"><span class="pre">amp_hours</span></code> being
produced by this sample of <code class="docutils literal notranslate"><span class="pre">amps</span></code>.</p>
<p>You pause for a breath then say, “The <code class="docutils literal notranslate"><span class="pre">amps_to_time</span></code> signal handler squirrels
away the <code class="docutils literal notranslate"><span class="pre">last_current_amps</span></code>, the <code class="docutils literal notranslate"><span class="pre">last_sample_time</span></code>, and the
<code class="docutils literal notranslate"><span class="pre">last_terminal_volts</span></code> and then it invents the <code class="docutils literal notranslate"><span class="pre">Amp_Hours</span></code> event and posts it
to the chart. Finally, it transitions to the <code class="docutils literal notranslate"><span class="pre">update_charge_state</span></code>.</p>
<p>You wait for him to make eye contact, he studies the chart and without looking
at you says, <span class="new-spec">Keep going.</span></p>
<p>This <code class="docutils literal notranslate"><span class="pre">update_charge_state</span></code> receives the <code class="docutils literal notranslate"><span class="pre">amp_hours</span></code> event, calculates the
new total amp hours for the battery, figures out a new state of charge, then
figures out what the new open circuit voltage is.  These values are thread-safe
so they can be read from within the statechart’s thread, or from any other
object that has a reference to the battery (like main).</p>
<p>“So, from our original volt event, we have a new battery state”.</p>
<p><span class="new-spec">Why is it so complicated?  Why not just update the battery information
directly from the terminal voltage using the battery circuit equations?</span></p>
<p>“It’s not that complicated, because it forces re-use of the same calculation
pathways.  The exact same logic will be followed if a constant current is
applied, but instead of the amps being calculated from the volts, they are
provided directly from the event.  Look, you can see something very similar
happens if an <code class="docutils literal notranslate"><span class="pre">amps</span></code> event is sent.”  You point to the <code class="docutils literal notranslate"><span class="pre">amps_to_amp_hours</span></code>
state on the diagram. “Try and describe to me how it works.”</p>
<p>He looks at it and asks, <span class="new-spec">Where is the state machine usually
sitting?</span></p>
<p>“It’s usually in the <code class="docutils literal notranslate"><span class="pre">update_charge_state</span></code>”.</p>
<p>He concentrates for a moment and says, <span class="new-spec">Yeah, ok, the amps event kind
of works the same way, it generates a amps_and_time event, which is caught then
fed as a amp_hours event, and eventually the chart climbs back into the
update_charge_state, like before.</span></p>
<p>He pauses, then says, <span class="new-spec">I think I see a problem though, what happens if an amps
event is being processed while the volts event was being processed?</span></p>
<p>“It’s not a problem because the invented signals are posted using <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code>
calls.  This will automatically change the order of the events in the queue, if
an <code class="docutils literal notranslate"><span class="pre">amp</span></code> event is received by the battery while it is still chewing on the
<code class="docutils literal notranslate"><span class="pre">volts</span></code> event, the invented <code class="docutils literal notranslate"><span class="pre">amps_and_time</span></code> and <code class="docutils literal notranslate"><span class="pre">amp_hours</span></code> events will be
invented an processed before the <code class="docutils literal notranslate"><span class="pre">amps</span></code> event is dealt with. The call to
<code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> is very selfish; It will always push itself to the front of the
queue.”</p>
<p><span class="new-spec">Ok, so I think I kind of understand your design, let’s see it work.</span></p>
<p>“It’s kind of boring to watch, what do you want to see?”</p>
<p><span class="new-spec">Well, let’s watch the point at which the charger should switch
between bulk to absorption.  Ideally I would like to see this happen when the
battery is 80 percent charged.</span></p>
<p>“Ok, so I’ll place the battery near an 80 percent state of charge and transition
from a constant current to a constant voltage technique once it’s charged to 80
percent. What charge current do you want?”</p>
<p><span class="new-spec">What is the battery rating?</span></p>
<p>You say, “100 Ah.”</p>
<p><span class="new-spec">Charge it at c/3, or about 30 amps</span>.</p>
<p>“To do that in code I would write:”</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">battery</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span>
  <span class="n">rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">batt_r_ohms</span><span class="o">=</span><span class="mf">0.014</span><span class="p">,</span>
  <span class="n">battery_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_soc.csv&#39;</span><span class="p">,</span>
  <span class="n">initial_soc_per</span><span class="o">=</span><span class="mf">79.9</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;battery_example&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="n">battery</span><span class="o">.</span><span class="n">soc_per</span> <span class="o">&lt;</span> <span class="mf">80.0</span><span class="p">:</span>
  <span class="n">battery</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">amps</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">Amps</span><span class="p">(</span><span class="mf">30.0</span><span class="p">)))</span>
  <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">abs_volts</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">last_terminal_voltage</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">battery</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">volts</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">Volts</span><span class="p">(</span><span class="n">abs_volts</span><span class="p">))</span>
  <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>“Let’s watch it work:”</p>
<div class="video-content">
  <iframe src="https://www.youtube.com/embed/qI8-3kF5nlU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div><p><span class="new-spec">There seems to be something weird happening with the time.</span></p>
<p>“Yeah, the time print out is the difference in seconds from when the simulation
started and when the reading was being made, you are watching python slip.  When
you write <code class="docutils literal notranslate"><span class="pre">time.sleep(1)</span></code> you don’t actually sleep 1 second you sleep a bit
more than that.  This slip is dependent upon your operating system and what
other kinds of computational loads you are running.  Because of this, no two
runs of the program will generate the same results, since the time difference
comes to play in how the state-of-charge is accumulated.”</p>
<p><span class="new-spec">Ok, well it looks like you got the transition working, but I don’t
think you have enough loss in your battery, where did you get your internal
resistance number from?</span></p>
<p>“I pulled it off of a battery vendor’s data sheet.”</p>
<p><span class="new-spec">Ah yes, that is another way for vendor’s to white-lie about their
batteries, the internal resistance changes as you charge the battery.  Would it
be hard for you to add another curve?  The battery resistence changes with its
state of charge.  If you add this your simulator will behave more like a real
battery.</span></p>
<p>“No, it wouldn’t be that hard, I would just do what I did before, the hardest
part would be finding good data and updating the diagram with a graphic.”</p>
<p><span class="new-spec">If it isn’t a big deal add it.  Otherwise, this is good enough.</span></p>
<hr class="docutils" />
<p>You head back to the <a class="reference external" href="https://batteryuniversity.com/learn/archive/how_does_internal_resistance_affect_performance">cadex website</a>
and find a open circuit voltage versus internal resistance graph for a lead acid
battery:</p>
<a class="reference external image-reference" href="_static/battery_resistance_profile.pdf"><img alt="_images/battery_resistance_profile.svg" class="noscale-center" src="_images/battery_resistance_profile.svg" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Above 14 V, the battery resistence was just made up.  This data was not
provided by cadex, I am just imagining how it would work.</p>
<p>You can find the <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.csv">data to generate this model</a> here, and the
<a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.py">code to make the graphs</a> here.</p>
</div>
<p>Then you update the battery simulator design:</p>
<a class="reference external image-reference" href="_static/battery_model_4.pdf"><img alt="_images/battery_model_4.svg" class="scale-to-fit" src="_images/battery_model_4.svg" /></a>
<p><span class="new-spec">You know, if you keep adding features like this to the battery
simulator you are going to have something that is very useful, not just for us.</span></p>
<p>“All I need is data, its the Python <cite>numpy</cite> and <cite>scipy</cite> packages that are doing
the heavy lifting and the statechart manages the time and the design complexity.
Speaking of which, I have simplified things by adding the <code class="docutils literal notranslate"><span class="pre">amps_into_terminal</span></code>
and <code class="docutils literal notranslate"><span class="pre">volts_across_terminal</span></code> methods.  You shouldn’t have to know about event
names if you are using the simulator, the code should figure that out for you.”</p>
<p><span class="new-spec">Can you speed it up? Maybe compress time? Like, make an
hour of charging in the battery’s time happen in tens of seconds in our time
frame?</span></p>
<p>“Yes, I added a time_series static function to the battery model, here is how we
would speed things up:”</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># .. simulator code above</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

   <span class="n">battery</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span>
     <span class="n">rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
     <span class="n">initial_soc_per</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
     <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lead_acid_battery_100Ah&quot;</span><span class="p">,</span>
     <span class="n">soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
     <span class="n">ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
     <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span>
   <span class="p">)</span>

   <span class="n">hours</span> <span class="o">=</span> <span class="mi">1</span>

   <span class="n">time_series</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">time_series</span><span class="p">(</span>
     <span class="n">duration_in_sec</span><span class="o">=</span><span class="n">hours</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
   <span class="p">)</span>

   <span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">time_series</span><span class="p">:</span>
     <span class="k">if</span> <span class="n">battery</span><span class="o">.</span><span class="n">soc_per</span> <span class="o">&lt;</span> <span class="mf">80.0</span><span class="p">:</span>
       <span class="n">battery</span><span class="o">.</span><span class="n">amps_into_terminals</span><span class="p">(</span><span class="mf">33.0</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
       <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
       <span class="n">abs_volts</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">last_terminal_voltage</span>
     <span class="k">else</span><span class="p">:</span>
       <span class="n">battery</span><span class="o">.</span><span class="n">volts_across_terminals</span><span class="p">(</span><span class="n">abs_volts</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
       <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>“This code will get us around our Python time-slippage issue.  See how I
pre-calculate the time in the <code class="docutils literal notranslate"><span class="pre">time_series</span></code>?”</p>
<p><span class="new-spec">Not really.</span></p>
<p>“The call to the <code class="docutils literal notranslate"><span class="pre">time_series</span></code> function basically creates a set
of time stamps ranging from “now” till one hour from now, 1 second apart.  There
will be 3600 of them.  We then try to slam the battery with data as fast as main
will run.  The battery model doesn’t know that its running one hour into our
future; we feed it its time reference.”</p>
<p><span class="new-spec">Show me.</span></p>
<div class="video-content">
   <iframe src="https://www.youtube.com/embed/HFwYUzvyIxk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div><p><span class="new-spec">It looks good, but why does your simulator only run to 3581 and not
closer to 3600?</span></p>
<p>“I didn’t see that.”</p>
<p>You think for a moment and say, “It’s losing events, the main program is running
faster than the battery model’s thread.  If you added a small time delay at the
end of the loop the battery would be able to keep up.  Main is basically doing a
denial of service attack on the battery.  Despite this, the simulator seems to
work as you would expect.”</p>
<p><span class="new-spec">That’s kind of cool, but your tests will be non-deterministic.</span></p>
<p>“Yeah, I’ll add a delay when we use the simulator to test the charger.  You have
identified a bigger issue than the time-slippage issue, but it is much easier to
fix.”</p>
<p>Now that we have a way to simulate a battery, we will add this information to
our specification:</p>
</div>
<div class="section" id="spec-6-battery-simulator">
<span id="batterychargingexample-spec-6-battery-simulator"></span><h2>Spec 6: Battery Simulator<a class="headerlink" href="#spec-6-battery-simulator" title="Permalink to this headline">#</a></h2>
<p><strong>High level Specification (6)</strong></p>
<ul class="simple">
<li><p>This product will be a three stage charger with an equalization feature.</p></li>
<li><p>The charger has two control systems: constant current and constant voltage.</p></li>
<li><p>The bulk stage is a constant current control technique.</p></li>
<li><p>The absorption, float and equalization stages are constant voltage control
techniques.</p></li>
</ul>
<p>The charging electrical profile can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<p><strong>Sofware Functional Specification (6)</strong></p>
<ul class="simple">
<li><p>The software system will be broken into two parts, fast running c code and slower running Python code.</p></li>
<li><p>The c code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</p></li>
<li><p>The Python code will determine which control strategy the c code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit.</p></li>
<li><p>The Python code will sample the current and voltage and make decisions every 0.5 seconds.</p></li>
</ul>
<p>The Python data architecture can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_data.pdf"><img alt="_images/three_stage_charging_chart_4_data.svg" class="noscale-center" src="_images/three_stage_charging_chart_4_data.svg" /></a>
<p>The Python behavioral architecture can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_4_chart.pdf"><img alt="_images/three_stage_charging_chart_4_chart.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_4_chart.svg" /></a>
<p><strong>Software Testing Specification (6)</strong></p>
<ul class="simple">
<li><p>The charger’s data/behavioral software will be adjusted to use data instead of real electrical readings.</p></li>
<li><p>The software that will be shipped (production code) should be
identical to the software that is being tested.  The software testing code
should pass data into the production code and observe the production code’s
behavior without the production code knowing it is under test.</p></li>
<li><p>A simple physics model will be developed to describe the
relationship between the battery and the charger.  The testing code will use
this model to confirm that the charger’s behavioral software is working as
designed.  The physics model should be parameterized so that it can test
different battery types.</p></li>
</ul>
<p><strong>Sofware Testing Functional Specification (6)</strong></p>
<p><span class="new-spec">The battery simulation (simple physical model)</span> <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/battery_model_1.py">software</a> <span class="new-spec">is described below:</span></p>
<a class="reference external image-reference" href="_static/battery_model_4.pdf"><img alt="_images/battery_model_4.svg" class="scale-to-fit" src="_images/battery_model_4.svg" /></a>
<p><span class="new-spec">To change how the simulator profiles a given battery type, include two different spread-sheets, the “soc_ocv.csv” and the “ocv_internal_resistance.csv” for the battery you are mimicing.</span></p>
<p><span class="new-spec">An example of the “soc_ocv.csv” can be found</span> <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.csv">here</a> <span class="new-spec">and its</span> <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.py">data plot</a> <span class="new-spec">would look like this:</span></p>
<a class="reference external image-reference" href="_static/battery_profile.pdf"><img alt="_images/battery_profile.svg" class="noscale-center" src="_images/battery_profile.svg" /></a>
<p><span class="new-spec">An example of the “ocv_internal_resistance.csv” can be found</span> <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.csv">here</a>
<span class="new-spec">and its</span> <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.py">data plot</a> <span class="new-spec">would look like this:</span></p>
<a class="reference external image-reference" href="_static/battery_resistance_profile.pdf"><img alt="_images/battery_resistance_profile.svg" class="noscale-center" src="_images/battery_resistance_profile.svg" /></a>
<p><span class="new-spec">To build and run the battery simulator:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">battery</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span>
  <span class="n">rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">initial_soc_per</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lead_acid_battery_100Ah&quot;</span><span class="p">,</span>
  <span class="n">soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
  <span class="n">ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>

<span class="n">hours</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">time_series</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">time_series</span><span class="p">(</span>
  <span class="n">duration_in_sec</span><span class="o">=</span><span class="n">hours</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">time_series</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">battery</span><span class="o">.</span><span class="n">soc_per</span> <span class="o">&lt;</span> <span class="mf">80.0</span><span class="p">:</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">amps_into_terminals</span><span class="p">(</span><span class="mf">33.0</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">abs_volts</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">last_terminal_voltage</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">volts_across_terminals</span><span class="p">(</span><span class="n">abs_volts</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we have a simulator and we have some code we want to test with it.  How do we
bring them together?</p>
<p>Let’s consider our high level goals:</p>
<ul class="simple">
<li><p>to build an environment where we can put our charger into dangerous situations and see how it behaves.</p></li>
<li><p>to test in isolation of our big expensive batteries until we know we won’t destroy them.</p></li>
<li><p>to build an environment where we can make mistakes, where we can feel free to try stuff and see what happens.</p></li>
<li><p>to make a very fast feedback cycle so we can learn quickly and stay engaged with our problem.</p></li>
<li><p>to reduce the tedium of our “show-and-tells” so that our teammates don’t numb out.  We want them mentally “on point” so they can challenge our work.</p></li>
</ul>
<a class="reference external image-reference" href="_static/testing_challenge_1.pdf"><img alt="_images/testing_challenge_1.svg" class="scale-to-fit" src="_images/testing_challenge_1.svg" /></a>
<p>We want to build the system on the right before we build the system on the left.
Currently, it is very difficult to mock out our electrics and time features, so
we will change the production code to make it testable by adding an
<code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> class:</p>
<a class="reference external image-reference" href="_static/testing_challenge_2.pdf"><img alt="_images/testing_challenge_2.svg" class="scale-to-fit" src="_images/testing_challenge_2.svg" /></a>
<p>The <code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> class will act as the driver layer in our real
system.  It will receive constant current and constant voltage control
instructions and it will provide functions to other packages that can be used to
sample the current and the voltage.</p>
<a class="reference external image-reference" href="_static/testing_challenge_3.pdf"><img alt="_images/testing_challenge_3.svg" class="scale-to-fit" src="_images/testing_challenge_3.svg" /></a>
<p>With our new design we can mock-out the charger and the electrical interface
then, connect these mocks to our battery simulator.  Our test code will generate
electrical profile graphs so we can quickly see if our charger is working or
not.</p>
<p>We show our high level test design to our electrical engineer.</p>
<p>He asks, <span class="new-spec">What is a mock?</span></p>
<p>“It’s a way to inject false information into production code so it can be
tested.  We will want to inject false current and voltage.  And we will want to
change the time over which the battery is operating and the tempo at which the
charger is sampling the current and voltage.”</p>
<p><span class="new-spec">Sure, Sure, but how does it work?</span></p>
<p>“We will be programming by difference (inheritance); the <code class="docutils literal notranslate"><span class="pre">ElectricalInterfaceMock</span></code> will
almost be identical to the <code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code>, but it will be changed just
enough so it can use the Battery simulator rather than a real battery.</p>
<p>“The same applies to the <code class="docutils literal notranslate"><span class="pre">ChargerMock</span></code>, but it will only over-write the parts
of the charger that controls the sampling tempo of the charger.”</p>
<p>“Using these mocks, the <code class="docutils literal notranslate"><span class="pre">ChargerTester</span></code> will be able to confirm our charger
works with our simulated battery.  Yet, the production code, (the code we
ship), will not know that it was under test.”</p>
<p><span class="new-spec">What do you mean it won’t know, software doesn’t know anything.</span></p>
<p>“I mean, the software we ship to the customer will be exactly the same for the
software we test using compressed time and fake electrical data.”</p>
<p><span class="new-spec">Let’s see your design</span>:</p>
<p>“First of all this is where you would find the code”:</p>
<a class="reference external image-reference" href="_static/testing_challenge_4.pdf"><img alt="_images/testing_challenge_4.svg" class="scale-to-fit" src="_images/testing_challenge_4.svg" /></a>
<p>“Before I get into the details, I’ll show you how the shippable, <code class="docutils literal notranslate"><span class="pre">Charger</span></code> and
<code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> charts will communicate using published events.”</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_5_statocal.pdf"><img alt="_images/three_stage_charging_chart_5_statocal.svg" class="noscale-center" src="_images/three_stage_charging_chart_5_statocal.svg" /></a>
<p>“You can see the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> can request samplers, and the
<code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> will return functions in the <code class="docutils literal notranslate"><span class="pre">SET_VOLTAGE_SAMPLER</span></code> and
<code class="docutils literal notranslate"><span class="pre">SET_CURRENT_SAMPLER</span></code> events.  The <code class="docutils literal notranslate"><span class="pre">Charger</span></code> can drive the current or the
voltage using <code class="docutils literal notranslate"><span class="pre">DRIVE_CURRENT</span></code> and <code class="docutils literal notranslate"><span class="pre">DRIVE_VOLTAGE</span></code>.</p>
<p>“Now we have a bit of a chicken and an egg problem.  If these two ActiveObjects
are completely independent, then we can’t assume they are started at the same
time.  This means that either active object needs to be able to initiate an
information exchange.  Moreover, we have to make sure we don’t end up with an
infinite oscillation.”</p>
<p><span class="new-spec">Do you need that complexity?  Maybe you should just have something
else start them up and handle their timing?</span></p>
<p>“Yeah, there is a trade off here, I want the use of the objects to be simple,
but it means that their internal design is a bit more complicated, I’ll leave it
in there for now, I can pull it later if it looks too weird.”</p>
<p><span class="new-spec">Walk me through the new charger statechart.</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_5_chart.pdf"><img alt="_images/three_stage_charging_chart_5_chart.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_5_chart.svg" /></a>
<p>“So the charger’s job is to read electrical values then pick which control
system to use and whether we should be charging with a constant current or
voltage approach.”</p>
<p>“Either the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> or the <code class="docutils literal notranslate"><span class="pre">ElectricalInterfaces</span></code> can start first and
initiate a message exchange.  Imagine the <code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> is on, then
the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> turns on.  The <code class="docutils literal notranslate"><span class="pre">Charger</span></code> will publish a
<code class="docutils literal notranslate"><span class="pre">REQUEST_FOR_SAMPLER</span></code>.  The <code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> subscribes to this, and it
will respond by putting the function addresses of the current and voltage
samples into two separate payloads of the <code class="docutils literal notranslate"><span class="pre">SET_CURRENT_SAMPLER</span></code> and
<code class="docutils literal notranslate"><span class="pre">SET_VOLTAGE_SAMPLER</span></code>.  When the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> receives these messages,
it will save the functions and use them to get the electrical readings from then
on.”</p>
<p>“There is a chance that the Charger’s statechart could start before the
<code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code>, which means, that the <code class="docutils literal notranslate"><span class="pre">REQUEST_FOR_SAMPLER</span></code> event was
ignored by the system.  This doesn’t matter, since the <code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code>
will post the <code class="docutils literal notranslate"><span class="pre">SET_CURRENT_SAMPLER</span></code> and <code class="docutils literal notranslate"><span class="pre">SET_VOLTAGE_SAMPLER</span></code> when it
starts, this will turn on the charger.  However, if these events are received
again, they will be caught by hooks in the <code class="docutils literal notranslate"><span class="pre">charging</span></code> state.</p>
<p><span class="new-spec">That is the complexity you added to let either object start at
anytime?</span></p>
<p>You say, “That’s right.”</p>
<p><span class="new-spec">Ok, what else has changed?</span></p>
<p>“As the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> making decisions about what it should do it publishes a
<code class="docutils literal notranslate"><span class="pre">DRIVE_CURRENT</span></code> or <code class="docutils literal notranslate"><span class="pre">DRIVE_VOLTAGE</span></code>.  Inside of these events there will be an
electrical value, a control system, and the time of the request in seconds from
when the charger turned on.</p>
<p>These <code class="docutils literal notranslate"><span class="pre">DRIVE_CURRENT</span></code> and <code class="docutils literal notranslate"><span class="pre">DRIVE_VOLTAGE</span></code> messages will be received by the
<code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code>, and it will do as instructed.</p>
<p>“It’s still pretty much the same design, it has been adjusted to receive its
current and voltage samplers and to drive current or voltage.”  You pause, “But,
you need to take a look at the entry condition of the <code class="docutils literal notranslate"><span class="pre">charging</span></code> state.”</p>
<p><span class="new-spec">Ok, what’s the big deal there?</span></p>
<p>“The <code class="docutils literal notranslate"><span class="pre">Beat</span></code> drives the <code class="docutils literal notranslate"><span class="pre">Ticks</span></code> event.  The <code class="docutils literal notranslate"><span class="pre">Ticks</span></code> event thinks it’s being
driven every <code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code>, but it we drive it faster and the charger doesn’t know.
We will move it out of real time and into compressed time.”</p>
<p><span class="new-spec">What do you mean, “it doesn’t know”?</span></p>
<p>“The charger has all of these “time-outs” in seconds, like the
‘bulk_timeout_sec’ etc.. but, to test the unit we don’t want to change those
numbers to be different from what will ship, and don’t want to sit
around for hours while we are trying to test to see if our code and data work.
So, we hack that one callback and we can speed everything up for testing, but
the production code and the charger parameters look the same as the stuff we
are going to ship”</p>
<p><span class="new-spec">So how do you speed up the beat without changing the code you are
going to ship?</span></p>
<p>“We inherit the <code class="docutils literal notranslate"><span class="pre">Charger</span></code> into the <code class="docutils literal notranslate"><span class="pre">ChargerMock</span></code> then overload that one
callback.  Then test using the <code class="docutils literal notranslate"><span class="pre">ChargerMock</span></code>:”</p>
<a class="reference external image-reference" href="_static/ChargerMock.pdf"><img alt="_images/ChargerMock.svg" class="noscale-center" src="_images/ChargerMock.svg" /></a>
<p>“See how everything is the same, except we add a <code class="docutils literal notranslate"><span class="pre">time_compression_scalar</span></code>.
You can change the beat by changing this number, the charger’s time can be sped
up or slowed down.  But it won’t know, it will think that it is getting a beat
every <code class="docutils literal notranslate"><span class="pre">pulse_sec</span></code>.”</p>
<p><span class="new-spec">That part seems fairly straight forward, let’s see the ElectricalInterface design.</span></p>
<a class="reference external image-reference" href="_static/electrical_interface_5.pdf"><img alt="_images/electrical_interface_5.svg" class="scale-to-fit" src="_images/electrical_interface_5.svg" /></a>
<p>“The <code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> is just that, it will read from our battery’s
electrical values and it will be used to drive the battery current and terminal voltage.”</p>
<p>“When it starts up it sends out the current and voltage sampling functions to
whomever is subscribed.  Then it does nothing unless, it gets a request for the
samplers or instructions to drive the current or the voltage.”</p>
<p>“I have marked up what will be changed by the mocking code.  In production the
<code class="docutils literal notranslate"><span class="pre">drive_current</span></code> and <code class="docutils literal notranslate"><span class="pre">drive_voltage</span></code> functions will be connected to drivers
on the hardware.  But when the unit is under test, this will send information to our
battery simulator.</p>
<p><span class="new-spec">Ok, show me the electical interface mock.</span></p>
<p>“This is a bit more complex:”</p>
<a class="reference external image-reference" href="_static/electrical_interface_5_mock.pdf"><img alt="_images/electrical_interface_5_mock.svg" class="scale-to-fit" src="_images/electrical_interface_5_mock.svg" /></a>
<p>“The <code class="docutils literal notranslate"><span class="pre">ElectricalInterface</span></code> sends functions out to whomever wants to read the
current and the voltage.  I haven’t seen this before, functions inside of
events, but it works and it keeps everything decoupled.    The functions are
sent out as payloads inside of the <code class="docutils literal notranslate"><span class="pre">SET_CURRENT_SAMPLER</span></code> and
<code class="docutils literal notranslate"><span class="pre">SET_VOLTAGE_SAMPLER</span></code>.  If anything else in our system needs a set of samplers
they just have to ask by publishing a <code class="docutils literal notranslate"><span class="pre">REQUEST_FOR_SAMPLER</span></code>.  Our <code class="docutils literal notranslate"><span class="pre">Charger</span></code>
sends this out when it starts up and that is how it gets its drivers. And the
<code class="docutils literal notranslate"><span class="pre">Charger</span></code> doesn’t have to know it’s using a <code class="docutils literal notranslate"><span class="pre">BatterySimulator</span></code>.”</p>
<p>“The electrical interface doesn’t just read values, you can force it to drive
electrical values too.  It will respond to anything sending a <code class="docutils literal notranslate"><span class="pre">DRIVE_VOLTAGE</span></code>
or <code class="docutils literal notranslate"><span class="pre">DRIVE_CURRENT</span></code>.  Inside of these events is the electrical information and
the control system that should be used by the interface.  We aren’t going to use
the control system in this part of the test, because it is up to you to test
that, but know this is how it will be passed around.  If you look at the
<code class="docutils literal notranslate"><span class="pre">drive_current_state</span></code> and the <code class="docutils literal notranslate"><span class="pre">drive_voltage_state</span></code> you will see this is
where we call the battery simulator.  The drive-events will also cause us to
write down data that will be graphed once the test is finished.”</p>
<p><span class="new-spec">How do you make time programmable with this mock?</span></p>
<p>“This is very tricky, because time is being driven by the <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> event which
is started up in the entry condition.  But, this is the important thing to know:
the <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> event won’t actually be sent with the expected tempo, because this
isn’t a real-time system. The <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> event will drift forward in time
every time it is emitted by its sourcing thread.  So the clock of the
<code class="docutils literal notranslate"><span class="pre">ElectricalInterfaceMock</span></code> is sloppy because it is Python running on a native
OS.  When I first designed this part of the system I had the weirdest
time-traveling-bug, the entry conditions of the drive states where using
converted OS time rather than the slipping <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> time frame.  I would ask
the OS for the time, then calculate the equivalent time using the
<code class="docutils literal notranslate"><span class="pre">time_compression_scalar</span></code>, and the battery simulator would go nuts.  My
mistake was I was using two clocks instead of one clock, the OS time was not the
same as the <code class="docutils literal notranslate"><span class="pre">Pulse</span></code> time, it wasn’t slipping forward, so I was accidentally sending
electrical information back in time to the battery simulator when I either drove
the voltage or current.  The bug wrecked my head for a while.”</p>
<p><span class="new-spec">A time traveling bug?  What are you talking about?</span></p>
<p>“I was using two clocks, one which was pretty good and one which was slipping
forward in time.  I needed to just use one clock, so I picked the sloppy one and
the simulator stopped receiving messages from two different time frames and it
started to behave as I was expecting it to behave.”</p>
<p><span class="new-spec">There is a lot going on, show me that high level diagram again.</span></p>
<p>“You mean this one?”</p>
<a class="reference external image-reference" href="_static/testing_challenge_3.pdf"><img alt="_images/testing_challenge_3.svg" class="scale-to-fit" src="_images/testing_challenge_3.svg" /></a>
<p><span class="new-spec">Yeah, how do you run the code, like, how do you get the whole thing
going and what is the output look like?</span></p>
<p>“To start up the charger test you need to provide it with a lot of data, it
would look something like this:”</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">time_compression_scalar</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">simulated_duration_in_hours</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">fake_sec</span> <span class="o">=</span> <span class="n">simulated_duration_in_hours</span> <span class="o">*</span> <span class="mf">3600.0</span>
<span class="n">real_delay_needed_sec</span> <span class="o">=</span> <span class="n">fake_sec</span> <span class="o">/</span> <span class="n">time_compression_scalar</span>

<span class="n">ct</span> <span class="o">=</span> <span class="n">ChargerTester</span><span class="p">(</span>
  <span class="n">charger_bulk_timeout_sec</span><span class="o">=</span><span class="mi">1600</span><span class="p">,</span>
  <span class="n">charger_abs_timeout_sec</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span>
  <span class="n">charger_equ_timeout_sec</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span>
  <span class="n">charger_bulk_entry_volts</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
  <span class="n">charger_bulk_exit_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_abs_exit_amps</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
  <span class="n">charger_bulk_ref_amps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
  <span class="n">charger_float_ref_volts</span><span class="o">=</span><span class="mf">12.9</span><span class="p">,</span>
  <span class="n">charger_abs_ref_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_equ_ref_volts</span><span class="o">=</span><span class="mf">16.0</span><span class="p">,</span>
  <span class="n">battery_rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">battery_initial_soc_per</span><span class="o">=</span><span class="mf">65.0</span><span class="p">,</span>
  <span class="n">battery_soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
  <span class="n">battery_ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
  <span class="n">time_compression_scalar</span><span class="o">=</span><span class="n">time_compression_scalar</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">real_delay_needed_sec</span><span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">electrical_interface_mock</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>
<span class="n">ct</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">()</span>
</pre></div>
</div>
<p>And here is what the result would look like.  It would take about 72 seconds to
run the test:</p>
<a class="reference external image-reference" href="_static/charger_test_results.pdf"><img alt="_images/charger_test_results.svg" class="noscale-center" src="_images/charger_test_results.svg" /></a>
<p><span class="new-spec">Ok, that graph makes sense to me, more so than the rest of it.  You
should pack everything you have done into the spec.</span></p>
</div>
<div class="section" id="spec-7-testing-with-physics-simulation">
<span id="batterychargingexample-spec-7-single-unit-battery-charger"></span><h2>Spec 7: Testing with Physics Simulation<a class="headerlink" href="#spec-7-testing-with-physics-simulation" title="Permalink to this headline">#</a></h2>
<p><strong>High level Specification (7)</strong></p>
<ul class="simple">
<li><p>This product will be a three stage charger with an equalization feature.</p></li>
<li><p>The charger has two control systems: constant current and constant voltage.</p></li>
<li><p>The bulk stage is a constant current control technique.</p></li>
<li><p>The absorption, float and equalization stages are constant voltage control
techniques.</p></li>
</ul>
<p>The charging electrical profile can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<p><strong>Sofware Functional Specification (7)</strong></p>
<ul class="simple">
<li><p>The software system will be broken into two parts, fast running c code and slower running Python code.</p></li>
<li><p>The c code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</p></li>
<li><p>The Python code will determine which control strategy the c code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit.</p></li>
<li><p>The Python code will sample the current and voltage and make decisions every 0.5 seconds</p></li>
<li><p>The Python data architecture can be seen here.</p></li>
</ul>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_5_data.pdf"><img alt="_images/three_stage_charging_chart_5_data.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_5_data.svg" /></a>
<p><span class="new-spec">The Python behavioral architecture will be primarily broken into two parts:</span></p>
<ol class="arabic simple">
<li><p><span class="new-spec">The Charger will sample the battery current and voltage and make decisions about which control system to use.</span></p></li>
<li><p><span class="new-spec">ElectricalInterface will contain the software needed to read and set the current and voltage of the battery:</span></p></li>
</ol>
<p><span class="new-spec">From a high level the Charger and ElectricalInterface will communicate using asychronous messages:</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_5_high.pdf"><img alt="_images/three_stage_charging_chart_5_high.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_5_high.svg" /></a>
<p><span class="new-spec">The ElectricalInterface behavioral architecture can be seen below:</span></p>
<a class="reference external image-reference" href="_static/electrical_interface_5.pdf"><img alt="_images/electrical_interface_5.svg" class="scale-to-fit" src="_images/electrical_interface_5.svg" /></a>
<p><span class="new-spec">The Charger behavioral architecture can be seen below:</span></p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_5_chart.pdf"><img alt="_images/three_stage_charging_chart_5_chart.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_5_chart.svg" /></a>
<p><strong>Software Testing Specification (7)</strong></p>
<ul class="simple">
<li><p>The charger’s data/behavioral software will be adjusted to use data instead of real electrical readings.</p></li>
<li><p>The software that will be shipped (production code) should be
identical to the software that is being tested.  The software testing code
should pass data into the production code and observe the production code’s
behavior without the production code knowing it is under test.</p></li>
<li><p><span class="new-spec">The software tests should occur over tens of seconds and not over
the hours required to test with real batteries.</span></p></li>
<li><p><span class="new-spec">The testing environment should be able to create electrical
conditions which could destroy a real battery.</span></p></li>
<li><p>A simple physics model will be developed to describe the
relationship between the battery and the charger.  The physics model will be
wrapped within software and called the battery simulator.  The testing code will use
this simulator to confirm that the charger’s behavioral software is working as
designed.  The battery simulator should be parameterized so that it can test
different battery types.</p></li>
<li><p><span class="new-spec">Due to the complexity of the battery and charging system
interactions, the output of the test should produce a simple graph which can
quickly be parsed by any engineer on the team.  Here is an example of such a graph:</span></p></li>
</ul>
<a class="reference external image-reference" href="_static/charger_test_results.pdf"><img alt="_images/charger_test_results.svg" class="noscale-center" src="_images/charger_test_results.svg" /></a>
<p><strong>Sofware Testing Functional Specification (7)</strong></p>
<p><span class="new-spec">From a high level the testing architecture can be seen in this diagram:</span></p>
<a class="reference external image-reference" href="_static/testing_challenge_2.pdf"><img alt="_images/testing_challenge_2.svg" class="scale-to-fit" src="_images/testing_challenge_2.svg" /></a>
<p><span class="new-spec">Here is a more detailed description of the testing software architecture:</span></p>
<a class="reference external image-reference" href="_static/testing_challenge_3.pdf"><img alt="_images/testing_challenge_3.svg" class="scale-to-fit" src="_images/testing_challenge_3.svg" /></a>
<p><span class="new-spec">The class-to-file lookup can be seen here:</span></p>
<a class="reference external image-reference" href="_static/testing_challenge_4.pdf"><img alt="_images/testing_challenge_4.svg" class="scale-to-fit" src="_images/testing_challenge_4.svg" /></a>
<p>The battery simulation <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/battery_model_1.py">software</a> is described below:</p>
<a class="reference external image-reference" href="_static/battery_model_4.pdf"><img alt="_images/battery_model_4.svg" class="scale-to-fit" src="_images/battery_model_4.svg" /></a>
<p>To change how the simulator profiles a given battery type, include two different
spread-sheets, the “soc_ocv.csv” and the “ocv_internal_resistance.csv” for the
battery you are mimicing.</p>
<p>An example of the “soc_ocv.csv” can be found <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.csv">here</a> and its <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.py">data plot</a> would look like this:</p>
<a class="reference external image-reference" href="_static/battery_profile.pdf"><img alt="_images/battery_profile.svg" class="noscale-center" src="_images/battery_profile.svg" /></a>
<p>An example of the “ocv_internal_resistance.csv” can be found <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.csv">here</a>
and its <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.py">data plot</a> would look like this:</p>
<a class="reference external image-reference" href="_static/battery_resistance_profile.pdf"><img alt="_images/battery_resistance_profile.svg" class="noscale-center" src="_images/battery_resistance_profile.svg" /></a>
<p>To build and run the battery simulator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">battery</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span>
  <span class="n">rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">initial_soc_per</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lead_acid_battery_100Ah&quot;</span><span class="p">,</span>
  <span class="n">soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
  <span class="n">ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>

<span class="n">hours</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">time_series</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">time_series</span><span class="p">(</span>
  <span class="n">duration_in_sec</span><span class="o">=</span><span class="n">hours</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">time_series</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">battery</span><span class="o">.</span><span class="n">soc_per</span> <span class="o">&lt;</span> <span class="mf">80.0</span><span class="p">:</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">amps_into_terminals</span><span class="p">(</span><span class="mf">33.0</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">abs_volts</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">last_terminal_voltage</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">volts_across_terminals</span><span class="p">(</span><span class="n">abs_volts</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="new-spec">The ChargerMock will contain all of the Charger code but with a
slight adjustment so that the internal clock of the Charger is sped up to
match the tempo of the software test.</span></p>
<a class="reference external image-reference" href="_static/ChargerMock.pdf"><img alt="_images/ChargerMock.svg" class="noscale-center" src="_images/ChargerMock.svg" /></a>
<p><span class="new-spec">The ElectricalInterfaceMock will contain code which will sample
from the battery simulator and drive the current and voltage values to the
battery simulator in the programmable reference-time set by the ChargerTester:</span></p>
<a class="reference external image-reference" href="_static/electrical_interface_5_mock.pdf"><img alt="_images/electrical_interface_5_mock.svg" class="scale-to-fit" src="_images/electrical_interface_5_mock.svg" /></a>
<p><span class="new-spec">The ChargerTester will aggregate the information required to build
and run the charger product and the battery simulator.  It will construct the
ChargerMock and the ElectricalInterfaceMock and run them with the battery
simulation all within the same compressed time reference.  The output of the
charger will be stored in a CSV file, this file will be used to generate a
graph.  Here is an example of how to use the ChargerTester class and
how to graph its output:</span></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">time_compression_scalar</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">simulated_duration_in_hours</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">fake_sec</span> <span class="o">=</span> <span class="n">simulated_duration_in_hours</span> <span class="o">*</span> <span class="mf">3600.0</span>
<span class="n">real_delay_needed_sec</span> <span class="o">=</span> <span class="n">fake_sec</span> <span class="o">/</span> <span class="n">time_compression_scalar</span>

<span class="n">ct</span> <span class="o">=</span> <span class="n">ChargerTester</span><span class="p">(</span>
  <span class="n">charger_bulk_timeout_sec</span><span class="o">=</span><span class="mi">1600</span><span class="p">,</span>
  <span class="n">charger_abs_timeout_sec</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span>
  <span class="n">charger_equ_timeout_sec</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>
  <span class="n">charger_bulk_entry_volts</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
  <span class="n">charger_bulk_exit_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_abs_exit_amps</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
  <span class="n">charger_bulk_ref_amps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
  <span class="n">charger_float_ref_volts</span><span class="o">=</span><span class="mf">12.9</span><span class="p">,</span>
  <span class="n">charger_abs_ref_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_equ_ref_volts</span><span class="o">=</span><span class="mf">16.0</span><span class="p">,</span>
  <span class="n">battery_rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">battery_initial_soc_per</span><span class="o">=</span><span class="mf">65.0</span><span class="p">,</span>
  <span class="n">battery_soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
  <span class="n">battery_ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
  <span class="n">time_compression_scalar</span><span class="o">=</span><span class="n">time_compression_scalar</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">real_delay_needed_sec</span><span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">electrical_interface_mock</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>
<span class="n">ct</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference external image-reference" href="_static/charger_test_results_1.pdf"><img alt="_images/charger_test_results_1.svg" class="noscale-center" src="_images/charger_test_results_1.svg" /></a>
<p>The electrical engineer looks at the output of our test and says, <span class="new-spec">Now we are getting somewhere.</span></p>
<p><span class="new-spec">Are those teal bars describing time outs?</span></p>
<p>“Yes, they mark where the charger settings would have forced a state transition based on time.”</p>
<p><span class="new-spec">We can use the output of this test to describe deficit charging to
our customers.</span></p>
<p>“You might want to explain it to me first.”</p>
<p><span class="new-spec">I’ll explain it with your picture.  Can you adjust your first teal
bar so that its about 50 percent closer to the right.</span></p>
<p>“Sure I just have to change the <code class="docutils literal notranslate"><span class="pre">bulk_timeout_sec</span></code>.”</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">time_compression_scalar</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">simulated_duration_in_hours</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">fake_sec</span> <span class="o">=</span> <span class="n">simulated_duration_in_hours</span> <span class="o">*</span> <span class="mf">3600.0</span>
<span class="n">real_delay_needed_sec</span> <span class="o">=</span> <span class="n">fake_sec</span> <span class="o">/</span> <span class="n">time_compression_scalar</span>

<span class="n">ct</span> <span class="o">=</span> <span class="n">ChargerTester</span><span class="p">(</span>
<span class="hll">  <span class="n">charger_bulk_timeout_sec</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
</span>  <span class="n">charger_abs_timeout_sec</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span>
  <span class="n">charger_equ_timeout_sec</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>
  <span class="n">charger_bulk_entry_volts</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
  <span class="n">charger_bulk_exit_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_abs_exit_amps</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
  <span class="n">charger_bulk_ref_amps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
  <span class="n">charger_float_ref_volts</span><span class="o">=</span><span class="mf">12.9</span><span class="p">,</span>
  <span class="n">charger_abs_ref_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_equ_ref_volts</span><span class="o">=</span><span class="mf">16.0</span><span class="p">,</span>
  <span class="n">battery_rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">battery_initial_soc_per</span><span class="o">=</span><span class="mf">65.0</span><span class="p">,</span>
  <span class="n">battery_soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
  <span class="n">battery_ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
  <span class="n">time_compression_scalar</span><span class="o">=</span><span class="n">time_compression_scalar</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">real_delay_needed_sec</span><span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">electrical_interface_mock</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>
<span class="n">ct</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference external image-reference" href="_static/charger_test_results_2.pdf"><img alt="_images/charger_test_results_2.svg" class="noscale-center" src="_images/charger_test_results_2.svg" /></a>
<p><span class="new-spec">Ok, this is great and by the way I see a bug that tells me you did
things right:  The current being sourced in the absorption stage is above c/3
(33 amps) and above the bulk current.  If we let this go, we could destroy the
batteries.</span></p>
<p>“How will I stop the battery current from going above c/3 while in absorption,
when I have no control over the current while it is in constant voltage control
mode?”</p>
<p><span class="new-spec">It’s good that you have this problem, if you didn’t I wouldn’t trust
your model.  It will be up to me to keep that current below the threshold, but you will
have to tell me what the threshold is. I’ll add current limiting to the control
system.  I’ll use something called a derating.</span></p>
<p>“How does that work?”</p>
<p><span class="new-spec">Remember how I told you that the reference is the goal of the control
system?  While in a constant voltage state you will be giving me a voltage
reference and the control system will drive the terminal voltage to that value.
The problem we see in the picture is that if I do this, the current will be too
high.  Now imagine that I reduce that reference voltage a bit, just before I
fed it into the controller. If I did that, I would output less current right?
If you reduce your reference before sending it into your control system it’s
called derating.  So, if the current is too high, I’ll just drop the reference
voltage until the output current of my controller is just below the current
threshold.</span></p>
<p>“If you do that, won’t the terminal voltage be too low?”</p>
<p><span class="new-spec">Yes, but only for a little while.  As the battery charges, the amount
of current it accepts goes down.  Once the current accepted by the battery
falls below our c/3 limit I will stop derating the voltage reference and the
controller will hold the terminal voltage to the absorption voltage.</span></p>
<p>“I don’t understand, you are going to control the terminal voltage by watching
the current somehow?”</p>
<p><span class="new-spec">Yeah, you will give me a reference voltage, but I will also monitor
other stuff like current and temperature, and before feeding my control system
with the reference voltage, I might reduce its value so that I output a lower
voltage across the terminals.</span></p>
<p>“How are you going to do that exactly?”</p>
<p><span class="new-spec">Well, I’ll have some options to choose from because I’m switching so
fast.  I might put a control system in front of the voltage controller which can
reduce the voltage reference based on current, and another one to reduce the
voltage reference based on temperature.  By the way, don’t worry about
temperature right now. I’ll use a race-to-the-bottom approach, where the lowest
derated reference is chosen and used to drive the voltage.</span></p>
<p>“Ok I guess that makes sense, but how can I possibly model that?  I would have
to have your control systems running within my test loop.”</p>
<p><span class="new-spec">Can you query your battery physics model for the terminal voltage
that would give you a specific current?</span></p>
<p>“I don’t have it right now, but I’m sure I could do that.  My concern is that we
would be adding a lot of fiction into our system’s test model.  Maybe I can
handle this in the charger’s statechart, just move back into a kind of
limbo-bulk stage while the current is too high.”</p>
<p><span class="new-spec">I like your thinking, but this has to be fast, I don’t want the
current going above the c/3 limit, and your code will be running in slow time,
2Hz and not at the 20Khz switching frequency of the control loops.  We can’t mess
around with this.</span></p>
<p>“Ok, so you are suggesting that I adjust my test so that the terminal voltage on
the graphs changes based on a current limit?  You are saying if I talk to the
battery model I can get this data, and your control systems will discover this
same information from the real battery by experimenting against it in real
time?”</p>
<p><span class="new-spec">Exactly, that’s a good way to describe it.  A control system
is actually a set of experiments followed by a small adjustment, done over and
over, to move something toward a goal.  Since my system will be running a lot
faster than yours, you can model this fast code by just asking the battery for
the terminal voltage needed to set the current to c/3.</span></p>
<p><span class="new-spec">Once you have built this into your design we will be in really good
shape to talk about deficit charging and why we need that equalization feature.</span>
He pauses, <span class="new-spec">So go back and find a way to query your physics model to
get what we need.</span></p>
<p><span class="new-spec">Adjust your design so that the constant voltage mode never outputs
more current than your bulk current rating.  You will be able to see if you have
fixed your model by just looking at the graph.</span></p>
<p>“Ok, so you want me to add clamps to the control systems?”</p>
<p>He pauses, <span class="new-spec">I would like two clamps, one for voltage and one for
current.</span></p>
<p>“You said you want the current limited to the bulk reference, what do you want
the voltage limited to.”</p>
<p><span class="new-spec">Limit it to the equalization reference voltage, it should never go
above that.</span></p>
<p>“Just to be clear, you just want the data model to send you clamp
information, and you want my test to behave as if you have built deratings into
your control systems?”</p>
<p><span class="new-spec">That’s all I can think of for now.</span></p>
<hr class="docutils" />
<p>We add the <code class="docutils literal notranslate"><span class="pre">terminal_voltage_for</span></code> to the battery model.  It returns the
“terminal voltage” needed to get a given battery current based on the battery’s
state of charge:</p>
<a class="reference external image-reference" href="_static/battery_model_4.pdf"><img alt="_images/battery_model_4.svg" class="scale-to-fit" src="_images/battery_model_4.svg" /></a>
<p>We refactor our data model and add a <code class="docutils literal notranslate"><span class="pre">voltage_clamp_volts</span></code> and a
<code class="docutils literal notranslate"><span class="pre">current_clamp_amps</span></code> to the <code class="docutils literal notranslate"><span class="pre">ControlSystem</span></code> class.</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_6_data.pdf"><img alt="_images/three_stage_charging_chart_6_data.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_6_data.svg" /></a>
<p>Then we re-work the <code class="docutils literal notranslate"><span class="pre">ElectricalInterfaceMock</span></code> so that while it is in the
<code class="docutils literal notranslate"><span class="pre">drive_voltage_state</span></code> we clamp the voltage reference to limit the current to
the <code class="docutils literal notranslate"><span class="pre">current_clamp_amps</span></code> threshold.</p>
<a class="reference external image-reference" href="_static/electrical_interface_6_mock.pdf"><img alt="_images/electrical_interface_6_mock.svg" class="scale-to-fit" src="_images/electrical_interface_6_mock.svg" /></a>
<p>We re-run the program and see the following:</p>
<a class="reference external image-reference" href="_static/charger_test_results_3.pdf"><img alt="_images/charger_test_results_3.svg" class="noscale-center" src="_images/charger_test_results_3.svg" /></a>
<p>Our electrical engineer looks at it and says, <span class="new-spec">Yeah, that’s how the
control system will regulate the terminal voltage in the absorption state if our
bulk time out is too short.</span>  He pauses, <span class="new-spec">That didn’t take you too
long, I was worried that I sent you a curve ball.</span></p>
<p>“Well, since I’m using statecharts you can make these kinds of behavioral updates
very fast.”</p>
<p>“Now I have another problem, how do I explain this in the spec?”</p>
<p><span class="new-spec">What’s the problem? Just write it down.</span></p>
<p>“I want my spec to make sense to a junior software developer.”</p>
<p><span class="new-spec">I don’t think it’s that big of a deal, if they have questions they can
just talk to us and we can get them up to speed.</span></p>
<p>“But <a class="reference external" href="https://www.youtube.com/watch?v=vtIzMaLkCaM">most documentation isn’t useful</a>, they will just see it as
something else that was written with no intention to be legible to them, so they
won’t bother asking us about it.  Even if they read it and they don’t understand
it, they will think it is their fault, like they are dumb.  They won’t consider
that I am just a bad writer.”</p>
<p>He laughs, <span class="new-spec">Good point, I see this all of the time while wrestling
with Texas Instrument manuals.  Even the TI engineers joke about how they can’t
understand them.  You can ask TI a question on their forum and they have armies
of people from India who pretend to answer your question right away.  Then you get
a real answer from someone in the states but only after it sits there for a
couple of days.  They let their customers write their documents for them, it’s
very frustrating. I don’t bother asking questions on their forums anymore.</span></p>
<p>“That sounds frustrating.  It’s hard to write good documentation though.”</p>
<p>“I had trouble understanding the nuances of this feature and I implemented it.
Adjusting the battery model so the test could just ask it for an answer, to
mimic something your control systems will discover in fast-time through a set of
experiments; that’s clever man.”</p>
<p><span class="new-spec">It’s not a big deal to an analog guy.  We just think that way because
that’s how control systems work.</span></p>
<p><span class="new-spec">Listen, we aren’t technical writers.  They have the tough job but
it’s not our job.  We should write just enough down to draw attention to the
important things in our system.</span></p>
<p>“How are we going to transfer knowledge?”</p>
<p><span class="new-spec">There is a training/brevity trade off.  It
needs to be as short as possible because we are going to change it a lot.
The longer it is, the more expensive it will be from a
non-reoccurring-engineering cost perspective, and you will become burdened with
trying to keep it from lying too much.</span></p>
<p>He pauses, then says, <span class="new-spec">There may be a training/brevity
trade-off, but their is a huge bargain on the side of brevity.  Keep it short
and to the point, use a lot of pictures.</span></p>
<p>He pauses again, <span class="new-spec">Maybe there is no trade off.  We can use the spec as a
training locus later on, when the project has stabilized.  We can take new team
members and walk them through our intentions and show them how we built things.
How to test things.  While we are doing this, we will try to convince them that
we “actually” want them to look at the spec and contribute to it as they change
the system.</span></p>
<p><span class="new-spec">Ok, so work on the spec, when you are done come back and we will look
at deficit charging.</span></p>
</div>
<div class="section" id="spec-8-current-derating-in-constant-voltage-modes">
<span id="batterychargingexample-spec-8-current-derating-in-constant-voltage-modes"></span><h2>Spec 8: Current Derating in Constant Voltage Modes<a class="headerlink" href="#spec-8-current-derating-in-constant-voltage-modes" title="Permalink to this headline">#</a></h2>
<p><strong>High level Specification (8)</strong></p>
<ul class="simple">
<li><p>This product will be a three stage charger with an equalization feature.</p></li>
<li><p>The charger has two control systems: constant current and constant voltage.</p></li>
<li><p>The bulk stage is a constant current control technique.</p></li>
<li><p>The absorption, float and equalization stages are constant voltage control
techniques.</p></li>
</ul>
<p>The charging electrical profile can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_2_graph.pdf"><img alt="_images/three_stage_charging_chart_2_graph.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_2_graph.svg" /></a>
<ul class="simple">
<li><p><span class="new-spec">The maximum charging current will be set to c/3.  This maximum
charging current will typically be used as the bulk current setting.</span></p></li>
<li><p><span class="new-spec">The maximum charging voltage will be set to the equalization voltage.</span></p></li>
</ul>
<p><strong>Sofware Functional Specification (8)</strong></p>
<ul class="simple">
<li><p>The software system will be broken into two parts, fast running c-code and slower running Python code.</p></li>
<li><p>The c-code will run in ISRs at a frequency of 20 Khz and will control the charger in either a constant current or
constant voltage mode. (see separate doc)</p></li>
<li><p>The Python code will determine which control strategy the c-code is
using, it will also set the c code’s control system parameters.  The Python code will not directly control the electrical output of the unit.</p></li>
<li><p>The Python code will sample the current and voltage and make decisions every 0.5 seconds.</p></li>
</ul>
<p>The Python data architecture can be seen here:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_6_data.pdf"><img alt="_images/three_stage_charging_chart_6_data.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_6_data.svg" /></a>
<p>The Python behavioral architecture will be primarily broken into two parts:</p>
<ol class="arabic simple">
<li><p>The Charger will sample the battery current and voltage and make decisions about which control system to use.</p></li>
<li><p>ElectricalInterface will contain the software needed to read and set the current and voltage of the battery:</p></li>
</ol>
<p>From a high level the Charger and ElectricalInterface will
communicate using asychronous messages:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_5_high.pdf"><img alt="_images/three_stage_charging_chart_5_high.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_5_high.svg" /></a>
<p>The ElectricalInterface behavioral architecture can be seen below:</p>
<a class="reference external image-reference" href="_static/electrical_interface_5.pdf"><img alt="_images/electrical_interface_5.svg" class="scale-to-fit" src="_images/electrical_interface_5.svg" /></a>
<p>The Charger behavioral architecture can be seen below:</p>
<a class="reference external image-reference" href="_static/three_stage_charging_chart_5_chart.pdf"><img alt="_images/three_stage_charging_chart_5_chart.svg" class="scale-to-fit" src="_images/three_stage_charging_chart_5_chart.svg" /></a>
<p><strong>Software Testing Specification (8)</strong></p>
<ul class="simple">
<li><p>The charger’s data/behavioral software will be adjusted to use data instead of real electrical readings.</p></li>
<li><p>The software that will be shipped (production code) should be
identical to the software that is being tested.  The software testing code
should pass data into the production code and observe the production code’s
behavior without the production code knowing it is under test.</p></li>
<li><p>The software tests should occur over tens of seconds and not over
the hours required to test with real batteries.</p></li>
<li><p>The testing environment should be able to create electrical
conditions which could destroy a real battery.</p></li>
<li><p>A simple physics model will be developed to describe the
relationship between the battery and the charger.  The physics model will be
wrapped within software and called the battery simulator.  The testing code will use
this simulator to confirm that the charger’s behavioral software is working as
designed.  The battery simulator should be parameterized so that it can test
different battery types.</p></li>
<li><p>Due to the complexity of the battery and charging system
interactions, the output of the test should produce a simple graph which can
quickly be parsed by any engineer on the team.  Here is an example of such a graph:</p></li>
</ul>
<a class="reference external image-reference" href="_static/charger_test_results_1.pdf"><img alt="_images/charger_test_results_1.svg" class="noscale-center" src="_images/charger_test_results_1.svg" /></a>
<p><span class="new-spec">The c-code control systems will contain deratings to limit the
current and the voltage output of the unit.  A derating works by reducing the
reference value before it is fed into a control system so as to reduce the
control system’s output.  Deratings are used to control secondary properties
that the controller might cause to exceed safe values.  For instance, the
constant voltage controller could output a voltage that would cause the
battery current to exceed its maximum current setting.  In such a situation,
the derating would reduce the voltage reference prior to it being fed into the
constant voltage control system, and thereby reduce its driving terminal
voltage, to ensure that the current does not exceed its maximum value.  Below
is a picture of such a dangerous situation.  The charger’s bulk_timeout_sec is
set too low, so the bulk mode doesn’t charge the battery enough before it
enters the absorption mode.  As a result, the current drawn by the battery at
the absorption voltage will exceed the maximum current setting (bulk amps) of
the charger:</span></p>
<a class="reference external image-reference" href="_static/charger_test_results_2.pdf"><img alt="_images/charger_test_results_2.svg" class="noscale-center" src="_images/charger_test_results_2.svg" /></a>
<p><span class="new-spec">To ensure the above scenario does not take place a current derating
is designed into the c-code absorption controller. This current derating reduces the
terminal voltage output goal to limit the output current to the the maximum
current setting.  A graph with such a current derating, while in the
absorption mode (active in the same electrical scenario which caused the previous graph)
would look like this:</span></p>
<a class="reference external image-reference" href="_static/charger_test_results_3.pdf"><img alt="_images/charger_test_results_3.svg" class="noscale-center" src="_images/charger_test_results_3.svg" /></a>
<p><span class="new-spec">The Python testing environment should mimic the current
derating that is present in the constant voltage control modes.  Otherwise the
output graphs will not describe how the charger behaves with a
real battery. (see the ElectricalInterfaceMock functional specification notes
to see how this is implemented)</span></p>
<p><strong>Sofware Testing Functional Specification (8)</strong></p>
<p>From a high level the testing architecture can be seen in this
diagram:</p>
<a class="reference external image-reference" href="_static/testing_challenge_2.pdf"><img alt="_images/testing_challenge_2.svg" class="scale-to-fit" src="_images/testing_challenge_2.svg" /></a>
<p>Here is a more detailed description of the testing software architecture:</p>
<a class="reference external image-reference" href="_static/testing_challenge_3.pdf"><img alt="_images/testing_challenge_3.svg" class="scale-to-fit" src="_images/testing_challenge_3.svg" /></a>
<p>The class-to-file lookup can be seen here:</p>
<a class="reference external image-reference" href="_static/testing_challenge_4.pdf"><img alt="_images/testing_challenge_4.svg" class="scale-to-fit" src="_images/testing_challenge_4.svg" /></a>
<p>The battery simulation <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/battery_model_2.py">software</a>
is described below:</p>
<a class="reference external image-reference" href="_static/battery_model_4.pdf"><img alt="_images/battery_model_4.svg" class="scale-to-fit" src="_images/battery_model_4.svg" /></a>
<p>To change how the simulator profiles a given battery type, include two different
spread-sheets, the “soc_ocv.csv” and the “ocv_internal_resistance.csv” for the
battery you are mimicing.</p>
<p>An example of the “soc_ocv.csv” can be found <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.csv">here</a> and its <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/soc_ocv.py">data plot</a> would look like this:</p>
<a class="reference external image-reference" href="_static/battery_profile.pdf"><img alt="_images/battery_profile.svg" class="noscale-center" src="_images/battery_profile.svg" /></a>
<p>An example of the “ocv_internal_resistance.csv” can be found <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.csv">here</a> and its <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/ocv_internal_resistance.py">data plot</a> would look like this:</p>
<a class="reference external image-reference" href="_static/battery_resistance_profile.pdf"><img alt="_images/battery_resistance_profile.svg" class="noscale-center" src="_images/battery_resistance_profile.svg" /></a>
<p>To build and run the battery simulator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">battery</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span>
  <span class="n">rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">initial_soc_per</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;lead_acid_battery_100Ah&quot;</span><span class="p">,</span>
  <span class="n">soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
  <span class="n">ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>

<span class="n">hours</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">time_series</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">time_series</span><span class="p">(</span>
  <span class="n">duration_in_sec</span><span class="o">=</span><span class="n">hours</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">time_series</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">battery</span><span class="o">.</span><span class="n">soc_per</span> <span class="o">&lt;</span> <span class="mf">80.0</span><span class="p">:</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">amps_into_terminals</span><span class="p">(</span><span class="mf">33.0</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">abs_volts</span> <span class="o">=</span> <span class="n">battery</span><span class="o">.</span><span class="n">last_terminal_voltage</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">battery</span><span class="o">.</span><span class="n">volts_across_terminals</span><span class="p">(</span><span class="n">abs_volts</span><span class="p">,</span> <span class="n">moment</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">battery</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The ChargerMock will contain all of the Charger code but with a slight adjustment so that the internal clock of the Charger is sped up to match the tempo of the software test.</p></li>
</ul>
<a class="reference external image-reference" href="_static/ChargerMock.pdf"><img alt="_images/ChargerMock.svg" class="noscale-center" src="_images/ChargerMock.svg" /></a>
<ul class="simple">
<li><p>The ElectricalInterfaceMock will contain code which will sample
from the battery simulator and drive the current and voltage values to the
battery simulator in the programmable reference-time set by the ChargerTester.</p></li>
<li><p><span class="new-spec">The ElectricalInterfaceMock will mimic the current derating of
the constant voltage controller.  It will do this by querying the battery for
the terminal voltage needed to limit the current to the maximum setting of the
charger.  If this derated terminal voltage is less than the constant voltage
setting provided by the DRIVE_VOLTAGE event, it will use the derated terminal
voltage instead of the voltage sent from the Charger.</span></p></li>
</ul>
<p><span class="new-spec">You can see the ElectricalInterfaceMock below:</span></p>
<a class="reference external image-reference" href="_static/electrical_interface_5_mock.pdf"><img alt="_images/electrical_interface_5_mock.svg" class="scale-to-fit" src="_images/electrical_interface_5_mock.svg" /></a>
<p>The ChargerTester will aggregate the information required to build
and run the charger product and the battery simulator.  It will construct the
ChargerMock and the ElectricalInterfaceMock and run them with the battery
simulation all within the same compressed time reference.  The output of the
charger will be stored in a CSV file, this file will be used to generate a
graph.  Here is an example of how to use the ChargerTester class and
how to graph its output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">time_compression_scalar</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">simulated_duration_in_hours</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">fake_sec</span> <span class="o">=</span> <span class="n">simulated_duration_in_hours</span> <span class="o">*</span> <span class="mf">3600.0</span>
<span class="n">real_delay_needed_sec</span> <span class="o">=</span> <span class="n">fake_sec</span> <span class="o">/</span> <span class="n">time_compression_scalar</span>

<span class="n">ct</span> <span class="o">=</span> <span class="n">ChargerTester</span><span class="p">(</span>
  <span class="n">charger_bulk_timeout_sec</span><span class="o">=</span><span class="mi">1600</span><span class="p">,</span>
  <span class="n">charger_abs_timeout_sec</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span>
  <span class="n">charger_equ_timeout_sec</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>
  <span class="n">charger_bulk_entry_volts</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
  <span class="n">charger_bulk_exit_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_abs_exit_amps</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
  <span class="n">charger_bulk_ref_amps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
  <span class="n">charger_float_ref_volts</span><span class="o">=</span><span class="mf">12.9</span><span class="p">,</span>
  <span class="n">charger_abs_ref_volts</span><span class="o">=</span><span class="mf">13.04</span><span class="p">,</span>
  <span class="n">charger_equ_ref_volts</span><span class="o">=</span><span class="mf">16.0</span><span class="p">,</span>
  <span class="n">battery_rated_amp_hours</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
  <span class="n">battery_initial_soc_per</span><span class="o">=</span><span class="mf">65.0</span><span class="p">,</span>
  <span class="n">battery_soc_vrs_ocv_profile_csv</span><span class="o">=</span><span class="s1">&#39;soc_ocv.csv&#39;</span><span class="p">,</span>
  <span class="n">battery_ocv_vrs_r_profile_csv</span><span class="o">=</span><span class="s1">&#39;ocv_internal_resistance.csv&#39;</span><span class="p">,</span>
  <span class="n">time_compression_scalar</span><span class="o">=</span><span class="n">time_compression_scalar</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">real_delay_needed_sec</span><span class="p">)</span>
<span class="n">ct</span><span class="o">.</span><span class="n">electrical_interface_mock</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>
<span class="n">ct</span><span class="o">.</span><span class="n">plot_profile</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference external image-reference" href="_static/charger_test_results_1.pdf"><img alt="_images/charger_test_results_1.svg" class="noscale-center" src="_images/charger_test_results_1.svg" /></a>
</div>
</div>


        
        <div class="main-content__right-sidebar">
          <h2 class="sidebar-heading">On this page:</h2>
        </div>
      </div>
    </main>

    <div class="footer-wrapper">
      
      <footer class="main-footer main-footer--sidebar">
      
        <div class="relational-links">
          <div>
            
            ← <a class="relational-link" href="othogonalregions.html" title="previous chapter">Orthogonal Regions</a>
            
          </div>
          <div>
            
             <a class="relational-link" href="cellular_automata.html" title="next chapter">Cellular Automata</a> →
            
          </div>
        </div>
        
        <div class="copyright">
          © Copyright <span class="js-year"></span>,
          
          <a href="https://github.com/aleph2c" class="copyright_link">Scott Volk</a>.
          
        </div>
        
        
        <div class="last-updated">
          <span class="prefix">Last updated:</span>
          <span class="time">Jun 24, 2020 8:20 PM</span>
        </div>
        
        
        <div class="created-with">
          Created using <a href="http://sphinx-doc.org/" class="copyright_link">Sphinx</a> 2.4.0 with <span class="theme">13ds_theme_one</span>.
        </div>
        
      </footer>
    </div>
  </body>
</html>