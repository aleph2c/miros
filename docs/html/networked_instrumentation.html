







<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Spy and Trace Across a Network | miros</title>
    <link rel="shortcut icon" href="_static/favicon.ico">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="_static/theme.css" type="text/css">
    
      
    <link rel="stylesheet" type="text/css" href="_static/css/miros_docs.css" />
      
    
    

    
    <script type="text/javascript" src="_static/theme.js" defer></script>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    
    <script src="_static/jquery.js"></script>
    
    <script src="_static/underscore.js"></script>
    
    <script src="_static/doctools.js"></script>
    
    <script src="_static/language_data.js"></script>
    
    

    
      
      
    <link rel="index" title="Index" href="genindex.html">
      
      
    <link rel="search" title="Search" href="search.html">
      
      
      
      
    

    

    

    
  </head>

  <body>
    <header class="main-header">
      <div class="navbar">
        <div id="js-sidebar-mask" class="sidebar-mask"></div>
        <div id="js-sidebar-menu-button" class="sidebar-menu-button">
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg>
        </div>
        <a href="index.html" class="site-link">
          
          miros
          
        </a>
        <div class="navbar-links">
          <a href="installation.html" class="navbar-link">Docs</a>
          
          <a href="https://github.com/aleph2c/miros" class="navbar-link">GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
          
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      
      <div id="js-main-sidebar" class="main-sidebar">
        
        <div class="sidebar-content sidebar-content--divider sidebar-navbar-links">
          <a href="https://github.com/aleph2c/miros" class="sidebar-navbar-link">GitHub</a>
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
        </div>
        
        
        <div class="sidebar-content sidebar-logo">
    <a href="index.html">
      <img class="logo" src="_static/miros_logo.svg" alt="miros" >
    </a>
</div>
        
        

<h2 class="sidebar-heading">Contents</h2>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="zero_to_one.html">Tutorial: Zero to One</a></li>
<li class="toctree-l1"><a class="reference internal" href="reading_diagrams.html">Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="reflection.html">Reflection</a></li>
<li class="toctree-l1"><a class="reference internal" href="patterns.html">Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
</ul>

        
        
<h2 class="sidebar-heading">Useful Links</h2>

<ul>
  <li><a href="https://github.com/aleph2c/py-activeobject">miros on github</a></li>
  <li><a href="https://github.com/aleph2c/sequence">sequence on github</a></li>
  <li><a href="https://aleph2c.github.io/miros-rabbitmq/index.html">miros-rabbitmq plugin</a></li>
  <li><a href="http://www.umlet.com">UMLet Download</a></li>
  <li><a href="http://www.inf.ed.ac.uk/teaching/courses/seoc/2005_2006/resources/statecharts.pdf">formalism explained</a></li>
</ul>


<h2 class="sidebar-heading">For Embedded</h2>

<ul>
  <li><a href="https://state-machine.com/">Quantum Leaps for Embedded</a></li>
  <li><a href="https://github.com/QuantumLeaps/">Quantum Leaps On Github</a></li>
</ul>


<h2 class="sidebar-heading">Statechart Videos</h2>

<ul>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 1 (What)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-why-use-them-2-of-4-90489.html">Part 2 (Why)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 3 (Mealy/Moore)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-harel-state-machines-4-of-4-90491.html">Part 4 (Harel Statecharts)</a></li>
  <li><a href="https://barrgroup.com/Embedded-Systems/How-To/Introduction-Hierarchical-State-Machines">Introduction to HSMs</a></li>
</ul>
        
        

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel" class="sidebar-heading">Quick search</h2>
  <div class="searchformwrapper sidebar-content">
    <form class="search" action="search.html" method="get">
      <input class="sidebar-search sidebar-search--input" type="text" name="q" aria-labelledby="searchlabel"><input class="sidebar-search sidebar-search--btn" type="submit" value="Go">
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

        
      </div>
      

      
      <div class="main-content main-content--sidebar">
      
        
          
  <div class="section" id="spy-and-trace-across-a-network">
<span id="networked-instrumentation-spy-and-trace-across-a-network"></span><h1>Spy and Trace Across a Network<a class="headerlink" href="#spy-and-trace-across-a-network" title="Permalink to this headline">#</a></h1>
<div class="section" id="context">
<span id="networked-instrumentation-context"></span><h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">#</a></h2>
<p>The spy and trace tools are handy for designing, debugging, testing and
documenting the behaviour of your statecharts.</p>
<p>But how would you view the spy and trace information from different statecharts,
running on different computers, across a network?</p>
<p>It would be useful if you could send the spy and trace information from one
machine to another and aggregate it in one location.  This way you could view
the instrumentation results of all of your networked state machines as if they
were running in one place.</p>
<p>In this example, I will run a statechart on one computer, then view its spy and
trace log on another.</p>
</div>
<div class="section" id="getting-the-required-libraries">
<span id="networked-instrumentation-getting-the-required-libraries"></span><h2>Getting the Required Libraries<a class="headerlink" href="#getting-the-required-libraries" title="Permalink to this headline">#</a></h2>
<p>Up until now, I have only been using <code class="docutils literal notranslate"><span class="pre">miros</span></code> and the Python standard library.
To make this example work, you will have to install <code class="docutils literal notranslate"><span class="pre">pika</span></code> for messaging with
<a class="reference internal" href="setting_up_rabbit_mq.html#setting-up-rabbit-mq-setting-up-rabbit-mq"><span class="std std-ref">RabbitMq</span></a> and <code class="docutils literal notranslate"><span class="pre">cryptography</span></code>
for encrypting your messages.  So letâ€™s do that now:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip3 install pika cryptography --user
</pre></div>
</div>
</div>
<div class="section" id="setting-up-and-network-and-messaging">
<span id="networked-instrumentation-setting-up-and-network-and-messaging"></span><h2>Setting Up and Network and Messaging<a class="headerlink" href="#setting-up-and-network-and-messaging" title="Permalink to this headline">#</a></h2>
<p>This example is going to use RabbitMq for messaging. RabbitMq is a robust
messaging platform, but to use it you must first set it up on all of your
computers. I have written how to do that <a class="reference internal" href="setting_up_rabbit_mq.html#setting-up-rabbit-mq-setting-up-rabbit-mq"><span class="std std-ref">here</span></a>.</p>
<p>When I constructed this example, I placed a statechart on a raspberry pi,
running Linux and had it send messages to a program running on a Windows 10
machine. To use the RabbitMq terminology the script running on my raspberry pi
was a producer because it was producing information. The spy and trace
aggregator running on Windows was the consumer since it consumed the messages
generated elsewhere.</p>
<p>To keep things as simple as possible, I wrote a ForeignHsm class which could
accept spy and trace logs. To access these logs, you would use its <code class="docutils literal notranslate"><span class="pre">spy</span></code> and <code class="docutils literal notranslate"><span class="pre">trace</span></code>
methods, just like you would with any other statechart. So the ForeignHsm object
will live on the consumer since it will consume the spy and trace logs generated
by the statechart running on the raspberry pi.</p>
<p>RabbitMq has a variety of different messaging routing techniques. Our
aggregation consumer will want to receive all messages from the foreign
statechart. If I decided to run this consumer in two different threads in
Windows, I would want each of them to see all of the messages generated by the
raspberry pi. For this reason, I used the fanout routing technique offered by
RabbitMq. This fanout technique ensures that every connected consumer sees any
message generated by a producer.</p>
</div>
<div class="section" id="example-design-specification">
<span id="networked-instrumentation-example-design-specification"></span><h2>Example Design Specification<a class="headerlink" href="#example-design-specification" title="Permalink to this headline">#</a></h2>
<p>To begin the example, I will write a specification:</p>
<ul class="simple">
<li><p>A statechart on one machine should have its spy and trace output on another</p></li>
<li><p>All messages should be encrypted while on the network</p></li>
<li><p>A producer can be run multiple times in unison.  If this happens, all
connected consumers should receive all spy and trace information generated by
each of the producers.</p></li>
<li><p>A consumer should be able to be run multiple times in unison.  If this
happens, each consumer should receive all messages generated by each producer
in the network.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you would like to skip the explanations and just look at the code, itâ€™s here:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 31%" />
<col style="width: 43%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>File</p></td>
<td><p>Where I Ran the Code</p></td>
<td><p>Purpose</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/c_trace_producer.py">c_trace_producer</a></p></td>
<td><p>Run on Raspberry Pi</p></td>
<td><p>To produce spy and trace
information from a statemachine
running on a different computer
than the one monitoring it.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/c_trace_consumer.py">c_trace_consumer</a></p></td>
<td><p>Run on Window</p></td>
<td><p>To consume, then aggregate all of
the spy and trace information
being produced by a foreign
statechart, running on a
different machine.</p></td>
</tr>
</tbody>
</table>
</div>
<p>Now letâ€™s try to build something that meets our design goals.</p>
</div>
<div class="section" id="the-producer-design">
<span id="networked-instrumentation-the-producer-design"></span><h2>The Producer Design<a class="headerlink" href="#the-producer-design" title="Permalink to this headline">#</a></h2>
<p>Iâ€™ll start with the producerâ€™s code, letâ€™s call it <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/c_trace_producer.py">c_trace_producer</a> to show
that it is based on the <a class="reference external" href="https://www.rabbitmq.com/tutorials/tutorial-three-python.html">3rd (c) example</a> provided by
the rabbitmq team.  If you havenâ€™t gone through these tutorials, here is a link
to their tutorial and a link to my code that extends their example so that
it works across a network:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 30%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Tutorial Purpose</p></th>
<th class="head"><p>RabbitMQ Pika Tutorial</p></th>
<th class="head"><p>Networked Version of their Tutorial</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><ul class="simple">
<li><p>Publish/Subscribe</p></li>
</ul>
</td>
<td><p><a class="reference external" href="https://www.rabbitmq.com/tutorials/tutorial-three-python.html">simple pub-sub</a></p></td>
<td><ul class="simple">
<li><p><a class="reference external" href="https://github.com/aleph2c/miros/blob/master/experiment/rabbit/c_emit_log_fanout.py">networked pub-sub send</a></p></li>
<li><p><a class="reference external" href="https://github.com/aleph2c/miros/blob/master/experiment/rabbit/c_receive_logs_fanout.py">networked pub-sub receive</a></p></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>If you are feeling comfortable enough with programming RabbitMq with <code class="docutils literal notranslate"><span class="pre">pika</span></code>,
then let us move on and design the producer:</p>
<a class="reference external image-reference" href="_static/rabbit_chart_producer_1.pdf" id="producer-design"><img alt="_images/rabbit_chart_producer_1.svg" class="scale-to-fit" src="_images/rabbit_chart_producer_1.svg" /></a>
<p>Above we see the UML diagram for the RabbitProducer.  It is mostly just a
Factory with some additional attributes to track a rabbitMq connection.</p>
<p>This RabbitProducer class is in the <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/c_trace_producer.py">c_trace_producer</a> file.  It
contains all of the statechart features that a Factory class has and the
additional capability of sending messages across a network.</p>
<p>The RabbitMq messaging strategy is drawn into the diagram as the coloured part.
It will consist of a spy and a trace producer, each transmitting messages into
their exchanges, which will in turn, spit their messages onto the network.</p>
<p>The information that feeds these producers will come from the spy and trace
logs being generated by the statechart as it reacts to events.  We will start
the chart, then send a B signal to it, then turn off the connection.</p>
<p>If we ever intend on building a producer with this technology, we will have to
hide its messages while they are on the big-bad-internet.  For this reason, the
example will also demonstrate a straightforward form of encryption.</p>
<p>Now that we have a design, we will begin to build it by:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#networked-instrumentation-making-a-class-that-can-send-information-on-the-network"><span class="std std-ref">making a class that can send information on the network</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-connect-the-output-of-our-spy-and-trace-logs-to-the-network"><span class="std std-ref">connecting the output of our spy and trace logs to the network</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-create-the-statecharts-hsm"><span class="std std-ref">creating the statechartâ€™s HSM</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-have-our-statechart-reat-to-some-events"><span class="std std-ref">making our statechart react to some events</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-close-the-connection"><span class="std std-ref">closing the connection</span></a></p></li>
</ol>
<div class="section" id="making-a-class-that-can-send-information-on-the-network">
<span id="networked-instrumentation-making-a-class-that-can-send-information-on-the-network"></span><h3>Making a Class that can Send Information on the Network<a class="headerlink" href="#making-a-class-that-can-send-information-on-the-network" title="Permalink to this headline">#</a></h3>
<p id="networked-instrumentation-subsubsection-titl">Letâ€™s begin framing in the RabbitProducer class:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RabbitProducer</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chart_name</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
<span class="hll">    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">chart_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ip</span><span class="p">)</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span> <span class="o">=</span> <span class="n">rabbit_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination_ip</span> <span class="o">=</span> <span class="n">ip</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination_port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>Line 3 shows where we append the consumerâ€™s IP address to the statechart name.</p>
<p>The rest of the code is boiler plate rabbitMq code except for line 14 and 15.
Here we see that we are declaring two separate exchanges, both using the
<cite>fanout</cite> routing strategy.</p>
<p>The <cite>fanout</cite> strategy will ensure that any consumer who is subscribing to one of
these exchanges will get all of its messages.</p>
</div>
<div class="section" id="connect-the-output-of-our-spy-and-trace-logs-to-the-network">
<span id="networked-instrumentation-connect-the-output-of-our-spy-and-trace-logs-to-the-network"></span><h3>Connect the output of our Spy and Trace Logs to the Network<a class="headerlink" href="#connect-the-output-of-our-spy-and-trace-logs-to-the-network" title="Permalink to this headline">#</a></h3>
<p>Now that we have something that can send messages over a network letâ€™s wire it
to the logs emitted by our statechart:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RabbitProducer</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chart_name</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">chart_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ip</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span> <span class="o">=</span> <span class="n">rabbit_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination_ip</span> <span class="o">=</span> <span class="n">ip</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination_port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>

<span class="hll">    <span class="k">def</span> <span class="nf">strip_trace</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span class="hll">      <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span class="hll">      <span class="k">def</span> <span class="nf">_strip_trace</span><span class="p">(</span><span class="n">trace_live</span><span class="p">):</span>
</span><span class="hll">        <span class="n">trace_live</span> <span class="o">=</span> <span class="n">trace_live</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class="hll">        <span class="c1"># encrypt</span>
</span><span class="hll">        <span class="n">fn</span><span class="p">(</span><span class="n">trace_live</span><span class="p">)</span>
</span><span class="hll">      <span class="k">return</span> <span class="n">_strip_trace</span>
</span>
<span class="hll">    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span class="hll">      <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span class="hll">      <span class="k">def</span> <span class="nf">_encrypt</span><span class="p">(</span><span class="n">plain_text</span><span class="p">):</span>
</span><span class="hll">        <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;u3Uc-qAi9iiCv3fkBfRUAKrM1gH8w51-nVU8M8A73Jg=&#39;</span>
</span><span class="hll">        <span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class="hll">        <span class="n">cyphertext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">plain_text</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span><span class="hll">        <span class="c1"># broadcast_trace/broadcast_spy</span>
</span><span class="hll">        <span class="n">fn</span><span class="p">(</span><span class="n">cyphertext</span><span class="p">)</span>
</span><span class="hll">      <span class="k">return</span> <span class="n">_encrypt</span>
</span>
<span class="hll">    <span class="nd">@encrypt</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">broadcast_spy</span><span class="p">(</span><span class="n">spy_live</span><span class="p">):</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
</span><span class="hll">          <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span>
</span><span class="hll">          <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class="hll">          <span class="n">body</span><span class="o">=</span><span class="n">spy_live</span>
</span><span class="hll">      <span class="p">)</span>
</span>
<span class="hll">    <span class="nd">@strip_trace</span>
</span><span class="hll">    <span class="nd">@encrypt</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">broadcast_trace</span><span class="p">(</span><span class="n">trace_live</span><span class="p">):</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
</span><span class="hll">          <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span>
</span><span class="hll">          <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class="hll">          <span class="n">body</span><span class="o">=</span><span class="n">trace_live</span>
</span><span class="hll">      <span class="p">)</span>
</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">broadcast_spy</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">broadcast_trace</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span>   <span class="o">=</span> <span class="kc">True</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="kc">True</span>
</span></pre></div>
</td></tr></table></div>
<p>The newly added code is highlighted.</p>
<p>Iâ€™m going to ask you to look at the new code out of sequence.  Letâ€™s begin with
lines 54 and 55.  Here we see we are turning on the live spy and trace logging
for the statechart.</p>
<p>On lines 52 and 53 we are calling the <code class="docutils literal notranslate"><span class="pre">register_live_spy_callback</span></code> and
<code class="docutils literal notranslate"><span class="pre">register_live_trace_callback</span></code> to allow us to over-write the live spy and
trace behavior.  Instead of just outputting information to a terminal, we send
information into the provided functions.  So for instance, anytime our
statechart emits an item to its spy instrumentation it will send this to the
<code class="docutils literal notranslate"><span class="pre">broadcast_spy</span></code> function instead.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">broadcast_spy</span></code> function is defined within the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method scope
to enclose the <code class="docutils literal notranslate"><span class="pre">self.channel</span></code> object.  I wrote it this way because the
<code class="docutils literal notranslate"><span class="pre">pika</span></code> callback signature only has one argument, the <code class="docutils literal notranslate"><span class="pre">spy_live</span></code> argument.  It doesnâ€™t
accept <code class="docutils literal notranslate"><span class="pre">self</span></code>, and I need access to the <code class="docutils literal notranslate"><span class="pre">self</span></code> attribute to gain access to
the network.  Iâ€™m sure there is a neat way to get around this limitation, but I
didnâ€™t think about it too hard since I knew I could solve the issue with a
closure.</p>
<p>Both the <code class="docutils literal notranslate"><span class="pre">broadcast_spy</span></code> and <code class="docutils literal notranslate"><span class="pre">broadcast_trace</span></code> callback functions can send
strings across the network.  We see these functions are both decorated with
<code class="docutils literal notranslate"><span class="pre">encrypt</span></code>.  This means that before they do their business, their input is sent
to the <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> function defined on line 27.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are two main encryption libraries for Python, one is <code class="docutils literal notranslate"><span class="pre">cryptography</span></code>
and the other is <code class="docutils literal notranslate"><span class="pre">pycrypto</span></code>.  Use <code class="docutils literal notranslate"><span class="pre">cryptography</span></code> since <code class="docutils literal notranslate"><span class="pre">pycrypto</span></code> will
crash on windows.</p>
</div>
<p>Take note of the key, the consumer will have to have the same key, or it will
not be able to make sense of the messages sent to it.</p>
<p>The code is cluttered a bit with the <code class="docutils literal notranslate"><span class="pre">strip_trace</span></code> decorator, which removes
the newline characters for the trace stream.  I left it in the example because
you might want to follow this pattern for sprucing up your messages prior to
sending them out over the network.</p>
</div>
<div class="section" id="create-the-statechart-s-hsm">
<span id="networked-instrumentation-create-the-statecharts-hsm"></span><h3>Create the Statechartâ€™s HSM<a class="headerlink" href="#create-the-statechart-s-hsm" title="Permalink to this headline">#</a></h3>
<p>Now we create a RabbitProducer chart and add a hierarchical state machine to it.
The newly added code is highlighted:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RabbitProducer</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chart_name</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">chart_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ip</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span> <span class="o">=</span> <span class="n">rabbit_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination_ip</span> <span class="o">=</span> <span class="n">ip</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination_port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">credentials</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">strip_trace</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
      <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
      <span class="k">def</span> <span class="nf">_strip_trace</span><span class="p">(</span><span class="n">trace_live</span><span class="p">):</span>
        <span class="n">trace_live</span> <span class="o">=</span> <span class="n">trace_live</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># broadcast_trace</span>
        <span class="n">fn</span><span class="p">(</span><span class="n">trace_live</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">_strip_trace</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
      <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
      <span class="k">def</span> <span class="nf">_encrypt</span><span class="p">(</span><span class="n">plain_text</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;u3Uc-qAi9iiCv3fkBfRUAKrM1gH8w51-nVU8M8A73Jg=&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">cyphertext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">plain_text</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="c1"># broadcast_trace/broadcast_spy</span>
        <span class="n">fn</span><span class="p">(</span><span class="n">cyphertext</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">_encrypt</span>

    <span class="nd">@encrypt</span>
    <span class="k">def</span> <span class="nf">broadcast_spy</span><span class="p">(</span><span class="n">spy_live</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
          <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span>
          <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
          <span class="n">body</span><span class="o">=</span><span class="n">spy_live</span>
      <span class="p">)</span>

    <span class="nd">@strip_trace</span>
    <span class="nd">@encrypt</span>
    <span class="k">def</span> <span class="nf">broadcast_trace</span><span class="p">(</span><span class="n">trace_live</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
          <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span>
          <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
          <span class="n">body</span><span class="o">=</span><span class="n">trace_live</span>
      <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_spy_callback</span><span class="p">(</span><span class="n">broadcast_spy</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">register_live_trace_callback</span><span class="p">(</span><span class="n">broadcast_trace</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span>   <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="kc">True</span>


<span class="hll"><span class="c1">#  +-------- producer_outer ---------+</span>
</span><span class="hll"><span class="c1">#  |   +--- c1 ----+   +---- c2 ---+ |</span>
</span><span class="hll"><span class="c1">#  | * |           |   |           | +--+</span>
</span><span class="hll"><span class="c1">#  | | |           +-A-&gt;           | |  |</span>
</span><span class="hll"><span class="c1">#  | +-&gt;           &lt;-A-+           | |  B</span>
</span><span class="hll"><span class="c1">#  |   |           |   |           | &lt;--+</span>
</span><span class="hll"><span class="c1">#  |   +-----------+   +-----------+ |</span>
</span><span class="hll"><span class="c1">#  +---------------------------------+</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">producer_outer_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span>

<span class="hll"><span class="k">def</span> <span class="nf">producer_outer_B</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">producer_outer</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span>

<span class="hll"><span class="k">def</span> <span class="nf">c1_A</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span>

<span class="hll"><span class="k">def</span> <span class="nf">c2_A</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span><span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span>

<span class="hll"><span class="n">chart</span> <span class="o">=</span> <span class="n">RabbitProducer</span><span class="p">(</span>
</span><span class="hll">  <span class="n">chart_name</span><span class="o">=</span><span class="s2">&quot;producer&quot;</span><span class="p">,</span>
</span><span class="hll">  <span class="n">rabbit_user</span><span class="o">=</span><span class="s2">&quot;bob&quot;</span><span class="p">,</span>
</span><span class="hll">  <span class="n">rabbit_password</span><span class="o">=</span><span class="s2">&quot;dobbs&quot;</span><span class="p">,</span>
</span><span class="hll">  <span class="n">ip</span><span class="o">=</span><span class="s2">&quot;192.168.1.72&quot;</span><span class="p">,</span>
</span><span class="hll">  <span class="n">port</span><span class="o">=</span><span class="mi">5672</span>
</span><span class="hll"><span class="p">)</span>
</span>
<span class="hll"><span class="n">producer_outer</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;producer_outer&#39;</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">producer_outer_init</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">producer_outer_B</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">to_method</span><span class="p">()</span>
</span>
<span class="hll"><span class="n">c1</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">c1_A</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">to_method</span><span class="p">()</span>
</span>
<span class="hll"><span class="n">c2</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;c2&#39;</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">c2_A</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">to_method</span><span class="p">()</span>
</span>
<span class="hll"><span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">producer_outer</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">nest</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">producer_outer</span><span class="p">)</span><span class="o">.</span> \
</span><span class="hll">  <span class="n">nest</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">producer_outer</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>On lines 58-65 we see an ASCII-art version of the statechart we are trying to
build.  On lines 70 through 82 we see the state method callbacks which will be
used to provide their arrows on the diagram.</p>
<p>On lines 85-91, we see that we are constructing a chart which will emit logs to
a foreign consumer.  While building up this object, we provide the credentials
required to dispatch from the local RabbitMq server.</p>
<p>On lines 93-104 we create the state methods, linking callbacks to specific
signal names.</p>
<p>Finally, on lines 106 to 108 we add the chartâ€™s hierarchy, using the <code class="docutils literal notranslate"><span class="pre">nest</span></code>
method.</p>
</div>
<div class="section" id="have-our-statechart-react-to-some-events">
<span id="networked-instrumentation-have-our-statechart-reat-to-some-events"></span><h3>Have our statechart React to some Events<a class="headerlink" href="#have-our-statechart-react-to-some-events" title="Permalink to this headline">#</a></h3>
<p>The full RabbitMq chart has been built and linked to its thread with access to a
rabbitMq server and thereby it has access to the whole internet.</p>
<p>Now it is time to start our chart and watch it change its state.  We will start
it in the producer_outer state, wait, then send a <code class="docutils literal notranslate"><span class="pre">B</span></code> signal to it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># RabbitMq chart construction above</span>
<span class="hll"><span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">producer_outer</span><span class="p">)</span>
</span><span class="hll"><span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
</span><span class="hll"><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span class="hll"><span class="n">pp</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</span><span class="hll"><span class="nb">print</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
</span></pre></div>
</div>
</div>
<div class="section" id="close-the-connection">
<span id="networked-instrumentation-close-the-connection"></span><h3>Close the Connection<a class="headerlink" href="#close-the-connection" title="Permalink to this headline">#</a></h3>
<p>To close our connection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># RabbitMq chart construction above</span>
<span class="c1"># Chart start code and B signal injection above</span>
<span class="hll"><span class="n">chart</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>
</div>
<p>The code to build our designed producer is complete.  Now letâ€™s see its
terminal output on the raspberry pi:</p>
<div class="highlight-guess notranslate" id="producer-output"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s">&#39;START&#39;</span><span class="p">,</span>
 <span class="s">&#39;SEARCH_FOR_SUPER_SIGNAL:producer_outer&#39;</span><span class="p">,</span>
 <span class="s">&#39;ENTRY_SIGNAL:producer_outer&#39;</span><span class="p">,</span>
 <span class="s">&#39;INIT_SIGNAL:producer_outer&#39;</span><span class="p">,</span>
 <span class="s">&#39;SEARCH_FOR_SUPER_SIGNAL:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;ENTRY_SIGNAL:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;INIT_SIGNAL:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">,</span>
 <span class="s">&#39;B:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;B:producer_outer&#39;</span><span class="p">,</span>
 <span class="s">&#39;EXIT_SIGNAL:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;EXIT_SIGNAL:producer_outer&#39;</span><span class="p">,</span>
 <span class="s">&#39;ENTRY_SIGNAL:producer_outer&#39;</span><span class="p">,</span>
 <span class="s">&#39;INIT_SIGNAL:producer_outer&#39;</span><span class="p">,</span>
 <span class="s">&#39;SEARCH_FOR_SUPER_SIGNAL:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;ENTRY_SIGNAL:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;INIT_SIGNAL:c1&#39;</span><span class="p">,</span>
 <span class="s">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="p">]</span>

<span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">10</span> <span class="mi">13</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mf">26.739622</span><span class="p">]</span> <span class="p">[</span><span class="n">producer_192</span><span class="mf">.168.1.72</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">c1</span>
<span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">10</span> <span class="mi">13</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mf">27.024377</span><span class="p">]</span> <span class="p">[</span><span class="n">producer_192</span><span class="mf">.168.1.72</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">B</span><span class="p">()</span> <span class="n">c1</span><span class="o">-&gt;</span><span class="n">c1</span>
</pre></div>
</div>
<p>Comparing this to our <span class="xref std std-ref">producer design</span> we see that it is
the expected spy and trace.  If we ran our trace through sequence we would see:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="k">[ Chart: producer_192.168.1.72 ]</span>
     <span class="na">top          c1</span>
      <span class="na">+start_at()-&gt;|</span>
      <span class="na">|    (1)     |</span>
      <span class="na">|            +</span>
      <span class="na">|             \ (2)</span>
      <span class="na">|             B()</span>
      <span class="na">|             /</span>
      <span class="na">|            &lt;</span>
</pre></div>
</div>
<p>To summarize, we are expecting this trace and spy information to be passed as
individual encrypted messages to a different computer with 192.168.1.72 as an IP
address.</p>
<p>To see the full code example look at <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/c_trace_producer.py">c_trace_producer</a>.</p>
</div>
</div>
<div class="section" id="the-consumer-design">
<span id="networked-instrumentation-the-consumer-design"></span><h2>The Consumer Design<a class="headerlink" href="#the-consumer-design" title="Permalink to this headline">#</a></h2>
<p>The consumer is significantly more straightforward than the producer. It needs
to listen for messages coming in from another node, decrypt them, then output
them onto the screen.</p>
<p>This design will be broken down into:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#networked-instrumentation-report-the-required-libraries"><span class="std std-ref">Importing the required libraries</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-add-the-rabbitmq-boiler-plat-code-and-ability-to-get-ip"><span class="std std-ref">Creating a class with the required rabbitmq boiler plate</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-add-a-shutdown-count-and-a-foreignhsm-object"><span class="std std-ref">Adding a foreign hsm object to collection the spy and trace stream</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-link-our-messages-to-callback-functions"><span class="std std-ref">Linking the network messages to callbacks</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-decrypt-our-messages"><span class="std std-ref">Message decryption</span></a></p></li>
<li><p><a class="reference internal" href="#networked-instrumentation-turn-off-the-network-and-shutdown-the-program"><span class="std std-ref">Stopping the program and turning off the network connection</span></a></p></li>
</ol>
<div class="section" id="import-the-required-libraries">
<span id="networked-instrumentation-report-the-required-libraries"></span><h3>Import the Required Libraries<a class="headerlink" href="#import-the-required-libraries" title="Permalink to this headline">#</a></h3>
<p>To begin with we will import the required libraries:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">miros.foreign</span> <span class="kn">import</span> <span class="n">ForeignHsm</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</pre></div>
</td></tr></table></div>
<p>On line 1 we see that we will be using the <code class="docutils literal notranslate"><span class="pre">pika</span></code> rabbitMq Python library.</p>
<p>Line 3 introduces the ForeignHsm class, which is just an interface around the
spy and trace logs streaming in from another machine.  On line 5 we see we are
calling the Fermet crypto library which we will use for decrypting the messages
coming from the producer.</p>
</div>
<div class="section" id="create-a-class-and-a-drawing-in-its-docstring">
<span id="networked-instrumentation-create-a-class-and-a-drawing-in-its-docstring"></span><h3>Create a Class and a Drawing in its Docstring<a class="headerlink" href="#create-a-class-and-a-drawing-in-its-docstring" title="Permalink to this headline">#</a></h3>
<p>Now we will define a LocalConsumer class which acts as a container of
functionality.  In it, we will draw a picture of our network strategy in its doc
string.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">miros.foreign</span> <span class="kn">import</span> <span class="n">ForeignHsm</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="hll"><span class="k">class</span> <span class="nc">LocalConsumer</span><span class="p">():</span>
</span><span class="hll">  <span class="sd">&#39;&#39;&#39;</span>
</span><span class="hll"><span class="sd">  The Local Consumer looks like this:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">               |---&gt; LocalConsumer spans this part of pic---&gt;|</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">                  +----------------+  +----------------------+</span>
</span><span class="hll"><span class="sd">     +-----+   +-&gt;| spy exchange   +-&gt;| queue (random name)  |</span>
</span><span class="hll"><span class="sd">     |     |   |  +----------------+  +------+---------------+</span>
</span><span class="hll"><span class="sd">     |  p  +--&gt;|                             |</span>
</span><span class="hll"><span class="sd">     |     |   |                             +-&gt; spy_callback</span>
</span><span class="hll"><span class="sd">     +-----+   |  +----------------+  +----------------------+</span>
</span><span class="hll"><span class="sd">               +-&gt;| trace exchange +-&gt;| queue (random name)  |</span>
</span><span class="hll"><span class="sd">                  +----------------+  +------+---------------+</span>
</span><span class="hll"><span class="sd">                                             |</span>
</span><span class="hll"><span class="sd">                                             +-&gt; trace_callback</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">  ``p`` is the producer (statechart emitting spy/trace information) on</span>
</span><span class="hll"><span class="sd">  another machine. (See c_trace_producer.py)</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">  The spy_callback/trace_callback place decrypted spy/trace strings into the</span>
</span><span class="hll"><span class="sd">  foreign_hsm.  This foreign_hsm has the same spy/trace api as a local object</span>
</span><span class="hll"><span class="sd">  from a class which is inherited from the HsmWithQueue.</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">  To build a LocalConsumer:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    local_consumer = LocalConsumer(rabbit_user=&#39;bob&#39;, rabbit_password=&#39;dobbs&#39;)</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">  To start it:</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">    local_consumer.start()</span>
</span><span class="hll">
</span><span class="hll"><span class="sd">  &#39;&#39;&#39;</span>
</span><span class="hll">  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">):</span>
</span><span class="hll">    <span class="k">pass</span>
</span></pre></div>
</td></tr></table></div>
</div>
<div class="section" id="add-the-rabbitmq-boiler-plate-code-and-ability-to-get-ip">
<span id="networked-instrumentation-add-the-rabbitmq-boiler-plat-code-and-ability-to-get-ip"></span><h3>Add the RabbitMq Boiler Plate Code and Ability to get IP<a class="headerlink" href="#add-the-rabbitmq-boiler-plate-code-and-ability-to-get-ip" title="Permalink to this headline">#</a></h3>
<p>Now we fill in the boilerplate RabbitMq code required to build two exchanges,
â€˜spyâ€™ and â€˜trace,â€™ both using a â€˜fanoutâ€™ strategy.  We create two new queues
that will destroy themselves one the program stops running, identify the name of
these queues and bind the exchange to the queue name.</p>
<p>This boilerplate code needs to know the local IP address.  This information is
obtained from the get_ip static method of the LocalConsumer class.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">miros.foreign</span> <span class="kn">import</span> <span class="n">ForeignHsm</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">class</span> <span class="nc">LocalConsumer</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  The Local Consumer looks like this:</span>

<span class="sd">               |---&gt; LocalConsumer spans this part of pic---&gt;|</span>

<span class="sd">                  +----------------+  +----------------------+</span>
<span class="sd">     +-----+   +-&gt;| spy exchange   +-&gt;| queue (random name)  |</span>
<span class="sd">     |     |   |  +----------------+  +------+---------------+</span>
<span class="sd">     |  p  +--&gt;|                             |</span>
<span class="sd">     |     |   |                             +-&gt; spy_callback</span>
<span class="sd">     +-----+   |  +----------------+  +----------------------+</span>
<span class="sd">               +-&gt;| trace exchange +-&gt;| queue (random name)  |</span>
<span class="sd">                  +----------------+  +------+---------------+</span>
<span class="sd">                                             |</span>
<span class="sd">                                             +-&gt; trace_callback</span>

<span class="sd">  ``p`` is the producer (statechart emitting spy/trace information) on</span>
<span class="sd">  another machine. (See c_trace_producer.py)</span>

<span class="sd">  The spy_callback/trace_callback place decrypted spy/trace strings into the</span>
<span class="sd">  foreign_hsm.  This foreign_hsm has the same spy/trace api as a local object</span>
<span class="sd">  from a class which is inherited from the HsmWithQueue.</span>

<span class="sd">  To build a LocalConsumer:</span>

<span class="sd">    local_consumer = LocalConsumer(rabbit_user=&#39;bob&#39;, rabbit_password=&#39;dobbs&#39;)</span>

<span class="sd">  To start it:</span>

<span class="sd">    local_consumer.start()</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">):</span>

    <span class="c1"># rabbit related</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span>     <span class="o">=</span> <span class="n">rabbit_user</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
</span><span class="hll">    <span class="n">credentials</span>          <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
</span><span class="hll">    <span class="n">parameters</span>           <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
</span><span class="hll">                            <span class="n">LocalConsumer</span><span class="o">.</span><span class="n">get_ip</span><span class="p">(),</span>
</span><span class="hll">                            <span class="mi">5672</span><span class="p">,</span>
</span><span class="hll">                            <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span class="hll">                            <span class="n">credentials</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>      <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span>   <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># create new queues, and ensure they destroy themselves when we disconnect</span>
</span><span class="hll">    <span class="c1"># from them</span>
</span><span class="hll">    <span class="n">spy_result</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">    <span class="n">trace_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># queue names are random, so we need to get their names</span>
</span><span class="hll">    <span class="n">spy_queue_name</span>   <span class="o">=</span> <span class="n">spy_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
</span><span class="hll">    <span class="n">trace_queue_name</span> <span class="o">=</span> <span class="n">trace_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># bind the exchanges to each of the queues</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">)</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">)</span>
</span>
<span class="hll"><span class="nd">@staticmethod</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
</span><span class="hll">  <span class="sd">&#39;&#39;&#39;LocalConsumer.get_ip()&#39;&#39;&#39;</span>
</span><span class="hll">  <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class="hll">  <span class="n">s</span>  <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span><span class="hll">  <span class="k">try</span><span class="p">:</span>
</span><span class="hll">    <span class="c1"># doesn&#39;t have to be reachable</span>
</span><span class="hll">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;10.255.255.255&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span class="hll">    <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="hll">  <span class="k">finally</span><span class="p">:</span>
</span><span class="hll">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">ip</span>
</span></pre></div>
</td></tr></table></div>
</div>
<div class="section" id="add-a-shutdown-count-and-a-foreignhsm-object">
<span id="networked-instrumentation-add-a-shutdown-count-and-a-foreignhsm-object"></span><h3>Add a Shutdown Count and a ForeignHsm Object<a class="headerlink" href="#add-a-shutdown-count-and-a-foreignhsm-object" title="Permalink to this headline">#</a></h3>
<p>We need a way to shut down the program, so we will add a count that we can
compare against.  We will use this count later.</p>
<p>A foreign_hsm will be added, which will consume the spy and trace messages
emitted from the producer on the raspberry pi.  This foreign_hsm object will
have the same <code class="docutils literal notranslate"><span class="pre">spy</span></code> and <code class="docutils literal notranslate"><span class="pre">trace</span></code> methods of any other miros spy/trace
supported object.  However, if you look inside of the object, there is no event
processor it is just a store of information with an interface that looks like a
statechart object.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">miros.foreign</span> <span class="kn">import</span> <span class="n">ForeignHsm</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">class</span> <span class="nc">LocalConsumer</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  The Local Consumer looks like this:</span>

<span class="sd">               |---&gt; LocalConsumer spans this part of pic---&gt;|</span>

<span class="sd">                  +----------------+  +----------------------+</span>
<span class="sd">     +-----+   +-&gt;| spy exchange   +-&gt;| queue (random name)  |</span>
<span class="sd">     |     |   |  +----------------+  +------+---------------+</span>
<span class="sd">     |  p  +--&gt;|                             |</span>
<span class="sd">     |     |   |                             +-&gt; spy_callback</span>
<span class="sd">     +-----+   |  +----------------+  +----------------------+</span>
<span class="sd">               +-&gt;| trace exchange +-&gt;| queue (random name)  |</span>
<span class="sd">                  +----------------+  +------+---------------+</span>
<span class="sd">                                             |</span>
<span class="sd">                                             +-&gt; trace_callback</span>

<span class="sd">  ``p`` is the producer (statechart emitting spy/trace information) on</span>
<span class="sd">  another machine. (See c_trace_producer.py)</span>

<span class="sd">  The spy_callback/trace_callback place decrypted spy/trace strings into the</span>
<span class="sd">  foreign_hsm.  This foreign_hsm has the same spy/trace api as a local object</span>
<span class="sd">  from a class which is inherited from the HsmWithQueue.</span>

<span class="sd">  To build a LocalConsumer:</span>

<span class="sd">    local_consumer = LocalConsumer(rabbit_user=&#39;bob&#39;, rabbit_password=&#39;dobbs&#39;)</span>

<span class="sd">  To start it:</span>

<span class="sd">    local_consumer.start()</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">):</span>

    <span class="c1"># rabbit related</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span>     <span class="o">=</span> <span class="n">rabbit_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
    <span class="n">credentials</span>          <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
    <span class="n">parameters</span>           <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
                            <span class="n">LocalConsumer</span><span class="o">.</span><span class="n">get_ip</span><span class="p">(),</span>
                            <span class="mi">5672</span><span class="p">,</span>
                            <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                            <span class="n">credentials</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>      <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span>   <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>

    <span class="c1"># create new queues, and ensure they destroy themselves when we disconnect</span>
    <span class="c1"># from them</span>
    <span class="n">spy_result</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trace_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># queue names are random, so we need to get their names</span>
    <span class="n">spy_queue_name</span>   <span class="o">=</span> <span class="n">spy_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
    <span class="n">trace_queue_name</span> <span class="o">=</span> <span class="n">trace_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>

    <span class="c1"># bind the exchanges to each of the queues</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">)</span>

<span class="hll">    <span class="c1"># keep a count so we can exit the program</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="hll">    <span class="c1"># make a ForeignHsm to track activity on another machine</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span> <span class="o">=</span> <span class="n">ForeignHsm</span><span class="p">()</span>
</span>
<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;LocalConsumer.get_ip()&#39;&#39;&#39;</span>
  <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
  <span class="n">s</span>  <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="c1"># doesn&#39;t have to be reachable</span>
    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;10.255.255.255&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">ip</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="link-our-messages-to-callback-functions">
<span id="networked-instrumentation-link-our-messages-to-callback-functions"></span><h3>Link our Messages to Callback Functions<a class="headerlink" href="#link-our-messages-to-callback-functions" title="Permalink to this headline">#</a></h3>
<p>Now we need to link the messages coming from the live spy and live trace on the
raspberry pi to a set of callbacks that do something interesting with this
information, like print it to the terminal of my windows box.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">miros.foreign</span> <span class="kn">import</span> <span class="n">ForeignHsm</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">class</span> <span class="nc">LocalConsumer</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  The Local Consumer looks like this:</span>

<span class="sd">               |---&gt; LocalConsumer spans this part of pic---&gt;|</span>

<span class="sd">                  +----------------+  +----------------------+</span>
<span class="sd">     +-----+   +-&gt;| spy exchange   +-&gt;| queue (random name)  |</span>
<span class="sd">     |     |   |  +----------------+  +------+---------------+</span>
<span class="sd">     |  p  +--&gt;|                             |</span>
<span class="sd">     |     |   |                             +-&gt; spy_callback</span>
<span class="sd">     +-----+   |  +----------------+  +----------------------+</span>
<span class="sd">               +-&gt;| trace exchange +-&gt;| queue (random name)  |</span>
<span class="sd">                  +----------------+  +------+---------------+</span>
<span class="sd">                                             |</span>
<span class="sd">                                             +-&gt; trace_callback</span>

<span class="sd">  ``p`` is the producer (statechart emitting spy/trace information) on</span>
<span class="sd">  another machine. (See c_trace_producer.py)</span>

<span class="sd">  The spy_callback/trace_callback place decrypted spy/trace strings into the</span>
<span class="sd">  foreign_hsm.  This foreign_hsm has the same spy/trace api as a local object</span>
<span class="sd">  from a class which is inherited from the HsmWithQueue.</span>

<span class="sd">  To build a LocalConsumer:</span>

<span class="sd">    local_consumer = LocalConsumer(rabbit_user=&#39;bob&#39;, rabbit_password=&#39;dobbs&#39;)</span>

<span class="sd">  To start it:</span>

<span class="sd">    local_consumer.start()</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">):</span>

    <span class="c1"># rabbit related</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span>     <span class="o">=</span> <span class="n">rabbit_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
    <span class="n">credentials</span>          <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
    <span class="n">parameters</span>           <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
                            <span class="n">LocalConsumer</span><span class="o">.</span><span class="n">get_ip</span><span class="p">(),</span>
                            <span class="mi">5672</span><span class="p">,</span>
                            <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                            <span class="n">credentials</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>      <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span>   <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>

    <span class="c1"># create new queues, and ensure they destroy themselves when we disconnect</span>
    <span class="c1"># from them</span>
    <span class="n">spy_result</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trace_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># queue names are random, so we need to get their names</span>
    <span class="n">spy_queue_name</span>   <span class="o">=</span> <span class="n">spy_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
    <span class="n">trace_queue_name</span> <span class="o">=</span> <span class="n">trace_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>

    <span class="c1"># bind the exchanges to each of the queues</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">)</span>

    <span class="c1"># keep a count so we can exit the program</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># make a ForeignHsm to track activity on another machine</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span> <span class="o">=</span> <span class="n">ForeignHsm</span><span class="p">()</span>


<span class="hll">    <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
</span><span class="hll">      <span class="sd">&#39;&#39;&#39;create a spy_callback function received messages in the queue&#39;&#39;&#39;</span>
</span><span class="hll">      <span class="n">foreign_spy_item</span> <span class="o">=</span> <span class="n">body</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">append_to_spy</span><span class="p">(</span><span class="n">foreign_spy_item</span><span class="p">)</span>
</span><span class="hll">      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Spy: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">foreign_spy_item</span><span class="p">))</span>
</span>
<span class="hll">    <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
</span><span class="hll">      <span class="sd">&#39;&#39;&#39;create a trace_callback function received messages in the queue&#39;&#39;&#39;</span>
</span><span class="hll">      <span class="n">foreign_trace_item</span> <span class="o">=</span> <span class="n">body</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">append_to_trace</span><span class="p">(</span><span class="n">foreign_trace_item</span><span class="p">)</span>
</span><span class="hll">      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Trace: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">foreign_trace_item</span><span class="p">))</span>
</span>
<span class="hll">    <span class="c1"># register the spy_callback and trace_callback with a queue</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">spy_callback</span><span class="p">,</span>
</span><span class="hll">        <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">,</span>
</span><span class="hll">        <span class="n">no_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">trace_callback</span><span class="p">,</span>
</span><span class="hll">        <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">,</span>
</span><span class="hll">        <span class="n">no_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span>
<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;LocalConsumer.get_ip()&#39;&#39;&#39;</span>
  <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
  <span class="n">s</span>  <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="c1"># doesn&#39;t have to be reachable</span>
    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;10.255.255.255&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">ip</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="decrypt-our-messages">
<span id="networked-instrumentation-decrypt-our-messages"></span><h3>Decrypt our Messages<a class="headerlink" href="#decrypt-our-messages" title="Permalink to this headline">#</a></h3>
<p>But wait, the messages are encrypted, right?  So if we donâ€™t adjust our code, we
will just print a nonsensical set of strings coming from the raspberry piâ€™s
statechart.  We need to decrypt the messages.  To do this, we will decorate the
callback function with a static decrypt method.</p>
<p>Finally, we will need to build an object of the class and run the code:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">miros.foreign</span> <span class="kn">import</span> <span class="n">ForeignHsm</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">class</span> <span class="nc">LocalConsumer</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  The Local Consumer looks like this:</span>

<span class="sd">               |---&gt; LocalConsumer spans this part of pic---&gt;|</span>

<span class="sd">                  +----------------+  +----------------------+</span>
<span class="sd">     +-----+   +-&gt;| spy exchange   +-&gt;| queue (random name)  |</span>
<span class="sd">     |     |   |  +----------------+  +------+---------------+</span>
<span class="sd">     |  p  +--&gt;|                             |</span>
<span class="sd">     |     |   |                             +-&gt; spy_callback</span>
<span class="sd">     +-----+   |  +----------------+  +----------------------+</span>
<span class="sd">               +-&gt;| trace exchange +-&gt;| queue (random name)  |</span>
<span class="sd">                  +----------------+  +------+---------------+</span>
<span class="sd">                                             |</span>
<span class="sd">                                             +-&gt; trace_callback</span>

<span class="sd">  ``p`` is the producer (statechart emitting spy/trace information) on</span>
<span class="sd">  another machine. (See c_trace_producer.py)</span>

<span class="sd">  The spy_callback/trace_callback place decrypted spy/trace strings into the</span>
<span class="sd">  foreign_hsm.  This foreign_hsm has the same spy/trace api as a local object</span>
<span class="sd">  from a class which is inherited from the HsmWithQueue.</span>

<span class="sd">  To build a LocalConsumer:</span>

<span class="sd">    local_consumer = LocalConsumer(rabbit_user=&#39;bob&#39;, rabbit_password=&#39;dobbs&#39;)</span>

<span class="sd">  To start it:</span>

<span class="sd">    local_consumer.start()</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">):</span>

    <span class="c1"># rabbit related</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span>     <span class="o">=</span> <span class="n">rabbit_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
    <span class="n">credentials</span>          <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
    <span class="n">parameters</span>           <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
                            <span class="n">LocalConsumer</span><span class="o">.</span><span class="n">get_ip</span><span class="p">(),</span>
                            <span class="mi">5672</span><span class="p">,</span>
                            <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                            <span class="n">credentials</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>      <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span>   <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>

    <span class="c1"># create new queues, and ensure they destroy themselves when we disconnect</span>
    <span class="c1"># from them</span>
    <span class="n">spy_result</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trace_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># queue names are random, so we need to get their names</span>
    <span class="n">spy_queue_name</span>   <span class="o">=</span> <span class="n">spy_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
    <span class="n">trace_queue_name</span> <span class="o">=</span> <span class="n">trace_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>

    <span class="c1"># bind the exchanges to each of the queues</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">)</span>

    <span class="c1"># keep a count so we can exit the program</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># make a ForeignHsm to track activity on another machine</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span> <span class="o">=</span> <span class="n">ForeignHsm</span><span class="p">()</span>

<span class="hll">    <span class="nd">@LocalConsumer</span><span class="o">.</span><span class="n">decrypt</span>
</span>    <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;create a spy_callback function received messages in the queue&#39;&#39;&#39;</span>
      <span class="n">foreign_spy_item</span> <span class="o">=</span> <span class="n">body</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">append_to_spy</span><span class="p">(</span><span class="n">foreign_spy_item</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Spy: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">foreign_spy_item</span><span class="p">))</span>

<span class="hll">    <span class="nd">@LocalConsumer</span><span class="o">.</span><span class="n">decrypt</span>
</span>    <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;create a trace_callback function received messages in the queue&#39;&#39;&#39;</span>
      <span class="n">foreign_trace_item</span> <span class="o">=</span> <span class="n">body</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">append_to_trace</span><span class="p">(</span><span class="n">foreign_trace_item</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Trace: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">foreign_trace_item</span><span class="p">))</span>

    <span class="c1"># register the spy_callback and trace_callback with a queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">spy_callback</span><span class="p">,</span>   <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">,</span>   <span class="n">no_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">trace_callback</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;LocalConsumer.get_ip()&#39;&#39;&#39;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
    <span class="n">s</span>  <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># doesn&#39;t have to be reachable</span>
      <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;10.255.255.255&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
      <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ip</span>

<span class="hll">  <span class="nd">@staticmethod</span>
</span><span class="hll">  <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span class="hll">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">_decrypt</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">cyphertext</span><span class="p">):</span>
</span><span class="hll">      <span class="sd">&#39;&#39;&#39;LocalConsumer.decrypt()&#39;&#39;&#39;</span>
</span><span class="hll">      <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;u3Uc-qAi9iiCv3fkBfRUAKrM1gH8w51-nVU8M8A73Jg=&#39;</span>
</span><span class="hll">      <span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class="hll">      <span class="n">plain_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cyphertext</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span><span class="hll">      <span class="n">fn</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">plain_text</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">_decrypt</span>
</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">local_consumer</span> <span class="o">=</span> <span class="n">LocalConsumer</span><span class="p">(</span><span class="n">rabbit_user</span><span class="o">=</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="o">=</span><span class="s1">&#39;dobbs&#39;</span><span class="p">)</span>
  <span class="n">local_consumer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="turn-off-the-network-and-shutdown-the-program">
<span id="networked-instrumentation-turn-off-the-network-and-shutdown-the-program"></span><h3>Turn off the Network and Shutdown the Program<a class="headerlink" href="#turn-off-the-network-and-shutdown-the-program" title="Permalink to this headline">#</a></h3>
<p>So, itâ€™s mostly working, but how do we stop it?  When asked about this on stack
overflow the <code class="docutils literal notranslate"><span class="pre">pika</span></code> maintainer recommended a timeout callback that can call
the <code class="docutils literal notranslate"><span class="pre">stop_consuming</span></code> method of the channel class.  So we will add a callback
that has a timer, references our count and can resubscribe itself if it is too
soon to quit.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">miros.foreign</span> <span class="kn">import</span> <span class="n">ForeignHsm</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">pp</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">class</span> <span class="nc">LocalConsumer</span><span class="p">():</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  The Local Consumer looks like this:</span>

<span class="sd">               |---&gt; LocalConsumer spans this part of pic---&gt;|</span>

<span class="sd">                  +----------------+  +----------------------+</span>
<span class="sd">     +-----+   +-&gt;| spy exchange   +-&gt;| queue (random name)  |</span>
<span class="sd">     |     |   |  +----------------+  +------+---------------+</span>
<span class="sd">     |  p  +--&gt;|                             |</span>
<span class="sd">     |     |   |                             +-&gt; spy_callback</span>
<span class="sd">     +-----+   |  +----------------+  +----------------------+</span>
<span class="sd">               +-&gt;| trace exchange +-&gt;| queue (random name)  |</span>
<span class="sd">                  +----------------+  +------+---------------+</span>
<span class="sd">                                             |</span>
<span class="sd">                                             +-&gt; trace_callback</span>

<span class="sd">  ``p`` is the producer (statechart emitting spy/trace information) on</span>
<span class="sd">  another machine. (See c_trace_producer.py)</span>

<span class="sd">  The spy_callback/trace_callback place decrypted spy/trace strings into the</span>
<span class="sd">  foreign_hsm.  This foreign_hsm has the same spy/trace api as a local object</span>
<span class="sd">  from a class which is inherited from the HsmWithQueue.</span>

<span class="sd">  To build a LocalConsumer:</span>

<span class="sd">    local_consumer = LocalConsumer(rabbit_user=&#39;bob&#39;, rabbit_password=&#39;dobbs&#39;)</span>

<span class="sd">  To start it:</span>

<span class="sd">    local_consumer.start()</span>

<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">):</span>

    <span class="c1"># rabbit related</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_user</span>     <span class="o">=</span> <span class="n">rabbit_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rabbit_password</span> <span class="o">=</span> <span class="n">rabbit_password</span>
    <span class="n">credentials</span>          <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">rabbit_user</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="p">)</span>
    <span class="n">parameters</span>           <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
                            <span class="n">LocalConsumer</span><span class="o">.</span><span class="n">get_ip</span><span class="p">(),</span>
                            <span class="mi">5672</span><span class="p">,</span>
                            <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                            <span class="n">credentials</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>      <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span>   <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;fanout&#39;</span><span class="p">)</span>

    <span class="c1"># create new queues, and ensure they destroy themselves when we disconnect</span>
    <span class="c1"># from them</span>
    <span class="n">spy_result</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trace_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># queue names are random, so we need to get their names</span>
    <span class="n">spy_queue_name</span>   <span class="o">=</span> <span class="n">spy_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
    <span class="n">trace_queue_name</span> <span class="o">=</span> <span class="n">trace_result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>

    <span class="c1"># bind the exchanges to each of the queues</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;spy&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">)</span>

    <span class="c1"># keep a count so we can exit the program</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># make a ForeignHsm to track activity on another machine</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span> <span class="o">=</span> <span class="n">ForeignHsm</span><span class="p">()</span>

    <span class="nd">@LocalConsumer</span><span class="o">.</span><span class="n">decrypt</span>
    <span class="k">def</span> <span class="nf">spy_callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;create a spy_callback function received messages in the queue&#39;&#39;&#39;</span>
      <span class="n">foreign_spy_item</span> <span class="o">=</span> <span class="n">body</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">append_to_spy</span><span class="p">(</span><span class="n">foreign_spy_item</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Spy: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">foreign_spy_item</span><span class="p">))</span>

    <span class="nd">@LocalConsumer</span><span class="o">.</span><span class="n">decrypt</span>
    <span class="k">def</span> <span class="nf">trace_callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;create a trace_callback function received messages in the queue&#39;&#39;&#39;</span>
      <span class="n">foreign_trace_item</span> <span class="o">=</span> <span class="n">body</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">append_to_trace</span><span class="p">(</span><span class="n">foreign_trace_item</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; [x] Trace: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">foreign_trace_item</span><span class="p">))</span>

<span class="hll">    <span class="k">def</span> <span class="nf">timeout_callback</span><span class="p">():</span>
</span><span class="hll">      <span class="sd">&#39;&#39;&#39;callback for outputting the foreign trace and exiting the program&#39;&#39;&#39;</span>
</span><span class="hll">      <span class="n">spy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">spy</span><span class="p">()</span>
</span><span class="hll">      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spy</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="hll">        <span class="n">pp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">spy</span><span class="p">())</span>
</span><span class="hll">        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="hll">      <span class="c1"># stop processing or reconnect this callback to a timer</span>
</span><span class="hll">      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">stop_consuming</span><span class="p">()</span>
</span><span class="hll">      <span class="k">else</span><span class="p">:</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">deadline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">callback_method</span><span class="o">=</span><span class="n">timeout_callback</span><span class="p">)</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">clear_spy</span><span class="p">()</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">foreign_hsm</span><span class="o">.</span><span class="n">clear_trace</span><span class="p">()</span>
</span>
<span class="hll">    <span class="c1"># Add the timeout callback</span>
</span><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">deadline</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">callback_method</span><span class="o">=</span><span class="n">timeout_callback</span><span class="p">)</span>
</span>
    <span class="c1"># register the spy_callback and trace_callback with a queue</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">spy_callback</span><span class="p">,</span>   <span class="n">queue</span><span class="o">=</span><span class="n">spy_queue_name</span><span class="p">,</span>   <span class="n">no_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">trace_callback</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">trace_queue_name</span><span class="p">,</span> <span class="n">no_ack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;LocalConsumer.get_ip()&#39;&#39;&#39;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
    <span class="n">s</span>  <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># doesn&#39;t have to be reachable</span>
      <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;10.255.255.255&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
      <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ip</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_decrypt</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">cyphertext</span><span class="p">):</span>
      <span class="sd">&#39;&#39;&#39;LocalConsumer.decrypt()&#39;&#39;&#39;</span>
      <span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;u3Uc-qAi9iiCv3fkBfRUAKrM1gH8w51-nVU8M8A73Jg=&#39;</span>
      <span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
      <span class="n">plain_text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cyphertext</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
      <span class="n">fn</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">plain_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_decrypt</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">local_consumer</span> <span class="o">=</span> <span class="n">LocalConsumer</span><span class="p">(</span><span class="n">rabbit_user</span><span class="o">=</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="n">rabbit_password</span><span class="o">=</span><span class="s1">&#39;dobbs&#39;</span><span class="p">)</span>
  <span class="n">local_consumer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>Closing a program like this seems somewhat clumsy.  In the future, we will call
the <code class="docutils literal notranslate"><span class="pre">stop_consuming</span></code> method from within a statechart based on a statechart.</p>
<p>So there you have it, a full consumer.  Letâ€™s run it and the producer and see
what happens.</p>
<p>The consumer outputs:</p>
<div class="highlight-guess notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span> [x] Trace: [2018-01-10 18:23:35.647035] [rabbit_producer_192.168.1.72] e-&gt;start_at() top-&gt;c1
 [x] Spy: START
 [x] Spy: SEARCH_FOR_SUPER_SIGNAL:producer_outer
 [x] Spy: ENTRY_SIGNAL:producer_outer
 [x] Spy: INIT_SIGNAL:producer_outer
 [x] Spy: SEARCH_FOR_SUPER_SIGNAL:c1
 [x] Spy: ENTRY_SIGNAL:c1
 [x] Spy: INIT_SIGNAL:c1
 [x] Spy: &lt;- Queued:(0) Deferred:(0)
 [x] Trace: [2018-01-10 18:23:35.932470] [rabbit_producer_192.168.1.72] e-&gt;B() c1-&gt;c1
 [x] Spy: B:c1
 [x] Spy: B:producer_outer
 [x] Spy: EXIT_SIGNAL:c1
 [x] Spy: EXIT_SIGNAL:producer_outer
 [x] Spy: ENTRY_SIGNAL:producer_outer
 [x] Spy: INIT_SIGNAL:producer_outer
 [x] Spy: SEARCH_FOR_SUPER_SIGNAL:c1
 [x] Spy: ENTRY_SIGNAL:c1
 [x] Spy: INIT_SIGNAL:c1
 [x] Spy: &lt;- Queued:(0) Deferred:(0)
[&#39;START&#39;,
 &#39;SEARCH_FOR_SUPER_SIGNAL:producer_outer&#39;,
 &#39;ENTRY_SIGNAL:producer_outer&#39;,
 &#39;INIT_SIGNAL:producer_outer&#39;,
 &#39;SEARCH_FOR_SUPER_SIGNAL:c1&#39;,
 &#39;ENTRY_SIGNAL:c1&#39;,
 &#39;INIT_SIGNAL:c1&#39;,
 &#39;&lt;- Queued:(0) Deferred:(0)&#39;,
 &#39;B:c1&#39;,
 &#39;B:producer_outer&#39;,
 &#39;EXIT_SIGNAL:c1&#39;,
 &#39;EXIT_SIGNAL:producer_outer&#39;,
 &#39;ENTRY_SIGNAL:producer_outer&#39;,
 &#39;INIT_SIGNAL:producer_outer&#39;,
 &#39;SEARCH_FOR_SUPER_SIGNAL:c1&#39;,
 &#39;ENTRY_SIGNAL:c1&#39;,
 &#39;INIT_SIGNAL:c1&#39;,
 &#39;&lt;- Queued:(0) Deferred:(0)&#39;]
[2018-01-10 18:23:35.647035] [rabbit_producer_192.168.1.72] e-&gt;start_at() top-&gt;c1
[2018-01-10 18:23:35.932470] [rabbit_producer_192.168.1.72] e-&gt;B() c1-&gt;c1
</pre></div>
</td></tr></table></div>
<p>So we see that the decryption worked and the live spy and traced messages were
being emitted onto the screen as they were received from the network.  We also
see that the foreign_hsm objectâ€™s <code class="docutils literal notranslate"><span class="pre">spy</span></code> and <code class="docutils literal notranslate"><span class="pre">trace</span></code> methods output
instrumentation results as if they were coming from a real statechart running on
this machine.</p>
<p>To see the full consumer code, reference this <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/c_trace_consumer.py">c_trace_consumer</a>.</p>
<p>We have succeeded in aggregating spy and trace messages generated on one machine
within another.</p>
<p><a class="reference internal" href="examples.html#examples"><span class="std std-ref">back to examples</span></a></p>
</div>
</div>
</div>


        
        <div class="main-content__right-sidebar">
          <h2 class="sidebar-heading">On this page:</h2>
        </div>
      </div>
    </main>

    <div class="footer-wrapper">
      
      <footer class="main-footer main-footer--sidebar">
      
        <div class="relational-links">
          <div>
            
          </div>
          <div>
            
          </div>
        </div>
        
        <div class="copyright">
          Â© Copyright <span class="js-year"></span>,
          
          <a href="https://github.com/aleph2c" class="copyright_link">Scott Volk</a>.
          
        </div>
        
        
        <div class="last-updated">
          <span class="prefix">Last updated:</span>
          <span class="time">Nov 03, 2020 8:22 AM</span>
        </div>
        
        
        <div class="created-with">
          Created using <a href="http://sphinx-doc.org/" class="copyright_link">Sphinx</a> 3.3.0 with <span class="theme">13ds_theme_one</span>.
        </div>
        
      </footer>
    </div>
  </body>
</html>