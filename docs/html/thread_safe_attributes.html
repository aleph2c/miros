







<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Thread Safe Attributes | miros</title>
    <link rel="shortcut icon" href="_static/favicon.ico">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="_static/theme.css" type="text/css">
    
      
    <link rel="stylesheet" type="text/css" href="_static/css/miros_docs.css" />
      
    
    

    
    <script type="text/javascript" src="_static/theme.js" defer></script>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    
    <script src="_static/jquery.js"></script>
    
    <script src="_static/underscore.js"></script>
    
    <script src="_static/doctools.js"></script>
    
    <script src="_static/language_data.js"></script>
    
    

    
      
      
    <link rel="index" title="Index" href="genindex.html">
      
      
    <link rel="search" title="Search" href="search.html">
      
      
      
    <link rel="next" title="Hacking to Learn" href="scribbleexample.html">
      
      
    <link rel="prev" title="Comprehensive" href="comprehensive.html">
      
    

    

    

    
  </head>

  <body>
    <header class="main-header">
      <div class="navbar">
        <div id="js-sidebar-mask" class="sidebar-mask"></div>
        <div id="js-sidebar-menu-button" class="sidebar-menu-button">
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg>
        </div>
        <a href="index.html" class="site-link">
          
          miros
          
        </a>
        <div class="navbar-links">
          <a href="installation.html" class="navbar-link">Docs</a>
          
          <a href="https://github.com/aleph2c/miros" class="navbar-link">GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
          
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      
      <div id="js-main-sidebar" class="main-sidebar">
        
        <div class="sidebar-content sidebar-content--divider sidebar-navbar-links">
          <a href="https://github.com/aleph2c/miros" class="sidebar-navbar-link">GitHub</a>
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
        </div>
        
        
        <div class="sidebar-content sidebar-logo">
    <a href="index.html">
      <img class="logo" src="_static/miros_logo.svg" alt="miros" >
    </a>
</div>
        
        

<h2 class="sidebar-heading">Contents</h2>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="zero_to_one.html">Tutorial: Zero to One</a></li>
<li class="toctree-l1"><a class="reference internal" href="reading_diagrams.html">Diagrams</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="comprehensive.html">Comprehensive</a></li>
<li class="toctree-l2"><a class="reference internal" href="comprehensive.html#comprehensive-with-instrumentation">Comprehensive with Instrumentation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Thread Safe Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="scribbleexample.html">Hacking to Learn</a></li>
<li class="toctree-l2"><a class="reference internal" href="interactingcharts.html">Interacting Statecharts (Same Machine)</a></li>
<li class="toctree-l2"><a class="reference internal" href="towardsthefactoryexample.html">Using and Unwinding a Factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="othogonalregions.html">Orthogonal Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="batterychargingexample.html">Distributed Battery Charging</a></li>
<li class="toctree-l2"><a class="reference internal" href="cellular_automata.html">Cellular Automata</a></li>
<li class="toctree-l2"><a class="reference internal" href="i_mongol_example.html">Mongol Horse Archer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="reflection.html">Reflection</a></li>
<li class="toctree-l1"><a class="reference internal" href="patterns.html">Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
</ul>

        
        
<h2 class="sidebar-heading">Useful Links</h2>

<ul>
  <li><a href="https://github.com/aleph2c/py-activeobject">miros on github</a></li>
  <li><a href="https://github.com/aleph2c/sequence">sequence on github</a></li>
  <li><a href="https://aleph2c.github.io/miros-rabbitmq/index.html">miros-rabbitmq plugin</a></li>
  <li><a href="http://www.umlet.com">UMLet Download</a></li>
  <li><a href="http://www.inf.ed.ac.uk/teaching/courses/seoc/2005_2006/resources/statecharts.pdf">formalism explained</a></li>
</ul>


<h2 class="sidebar-heading">For Embedded</h2>

<ul>
  <li><a href="https://state-machine.com/">Quantum Leaps for Embedded</a></li>
  <li><a href="https://github.com/QuantumLeaps/">Quantum Leaps On Github</a></li>
</ul>


<h2 class="sidebar-heading">Statechart Videos</h2>

<ul>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 1 (What)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-why-use-them-2-of-4-90489.html">Part 2 (Why)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 3 (Mealy/Moore)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-harel-state-machines-4-of-4-90491.html">Part 4 (Harel Statecharts)</a></li>
  <li><a href="https://barrgroup.com/Embedded-Systems/How-To/Introduction-Hierarchical-State-Machines">Introduction to HSMs</a></li>
</ul>
        
        

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel" class="sidebar-heading">Quick search</h2>
  <div class="searchformwrapper sidebar-content">
    <form class="search" action="search.html" method="get">
      <input class="sidebar-search sidebar-search--input" type="text" name="q" aria-labelledby="searchlabel"><input class="sidebar-search sidebar-search--btn" type="submit" value="Go">
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

        
      </div>
      

      
      <div class="main-content main-content--sidebar">
      
        
          
  <blockquote class="epigraph">
<div><p>The best is the enemy of the good.</p>
<p class="attribution">—Voltaire</p>
</div></blockquote>
<div class="section" id="thread-safe-attributes">
<span id="thread-safe-attributes-thread-safe-attributes"></span><h1>Thread Safe Attributes<a class="headerlink" href="#thread-safe-attributes" title="Permalink to this headline">#</a></h1>
<p>If you use a miros statechart, your program is <a class="reference external" href="http://www.laurentluce.com/posts/python-threads-synchronization-locks-rlocks-semaphores-conditions-events-and-queues/">multi-threaded</a>.</p>
<p>Sometimes, you will want to access an attribute of your statechart from another
thread, like the main part of your program.  When you do this, you are trying to
access memory that could be changed in one thread while it is being read in by
another thread.</p>
<p>To see why this is an issue imagine using a calculator to solve a simple math
problem: calculate the value of <code class="docutils literal notranslate"><span class="pre">b</span></code>, starting with <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">0.35</span></code>, given the
following equation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.45</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">a</span><span class="o">^</span><span class="mf">1.2</span>
</pre></div>
</div>
<p>Seems simple enough.  Suppose you pick a straight-forward strategy:</p>
<ul class="simple">
<li><p>mark down the value of <code class="docutils literal notranslate"><span class="pre">a</span></code> on a piece of paper so you can reference it as you work</p></li>
<li><p>break the calculation into <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">*</span> <span class="pre">cos(0.45)</span></code> and <code class="docutils literal notranslate"><span class="pre">3*a*1.2</span></code></p></li>
<li><p>then add these results together to find <code class="docutils literal notranslate"><span class="pre">b</span></code></p></li>
</ul>
<p>But while calculated the <code class="docutils literal notranslate"><span class="pre">a*cos(0.45)</span></code> part of the problem, someone grabs your
paper, changes your temporary value of <code class="docutils literal notranslate"><span class="pre">a</span></code> to <code class="docutils literal notranslate"><span class="pre">0.3</span></code>, then puts it back on
your desk.  You don’t notice it.  When you get to the <code class="docutils literal notranslate"><span class="pre">3*a^1.2</span></code> part of the
calculation, you use the wrong <code class="docutils literal notranslate"><span class="pre">a</span></code> value, so you get the wrong answer for <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p>
<p>This is called a <strong>race condition</strong>.  Here our <code class="docutils literal notranslate"><span class="pre">a</span></code> variable was shared between
two threads, you and the other person.  When you program with multiple
concurrent processes/threads and you share memory, you are exposed to this kind
of problem.</p>
<p>A simple way to avoid such a situation is to not share the temporary paper in
the first place.  Do not use shared attributes.</p>
<p>Another way to deal with it is to have one thread change a shared attribute and
have the other thread read the shared attribute.  But, this will require that
maintenance developers understand there are hidden rules in your codebase;
they could innocently change something an introduce extremely subtle bugs.</p>
<p>Typically, shared variables are protected using thread locks.  A lock is a flag
which works across multiple threads.  You can lock the object for reading and
writing while you use it.  In our example, we would lock <code class="docutils literal notranslate"><span class="pre">a</span></code> in its <code class="docutils literal notranslate"><span class="pre">0.35</span></code>
state while calculating both sub-parts of our problem then unlock it when we are
done.  The other process would wait until the thread-lock cleared, then
they would change the value of <code class="docutils literal notranslate"><span class="pre">a</span></code> to <code class="docutils literal notranslate"><span class="pre">0.3</span></code> and do their own work.  So,
there is a cost, you block one thread while waiting for the other to work, and
you have to share lock variables across all of your threads.  It is easy to
screw this up, and it is tough to test for race conditions.</p>
<p>But why is it hard to test for race conditions?  As of Python 3, a thread will
run for 15 milliseconds before Python passes control to another thread.  Most of
the time, the common memory that is used by both threads will work as you expect
it will.  Infrequently a thread switch will occur midway through a non-atomic
operation, where some shared value is to be changed by the other
thread.  After this unlikely event, your thread will re-gain control and finish
its calculation producing the wrong answer.</p>
<p>These kinds of bugs are more probabilistic in nature, than deterministic;
Python’s access to the system clock is jittery.  The timing between two Python
threads will never be the same for every two runs of the program (it’s like
playing a slot machine) so, it will be hard for you to reproduce your issue.</p>
<p>The miros library accepts that people will want to access a statechart’s
internal attributes from the outside.  Significant efforts have been made to
make this kind of activity easy for you to do in a “thread-safe” manner.  The
<code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class was constructed to eat the complexity of making
thread-safe attributes by wrapping “getting” (use of the <code class="docutils literal notranslate"><span class="pre">.</span></code>) and “setting”
operations (use of the <code class="docutils literal notranslate"><span class="pre">=</span></code>) within thread-safe locks.  In addition to this, the
non-atomic <code class="docutils literal notranslate"><span class="pre">+=</span></code>, <code class="docutils literal notranslate"><span class="pre">-=</span></code> … <code class="docutils literal notranslate"><span class="pre">//=</span></code> statements using thread-safe attributes were
also wrapped within locks.  For more complex situations, the
thread-safety features provided by the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class can be
used to get the thread lock explicitly.</p>
<p>I will introduce these ideas gradually through a set of examples.  Let’s
begin by looking at four interacting threads (possible race conditions are
highlighted):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span> <span class="k">as</span> <span class="n">ThreadEvent</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ThreadSafeAttributes</span>

<span class="k">class</span> <span class="nc">GetLock1</span><span class="p">(</span><span class="n">ThreadSafeAttributes</span><span class="p">):</span>
  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;thread_safe_attr_1&#39;</span><span class="p">]</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running in main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">thread_method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running in th1 thread&#39;&#39;&#39;</span>
    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
<span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="hll">      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th1: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe_attr_1</span><span class="p">)</span>
</span>      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GetLock2</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running in main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span> <span class="o">=</span> <span class="n">gl1</span>

  <span class="k">def</span> <span class="nf">thread_method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running in th1 thread&#39;&#39;&#39;</span>
    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
<span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="hll">      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th2: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span><span class="p">)</span>
</span>      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ThreadKiller</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running in main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span> <span class="o">=</span> <span class="n">count_down</span>

  <span class="k">def</span> <span class="nf">thread_stopper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running in killer thread&#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="c1"># main thread:</span>
<span class="n">evt</span> <span class="o">=</span> <span class="n">ThreadEvent</span><span class="p">()</span>
<span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

<span class="n">gl1</span> <span class="o">=</span> <span class="n">GetLock1</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
<span class="n">gl2</span> <span class="o">=</span> <span class="n">GetLock2</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="o">=</span><span class="n">gl1</span><span class="p">)</span>
<span class="n">killer</span> <span class="o">=</span> <span class="n">ThreadKiller</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_method_1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th1&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl2</span><span class="o">.</span><span class="n">thread_method_2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th2&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
  <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">thread_stopper</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">killer</span><span class="o">.</span><span class="n">thread_stopper</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;killer&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/thread_safe_attributes_1.py">download the above code here</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GetLock1</span></code> class inherits from the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class, which
uses a metaclass to give it access to the following syntax (seen on line 8 of
the above example):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;thread_safe_attr_1&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class tries to protect you.  When we write the
<code class="docutils literal notranslate"><span class="pre">_attributes</span> <span class="pre">=</span> <span class="pre">['thread_safe_attr_1']</span></code> syntax, <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> creates
a set of hidden attributes, which are wrapped inside of a <a class="reference external" href="https://docs.python.org/3.6/howto/descriptor.html">descriptor protocol</a> (think &#64;property).  One of
the hidden attributes, <code class="docutils literal notranslate"><span class="pre">_lock</span></code> is a <a class="reference external" href="https://docs.python.org/3.5/library/threading.html#rlock-objects">threading.RLock</a>.  It is
used to lock and unlock itself around accesses to the other hidden attribute
<cite>_value</cite>.  Essentially this means that this code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span>
<span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>… would turn into something like this before it is run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gl1</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
 <span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span>

<span class="k">with</span> <span class="n">gl1</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
 <span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A lot of Python libraries provide features to change simple syntax into more
complex and specific syntax prior to having it run.  If this library was
written in c, this kind of work would be done inside of a macro, and the
preprocessor would create custom c-code before it was compiled into an
executable.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class also tries to protect your code from race
conditions introduced by non-atomic <code class="docutils literal notranslate"><span class="pre">+=</span></code> statements acting on shared
attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>When using the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class the above code turns into something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gl1</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
  <span class="n">temp</span> <span class="o">=</span> <span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span>
  <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="n">temp</span>
</pre></div>
</div>
<p>So the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class protects calls to the
seemingly-innocuous-looking, yet dangerous, <code class="docutils literal notranslate"><span class="pre">+=</span></code>, <code class="docutils literal notranslate"><span class="pre">-=</span></code>, … <code class="docutils literal notranslate"><span class="pre">//=</span></code> family of
Python calls.  They are dangerous because they are not-atomic and can cause race
conditions if they are applied to attributes shared across threads.</p>
<p>So our example, written without the <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class, but with the
same protections would look like this (shared attributes protections
highlighted):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">place</span> <span class="n">code</span> <span class="n">here</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">RLock</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span> <span class="k">as</span> <span class="n">ThreadEvent</span>

<span class="k">class</span> <span class="nc">GetLock1</span><span class="p">():</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">_rlock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
</span>    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">thread_method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within th1 thread&#39;&#39;&#39;</span>
    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
<span class="hll">      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rlock</span><span class="p">:</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="hll">      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rlock</span><span class="p">:</span>
</span><span class="hll">        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th1: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe_attr_1</span><span class="p">)</span>
</span>      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GetLock2</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span> <span class="o">=</span> <span class="n">gl1</span>

  <span class="k">def</span> <span class="nf">thread_method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within th2 thread&#39;&#39;&#39;</span>
    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
<span class="hll">      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">_rlock</span><span class="p">:</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="hll">      <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">_rlock</span><span class="p">:</span>
</span><span class="hll">        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th2: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_safe_attr_1</span><span class="p">)</span>
</span>      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ThreadKiller</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span> <span class="o">=</span> <span class="n">count_down</span>

  <span class="k">def</span> <span class="nf">thread_stopper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within killer thread&#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">evt</span> <span class="o">=</span> <span class="n">ThreadEvent</span><span class="p">()</span>
<span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

<span class="n">gl1</span> <span class="o">=</span> <span class="n">GetLock1</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
<span class="n">gl2</span> <span class="o">=</span> <span class="n">GetLock2</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="o">=</span><span class="n">gl1</span><span class="p">)</span>
<span class="n">killer</span> <span class="o">=</span> <span class="n">ThreadKiller</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_method_1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th1&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl2</span><span class="o">.</span><span class="n">thread_method_2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th2&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
  <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">thread_stopper</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">killer</span><span class="o">.</span><span class="n">thread_stopper</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stopper&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/thread_safe_attributes_2.py">download the above code here</a>.</p>
</div>
<p>We haven’t looked at any code results yet. Let’s run it and see what it does:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">$python</span> thread_safe_attributes_2.py
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
th2:  -1
th1:  <span class="m">0</span>
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
</pre></div>
</div>
<p>We see that the number oscillates about 0.  If we remove the time delays at the
bottom of the thread functions, you will see wild oscillation in this number,
since one thread by chance will get many more opportunities to run.  So you can
see that it might be hard to reproduce precisely two identical traces of the
program output.</p>
<p>Ok, now for something scary, let’s look at our code without thread-locks (the
race conditions are highlighted):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span> <span class="k">as</span> <span class="n">ThreadEvent</span>

<span class="k">class</span> <span class="nc">GetLock1</span><span class="p">():</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">thread_race_attr_1</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">thread_method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within th1 thread&#39;&#39;&#39;</span>
    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
<span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">thread_race_attr_1</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="hll">      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th1: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_race_attr_1</span><span class="p">)</span>
</span>      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GetLock2</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span> <span class="o">=</span> <span class="n">gl1</span>

  <span class="k">def</span> <span class="nf">thread_method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within th2 thread&#39;&#39;&#39;</span>
    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
<span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_race_attr_1</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class="hll">      <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th2: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_race_attr_1</span><span class="p">)</span>
</span>      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ThreadKiller</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span> <span class="o">=</span> <span class="n">count_down</span>

  <span class="k">def</span> <span class="nf">thread_stopper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within killer thread&#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">evt</span> <span class="o">=</span> <span class="n">ThreadEvent</span><span class="p">()</span>
<span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

<span class="n">gl1</span> <span class="o">=</span> <span class="n">GetLock1</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
<span class="n">gl2</span> <span class="o">=</span> <span class="n">GetLock2</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="o">=</span><span class="n">gl1</span><span class="p">)</span>
<span class="n">killer</span> <span class="o">=</span> <span class="n">ThreadKiller</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_method_1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th1&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl2</span><span class="o">.</span><span class="n">thread_method_2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th2&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
  <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">thread_stopper</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">killer</span><span class="o">.</span><span class="n">thread_stopper</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stopper&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/thread_safe_attributes_3_unsafe.py">download the above code here</a>.</p>
</div>
<p>I changed the <code class="docutils literal notranslate"><span class="pre">thread_safe_attr_1</span></code> name to <code class="docutils literal notranslate"><span class="pre">thread_race_attr_1</span></code> to make a
point.  The highlighted code shows where race conditions can occur.  If we run
the code we see:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python thread_safe_attributes_3_unsafe.py
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
th2:  -1
th1:  <span class="m">0</span>
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
th1:  <span class="m">1</span>
th2:  <span class="m">0</span>
</pre></div>
</div>
<p>Which looks almost exactly the same as the last run.  Race conditions are very
hard to find.</p>
<p>Let’s move back to our original example, suppose we absolutely needed
to run calculations on the <code class="docutils literal notranslate"><span class="pre">thread_safe_attr_1</span></code> in more than one thread (which
I can’t see the need for).  I’ll change the name of <code class="docutils literal notranslate"><span class="pre">thread_safe_attr_1</span></code> to
<code class="docutils literal notranslate"><span class="pre">a</span></code>. The <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> class can not implicitly protect you in such
situations, but what it can do is give you the lock and you can use it to
protect your own code (highlighting how to get the lock):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span> <span class="k">as</span> <span class="n">ThreadEvent</span>

<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">ThreadSafeAttributes</span>

<span class="k">class</span> <span class="nc">GetLock1</span><span class="p">(</span><span class="n">ThreadSafeAttributes</span><span class="p">):</span>
  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">thread_method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within th1 thread&#39;&#39;&#39;</span>
<span class="hll">    <span class="n">_</span><span class="p">,</span> <span class="n">_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
</span>    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
      <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.35</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.45</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">**</span> <span class="mf">1.2</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th1: &quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GetLock2</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span> <span class="o">=</span> <span class="n">gl1</span>

  <span class="k">def</span> <span class="nf">thread_method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within th2 thread&#39;&#39;&#39;</span>
<span class="hll">    <span class="n">_</span><span class="p">,</span> <span class="n">_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">a</span>
</span>    <span class="k">while</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">is_set</span><span class="p">()):</span>
      <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.30</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.45</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">a</span> <span class="o">**</span> <span class="mf">1.2</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;th2: &quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.020</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ThreadKiller</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within main thread&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evt</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span> <span class="o">=</span> <span class="n">count_down</span>

  <span class="k">def</span> <span class="nf">thread_stopper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;running within killer thread&#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kill_time</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evt</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="c1"># main thread:</span>
<span class="n">evt</span> <span class="o">=</span> <span class="n">ThreadEvent</span><span class="p">()</span>
<span class="n">evt</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

<span class="n">gl1</span> <span class="o">=</span> <span class="n">GetLock1</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
<span class="n">gl2</span> <span class="o">=</span> <span class="n">GetLock2</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">gl1</span><span class="o">=</span><span class="n">gl1</span><span class="p">)</span>
<span class="n">killer</span> <span class="o">=</span> <span class="n">ThreadKiller</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">count_down</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl1</span><span class="o">.</span><span class="n">thread_method_1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th1&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>
<span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">gl2</span><span class="o">.</span><span class="n">thread_method_2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;th2&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()))</span>

<span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
  <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">thread_stopper</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">killer</span><span class="o">.</span><span class="n">thread_stopper</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stopper&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">thread_stopper</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can <a class="reference external" href="https://github.com/aleph2c/miros/blob/master/examples/thread_safe_attributes_4.py">download the above code here</a>.</p>
</div>
<p>The lock can be obtained by calling <code class="docutils literal notranslate"><span class="pre">_,</span> <span class="pre">_lock</span> <span class="pre">=</span> <span class="pre">&lt;thread_safe_attribute&gt;</span></code>.</p>
<p>This nasty little piece of metaprogramming could baffle a beginner or anyone who
looks at the thread safe attribute:  Most of the time your thread-safe attribute
acts as an attribute, but other times it acts as an iterable, what is going on?
It only acts as an iterable when proceeded by <code class="docutils literal notranslate"><span class="pre">_,</span> <span class="pre">_lock</span></code>.  <strong>If you use this
technique in one of your threads, you must also explicitly get the lock in all
other threads that share the attribute.</strong></p>
<p>This lock-access feature was added for difficult situations, where the client
code absolutely needs the lock, maybe for advanced database calls or that kind
of thing.</p>
<p><strong>I recommend against explicitely getting a lock</strong> and performing calculations
directly on your shared attributes.</p>
<p>Instead, copy their contents into a local variable (automatically locked) ,
perform a calculation using local variables, then assign the results back into
the shared attribute (automatically locked).</p>
<p>In our example, we don’t need to use shared attribute at all, so we shouldn’t.
The example was arbitrary, a better way to perform the calculation can be seen
in the following code listing.  If we needed to place the <code class="docutils literal notranslate"><span class="pre">0.3</span></code> back into the
shared-attribute, we can do that, but we keep the shared-attribute out of our
equation.   The equation will use non-shared, thread-safe, local variables which
are placed on the stack during a thread’s context switch.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># code which doesn&#39;t require an explicit lock</span>
<span class="n">temp</span> <span class="o">=</span> <span class="mf">0.30</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.45</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">**</span> <span class="mf">1.2</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;thr2: &quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="c1"># this code will be implicitly locked by ThreadSafeAttributes</span>
<span class="bp">self</span><span class="o">.</span><span class="n">gl1</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">temp</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ThreadSafeAttributes</span></code> feature actually reads the last line of code you
have written, the behaves differently depending on what you have written.  It
is because of this feature it can release its lock in what looks like a
syntactically inconsistent way.</p>
</div>
</div>


        
        <div class="main-content__right-sidebar">
          <h2 class="sidebar-heading">On this page:</h2>
        </div>
      </div>
    </main>

    <div class="footer-wrapper">
      
      <footer class="main-footer main-footer--sidebar">
      
        <div class="relational-links">
          <div>
            
            ← <a class="relational-link" href="comprehensive.html" title="previous chapter">Comprehensive</a>
            
          </div>
          <div>
            
             <a class="relational-link" href="scribbleexample.html" title="next chapter">Hacking to Learn</a> →
            
          </div>
        </div>
        
        <div class="copyright">
          © Copyright <span class="js-year"></span>,
          
          <a href="https://github.com/aleph2c" class="copyright_link">Scott Volk</a>.
          
        </div>
        
        
        <div class="last-updated">
          <span class="prefix">Last updated:</span>
          <span class="time">Jul 14, 2020 6:45 AM</span>
        </div>
        
        
        <div class="created-with">
          Created using <a href="http://sphinx-doc.org/" class="copyright_link">Sphinx</a> 3.1.2 with <span class="theme">13ds_theme_one</span>.
        </div>
        
      </footer>
    </div>
  </body>
</html>