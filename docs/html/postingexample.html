







<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Simple Posting Example | miros</title>
    <link rel="shortcut icon" href="_static/favicon.ico">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="_static/theme.css" type="text/css">
    
      
    <link rel="stylesheet" type="text/css" href="_static/css/miros_docs.css" />
      
    
    

    
    <script type="text/javascript" src="_static/theme.js" defer></script>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    
    <script src="_static/jquery.js"></script>
    
    <script src="_static/underscore.js"></script>
    
    <script src="_static/doctools.js"></script>
    
    <script src="_static/language_data.js"></script>
    
    

    
      
      
    <link rel="index" title="Index" href="genindex.html">
      
      
    <link rel="search" title="Search" href="search.html">
      
      
      
      
    

    

    

    
  </head>

  <body>
    <header class="main-header">
      <div class="navbar">
        <div id="js-sidebar-mask" class="sidebar-mask"></div>
        <div id="js-sidebar-menu-button" class="sidebar-menu-button">
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg>
        </div>
        <a href="index.html" class="site-link">
          
          miros
          
        </a>
        <div class="navbar-links">
          <a href="installation.html" class="navbar-link">Docs</a>
          
          <a href="https://github.com/aleph2c/miros" class="navbar-link">GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
          
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      
      <div id="js-main-sidebar" class="main-sidebar">
        
        <div class="sidebar-content sidebar-content--divider sidebar-navbar-links">
          <a href="https://github.com/aleph2c/miros" class="sidebar-navbar-link">GitHub</a>
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
        </div>
        
        
        <div class="sidebar-content sidebar-logo">
    <a href="index.html">
      <img class="logo" src="_static/miros_logo.svg" alt="miros" >
    </a>
</div>
        
        

<h2 class="sidebar-heading">Contents</h2>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="zero_to_one.html">Tutorial: Zero to One</a></li>
<li class="toctree-l1"><a class="reference internal" href="reading_diagrams.html">Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="reflection.html">Reflection</a></li>
<li class="toctree-l1"><a class="reference internal" href="patterns.html">Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
</ul>

        
        
<h2 class="sidebar-heading">Useful Links</h2>

<ul>
  <li><a href="https://github.com/aleph2c/py-activeobject">miros on github</a></li>
  <li><a href="https://github.com/aleph2c/sequence">sequence on github</a></li>
  <li><a href="https://aleph2c.github.io/miros-rabbitmq/index.html">miros-rabbitmq plugin</a></li>
  <li><a href="http://www.umlet.com">UMLet Download</a></li>
  <li><a href="http://www.inf.ed.ac.uk/teaching/courses/seoc/2005_2006/resources/statecharts.pdf">formalism explained</a></li>
</ul>


<h2 class="sidebar-heading">For Embedded</h2>

<ul>
  <li><a href="https://state-machine.com/">Quantum Leaps for Embedded</a></li>
  <li><a href="https://github.com/QuantumLeaps/">Quantum Leaps On Github</a></li>
</ul>


<h2 class="sidebar-heading">Statechart Videos</h2>

<ul>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 1 (What)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-why-use-them-2-of-4-90489.html">Part 2 (Why)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 3 (Mealy/Moore)</a></li>
  <li><a href="https://www.mathworks.com/videos/understanding-state-machines-harel-state-machines-4-of-4-90491.html">Part 4 (Harel Statecharts)</a></li>
  <li><a href="https://barrgroup.com/Embedded-Systems/How-To/Introduction-Hierarchical-State-Machines">Introduction to HSMs</a></li>
</ul>
        
        

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel" class="sidebar-heading">Quick search</h2>
  <div class="searchformwrapper sidebar-content">
    <form class="search" action="search.html" method="get">
      <input class="sidebar-search sidebar-search--input" type="text" name="q" aria-labelledby="searchlabel"><input class="sidebar-search sidebar-search--btn" type="submit" value="Go">
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

        
      </div>
      

      
      <div class="main-content main-content--sidebar">
      
        
          
  <blockquote>
<div><p><em>The individual has always had to struggle to keep from being overwhelmed by the
tribe.  If you try it, you will be frightened.  But no price is too high to pay
for the privilege of owning yourself</em> – Friedrich Nietzsche</p>
</div></blockquote>
<div class="section" id="simple-posting-example">
<span id="examples-simple-posting-example"></span><h1>Simple Posting Example<a class="headerlink" href="#simple-posting-example" title="Permalink to this headline">#</a></h1>
<a class="reference external image-reference" href="_static/posting_example.pdf"><img alt="_images/posting_example.svg" class="scale-to-fit" src="_images/posting_example.svg" /></a>
<p>Here we see an active object.  To understand it, lets take the following steps:</p>
<ol class="arabic simple">
<li><p>Look at the states and see how they are related to one another in a hierarchy.</p></li>
<li><p>What external events exist and how the relate to the states.</p></li>
<li><p>What custom code has been placed within the hierarchy.</p></li>
</ol>
<p>In the above example we see three different states interacting with 4 different
user defined events.  The outer state contains a middle state which contains an
inner state.</p>
<p>The event with signal name <strong>A</strong> will cause a transition from the middle state to
the inner state.  The event with signal name <strong>B</strong> will cause the outer event to
exit, print “flash b!” then enter back into the outer state.  Finally, the
event with the signal name <strong>D</strong> will cause the <code class="docutils literal notranslate"><span class="pre">recall</span></code> method to be triggered
in the outer state.</p>
<p>Now that we have a feeling for how the states relate and how they react to
events, lets look at the custom code that has been placed within the
hierarchical structure.</p>
<p>We see that, as previously mentioned, the outer state contains some signal
handling for the <strong>D</strong> named event.</p>
<p>The middle state has some code that is run upon entering the state.  It looks
like we are posting an event to the signal named <strong>A</strong>, that we want it to happen
3 times, with a period of 1 [second] and that we would like it to be deferred. The
entry condition also contains code which <em>augments</em> the chart with something.</p>
<p>The middle state has some exit code, where we are canceling an event.</p>
<p>Upon entering, the inner state, calls the defer method with an Event named <strong>B</strong>.
When the innner state is initialized, it prints “”flash B!” to the terminal,
then stops processing.</p>
<p>Generally speaking we have an idea about what is going on with the chart, now
let’s look how to implement this design using the <em>miros</em> library, then start it
up in the <code class="docutils literal notranslate"><span class="pre">outer</span></code> state.  We will do this in three steps:</p>
<ol class="arabic simple">
<li><p>We will define the state methods and fill them with the custom code in the
diagram.</p></li>
<li><p>We will create an active object</p></li>
<li><p>We will tie our active object to the state methods, by starting it within
the <code class="docutils literal notranslate"><span class="pre">outer</span></code> state.</p></li>
<li><p>We will trigger an event and watch the chart react.</p></li>
</ol>
<p>The <strong>outer</strong> state method would look like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">D</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;flash B!&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>On line <strong>1</strong> we see we are using the <code class="docutils literal notranslate"><span class="pre">&#64;spy_on</span></code> decorator.  This will allow us to
look at how the chart behaves in a log once we start sending events to
it.</p>
<p>Line <strong>2</strong> has the state name, and the method signature.  The <code class="docutils literal notranslate"><span class="pre">ao</span></code> object will be
overwritten with <code class="docutils literal notranslate"><span class="pre">self</span></code> when this method is used by an active object.
However, it can be used by other active objects as well, in that it is a kind
of slide-method that can be shared between objects.  So long as we don’t mark the
function’s name space directly we could share this method between as many
active objects as we construct in our system.  In this example we only use this
method within one active object.  The second argument in the method signature
contains the event that is being sent to this state method.</p>
<p>On line <strong>3</strong> we see the <code class="docutils literal notranslate"><span class="pre">status</span></code> variable defined.  Pay special attention to
this status variable, because it is used by the event processor to determine
what to do as it searches the chart hierarchy while responding to various
events.  We will talk about this in greater detail as we move through the
example.</p>
<p>On lines <strong>4-6</strong>, we see the entry handling for this state.  If we are entering the
state (line <strong>4</strong>), then call the <code class="docutils literal notranslate"><span class="pre">recall</span></code> method of the active object (line <strong>5</strong>)
and finally set the <code class="docutils literal notranslate"><span class="pre">status</span></code> to <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code>, or tell the event processor that
we know what to do with this event and it does not have to recurse the chart
to respond to the event anymore (line <strong>6</strong>).</p>
<p>On line <em>7-8</em> we are saying, run no custom code upon exiting the state.  On
line <em>9-10</em> we are saying, no custom code needs to be run to initialize this
state.</p>
<p>Lines <strong>11-13</strong> describe this state’s reaction to an event with the <strong>D</strong>
signal.  It runs the <code class="docutils literal notranslate"><span class="pre">recall</span></code> method of the active object (line <strong>12</strong>) then
sets the status variable to <code class="docutils literal notranslate"><span class="pre">HANDLED</span></code>.  If there is an event in the deferred
queue of the active object it will be placed into the fifo for the next run to
completion event.  This probably won’t make sense to you yet, don’t worry when
we move through the dynamics of the chart, we will see what this means.  Line
<strong>13</strong> tells the event processor that the <strong>D</strong> signal was handled.  This means
that if the <strong>D</strong> signal was received by the chart while it was in another
state, that the code on line 12 was run, then control was passed back to the
state which received the event.  This behavior is an example of the ultimate
hook pattern which you can read about in the section titled
<a class="reference internal" href="patterns.html#patterns-ultimate-hook"><span class="std std-ref">Ultimate Hook</span></a>.</p>
<p>Lines <strong>14-16</strong> describe the <strong>B</strong> arrow on the diagram.  If any state within
our state chart receives an event called <strong>B</strong> we would like it to pass control
to the outer state (line 14,16), then exit the outer state, run <code class="docutils literal notranslate"><span class="pre">print(flash</span>
<span class="pre">B)</span></code> (line 15) then re-enter the outer state (line 16).  Pay special attention
to line 16.  Here we are using the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method, which will return the
status.  Unlike the other parts of this method, we are not saying that the
status is HANDLED, here we let the trans method decide how to set this
variable.  This is important since it allows the event processor to perform the
work required by our hierarchical topology.</p>
<p>On lines <strong>17-18</strong> we are telling the event processor that if we haven’t
managed this signal pass it onto our outer state, in this case it is the top
state which means that it is unhandled.</p>
<p>Finally on line <strong>19</strong> we return the status.</p>
<p>Anyone familiar with the event processors described in the Miro Samek
tradition of dealing with hierarchical state machines will recognize the
structure of this method.  This is because the event processor used by the
miros library is a port of his work which has been written about in papers in
embedded journals and books.  I think it is important to keep the same
structure and semantics since many in our industry have become familiar with
them.  It will also ensure that if you port your work into the quantum
framework, the code will look about the same there as it does here.</p>
<p>Now let’s move on to the construction of the <em>middle</em> state:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">middle</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">multi_shot_thread</span> <span class="o">=</span> \
      <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">),</span>
                      <span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                      <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># We mark up the ao with this id, so that</span>
    <span class="c1"># this state function can be used by many different aos</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">multi_shot_thread</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;multi_shot_thread&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">cancel_event</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">multi_shot_thread</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>This method generally has the same structure as the outer state method.  Line
<em>1</em> instruments the method.  Line <em>2</em> has the same method signature.  Line <em>3</em>
uses the same way to set up are return variable.</p>
<p>On lines <strong>4-14</strong> we see the code which will be run  when this state is
entered.  Line <strong>5</strong> stores the <code class="docutils literal notranslate"><span class="pre">multi_shot_thread</span></code> id which is produced in
the call to <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> on line <strong>6</strong>.  The <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> call creates a
little parallel thread which will make events then send them back at our
statechart with no regard to what state our active object is in, it will just
place the event into the active object’s first in first out buffer.</p>
<p>We see on lines <strong>12-13</strong> that we <code class="docutils literal notranslate"><span class="pre">augment</span></code> our <code class="docutils literal notranslate"><span class="pre">ao</span></code> with the attribute
called <code class="docutils literal notranslate"><span class="pre">multi_shot_thread</span></code> and give it the contents that was returned on line
<strong>6</strong>.  This was done to salt away this information so that it can be used in
the exit condition of this state method.  Now lets jump back to how the
<code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> event was called:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">A</span><span class="p">),</span>
                <span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we see that it will be posting an Event with the signal name <strong>A</strong> to our
chart 3 times, with a period of 1 second and that it is deferred.  Here the
<cite>deferred</cite> input means that our parallel thread will wait the period duration
(1 second) before beginning its little job of posting the <strong>A</strong> event 3 times,
at a frequency of once per second.  There are lots of different ways to post
events, if you would like to investigate the other ways, look at the
<a class="reference internal" href="recipes.html#posting-events"><span class="std std-ref">Posting Events</span></a> recipes.</p>
<p>When this thread source has finished its job it will just stop running.
However, if the chart exits our middle state prior to our thread source
exhausting itself, it would start posting the <em>A</em> signal to the outer state.
This wouldn’t be a big deal, since our state chart would just ignore the <em>A</em>
signal, but it would mean that we would be wasting cycles by making our event
processor search the chart’s hierarchy with no hope of finding any useful work.</p>
<p>Let’s talk about how this little thread can be canceled upon exiting our state.</p>
<p>On lines <strong>10-11</strong> we see this comment: “We mark up the ao with this id, so
that this state function can be used by many different aos.”  Then we see some
code where the <code class="docutils literal notranslate"><span class="pre">multi_shot_thread</span></code> attribute is created an given the id of
the thread used to post the <em>A</em> events.  Remember, the <code class="docutils literal notranslate"><span class="pre">ao</span></code> variable
represents the <code class="docutils literal notranslate"><span class="pre">self</span></code> of your active object.  Here we are creating code that
could be written as this instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-writing lines 12-13 as if they were in the active object class</span>
<span class="n">this</span><span class="o">.</span><span class="n">multi_shot_thread</span> <span class="o">=</span> <span class="n">multi_shot_thread</span>
</pre></div>
</div>
<p>All we are doing is storing the multi_shot_thread id into the active object
that is using it, so that it can be canceled by the exit handler of the
<strong>middle</strong> state.  Now what is up with that comment?  When I first wrote the
example I wrote the thread id into the <strong>middle</strong> function’s name space.  This
was a bug, since this <strong>middle</strong> state method could be used by many different
active objects.  When one exited it would use an id associate with a different
one.  Since this code can be re-used by many different active objects we need
to mark up those object’s namespace and leave this functions’ name space as is.
Never use static variables in the state method state space.</p>
<p>So we have created a little thread that can post events, we have stored its id
into a variable within the name space of the active object calling this state
method, so we can cancel it if we want to.  Now let’s move on.</p>
<p>Line <strong>14</strong> tells the event processor that we have handled this signal and it
does not have to recurse the outer states of the chart.</p>
<p>Lines <strong>16-18</strong> describes what we want to do when this state is being exited.
On line <strong>17</strong> we see that we are using the thread id of our little event
posting thread to cancel that thread.  The <code class="docutils literal notranslate"><span class="pre">cancel_event</span></code> method needs a
specific thread id.  If you wanted to avoid all of this trouble of storing
event source ids into your active object, you could use the <code class="docutils literal notranslate"><span class="pre">cancel_events</span></code>
method instead.  See the <a class="reference internal" href="recipes.html#recipes-cancelling-event-source-by-signal-name"><span class="std std-ref">Canceling Event Source By Signal Name</span></a> recipe.</p>
<p>From line <strong>20-21</strong> we see that we don’t have any special handling for the
initialization event for this state.</p>
<p>On lines <strong>22-23</strong> we see that when this state sees an <strong>A</strong> event it must
transition into the <strong>inner</strong> state.</p>
<p>On lines <strong>24-25</strong> we see how this state method handle’s signals it does not
know what to do with, it sets the status to <strong>SUPER</strong> and sets the
<code class="docutils literal notranslate"><span class="pre">ao.temp.fun</span></code> to the outer function.</p>
<p>With these bread crumbs the event processor will know what to do so that our
architecture can give us the dynamics of the Harel statechart formalism.</p>
<p>It is easy to forget that our statecharts are just programs that repeatedly
call methods with arguments.  They are structured programs pretending to be in
a different programming paradigm.  It is the event processor that allows this
to happen, the trade off is that we have to pepper our state methods with what
looks like strange syntax to give the event processor the ability to
traverse any of the topologies that we might want to build.</p>
<p>It is the event processor that calls our state methods over and over again to
build up lists of what functions should be called when and with what arguments.</p>
<p>This is what Miro Samek called an inversion of control.  By embedding his event
processing algorithm into their design, a developer can quickly construct any
sort of state chart topology knowing that the dynamics of the how and the when
things are called, will behave as they would expect them to.  By placing the
<cite>control</cite> of how things happen into the event processor, a developer can unload
their cognition, focusing on the design itself rather than how they are going
to implement it.</p>
<p>Let’s describe the <strong>inner</strong> state as a state method:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
<span class="hll">    <span class="n">ao</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;charging with B&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">middle</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>We understand most of this code now, with the exception of line <em>4</em>.  We see
that it happens upon entering the state and that we are deferring an
event with the signal name <strong>B</strong>, but what does this mean?</p>
<p>To understand this, we have to know that an active object has a kind of
savings-account queue.  You can put things into it and nothing will happen.  The
active object won’t react to them until you ask it to react to them with a call
to the <code class="docutils literal notranslate"><span class="pre">recall</span></code> method.  The recall method moves an item out of the
<cite>deferred</cite> queue and places it into the <cite>fifo</cite> queue.  The active object reacts
to elements in the <cite>fifo</cite> so when you call the <code class="docutils literal notranslate"><span class="pre">recall</span></code> method you are asking
the chart to react to the oldest thing that was placed into the deferred queue.</p>
<p>Ok, so <code class="docutils literal notranslate"><span class="pre">defer</span></code> stores an Event, so who recalls the event?  By examining our
state diagram, we see that the <strong>outer</strong> state has a <code class="docutils literal notranslate"><span class="pre">recall</span></code> method that it
calls upon receiving the event named <strong>D</strong>.  The entry of the <code class="docutils literal notranslate"><span class="pre">inner</span></code>
entry handler also has the <code class="docutils literal notranslate"><span class="pre">recall</span></code> method.  That’s kind of strange, but this
will make more sense once we reflect upon the dynamics of the active object.</p>
<p>Before we do that, let’s look at lines <strong>8-9</strong>.  Here we see that once the state
is initialized we print, “charging with B” to the terminal.  Once again, this
is kind of strange.  On the diagram we see this expressed as the bit black dot
(the <strong>init</strong> signal) with an arrow labeled with the code we want to run, running
into a big black line.  This black line means stop there, you have done enough
processing.  This is the equivalent to line <strong>10</strong> in the above code snippet.</p>
<p>If you understand active objects look at the diagram and ask yourself, what
happens if I start this chart in the <strong>middle</strong> state, then what happens if I
wait about 4 seconds and then send an event named <strong>D</strong>?</p>
<a class="reference external image-reference" href="_static/posting_example.pdf"><img alt="_images/posting_example.svg" class="scale-to-fit" src="_images/posting_example.svg" /></a>
<p><em>Hint: I modeled the diagram on a tazor.</em></p>
<p>Let’s see what happens using our state methods within an active object, then
reflecting upon its behavior.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="n">ao</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">C</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>
<span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">D</span><span class="p">))</span>
<span class="hll"><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">spy_full</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>On line <strong>1</strong> we create an active object.  On line <strong>2</strong> we start it in the
<strong>outer</strong> state method.  The active object’s event processor can now reach all
of the state methods (even though they are defined outside of its class)
because the state methods reference each other.  On line <strong>3</strong> we transition
into the <strong>middle</strong> state.  We wait for a while; <strong>4</strong> and then we send an event with
the <strong>D</strong> signal to the chart, line <strong>6</strong>.</p>
<p>Pay special attention to line <strong>7</strong>, because if you don’t you might end up thinking
this whole example doesn’t work at all.  I did this when I was constructing the
example and began a senseless investigation trying to figure out what was
wrong.</p>
<p>You need to wait for the active object threads to react to the items placed in
their queues.  All of the threads used within the miros library are <cite>daemonic</cite>
meaning that when your main program loop stops running, all of the threads it
created also stop running.  So, if you don’t wait, the program will exit,
killing all of the threads before they can do anything useful.</p>
<p>Now let’s break it down, thinking about a tazor as a metaphor.  A tazor is a
device that contains a small low voltage battery, a voltage amplifier circuit
and a capacitor.  You turn it on and it starts to whine.</p>
<p>This is the sound of a charge transfer from the small battery to the voltage
amplifier which separates the charge at a high voltage across the capacitor.
After this capacitor is charged up, you can zap somebody; the charge is coming
out of the capacitor in a hurry.</p>
<p>Line <strong>9</strong> shows us the action:</p>
<div class="highlight-shell notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="o">[</span><span class="s1">&#39;START&#39;</span>,
</span> <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:middle&#39;</span>,
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:middle&#39;</span>,
 <span class="s1">&#39;INIT_SIGNAL:middle&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span>,
</span> <span class="s1">&#39;A:middle&#39;</span>,
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;POST_DEFERRED:B&#39;</span>,
 <span class="s1">&#39;INIT_SIGNAL:inner&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span>,
</span> <span class="s1">&#39;A:inner&#39;</span>,
 <span class="s1">&#39;A:middle&#39;</span>,
 <span class="s1">&#39;EXIT_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;POST_DEFERRED:B&#39;</span>,
 <span class="s1">&#39;INIT_SIGNAL:inner&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(2)&#39;</span>,
</span> <span class="s1">&#39;A:inner&#39;</span>,
 <span class="s1">&#39;A:middle&#39;</span>,
 <span class="s1">&#39;EXIT_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;POST_DEFERRED:B&#39;</span>,
 <span class="s1">&#39;INIT_SIGNAL:inner&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(3)&#39;</span>,
</span> <span class="s1">&#39;D:inner&#39;</span>,
 <span class="s1">&#39;D:middle&#39;</span>,
 <span class="s1">&#39;D:outer&#39;</span>,
 <span class="s1">&#39;POST_FIFO:B&#39;</span>,
 <span class="s1">&#39;D:outer:HOOK&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(2)&#39;</span>,
</span> <span class="s1">&#39;B:inner&#39;</span>,
 <span class="s1">&#39;B:middle&#39;</span>,
 <span class="s1">&#39;B:outer&#39;</span>,
 <span class="s1">&#39;EXIT_SIGNAL:inner&#39;</span>,
 <span class="s1">&#39;EXIT_SIGNAL:middle&#39;</span>,
 <span class="s1">&#39;EXIT_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;POST_FIFO:B&#39;</span>,
 <span class="s1">&#39;RECALL:B&#39;</span>,
 <span class="s1">&#39;INIT_SIGNAL:outer&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(1)&#39;</span>,
</span> <span class="s1">&#39;B:outer&#39;</span>,
 <span class="s1">&#39;EXIT_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;POST_FIFO:B&#39;</span>,
 <span class="s1">&#39;RECALL:B&#39;</span>,
 <span class="s1">&#39;INIT_SIGNAL:outer&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span>,
</span> <span class="s1">&#39;B:outer&#39;</span>,
 <span class="s1">&#39;EXIT_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;ENTRY_SIGNAL:outer&#39;</span>,
 <span class="s1">&#39;INIT_SIGNAL:outer&#39;</span>,
<span class="hll"> <span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="o">]</span>
</span></pre></div>
</td></tr></table></div>
<p>I have emphasized the beginning and ends of each run to completion event.  This
should make things easier to talk about.  So we entered our chart, waited then
sent a single event to it, and we got all of this action.</p>
<p>Lines <strong>1-7</strong> occurred as a result of us starting up the active object in the
<strong>middle</strong> state.  We entered the <strong>outer</strong> state, ran its entry code, then
entered the <strong>middle</strong> state and ran its entry code, then its <strong>init</strong> code.</p>
<p>The <strong>entry</strong> code for the <strong>middle</strong> state started up or <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> thread,
which would post an <strong>A</strong> signal to the chart once a second for 3 seconds.  We
are charging the capacitor.  To see how, look at lines <strong>7-13</strong>, we see that an
<strong>A</strong> event was fired, the chart transitioned into the <strong>inner</strong> state, the
<strong>entry</strong> condition for the <strong>inner</strong> placed the <strong>B</strong> event into the active
objects deferred queue.  Think of this as the battery pumping up the
capacitor’s voltage with some charge.  It can only happen a little bit at a
time.</p>
<p>One second later we see the next pumping event on lines <strong>13-21</strong>, and then
one more time over lines <strong>21-29</strong>.  Notice that our <cite>Deferred</cite> queue is
getting bigger.</p>
<p>Now it is time to zap someone, so we would hold our tazor close to our
unsuspecting victim and trigger the <strong>D</strong> signal. We can see what happens in
the rest of the spy output.</p>
<p>Lines <strong>29-35</strong> shows the event processor searching for a state method that knows
what to do with the <strong>D</strong> signal.  On line <strong>33</strong> we see that the outer state
has posted a deferred signal <strong>B</strong> into our fifo buffer, then on line <strong>34</strong> we
see that this was done using a <strong>HOOK</strong> which means that the code that managed
it is an inherited behavior and that we aren’t expected to transition because of
the <strong>D</strong> signal: the signal is <cite>HANDLED</cite>.</p>
<p>But the resulting <strong>B</strong> signal is not HANDLED, in fact it is going to create a
cascade of activity.</p>
<p>Lines <strong>35-46</strong> show the beginning of this activity.  Since the previous <strong>D</strong>
signal was HANDLED (see line <strong>34</strong>), the chart is still in its prior
<strong>inner</strong> state.  Lines <strong>36-38</strong> show the event processor searching the chart
to see if any of the state methods know how to handle the <strong>B</strong> signal.  It
finds the <code class="docutils literal notranslate"><span class="pre">trans</span></code> code in the <strong>outer</strong> state, builds up a strategy, then
starts to act on that strategy from lines <strong>39-46</strong>.  We see that it runs the
<strong>exit</strong> event against the <strong>inner</strong> method, then runs the <strong>exit</strong> event
against the <strong>middle</strong> method (which cancels our post_fifo thread if it is
still running), then it posts the <strong>exit</strong> event against the <strong>outer</strong> state,
then it posts the <strong>entry</strong> event against the <strong>inner</strong> state.  On lines
<strong>43-44</strong> we see that we are posting and recalling the next <strong>B</strong> signal from
our deferred event queue.</p>
<p>Since our statechart is now in the <strong>outer</strong> state this <strong>B</strong> signal just
leaves and re-enters the chart, triggering the next deferred <strong>B</strong> event to be
posted to the <strong>fifo</strong> queue of the active object.  This dynamic continues
until all of the deferred <strong>B</strong> items in the active object queue are expressed.
Your victim should be laying on the floor now.</p>
<p>So, there you have it, a very simple rendition of a tazor, our statechart could
have look like this:</p>
<a class="reference external image-reference" href="_static/tazor.pdf" id="examples-tazor-example"><img alt="_images/tazor.svg" class="scale-to-fit" src="_images/tazor.svg" /></a>
<p>This diagram is almost topologically the same as the one described at the
beginning of our <a class="reference internal" href="#examples-simple-posting-example"><span class="std std-ref">Simple Posting Example</span></a>.  The only adjustment
was to add a new signal from re-arming our tazor (READY).</p>
<p>Here are the state methods for the diagram:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">tazor_operating</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">TRIGGER_PULLED</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="c1"># added this so we can rearm our tazor</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">READY</span><span class="p">):</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">arming</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">CAPACITOR_CHARGE</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;zapping&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">tazor_operating</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">arming</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">multi_shot_thread</span> <span class="o">=</span> \
      <span class="n">ao</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">BATTERY_CHARGE</span><span class="p">),</span>
                      <span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                      <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># We mark up the ao with this id, so that</span>
    <span class="c1"># state function can be used by many different aos</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">multi_shot_thread</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;multi_shot_thread&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">cancel_event</span><span class="p">(</span><span class="n">ao</span><span class="o">.</span><span class="n">multi_shot_thread</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BATTERY_CHARGE</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">ao</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">armed</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">tazor_operating</span>
  <span class="k">return</span> <span class="n">status</span>


<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">armed</span><span class="p">(</span><span class="n">ao</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">ao</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CAPACITOR_CHARGE</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;charging tazor&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">ao</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">arming</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Now we will create an active object, link the above state methods into it by
starting it in the arming state:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tazor</span> <span class="o">=</span> <span class="n">ActiveObject</span><span class="p">()</span>
<span class="n">tazor</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">arming</span><span class="p">)</span>
<span class="hll"><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>
</span></pre></div>
</div>
<p>Notice that we wait 3 seconds to let it charge up.</p>
<p>Now let’s pull the trigger:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tazor</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">TRIGGER_PULLED</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># if you don&#39;t wait it won&#39;t look like it is working</span>
<span class="hll"><span class="nb">print</span><span class="p">(</span><span class="n">tazor</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>
</span></pre></div>
</div>
<p>The highlighted code above shows that we used the trace to output a high level
view of what happened when we pulled the trigger:</p>
<div class="highlight-shell notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="m">19</span>:51:25.509209 <span class="o">[</span>75c8c<span class="o">]</span> None: top-&gt;arming
<span class="m">19</span>:51:26.511506 <span class="o">[</span>75c8c<span class="o">]</span> BATTERY_CHARGE: arming-&gt;armed
<span class="m">19</span>:51:27.512153 <span class="o">[</span>75c8c<span class="o">]</span> BATTERY_CHARGE: armed-&gt;armed
<span class="hll"><span class="m">19</span>:51:28.512604 <span class="o">[</span>75c8c<span class="o">]</span> BATTERY_CHARGE: armed-&gt;armed
</span><span class="hll"><span class="m">19</span>:51:29.512080 <span class="o">[</span>75c8c<span class="o">]</span> CAPACITOR_CHARGE: armed-&gt;tazor_operating
</span><span class="m">19</span>:51:29.513081 <span class="o">[</span>75c8c<span class="o">]</span> CAPACITOR_CHARGE: tazor_operating-&gt;tazor_operating
<span class="m">19</span>:51:29.514085 <span class="o">[</span>75c8c<span class="o">]</span> CAPACITOR_CHARGE: tazor_operating-&gt;tazor_operating
</pre></div>
</td></tr></table></div>
<p>Notice that our <strong>TRIGGER_PULL</strong> signal did not show up in our trace.  We would
expect it to occur between lines <em>4</em> and <em>5</em>.  This is because the trace only
shows signals that cause state transition.  The <strong>TRIGGER_PULL</strong> signal was
handled by a HOOK and therefore didn’t directly cause a transition.  Instead,
it cause the <code class="docutils literal notranslate"><span class="pre">recall</span></code> method to post a <strong>CAPACITOR_CHARGE</strong> signal, which
in turn causes two more state transitions.</p>
<p>To see our full spy log, we would use the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pp</span><span class="p">(</span><span class="n">tazor</span><span class="o">.</span><span class="n">spy_full</span><span class="p">())</span>
</pre></div>
</div>
<p>Which outputs the full story:</p>
<div class="highlight-shell notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="o">[</span><span class="s1">&#39;START&#39;</span>,
</span><span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:arming&#39;</span>,
<span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:arming&#39;</span>,
<span class="s1">&#39;INIT_SIGNAL:arming&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span>,
</span><span class="s1">&#39;BATTERY_CHARGE:arming&#39;</span>,
<span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;POST_DEFERRED:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;INIT_SIGNAL:armed&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(0) Deferred:(1)&#39;</span>,
</span><span class="s1">&#39;BATTERY_CHARGE:armed&#39;</span>,
<span class="s1">&#39;BATTERY_CHARGE:arming&#39;</span>,
<span class="s1">&#39;EXIT_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;POST_DEFERRED:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;INIT_SIGNAL:armed&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(0) Deferred:(2)&#39;</span>,
</span><span class="s1">&#39;BATTERY_CHARGE:armed&#39;</span>,
<span class="s1">&#39;BATTERY_CHARGE:arming&#39;</span>,
<span class="s1">&#39;EXIT_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;POST_DEFERRED:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;INIT_SIGNAL:armed&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(0) Deferred:(3)&#39;</span>,
</span><span class="s1">&#39;TRIGGER_PULLED:armed&#39;</span>,
<span class="s1">&#39;TRIGGER_PULLED:arming&#39;</span>,
<span class="s1">&#39;TRIGGER_PULLED:tazor_operating&#39;</span>,
<span class="s1">&#39;POST_FIFO:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;TRIGGER_PULLED:tazor_operating:HOOK&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(1) Deferred:(2)&#39;</span>,
</span><span class="s1">&#39;CAPACITOR_CHARGE:armed&#39;</span>,
<span class="s1">&#39;CAPACITOR_CHARGE:arming&#39;</span>,
<span class="s1">&#39;CAPACITOR_CHARGE:tazor_operating&#39;</span>,
<span class="s1">&#39;EXIT_SIGNAL:armed&#39;</span>,
<span class="s1">&#39;EXIT_SIGNAL:arming&#39;</span>,
<span class="s1">&#39;EXIT_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;POST_FIFO:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;RECALL:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;INIT_SIGNAL:tazor_operating&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(1) Deferred:(1)&#39;</span>,
</span><span class="s1">&#39;CAPACITOR_CHARGE:tazor_operating&#39;</span>,
<span class="s1">&#39;EXIT_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;POST_FIFO:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;RECALL:CAPACITOR_CHARGE&#39;</span>,
<span class="s1">&#39;INIT_SIGNAL:tazor_operating&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(1) Deferred:(0)&#39;</span>,
</span><span class="s1">&#39;CAPACITOR_CHARGE:tazor_operating&#39;</span>,
<span class="s1">&#39;EXIT_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;ENTRY_SIGNAL:tazor_operating&#39;</span>,
<span class="s1">&#39;INIT_SIGNAL:tazor_operating&#39;</span>,
<span class="hll"><span class="s1">&#39;&lt;- Queued:(0) Deferred:(0)&#39;</span><span class="o">]</span>
</span></pre></div>
</td></tr></table></div>
<p><a class="reference internal" href="examples.html#examples"><span class="std std-ref">back to examples</span></a></p>
</div>


        
        <div class="main-content__right-sidebar">
          <h2 class="sidebar-heading">On this page:</h2>
        </div>
      </div>
    </main>

    <div class="footer-wrapper">
      
      <footer class="main-footer main-footer--sidebar">
      
        <div class="relational-links">
          <div>
            
          </div>
          <div>
            
          </div>
        </div>
        
        <div class="copyright">
          © Copyright <span class="js-year"></span>,
          
          <a href="https://github.com/aleph2c" class="copyright_link">Scott Volk</a>.
          
        </div>
        
        
        <div class="last-updated">
          <span class="prefix">Last updated:</span>
          <span class="time">Nov 03, 2020 8:22 AM</span>
        </div>
        
        
        <div class="created-with">
          Created using <a href="http://sphinx-doc.org/" class="copyright_link">Sphinx</a> 3.3.0 with <span class="theme">13ds_theme_one</span>.
        </div>
        
      </footer>
    </div>
  </body>
</html>