
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Quick Start &#8212; miros 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Zero To One" href="zero_to_one.html" />
    <link rel="prev" title="Introduction" href="introduction.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <blockquote>
<div><p><em>I invented the term object oriented, and I can tell you that C++ wasn’t what I had in mind.</em></p>
<p class="attribution">&mdash;Alan Kay</p>
</div></blockquote>
<div class="section" id="quick-start">
<span id="id1"></span><h1>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h1>
<p>If you know nothing about statecharts I suggest you start here: <a class="reference internal" href="zero_to_one.html#zero-to-one-zero-to-one"><span class="std std-ref">zero to
one</span></a></p>
<p>If you haven’t seen UML diagrams before, scan the <a class="reference internal" href="reading_diagrams.html#reading-diagrams-reading-diagrams"><span class="std std-ref">understanding diagrams</span></a> part of this guide to make sense of the
pictures.</p>
<p>If you are an embedded developer and want to port your working miros Python code to
C/C++ for a considerable performance gain.  Check out this project: <a class="reference external" href="https://github.com/QuantumLeaps/qpc">qp codebase</a>.  It is documented here: <a class="reference external" href="https://sourceforge.net/projects/qpc/files/doc/PSiCC2.pdf/download">Practical UML
Statecharts in C/C++, 2nd Edition</a>.</p>
<p>In the next section we will show how to tackle a problem using UML statecharts.</p>
<div class="section" id="a-networked-sprinkler">
<span id="quickstart-a-quick-example"></span><h2>A Networked Sprinkler<a class="headerlink" href="#a-networked-sprinkler" title="Permalink to this headline">¶</a></h2>
<p>Let’s use the Python miros library to build a sprinkler. This
sprinkler will water our plants in the summer, after dark, and only when it is
not raining.  To do this we will call out to the <a class="reference external" href="https://openweathermap.org/api">open weather api</a>.</p>
<a class="reference external image-reference" href="https://www.ijcaonline.org/archives/volume172/number6/28254-2017915160"><img alt="_images/sprinkler.jpg" class="align-center" src="_images/sprinkler.jpg" /></a>
<p>Once the networked sprinkler knows which city its working in it should just turn
on and operate as if it could measure the weather conditions with local instruments.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">open</span> <span class="pre">weather</span></code> documentation recommends that we request city information
using a city ID, so our software should extract this id from a file the <code class="docutils literal notranslate"><span class="pre">open</span>
<span class="pre">weather</span></code> folks have put on their website:
<a class="reference external" href="http://bulk.openweathermap.org/sample/city.list.json.gz">http://bulk.openweathermap.org/sample/city.list.json.gz</a>.</p>
<p>Our design will consist of three different active objects which will work
together:</p>
<blockquote>
<div><ul class="simple">
<li>something that will control the sprinkler (Sprinkler).</li>
<li>something that will download a file from the open weather website and
extract the correct city ID for a given city and country
(OpenWeatherMapCityDetails).</li>
<li>something that will act like a weather station attached to the sprinkler,
by making calls to the open weather API (CityWeather).</li>
</ul>
</div></blockquote>
<p>Here is a high level diagram of how these parts fit together and what they do:</p>
<a class="reference external image-reference" href="_static/sprinkler_high_level.pdf"><div align="center" class="align-center"><img alt="_images/sprinkler_high_level.svg" src="_images/sprinkler_high_level.svg" /></div>
</a>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On interpreting the diagram:</p>
<p class="last">The Sprinkler class <strong>will have a</strong> CityWeather object <strong>and an</strong>
OpenWeatherMapCityDetails object (black diamond arrows).  The CityWeather
object will interact with the Sprinkler and OpenWeatherMapCityDetails objects.
(dashed lines)</p>
</div>
<p>We will use three different statecharts, one per object in the above diagram.
Having independent objects interface in a statechart is called orthogonality in
statechart theory.</p>
<div class="section" id="figuring-out-what-information-will-be-passed-around">
<span id="quickstart-figuring-out-what-information-will-be-passed-around"></span><h3>Figuring out what Information will be Passed Around<a class="headerlink" href="#figuring-out-what-information-will-be-passed-around" title="Permalink to this headline">¶</a></h3>
<p>Let’s wave our hands an assume that the three active objects used in this
designed have been built already and are working, but we want to figure out how
they will communicate with one another.</p>
<p>David Harel called such a thing, a <code class="docutils literal notranslate"><span class="pre">statocol</span></code> (state protocol):  what
information will the statecharts need to share, so as a group, they will
achieve our design goal; and give us our networked sprinkler:</p>
<a class="reference external image-reference" href="_static/sprinkler_high_level.pdf"><div align="center" class="align-center"><img alt="_images/sprinkler_high_level.svg" src="_images/sprinkler_high_level.svg" /></div>
</a>
<p>We need to figure out how to call the open weather api, with a city id, before it
will return weather information for its location. This is the problem the
<code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code> object solves: it will provide the city id when we
give it the city and country names of where we have placed the sprinkler.</p>
<p>A rough sketch of the <code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code> object will look like this:</p>
<a class="reference external image-reference" href="_static/open_weather_map_city_details_medium.pdf"><div align="center" class="align-center"><img alt="_images/open_weather_map_city_details_medium.svg" src="_images/open_weather_map_city_details_medium.svg" /></div>
</a>
<p>This diagram shows us the input and output goals; for a city and a country
return the open weather api’s city id.</p>
<p><code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code> will subscribe to and receive events called
<code class="docutils literal notranslate"><span class="pre">REQUEST_DETAILS_FOR_CITY</span></code>.  Below this event is the namedtuple,
<code class="docutils literal notranslate"><span class="pre">RequestDetailsForCityPayload</span></code>.  This is the immutable payload that will ride
inside of the event.  Likewise the namedtuple called <code class="docutils literal notranslate"><span class="pre">CityDetailsPayload</span></code> will
ride inside of the <code class="docutils literal notranslate"><span class="pre">CITY_DETAILS</span></code> event.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On interpreting the diagram:</p>
<p class="last">All of the high level event interfaces will look like this one.  Arrows going
into the rounded rectangle beside the green dots are the published events
that the object will consume.  Arrows leaving the object, beside the red
dots, will be the events it publishes.  The namedtuples near the event’s name
will describe the payload data structure.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On namedtuples:</p>
<p class="last">The miros library can place any kind of object into an event payload.
However event payloads are objects that are shared between threads, we don’t
want one thread to change this object while another thread is trying to read
it, so as a rule use immutable objects as payloads when programming with miros
(to avoid nasty multithreading bugs).</p>
</div>
<p>The high level event interface of the <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> object looks like this:</p>
<a class="reference external image-reference" href="_static/city_weather_details_medium.pdf"><div align="center" class="align-center"><img alt="_images/city_weather_details_medium.svg" src="_images/city_weather_details_medium.svg" /></div>
</a>
<p>This diagram shows us the <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> input and output goals: For a city and
a country get its city id, and when asked, return the weather information for
that city.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On implimentation (and sausage making):</p>
<p class="last">I wrote some prototype code, to poke at the open weather city api prior to
designing this system.  I used the python debugger to break right after
receiving a message from their service.  I compared what I was seeing with
their documentation, then decided on what the payload data structures should
look like.</p>
</div>
<p>Here is the high level interface diagram of the <code class="docutils literal notranslate"><span class="pre">Sprinkler</span></code>:</p>
<a class="reference external image-reference" href="_static/sprinkler_details_medium.pdf"><div align="center" class="align-center"><img alt="_images/sprinkler_details_medium.svg" src="_images/sprinkler_details_medium.svg" /></div>
</a>
<p>This diagram shows us the <code class="docutils literal notranslate"><span class="pre">Sprinkler</span></code> input and output goals: Ask for the
weather and get the weather.</p>
<p>There can be many events which all share the same name; an event’s name is
called a signal.  An event of a particular signal, can also carry a python
object with it.  As this event is passed through the system, the object that it
is carrying stays linked to it.  A linked object is called a payload.  The miros
library lets you link any python object to an event, or in other words, your
Event can have any Python object as a payload.  However, we are limiting
ourselves to only send namedtuples as payloads, because they are immutable and
provide very nice syntax.</p>
<p>Here is how you would use the miros library to publish (public send) a
<code class="docutils literal notranslate"><span class="pre">REQUEST_DETAILS_FOR_CITY</span></code> event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="c1"># define the REQUEST_DETAILS_FOR_CITY payload type</span>
<span class="n">RequestDetailsForCityPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RequestDetailsForCityPayload&#39;</span><span class="p">,</span>
  <span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;country&#39;</span><span class="p">])</span>

<span class="c1"># Assume the CityWeather ActiveObject has been defined elsewhere and is</span>
<span class="c1"># working.</span>
<span class="n">city_weather</span> <span class="o">=</span> <span class="n">CityWeather</span><span class="p">()</span>

<span class="c1"># Published an event will have a red dot beside it on the diagram, it</span>
<span class="c1"># publishes and the event has to wait somewhere before it is processed (red</span>
<span class="c1"># light).</span>
<span class="c1">#</span>
<span class="c1"># If the &#39;REQUEST_DETAILS_FOR_CITY&#39; signal name has not been defined before</span>
<span class="c1"># miros will define it now.  Its signal will be given a signal_number</span>
<span class="c1"># attribute and a signal_name attribute equal to &#39;REQUEST_DETAILS_FOR_CITY&#39;</span>
<span class="c1"># (signal name construction happens automatically in miros)</span>
<span class="n">city_weather</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_DETAILS_FOR_CITY</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">RequestDetailsForCityPayload</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="s1">&#39;Vancouver&#39;</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="s1">&#39;CA&#39;</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span>
<span class="c1"># any ActiveObject that has subscribed to REQUEST_DETAILS_FOR_CITY will</span>
<span class="c1"># receive the event and react to it.  When an event is received which</span>
<span class="c1"># was subscribed to on the diagram, it will have a green dot beside it.</span>
<span class="c1"># (green light)</span>
</pre></div>
</div>
<p>To lock down how I want my payloads to look, I would place this in the top part
of the robotic sprinkler Python file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">Coord</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
  <span class="s1">&#39;Coord&#39;</span><span class="p">,</span>
  <span class="p">[</span>
    <span class="s1">&#39;lon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lat&#39;</span>
  <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># uses Coord</span>
<span class="n">CityDetailsPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
  <span class="s1">&#39;CityDetailsPayload&#39;</span><span class="p">,</span>
  <span class="p">[</span>
    <span class="s1">&#39;id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;country&#39;</span><span class="p">,</span>  <span class="c1"># ISO 3166</span>
    <span class="s1">&#39;city&#39;</span><span class="p">,</span>
    <span class="s1">&#39;coord&#39;</span>  <span class="c1"># Coord</span>
  <span class="p">]</span>
<span class="p">)</span>

<span class="n">RequestDetailsForCityPayload</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
  <span class="s1">&#39;RequestDetailsForCityPayload&#39;</span><span class="p">,</span>
  <span class="p">[</span>
    <span class="s1">&#39;city&#39;</span><span class="p">,</span>
    <span class="s1">&#39;country&#39;</span>  <span class="c1"># ISO 3166</span>
  <span class="p">]</span>
<span class="p">)</span>

<span class="n">Weather</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
  <span class="s1">&#39;Weather&#39;</span><span class="p">,</span>
  <span class="p">[</span>
    <span class="s1">&#39;icon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;main&#39;</span><span class="p">,</span>
    <span class="s1">&#39;id&#39;</span><span class="p">,</span>
    <span class="s1">&#39;description&#39;</span>
  <span class="p">]</span>
<span class="p">)</span>

<span class="n">Wind</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
  <span class="s1">&#39;Wind&#39;</span><span class="p">,</span>
  <span class="p">[</span>
    <span class="s1">&#39;speed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;deg&#39;</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># uses Weather, Coord</span>
<span class="n">WeatherOpenApiResult</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
  <span class="s1">&#39;WeatherOpenApiResult&#39;</span><span class="p">,</span>
  <span class="p">[</span>
    <span class="s1">&#39;city&#39;</span><span class="p">,</span>
    <span class="s1">&#39;country&#39;</span><span class="p">,</span>  <span class="c1"># ISO 3166</span>
    <span class="s1">&#39;coord&#39;</span><span class="p">,</span>    <span class="c1"># Coord</span>
    <span class="s1">&#39;wind&#39;</span><span class="p">,</span>     <span class="c1"># Wind</span>
    <span class="s1">&#39;weather&#39;</span><span class="p">,</span>  <span class="c1"># Weather</span>
    <span class="s1">&#39;sunrise&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sunset&#39;</span><span class="p">,</span>
    <span class="s1">&#39;temp_min&#39;</span><span class="p">,</span>
    <span class="s1">&#39;temp_max&#39;</span><span class="p">,</span>
    <span class="s1">&#39;temp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;humidity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pressure&#39;</span>
    <span class="s1">&#39;dt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;visibility&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timezone&#39;</span><span class="p">,</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Now that we have a decent understanding about what information we want to flow
in our system, let’s focus in on each part.</p>
</div>
<div class="section" id="openweathermapcitydetails-specifications">
<span id="quickstart-openweathermapcitydetails-specifications"></span><h3>OpenWeatherMapCityDetails Specifications<a class="headerlink" href="#openweathermapcitydetails-specifications" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code> needs to provide a city ID given a city and a
country.  This city ID will be used by the <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> object to make a call
to the open web API.  The open-weather website contains a compressed file called
<code class="docutils literal notranslate"><span class="pre">city.list.json.gz</span></code> at
<a class="reference external" href="http://bulk.openweathermap.org/sample/city.list.json.gz">http://bulk.openweathermap.org/sample/city.list.json.gz</a>.  If you have a
city name and a country code, you can use this file to look up the city’s id.</p>
<p>I have long term plans to pull the <code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code> object out of
the networked sprinkler and place it on a server somewhere.  This is because the
<code class="docutils literal notranslate"><span class="pre">city.list.json.gz</span></code> file is really big, and I would like to cost reduce my
robotic sprinkler onto processors with very little memory.  This means that many
many different <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> objects might be making requests for city-ids at
the same time.</p>
<p>I only want to download the <code class="docutils literal notranslate"><span class="pre">city.list.json.gz</span></code> file if I don’t have it
already, and I would like the <code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code> object to be
resilient to network outages on the Open Weather website.  If it can’t download
the file from the Open Weather server, it should wait ten seconds then try
again.  While its waiting, it should place any request from <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code>
objects for city-ids into a queue which will be answered once it gets the
information it needs.  Once it gets the file, it should answer any of its queued
requests in a first in first out kind of way.</p>
<p>Here is the design, it uses the <a class="reference internal" href="patterns.html#patterns-deferred-event"><span class="std std-ref">deferred event</span></a>
statechart pattern.</p>
<a class="reference external image-reference" href="_static/open_weather_map_city_details.pdf"><div align="center" class="align-center"><img alt="_images/open_weather_map_city_details.svg" src="_images/open_weather_map_city_details.svg" /></div>
</a>
<p>From the design we can write our code (compacted to fit on the page):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>

<span class="c1"># ... named tuples defined above, see previous section (removed to make it</span>
<span class="c1">#     easier to see the OpenWeatherMapCityDetails code</span>

<span class="k">class</span> <span class="nc">InstrumentedFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_trace</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_trace</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">live_spy</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">live_spy</span>

<span class="k">class</span> <span class="nc">OpenWeatherMapCityDetails</span><span class="p">(</span><span class="n">InstrumentedFactory</span><span class="p">):</span>

  <span class="n">DEFAULT_LOOKUP_FILE_URL</span> <span class="o">=</span> \
    <span class="s1">&#39;http://bulk.openweathermap.org/sample/city.list.json.gz&#39;</span>

  <span class="n">LOOKUP_FILE_PATH</span> <span class="o">=</span> \
    <span class="s1">&#39;city_to_id_json.gz&#39;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">lookup_file_url</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    To see the design diagram:</span>
<span class="sd">      https://aleph2c.github.io/miros/_static/open_weather_map_city_details.pdf</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">)</span>

    <span class="c1"># setup attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">city</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lookup_file_url</span> <span class="o">=</span> \
      <span class="n">OpenWeatherMapCityDetails</span><span class="o">.</span><span class="n">DEFAULT_LOOKUP_FILE_URL</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lookup_file_name</span> <span class="o">=</span> \
       <span class="n">OpenWeatherMapCityDetails</span><span class="o">.</span><span class="n">LOOKUP_FILE_PATH</span> \
         <span class="k">if</span> <span class="n">lookup_file_url</span> <span class="o">==</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">lookup_file_url</span>

    <span class="c1"># define the states, link signals to handlers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;api_lookup_data&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data_request_city_details</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CITY_DETAILS</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data_city_details</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;build_data_structure&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">read_file</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure_read_file</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ready</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_id_file_from_network_ready</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">retry_after_network_error</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_id_file_from_network_retry_after_network_error</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">get_id_file_from_network</span> <span class="o">=</span> \
      <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;get_id_file_from_network&quot;</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
         <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_id_file_from_network_entry_signal</span><span class="p">)</span><span class="o">.</span> \
       <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">read_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;read_file&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">idle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;idle&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_request_city_details</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">conduct_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;conduct_query&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conduct_query_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ready</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conduct_query_ready</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="c1"># add the hierarchy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data</span><span class="p">,</span>
           <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
         <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure</span><span class="p">,</span>
           <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data</span><span class="p">)</span><span class="o">.</span> \
         <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_id_file_from_network</span><span class="p">,</span>
           <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure</span><span class="p">)</span><span class="o">.</span> \
         <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_file</span><span class="p">,</span>
           <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure</span><span class="p">)</span><span class="o">.</span> \
         <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span>
           <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure</span><span class="p">)</span><span class="o">.</span> \
         <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conduct_query</span><span class="p">,</span>
           <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_data_structure</span><span class="p">)</span>

    <span class="c1"># start the statechart (fire up a separate thread)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_lookup_data</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">city_details_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Pull the city details out of the raw_weather_lookup_dict using the</span>
<span class="sd">       country and city attributes to identify the required item from the</span>
<span class="sd">       collection</span>

<span class="sd">    **Returns**:</span>
<span class="sd">       (CityDetailsPayload): namedtuple containing the city details needed for</span>
<span class="sd">       the open weather API call</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">_id</span><span class="p">,</span> <span class="n">_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_weather_lookup_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span> <span class="o">==</span> <span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;country&#39;</span><span class="p">]:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">Coord</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">lat</span><span class="o">=</span><span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">CityDetailsPayload</span><span class="p">(</span>
          <span class="nb">id</span><span class="o">=</span><span class="n">_dict</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
          <span class="n">city</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
          <span class="n">country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">,</span>
          <span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_lookup_data_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CITY_DETAILS</span><span class="p">))</span>  <span class="c1"># debugging</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_lookup_data_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">build_data_structure</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_lookup_data_request_city_details</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_lookup_data_city_details</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{}: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">city</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">build_data_structure_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">this_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">lookup_file_path</span> <span class="o">=</span> <span class="n">this_dir</span> <span class="o">/</span> <span class="n">chart</span><span class="o">.</span><span class="n">lookup_file_name</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">build_data_structure_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">chart</span><span class="o">.</span><span class="n">lookup_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">get_id_file_from_network</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">read_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">build_data_structure_read_file</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">read_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">get_id_file_from_network_ready</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">idle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">get_id_file_from_network_retry_after_network_error</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">build_data_structure</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">get_id_file_from_network_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">lookup_file_url</span><span class="p">)</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">lookup_file_path</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
      <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">read_file</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
        <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">retry_after_network_error</span><span class="p">),</span>
        <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
        <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">read_file_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">raw_weather_lookup_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">lookup_file_path</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">raw_weather_lookup_list</span> <span class="o">=</span> \
        <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">raw_weather_lookup_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">raw_weather_lookup_dict</span> <span class="o">=</span> \
      <span class="p">{</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">raw_weather_lookup_list</span><span class="p">}</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ready</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">idle_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">idle_request_city_details</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">city</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">city</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">country</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">conduct_query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">conduct_query_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CITY_DETAILS</span><span class="p">,</span>
      <span class="n">payload</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">city_details_payload</span><span class="p">()))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ready</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">conduct_query_ready</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">idle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>Now that I have a design and its code, I would like to run it independently of
the other two objects needed to build the robotic sprinkler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="n">owm</span> <span class="o">=</span> <span class="n">OpenWeatherMapCityDetails</span><span class="p">(</span><span class="s1">&#39;city_details&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">owm</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">RequestDetailsForCityPayload</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="s2">&quot;Vancouver&quot;</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">)))</span>
  <span class="n">owm</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">RequestDetailsForCityPayload</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="s2">&quot;Burnaby&quot;</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">)))</span>
  <span class="n">owm</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">RequestDetailsForCityPayload</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">)))</span>
  <span class="n">owm</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">RequestDetailsForCityPayload</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="s2">&quot;Saskatoon&quot;</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">)))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>To run it, I make sure to delete the compressed file (so the code will be forced
to download it again), then I hammer the statechart with a bunch of requests
(see above) while it is trying to download and decompress and make sense of the
file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rm</span> <span class="o">*.</span><span class="n">gz</span> <span class="p">;</span> <span class="n">python</span> <span class="n">sprinkler</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Let’s look at what it did, we can see it because we turned on the
<code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code>’s live_trace feature:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[12:09:57] [city_details] e-&gt;start_at() top-&gt;get_id_file_from_network
[12:09:57] [city_details] e-&gt;read_file() get_id_file_from_network-&gt;read_file
[12:09:58] [city_details] e-&gt;ready() read_file-&gt;idle
[12:09:58] [city_details] e-&gt;REQUEST_CITY_DETAILS() idle-&gt;conduct_query
[12:09:58] [city_details] e-&gt;ready() conduct_query-&gt;idle
[12:09:58] [city_details] e-&gt;REQUEST_CITY_DETAILS() idle-&gt;conduct_query
Vancouver: 6173331
[12:09:58] [city_details] e-&gt;ready() conduct_query-&gt;idle
[12:09:58] [city_details] e-&gt;REQUEST_CITY_DETAILS() idle-&gt;conduct_query
Toronto: 6167865
[12:09:58] [city_details] e-&gt;ready() conduct_query-&gt;idle
[12:09:58] [city_details] e-&gt;REQUEST_CITY_DETAILS() idle-&gt;conduct_query
Burnaby: 5911606
[12:09:58] [city_details] e-&gt;ready() conduct_query-&gt;idle
Saskatoon: 6141256
</pre></div>
</div>
<p><a class="reference internal" href="recipes.html#recipes-drawing-a-sequence-diagram"><span class="std std-ref">Turning this into a sequence diagram</span></a> looks
like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Statechart</span><span class="p">:</span> <span class="n">city_details</span><span class="p">]</span>
<span class="n">top</span>   <span class="n">get_id_file_from_network</span> <span class="n">read_file</span>   <span class="n">idle</span>                  <span class="n">conduct_query</span>
 <span class="o">+---</span><span class="n">start_at</span><span class="p">()</span><span class="o">-&gt;|</span>              <span class="o">|</span>           <span class="o">|</span>                          <span class="o">|</span>
 <span class="o">|</span>      <span class="p">(</span><span class="mi">1</span><span class="p">)</span>      <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>                          <span class="o">|</span>
 <span class="o">|</span>               <span class="o">+-</span><span class="n">read_file</span><span class="p">()</span><span class="o">-&gt;|</span>           <span class="o">|</span>                          <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>    <span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="o">|</span>           <span class="o">|</span>                          <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">+-</span><span class="n">ready</span><span class="p">()</span><span class="o">--&gt;|</span>                          <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>  <span class="p">(</span><span class="mi">3</span><span class="p">)</span>      <span class="o">|</span>                          <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+--</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">()</span><span class="o">-&gt;|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>           <span class="p">(</span><span class="mi">4</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+&lt;---------</span><span class="n">ready</span><span class="p">()</span><span class="o">---------|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>           <span class="p">(</span><span class="mi">5</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+--</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">()</span><span class="o">-&gt;|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>           <span class="p">(</span><span class="mi">6</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+&lt;---------</span><span class="n">ready</span><span class="p">()</span><span class="o">---------|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>           <span class="p">(</span><span class="mi">7</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+--</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">()</span><span class="o">-&gt;|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>           <span class="p">(</span><span class="mi">8</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+&lt;---------</span><span class="n">ready</span><span class="p">()</span><span class="o">---------|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>           <span class="p">(</span><span class="mi">9</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+--</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">()</span><span class="o">-&gt;|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>          <span class="p">(</span><span class="mi">10</span><span class="p">)</span>            <span class="o">|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">+&lt;---------</span><span class="n">ready</span><span class="p">()</span><span class="o">---------|</span>
 <span class="o">|</span>               <span class="o">|</span>              <span class="o">|</span>           <span class="o">|</span>          <span class="p">(</span><span class="mi">11</span><span class="p">)</span>            <span class="o">|</span>
</pre></div>
</div>
<p>We can see that the city_details statechart queued the REQUEST_CITY_DETAILS
(4,6,8,10) events until after it had downloaded the <code class="docutils literal notranslate"><span class="pre">city.list.json.qz</span></code> (1).</p>
</div>
<div class="section" id="cityweather-specifications">
<span id="quickstart-citydetails-specifications"></span><h3>CityWeather Specifications<a class="headerlink" href="#cityweather-specifications" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> goals are:</p>
<ul class="simple">
<li>for a city and a country get a city id so the open weather api can be called for information about this city</li>
<li>return weather information when it is asked for it.</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> will be built like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cw</span> <span class="o">=</span> <span class="n">CityWeather</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;city_weather&#39;</span><span class="p">,</span> <span class="c1"># for trace outputs (logs)</span>
  <span class="n">city</span><span class="o">=</span><span class="s1">&#39;Vancouver&#39;</span><span class="p">,</span>
  <span class="n">country</span><span class="o">=</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span>
<span class="hll">  <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;b35975e18dc93725acb092f7272cc6b8&#39;</span><span class="p">,</span>
</span>  <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># if you want to see the live trace</span>
</pre></div>
</div>
<p>You will have to get your own API key (highlighted) from <a class="reference external" href="https://openweathermap.org/appid">here</a>.</p>
<p>Before <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> can get the weather, it needs to ask for the CITY_DETAILS so
it can call the open weather server with the correct city ID.  While
it’s waiting around to get this information, it might start receiving
GET_WEATHER events.  If this happens it should just queue up these requests and
answer them in the right order when it can.</p>
<p>There is a chance that while its trying to contact the open weather API, there
could be an issue with the network.  If this happens wait 5 seconds and post the
GET_WEATHER event back at itself as if someone from outside of the active object
made the request.  However, if a real GET_WEATHER event comes into the object
while it’s waiting for this network-error-timer to time out, just cancel the timer.
If we don’t do this, we could end up sending way too many WEATHER events once the
network issue clears.</p>
<p>The open weather API asks us not to make more than 1 weather request every 10
seconds.  If we send too many requests per minute, the open api server will send
us an error message.  To avoid such a situation we <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> will only
make one real call to the open weather servers every 10 seconds, otherwise it
just returns its most recently discovered weather data.  This provide a kind of
time buffer between it in the server.</p>
<a class="reference external image-reference" href="_static/city_weather.pdf"><div align="center" class="align-center"><img alt="_images/city_weather.svg" src="_images/city_weather.svg" /></div>
</a>
<p>Here is the CityWeather code based on the above design:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CityWeather</span><span class="p">(</span><span class="n">InstrumentedFactory</span><span class="p">):</span>

  <span class="n">API_HOLD_OFF_TIME_IN_SEC</span> <span class="o">=</span> <span class="mf">10.0</span>
  <span class="n">NETWORK_ERROR_RETRY_TIME_IN_SEC</span> <span class="o">=</span> <span class="mf">5.0</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">city</span><span class="p">,</span>
    <span class="n">country</span><span class="p">,</span>
    <span class="n">api_key</span><span class="p">,</span>
    <span class="n">live_trace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">live_spy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    To see diagram of the CityWeather statechart:</span>
<span class="sd">      https://aleph2c.github.io/miros/_static/city_weather.pdf</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">live_trace</span><span class="p">,</span> <span class="n">live_spy</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">city</span> <span class="o">=</span> <span class="n">city</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span>  <span class="c1"># ISO 3166</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">city_id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cached_payload</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">weather_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;weather_worker&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather_worker_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">GET_WEATHER</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather_worker_get_weather</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CITY_DETAILS</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather_worker_city_details</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">WEATHER</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather_worker_weather</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">query_weather</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;query_weather&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_weather_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">idle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;idle&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">GET_WEATHER</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_get_weather</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">api_live</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;api_live&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_live_entry_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_live_init_signal</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">fresh_api_call</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_live_fresh_api_call</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">network_error</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_live_network_error</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">api_paused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s2">&quot;api_paused&quot;</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_paused_entry</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">GET_WEATHER</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_paused_get_weather</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">to_method</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather_worker</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_weather</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather_worker</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_weather</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_live</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_weather</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_paused</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_live</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weather_worker</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">query_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">api_query_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_url</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_query_url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">make_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Make an Open Weather URL to request weather data this object&#39;s city and</span>
<span class="sd">       country</span>

<span class="sd">    **Note**:</span>
<span class="sd">       The URL request should look something like this:</span>

<span class="sd">       http://api.openweathermap.org/data/2.5/</span>
<span class="sd">         weather?id=6173331&amp;APPID=</span>
<span class="sd">         b35975e18dc93725acb092f7272cc6b8&amp;units=metric</span>

<span class="sd">    **Returns**:</span>
<span class="sd">       (str): the url which you can use with the requests library</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;id=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">city_id</span><span class="p">)</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://api.openweathermap.org/data/2.5/weather?&#39;</span>
    <span class="n">url</span> <span class="o">+=</span> <span class="n">query</span>
    <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;&amp;APPID=&#39;</span>
    <span class="n">url</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span>
    <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;&amp;units=metric&#39;</span>

    <span class="k">return</span> <span class="n">url</span>

  <span class="k">def</span> <span class="nf">to_weather_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weather_dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert the open web api (as a dict) to the WeatherOpenApiResult.</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``weather_dict`` (dict): dictionary version of the json structure</span>
<span class="sd">       |                          returned from the Open Weather Api service</span>

<span class="sd">    **Returns**:</span>
<span class="sd">       (WeatherOpenApiResult): immutable namedtuple of the data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">weather_dict</span>
    <span class="n">api_weather_dict</span> <span class="o">=</span> <span class="n">api</span><span class="p">[</span><span class="s1">&#39;weather&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">coord</span> <span class="o">=</span> <span class="n">Coord</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">][</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">lat</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">][</span><span class="s1">&#39;lat&#39;</span><span class="p">])</span>

    <span class="n">weather</span> <span class="o">=</span> <span class="n">Weather</span><span class="p">(</span>
      <span class="n">icon</span><span class="o">=</span><span class="n">api_weather_dict</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">],</span>
      <span class="n">main</span><span class="o">=</span><span class="n">api_weather_dict</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">],</span>
      <span class="nb">id</span><span class="o">=</span><span class="n">api_weather_dict</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
      <span class="n">description</span><span class="o">=</span><span class="n">api_weather_dict</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">wind</span> <span class="o">=</span> <span class="n">Wind</span><span class="p">(</span>
      <span class="n">speed</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;wind&#39;</span><span class="p">][</span><span class="s1">&#39;speed&#39;</span><span class="p">],</span>
      <span class="n">deg</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;wind&#39;</span><span class="p">][</span><span class="s1">&#39;deg&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">WeatherOpenApiResult</span><span class="p">(</span>
      <span class="n">city</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
      <span class="n">country</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">,</span>
      <span class="n">coord</span><span class="o">=</span><span class="n">coord</span><span class="p">,</span>
      <span class="n">wind</span><span class="o">=</span><span class="n">wind</span><span class="p">,</span>
      <span class="n">weather</span><span class="o">=</span><span class="n">weather</span><span class="p">,</span>
      <span class="n">sunrise</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">][</span><span class="s1">&#39;sunrise&#39;</span><span class="p">],</span>
      <span class="n">sunset</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;sys&#39;</span><span class="p">][</span><span class="s1">&#39;sunset&#39;</span><span class="p">],</span>
      <span class="n">temp_min</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][</span><span class="s1">&#39;temp_min&#39;</span><span class="p">],</span>
      <span class="n">temp_max</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][</span><span class="s1">&#39;temp_max&#39;</span><span class="p">],</span>
      <span class="n">temp</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][</span><span class="s1">&#39;temp&#39;</span><span class="p">],</span>
      <span class="n">humidity</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][</span><span class="s1">&#39;humidity&#39;</span><span class="p">],</span>
      <span class="n">pressure</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">],</span>
      <span class="n">dt</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">],</span>
      <span class="n">visibility</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">],</span>
      <span class="n">timezone</span><span class="o">=</span><span class="n">api</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">payload</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">weather_worker_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">GET_WEATHER</span><span class="p">))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">CITY_DETAILS</span><span class="p">))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">WEATHER</span><span class="p">))</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REQUEST_CITY_DETAILS</span><span class="p">,</span>
      <span class="n">payload</span><span class="o">=</span><span class="n">RequestDetailsForCityPayload</span><span class="p">(</span>
        <span class="n">city</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
        <span class="n">country</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">country</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">weather_worker_get_weather</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">weather_worker_city_details</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">city</span> <span class="o">==</span> <span class="n">chart</span><span class="o">.</span><span class="n">city</span> <span class="ow">and</span> \
       <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">country</span><span class="p">:</span>
      <span class="n">chart</span><span class="o">.</span><span class="n">city_id</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">id</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">query_weather</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">weather_worker_weather</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">city</span> <span class="o">==</span> <span class="n">chart</span><span class="o">.</span><span class="n">city</span> <span class="ow">and</span> \
       <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="n">chart</span><span class="o">.</span><span class="n">country</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">query_weather_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">idle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">idle_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">recall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">idle_get_weather</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">network_error</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">api_live</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_live_entry_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">weather_results_dict</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">query_api</span><span class="p">()</span>
      <span class="n">chart</span><span class="o">.</span><span class="n">cached_payload</span> <span class="o">=</span> \
        <span class="n">chart</span><span class="o">.</span><span class="n">to_weather_payload</span><span class="p">(</span><span class="n">weather_results_dict</span><span class="p">)</span>
      <span class="n">chart</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
        <span class="n">Event</span><span class="p">(</span>
          <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">WEATHER</span><span class="p">,</span>
          <span class="n">payload</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">cached_payload</span>
        <span class="p">)</span>
      <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">chart</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">network_error</span><span class="p">))</span>
      <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
        <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">GET_WEATHER</span><span class="p">),</span>
        <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="n">CityWeather</span><span class="o">.</span><span class="n">NETWORK_ERROR_RETRY_TIME_IN_SEC</span><span class="p">,</span>
        <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_live_init_signal</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">api_paused</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_live_fresh_api_call</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">idle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_live_network_error</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">idle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_paused_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">fresh_api_call</span><span class="p">),</span>
      <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
      <span class="n">period</span><span class="o">=</span><span class="n">CityWeather</span><span class="o">.</span><span class="n">API_HOLD_OFF_TIME_IN_SEC</span><span class="p">,</span>
      <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">api_paused_get_weather</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="n">chart</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
      <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">WEATHER</span><span class="p">,</span>
        <span class="n">payload</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">cached_payload</span>
      <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>I already built the <code class="docutils literal notranslate"><span class="pre">OpenWeatherMapCityDetails</span></code> object which can return city
ID objects when it’s asked to by <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code>.</p>
<p>So, to see if the <code class="docutils literal notranslate"><span class="pre">CityWeather</span></code> object is working, I’ll make both objects and
publish some <code class="docutils literal notranslate"><span class="pre">GET_WEATHER</span></code> events to both the them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">owm</span> <span class="o">=</span> <span class="n">OpenWeatherMapCityDetails</span><span class="p">(</span><span class="s1">&#39;city_details&#39;</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">cw</span>  <span class="o">=</span> <span class="n">CityWeather</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;city_weather&#39;</span><span class="p">,</span>
  <span class="n">city</span><span class="o">=</span><span class="s1">&#39;Vancouver&#39;</span><span class="p">,</span>
  <span class="n">country</span><span class="o">=</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span>
  <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;b35975e18dc93725acb092f7272cc6b8&#39;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="n">cw</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">GET_WEATHER</span><span class="p">))</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>This produces the following output, which convinced me that the code was
working:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="section" id="sprinkler-specifications">
<span id="quickstart-sprinkler-specifications"></span><h3>Sprinkler Specifications<a class="headerlink" href="#sprinkler-specifications" title="Permalink to this headline">¶</a></h3>
<a class="reference external image-reference" href="_static/sprinkler.pdf"><div align="center" class="align-center"><img alt="_images/sprinkler.svg" src="_images/sprinkler.svg" /></div>
</a>
<a class="reference internal" href="introduction.html"<span class="std-ref">prev</span></a>, <a class="reference internal" href="index.html#top"><span class="std std-ref">top</span></a>, <a class="reference internal" href="zero_to_one.html"><span class="std std-ref">next</span></a><div class="toctree-wrapper compound">
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Quick Start</a><ul>
<li><a class="reference internal" href="#a-networked-sprinkler">A Networked Sprinkler</a><ul>
<li><a class="reference internal" href="#figuring-out-what-information-will-be-passed-around">Figuring out what Information will be Passed Around</a></li>
<li><a class="reference internal" href="#openweathermapcitydetails-specifications">OpenWeatherMapCityDetails Specifications</a></li>
<li><a class="reference internal" href="#cityweather-specifications">CityWeather Specifications</a></li>
<li><a class="reference internal" href="#sprinkler-specifications">Sprinkler Specifications</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="introduction.html" title="previous chapter">Introduction</a></li>
      <li>Next: <a href="zero_to_one.html" title="next chapter">Zero To One</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/quickstart.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Scott Volk.
      
      |
      <a href="_sources/quickstart.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>